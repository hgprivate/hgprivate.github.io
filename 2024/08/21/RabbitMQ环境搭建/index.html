<!doctypehtml><html lang=zh-CN><meta charset=UTF-8><meta content=width=device-width name=viewport><meta media="(prefers-color-scheme: light)" content=#222 name=theme-color><meta media="(prefers-color-scheme: dark)" content=#222 name=theme-color><meta content="Hexo 7.3.0" name=generator><link href=/images/apple-touch-icon-next.png rel=apple-touch-icon sizes=180x180><link href=/images/favicon-32x32-next.png rel=icon sizes=32x32 type=image/png><link href=/images/favicon-16x16-next.png rel=icon sizes=16x16 type=image/png><link color=#222 href=/images/logo.svg rel=mask-icon><link href=/css/main.css rel=stylesheet><link crossorigin=anonymous href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css integrity=sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA= rel=stylesheet><link crossorigin=anonymous href=https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css integrity=sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE= rel=stylesheet><script class=next-config data-name=main type=application/json>{"hostname":"hshz21.gitee.io","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script src=/js/config.js></script><meta content="1.单机部署Centos7环境下使用Docker来安装。 1.1.下载镜像方式一：在线拉取 1docker pull rabbitmq:3-management  方式二：从本地加载 将镜像包上传到虚拟机中后，使用命令加载镜像即可： 1docker load -i mq.tar  1.2.部署MQ执行下面的命令来运行MQ容器： 12345678docker run \ -e RABBITMQ_DE" name=description><meta content=article property=og:type><meta content=RabbitMQ系列-RabbitMQ环境搭建 property=og:title><meta content=https://hshz21.gitee.io/2024/08/21/RabbitMQ%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/index.html property=og:url><meta content=豪哥博客 property=og:site_name><meta content="1.单机部署Centos7环境下使用Docker来安装。 1.1.下载镜像方式一：在线拉取 1docker pull rabbitmq:3-management  方式二：从本地加载 将镜像包上传到虚拟机中后，使用命令加载镜像即可： 1docker load -i mq.tar  1.2.部署MQ执行下面的命令来运行MQ容器： 12345678docker run \ -e RABBITMQ_DE" property=og:description><meta content=zh_CN property=og:locale><meta content=2024-08-21T13:39:14.356Z property=article:published_time><meta content=2023-08-07T02:27:24.691Z property=article:modified_time><meta content=豪哥 property=article:author><meta content=RabbitMQ property=article:tag><meta content=RabbitMQ环境 property=article:tag><meta content=summary name=twitter:card><link href=https://hshz21.gitee.io/2024/08/21/RabbitMQ%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/ rel=canonical><script class=next-config data-name=page type=application/json>{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://hshz21.gitee.io/2024/08/21/RabbitMQ%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/","path":"2024/08/21/RabbitMQ环境搭建/","title":"RabbitMQ系列-RabbitMQ环境搭建"}</script><script class=next-config data-name=calendar type=application/json>""</script><title>RabbitMQ系列-RabbitMQ环境搭建 | 豪哥博客</title><noscript><link href=/css/noscript.css rel=stylesheet></noscript><body class=use-motion itemscope itemtype=http://schema.org/WebPage><div class=headband></div><main class=main><div class=column><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=site-brand-container><div class=site-nav-toggle><div aria-label=切换导航栏 class=toggle role=button><span class=toggle-line></span><span class=toggle-line></span><span class=toggle-line></span></div></div><div class=site-meta><a class=brand href=/ rel=start> <i class=logo-line></i> <p class=site-title>豪哥博客</p> <i class=logo-line></i> </a><p class=site-subtitle itemprop=description>豪哥博客</div><div class=site-nav-right><div class="toggle popup-trigger" aria-label=搜索 role=button><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ rel=section><i class="fa fa-home fa-fw"></i>首页</a><li class="menu-item menu-item-tags"><a href=/tags/ rel=section><i class="fa fa-tags fa-fw"></i>标签</a><li class="menu-item menu-item-categories"><a href=/categories/ rel=section><i class="fa fa-th fa-fw"></i>分类</a><li class="menu-item menu-item-archives"><a href=/archives/ rel=section><i class="fa fa-archive fa-fw"></i>归档</a><li class="menu-item menu-item-search"><a class=popup-trigger role=button><i class="fa fa-search fa-fw"></i>搜索 </a></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon> <i class="fa fa-search"></i> </span><div class=search-input-container><input autocapitalize=off autocomplete=off class=search-input maxlength=80 placeholder=搜索... spellcheck=false type=search></div><span class=popup-btn-close role=button> <i class="fa fa-times-circle"></i> </span></div><div class=search-result-container><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></header><aside class=sidebar><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录<li class=sidebar-nav-overview>站点概览</ul><div class=sidebar-panel-container><!--noindex--><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class=nav><li class="nav-item nav-level-1"><a class=nav-link href=#1-%E5%8D%95%E6%9C%BA%E9%83%A8%E7%BD%B2><span class=nav-number>1.</span> <span class=nav-text>1.单机部署</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#1-1-%E4%B8%8B%E8%BD%BD%E9%95%9C%E5%83%8F><span class=nav-number>1.1.</span> <span class=nav-text>1.1.下载镜像</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#1-2-%E9%83%A8%E7%BD%B2MQ><span class=nav-number>1.2.</span> <span class=nav-text>1.2.部署MQ</span></a></ol><li class="nav-item nav-level-1"><a class=nav-link href=#2-%E5%AE%89%E8%A3%85DelayExchange%E6%8F%92%E4%BB%B6><span class=nav-number>2.</span> <span class=nav-text>2.安装DelayExchange插件</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#2-1-%E4%B8%8B%E8%BD%BD%E6%8F%92%E4%BB%B6><span class=nav-number>2.1.</span> <span class=nav-text>2.1.下载插件</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#2-2-%E4%B8%8A%E4%BC%A0%E6%8F%92%E4%BB%B6><span class=nav-number>2.2.</span> <span class=nav-text>2.2.上传插件</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#2-3-%E5%AE%89%E8%A3%85%E6%8F%92%E4%BB%B6><span class=nav-number>2.3.</span> <span class=nav-text>2.3.安装插件</span></a></ol><li class="nav-item nav-level-1"><a class=nav-link href=#3-%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2><span class=nav-number>3.</span> <span class=nav-text>3.集群部署</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#3-1-%E9%9B%86%E7%BE%A4%E5%88%86%E7%B1%BB><span class=nav-number>3.1.</span> <span class=nav-text>3.1.集群分类</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#3-2-%E8%8E%B7%E5%8F%96cookie><span class=nav-number>3.2.</span> <span class=nav-text>3.2.获取cookie</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#3-3-%E5%87%86%E5%A4%87%E9%9B%86%E7%BE%A4%E9%85%8D%E7%BD%AE><span class=nav-number>3.3.</span> <span class=nav-text>3.3.准备集群配置</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#3-4-%E5%90%AF%E5%8A%A8%E9%9B%86%E7%BE%A4><span class=nav-number>3.4.</span> <span class=nav-text>3.4.启动集群</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#2-5-%E6%B5%8B%E8%AF%95><span class=nav-number>3.5.</span> <span class=nav-text>2.5.测试</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#2-5-1-%E6%95%B0%E6%8D%AE%E5%85%B1%E4%BA%AB%E6%B5%8B%E8%AF%95><span class=nav-number>3.5.1.</span> <span class=nav-text>2.5.1.数据共享测试</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#2-5-2-%E5%8F%AF%E7%94%A8%E6%80%A7%E6%B5%8B%E8%AF%95><span class=nav-number>3.5.2.</span> <span class=nav-text>2.5.2.可用性测试</span></a></ol></ol><li class="nav-item nav-level-1"><a class=nav-link href=#4-%E9%95%9C%E5%83%8F%E6%A8%A1%E5%BC%8F><span class=nav-number>4.</span> <span class=nav-text>4.镜像模式</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#4-1-%E9%95%9C%E5%83%8F%E6%A8%A1%E5%BC%8F%E7%89%B9%E5%BE%81><span class=nav-number>4.1.</span> <span class=nav-text>4.1.镜像模式特征</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#4-2-%E9%95%9C%E5%83%8F%E6%A8%A1%E5%BC%8F%E9%85%8D%E7%BD%AE><span class=nav-number>4.2.</span> <span class=nav-text>4.2.镜像模式配置</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#4-2-1-exactly%E6%A8%A1%E5%BC%8F><span class=nav-number>4.2.1.</span> <span class=nav-text>4.2.1.exactly模式</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#4-2-2-all%E6%A8%A1%E5%BC%8F><span class=nav-number>4.2.2.</span> <span class=nav-text>4.2.2.all模式</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#4-2-3-nodes%E6%A8%A1%E5%BC%8F><span class=nav-number>4.2.3.</span> <span class=nav-text>4.2.3.nodes模式</span></a></ol><li class="nav-item nav-level-2"><a class=nav-link href=#4-3-%E6%B5%8B%E8%AF%95><span class=nav-number>4.3.</span> <span class=nav-text>4.3.测试</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#4-3-1-%E6%B5%8B%E8%AF%95%E6%95%B0%E6%8D%AE%E5%85%B1%E4%BA%AB><span class=nav-number>4.3.1.</span> <span class=nav-text>4.3.1.测试数据共享</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#4-3-2-%E6%B5%8B%E8%AF%95%E9%AB%98%E5%8F%AF%E7%94%A8><span class=nav-number>4.3.2.</span> <span class=nav-text>4.3.2.测试高可用</span></a></ol></ol><li class="nav-item nav-level-1"><a class=nav-link href=#5-%E4%BB%B2%E8%A3%81%E9%98%9F%E5%88%97><span class=nav-number>5.</span> <span class=nav-text>5.仲裁队列</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#5-1-%E6%B7%BB%E5%8A%A0%E4%BB%B2%E8%A3%81%E9%98%9F%E5%88%97><span class=nav-number>5.1.</span> <span class=nav-text>5.1.添加仲裁队列</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#5-2-%E6%B5%8B%E8%AF%95><span class=nav-number>5.2.</span> <span class=nav-text>5.2.测试</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#5-3-%E9%9B%86%E7%BE%A4%E6%89%A9%E5%AE%B9><span class=nav-number>5.3.</span> <span class=nav-text>5.3.集群扩容</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#5-3-1-%E5%8A%A0%E5%85%A5%E9%9B%86%E7%BE%A4><span class=nav-number>5.3.1.</span> <span class=nav-text>5.3.1.加入集群</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#5-3-2-%E5%A2%9E%E5%8A%A0%E4%BB%B2%E8%A3%81%E9%98%9F%E5%88%97%E5%89%AF%E6%9C%AC><span class=nav-number>5.3.2.</span> <span class=nav-text>5.3.2.增加仲裁队列副本</span></a></ol></ol></ol></div></div><!--/noindex--><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop=author itemscope itemtype=http://schema.org/Person><img alt=豪哥 class=site-author-image itemprop=image src=/static/imgs/avatar.png><p class=site-author-name itemprop=name>豪哥<div class=site-description itemprop=description>豪哥博客</div></div><div class="site-state-wrap animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/> <span class=site-state-item-count>116</span> <span class=site-state-item-name>日志</span> </a></div><div class="site-state-item site-state-categories"><a href=/categories/> <span class=site-state-item-count>35</span> <span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/> <span class=site-state-item-count>128</span> <span class=site-state-item-name>标签</span></a></div></nav></div></div></div></div></aside></div><div class="main-inner post posts-expand"><div class=post-block><article class=post-content itemscope itemtype=http://schema.org/Article lang=zh-CN><link href=https://hshz21.gitee.io/2024/08/21/RabbitMQ%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/ itemprop=mainEntityOfPage><span hidden itemprop=author itemscope itemtype=http://schema.org/Person> <meta content=/static/imgs/avatar.png itemprop=image> <meta content=豪哥 itemprop=name> </span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization> <meta content=豪哥博客 itemprop=name> <meta content=豪哥博客 itemprop=description> </span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork> <meta content="RabbitMQ系列-RabbitMQ环境搭建 | 豪哥博客" itemprop=name> <meta itemprop=description> </span><header class=post-header><h1 itemprop="name headline" class=post-title>RabbitMQ系列-RabbitMQ环境搭建</h1><div class=post-meta-container><div class=post-meta><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar"></i> </span> <span class=post-meta-item-text>发表于</span> <time itemprop="dateCreated datePublished" title="创建时间：2024-08-21 21:39:14" datetime=2024-08-21T21:39:14+08:00>2024-08-21</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar-check"></i> </span> <span class=post-meta-item-text>更新于</span> <time title="修改时间：2023-08-07 10:27:24" datetime=2023-08-07T10:27:24+08:00 itemprop=dateModified>2023-08-07</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-folder"></i> </span> <span class=post-meta-item-text>分类于</span> <span itemprop=about itemscope itemtype=http://schema.org/Thing> <a href=/categories/RabbitMQ/ itemprop=url rel=index><span itemprop=name>RabbitMQ</span></a> </span> </span></div></div></header><div class=post-body itemprop=articleBody><h1 id=1-单机部署><a class=headerlink href=#1-单机部署 title=1.单机部署></a>1.单机部署</h1><p>Centos7环境下使用Docker来安装。<h2 id=1-1-下载镜像><a class=headerlink href=#1-1-下载镜像 title=1.1.下载镜像></a>1.1.下载镜像</h2><p>方式一：在线拉取<figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>docker pull rabbitmq:3-management</span><br></pre></table></figure><p>方式二：从本地加载<p>将镜像包上传到虚拟机中后，使用命令加载镜像即可：<figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>docker load -i mq.tar</span><br></pre></table></figure><h2 id=1-2-部署MQ><a class=headerlink href=#1-2-部署MQ title=1.2.部署MQ></a>1.2.部署MQ</h2><p>执行下面的命令来运行MQ容器：<figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre><td class=code><pre><span class=line>docker run \</span><br><span class=line> -e RABBITMQ_DEFAULT_USER=rabbitmq \</span><br><span class=line> -e RABBITMQ_DEFAULT_PASS=123321 \</span><br><span class=line> --name rabbitmq-node1 \</span><br><span class=line> --hostname mq1 \</span><br><span class=line> -p 15672:15672 \</span><br><span class=line> -p 5672:5672 \</span><br><span class=line> -d rabbitmq:3-management</span><br></pre></table></figure><h1 id=2-安装DelayExchange插件><a class=headerlink href=#2-安装DelayExchange插件 title=2.安装DelayExchange插件></a>2.安装DelayExchange插件</h1><h2 id=2-1-下载插件><a class=headerlink href=#2-1-下载插件 title=2.1.下载插件></a>2.1.下载插件</h2><p>RabbitMQ官方插件社区<a href=https://www.rabbitmq.com/community-plugins.html rel=noopener target=_blank>https://www.rabbitmq.com/community-plugins.html</a> 中包含各种插件，包括我们要使用的DelayExchange插件。<h2 id=2-2-上传插件><a class=headerlink href=#2-2-上传插件 title=2.2.上传插件></a>2.2.上传插件</h2><p>因为我们是基于Docker安装，所以需要先查看RabbitMQ的插件目录对应的数据卷。<p>先前设置的RabbitMQ数据卷名称为<code>mq-plugins</code>，使用下面命令可查看数据卷：<figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>docker volume inspect mq-plugins</span><br></pre></table></figure><h2 id=2-3-安装插件><a class=headerlink href=#2-3-安装插件 title=2.3.安装插件></a>2.3.安装插件</h2><p>进入MQ容器内部来执行安装。我的容器名为<code>mq</code>，所以执行下面命令：<figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>docker <span class=built_in>exec</span> -it mq bash</span><br></pre></table></figure><p>进入容器内部后，执行下面命令开启插件：<figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>rabbitmq-plugins <span class=built_in>enable</span> rabbitmq_delayed_message_exchange</span><br></pre></table></figure><h1 id=3-集群部署><a class=headerlink href=#3-集群部署 title=3.集群部署></a>3.集群部署</h1><h2 id=3-1-集群分类><a class=headerlink href=#3-1-集群分类 title=3.1.集群分类></a>3.1.集群分类</h2><p>RabbitMQ官方提出了两种集群的配置方式：<ul><li><font color=orange>普通模式</font>：普通模式集群不进行数据同步，每个MQ都有自己的队列、数据信息（其它元数据信息如交换机等会同步）。例如我们有2个MQ：mq1，和mq2，如果你的消息在mq1，而你连接到了mq2，那么mq2会去mq1拉取消息，然后返回给你。如果mq1宕机，消息就会丢失。<li><font color=orange>镜像模式</font>：与普通模式不同，队列会在各个mq的镜像节点之间同步，因此你连接到任何一个镜像节点，均可获取到消息。而且如果一个节点宕机，并不会导致数据丢失。不过，这种方式增加了数据同步的带宽消耗。</ul><p>先看普通模式集群，计划部署3个节点来实现mq集群：<table><thead><tr><th>主机名<th>控制台端口<th>amqp通信端口<tbody><tr><td>mq1<td>8081 —> 15672<td>8071 —> 5672<tr><td>mq2<td>8082 —> 15672<td>8072 —> 5672<tr><td>mq3<td>8083 —> 15672<td>8073 —> 5672</table><p>集群节点标示默认都是：<code>rabbit@[hostname]</code>，因此以上三个节点的名称分别为：<ul><li>rabbit@mq1<li>rabbit@mq2<li>rabbit@mq3</ul><h2 id=3-2-获取cookie><a class=headerlink href=#3-2-获取cookie title=3.2.获取cookie></a>3.2.获取cookie</h2><p>RabbitMQ底层依赖于Erlang，而Erlang虚拟机就是一个面向分布式的语言，默认就支持集群模式。集群模式中的每个RabbitMQ 节点使用 cookie 来确定它们是否被允许相互通信。<p>要使两个节点能够通信，它们必须具有相同的共享秘密，称为<strong>Erlang cookie</strong>。cookie 只是一串最多 255 个字符的字母数字字符。<p>每个集群节点必须具有<strong>相同的 cookie</strong>。实例之间也需要它来相互通信。<p>我们先在之前启动的mq容器中获取一个cookie值，作为集群的cookie。执行下面的命令：<figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>docker <span class=built_in>exec</span> -it mq <span class=built_in>cat</span> /var/lib/rabbitmq/.erlang.cookie</span><br></pre></table></figure><p>可以看到cookie值如下：<figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>FXZMCVGLBIXZCDEMMVZQ</span><br></pre></table></figure><p>停止并删除当前mq容器，重新搭建集群。<figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>docker <span class=built_in>rm</span> -f mq</span><br></pre></table></figure><h2 id=3-3-准备集群配置><a class=headerlink href=#3-3-准备集群配置 title=3.3.准备集群配置></a>3.3.准备集群配置</h2><p>在/tmp目录新建一个配置文件 rabbitmq.conf：<figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line><span class=built_in>cd</span> /tmp</span><br><span class=line><span class=comment># 创建文件</span></span><br><span class=line><span class=built_in>touch</span> rabbitmq.conf</span><br></pre></table></figure><p>文件内容如下：<figure class="highlight nginx"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre><td class=code><pre><span class=line>loopback_users.<span class=attribute>guest</span> = <span class=literal>false</span></span><br><span class=line>listeners.tcp.default = <span class=number>5672</span></span><br><span class=line>cluster_formation.peer_discovery_backend = rabbit_peer_discovery_classic_config</span><br><span class=line>cluster_formation.classic_config.nodes.<span class=number>1</span> = rabbit<span class=variable>@mq1</span></span><br><span class=line>cluster_formation.classic_config.nodes.<span class=number>2</span> = rabbit<span class=variable>@mq2</span></span><br><span class=line>cluster_formation.classic_config.nodes.<span class=number>3</span> = rabbit<span class=variable>@mq3</span></span><br></pre></table></figure><p>再创建一个文件，记录cookie<figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre><td class=code><pre><span class=line><span class=built_in>cd</span> /tmp</span><br><span class=line><span class=comment># 创建cookie文件</span></span><br><span class=line><span class=built_in>touch</span> .erlang.cookie</span><br><span class=line><span class=comment># 写入cookie</span></span><br><span class=line><span class=built_in>echo</span> <span class=string>"FXZMCVGLBIXZCDEMMVZQ"</span> > .erlang.cookie</span><br><span class=line><span class=comment># 修改cookie文件的权限</span></span><br><span class=line><span class=built_in>chmod</span> 600 .erlang.cookie</span><br></pre></table></figure><p>准备三个目录,mq1、mq2、mq3：<figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line><span class=built_in>cd</span> /tmp</span><br><span class=line><span class=comment># 创建目录</span></span><br><span class=line><span class=built_in>mkdir</span> mq1 mq2 mq3</span><br></pre></table></figure><p>然后拷贝rabbitmq.conf、cookie文件到mq1、mq2、mq3：<figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre><td class=code><pre><span class=line><span class=comment># 进入/tmp</span></span><br><span class=line><span class=built_in>cd</span> /tmp</span><br><span class=line><span class=comment># 拷贝</span></span><br><span class=line><span class=built_in>cp</span> rabbitmq.conf mq1</span><br><span class=line><span class=built_in>cp</span> rabbitmq.conf mq2</span><br><span class=line><span class=built_in>cp</span> rabbitmq.conf mq3</span><br><span class=line><span class=built_in>cp</span> .erlang.cookie mq1</span><br><span class=line><span class=built_in>cp</span> .erlang.cookie mq2</span><br><span class=line><span class=built_in>cp</span> .erlang.cookie mq3</span><br></pre></table></figure><h2 id=3-4-启动集群><a class=headerlink href=#3-4-启动集群 title=3.4.启动集群></a>3.4.启动集群</h2><p>创建一个网络：<figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>docker network create mq-net</span><br></pre></table></figure><p>docker volume create<p>运行命令<figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br></pre><td class=code><pre><span class=line>docker run -d --net mq-net \</span><br><span class=line>-v <span class=variable>${PWD}</span>/mq1/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf \</span><br><span class=line>-v <span class=variable>${PWD}</span>/.erlang.cookie:/var/lib/rabbitmq/.erlang.cookie \</span><br><span class=line>-e RABBITMQ_DEFAULT_USER=itcast \</span><br><span class=line>-e RABBITMQ_DEFAULT_PASS=123321 \</span><br><span class=line>--name mq1 \</span><br><span class=line>--hostname mq1 \</span><br><span class=line>-p 8071:5672 \</span><br><span class=line>-p 8081:15672 \</span><br><span class=line>rabbitmq:3.8-management</span><br></pre></table></figure><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br></pre><td class=code><pre><span class=line>docker run -d --net mq-net \</span><br><span class=line>-v <span class=variable>${PWD}</span>/mq2/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf \</span><br><span class=line>-v <span class=variable>${PWD}</span>/.erlang.cookie:/var/lib/rabbitmq/.erlang.cookie \</span><br><span class=line>-e RABBITMQ_DEFAULT_USER=itcast \</span><br><span class=line>-e RABBITMQ_DEFAULT_PASS=123321 \</span><br><span class=line>--name mq2 \</span><br><span class=line>--hostname mq2 \</span><br><span class=line>-p 8072:5672 \</span><br><span class=line>-p 8082:15672 \</span><br><span class=line>rabbitmq:3.8-management</span><br></pre></table></figure><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br></pre><td class=code><pre><span class=line>docker run -d --net mq-net \</span><br><span class=line>-v <span class=variable>${PWD}</span>/mq3/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf \</span><br><span class=line>-v <span class=variable>${PWD}</span>/.erlang.cookie:/var/lib/rabbitmq/.erlang.cookie \</span><br><span class=line>-e RABBITMQ_DEFAULT_USER=itcast \</span><br><span class=line>-e RABBITMQ_DEFAULT_PASS=123321 \</span><br><span class=line>--name mq3 \</span><br><span class=line>--hostname mq3 \</span><br><span class=line>-p 8073:5672 \</span><br><span class=line>-p 8083:15672 \</span><br><span class=line>rabbitmq:3.8-management</span><br></pre></table></figure><h2 id=2-5-测试><a class=headerlink href=#2-5-测试 title=2.5.测试></a>2.5.测试</h2><p>在mq1这个节点上添加一个队列，在mq2和mq3两个控制台也都能看到。<h3 id=2-5-1-数据共享测试><a class=headerlink href=#2-5-1-数据共享测试 title=2.5.1.数据共享测试></a>2.5.1.数据共享测试</h3><h3 id=2-5-2-可用性测试><a class=headerlink href=#2-5-2-可用性测试 title=2.5.2.可用性测试></a>2.5.2.可用性测试</h3><p>让节点mq1宕机：<figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>docker stop mq1</span><br></pre></table></figure><p>然后登录mq2或mq3的控制台，发现simple.queue也不可用了，说明数据并没有拷贝到mq2和mq3。<h1 id=4-镜像模式><a class=headerlink href=#4-镜像模式 title=4.镜像模式></a>4.镜像模式</h1><p>创建队列的主机宕机后队列就不可用了，不具备高可用能力。为解决该问题，必须使用镜像集群方案。<p>官方文档地址：<a href=https://www.rabbitmq.com/ha.html rel=noopener target=_blank>https://www.rabbitmq.com/ha.html</a><h2 id=4-1-镜像模式特征><a class=headerlink href=#4-1-镜像模式特征 title=4.1.镜像模式特征></a>4.1.镜像模式特征</h2><p>默认情况下，队列只保存在创建该队列的节点上。而镜像模式下，创建队列的节点被称为该队列的<strong>主节点</strong>，队列还会拷贝到集群中的其它节点，也叫做该队列的<strong>镜像</strong>节点。<p>但是，不同队列可以在集群中的任意节点上创建，因此不同队列的主节点可以不同。甚至，<strong>一个队列的主节点可能是另一个队列的镜像节点</strong>。<p>用户发送给队列的一切请求，例如发送消息、消息回执默认都会在主节点完成，如果是从节点接收到请求，也会路由到主节点去完成。<strong>镜像节点仅仅起到备份数据作用</strong>。<p>当主节点接收到消费者的ACK时，所有镜像都会删除节点中的数据。<p>总结如下：<ul><li>镜像队列结构是一主多从（从就是镜像）<li>所有操作都是主节点完成，然后同步给镜像节点<li>主宕机后，镜像节点会替代成新的主（如果在主从同步完成前，主就已经宕机，可能出现数据丢失）<li>不具备负载均衡功能，因为所有操作都会有主节点完成（但是不同队列，其主节点可以不同，可以利用这个提高吞吐量）</ul><h2 id=4-2-镜像模式配置><a class=headerlink href=#4-2-镜像模式配置 title=4.2.镜像模式配置></a>4.2.镜像模式配置</h2><p>镜像模式的配置有3种模式：<table><thead><tr><th align=left>ha-mode<th align=left>ha-params<th align=left>效果<tbody><tr><td align=left>准确模式exactly<td align=left>队列的副本量count<td align=left>集群中队列副本（主服务器和镜像服务器之和）的数量。count如果为1意味着单个副本：即队列主节点。count值为2表示2个副本：1个队列主和1个队列镜像。换句话说：count = 镜像数量 + 1。如果群集中的节点数少于count，则该队列将镜像到所有节点。如果有集群总数大于count+1，并且包含镜像的节点出现故障，则将在另一个节点上创建一个新的镜像。<tr><td align=left>all<td align=left>(none)<td align=left>队列在群集中的所有节点之间进行镜像。队列将镜像到任何新加入的节点。镜像到所有节点将对所有群集节点施加额外的压力，包括网络I / O，磁盘I / O和磁盘空间使用情况。推荐使用exactly，设置副本数为（N / 2 +1）。<tr><td align=left>nodes<td align=left><em>node names</em><td align=left>指定队列创建到哪些节点，如果指定的节点全部不存在，则会出现异常。如果指定的节点在集群中存在，但是暂时不可用，会创建节点到当前客户端连接到的节点。</table><h3 id=4-2-1-exactly模式><a class=headerlink href=#4-2-1-exactly模式 title=4.2.1.exactly模式></a>4.2.1.exactly模式</h3><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>rabbitmqctl set_policy ha-two <span class=string>"^two\."</span> <span class=string>'{"ha-mode":"exactly","ha-params":2,"ha-sync-mode":"automatic"}'</span></span><br></pre></table></figure><ul><li><code>rabbitmqctl set_policy</code>：固定写法<li><code>ha-two</code>：策略名称，自定义<li><code>"^two\."</code>：匹配队列的正则表达式，符合命名规则的队列才生效，这里是任何以<code>two.</code>开头的队列名称<li><code>'{"ha-mode":"exactly","ha-params":2,"ha-sync-mode":"automatic"}'</code>: 策略内容<ul><li><code>"ha-mode":"exactly"</code>：策略模式，此处是exactly模式，指定副本数量<li><code>"ha-params":2</code>：策略参数，这里是2，就是副本数量为2，1主1镜像<li><code>"ha-sync-mode":"automatic"</code>：同步策略，默认是manual，即新加入的镜像节点不会同步旧的消息。如果设置为automatic，则新加入的镜像节点会把主节点中所有消息都同步，会带来额外的网络开销</ul></ul><h3 id=4-2-2-all模式><a class=headerlink href=#4-2-2-all模式 title=4.2.2.all模式></a>4.2.2.all模式</h3><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>rabbitmqctl set_policy ha-all <span class=string>"^all\."</span> <span class=string>'{"ha-mode":"all"}'</span></span><br></pre></table></figure><ul><li><code>ha-all</code>：策略名称，自定义<li><code>"^all\."</code>：匹配所有以<code>all.</code>开头的队列名<li><code>'{"ha-mode":"all"}'</code>：策略内容<ul><li><code>"ha-mode":"all"</code>：策略模式，此处是all模式，即所有节点都会称为镜像节点</ul></ul><h3 id=4-2-3-nodes模式><a class=headerlink href=#4-2-3-nodes模式 title=4.2.3.nodes模式></a>4.2.3.nodes模式</h3><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>rabbitmqctl set_policy ha-nodes <span class=string>"^nodes\."</span> <span class=string>'{"ha-mode":"nodes","ha-params":["rabbit@nodeA", "rabbit@nodeB"]}'</span></span><br></pre></table></figure><ul><li><code>rabbitmqctl set_policy</code>：固定写法<li><code>ha-nodes</code>：策略名称，自定义<li><code>"^nodes\."</code>：匹配队列的正则表达式，符合命名规则的队列才生效，这里是任何以<code>nodes.</code>开头的队列名称<li><code>'{"ha-mode":"nodes","ha-params":["rabbit@nodeA", "rabbit@nodeB"]}'</code>: 策略内容<ul><li><code>"ha-mode":"nodes"</code>：策略模式，此处是nodes模式<li><code>"ha-params":["rabbit@mq1", "rabbit@mq2"]</code>：策略参数，这里指定副本所在节点名称</ul></ul><h2 id=4-3-测试><a class=headerlink href=#4-3-测试 title=4.3.测试></a>4.3.测试</h2><p>我们使用exactly模式的镜像，因为集群节点数量为3，因此镜像数量就设置为2。<p>运行下面的命令：<figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>docker <span class=built_in>exec</span> -it mq1 rabbitmqctl set_policy ha-two <span class=string>"^two\."</span> <span class=string>'{"ha-mode":"exactly","ha-params":2,"ha-sync-mode":"automatic"}'</span></span><br></pre></table></figure><p>创建一个新的队列，在任意一个mq控制台查看队列。<h3 id=4-3-1-测试数据共享><a class=headerlink href=#4-3-1-测试数据共享 title=4.3.1.测试数据共享></a>4.3.1.测试数据共享</h3><p>给two.queue发送一条消息，然后在mq1、mq2、mq3的任意控制台查看消息。<h3 id=4-3-2-测试高可用><a class=headerlink href=#4-3-2-测试高可用 title=4.3.2.测试高可用></a>4.3.2.测试高可用</h3><p>现在，我们让two.queue的主节点mq1宕机：<figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>docker stop mq1</span><br></pre></table></figure><p>查看集群状态、队列状态，发现依然健康，且主节点切换到了rabbit@mq2上。<h1 id=5-仲裁队列><a class=headerlink href=#5-仲裁队列 title=5.仲裁队列></a>5.仲裁队列</h1><p>RabbitMQ 3.8开始引入仲裁队列，具备镜像队列的功能，且使用更加方便。<h2 id=5-1-添加仲裁队列><a class=headerlink href=#5-1-添加仲裁队列 title=5.1.添加仲裁队列></a>5.1.添加仲裁队列</h2><p>在任意控制台添加一个队列，一定要选择队列类型为Quorum类型。在任意控制台查看队列，可以看到仲裁队列的 + 2字样。代表这个队列有2个镜像节点。<p>因为仲裁队列默认的镜像数为5。如果你的集群有7个节点，那么镜像数肯定是5；而我们集群只有3个节点，因此镜像数量就是3.<h2 id=5-2-测试><a class=headerlink href=#5-2-测试 title=5.2.测试></a>5.2.测试</h2><p>可以参考对镜像集群的测试，效果是一样的。<h2 id=5-3-集群扩容><a class=headerlink href=#5-3-集群扩容 title=5.3.集群扩容></a>5.3.集群扩容</h2><h3 id=5-3-1-加入集群><a class=headerlink href=#5-3-1-加入集群 title=5.3.1.加入集群></a>5.3.1.加入集群</h3><p>1）启动一个新的MQ容器：<figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre><td class=code><pre><span class=line>docker run -d --net mq-net \</span><br><span class=line>-v <span class=variable>${PWD}</span>/.erlang.cookie:/var/lib/rabbitmq/.erlang.cookie \</span><br><span class=line>-e RABBITMQ_DEFAULT_USER=itcast \</span><br><span class=line>-e RABBITMQ_DEFAULT_PASS=123321 \</span><br><span class=line>--name mq4 \</span><br><span class=line>--hostname mq5 \</span><br><span class=line>-p 8074:15672 \</span><br><span class=line>-p 8084:15672 \</span><br><span class=line>rabbitmq:3.8-management</span><br></pre></table></figure><p>2）进入容器控制台：<figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>docker <span class=built_in>exec</span> -it mq4 bash</span><br></pre></table></figure><p>3）停止mq进程<figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>rabbitmqctl stop_app</span><br></pre></table></figure><p>4）重置RabbitMQ中的数据：<figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>rabbitmqctl reset</span><br></pre></table></figure><p>5）加入mq1<figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>rabbitmqctl join_cluster rabbit@mq1</span><br></pre></table></figure><p>6）再次启动mq进程<figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>rabbitmqctl start_app</span><br></pre></table></figure><h3 id=5-3-2-增加仲裁队列副本><a class=headerlink href=#5-3-2-增加仲裁队列副本 title=5.3.2.增加仲裁队列副本></a>5.3.2.增加仲裁队列副本</h3><p>我们先查看下quorum.queue这个队列目前的副本情况，进入mq1容器：<figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>docker <span class=built_in>exec</span> -it mq1 bash</span><br></pre></table></figure><p>执行命令：<figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>rabbitmq-queues quorum_status <span class=string>"quorum.queue"</span></span><br></pre></table></figure><p>现在，我们让mq4也加入进来：<figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>rabbitmq-queues add_member <span class=string>"quorum.queue"</span> <span class=string>"rabbit@mq4"</span></span><br></pre></table></figure><p>再次查看：<figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>rabbitmq-queues quorum_status <span class=string>"quorum.queue"</span></span><br></pre></table></figure><p>查看控制台，发现quorum.queue的镜像数量也从原来的 +2 变成了 +3。</div><footer class=post-footer><div class=post-tags><a href=/tags/RabbitMQ/ rel=tag># RabbitMQ</a><a href=/tags/RabbitMQ%E7%8E%AF%E5%A2%83/ rel=tag># RabbitMQ环境</a></div><div class=post-nav><div class=post-nav-item><a href=/2024/08/21/Nginx%E5%9F%BA%E6%9C%AC%E5%BA%94%E7%94%A8/ rel=prev title=Nginx系列-Nginx基础应用> <i class="fa fa-angle-left"></i> Nginx系列-Nginx基础应用 </a></div><div class=post-nav-item><a href=/2024/08/21/RabbitMQ%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/ rel=next title=RabbitMQ系列-RabbitMQ常见业务问题> RabbitMQ系列-RabbitMQ常见业务问题 <i class="fa fa-angle-right"></i> </a></div></div></footer></article></div></div></main><footer class=footer><div class=footer-inner><div class=copyright>© <span itemprop=copyrightYear>2024</span><span class=with-love> <i class="fa fa-heart"></i> </span><span class=author itemprop=copyrightHolder>豪哥</span></div></div></footer><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span><span class=toggle-line></span><span class=toggle-line></span></div><div class=sidebar-dimmer></div><div aria-label=返回顶部 class=back-to-top role=button><i class="fa fa-arrow-up fa-lg"></i><span>0%</span></div><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><script crossorigin=anonymous integrity=sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY= src=https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js></script><script src=/js/comments.js></script><script src=/js/utils.js></script><script src=/js/motion.js></script><script src=/js/sidebar.js></script><script src=/js/next-boot.js></script><script crossorigin=anonymous integrity=sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc= src=https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js></script><script src=/js/third-party/search/local-search.js></script>