<!doctypehtml><html lang=zh-CN><meta charset=UTF-8><meta content=width=device-width name=viewport><meta media="(prefers-color-scheme: light)" content=#222 name=theme-color><meta media="(prefers-color-scheme: dark)" content=#222 name=theme-color><meta content="Hexo 7.3.0" name=generator><link href=/images/apple-touch-icon-next.png rel=apple-touch-icon sizes=180x180><link href=/images/favicon-32x32-next.png rel=icon sizes=32x32 type=image/png><link href=/images/favicon-16x16-next.png rel=icon sizes=16x16 type=image/png><link color=#222 href=/images/logo.svg rel=mask-icon><link href=/css/main.css rel=stylesheet><link crossorigin=anonymous href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css integrity=sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA= rel=stylesheet><link crossorigin=anonymous href=https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css integrity=sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE= rel=stylesheet><script class=next-config data-name=main type=application/json>{"hostname":"hshz21.gitee.io","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script src=/js/config.js></script><meta content="目录结构Nginx主目录有如下文件，其中 带temp后缀 的文件夹在刚安装后是没有的，主要用来存放运行过程中的临时文件。 1client_body_temp、conf、fastcgi_temp、html、logs、proxy_temp、sbin、scgi_temp、uwsgi_temp   conf：用来存放配置文件相关。 html：用来存放静态文件的默认目录 html、css等。 sbin：ng" name=description><meta content=article property=og:type><meta content=Nginx系列-Nginx基础应用 property=og:title><meta content=https://hshz21.gitee.io/2024/08/21/Nginx%E5%9F%BA%E6%9C%AC%E5%BA%94%E7%94%A8/index.html property=og:url><meta content=豪哥博客 property=og:site_name><meta content="目录结构Nginx主目录有如下文件，其中 带temp后缀 的文件夹在刚安装后是没有的，主要用来存放运行过程中的临时文件。 1client_body_temp、conf、fastcgi_temp、html、logs、proxy_temp、sbin、scgi_temp、uwsgi_temp   conf：用来存放配置文件相关。 html：用来存放静态文件的默认目录 html、css等。 sbin：ng" property=og:description><meta content=zh_CN property=og:locale><meta content=https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/07/%E5%9F%BA%E7%A1%80%E5%BA%94%E7%94%A8-6.1.2.2-%E5%A4%9A%E7%BA%A7%E7%BC%93%E5%AD%98-%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F-OpenResty-%E8%8E%B7%E5%8F%96%E8%AF%B7%E6%B1%82%E5%8F%82%E6%95%B0.png property=og:image><meta content=2024-08-21T13:39:14.319Z property=article:published_time><meta content=2023-10-02T12:08:49.676Z property=article:modified_time><meta content=豪哥 property=article:author><meta content=Nginx property=article:tag><meta content=Nginx基础 property=article:tag><meta content=summary name=twitter:card><meta content=https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/07/%E5%9F%BA%E7%A1%80%E5%BA%94%E7%94%A8-6.1.2.2-%E5%A4%9A%E7%BA%A7%E7%BC%93%E5%AD%98-%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F-OpenResty-%E8%8E%B7%E5%8F%96%E8%AF%B7%E6%B1%82%E5%8F%82%E6%95%B0.png name=twitter:image><link href=https://hshz21.gitee.io/2024/08/21/Nginx%E5%9F%BA%E6%9C%AC%E5%BA%94%E7%94%A8/ rel=canonical><script class=next-config data-name=page type=application/json>{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://hshz21.gitee.io/2024/08/21/Nginx%E5%9F%BA%E6%9C%AC%E5%BA%94%E7%94%A8/","path":"2024/08/21/Nginx基本应用/","title":"Nginx系列-Nginx基础应用"}</script><script class=next-config data-name=calendar type=application/json>""</script><title>Nginx系列-Nginx基础应用 | 豪哥博客</title><noscript><link href=/css/noscript.css rel=stylesheet></noscript><body class=use-motion itemscope itemtype=http://schema.org/WebPage><div class=headband></div><main class=main><div class=column><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=site-brand-container><div class=site-nav-toggle><div aria-label=切换导航栏 class=toggle role=button><span class=toggle-line></span><span class=toggle-line></span><span class=toggle-line></span></div></div><div class=site-meta><a class=brand href=/ rel=start> <i class=logo-line></i> <p class=site-title>豪哥博客</p> <i class=logo-line></i> </a><p class=site-subtitle itemprop=description>豪哥博客</div><div class=site-nav-right><div class="toggle popup-trigger" aria-label=搜索 role=button><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ rel=section><i class="fa fa-home fa-fw"></i>首页</a><li class="menu-item menu-item-tags"><a href=/tags/ rel=section><i class="fa fa-tags fa-fw"></i>标签</a><li class="menu-item menu-item-categories"><a href=/categories/ rel=section><i class="fa fa-th fa-fw"></i>分类</a><li class="menu-item menu-item-archives"><a href=/archives/ rel=section><i class="fa fa-archive fa-fw"></i>归档</a><li class="menu-item menu-item-search"><a class=popup-trigger role=button><i class="fa fa-search fa-fw"></i>搜索 </a></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon> <i class="fa fa-search"></i> </span><div class=search-input-container><input autocapitalize=off autocomplete=off class=search-input maxlength=80 placeholder=搜索... spellcheck=false type=search></div><span class=popup-btn-close role=button> <i class="fa fa-times-circle"></i> </span></div><div class=search-result-container><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></header><aside class=sidebar><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录<li class=sidebar-nav-overview>站点概览</ul><div class=sidebar-panel-container><!--noindex--><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class=nav><li class="nav-item nav-level-1"><a class=nav-link href=#%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84><span class=nav-number>1.</span> <span class=nav-text>目录结构</span></a><li class="nav-item nav-level-1"><a class=nav-link href=#Nginx%E9%85%8D%E7%BD%AE><span class=nav-number>2.</span> <span class=nav-text>Nginx配置</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#%E6%9C%80%E5%B0%8F%E9%85%8D%E7%BD%AE><span class=nav-number>2.1.</span> <span class=nav-text>最小配置</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B><span class=nav-number>2.2.</span> <span class=nav-text>配置示例</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#server-name%E5%8C%B9%E9%85%8D%E8%A7%84%E5%88%99><span class=nav-number>2.3.</span> <span class=nav-text>server_name匹配规则</span></a></ol><li class="nav-item nav-level-1"><a class=nav-link href=#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1><span class=nav-number>3.</span> <span class=nav-text>负载均衡</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B><span class=nav-number>3.1.</span> <span class=nav-text>使用示例</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AD%96%E7%95%A5><span class=nav-number>3.2.</span> <span class=nav-text>负载均衡策略</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#%E8%BD%AE%E8%AF%A2%EF%BC%88%E9%BB%98%E8%AE%A4%EF%BC%89><span class=nav-number>3.2.1.</span> <span class=nav-text>轮询（默认）</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#%E6%9D%83%E9%87%8D><span class=nav-number>3.2.2.</span> <span class=nav-text>权重</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#ip-hash><span class=nav-number>3.2.3.</span> <span class=nav-text>ip_hash</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#least-conn><span class=nav-number>3.2.4.</span> <span class=nav-text>least_conn</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#url-hash%EF%BC%88%E7%AC%AC%E4%B8%89%E6%96%B9%EF%BC%89><span class=nav-number>3.2.5.</span> <span class=nav-text>url_hash（第三方）</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#fair%EF%BC%88%E7%AC%AC%E4%B8%89%E6%96%B9%EF%BC%89><span class=nav-number>3.2.6.</span> <span class=nav-text>fair（第三方）</span></a></ol><li class="nav-item nav-level-2"><a class=nav-link href=#%E5%8A%A8%E9%9D%99%E5%88%86%E7%A6%BB><span class=nav-number>3.3.</span> <span class=nav-text>动静分离</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#UrlRewrite><span class=nav-number>3.4.</span> <span class=nav-text>UrlRewrite</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#%E8%AF%AD%E6%B3%95%E5%8F%8A%E5%8F%82%E6%95%B0><span class=nav-number>3.4.1.</span> <span class=nav-text>语法及参数</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#%E7%BD%91%E5%85%B3%E9%85%8D%E7%BD%AE><span class=nav-number>3.4.2.</span> <span class=nav-text>网关配置</span></a></ol><li class="nav-item nav-level-2"><a class=nav-link href=#%E9%98%B2%E7%9B%97%E9%93%BE><span class=nav-number>3.5.</span> <span class=nav-text>防盗链</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#%E8%AF%AD%E6%B3%95><span class=nav-number>3.5.1.</span> <span class=nav-text>语法</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B-1><span class=nav-number>3.5.2.</span> <span class=nav-text>配置示例</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#%E6%B5%8B%E8%AF%95><span class=nav-number>3.5.3.</span> <span class=nav-text>测试</span></a></ol></ol><li class="nav-item nav-level-1"><a class=nav-link href=#%E9%AB%98%E5%8F%AF%E7%94%A8><span class=nav-number>4.</span> <span class=nav-text>高可用</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#keepalived><span class=nav-number>4.1.</span> <span class=nav-text>keepalived</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#%E6%A6%82%E8%BF%B0><span class=nav-number>4.1.1.</span> <span class=nav-text>概述</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8><span class=nav-number>4.1.2.</span> <span class=nav-text>安装使用</span></a></ol></ol><li class="nav-item nav-level-1"><a class=nav-link href=#Openresty><span class=nav-number>5.</span> <span class=nav-text>Openresty</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#Docker%E6%96%B9%E5%BC%8F%E5%AE%89%E8%A3%85><span class=nav-number>5.1.</span> <span class=nav-text>Docker方式安装</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C><span class=nav-number>5.1.1.</span> <span class=nav-text>准备工作</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#%E8%BF%90%E8%A1%8C%E5%AE%B9%E5%99%A8><span class=nav-number>5.1.2.</span> <span class=nav-text>运行容器</span></a></ol><li class="nav-item nav-level-2"><a class=nav-link href=#%E6%9C%AC%E5%9C%B0%E5%AE%89%E8%A3%85><span class=nav-number>5.2.</span> <span class=nav-text>本地安装</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#1-2-1%E3%80%81%E5%AE%89%E8%A3%85%E5%BC%80%E5%8F%91%E5%BA%93><span class=nav-number>5.2.1.</span> <span class=nav-text>1.2.1、安装开发库</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#1-2-2%E3%80%81%E5%AE%89%E8%A3%85OpenResty%E4%BB%93%E5%BA%93><span class=nav-number>5.2.2.</span> <span class=nav-text>1.2.2、安装OpenResty仓库</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#1-2-3%E3%80%81%E5%AE%89%E8%A3%85OpenResty><span class=nav-number>5.2.3.</span> <span class=nav-text>1.2.3、安装OpenResty</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#1-2-4%E3%80%81%E5%AE%89%E8%A3%85opm%E5%B7%A5%E5%85%B7><span class=nav-number>5.2.4.</span> <span class=nav-text>1.2.4、安装opm工具</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#1-2-5%E3%80%81%E9%85%8D%E7%BD%AENginx%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F><span class=nav-number>5.2.5.</span> <span class=nav-text>1.2.5、配置Nginx环境变量</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#1-2-6%E3%80%81%E5%90%AF%E5%8A%A8%E8%BF%90%E8%A1%8C><span class=nav-number>5.2.6.</span> <span class=nav-text>1.2.6、启动运行</span></a></ol><li class="nav-item nav-level-2"><a class=nav-link href=#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8><span class=nav-number>5.3.</span> <span class=nav-text>基本使用</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#%E7%9B%91%E5%90%AC%E5%A4%84%E7%90%86%E8%AF%B7%E6%B1%82><span class=nav-number>5.3.1.</span> <span class=nav-text>监听处理请求</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#%E8%8E%B7%E5%8F%96%E8%AF%B7%E6%B1%82%E5%8F%82%E6%95%B0><span class=nav-number>5.3.2.</span> <span class=nav-text>获取请求参数</span></a></ol><li class="nav-item nav-level-2"><a class=nav-link href=#Nginx%E6%9C%AC%E5%9C%B0%E7%BC%93%E5%AD%98><span class=nav-number>5.4.</span> <span class=nav-text>Nginx本地缓存</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#%E7%AE%80%E4%BB%8B><span class=nav-number>5.4.1.</span> <span class=nav-text>简介</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#%E4%BD%BF%E7%94%A8><span class=nav-number>5.4.2.</span> <span class=nav-text>使用</span></a></ol><li class="nav-item nav-level-2"><a class=nav-link href=#Nginx%E8%AE%BF%E9%97%AERedis><span class=nav-number>5.5.</span> <span class=nav-text>Nginx访问Redis</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#%E7%AE%80%E4%BB%8B-1><span class=nav-number>5.5.1.</span> <span class=nav-text>简介</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE><span class=nav-number>5.5.2.</span> <span class=nav-text>环境配置</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#%E5%B0%81%E8%A3%85%E5%B7%A5%E5%85%B7><span class=nav-number>5.5.3.</span> <span class=nav-text>封装工具</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#%E6%B5%8B%E8%AF%95%E7%A4%BA%E4%BE%8B><span class=nav-number>5.5.4.</span> <span class=nav-text>测试示例</span></a></ol><li class="nav-item nav-level-2"><a class=nav-link href=#Nginx%E8%AE%BF%E9%97%AETomcat><span class=nav-number>5.6.</span> <span class=nav-text>Nginx访问Tomcat</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#%E5%8F%91%E9%80%81HTTP%E8%AF%B7%E6%B1%82><span class=nav-number>5.6.1.</span> <span class=nav-text>发送HTTP请求</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#proxy-pass%E6%96%B9%E5%BC%8F><span class=nav-number>5.6.2.</span> <span class=nav-text>proxy_pass方式</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#cosocket%E6%96%B9%E5%BC%8F><span class=nav-number>5.6.3.</span> <span class=nav-text>cosocket方式</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE-1><span class=nav-number>5.6.4.</span> <span class=nav-text>环境配置</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#%E5%B0%81%E8%A3%85%E5%B7%A5%E5%85%B7-1><span class=nav-number>5.6.5.</span> <span class=nav-text>封装工具</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#%E6%B5%8B%E8%AF%95%E7%A4%BA%E4%BE%8B-1><span class=nav-number>5.6.6.</span> <span class=nav-text>测试示例</span></a></ol></ol></ol></div></div><!--/noindex--><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop=author itemscope itemtype=http://schema.org/Person><img alt=豪哥 class=site-author-image itemprop=image src=/static/imgs/avatar.png><p class=site-author-name itemprop=name>豪哥<div class=site-description itemprop=description>豪哥博客</div></div><div class="site-state-wrap animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/> <span class=site-state-item-count>109</span> <span class=site-state-item-name>日志</span> </a></div><div class="site-state-item site-state-categories"><a href=/categories/> <span class=site-state-item-count>33</span> <span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/> <span class=site-state-item-count>126</span> <span class=site-state-item-name>标签</span></a></div></nav></div></div></div></div></aside></div><div class="main-inner post posts-expand"><div class=post-block><article class=post-content itemscope itemtype=http://schema.org/Article lang=zh-CN><link href=https://hshz21.gitee.io/2024/08/21/Nginx%E5%9F%BA%E6%9C%AC%E5%BA%94%E7%94%A8/ itemprop=mainEntityOfPage><span hidden itemprop=author itemscope itemtype=http://schema.org/Person> <meta content=/static/imgs/avatar.png itemprop=image> <meta content=豪哥 itemprop=name> </span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization> <meta content=豪哥博客 itemprop=name> <meta content=豪哥博客 itemprop=description> </span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork> <meta content="Nginx系列-Nginx基础应用 | 豪哥博客" itemprop=name> <meta itemprop=description> </span><header class=post-header><h1 itemprop="name headline" class=post-title>Nginx系列-Nginx基础应用</h1><div class=post-meta-container><div class=post-meta><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar"></i> </span> <span class=post-meta-item-text>发表于</span> <time itemprop="dateCreated datePublished" title="创建时间：2024-08-21 21:39:14" datetime=2024-08-21T21:39:14+08:00>2024-08-21</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar-check"></i> </span> <span class=post-meta-item-text>更新于</span> <time title="修改时间：2023-10-02 20:08:49" datetime=2023-10-02T20:08:49+08:00 itemprop=dateModified>2023-10-02</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-folder"></i> </span> <span class=post-meta-item-text>分类于</span> <span itemprop=about itemscope itemtype=http://schema.org/Thing> <a href=/categories/Nginx/ itemprop=url rel=index><span itemprop=name>Nginx</span></a> </span> </span></div></div></header><div class=post-body itemprop=articleBody><h1 id=目录结构><a class=headerlink href=#目录结构 title=目录结构></a>目录结构</h1><p>Nginx主目录有如下文件，其中 带temp后缀 的文件夹在刚安装后是没有的，主要用来存放运行过程中的临时文件。<figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line><span class=attr>client_body_temp、conf、fastcgi_temp、html、logs、proxy_temp、sbin、scgi_temp、uwsgi_temp</span></span><br></pre></table></figure><ul><li>conf：用来存放配置文件相关。<li>html：用来存放静态文件的默认目录 html、css等。<li>sbin：nginx的主程序。</ul><h1 id=Nginx配置><a class=headerlink href=#Nginx配置 title=Nginx配置></a>Nginx配置</h1><h2 id=最小配置><a class=headerlink href=#最小配置 title=最小配置></a>最小配置</h2><ul><li><p><strong>worker_processes</strong>：业务进程数量，默认1。</p><li><p><strong>worker_connections</strong>：单个业务进程连接数，默认1024。</p><li><p><strong>include mime.types</strong>：引入http mime类型。</p><li><p><strong>default_type application/octet-stream</strong>：如果mime类型没匹配上，默认使用二进制流的方式传输。</p><li><p><strong>sendfile on</strong>：使用 linux sendfile(socket, file, len) 高效网络传输，也就是数据 零拷贝。</p><li><p><strong>keepalive_timeout</strong>：长连接超时时间，65。</p></ul><h2 id=配置示例><a class=headerlink href=#配置示例 title=配置示例></a>配置示例</h2><figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br></pre><td class=code><pre><span class=line><span class=attr>server</span> <span class=string>{</span></span><br><span class=line>    <span class=attr>listen</span> <span class=string>80; 监听端口号</span></span><br><span class=line>    <span class=attr>server_name</span> <span class=string>localhost; 主机名</span></span><br><span class=line>    <span class=attr>location</span> <span class=string>/ { 匹配路径</span></span><br><span class=line>        <span class=attr>root</span> <span class=string>html; 文件根目录</span></span><br><span class=line>        <span class=attr>index</span> <span class=string>index.html index.htm; 默认页名称</span></span><br><span class=line>    <span class=attr>}</span></span><br><span class=line>    <span class=attr>error_page</span> <span class=string>500 502 503 504 /50x.html; 报错编码对应页面</span></span><br><span class=line>    <span class=attr>location</span> = <span class=string>/50x.html {</span></span><br><span class=line>    	<span class=attr>root</span> <span class=string>html;</span></span><br><span class=line>    <span class=attr>}</span></span><br><span class=line><span class=attr>}</span></span><br></pre></table></figure><h2 id=server-name匹配规则><a class=headerlink href=#server-name匹配规则 title=server_name匹配规则></a>server_name匹配规则</h2><ul><li><p>完整匹配</p> <figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line><span class=attr>server_name</span> <span class=string>vod.mmban.com www1.mmban.com;</span></span><br></pre></table></figure><li><p>通配符匹配</p> <figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line><span class=attr>server_name</span> <span class=string>*.mmban.com</span></span><br></pre></table></figure><li><p>通配符结束匹配</p> <figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line><span class=attr>server_name</span> <span class=string>vod.*;</span></span><br></pre></table></figure><li><p>正则匹配</p> <figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line><span class=attr>server_name</span> <span class=string>~^[0-9]+\.mmban\.com$;</span></span><br></pre></table></figure></ul><h1 id=负载均衡><a class=headerlink href=#负载均衡 title=负载均衡></a>负载均衡</h1><h2 id=使用示例><a class=headerlink href=#使用示例 title=使用示例></a>使用示例</h2><figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre><td class=code><pre><span class=line><span class=attr>upstream</span> <span class=string>httpd {</span></span><br><span class=line>    <span class=attr>server</span> <span class=string>192.168.44.102:80;</span></span><br><span class=line>    <span class=attr>server</span> <span class=string>192.168.43.103:80;</span></span><br><span class=line><span class=attr>}</span></span><br><span class=line></span><br><span class=line><span class=attr>location</span> <span class=string>/ {</span></span><br><span class=line>	<span class=attr>proxy_pass</span> <span class=string>http://httpd;</span></span><br><span class=line><span class=attr>}</span></span><br></pre></table></figure><h2 id=负载均衡策略><a class=headerlink href=#负载均衡策略 title=负载均衡策略></a>负载均衡策略</h2><h3 id=轮询（默认）><a class=headerlink href=#轮询（默认） title=轮询（默认）></a>轮询（默认）</h3><p><strong>轮询是默认策略。每个请求会按时间顺序逐一分配到不同的后端服务器</strong>。<p>参数：<ul><li><strong>fail_timeout</strong>：与max_fails结合使用。<li><strong>max_fails</strong>：fail_timeout时间内请求失败次数超过该参数值，就会确认为服务器宕机。<li><strong>fail_time</strong>：停机时间长度，默认为10s。<li><strong>backup</strong>：标记服务器为备用服务器，当主服务器无法提供服务时，备用服务器将负责提供服务。<li><strong>down</strong>：标记服务器永久停机。</ul><p>注意事项：<ul><li>轮询过程中服务器宕机会被自动移除。<li>轮询策略是默认配置。<li>适用于 无状态且短平快的服务。</ul><h3 id=权重><a class=headerlink href=#权重 title=权重></a>权重</h3><p><strong>在轮询基础上设置权重，权重越大优先提供服务。使用 weight 参数设置权重，默认值1</strong>。<figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line><span class=attr>upstream</span> <span class=string>httpd {</span></span><br><span class=line>    <span class=attr>server</span> <span class=string>127.0.0.1:8050 weight=10 down;</span></span><br><span class=line>    <span class=attr>server</span> <span class=string>127.0.0.1:8060 weight=1;</span></span><br><span class=line>    <span class=attr>server</span> <span class=string>127.0.0.1:8060 weight=1 backup;</span></span><br><span class=line><span class=attr>}</span></span><br></pre></table></figure><p>参数解析：<ul><li><strong>down</strong>：当前server暂时不参与负载。<li><strong>weight</strong>：默认为1，weight越大，负载权重越大。<li><strong>backup</strong>：非backup机器不能工作时，请求将转发至backup机器。</ul><p>注意事项：<ul><li>权重越高 表示 需要处理的请求越多。<li>可以与 least_conn 和 ip_hash 结合使用。<li>适用于 服务器配置相差较大的服务。</ul><h3 id=ip-hash><a class=headerlink href=#ip-hash title=ip_hash></a>ip_hash</h3><p><strong>根据ip地址转发至同一服务器。适用于有状态的服务</strong>。<figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre><td class=code><pre><span class=line><span class=attr>upstream</span> <span class=string>dynamic_zuoyu {</span></span><br><span class=line>    <span class=attr>ip_hash;</span>  <span class=string>#保证每个访客固定访问一个后端服务器</span></span><br><span class=line>    <span class=attr>server</span> <span class=string>localhost:8080  weight=2; 				 	 #tomcat 7.0</span></span><br><span class=line>    <span class=attr>server</span> <span class=string>localhost:8081; 								#tomcat 8.0</span></span><br><span class=line>    <span class=attr>server</span> <span class=string>localhost:8082; 								#tomcat 8.5</span></span><br><span class=line>    <span class=attr>server</span> <span class=string>localhost:8083  max_fails=3 fail_timeout=20s;   #tomcat 9.0</span></span><br><span class=line><span class=attr>}</span></span><br></pre></table></figure><p>注意：<ul><li>nginx 1.3.1前，不能在ip_hash中使用权重weight。<li>ip_hash不能与backup同时使用。<li>服务器需要被移除时必须手动执行。</ul><h3 id=least-conn><a class=headerlink href=#least-conn title=least_conn></a>least_conn</h3><p><strong>将请求转发给连接数较少的后端服务器。适用于处理请求时间长短不同的服务</strong>。<figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre><td class=code><pre><span class=line><span class=attr>upstream</span> <span class=string>dynamic_zuoyu {</span></span><br><span class=line>  <span class=attr>least_conn;</span>  <span class=string>#把请求转发给连接数较少的后端服务器</span></span><br><span class=line>  <span class=attr>server</span> <span class=string>localhost:8080  weight=2; #tomcat 7.0</span></span><br><span class=line>  <span class=attr>server</span> <span class=string>localhost:8081; #tomcat 8.0</span></span><br><span class=line>  <span class=attr>server</span> <span class=string>localhost:8082 backup; #tomcat 8.5</span></span><br><span class=line>  <span class=attr>server</span> <span class=string>localhost:8083  max_fails=3 fail_timeout=20s; #tomcat 9.0</span></span><br><span class=line><span class=attr>}</span></span><br></pre></table></figure><h3 id=url-hash（第三方）><a class=headerlink href=#url-hash（第三方） title=url_hash（第三方）></a>url_hash（第三方）</h3><p><strong>根据请求url的hash来分配请求，可以将每个url定向到同一个服务器，要配合缓存命中来使用</strong>。<figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre><td class=code><pre><span class=line><span class=attr>upstream</span> <span class=string>dynamic_zuoyu {</span></span><br><span class=line>  <span class=attr>hash</span> <span class=string>$request_uri;  #实现每个url定向到同一个后端服务器</span></span><br><span class=line>  <span class=attr>server</span> <span class=string>localhost:8080; #tomcat 7.0</span></span><br><span class=line>  <span class=attr>server</span> <span class=string>localhost:8081; #tomcat 8.0</span></span><br><span class=line>  <span class=attr>server</span> <span class=string>localhost:8082; #tomcat 8.5</span></span><br><span class=line>  <span class=attr>server</span> <span class=string>localhost:8083; #tomcat 9.0</span></span><br><span class=line><span class=attr>}</span></span><br></pre></table></figure><h3 id=fair（第三方）><a class=headerlink href=#fair（第三方） title=fair（第三方）></a>fair（第三方）</h3><p><strong>根据 服务响应时间来分配请求，响应时间短的优先分配</strong>。<figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre><td class=code><pre><span class=line><span class=attr>upstream</span> <span class=string>dynamic_zuoyu {</span></span><br><span class=line>  <span class=attr>server</span> <span class=string>localhost:8080; #tomcat 7.0</span></span><br><span class=line>  <span class=attr>server</span> <span class=string>localhost:8081; #tomcat 8.0</span></span><br><span class=line>  <span class=attr>server</span> <span class=string>localhost:8082; #tomcat 8.5</span></span><br><span class=line>  <span class=attr>server</span> <span class=string>localhost:8083; #tomcat 9.0</span></span><br><span class=line>  <span class=attr>fair;</span>  <span class=string>#实现响应时间短的优先分配</span></span><br><span class=line><span class=attr>}</span></span><br></pre></table></figure><h2 id=动静分离><a class=headerlink href=#动静分离 title=动静分离></a>动静分离</h2><figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br></pre><td class=code><pre><span class=line><span class=comment># 静态文件放在 html\static 目录下</span></span><br><span class=line><span class=attr>nginx\html\static</span></span><br><span class=line><span class=comment></span></span><br><span class=line><span class=comment># nginx.conf文件添加配置</span></span><br><span class=line><span class=attr>server</span> <span class=string>{</span></span><br><span class=line>	<span class=attr>listen</span>       <span class=string>80;</span></span><br><span class=line>	<span class=attr>server_name</span>  <span class=string>xxx.com *.xxx.com;</span></span><br><span class=line>	<span class=attr>underscores_in_headers</span> <span class=string>on;</span></span><br><span class=line><span class=comment>	</span></span><br><span class=line><span class=comment>	# 方式1（二选一）</span></span><br><span class=line>	<span class=attr>location</span> <span class=string>/static/ {</span></span><br><span class=line>		<span class=attr>root</span> <span class=string>html;</span></span><br><span class=line>	<span class=attr>}</span></span><br><span class=line><span class=comment>	</span></span><br><span class=line><span class=comment>	# 方式2（二选一）</span></span><br><span class=line>	<span class=attr>location</span> <span class=string>~*/(css|img|js) {</span></span><br><span class=line>        <span class=attr>root</span> <span class=string>/usr/local/nginx/static;</span></span><br><span class=line>        <span class=attr>index</span> <span class=string>index.html index.htm;</span></span><br><span class=line>    <span class=attr>}</span></span><br><span class=line></span><br><span class=line>	<span class=attr>location</span> <span class=string>/ {</span></span><br><span class=line>		<span class=attr>proxy_set_header</span> <span class=string>Host $host;</span></span><br><span class=line>		<span class=attr>proxy_pass</span> <span class=string>http://gulimall;</span></span><br><span class=line>	<span class=attr>}</span></span><br><span class=line><span class=attr>}</span></span><br></pre></table></figure><h2 id=UrlRewrite><a class=headerlink href=#UrlRewrite title=UrlRewrite></a>UrlRewrite</h2><p><strong>rewrite可实现<code>url</code>重写，根据<code>regex</code>（正则表达式）重定向到<code>replacement</code>，结尾是flag标记。</strong><h3 id=语法及参数><a class=headerlink href=#语法及参数 title=语法及参数></a>语法及参数</h3><figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line><span class=attr>关键字</span>   <span class=string>正则     替代内容      flag标记</span></span><br><span class=line><span class=attr>rewrite</span> <span class=string>&LTregex> &LTreplacement> [flag];</span></span><br></pre></table></figure><ul><li>正则：判断是否满足特定需求的一种规则。<li>替代内容：符合正则匹配需求时，需要的替换内容。<li>flag标记：rewrite支持的flag标记。<ul><li>last #本条规则匹配完成后，继续向下匹配新的location URI规则。<li>break #本条规则匹配完成即终止，不再匹配后面的任何规则。<li>redirect #返回302临时重定向，浏览器地址会显示跳转后的URL地址。<li>permanent #返回301永久重定向，浏览器地址栏会显示跳转后的URL地址。</ul></ul><p>配置示例：<figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>rewrite ^/([0-9]+).html$ /index.jsp?pageNum=<span class=variable>$1</span> <span class=built_in>break</span>;</span><br></pre></table></figure><h3 id=网关配置><a class=headerlink href=#网关配置 title=网关配置></a>网关配置</h3><figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre><td class=code><pre><span class=line><span class=attr>upstream</span> <span class=string>httpds {</span></span><br><span class=line>    <span class=attr>server</span> <span class=string>192.168.44.102 weight=8 down;</span></span><br><span class=line>    <span class=attr>server</span> <span class=string>192.168.44.103:8080 weight=2;</span></span><br><span class=line>    <span class=attr>server</span> <span class=string>192.168.44.104:8080 weight=1 backup;</span></span><br><span class=line><span class=attr>}</span></span><br><span class=line><span class=attr>location</span> <span class=string>/ {</span></span><br><span class=line>    <span class=attr>rewrite</span> <span class=string>^/([0-9]+).html$ /index.jsp?pageNum=$1 redirect;</span></span><br><span class=line>    <span class=attr>proxy_pass</span> <span class=string>http://httpds ;</span></span><br><span class=line><span class=attr>}</span></span><br></pre></table></figure><h2 id=防盗链><a class=headerlink href=#防盗链 title=防盗链></a>防盗链</h2><h3 id=语法><a class=headerlink href=#语法 title=语法></a>语法</h3><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>valid_referers none | blocked | server_names | strings ....;</span><br></pre></table></figure><ul><li>none：检测 Referer 头域不存在的情况。<li>blocked：检测 Referer 头域的值被防火墙或代理服务器删除或伪装的情况。这种情况该头域的值不以 “http://” 或 “https://” 开头。<li>server_names：设置一个或多个 URL ，检测 Referer 头域的值是否是这些 URL 中的某一个。</ul><h3 id=配置示例-1><a class=headerlink href=#配置示例-1 title=配置示例></a>配置示例</h3><p>在需要防盗链的location中配置：<figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line><span class=attr>valid_referers</span> <span class=string>192.168.44.101;</span></span><br><span class=line><span class=attr>if</span> <span class=string>($invalid_referer) {</span></span><br><span class=line>	<span class=attr>return</span> <span class=string>403;</span></span><br><span class=line><span class=attr>}</span></span><br></pre></table></figure><h3 id=测试><a class=headerlink href=#测试 title=测试></a>测试</h3><figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line><span class=comment># curl测试</span></span><br><span class=line><span class=attr>curl</span> <span class=string>-I http://192.168.44.101/img/logo.png</span></span><br><span class=line><span class=comment># 带引用</span></span><br><span class=line><span class=attr>curl</span> <span class=string>-e "http://baidu.com" -I http://192.168.44.101/img/logo.png</span></span><br></pre></table></figure><h1 id=高可用><a class=headerlink href=#高可用 title=高可用></a>高可用</h1><h2 id=keepalived><a class=headerlink href=#keepalived title=keepalived></a>keepalived</h2><h3 id=概述><a class=headerlink href=#概述 title=概述></a>概述</h3><p><strong>Keepalived 是一个开源的高可用解决方案，用于确保服务和网络的连续可用性。它主要用于构建高可用性集群，提供故障切换和故障恢复机制。</strong><p><strong>Keepalived 基于虚拟路由冗余协议 VRRP 实现了服务器的冗余和故障转移。</strong>VRRP 是一种网络协议，用于将多个路由器组成一个虚拟路由器，提供故障切换和负载均衡功能。<p>Keepalived监视服务器的状态和可用性，一旦活动服务器发生故障不可用，它会自动将备份服务器切换为活动状态，接管服务并继续提供服务。<p><strong>除了故障转移，Keepalived 还提供了健康检测、负载均衡、通知机制等功能。</strong><h3 id=安装使用><a class=headerlink href=#安装使用 title=安装使用></a>安装使用</h3><p><strong>（1）通过命令安装</strong><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line><span class=comment># 安装keepalived</span></span><br><span class=line>yum install keepalived</span><br></pre></table></figure><p>安装后配置文件在<code>/etc/keepalived/keepalived.conf</code>。<p><strong>（2）配置</strong><p>master配置信息如下：<figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br></pre><td class=code><pre><span class=line><span class=comment>! Configuration File for keepalived</span></span><br><span class=line><span class=attr>global_defs</span> <span class=string>{</span></span><br><span class=line>	<span class=attr>router_id</span> <span class=string>lb111</span></span><br><span class=line><span class=attr>}</span></span><br><span class=line><span class=attr>vrrp_instance</span> <span class=string>atguigu {</span></span><br><span class=line>    <span class=attr>state</span> <span class=string>MASTER</span></span><br><span class=line>    <span class=attr>interface</span> <span class=string>ens33</span></span><br><span class=line>    <span class=attr>virtual_router_id</span> <span class=string>51</span></span><br><span class=line>    <span class=attr>priority</span> <span class=string>100</span></span><br><span class=line>    <span class=attr>advert_int</span> <span class=string>1</span></span><br><span class=line>    <span class=attr>authentication</span> <span class=string>{</span></span><br><span class=line>        <span class=attr>auth_type</span> <span class=string>PASS</span></span><br><span class=line>        <span class=attr>auth_pass</span> <span class=string>1111</span></span><br><span class=line>    <span class=attr>}</span></span><br><span class=line>    <span class=attr>virtual_ipaddress</span> <span class=string>{</span></span><br><span class=line>        <span class=attr>192.168.44.200</span></span><br><span class=line>    <span class=attr>}</span></span><br><span class=line><span class=attr>}</span></span><br></pre></table></figure><p>backup配置如下：<figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br></pre><td class=code><pre><span class=line><span class=comment>! Configuration File for keepalived</span></span><br><span class=line><span class=attr>global_defs</span> <span class=string>{</span></span><br><span class=line>	<span class=attr>router_id</span> <span class=string>lb110</span></span><br><span class=line><span class=attr>}</span></span><br><span class=line><span class=attr>vrrp_instance</span> <span class=string>atguigu {</span></span><br><span class=line>    <span class=attr>state</span> <span class=string>BACKUP	# 需要修改</span></span><br><span class=line>    <span class=attr>interface</span> <span class=string>ens33</span></span><br><span class=line>    <span class=attr>virtual_router_id</span> <span class=string>51</span></span><br><span class=line>    <span class=attr>priority</span> <span class=string>50		# 需要修改</span></span><br><span class=line>    <span class=attr>advert_int</span> <span class=string>1</span></span><br><span class=line>    <span class=attr>authentication</span> <span class=string>{</span></span><br><span class=line>        <span class=attr>auth_type</span> <span class=string>PASS</span></span><br><span class=line>        <span class=attr>auth_pass</span> <span class=string>1111</span></span><br><span class=line>    <span class=attr>}</span></span><br><span class=line>    <span class=attr>virtual_ipaddress</span> <span class=string>{</span></span><br><span class=line>        <span class=attr>192.168.44.200</span></span><br><span class=line>    <span class=attr>}</span></span><br><span class=line><span class=attr>}</span></span><br></pre></table></figure><p><strong>（3）启动服务，测试效果</strong><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>systemctl start keepalived</span><br></pre></table></figure><h1 id=Openresty><a class=headerlink href=#Openresty title=Openresty></a>Openresty</h1><h2 id=Docker方式安装><a class=headerlink href=#Docker方式安装 title=Docker方式安装></a>Docker方式安装</h2><h3 id=准备工作><a class=headerlink href=#准备工作 title=准备工作></a>准备工作</h3><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre><td class=code><pre><span class=line><span class=comment># 1、拉取镜像</span></span><br><span class=line>docker pull openresty/openresty</span><br><span class=line></span><br><span class=line><span class=comment># 2、创建文件夹</span></span><br><span class=line><span class=built_in>mkdir</span>  /tmp/openresty/data</span><br><span class=line><span class=built_in>mkdir</span>  /tmp/openresty/conf</span><br></pre></table></figure><p>在<code>/tmp/openresty/conf</code>目录下创建<code>nginx.conf</code>文件，添加如下内容：<figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br><span class=line>61</span><br><span class=line>62</span><br><span class=line>63</span><br><span class=line>64</span><br><span class=line>65</span><br><span class=line>66</span><br><span class=line>67</span><br><span class=line>68</span><br><span class=line>69</span><br><span class=line>70</span><br><span class=line>71</span><br><span class=line>72</span><br><span class=line>73</span><br><span class=line>74</span><br><span class=line>75</span><br><span class=line>76</span><br><span class=line>77</span><br><span class=line>78</span><br><span class=line>79</span><br><span class=line>80</span><br><span class=line>81</span><br><span class=line>82</span><br><span class=line>83</span><br><span class=line>84</span><br><span class=line>85</span><br></pre><td class=code><pre><span class=line><span class=comment># nginx.conf  --  docker-openresty</span></span><br><span class=line><span class=comment>#</span></span><br><span class=line><span class=comment># This file is installed to:</span></span><br><span class=line><span class=comment>#   `/usr/local/openresty/nginx/conf/nginx.conf`</span></span><br><span class=line><span class=comment># and is the file loaded by nginx at startup,</span></span><br><span class=line><span class=comment># unless the user specifies otherwise.</span></span><br><span class=line><span class=comment>#</span></span><br><span class=line><span class=comment># It tracks the upstream OpenResty's `nginx.conf`, but removes the `server`</span></span><br><span class=line><span class=comment># section and adds this directive:</span></span><br><span class=line><span class=comment>#     `include /etc/nginx/conf.d/*.conf;`</span></span><br><span class=line><span class=comment>#</span></span><br><span class=line><span class=comment># The `docker-openresty` file `nginx.vh.default.conf` is copied to</span></span><br><span class=line><span class=comment># `/etc/nginx/conf.d/default.conf`.  It contains the `server section</span></span><br><span class=line><span class=comment># of the upstream `nginx.conf`.</span></span><br><span class=line><span class=comment>#</span></span><br><span class=line><span class=comment># See https://github.com/openresty/docker-openresty/blob/master/README.md#nginx-config-files</span></span><br><span class=line><span class=comment>#</span></span><br><span class=line><span class=comment></span></span><br><span class=line><span class=comment>#user  nobody;</span></span><br><span class=line><span class=comment>#worker_processes 1;</span></span><br><span class=line><span class=comment></span></span><br><span class=line><span class=comment># Enables the use of JIT for regular expressions to speed-up their processing.</span></span><br><span class=line><span class=attr>pcre_jit</span> <span class=string>on;</span></span><br><span class=line><span class=comment></span></span><br><span class=line><span class=comment>#error_log  logs/error.log;</span></span><br><span class=line><span class=comment>#error_log  logs/error.log  notice;</span></span><br><span class=line><span class=comment>#error_log  logs/error.log  info;</span></span><br><span class=line><span class=comment>#pid        logs/nginx.pid;</span></span><br><span class=line></span><br><span class=line><span class=attr>events</span> <span class=string>{</span></span><br><span class=line>    <span class=attr>worker_connections</span>  <span class=string>1024;</span></span><br><span class=line><span class=attr>}</span></span><br><span class=line></span><br><span class=line><span class=attr>http</span> <span class=string>{</span></span><br><span class=line>    <span class=attr>include</span>       <span class=string>mime.types;</span></span><br><span class=line>    <span class=attr>default_type</span>  <span class=string>application/octet-stream;</span></span><br><span class=line><span class=comment></span></span><br><span class=line><span class=comment>    # Enables or disables the use of underscores in client request header fields.</span></span><br><span class=line><span class=comment>    # When the use of underscores is disabled, request header fields whose names contain underscores are marked as invalid and become subject to the ignore_invalid_headers directive.</span></span><br><span class=line><span class=comment>    # underscores_in_headers off;</span></span><br><span class=line><span class=comment></span></span><br><span class=line><span class=comment>    #log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '</span></span><br><span class=line><span class=comment>    #                  '$status $body_bytes_sent "$http_referer" '</span></span><br><span class=line><span class=comment>    #                  '"$http_user_agent" "$http_x_forwarded_for"';</span></span><br><span class=line><span class=comment></span></span><br><span class=line><span class=comment>    #access_log  logs/access.log  main;</span></span><br><span class=line><span class=comment></span></span><br><span class=line><span class=comment>        # Log in JSON Format</span></span><br><span class=line><span class=comment>        # log_format nginxlog_json escape=json '{ "timestamp": "$time_iso8601", '</span></span><br><span class=line><span class=comment>        # '"remote_addr": "$remote_addr", '</span></span><br><span class=line><span class=comment>        #  '"body_bytes_sent": $body_bytes_sent, '</span></span><br><span class=line><span class=comment>        #  '"request_time": $request_time, '</span></span><br><span class=line><span class=comment>        #  '"response_status": $status, '</span></span><br><span class=line><span class=comment>        #  '"request": "$request", '</span></span><br><span class=line><span class=comment>        #  '"request_method": "$request_method", '</span></span><br><span class=line><span class=comment>        #  '"host": "$host",'</span></span><br><span class=line><span class=comment>        #  '"upstream_addr": "$upstream_addr",'</span></span><br><span class=line><span class=comment>        #  '"http_x_forwarded_for": "$http_x_forwarded_for",'</span></span><br><span class=line><span class=comment>        #  '"http_referrer": "$http_referer", '</span></span><br><span class=line><span class=comment>        #  '"http_user_agent": "$http_user_agent", '</span></span><br><span class=line><span class=comment>        #  '"http_version": "$server_protocol", '</span></span><br><span class=line><span class=comment>        #  '"nginx_access": true }';</span></span><br><span class=line><span class=comment>        # access_log /dev/stdout nginxlog_json;</span></span><br><span class=line><span class=comment></span></span><br><span class=line><span class=comment>    # See Move default writable paths to a dedicated directory (#119)</span></span><br><span class=line><span class=comment>    # https://github.com/openresty/docker-openresty/issues/119</span></span><br><span class=line>    <span class=attr>client_body_temp_path</span> <span class=string>/var/run/openresty/nginx-client-body;</span></span><br><span class=line>    <span class=attr>proxy_temp_path</span>       <span class=string>/var/run/openresty/nginx-proxy;</span></span><br><span class=line>    <span class=attr>fastcgi_temp_path</span>     <span class=string>/var/run/openresty/nginx-fastcgi;</span></span><br><span class=line>    <span class=attr>uwsgi_temp_path</span>       <span class=string>/var/run/openresty/nginx-uwsgi;</span></span><br><span class=line>    <span class=attr>scgi_temp_path</span>        <span class=string>/var/run/openresty/nginx-scgi;</span></span><br><span class=line></span><br><span class=line>    <span class=attr>sendfile</span>        <span class=string>on;</span></span><br><span class=line><span class=comment>    #tcp_nopush     on;</span></span><br><span class=line><span class=comment></span></span><br><span class=line><span class=comment>    #keepalive_timeout  0;</span></span><br><span class=line>    <span class=attr>keepalive_timeout</span>  <span class=string>65;</span></span><br><span class=line><span class=comment></span></span><br><span class=line><span class=comment>    #gzip  on;</span></span><br><span class=line></span><br><span class=line>    <span class=attr>include</span> <span class=string>/etc/nginx/conf.d/*.conf;</span></span><br><span class=line><span class=comment></span></span><br><span class=line><span class=comment>    # Don't reveal OpenResty version to clients.</span></span><br><span class=line><span class=comment>    # server_tokens off;</span></span><br><span class=line><span class=attr>}</span></span><br></pre></table></figure><h3 id=运行容器><a class=headerlink href=#运行容器 title=运行容器></a>运行容器</h3><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre><td class=code><pre><span class=line>docker run -<span class=built_in>id</span> -p 80:80 \</span><br><span class=line>--name openresty --restart always \</span><br><span class=line>-v /tmp/openresty/conf/nginx.conf:/usr/local/openresty/nginx/conf/nginx.conf \</span><br><span class=line>-v /etc/localtime:/etc/localtime \</span><br><span class=line>openresty/openresty</span><br><span class=line>---</span><br><span class=line>-v /tmp/openresty/lualib:/usr/local/openresty/lualib \</span><br></pre></table></figure><h2 id=本地安装><a class=headerlink href=#本地安装 title=本地安装></a>本地安装</h2><h3 id=1-2-1、安装开发库><a class=headerlink href=#1-2-1、安装开发库 title=1.2.1、安装开发库></a>1.2.1、安装开发库</h3><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>yum install -y pcre-devel openssl-devel gcc --skip-broken</span><br></pre></table></figure><h3 id=1-2-2、安装OpenResty仓库><a class=headerlink href=#1-2-2、安装OpenResty仓库 title=1.2.2、安装OpenResty仓库></a>1.2.2、安装OpenResty仓库</h3><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>yum-config-manager --add-repo https://openresty.org/package/centos/openresty.repo</span><br></pre></table></figure><p>若提示命令不存在，则运行下面命令，然后再重新安装。<figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>yum install -y yum-utils </span><br></pre></table></figure><h3 id=1-2-3、安装OpenResty><a class=headerlink href=#1-2-3、安装OpenResty title=1.2.3、安装OpenResty></a>1.2.3、安装OpenResty</h3><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>yum install -y openresty</span><br></pre></table></figure><h3 id=1-2-4、安装opm工具><a class=headerlink href=#1-2-4、安装opm工具 title=1.2.4、安装opm工具></a>1.2.4、安装opm工具</h3><p>opm是OpenResty的一个管理工具，可以帮助我们安装一个第三方的Lua模块。<p>如果你想安装命令行工具 <code>opm</code>，那么可以像下面这样安装 <code>openresty-opm</code> 包：<figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>yum install -y openresty-opm</span><br></pre></table></figure><h3 id=1-2-5、配置Nginx环境变量><a class=headerlink href=#1-2-5、配置Nginx环境变量 title=1.2.5、配置Nginx环境变量></a>1.2.5、配置Nginx环境变量</h3><p>编辑<code>/etc/profile</code>文件，添加如下内容：<figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line><span class=built_in>export</span> NGINX_HOME=/usr/local/openresty/nginx</span><br><span class=line><span class=built_in>export</span> PATH=<span class=variable>${NGINX_HOME}</span>/sbin:<span class=variable>$PATH</span></span><br></pre></table></figure><p>添加完后执行命令<code>source /etc/profile</code>，让配置生效。<h3 id=1-2-6、启动运行><a class=headerlink href=#1-2-6、启动运行 title=1.2.6、启动运行></a>1.2.6、启动运行</h3><p>修改<code>/usr/local/openresty/nginx/conf/nginx.conf</code>文件，内容如下：<figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br></pre><td class=code><pre><span class=line><span class=comment>#user  nobody;</span></span><br><span class=line><span class=attr>worker_processes</span>  <span class=string>1;</span></span><br><span class=line><span class=attr>error_log</span>  <span class=string>logs/error.log;</span></span><br><span class=line></span><br><span class=line><span class=attr>events</span> <span class=string>{</span></span><br><span class=line>    <span class=attr>worker_connections</span>  <span class=string>1024;</span></span><br><span class=line><span class=attr>}</span></span><br><span class=line></span><br><span class=line><span class=attr>http</span> <span class=string>{</span></span><br><span class=line>    <span class=attr>include</span>       <span class=string>mime.types;</span></span><br><span class=line>    <span class=attr>default_type</span>  <span class=string>application/octet-stream;</span></span><br><span class=line>    <span class=attr>sendfile</span>        <span class=string>on;</span></span><br><span class=line>    <span class=attr>keepalive_timeout</span>  <span class=string>65;</span></span><br><span class=line></span><br><span class=line>    <span class=attr>server</span> <span class=string>{</span></span><br><span class=line>        <span class=attr>listen</span>       <span class=string>8081;</span></span><br><span class=line>        <span class=attr>server_name</span>  <span class=string>localhost;</span></span><br><span class=line>        <span class=attr>location</span> <span class=string>/ {</span></span><br><span class=line>            <span class=attr>root</span>   <span class=string>html;</span></span><br><span class=line>            <span class=attr>index</span>  <span class=string>index.html index.htm;</span></span><br><span class=line>        <span class=attr>}</span></span><br><span class=line>        <span class=attr>error_page</span>   <span class=string>500 502 503 504  /50x.html;</span></span><br><span class=line>        <span class=attr>location</span> = <span class=string>/50x.html {</span></span><br><span class=line>            <span class=attr>root</span>   <span class=string>html;</span></span><br><span class=line>        <span class=attr>}</span></span><br><span class=line>    <span class=attr>}</span></span><br><span class=line><span class=attr>}</span></span><br></pre></table></figure><p>输入命令<code>nginx</code>来启动 Nginx。然后访问页面：<code>http://192.168.150.101:8081</code>。<h2 id=基本使用><a class=headerlink href=#基本使用 title=基本使用></a>基本使用</h2><h3 id=监听处理请求><a class=headerlink href=#监听处理请求 title=监听处理请求></a>监听处理请求</h3><p>在 nginx.conf 文件中的 http 标签下面添加对 OpenResty lua 模块的加载。<figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line><span class=comment># lua 模块</span></span><br><span class=line><span class=attr>lua_package_path</span> <span class=string>"/usr/local/openresty/lualib/?.lua;;";</span></span><br><span class=line><span class=comment># c 模块     </span></span><br><span class=line><span class=attr>lua_package_cpath</span> <span class=string>"/usr/local/openresty/lualib/?.so;;";  </span></span><br></pre></table></figure><p>在 nginx.conf 文件中的 server 标签下面添加对请求路径的监听。<figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre><td class=code><pre><span class=line><span class=attr>localtion</span> <span class=string>/api/item {</span></span><br><span class=line><span class=comment>	# 响应类型</span></span><br><span class=line>	<span class=attr>default_type</span> <span class=string>application/json;</span></span><br><span class=line><span class=comment>	# 响应数据由 item.lua 文件来决定</span></span><br><span class=line>	<span class=attr>content_by_lua_file</span> <span class=string>lua/item.lua;</span></span><br><span class=line><span class=attr>}</span></span><br></pre></table></figure><h3 id=获取请求参数><a class=headerlink href=#获取请求参数 title=获取请求参数></a>获取请求参数</h3><p>获取不同类型参数的方式如下：<p><img src=https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/07/%E5%9F%BA%E7%A1%80%E5%BA%94%E7%94%A8-6.1.2.2-%E5%A4%9A%E7%BA%A7%E7%BC%93%E5%AD%98-%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F-OpenResty-%E8%8E%B7%E5%8F%96%E8%AF%B7%E6%B1%82%E5%8F%82%E6%95%B0.png><h2 id=Nginx本地缓存><a class=headerlink href=#Nginx本地缓存 title=Nginx本地缓存></a>Nginx本地缓存</h2><h3 id=简介><a class=headerlink href=#简介 title=简介></a>简介</h3><p>OpenResty 为 Nginx 提供<code>shard dict</code>功能，可以在 nginx 多个 worker 之间共享数据，实现缓存功能。<h3 id=使用><a class=headerlink href=#使用 title=使用></a>使用</h3><p>1）开启共享词典<figure class="highlight nginx"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line><span class=comment># 共享字典，也就是本地缓存，名称叫做：item_cache，大小150m</span></span><br><span class=line><span class=attribute>lua_shared_dict</span> item_cache <span class=number>150m</span>; </span><br></pre></table></figure><p>2）操作共享字典<figure class="highlight lua"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line><span class=keyword>local</span> item_cache = ngx.shard.item_cache</span><br><span class=line>item_cache:set(<span class=string>'key'</span>, <span class=string>'val'</span>, <span class=number>1000</span>)</span><br><span class=line><span class=keyword>local</span> val = item_cache:get(<span class=string>'key'</span>)</span><br></pre></table></figure><h2 id=Nginx访问Redis><a class=headerlink href=#Nginx访问Redis title=Nginx访问Redis></a>Nginx访问Redis</h2><h3 id=简介-1><a class=headerlink href=#简介-1 title=简介></a>简介</h3><p>OpenResty 提供了操作 Redis 的模块，直接引入即可使用。<h3 id=环境配置><a class=headerlink href=#环境配置 title=环境配置></a>环境配置</h3><p>1）加载 OpenResty lua 模块。<p>在 nginx.conf 文件中的 http 标签下面添加对 OpenResty lua 模块的加载：<figure class="highlight nginx"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line><span class=comment># lua 模块</span></span><br><span class=line><span class=attribute>lua_package_path</span> <span class=string>"/usr/local/openresty/lualib/?.lua;;"</span>;</span><br><span class=line><span class=comment># c 模块     </span></span><br><span class=line><span class=attribute>lua_package_cpath</span> <span class=string>"/usr/local/openresty/lualib/?.so;;"</span>;  </span><br></pre></table></figure><p>2）引入 Redis 模块，初始化 Redis 对象。<figure class="highlight lua"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line><span class=keyword>local</span> redis = <span class=built_in>require</span>(<span class=string>"resty.redis"</span>)</span><br><span class=line><span class=keyword>local</span> red = redis:new()</span><br><span class=line>red:set_timeouts(<span class=number>1000</span>, <span class=number>1000</span>, <span class=number>1000</span>)</span><br></pre></table></figure><h3 id=封装工具><a class=headerlink href=#封装工具 title=封装工具></a>封装工具</h3><p>编辑 OpenResty 函数库文件<code>/usr/local/openresty/lualib/common.lua</code>，添加如下内容：<p>1）发送 redis 请求。<figure class="highlight lua"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br></pre><td class=code><pre><span class=line><span class=comment>-- 查询redis的方法 ip和port是redis地址，key是查询的key</span></span><br><span class=line><span class=keyword>local</span> <span class=function><span class=keyword>function</span> <span class=title>read_redis</span><span class=params>(ip, port, key)</span></span></span><br><span class=line>    <span class=comment>-- 获取一个连接</span></span><br><span class=line>    <span class=keyword>local</span> ok, err = red:connect(ip, port)</span><br><span class=line>    <span class=keyword>if</span> <span class=keyword>not</span> ok <span class=keyword>then</span></span><br><span class=line>        ngx.<span class=built_in>log</span>(ngx.ERR, <span class=string>"连接redis失败 : "</span>, err)</span><br><span class=line>        <span class=keyword>return</span> <span class=literal>nil</span></span><br><span class=line>    <span class=keyword>end</span></span><br><span class=line>    <span class=comment>-- 查询redis</span></span><br><span class=line>    <span class=keyword>local</span> resp, err = red:get(key)</span><br><span class=line>    <span class=comment>-- 查询失败处理</span></span><br><span class=line>    <span class=keyword>if</span> <span class=keyword>not</span> resp <span class=keyword>then</span></span><br><span class=line>        ngx.<span class=built_in>log</span>(ngx.ERR, <span class=string>"查询Redis失败: "</span>, err, <span class=string>", key = "</span> , key)</span><br><span class=line>    <span class=keyword>end</span></span><br><span class=line>    <span class=comment>--得到的数据为空处理</span></span><br><span class=line>    <span class=keyword>if</span> resp == ngx.null <span class=keyword>then</span></span><br><span class=line>        resp = <span class=literal>nil</span></span><br><span class=line>        ngx.<span class=built_in>log</span>(ngx.ERR, <span class=string>"查询Redis数据为空, key = "</span>, key)</span><br><span class=line>    <span class=keyword>end</span></span><br><span class=line>    close_redis(red)</span><br><span class=line>    <span class=keyword>return</span> resp</span><br><span class=line><span class=keyword>end</span></span><br></pre></table></figure><p>2）关闭 redis 连接。<figure class="highlight lua"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre><td class=code><pre><span class=line><span class=comment>-- 关闭redis连接的工具方法，其实是放入连接池</span></span><br><span class=line><span class=keyword>local</span> <span class=function><span class=keyword>function</span> <span class=title>close_redis</span><span class=params>(red)</span></span></span><br><span class=line>    <span class=keyword>local</span> pool_max_idle_time = <span class=number>10000</span> <span class=comment>-- 连接的空闲时间，单位是毫秒</span></span><br><span class=line>    <span class=keyword>local</span> pool_size = <span class=number>100</span> <span class=comment>--连接池大小</span></span><br><span class=line>    <span class=keyword>local</span> ok, err = red:set_keepalive(pool_max_idle_time, pool_size)</span><br><span class=line>    <span class=keyword>if</span> <span class=keyword>not</span> ok <span class=keyword>then</span></span><br><span class=line>        ngx.<span class=built_in>log</span>(ngx.ERR, <span class=string>"放入redis连接池失败: "</span>, err)</span><br><span class=line>    <span class=keyword>end</span></span><br><span class=line><span class=keyword>end</span></span><br></pre></table></figure><p>3）发送 http 请求。<figure class="highlight lua"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br></pre><td class=code><pre><span class=line><span class=comment>-- 封装函数，发送http请求，并解析响应</span></span><br><span class=line><span class=keyword>local</span> <span class=function><span class=keyword>function</span> <span class=title>read_http</span><span class=params>(path, params)</span></span></span><br><span class=line>    <span class=keyword>local</span> resp = ngx.location.capture(<span class=built_in>path</span>,{</span><br><span class=line>        method = ngx.HTTP_GET,</span><br><span class=line>        args = params,</span><br><span class=line>    })</span><br><span class=line>    <span class=keyword>if</span> <span class=keyword>not</span> resp <span class=keyword>then</span></span><br><span class=line>        <span class=comment>-- 记录错误信息，返回404</span></span><br><span class=line>        ngx.<span class=built_in>log</span>(ngx.ERR, <span class=string>"http not found, path: "</span>, <span class=built_in>path</span> , <span class=string>", args: "</span>, args)</span><br><span class=line>        ngx.<span class=built_in>exit</span>(<span class=number>404</span>)</span><br><span class=line>    <span class=keyword>end</span></span><br><span class=line>    <span class=keyword>return</span> resp.body</span><br><span class=line><span class=keyword>end</span></span><br><span class=line><span class=comment>-- 将方法导出</span></span><br><span class=line><span class=keyword>local</span> _M = {  </span><br><span class=line>    read_http = read_http</span><br><span class=line>}  </span><br><span class=line><span class=keyword>return</span> _M</span><br></pre></table></figure><h3 id=测试示例><a class=headerlink href=#测试示例 title=测试示例></a>测试示例</h3><figure class="highlight lua"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br></pre><td class=code><pre><span class=line><span class=comment>-- 引入cjson库</span></span><br><span class=line><span class=keyword>local</span> cjson = <span class=built_in>require</span>(<span class=string>'cjson'</span>)</span><br><span class=line><span class=comment>-- 引入 common 函数库</span></span><br><span class=line><span class=keyword>local</span> common = <span class=built_in>require</span>(<span class=string>'common'</span>)</span><br><span class=line><span class=keyword>local</span> read_http = common.read_http</span><br><span class=line><span class=keyword>local</span> read_redis = common.read_redis</span><br><span class=line></span><br><span class=line><span class=comment>-- 先查询redis，未命中时再查询tomcat</span></span><br><span class=line><span class=function><span class=keyword>function</span> <span class=title>read_data</span><span class=params>(key, path, params)</span></span></span><br><span class=line>    <span class=keyword>local</span> resp = read_redis(<span class=string>"127.0.0.1"</span>, <span class=number>6379</span>, key)</span><br><span class=line>    <span class=keyword>if</span> <span class=keyword>not</span> resp <span class=keyword>then</span></span><br><span class=line>        ngx.<span class=built_in>log</span>(<span class=string>"redis查询失败，尝试查询http，key："</span>， key)</span><br><span class=line>        resp = read_http(<span class=built_in>path</span>, params)</span><br><span class=line>    <span class=keyword>end</span></span><br><span class=line>    <span class=keyword>return</span> resp</span><br><span class=line><span class=keyword>end</span></span><br><span class=line></span><br><span class=line><span class=keyword>local</span> itemJson = read_data(<span class=string>"item:id"</span> .. id, <span class=string>"/item/"</span> .. id, <span class=literal>nil</span>)</span><br><span class=line><span class=comment>-- 将 json 转为lua的table</span></span><br><span class=line><span class=keyword>local</span> item = cjson.decode(itemJson)</span><br><span class=line>    </span><br><span class=line>ngx.say(cjson.encode(item))</span><br></pre></table></figure><h2 id=Nginx访问Tomcat><a class=headerlink href=#Nginx访问Tomcat title=Nginx访问Tomcat></a>Nginx访问Tomcat</h2><h3 id=发送HTTP请求><a class=headerlink href=#发送HTTP请求 title=发送HTTP请求></a>发送HTTP请求</h3><h3 id=proxy-pass方式><a class=headerlink href=#proxy-pass方式 title=proxy_pass方式></a>proxy_pass方式</h3><figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br></pre><td class=code><pre><span class=line><span class=attr>http</span> <span class=string>{</span></span><br><span class=line>    <span class=attr>upstream</span> <span class=string>md5_server{</span></span><br><span class=line>        <span class=attr>server</span> <span class=string>127.0.0.1:81;</span></span><br><span class=line>        <span class=attr>keepalive</span> <span class=string>20;</span></span><br><span class=line>    <span class=attr>}</span></span><br><span class=line></span><br><span class=line>    <span class=attr>server</span> <span class=string>{</span></span><br><span class=line>        <span class=attr>listen</span>    <span class=string>80;</span></span><br><span class=line>        <span class=attr>location</span> <span class=string>/test {</span></span><br><span class=line>            <span class=attr>content_by_lua_block</span> <span class=string>{</span></span><br><span class=line>                <span class=attr>ngx.req.read_body()</span></span><br><span class=line>                <span class=attr>local</span> <span class=string>args, err = ngx.req.get_uri_args()</span></span><br><span class=line>                <span class=attr>local</span> <span class=string>res = ngx.location.capture('/spe_md5',{</span></span><br><span class=line>                        <span class=attr>method</span> = <span class=string>ngx.HTTP_POST,</span></span><br><span class=line>                        <span class=attr>body</span> = <span class=string>args.data</span></span><br><span class=line>                <span class=attr>})</span></span><br><span class=line>                <span class=attr>if</span> <span class=string>200 ~= res.status then</span></span><br><span class=line>                    <span class=attr>ngx.exit(res.status)</span></span><br><span class=line>                <span class=attr>end</span></span><br><span class=line>                <span class=attr>if</span> <span class=string>args.key == res.body then</span></span><br><span class=line>                    <span class=attr>ngx.say("valid</span> <span class=string>request")</span></span><br><span class=line>                <span class=attr>else</span></span><br><span class=line>                    <span class=attr>ngx.say("invalid</span> <span class=string>request")</span></span><br><span class=line>                <span class=attr>end</span></span><br><span class=line>            <span class=attr>}</span></span><br><span class=line>        <span class=attr>}</span></span><br><span class=line>        <span class=attr>location</span> <span class=string>/spe_md5 {</span></span><br><span class=line>            <span class=attr>proxy_pass</span> <span class=string>http://md5_server;   -- ④</span></span><br><span class=line><span class=comment>            #For HTTP, the proxy_http_version directive should be set to “1.1” and the “Connection” </span></span><br><span class=line><span class=comment>            #header field should be cleared.（from:http://nginx.org/en/docs/http/ngx_http_upstream_module.html#keepalive)</span></span><br><span class=line>            <span class=attr>proxy_http_version</span> <span class=string>1.1;</span></span><br><span class=line>            <span class=attr>proxy_set_header</span> <span class=string>Connection "";</span></span><br><span class=line>        <span class=attr>}</span></span><br><span class=line>    <span class=attr>}</span></span><br><span class=line></span><br><span class=line>    <span class=attr>server</span> <span class=string>{</span></span><br><span class=line>        <span class=attr>listen</span>    <span class=string>81;</span></span><br><span class=line>        <span class=attr>location</span> <span class=string>/spe_md5 {</span></span><br><span class=line>            <span class=attr>content_by_lua_block</span> <span class=string>{</span></span><br><span class=line>                <span class=attr>ngx.req.read_body()</span></span><br><span class=line>                <span class=attr>local</span> <span class=string>data = ngx.req.get_body_data()</span></span><br><span class=line>                <span class=attr>ngx.print(ngx.md5(data</span> <span class=string>.. "*&^%$#$^&kjtrKUYG"))</span></span><br><span class=line>            <span class=attr>}</span></span><br><span class=line>        <span class=attr>}</span></span><br><span class=line>    <span class=attr>}</span></span><br><span class=line><span class=attr>}</span></span><br></pre></table></figure><h3 id=cosocket方式><a class=headerlink href=#cosocket方式 title=cosocket方式></a>cosocket方式</h3><figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br></pre><td class=code><pre><span class=line><span class=attr>http</span> <span class=string>{</span></span><br><span class=line>    <span class=attr>server</span> <span class=string>{</span></span><br><span class=line>        <span class=attr>listen</span> <span class=string>80;</span></span><br><span class=line>        <span class=attr>location</span> <span class=string>/test {</span></span><br><span class=line>            <span class=attr>content_by_lua_block</span> <span class=string>{</span></span><br><span class=line>                <span class=attr>ngx.req.read_body()</span></span><br><span class=line>                <span class=attr>local</span> <span class=string>args, err = ngx.req.get_uri_args()</span></span><br><span class=line>                <span class=attr>local</span> <span class=string>http = require "resty.http"</span></span><br><span class=line>                <span class=attr>local</span> <span class=string>httpc = http.new()</span></span><br><span class=line>                <span class=attr>local</span> <span class=string>res, err = httpc:request_uri(</span></span><br><span class=line>                    <span class=attr>"http</span>:<span class=string>//127.0.0.1:81/spe_md5",{</span></span><br><span class=line>                        <span class=attr>method</span> = <span class=string>"POST",</span></span><br><span class=line>                        <span class=attr>body</span> = <span class=string>args.data,</span></span><br><span class=line>                     <span class=attr>})</span></span><br><span class=line></span><br><span class=line>                <span class=attr>if</span> <span class=string>200 ~= res.status then</span></span><br><span class=line>                    <span class=attr>ngx.exit(res.status)</span></span><br><span class=line>                <span class=attr>end</span></span><br><span class=line></span><br><span class=line>                <span class=attr>if</span> <span class=string>args.key == res.body then</span></span><br><span class=line>                    <span class=attr>ngx.say("valid</span> <span class=string>request")</span></span><br><span class=line>                <span class=attr>else</span></span><br><span class=line>                    <span class=attr>ngx.say("invalid</span> <span class=string>request")</span></span><br><span class=line>                <span class=attr>end</span></span><br><span class=line>            <span class=attr>}</span></span><br><span class=line>        <span class=attr>}</span></span><br><span class=line>    <span class=attr>}</span></span><br><span class=line></span><br><span class=line>    <span class=attr>server</span> <span class=string>{</span></span><br><span class=line>        <span class=attr>listen</span>    <span class=string>81;</span></span><br><span class=line>        <span class=attr>location</span> <span class=string>/spe_md5 {</span></span><br><span class=line>            <span class=attr>content_by_lua_block</span> <span class=string>{</span></span><br><span class=line>                <span class=attr>ngx.req.read_body()</span></span><br><span class=line>                <span class=attr>local</span> <span class=string>data = ngx.req.get_body_data()</span></span><br><span class=line>                <span class=attr>ngx.print(ngx.md5(data</span> <span class=string>.. "*&^%$#$^&kjtrKUYG"))</span></span><br><span class=line>            <span class=attr>}</span></span><br><span class=line>        <span class=attr>}</span></span><br><span class=line>    <span class=attr>}</span></span><br><span class=line><span class=attr>}</span></span><br></pre></table></figure><h3 id=环境配置-1><a class=headerlink href=#环境配置-1 title=环境配置></a>环境配置</h3><p>加载 OpenResty lua 模块。<p>在配置文件 nginx.conf 中的 http 模块下添加如下内容：<figure class="highlight nginx"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line><span class=comment>#lua 模块</span></span><br><span class=line><span class=attribute>lua_package_path</span> <span class=string>"/usr/local/openresty/lualib/?.lua;;"</span>;</span><br><span class=line><span class=comment>#c模块     </span></span><br><span class=line><span class=attribute>lua_package_cpath</span> <span class=string>"/usr/local/openresty/lualib/?.so;;"</span>;  </span><br></pre></table></figure><h3 id=封装工具-1><a class=headerlink href=#封装工具-1 title=封装工具></a>封装工具</h3><p>封装发送 http 请求的函数。<p>编辑 OpenResty 函数库文件<code>/usr/local/openresty/lualib/common.lua</code>，添加如下内容：<figure class="highlight lua"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br></pre><td class=code><pre><span class=line><span class=comment>-- 封装函数，发送http请求，并解析响应</span></span><br><span class=line><span class=keyword>local</span> <span class=function><span class=keyword>function</span> <span class=title>read_http</span><span class=params>(path, params)</span></span></span><br><span class=line>    <span class=keyword>local</span> resp = ngx.location.capture(<span class=built_in>path</span>,{</span><br><span class=line>        method = ngx.HTTP_GET,</span><br><span class=line>        args = params,</span><br><span class=line>    })</span><br><span class=line>    <span class=keyword>if</span> <span class=keyword>not</span> resp <span class=keyword>then</span></span><br><span class=line>        ngx.<span class=built_in>log</span>(ngx.ERR, <span class=string>"http not found, path: "</span>, <span class=built_in>path</span> , <span class=string>", args: "</span>, args)</span><br><span class=line>        ngx.<span class=built_in>exit</span>(<span class=number>404</span>)</span><br><span class=line>    <span class=keyword>end</span></span><br><span class=line>    <span class=keyword>return</span> resp.body</span><br><span class=line><span class=keyword>end</span></span><br><span class=line><span class=comment>-- 将方法导出</span></span><br><span class=line><span class=keyword>local</span> _M = {  </span><br><span class=line>    read_http = read_http</span><br><span class=line>}  </span><br><span class=line><span class=keyword>return</span> _M</span><br></pre></table></figure><h3 id=测试示例-1><a class=headerlink href=#测试示例-1 title=测试示例></a>测试示例</h3><figure class="highlight lua"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br></pre><td class=code><pre><span class=line><span class=comment>-- 引入 common 函数库</span></span><br><span class=line><span class=keyword>local</span> common = <span class=built_in>require</span>(<span class=string>'common'</span>)</span><br><span class=line><span class=keyword>local</span> read_http = common.read_http</span><br><span class=line><span class=comment>-- 引入cjson库</span></span><br><span class=line><span class=keyword>local</span> cjson = <span class=built_in>require</span>(<span class=string>'cjson'</span>)</span><br><span class=line></span><br><span class=line><span class=comment>-- 获取路径参数</span></span><br><span class=line><span class=keyword>local</span> id = ngx.var[<span class=number>1</span>]</span><br><span class=line></span><br><span class=line><span class=comment>-- 获取商品信息</span></span><br><span class=line><span class=keyword>local</span> itemJson = read_http(<span class=string>"/item"</span> .. id, <span class=literal>nil</span>)</span><br><span class=line><span class=keyword>local</span> item = cjson.decode(itemJson)</span><br><span class=line></span><br><span class=line><span class=comment>-- 返回结果</span></span><br><span class=line>ngx.say(itemJson)</span><br></pre></table></figure></div><footer class=post-footer><div class=post-tags><a href=/tags/Nginx/ rel=tag># Nginx</a><a href=/tags/Nginx%E5%9F%BA%E7%A1%80/ rel=tag># Nginx基础</a></div><div class=post-nav><div class=post-nav-item><a href=/2024/08/21/Netty%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93/ rel=prev title=计算机系列-Netty> <i class="fa fa-angle-left"></i> 计算机系列-Netty </a></div><div class=post-nav-item><a href=/2024/08/21/RabbitMQ%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/ rel=next title=RabbitMQ系列-RabbitMQ环境搭建> RabbitMQ系列-RabbitMQ环境搭建 <i class="fa fa-angle-right"></i> </a></div></div></footer></article></div></div></main><footer class=footer><div class=footer-inner><div class=copyright>© <span itemprop=copyrightYear>2024</span><span class=with-love> <i class="fa fa-heart"></i> </span><span class=author itemprop=copyrightHolder>豪哥</span></div></div></footer><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span><span class=toggle-line></span><span class=toggle-line></span></div><div class=sidebar-dimmer></div><div aria-label=返回顶部 class=back-to-top role=button><i class="fa fa-arrow-up fa-lg"></i><span>0%</span></div><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><script crossorigin=anonymous integrity=sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY= src=https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js></script><script src=/js/comments.js></script><script src=/js/utils.js></script><script src=/js/motion.js></script><script src=/js/sidebar.js></script><script src=/js/next-boot.js></script><script crossorigin=anonymous integrity=sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc= src=https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js></script><script src=/js/third-party/search/local-search.js></script>