<!doctypehtml><html lang=zh-CN><meta charset=UTF-8><meta content=width=device-width name=viewport><meta media="(prefers-color-scheme: light)" content=#222 name=theme-color><meta media="(prefers-color-scheme: dark)" content=#222 name=theme-color><meta content="Hexo 7.3.0" name=generator><link href=/images/apple-touch-icon-next.png rel=apple-touch-icon sizes=180x180><link href=/images/favicon-32x32-next.png rel=icon sizes=32x32 type=image/png><link href=/images/favicon-16x16-next.png rel=icon sizes=16x16 type=image/png><link color=#222 href=/images/logo.svg rel=mask-icon><link href=/css/main.css rel=stylesheet><link crossorigin=anonymous href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css integrity=sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA= rel=stylesheet><link crossorigin=anonymous href=https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css integrity=sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE= rel=stylesheet><script class=next-config data-name=main type=application/json>{"hostname":"hgprivate.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script src=/js/config.js></script><meta content="基础知识1.1、使用场景 Authentication（权限） Caching（缓存） Context passing（内容传递） Error handling（错误处理） Lazy loading（懒加载） Debugging（调试） logging / tracing / profiling and monitoring（记录跟踪 / 优化 / 校准）" name=description><meta content=article property=og:type><meta content=Spring系列-SpringAOP property=og:title><meta content=https://hgprivate.github.io/2024/08/21/SpringAOP/index.html property=og:url><meta content=豪哥博客 property=og:site_name><meta content="基础知识1.1、使用场景 Authentication（权限） Caching（缓存） Context passing（内容传递） Error handling（错误处理） Lazy loading（懒加载） Debugging（调试） logging / tracing / profiling and monitoring（记录跟踪 / 优化 / 校准）" property=og:description><meta content=zh_CN property=og:locale><meta content=2024-08-21T13:39:14.704Z property=article:published_time><meta content=2023-10-04T02:53:40.767Z property=article:modified_time><meta content=豪哥 property=article:author><meta content=Spring property=article:tag><meta content=SpringAOP property=article:tag><meta content=summary name=twitter:card><link href=https://hgprivate.github.io/2024/08/21/SpringAOP/ rel=canonical><script class=next-config data-name=page type=application/json>{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://hgprivate.github.io/2024/08/21/SpringAOP/","path":"2024/08/21/SpringAOP/","title":"Spring系列-SpringAOP"}</script><script class=next-config data-name=calendar type=application/json>""</script><title>Spring系列-SpringAOP | 豪哥博客</title><noscript><link href=/css/noscript.css rel=stylesheet></noscript><body class=use-motion itemscope itemtype=http://schema.org/WebPage><div class=headband></div><main class=main><div class=column><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=site-brand-container><div class=site-nav-toggle><div aria-label=切换导航栏 class=toggle role=button><span class=toggle-line></span><span class=toggle-line></span><span class=toggle-line></span></div></div><div class=site-meta><a class=brand href=/ rel=start> <i class=logo-line></i> <p class=site-title>豪哥博客</p> <i class=logo-line></i> </a><p class=site-subtitle itemprop=description>豪哥博客</div><div class=site-nav-right><div class="toggle popup-trigger" aria-label=搜索 role=button><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ rel=section><i class="fa fa-home fa-fw"></i>首页</a><li class="menu-item menu-item-tags"><a href=/tags/ rel=section><i class="fa fa-tags fa-fw"></i>标签</a><li class="menu-item menu-item-categories"><a href=/categories/ rel=section><i class="fa fa-th fa-fw"></i>分类</a><li class="menu-item menu-item-archives"><a href=/archives/ rel=section><i class="fa fa-archive fa-fw"></i>归档</a><li class="menu-item menu-item-search"><a class=popup-trigger role=button><i class="fa fa-search fa-fw"></i>搜索 </a></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon> <i class="fa fa-search"></i> </span><div class=search-input-container><input autocapitalize=off autocomplete=off class=search-input maxlength=80 placeholder=搜索... spellcheck=false type=search></div><span class=popup-btn-close role=button> <i class="fa fa-times-circle"></i> </span></div><div class=search-result-container><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></header><aside class=sidebar><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录<li class=sidebar-nav-overview>站点概览</ul><div class=sidebar-panel-container><!--noindex--><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class=nav><li class="nav-item nav-level-1"><a class=nav-link href=#%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86><span class=nav-number>1.</span> <span class=nav-text>基础知识</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#1-1%E3%80%81%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF><span class=nav-number>1.1.</span> <span class=nav-text>1.1、使用场景</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#1-2%E3%80%81AOP%E6%80%9D%E6%83%B3><span class=nav-number>1.2.</span> <span class=nav-text>1.2、AOP思想</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#1-3%E3%80%81%E9%87%8D%E8%A6%81%E6%A6%82%E5%BF%B5><span class=nav-number>1.3.</span> <span class=nav-text>1.3、重要概念</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#1-4%E3%80%81%E5%88%87%E7%82%B9%E8%A1%A8%E8%BE%BE%E5%BC%8F><span class=nav-number>1.4.</span> <span class=nav-text>1.4、切点表达式</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#1-4-1%E3%80%81%E8%AF%AD%E6%B3%95><span class=nav-number>1.4.1.</span> <span class=nav-text>1.4.1、语法</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#1-4-2%E3%80%81%E5%B8%B8%E7%94%A8%E8%A1%A8%E8%BE%BE%E5%BC%8F%E7%A4%BA%E4%BE%8B><span class=nav-number>1.4.2.</span> <span class=nav-text>1.4.2、常用表达式示例</span></a></ol><li class="nav-item nav-level-2"><a class=nav-link href=#1-5%E3%80%81%E9%80%9A%E7%9F%A5%E7%B1%BB%E5%9E%8B><span class=nav-number>1.5.</span> <span class=nav-text>1.5、通知类型</span></a></ol><li class="nav-item nav-level-1"><a class=nav-link href=#%E4%BD%BF%E7%94%A8AOP><span class=nav-number>2.</span> <span class=nav-text>使用AOP</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#1-1%E3%80%81%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F><span class=nav-number>2.1.</span> <span class=nav-text>1.1、实现方式</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#1-2%E3%80%81XML%E5%AE%9E%E7%8E%B0><span class=nav-number>2.2.</span> <span class=nav-text>1.2、XML实现</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#1-2-1%E3%80%81Advisor%E6%96%B9%E5%BC%8F><span class=nav-number>2.2.1.</span> <span class=nav-text>1.2.1、Advisor方式</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#1-2-2%E3%80%81AspectJ%E6%96%B9%E5%BC%8F><span class=nav-number>2.2.2.</span> <span class=nav-text>1.2.2、AspectJ方式</span></a></ol><li class="nav-item nav-level-2"><a class=nav-link href=#1-3%E3%80%81%E6%B3%A8%E8%A7%A3%E5%AE%9E%E7%8E%B0><span class=nav-number>2.3.</span> <span class=nav-text>1.3、注解实现</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#1-4%E3%80%81ProxyFactoryBean%E5%AE%9E%E7%8E%B0><span class=nav-number>2.4.</span> <span class=nav-text>1.4、ProxyFactoryBean实现</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#1-5%E3%80%81ProxyFactory%E5%AE%9E%E7%8E%B0><span class=nav-number>2.5.</span> <span class=nav-text>1.5、ProxyFactory实现</span></a></ol><li class="nav-item nav-level-1"><a class=nav-link href=#%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90><span class=nav-number>3.</span> <span class=nav-text>原理解析</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#1-1%E3%80%81%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86><span class=nav-number>3.1.</span> <span class=nav-text>1.1、动态代理</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#1-1-1%E3%80%81JDK%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86><span class=nav-number>3.1.1.</span> <span class=nav-text>1.1.1、JDK动态代理</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#1-1-2%E3%80%81CGLIB%E4%BB%A3%E7%90%86><span class=nav-number>3.1.2.</span> <span class=nav-text>1.1.2、CGLIB代理</span></a></ol><li class="nav-item nav-level-2"><a class=nav-link href=#1-2%E3%80%81%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86><span class=nav-number>3.2.</span> <span class=nav-text>1.2、功能实现原理</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#1-2-1%E3%80%81%E5%85%A5%E5%8F%A3-aop-config><span class=nav-number>3.2.1.</span> <span class=nav-text>1.2.1、入口 aop:config</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#1-2-2%E3%80%81%E5%85%A5%E5%8F%A3-EnableAspectJAutoProxy><span class=nav-number>3.2.2.</span> <span class=nav-text>1.2.2、入口@EnableAspectJAutoProxy</span></a></ol></ol></ol></div></div><!--/noindex--><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop=author itemscope itemtype=http://schema.org/Person><img alt=豪哥 class=site-author-image itemprop=image src=/static/imgs/avatar.png><p class=site-author-name itemprop=name>豪哥<div class=site-description itemprop=description>豪哥博客</div></div><div class="site-state-wrap animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/> <span class=site-state-item-count>116</span> <span class=site-state-item-name>日志</span> </a></div><div class="site-state-item site-state-categories"><a href=/categories/> <span class=site-state-item-count>36</span> <span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/> <span class=site-state-item-count>129</span> <span class=site-state-item-name>标签</span></a></div></nav></div></div></div></div></aside></div><div class="main-inner post posts-expand"><div class=post-block><article class=post-content itemscope itemtype=http://schema.org/Article lang=zh-CN><link href=https://hgprivate.github.io/2024/08/21/SpringAOP/ itemprop=mainEntityOfPage><span hidden itemprop=author itemscope itemtype=http://schema.org/Person> <meta content=/static/imgs/avatar.png itemprop=image> <meta content=豪哥 itemprop=name> </span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization> <meta content=豪哥博客 itemprop=name> <meta content=豪哥博客 itemprop=description> </span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork> <meta content="Spring系列-SpringAOP | 豪哥博客" itemprop=name> <meta itemprop=description> </span><header class=post-header><h1 itemprop="name headline" class=post-title>Spring系列-SpringAOP</h1><div class=post-meta-container><div class=post-meta><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar"></i> </span> <span class=post-meta-item-text>发表于</span> <time itemprop="dateCreated datePublished" title="创建时间：2024-08-21 21:39:14" datetime=2024-08-21T21:39:14+08:00>2024-08-21</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar-check"></i> </span> <span class=post-meta-item-text>更新于</span> <time title="修改时间：2023-10-04 10:53:40" datetime=2023-10-04T10:53:40+08:00 itemprop=dateModified>2023-10-04</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-folder"></i> </span> <span class=post-meta-item-text>分类于</span> <span itemprop=about itemscope itemtype=http://schema.org/Thing> <a href=/categories/Spring/ itemprop=url rel=index><span itemprop=name>Spring</span></a> </span> </span></div></div></header><div class=post-body itemprop=articleBody><h1 id=基础知识><a class=headerlink href=#基础知识 title=基础知识></a>基础知识</h1><h2 id=1-1、使用场景><a class=headerlink href=#1-1、使用场景 title=1.1、使用场景></a>1.1、使用场景</h2><ul><li>Authentication（权限）<li>Caching（缓存）<li>Context passing（内容传递）<li>Error handling（错误处理）<li>Lazy loading（懒加载）<li>Debugging（调试）<li>logging / tracing / profiling and monitoring（记录跟踪 / 优化 / 校准）<li>Performance optimization（性能优化）<li>Persistence（持久化）<li>Resource pooling（资源池）<li>Synchronization（同步）<li>Transactions（事务）</ul><h2 id=1-2、AOP思想><a class=headerlink href=#1-2、AOP思想 title=1.2、AOP思想></a>1.2、AOP思想</h2><p>AOP思想的实现技术主要有Spring AOP 和 AspectJ。<p>AspectJ底层<strong>通过静态代理实现编译时自动编译得到一个新类</strong>，新类增强了原有类功能。<p>Spring AOP底层<strong>通过动态代理实现运行时增强目标方法，不会生成新类</strong>。Spring AOP支持 JDK动态代理 和CGLib代理。<blockquote><p>Spring 允许使用 AspectJ Annotation 来定义方面（Aspect）、切入点（Pointcut）和增强处理（Advice），且可根据这些Annotation来生成AOP代理。Spring 仅仅使用了和AspectJ 5一样的注解，并没有使用AspectJ的编译器或织入器（Weaver）。</blockquote><h2 id=1-3、重要概念><a class=headerlink href=#1-3、重要概念 title=1.3、重要概念></a>1.3、重要概念</h2><ul><li><strong>连接点</strong>：目标对象中可以被增强的方法；<li><strong>切入点</strong>：目标对象中实际被增强的方法；<li><strong>通知</strong>：增强的代码逻辑；<li><strong>切面</strong>：增强和切入点的组合；<li><strong>织入</strong>：将通知和切入点动态组合的过程；</ul><h2 id=1-4、切点表达式><a class=headerlink href=#1-4、切点表达式 title=1.4、切点表达式></a>1.4、切点表达式</h2><h3 id=1-4-1、语法><a class=headerlink href=#1-4-1、语法 title=1.4.1、语法></a>1.4.1、语法</h3><p>切点表达式的语法如下：<figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line><span class=attr>execution([访问修饰符]</span> <span class=string>返回类型 包名.类名.方法名(参数))</span></span><br></pre></table></figure><p>注意事项：<ul><li><strong>访问修饰符可以省略不写</strong>；<li>返回值类型、包名、类名、方法名可以使用<code>*</code>代替，表示任意；<li>包名与类名之间使用<strong>一个点表示该包下的类，两个点表示该包及子包下的类</strong>；<li>参数可以使用<strong>两个点表示任意参数</strong>；</ul><h3 id=1-4-2、常用表达式示例><a class=headerlink href=#1-4-2、常用表达式示例 title=1.4.2、常用表达式示例></a>1.4.2、常用表达式示例</h3><figure class="highlight txt"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line>execution(* cn.shh.xxx.A.*(..))：	// 类A下的任意方法都匹配；</span><br><span class=line>execution(* cn.shh.xxx.*.*(..))：	// 包xxx下的任意类的任意方法都匹配；</span><br><span class=line>execution(* cn.shh.xxx..*.*(..))：	// 包xxx及子包下的任意类的任意方法都匹配；</span><br><span class=line>execution(* *..*.*(..))：			// 任意包下任意类的任意方法都匹配；</span><br></pre></table></figure><h2 id=1-5、通知类型><a class=headerlink href=#1-5、通知类型 title=1.5、通知类型></a>1.5、通知类型</h2><p>Spring AOP通知分如下几种：<ol><li><strong>前置通知 Before advice</strong>；<li><strong>后置通知 After (finally) advice</strong>；<li><strong>返回/引入通知 After returning advice</strong>：引入通知只需要进行配置即可，目的是用来指定哪些方法需要执行相应的通知，如，我们想指定只有 sayHello() 方法执行前置通知；<li><strong>异常通知 After throwing advice</strong>；<li><strong>环绕通知 Around advice</strong>；</ol><h1 id=使用AOP><a class=headerlink href=#使用AOP title=使用AOP></a>使用AOP</h1><h2 id=1-1、实现方式><a class=headerlink href=#1-1、实现方式 title=1.1、实现方式></a>1.1、实现方式</h2><p>实现AOP有如下几种方式：<ul><li>使用<code>xml</code>实现；<ul><li>Advisor方式<li>AspectJ方式</ul><li>使用注解实现。<li>使用<code>ProxyFactoryBean</code>实现；<li>使用<code>ProxyFactory</code>实现；</ul><h2 id=1-2、XML实现><a class=headerlink href=#1-2、XML实现 title=1.2、XML实现></a>1.2、XML实现</h2><h3 id=1-2-1、Advisor方式><a class=headerlink href=#1-2-1、Advisor方式 title=1.2.1、Advisor方式></a>1.2.1、Advisor方式</h3><p>xml配置内容如下：<figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre><td class=code><pre><span class=line><span class=tag><<span class=name>bean</span> <span class=attr>id</span>=<span class=string>"test_xml2aop_service"</span> <span class=attr>class</span>=<span class=string>"cn.shh.demo.spring.aop.impl.xml2aop.Xml2AopServieImpl"</span>/></span></span><br><span class=line></span><br><span class=line><span class=tag><<span class=name>bean</span> <span class=attr>id</span>=<span class=string>"test_xml2aop_advice"</span> <span class=attr>class</span>=<span class=string>"cn.shh.demo.spring.aop.impl.xml2aop.Xml2AopAdvice"</span>/></span></span><br><span class=line></span><br><span class=line><span class=tag><<span class=name>aop:config</span> <span class=attr>proxy-target-class</span>=<span class=string>"true"</span>></span></span><br><span class=line>    <span class=tag><<span class=name>aop:pointcut</span> <span class=attr>id</span>=<span class=string>"test_xml2aop_pointcut"</span> <span class=attr>expression</span>=<span class=string>"execution(* cn.shh.demo.spring.aop.impl.xml2aop.Xml2AopServie.*())"</span>/></span></span><br><span class=line>    <span class=tag><<span class=name>aop:advisor</span> <span class=attr>advice-ref</span>=<span class=string>"test_xml2aop_advice"</span> <span class=attr>pointcut-ref</span>=<span class=string>"test_xml2aop_pointcut"</span>></span><span class=tag>&LT/<span class=name>aop:advisor</span>></span></span><br><span class=line><span class=tag>&LT/<span class=name>aop:config</span>></span></span><br></pre></table></figure><p>Java类文件内容如下：<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br></pre><td class=code><pre><span class=line><span class=keyword>public</span> <span class=keyword>class</span> <span class="title class_">Xml2AopAdvice</span> <span class=keyword>implements</span> <span class="title class_">Advice</span>, Ordered {</span><br><span class=line>    <span class=meta>@Override</span></span><br><span class=line>    <span class=keyword>public</span> <span class=type>int</span> <span class="title function_">getOrder</span><span class=params>()</span> {</span><br><span class=line>        <span class=keyword>return</span> <span class=number>1</span>;</span><br><span class=line>    }</span><br><span class=line>    <span class=keyword>void</span> <span class="title function_">before</span><span class=params>()</span>{</span><br><span class=line>        System.out.println(<span class=string>"--- xml before advice ---"</span>);</span><br><span class=line>    }</span><br><span class=line>    <span class=keyword>void</span> <span class="title function_">after</span><span class=params>()</span>{</span><br><span class=line>        System.out.println(<span class=string>"--- xml after advice ---"</span>);</span><br><span class=line>    }</span><br><span class=line>    <span class=keyword>void</span> <span class="title function_">afterReturning</span><span class=params>()</span>{</span><br><span class=line>        System.out.println(<span class=string>"--- xml afterReturn advice ---"</span>);</span><br><span class=line>    }</span><br><span class=line>    <span class=keyword>void</span> <span class="title function_">afterThrowing</span><span class=params>()</span>{</span><br><span class=line>        System.out.println(<span class=string>"--- xml throwing advice ---"</span>);</span><br><span class=line>    }</span><br><span class=line>    Object <span class="title function_">aroundAdvice</span><span class=params>(ProceedingJoinPoint pjp)</span> <span class=keyword>throws</span> Throwable{</span><br><span class=line>        System.out.println(<span class=string>"Xml2AopAdvice.aroundAdvice before"</span>);</span><br><span class=line>        <span class=type>Object</span> <span class=variable>result</span> <span class=operator>=</span> pjp.proceed();</span><br><span class=line>        System.out.println(<span class=string>"Xml2AopAdvice.aroundAdvice after"</span>);</span><br><span class=line>        <span class=keyword>return</span> result;</span><br><span class=line>    }</span><br><span class=line>}</span><br><span class=line><span class=comment>//====================</span></span><br><span class=line><span class=keyword>public</span> <span class=keyword>interface</span> <span class="title class_">Xml2AopServie</span> {</span><br><span class=line>    <span class=keyword>void</span> <span class="title function_">info</span><span class=params>()</span>;</span><br><span class=line>}</span><br><span class=line><span class=comment>//====================</span></span><br><span class=line><span class=keyword>public</span> <span class=keyword>class</span> <span class="title class_">Xml2AopServieImpl</span> <span class=keyword>implements</span> <span class="title class_">Xml2AopServie</span> {</span><br><span class=line>    <span class=meta>@Override</span></span><br><span class=line>    <span class=keyword>public</span> <span class=keyword>void</span> <span class="title function_">info</span><span class=params>()</span> {</span><br><span class=line>        System.out.println(<span class=string>"Xml2AopServieImpl.info"</span>);</span><br><span class=line>    }</span><br><span class=line>}</span><br></pre></table></figure><h3 id=1-2-2、AspectJ方式><a class=headerlink href=#1-2-2、AspectJ方式 title=1.2.2、AspectJ方式></a>1.2.2、AspectJ方式</h3><p>xml配置内容如下：<figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br></pre><td class=code><pre><span class=line><span class=tag><<span class=name>bean</span> <span class=attr>id</span>=<span class=string>"test_xml2aop_service2"</span> <span class=attr>class</span>=<span class=string>"cn.shh.demo.spring.aop.impl.xml2aop.Xml2AopServieImpl"</span>/></span></span><br><span class=line></span><br><span class=line><span class=tag><<span class=name>bean</span> <span class=attr>id</span>=<span class=string>"test_xml2aop_advice2"</span> <span class=attr>class</span>=<span class=string>"cn.shh.demo.spring.aop.impl.xml2aop.Xml2AopAdvice2"</span>/></span></span><br><span class=line></span><br><span class=line><span class=tag><<span class=name>aop:config</span> <span class=attr>proxy-target-class</span>=<span class=string>"true"</span>></span></span><br><span class=line>    <span class=tag><<span class=name>aop:aspect</span> <span class=attr>id</span>=<span class=string>"test_xml2aop_aspect"</span> <span class=attr>ref</span>=<span class=string>"test_xml2aop_advice2"</span>></span></span><br><span class=line>        <span class=tag><<span class=name>aop:pointcut</span> <span class=attr>id</span>=<span class=string>"test_xml2aop_pointcut"</span> <span class=attr>expression</span>=<span class=string>"execution(* cn.shh.demo.spring.aop.impl.xml2aop.Xml2AopServie.*())"</span>/></span></span><br><span class=line>        <span class=tag><<span class=name>aop:before</span> <span class=attr>pointcut-ref</span>=<span class=string>"test_xml2aop_pointcut"</span> <span class=attr>method</span>=<span class=string>"before"</span> /></span></span><br><span class=line>        <span class=tag><<span class=name>aop:after</span> <span class=attr>pointcut-ref</span>=<span class=string>"test_xml2aop_pointcut"</span> <span class=attr>method</span>=<span class=string>"after"</span> /></span></span><br><span class=line>        <span class=tag><<span class=name>aop:after-returning</span> <span class=attr>pointcut-ref</span>=<span class=string>"test_xml2aop_pointcut"</span> <span class=attr>method</span>=<span class=string>"afterReturning"</span>/></span></span><br><span class=line>        <span class=tag><<span class=name>aop:after-throwing</span> <span class=attr>pointcut-ref</span>=<span class=string>"test_xml2aop_pointcut"</span> <span class=attr>method</span>=<span class=string>"afterThrowing"</span>/></span></span><br><span class=line>        <span class=tag><<span class=name>aop:around</span> <span class=attr>pointcut-ref</span>=<span class=string>"test_xml2aop_pointcut"</span> <span class=attr>method</span>=<span class=string>"aroundAdvice"</span> /></span></span><br><span class=line>    <span class=tag>&LT/<span class=name>aop:aspect</span>></span></span><br><span class=line><span class=tag>&LT/<span class=name>aop:config</span>></span></span><br></pre></table></figure><p>Java类文件内容与Advisor方式中的一样。<h2 id=1-3、注解实现><a class=headerlink href=#1-3、注解实现 title=1.3、注解实现></a>1.3、注解实现</h2><p><strong>（1）创建增强类AspectJ.java</strong><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br></pre><td class=code><pre><span class=line><span class=meta>@Aspect</span></span><br><span class=line><span class=keyword>public</span> <span class=keyword>class</span> <span class="title class_">AspectJ</span> {</span><br><span class=line>	<span class=comment>//@Pointcut("execution(* doing(..))")</span></span><br><span class=line>	<span class=meta>@Pointcut("@annotation(cn.shh.demo.spring.aop.impl.aspectj2aop.AspectJAnnotation)")</span></span><br><span class=line>	<span class=keyword>private</span> <span class=keyword>void</span> <span class="title function_">pointcut</span><span class=params>()</span>{}</span><br><span class=line>	<span class=meta>@Before("pointcut()")</span></span><br><span class=line>	<span class=keyword>public</span> <span class=keyword>void</span> <span class="title function_">before</span><span class=params>()</span>{</span><br><span class=line>		System.out.println(<span class=string>"--- aspectj before advice ---"</span>);</span><br><span class=line>	}</span><br><span class=line>}</span><br></pre></table></figure><p><strong>（2）创建配置类AopConfig.java，开启AOP功能</strong><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line><span class=meta>@Configuration</span></span><br><span class=line><span class=meta>@EnableAspectJAutoProxy</span> <span class=comment>// 开启aop功能</span></span><br><span class=line><span class=keyword>public</span> <span class=keyword>class</span> <span class="title class_">AopConfig</span> {</span><br><span class=line>}</span><br></pre></table></figure><h2 id=1-4、ProxyFactoryBean实现><a class=headerlink href=#1-4、ProxyFactoryBean实现 title=1.4、ProxyFactoryBean实现></a>1.4、ProxyFactoryBean实现</h2><p><strong>（1）创建增强通知类</strong><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre><td class=code><pre><span class=line><span class=keyword>public</span> <span class=keyword>class</span> <span class="title class_">PFBAdvice</span> <span class=keyword>implements</span> <span class="title class_">MethodInterceptor</span>, Advice {</span><br><span class=line>	<span class=meta>@Override</span></span><br><span class=line>	<span class=keyword>public</span> Object <span class="title function_">invoke</span><span class=params>(MethodInvocation invocation)</span> <span class=keyword>throws</span> Throwable {</span><br><span class=line>		System.out.println(<span class=string>"--- ProxyFactoryBean before advice ---"</span>);</span><br><span class=line>		<span class=type>Object</span> <span class=variable>proceed</span> <span class=operator>=</span> invocation.proceed();</span><br><span class=line>		System.out.println(<span class=string>"--- ProxyFactoryBean after advice ---"</span>);</span><br><span class=line>		<span class=keyword>return</span> proceed;</span><br><span class=line>	}</span><br><span class=line>}</span><br></pre></table></figure><p><strong>（2）使用main方法测试效果</strong><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br></pre><td class=code><pre><span class=line><span class=keyword>public</span> <span class=keyword>class</span> <span class="title class_">App</span> {</span><br><span class=line>	<span class=keyword>public</span> <span class=keyword>static</span> <span class=keyword>void</span> <span class="title function_">main</span><span class=params>(String[] args)</span> {</span><br><span class=line>		<span class=type>ProxyFactoryBean</span> <span class=variable>factoryBean</span> <span class=operator>=</span> <span class=keyword>new</span> <span class="title class_">ProxyFactoryBean</span>();</span><br><span class=line>		factoryBean.setTarget(<span class=keyword>new</span> <span class="title class_">PFBServiceImpl</span>());</span><br><span class=line>		factoryBean.addAdvice(<span class=keyword>new</span> <span class="title class_">PFBAdvice</span>());</span><br><span class=line>		<span class=type>PFBServiceImpl</span> <span class=variable>pfbService</span> <span class=operator>=</span> (PFBServiceImpl) factoryBean.getObject();</span><br><span class=line>		pfbService.doing();</span><br><span class=line>		pfbService.doing2();</span><br><span class=line>	}</span><br><span class=line>}</span><br></pre></table></figure><h2 id=1-5、ProxyFactory实现><a class=headerlink href=#1-5、ProxyFactory实现 title=1.5、ProxyFactory实现></a>1.5、ProxyFactory实现</h2><p><strong>（1）创建增强通知类</strong><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre><td class=code><pre><span class=line><span class=keyword>public</span> <span class=keyword>class</span> <span class="title class_">PFAdvice</span> <span class=keyword>implements</span> <span class="title class_">MethodInterceptor</span> {</span><br><span class=line>	<span class=meta>@Override</span></span><br><span class=line>	<span class=keyword>public</span> Object <span class="title function_">invoke</span><span class=params>(MethodInvocation invocation)</span> <span class=keyword>throws</span> Throwable {</span><br><span class=line>		System.out.println(<span class=string>"--- ProxyFactory before advice ---"</span>);</span><br><span class=line>		<span class=type>Object</span> <span class=variable>proceed</span> <span class=operator>=</span> invocation.proceed();</span><br><span class=line>		System.out.println(<span class=string>"--- ProxyFactory after advice ---"</span>);</span><br><span class=line>		<span class=keyword>return</span> proceed;</span><br><span class=line>	}</span><br><span class=line>}</span><br></pre></table></figure><p><strong>（2）使用main方法测试效果</strong><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre><td class=code><pre><span class=line><span class=keyword>public</span> <span class=keyword>class</span> <span class="title class_">App</span> {</span><br><span class=line>	<span class=keyword>public</span> <span class=keyword>static</span> <span class=keyword>void</span> <span class="title function_">main</span><span class=params>(String[] args)</span> {</span><br><span class=line>		<span class=type>ProxyFactory</span> <span class=variable>factory</span> <span class=operator>=</span> <span class=keyword>new</span> <span class="title class_">ProxyFactory</span>(<span class=keyword>new</span> <span class="title class_">PFServiceImpl</span>());</span><br><span class=line>		factory.addAdvice(<span class=keyword>new</span> <span class="title class_">PFAdvice</span>());</span><br><span class=line>		<span class=type>PFService</span> <span class=variable>proxy</span> <span class=operator>=</span> (PFService) factory.getProxy();</span><br><span class=line>		proxy.doing();</span><br><span class=line>		proxy.doing2();</span><br><span class=line>	}</span><br><span class=line>}</span><br></pre></table></figure><h1 id=原理解析><a class=headerlink href=#原理解析 title=原理解析></a>原理解析</h1><h2 id=1-1、动态代理><a class=headerlink href=#1-1、动态代理 title=1.1、动态代理></a>1.1、动态代理</h2><p><strong>Spring AOP通过JDK动态代理和CGLib动态代理实现增强</strong>。<h3 id=1-1-1、JDK动态代理><a class=headerlink href=#1-1-1、JDK动态代理 title=1.1.1、JDK动态代理></a>1.1.1、JDK动态代理</h3><p>JDK动态代理的前提如下：<ul><li>目标类实现了接口，默认使用该方式；</ul><p>JDK动态代理会<strong>基于接口创建实现类的代理对象，创建出来的代理对象与目标类同属于接口的实现类，与目标类是平级关系</strong>。<p>原理：<strong>获取抽象接口信息（利用Java反射技术），并生成一个实现了接口的动态代理类（字节码），再通过反射生成该代理类的实例对象，在调用具体方法时会被拦截，然后执行代理类的方法逻辑</strong>。<h3 id=1-1-2、CGLIB代理><a class=headerlink href=#1-1-2、CGLIB代理 title=1.1.2、CGLIB代理></a>1.1.2、CGLIB代理</h3><p>CGLib动态代理的前提如下：<ul><li>目标类没有实现接口，且没有被final修饰，则默认使用该方式；<li>若目标类实现了接口，那么可通过设置属性<code>proxy-target-class=true</code>来强制使用CGLib代理；</ul><p>原理：<strong>通过ASM加载被代理类的class文件，通过修改其字节码生成子类，并在子类中采用方法拦截技术，拦截所有父类方法调用，并顺势织入增强逻辑</strong>。<h2 id=1-2、功能实现原理><a class=headerlink href=#1-2、功能实现原理 title=1.2、功能实现原理></a>1.2、功能实现原理</h2><h3 id=1-2-1、入口-aop-config><a title="1.2.1、入口 aop:config" class=headerlink href=#1-2-1、入口-aop-config></a>1.2.1、入口 aop:config</h3><p><strong>（1）向容器中注入一个Bean增强器，通过Bean增强器对目标对象进行增强</strong><p>通过标签解析器 ConfigBeanDefinitionParser 向容器中注入<code>AspectJAwareAdvisorAutoProxyCreator</code>。AspectJAwareAdvisorAutoProxyCreator 就是一个BeanPostProcessor，会<strong>在Bean初始化阶段对相关Bean进行增强</strong>。<p><strong>（2）Bean增强器会使用祖先的方法进行增强</strong><p>AspectJAwareAdvisorAutoProxyCreator 会使用爷爷AbstractAutoProxyCreator的postProcessorAfterInitialization方法对bean增强。<p><strong>（3）根据目标对象的实际情况，会选择使用CGLib代理或JDK代理来创建代理进行增强</strong>。<h3 id=1-2-2、入口-EnableAspectJAutoProxy><a class=headerlink href=#1-2-2、入口-EnableAspectJAutoProxy title=1.2.2、入口@EnableAspectJAutoProxy></a>1.2.2、入口@EnableAspectJAutoProxy</h3><p>流程与入口aop:config的类似，详情如下：<p><strong>（1）向容器中注入一个Bean增强器，通过Bean增强器对目标对象进行增强</strong><p>通过标签解析器 AspectJAutoProxyBeanDefinitionParser 向容器中注入<code>AnnotationAwareAspectJAutoProxyCreator</code>。AnnotationAwareAspectJAutoProxyCreator 就是一个BeanPostProcessor，会<strong>在Bean初始化阶段对其进行增强</strong>。<p><strong>（2）该bean增强器是aop:config导入的增强器的子类</strong><p>AnnotationAwareAspectJAutoProxyCreator 就是 AspectJAwareAdvisorAutoProxyCreator 的子类。<p><strong>（3）Bean增强器会使用祖先的方法进行增强</strong><p>AnnotationAwareAspectJAutoProxyCreator 会使用 AbstractAutoProxyCreator 的postProcessorAfterInitialization方法对bean增强。<p><strong>（3）根据目标对象的实际情况，会选择使用CGLib代理或JDK代理来创建代理进行增强</strong>。</div><footer class=post-footer><div class=post-tags><a href=/tags/Spring/ rel=tag># Spring</a><a href=/tags/SpringAOP/ rel=tag># SpringAOP</a></div><div class=post-nav><div class=post-nav-item><a href=/2024/08/21/SpringBoot%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/ rel=prev title=SpringBoot系列-SpringBoot原理解析> <i class="fa fa-angle-left"></i> SpringBoot系列-SpringBoot原理解析 </a></div><div class=post-nav-item><a href=/2024/08/21/SpringBoo%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93/ rel=next title=SpringBoot系列-SpringBoot基础应用> SpringBoot系列-SpringBoot基础应用 <i class="fa fa-angle-right"></i> </a></div></div></footer></article></div></div></main><footer class=footer><div class=footer-inner><div class=copyright>© <span itemprop=copyrightYear>2024</span><span class=with-love> <i class="fa fa-heart"></i> </span><span class=author itemprop=copyrightHolder>豪哥</span></div></div></footer><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span><span class=toggle-line></span><span class=toggle-line></span></div><div class=sidebar-dimmer></div><div aria-label=返回顶部 class=back-to-top role=button><i class="fa fa-arrow-up fa-lg"></i><span>0%</span></div><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><script crossorigin=anonymous integrity=sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY= src=https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js></script><script src=/js/comments.js></script><script src=/js/utils.js></script><script src=/js/motion.js></script><script src=/js/sidebar.js></script><script src=/js/next-boot.js></script><script crossorigin=anonymous integrity=sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc= src=https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js></script><script src=/js/third-party/search/local-search.js></script>