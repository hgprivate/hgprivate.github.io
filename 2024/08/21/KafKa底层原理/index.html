<!doctypehtml><html lang=zh-CN><meta charset=UTF-8><meta content=width=device-width name=viewport><meta media="(prefers-color-scheme: light)" content=#222 name=theme-color><meta media="(prefers-color-scheme: dark)" content=#222 name=theme-color><meta content="Hexo 7.3.0" name=generator><link href=/images/apple-touch-icon-next.png rel=apple-touch-icon sizes=180x180><link href=/images/favicon-32x32-next.png rel=icon sizes=32x32 type=image/png><link href=/images/favicon-16x16-next.png rel=icon sizes=16x16 type=image/png><link color=#222 href=/images/logo.svg rel=mask-icon><link href=/css/main.css rel=stylesheet><link crossorigin=anonymous href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css integrity=sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA= rel=stylesheet><link crossorigin=anonymous href=https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css integrity=sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE= rel=stylesheet><script class=next-config data-name=main type=application/json>{"hostname":"hshz21.gitee.io","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script src=/js/config.js></script><meta content="1、生产者1.1、生产者客户端流程 配置信息 服务器 key/val序列化   生产者实例 KafkaProducer   构造消息 消息 ProducerRecord 消息元数据 RecordMetadata   发送消息 三种方式：发后即忘、同步、异步   关闭生产者  1.2、发送消息流程分析 主线程：拦截器 -> 序列化器 -> 分区器 -> 消息累加器：分区" name=description><meta content=article property=og:type><meta content=Kafka系列-KafKa原理解析 property=og:title><meta content=https://hshz21.gitee.io/2024/08/21/KafKa%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/index.html property=og:url><meta content=豪哥博客 property=og:site_name><meta content="1、生产者1.1、生产者客户端流程 配置信息 服务器 key/val序列化   生产者实例 KafkaProducer   构造消息 消息 ProducerRecord 消息元数据 RecordMetadata   发送消息 三种方式：发后即忘、同步、异步   关闭生产者  1.2、发送消息流程分析 主线程：拦截器 -> 序列化器 -> 分区器 -> 消息累加器：分区" property=og:description><meta content=zh_CN property=og:locale><meta content=https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/07/KafKa%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86-%E7%94%9F%E4%BA%A7%E8%80%85%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B%E5%9B%BE.png property=og:image><meta content=https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/07/KafKa%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86-Broker%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B%E5%9B%BE.png property=og:image><meta content=https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/07/KafKa%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86-%E6%B6%88%E8%B4%B9%E8%80%85%E7%BB%84%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B%E5%9B%BE.png property=og:image><meta content=https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/07/KafKa%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86-%E6%B6%88%E8%B4%B9%E8%80%85%E7%BB%84%E6%B6%88%E8%B4%B9%E6%B6%88%E6%81%AF%E6%B5%81%E7%A8%8B%E5%9B%BE.png property=og:image><meta content=2024-08-21T13:39:13.866Z property=article:published_time><meta content=2023-09-23T09:13:31.099Z property=article:modified_time><meta content=豪哥 property=article:author><meta content=KafKa property=article:tag><meta content=KafKa原理 property=article:tag><meta content=summary name=twitter:card><meta content=https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/07/KafKa%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86-%E7%94%9F%E4%BA%A7%E8%80%85%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B%E5%9B%BE.png name=twitter:image><link href=https://hshz21.gitee.io/2024/08/21/KafKa%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/ rel=canonical><script class=next-config data-name=page type=application/json>{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://hshz21.gitee.io/2024/08/21/KafKa%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/","path":"2024/08/21/KafKa底层原理/","title":"Kafka系列-KafKa原理解析"}</script><script class=next-config data-name=calendar type=application/json>""</script><title>Kafka系列-KafKa原理解析 | 豪哥博客</title><noscript><link href=/css/noscript.css rel=stylesheet></noscript><body class=use-motion itemscope itemtype=http://schema.org/WebPage><div class=headband></div><main class=main><div class=column><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=site-brand-container><div class=site-nav-toggle><div aria-label=切换导航栏 class=toggle role=button><span class=toggle-line></span><span class=toggle-line></span><span class=toggle-line></span></div></div><div class=site-meta><a class=brand href=/ rel=start> <i class=logo-line></i> <p class=site-title>豪哥博客</p> <i class=logo-line></i> </a><p class=site-subtitle itemprop=description>豪哥博客</div><div class=site-nav-right><div class="toggle popup-trigger" aria-label=搜索 role=button><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ rel=section><i class="fa fa-home fa-fw"></i>首页</a><li class="menu-item menu-item-tags"><a href=/tags/ rel=section><i class="fa fa-tags fa-fw"></i>标签</a><li class="menu-item menu-item-categories"><a href=/categories/ rel=section><i class="fa fa-th fa-fw"></i>分类</a><li class="menu-item menu-item-archives"><a href=/archives/ rel=section><i class="fa fa-archive fa-fw"></i>归档</a><li class="menu-item menu-item-search"><a class=popup-trigger role=button><i class="fa fa-search fa-fw"></i>搜索 </a></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon> <i class="fa fa-search"></i> </span><div class=search-input-container><input autocapitalize=off autocomplete=off class=search-input maxlength=80 placeholder=搜索... spellcheck=false type=search></div><span class=popup-btn-close role=button> <i class="fa fa-times-circle"></i> </span></div><div class=search-result-container><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></header><aside class=sidebar><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录<li class=sidebar-nav-overview>站点概览</ul><div class=sidebar-panel-container><!--noindex--><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class=nav><li class="nav-item nav-level-1"><a class=nav-link href=#1%E3%80%81%E7%94%9F%E4%BA%A7%E8%80%85><span class=nav-number>1.</span> <span class=nav-text>1、生产者</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#1-1%E3%80%81%E7%94%9F%E4%BA%A7%E8%80%85%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%B5%81%E7%A8%8B><span class=nav-number>1.1.</span> <span class=nav-text>1.1、生产者客户端流程</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#1-2%E3%80%81%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90><span class=nav-number>1.2.</span> <span class=nav-text>1.2、发送消息流程分析</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#1-3%E3%80%81%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81%E7%9B%B8%E5%85%B3%E5%8F%82%E6%95%B0><span class=nav-number>1.3.</span> <span class=nav-text>1.3、消息发送相关参数</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#1-4%E3%80%81%E7%94%9F%E4%BA%A7%E8%80%85%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF%E6%B5%81%E7%A8%8B><span class=nav-number>1.4.</span> <span class=nav-text>1.4、生产者发送消息流程</span></a></ol><li class="nav-item nav-level-1"><a class=nav-link href=#2%E3%80%81Broker><span class=nav-number>2.</span> <span class=nav-text>2、Broker</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#2-1%E3%80%81Topic%E7%BB%93%E6%9E%84%E5%88%92%E5%88%86><span class=nav-number>2.1.</span> <span class=nav-text>2.1、Topic结构划分</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#2-2%E3%80%81%E5%89%AF%E6%9C%AC><span class=nav-number>2.2.</span> <span class=nav-text>2.2、副本</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#2-3%E3%80%81%E5%88%A0%E9%99%A4%E6%95%B0%E6%8D%AE><span class=nav-number>2.3.</span> <span class=nav-text>2.3、删除数据</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#2-4%E3%80%81%E9%AB%98%E6%95%88%E8%AF%BB%E5%86%99><span class=nav-number>2.4.</span> <span class=nav-text>2.4、高效读写</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#2-5%E3%80%81%E6%89%8B%E5%8A%A8%E8%B0%83%E6%95%B4%E5%88%86%E5%8C%BA%E5%89%AF%E6%9C%AC><span class=nav-number>2.5.</span> <span class=nav-text>2.5、手动调整分区副本</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#2-6%E3%80%81%E6%9C%8D%E5%BD%B9%E6%96%B0%E8%8A%82%E7%82%B9%EF%BC%8C%E9%80%80%E5%BD%B9%E6%97%A7%E8%8A%82%E7%82%B9><span class=nav-number>2.6.</span> <span class=nav-text>2.6、服役新节点，退役旧节点</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#2-7%E3%80%81Broker%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B><span class=nav-number>2.7.</span> <span class=nav-text>2.7、Broker工作流程</span></a></ol><li class="nav-item nav-level-1"><a class=nav-link href=#3%E3%80%81%E6%B6%88%E8%B4%B9%E8%80%85><span class=nav-number>3.</span> <span class=nav-text>3、消费者</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#3-1%E3%80%81%E6%B6%88%E8%B4%B9%E8%80%85%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%B5%81%E7%A8%8B><span class=nav-number>3.1.</span> <span class=nav-text>3.1、消费者客户端流程</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#3-2%E3%80%81%E5%88%86%E5%8C%BA%E5%88%86%E9%85%8D%E7%AD%96%E7%95%A5><span class=nav-number>3.2.</span> <span class=nav-text>3.2、分区分配策略</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#3-3%E3%80%81%E5%81%8F%E7%A7%BB%E9%87%8FOffset><span class=nav-number>3.3.</span> <span class=nav-text>3.3、偏移量Offset</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#3-4%E3%80%81%E4%BA%8B%E5%8A%A1><span class=nav-number>3.4.</span> <span class=nav-text>3.4、事务</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#3-5%E3%80%81%E6%95%B0%E6%8D%AE%E7%A7%AF%E5%8E%8B><span class=nav-number>3.5.</span> <span class=nav-text>3.5、数据积压</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#3-6%E3%80%81%E6%B6%88%E8%B4%B9%E8%80%85%E6%B6%88%E8%B4%B9%E6%B6%88%E6%81%AF%E6%B5%81%E7%A8%8B><span class=nav-number>3.6.</span> <span class=nav-text>3.6、消费者消费消息流程</span></a></ol><li class="nav-item nav-level-1"><a class=nav-link href=#4%E3%80%81Kafka%E7%9B%91%E6%8E%A7><span class=nav-number>4.</span> <span class=nav-text>4、Kafka监控</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#4-1%E3%80%81%E5%AE%89%E8%A3%85MySQL><span class=nav-number>4.1.</span> <span class=nav-text>4.1、安装MySQL</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#4-2%E3%80%81%E9%85%8D%E7%BD%AEKafka><span class=nav-number>4.2.</span> <span class=nav-text>4.2、配置Kafka</span></a></ol><li class="nav-item nav-level-1"><a class=nav-link href=#5%E3%80%81Kafka%E7%A1%AC%E4%BB%B6%E9%9C%80%E6%B1%82><span class=nav-number>5.</span> <span class=nav-text>5、Kafka硬件需求</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#5-1%E3%80%81%E6%97%A5%E6%B5%81%E9%87%8F><span class=nav-number>5.1.</span> <span class=nav-text>5.1、日流量</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#5-2%E3%80%81%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%95%B0%E9%87%8F><span class=nav-number>5.2.</span> <span class=nav-text>5.2、服务器数量</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#5-3%E3%80%81%E7%A1%AC%E7%9B%98%E9%80%89%E6%8B%A9><span class=nav-number>5.3.</span> <span class=nav-text>5.3、硬盘选择</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#5-4%E3%80%81%E5%86%85%E5%AD%98%E9%80%89%E6%8B%A9><span class=nav-number>5.4.</span> <span class=nav-text>5.4、内存选择</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#5-5%E3%80%81CPU><span class=nav-number>5.5.</span> <span class=nav-text>5.5、CPU</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#5-6%E3%80%81%E7%BD%91%E7%BB%9C><span class=nav-number>5.6.</span> <span class=nav-text>5.6、网络</span></a></ol><li class="nav-item nav-level-1"><a class=nav-link href=#6%E3%80%81%E8%B0%83%E4%BC%98><span class=nav-number>6.</span> <span class=nav-text>6、调优</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#6-1%E3%80%81%E7%94%9F%E4%BA%A7%E8%80%85%E4%BC%98%E5%8C%96><span class=nav-number>6.1.</span> <span class=nav-text>6.1、生产者优化</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#6-1-1%E3%80%81%E6%8F%90%E5%8D%87%E7%94%9F%E4%BA%A7%E8%80%85%E5%90%9E%E5%90%90%E9%87%8F><span class=nav-number>6.1.1.</span> <span class=nav-text>6.1.1、提升生产者吞吐量</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#6-1-2%E3%80%81%E6%95%B0%E6%8D%AE%E5%8F%AF%E9%9D%A0%E6%80%A7><span class=nav-number>6.1.2.</span> <span class=nav-text>6.1.2、数据可靠性</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#6-1-3%E3%80%81%E6%95%B0%E6%8D%AE%E5%8E%BB%E9%87%8D><span class=nav-number>6.1.3.</span> <span class=nav-text>6.1.3、数据去重</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#6-1-4%E3%80%81%E6%95%B0%E6%8D%AE%E6%9C%89%E5%BA%8F><span class=nav-number>6.1.4.</span> <span class=nav-text>6.1.4、数据有序</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#6-1-5%E3%80%81%E6%95%B0%E6%8D%AE%E4%B9%B1%E5%BA%8F><span class=nav-number>6.1.5.</span> <span class=nav-text>6.1.5、数据乱序</span></a></ol><li class="nav-item nav-level-2"><a class=nav-link href=#6-2%E3%80%81Broker%E4%BC%98%E5%8C%96><span class=nav-number>6.2.</span> <span class=nav-text>6.2、Broker优化</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#6-2-1%E3%80%81%E6%9C%8D%E5%BD%B9%E9%80%80%E5%BD%B9%E8%8A%82%E7%82%B9><span class=nav-number>6.2.1.</span> <span class=nav-text>6.2.1、服役退役节点</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#6-2-2%E3%80%81%E5%A2%9E%E5%8A%A0%E5%88%86%E5%8C%BA><span class=nav-number>6.2.2.</span> <span class=nav-text>6.2.2、增加分区</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#6-2-3%E3%80%81%E5%A2%9E%E5%8A%A0%E5%89%AF%E6%9C%AC%E5%9B%A0%E5%AD%90><span class=nav-number>6.2.3.</span> <span class=nav-text>6.2.3、增加副本因子</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#6-2-4%E3%80%81Leader%E5%88%86%E5%8C%BA%E8%B4%9F%E8%BD%BD%E5%B9%B3%E8%A1%A1><span class=nav-number>6.2.4.</span> <span class=nav-text>6.2.4、Leader分区负载平衡</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#6-2-5%E3%80%81%E8%87%AA%E5%8A%A8%E5%88%9B%E5%BB%BA%E4%B8%BB%E9%A2%98><span class=nav-number>6.2.5.</span> <span class=nav-text>6.2.5、自动创建主题</span></a></ol><li class="nav-item nav-level-2"><a class=nav-link href=#6-3%E3%80%81%E6%B6%88%E8%B4%B9%E8%80%85%E4%BC%98%E5%8C%96><span class=nav-number>6.3.</span> <span class=nav-text>6.3、消费者优化</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#6-3-1%E3%80%81%E6%B6%88%E8%B4%B9%E8%80%85%E5%86%8D%E5%B9%B3%E8%A1%A1><span class=nav-number>6.3.1.</span> <span class=nav-text>6.3.1、消费者再平衡</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#6-3-2%E3%80%81%E6%8C%87%E5%AE%9AOffset%E6%B6%88%E8%B4%B9><span class=nav-number>6.3.2.</span> <span class=nav-text>6.3.2、指定Offset消费</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#6-3-3%E3%80%81%E6%8C%87%E5%AE%9A%E6%97%B6%E9%97%B4%E6%B6%88%E8%B4%B9><span class=nav-number>6.3.3.</span> <span class=nav-text>6.3.3、指定时间消费</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#6-3-4%E3%80%81%E6%B6%88%E8%B4%B9%E8%80%85%E4%BA%8B%E5%8A%A1><span class=nav-number>6.3.4.</span> <span class=nav-text>6.3.4、消费者事务</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#6-3-5%E3%80%81%E6%B6%88%E8%B4%B9%E8%80%85%E6%8F%90%E5%8D%87%E5%90%9E%E5%90%90%E9%87%8F><span class=nav-number>6.3.5.</span> <span class=nav-text>6.3.5、消费者提升吞吐量</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#6-3-6%E3%80%81%E5%A2%9E%E5%8A%A0%E4%B8%8B%E6%B8%B8%E6%B6%88%E8%B4%B9%E8%80%85%E5%A4%84%E7%90%86%E8%83%BD%E5%8A%9B><span class=nav-number>6.3.6.</span> <span class=nav-text>6.3.6、增加下游消费者处理能力</span></a></ol><li class="nav-item nav-level-2"><a class=nav-link href=#6-4%E3%80%81%E6%95%B4%E4%BD%93%E8%B0%83%E4%BC%98><span class=nav-number>6.4.</span> <span class=nav-text>6.4、整体调优</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#6-4-1%E3%80%81%E6%8F%90%E5%8D%87%E5%90%9E%E5%90%90%E9%87%8F><span class=nav-number>6.4.1.</span> <span class=nav-text>6.4.1、提升吞吐量</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#6-4-2%E3%80%81%E6%95%B0%E6%8D%AE%E7%B2%BE%E5%87%86%E4%B8%80%E6%AC%A1><span class=nav-number>6.4.2.</span> <span class=nav-text>6.4.2、数据精准一次</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#6-4-3%E3%80%81%E5%90%88%E7%90%86%E8%AE%BE%E7%BD%AE%E5%88%86%E5%8C%BA%E6%95%B0><span class=nav-number>6.4.3.</span> <span class=nav-text>6.4.3、合理设置分区数</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#6-4-4%E3%80%81%E5%8D%95%E6%9D%A1%E6%97%A5%E5%BF%97%E5%A4%A7%E5%B0%8F><span class=nav-number>6.4.4.</span> <span class=nav-text>6.4.4、单条日志大小</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#6-4-5%E3%80%81%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%AE%95%E6%9C%BA><span class=nav-number>6.4.5.</span> <span class=nav-text>6.4.5、服务器宕机</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#6-4-6%E3%80%81%E9%9B%86%E7%BE%A4%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95><span class=nav-number>6.4.6.</span> <span class=nav-text>6.4.6、集群压力测试</span></a></ol></ol><li class="nav-item nav-level-1"><a class=nav-link href=#7%E3%80%81%E6%9F%A5%E7%9C%8B%E6%97%A5%E5%BF%97%E5%88%86%E6%AE%B5><span class=nav-number>7.</span> <span class=nav-text>7、查看日志分段</span></a></ol></div></div><!--/noindex--><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop=author itemscope itemtype=http://schema.org/Person><img alt=豪哥 class=site-author-image itemprop=image src=/static/imgs/avatar.png><p class=site-author-name itemprop=name>豪哥<div class=site-description itemprop=description>豪哥博客</div></div><div class="site-state-wrap animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/> <span class=site-state-item-count>116</span> <span class=site-state-item-name>日志</span> </a></div><div class="site-state-item site-state-categories"><a href=/categories/> <span class=site-state-item-count>35</span> <span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/> <span class=site-state-item-count>128</span> <span class=site-state-item-name>标签</span></a></div></nav></div></div></div></div></aside></div><div class="main-inner post posts-expand"><div class=post-block><article class=post-content itemscope itemtype=http://schema.org/Article lang=zh-CN><link href=https://hshz21.gitee.io/2024/08/21/KafKa%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/ itemprop=mainEntityOfPage><span hidden itemprop=author itemscope itemtype=http://schema.org/Person> <meta content=/static/imgs/avatar.png itemprop=image> <meta content=豪哥 itemprop=name> </span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization> <meta content=豪哥博客 itemprop=name> <meta content=豪哥博客 itemprop=description> </span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork> <meta content="Kafka系列-KafKa原理解析 | 豪哥博客" itemprop=name> <meta itemprop=description> </span><header class=post-header><h1 itemprop="name headline" class=post-title>Kafka系列-KafKa原理解析</h1><div class=post-meta-container><div class=post-meta><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar"></i> </span> <span class=post-meta-item-text>发表于</span> <time itemprop="dateCreated datePublished" title="创建时间：2024-08-21 21:39:13" datetime=2024-08-21T21:39:13+08:00>2024-08-21</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar-check"></i> </span> <span class=post-meta-item-text>更新于</span> <time title="修改时间：2023-09-23 17:13:31" datetime=2023-09-23T17:13:31+08:00 itemprop=dateModified>2023-09-23</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-folder"></i> </span> <span class=post-meta-item-text>分类于</span> <span itemprop=about itemscope itemtype=http://schema.org/Thing> <a href=/categories/KafKa/ itemprop=url rel=index><span itemprop=name>KafKa</span></a> </span> </span></div></div></header><div class=post-body itemprop=articleBody><h1 id=1、生产者><a class=headerlink href=#1、生产者 title=1、生产者></a>1、生产者</h1><h2 id=1-1、生产者客户端流程><a class=headerlink href=#1-1、生产者客户端流程 title=1.1、生产者客户端流程></a>1.1、生产者客户端流程</h2><ol><li><strong>配置信息</strong><ul><li>服务器<li>key/val序列化</ul><li><strong>生产者实例</strong><ul><li>KafkaProducer</ul><li><strong>构造消息</strong><ul><li>消息 ProducerRecord<li>消息元数据 RecordMetadata</ul><li><strong>发送消息</strong><ul><li>三种方式：发后即忘、同步、异步</ul><li><strong>关闭生产者</strong></ol><h2 id=1-2、发送消息流程分析><a class=headerlink href=#1-2、发送消息流程分析 title=1.2、发送消息流程分析></a>1.2、发送消息流程分析</h2><ul><li>主线程：拦截器 -> 序列化器 -> 分区器 -> 消息累加器：分区 - 双端队列-ProducerBatch。<li>send线程：Request -> node - Request -> selector -> kafka cluster。</ul><h2 id=1-3、消息发送相关参数><a class=headerlink href=#1-3、消息发送相关参数 title=1.3、消息发送相关参数></a>1.3、消息发送相关参数</h2><ol><li><code>compression.type</code>：消息压缩方式 gzip / snappy / lz4<li><code>linger.ms</code>：发送ProducerBatch前等待消息加入的时间，默认0<li><code>max.request.size</code>：能发送消息的最大值，默认1048576<li><code>retries</code>：发生消息异常时的重试次数，默认2147483647<li><code>retry.backoff.ms</code>：发生异常时的重试间隔时间，默认100<li><code>send.buffer.bytes</code>：socket发送消息缓冲区大小，默认131072，128KB<li><code>receive.buffer.bytes</code>：socket接收消息缓冲区大小，默认65536，64KB<li><code>request.timeout.ms</code>：等待请求响应的最长时间，默认30秒<li><code>acks</code>：有多少分区收到消息，才会响应成功。<ul><li>1：leader副本写入成功就响应。<li>0：无需等待响应（异步）。<li>-1/all：ISR集合中的副本都写入成功后再响应。</ul><li><code>connections.max.idle.ms</code>：多久后关闭限制的连接，默认9分钟</ol><h2 id=1-4、生产者发送消息流程><a class=headerlink href=#1-4、生产者发送消息流程 title=1.4、生产者发送消息流程></a>1.4、生产者发送消息流程</h2><p><img src=https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/07/KafKa%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86-%E7%94%9F%E4%BA%A7%E8%80%85%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B%E5%9B%BE.png><h1 id=2、Broker><a class=headerlink href=#2、Broker title=2、Broker></a>2、Broker</h1><h2 id=2-1、Topic结构划分><a class=headerlink href=#2-1、Topic结构划分 title=2.1、Topic结构划分></a>2.1、Topic结构划分</h2><p>topic -> partition -> 副本 -> log -> segment(.log / .index / .timeindex / 其它)<blockquote><p><code>.index</code>索引文件 基于 稀疏索引实现，默认<code>.log</code>文件每记录4Kb数据 就会在<code>.index</code>文件中记录一条索引。</blockquote><h2 id=2-2、副本><a class=headerlink href=#2-2、副本 title=2.2、副本></a>2.2、副本</h2><ol><li>leader : follower === 1 : N。<li>AR = ISR + OSR。<li>leader副本与follower副本间若超30秒没有交流，否则从ISR中删除。<li>controller 第一次 随机 轮询。<li>leader / follower 挂了。<li>副本分配 默认。<li>手动分配。<li>leader partition 负载均衡 10%。</ol><h2 id=2-3、删除数据><a class=headerlink href=#2-3、删除数据 title=2.3、删除数据></a>2.3、删除数据</h2><p><strong>数据默认保存7天，超过就会被删除</strong>。<p>删除策略有两种：<ul><li><strong>删除</strong>：所有都过期再删除。<li><strong>压缩</strong>：以最新val的key为准保存。</ul><h2 id=2-4、高效读写><a class=headerlink href=#2-4、高效读写 title=2.4、高效读写></a>2.4、高效读写</h2><ol><li><strong>集群分区</strong><li><strong>稀疏索引</strong><li><strong>顺序读写</strong><li><strong>零拷贝 / 页缓存（内核）</strong></ol><h2 id=2-5、手动调整分区副本><a class=headerlink href=#2-5、手动调整分区副本 title=2.5、手动调整分区副本></a>2.5、手动调整分区副本</h2><ol><li><p>编写一个json文件(文件名为increase-replication-factor.json)，内容格式如下：</p> <figure class="highlight json"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line><span class=attr>"version"</span><span class=punctuation>:</span><span class=number>1</span></span><br><span class=line><span class=attr>"partitions"</span><span class=punctuation>:</span><span class=punctuation>[</span><span class=punctuation>{</span><span class=attr>"topic"</span><span class=punctuation>:</span><span class=string>"first"</span><span class=punctuation>,</span><span class=attr>"partition"</span><span class=punctuation>:</span><span class=number>0</span><span class=punctuation>,</span><span class=attr>"replicas"</span><span class=punctuation>:</span><span class=punctuation>[</span><span class=number>0</span><span class=punctuation>,</span><span class=number>1</span><span class=punctuation>]</span><span class=punctuation>}</span><span class=punctuation>,</span></span><br><span class=line>			 <span class=punctuation>{</span><span class=attr>"topic"</span><span class=punctuation>:</span><span class=string>"first"</span><span class=punctuation>,</span><span class=attr>"partition"</span><span class=punctuation>:</span><span class=number>1</span><span class=punctuation>,</span><span class=attr>"replicas"</span><span class=punctuation>:</span><span class=punctuation>[</span><span class=number>0</span><span class=punctuation>,</span><span class=number>1</span><span class=punctuation>]</span><span class=punctuation>}</span><span class=punctuation>,</span></span><br><span class=line>			 <span class=punctuation>{</span><span class=attr>"topic"</span><span class=punctuation>:</span><span class=string>"first"</span><span class=punctuation>,</span><span class=attr>"partition"</span><span class=punctuation>:</span><span class=number>2</span><span class=punctuation>,</span><span class=attr>"replicas"</span><span class=punctuation>:</span><span class=punctuation>[</span><span class=number>1</span><span class=punctuation>,</span><span class=number>0</span><span class=punctuation>]</span><span class=punctuation>}</span><span class=punctuation>,</span></span><br><span class=line>			 <span class=punctuation>{</span><span class=attr>"topic"</span><span class=punctuation>:</span><span class=string>"first"</span><span class=punctuation>,</span><span class=attr>"partition"</span><span class=punctuation>:</span><span class=number>4</span><span class=punctuation>,</span><span class=attr>"replicas"</span><span class=punctuation>:</span><span class=punctuation>[</span><span class=number>1</span><span class=punctuation>,</span><span class=number>0</span><span class=punctuation>]</span><span class=punctuation>}</span><span class=punctuation>]</span></span><br></pre></table></figure><li><p>执行如下命令</p> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>bin/kafka-reassign-partitions.sh --bootstrap-server node2:9092 --reassignment-json-file increase-replication-factor.json --execute</span><br></pre></table></figure></ol><h2 id=2-6、服役新节点，退役旧节点><a class=headerlink href=#2-6、服役新节点，退役旧节点 title=2.6、服役新节点，退役旧节点></a>2.6、服役新节点，退役旧节点</h2><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br></pre><td class=code><pre><span class=line><span class=comment># 第一步</span></span><br><span class=line>bin/kafka-reassign-partitions.sh --bootstrap-server node1:9092 --topics-to-move-json-file topics-to-move.json --broker-list <span class=string>"0,1,2,3"</span> --generate</span><br><span class=line></span><br><span class=line><span class=comment># 第二步</span></span><br><span class=line>vim increase-replication-factor.json</span><br><span class=line></span><br><span class=line><span class=comment># 第三步</span></span><br><span class=line>bin/kafka-reassign-partitions --bootstrap-server node1:9092 --reassignment-json-file increase-replication-factor.json --execute</span><br><span class=line></span><br><span class=line><span class=comment># 第四步</span></span><br><span class=line>bin/kafka-reassign-partitions.sh --bootstrap-server node1:9092 --reassignment-json-file increase-replication-factor.json --verify</span><br></pre></table></figure><h2 id=2-7、Broker工作流程><a class=headerlink href=#2-7、Broker工作流程 title=2.7、Broker工作流程></a>2.7、Broker工作流程</h2><p><img src=https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/07/KafKa%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86-Broker%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B%E5%9B%BE.png><h1 id=3、消费者><a class=headerlink href=#3、消费者 title=3、消费者></a>3、消费者</h1><h2 id=3-1、消费者客户端流程><a class=headerlink href=#3-1、消费者客户端流程 title=3.1、消费者客户端流程></a>3.1、消费者客户端流程</h2><ol><li><strong>消费者配置</strong><ul><li>连接服务器<li>key/val序列化<li>消费组ID</ul><li><strong>消费者实例</strong><li><strong>订阅主题</strong><li><strong>拉取消息并消费</strong><li><strong>提交消费位移</strong><li><strong>关系消费者</strong></ol><h2 id=3-2、分区分配策略><a class=headerlink href=#3-2、分区分配策略 title=3.2、分区分配策略></a>3.2、分区分配策略</h2><ul><li><p><strong>Range：按主题来分配。</strong></p> <p>消费者数量 不是 分区数量的 整数倍时，第一个消费者多消费一个分区。</p> <p>例如：分区为【0、1、2、3、4、5、6】，消费者为【c1、c2、c3】，那么消费者消费规则为：c1：【0、1、2】，c2：【3、4】，c3：【5、6】。该种策略会造成 数据倾斜 问题。</p><li><p><strong>RoundRobin：轮询分区策略。</strong></p> <p>例如：分区为【0、1、2、3、4、5、6】，消费者为【c1、c2、c3】，那么消费者消费规则为：c1：【0、3、6】，c2：【1、4】，c3：【2、5】。</p><li><p><strong>Sticky：粘性分区策略，也即随机分配。</strong></p> <p>例如：分区为【0、1、2、3、4、5、6】，消费者为【c1、c2、c3】，那么消费者消费规则为：c1：【0、5、6】，c2：【1、3】，c3：【2、4】。注意：第一个消费者会多消费一个，但消费者所消费的分区是随机。</p><li><p><strong>CooperativeSticky：遵循相同的 Sticky逻辑，但允许再平衡。</strong></p></ul><blockquote><p>默认策略为 Range + CooperativeSticky，kafka允许设置多个分配策略。</blockquote><h2 id=3-3、偏移量Offset><a class=headerlink href=#3-3、偏移量Offset title=3.3、偏移量Offset></a>3.3、偏移量Offset</h2><ol><li>默认存储在系统主题。<li>默认自动提交，提交周期5s。<li>手动提交、同步/异步。<li>指定offset位置起消费，通过方法seek()实现。<li>按照时间消费、把时间转成offset再消费。<li>漏消费、重复消费。</ol><h2 id=3-4、事务><a class=headerlink href=#3-4、事务 title=3.4、事务></a>3.4、事务</h2><p>生产端 -> 集群 -> 消费者 -> 框架<h2 id=3-5、数据积压><a class=headerlink href=#3-5、数据积压 title=3.5、数据积压></a>3.5、数据积压</h2><ol><li>增加分区 消费者。<li>生产 -> 集群，4个参数。<li>消费端 两个参数 50m 500条。</ol><h2 id=3-6、消费者消费消息流程><a class=headerlink href=#3-6、消费者消费消息流程 title=3.6、消费者消费消息流程></a>3.6、消费者消费消息流程</h2><p>消费者组 初始化 流程图：<p><img src=https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/07/KafKa%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86-%E6%B6%88%E8%B4%B9%E8%80%85%E7%BB%84%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B%E5%9B%BE.png><p>消费者组 消费消息 流程图：<p><img src=https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/07/KafKa%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86-%E6%B6%88%E8%B4%B9%E8%80%85%E7%BB%84%E6%B6%88%E8%B4%B9%E6%B6%88%E6%81%AF%E6%B5%81%E7%A8%8B%E5%9B%BE.png><h1 id=4、Kafka监控><a class=headerlink href=#4、Kafka监控 title=4、Kafka监控></a>4、Kafka监控</h1><h2 id=4-1、安装MySQL><a class=headerlink href=#4-1、安装MySQL title=4.1、安装MySQL></a>4.1、安装MySQL</h2><p>参考博客。<h2 id=4-2、配置Kafka><a class=headerlink href=#4-2、配置Kafka title=4.2、配置Kafka></a>4.2、配置Kafka</h2><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line><span class=comment># 1、修改kafka启动脚本(kafka-server-start.sh)，修改KAFKA_HEAP_OPTS参数项：</span></span><br><span class=line><span class=built_in>export</span> KAFKA_HEAP_OPTS=“-server -Xms2G -Xmx2G -XX:PermSize=128m </span><br><span class=line>-XX:+UserG1GC -XX:MaxGCPauseMillis=200 -XX:ParallelGCThreads=8 </span><br><span class=line>-XX:ConcGCThreads=5 -XX:InitiatingHeapOccupancyPercent=70”</span><br><span class=line><span class=built_in>export</span> JMX_PORT=9999</span><br></pre></table></figure><h1 id=5、Kafka硬件需求><a class=headerlink href=#5、Kafka硬件需求 title=5、Kafka硬件需求></a>5、Kafka硬件需求</h1><h2 id=5-1、日流量><a class=headerlink href=#5-1、日流量 title=5.1、日流量></a>5.1、日流量</h2><ul><li>100G万日活 * 每人每天100条 = 1亿条（中型公司）<li>处理速度：1亿条 / (24 * 3600s) = 1150条/秒<li>1150条日志 * 1K/s = 1m/s<li>高峰：1m/s * 20倍 = 20m/s - 40m/s</ul><h2 id=5-2、服务器数量><a class=headerlink href=#5-2、服务器数量 title=5.2、服务器数量></a>5.2、服务器数量</h2><p>参考公式：2 * (生产者峰值速率 * 副本数 / 100) + 1<p>服务器数量 = 2 * （20m/s * 2 / 100） + 1 = 3台服务器。<h2 id=5-3、硬盘选择><a class=headerlink href=#5-3、硬盘选择 title=5.3、硬盘选择></a>5.3、硬盘选择</h2><ul><li>1亿条数据 * 1K = 100G。<li>100G * 2副本 * 3天 / 0.7 = 1T硬盘容量。<li><strong>三台服务器，磁盘总大小要大于1T</strong>。</ul><h2 id=5-4、内存选择><a class=headerlink href=#5-4、内存选择 title=5.4、内存选择></a>5.4、内存选择</h2><p>kafka内存 = 堆内存 + 页缓存（服务器内存）<ol><li><p>堆内存10 - 15G。</p> <figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line>jstat -gc kafka进程ID号 ls 10</span><br><span class=line>jmap -heap kafka进程号</span><br></pre></table></figure><li><p>页缓存segment（1G） (分区数 * 1G * 25%) / 3 = 1G。</p><li><p>一台服务器为 10G + 1G = 11G，<strong>大于11G即可</strong>。</p></ol><h2 id=5-5、CPU><a class=headerlink href=#5-5、CPU title=5.5、CPU></a>5.5、CPU</h2><p><strong>32核 最优</strong>。<ul><li>num.io.threads：写磁盘线程数，占总核数的50%，即12个<li>num.replica.fetchers：副本拉取线程数，占总核数50%的三分之一，即4个<li>num.network.threads：数据传输线程数，占总核数50%的三分之二，即8个<li>执行其它任务线程 8个</ul><h2 id=5-6、网络><a class=headerlink href=#5-6、网络 title=5.6、网络></a>5.6、网络</h2><p>网络带宽 = 峰值吞吐量 = 20M/S<p><strong>选择 千兆网卡（125M/s）即可</strong>。<h1 id=6、调优><a class=headerlink href=#6、调优 title=6、调优></a>6、调优</h1><h2 id=6-1、生产者优化><a class=headerlink href=#6-1、生产者优化 title=6.1、生产者优化></a>6.1、生产者优化</h2><h3 id=6-1-1、提升生产者吞吐量><a class=headerlink href=#6-1-1、提升生产者吞吐量 title=6.1.1、提升生产者吞吐量></a>6.1.1、提升生产者吞吐量</h3><ol><li>buffer.memory：发送缓冲区大小，默认32M，可提升到64M。<li>batch.size：默认16KB。<li>linger.ms：默认0，一般设置5-100。<li>compression.type：压缩方式。</ol><h3 id=6-1-2、数据可靠性><a class=headerlink href=#6-1-2、数据可靠性 title=6.1.2、数据可靠性></a>6.1.2、数据可靠性</h3><ol><li>acks：0 / 1 / -1，默认为-1。<li>ack设为-1。<li>分区副本数量大于等于2。<li>ISR中应答的副本数量大于等于2。</ol><h3 id=6-1-3、数据去重><a class=headerlink href=#6-1-3、数据去重 title=6.1.3、数据去重></a>6.1.3、数据去重</h3><ol><li>enable.idempotence：是否开启幂等性，默认为true，表示开启。<li>开启事务。</ol><h3 id=6-1-4、数据有序><a class=headerlink href=#6-1-4、数据有序 title=6.1.4、数据有序></a>6.1.4、数据有序</h3><ol><li>采用单分区，单分区内数据有序，可实现有序消费。<li>多分区，分区间是无序的。</ol><h3 id=6-1-5、数据乱序><a class=headerlink href=#6-1-5、数据乱序 title=6.1.5、数据乱序></a>6.1.5、数据乱序</h3><ol><li>enable.idempotence=true，开启幂等处理。<li>允许没有返回的ack次数为1-5。</ol><h2 id=6-2、Broker优化><a class=headerlink href=#6-2、Broker优化 title=6.2、Broker优化></a>6.2、Broker优化</h2><h3 id=6-2-1、服役退役节点><a class=headerlink href=#6-2-1、服役退役节点 title=6.2.1、服役退役节点></a>6.2.1、服役退役节点</h3><h3 id=6-2-2、增加分区><a class=headerlink href=#6-2-2、增加分区 title=6.2.2、增加分区></a>6.2.2、增加分区</h3><h3 id=6-2-3、增加副本因子><a class=headerlink href=#6-2-3、增加副本因子 title=6.2.3、增加副本因子></a>6.2.3、增加副本因子</h3><ol><li>创建副本存储计划<li>执行副本存储计划</ol><h3 id=6-2-4、Leader分区负载平衡><a class=headerlink href=#6-2-4、Leader分区负载平衡 title=6.2.4、Leader分区负载平衡></a>6.2.4、Leader分区负载平衡</h3><ol><li>auto.leader-rebalance.enable：默认为true，建议关闭。</ol><h3 id=6-2-5、自动创建主题><a class=headerlink href=#6-2-5、自动创建主题 title=6.2.5、自动创建主题></a>6.2.5、自动创建主题</h3><ol><li>关闭 自动创建主题功能。</ol><h2 id=6-3、消费者优化><a class=headerlink href=#6-3、消费者优化 title=6.3、消费者优化></a>6.3、消费者优化</h2><h3 id=6-3-1、消费者再平衡><a class=headerlink href=#6-3-1、消费者再平衡 title=6.3.1、消费者再平衡></a>6.3.1、消费者再平衡</h3><ol><li>消费者与coordinator心跳时间3S。<li>消费者与coordinator连接超时45S。<li>消费者 消息处理超时 5分钟。<li>消费者分区分配策略，默认Range+CooperativeSticky，可同时配置多个策略。可选策略有：Range、RoundRobin、Sticky、CooperativeSticky。</ol><h3 id=6-3-2、指定Offset消费><a class=headerlink href=#6-3-2、指定Offset消费 title=6.3.2、指定Offset消费></a>6.3.2、指定Offset消费</h3><h3 id=6-3-3、指定时间消费><a class=headerlink href=#6-3-3、指定时间消费 title=6.3.3、指定时间消费></a>6.3.3、指定时间消费</h3><h3 id=6-3-4、消费者事务><a class=headerlink href=#6-3-4、消费者事务 title=6.3.4、消费者事务></a>6.3.4、消费者事务</h3><h3 id=6-3-5、消费者提升吞吐量><a class=headerlink href=#6-3-5、消费者提升吞吐量 title=6.3.5、消费者提升吞吐量></a>6.3.5、消费者提升吞吐量</h3><ol><li>fetch.max.bytes：默认50M。<li>max.poll.records：默认500条。</ol><h3 id=6-3-6、增加下游消费者处理能力><a class=headerlink href=#6-3-6、增加下游消费者处理能力 title=6.3.6、增加下游消费者处理能力></a>6.3.6、增加下游消费者处理能力</h3><h2 id=6-4、整体调优><a class=headerlink href=#6-4、整体调优 title=6.4、整体调优></a>6.4、整体调优</h2><h3 id=6-4-1、提升吞吐量><a class=headerlink href=#6-4-1、提升吞吐量 title=6.4.1、提升吞吐量></a>6.4.1、提升吞吐量</h3><ul><li>生产者<ol><li>buffer.memory：发送缓冲区大小，默认32M，可提升到64M。<li>batch.size：默认16KB。<li>linger.ms：默认0，一般设置5-100。<li>compression.type：压缩方式。</ol><li>Broker<ol><li>增加分区</ol><li>消费者<ol><li>fetch.max.bytes：默认50M。<li>max.poll.records：默认500条。</ol><li>增加下游消费者处理能力</ul><h3 id=6-4-2、数据精准一次><a class=headerlink href=#6-4-2、数据精准一次 title=6.4.2、数据精准一次></a>6.4.2、数据精准一次</h3><ul><li>生产者<ol><li>acks设置为-1。<li>幂等性+事务。</ol><li>Broker<ol><li>分区副本大于等于2。<li>ISR中应答的最小副本数量大于等于2</ol><li>消费者<ol><li>事务+手动提交。<li>消费者输出目的地必须支持事务。</ol></ul><h3 id=6-4-3、合理设置分区数><a class=headerlink href=#6-4-3、合理设置分区数 title=6.4.3、合理设置分区数></a>6.4.3、合理设置分区数</h3><p>producer吞吐量=20M/S，consumer吞吐量=50M/S，期望吞吐量=100M/S，则：<p>分区数量=100/20=5个分区，分区数量一般设置为3-10个。<h3 id=6-4-4、单条日志大小><a class=headerlink href=#6-4-4、单条日志大小 title=6.4.4、单条日志大小></a>6.4.4、单条日志大小</h3><ol><li>message.max.bytes：默认1M，broker接收每批次消息最大值。<li>max.request.size：默认1M，broker发送每个请求的最大值，针对topic来说。<li>replica.fetch.max.bytes：默认1M，副本同步数据每批次的最大值。<li>fetch.max.bytes：默认50M。</ol><h3 id=6-4-5、服务器宕机><a class=headerlink href=#6-4-5、服务器宕机 title=6.4.5、服务器宕机></a>6.4.5、服务器宕机</h3><p>处理方法流程<ol><li>尝试启动，若可以启动，直接解决。<li>重启不行，增加内存，增加CPU、网络带宽。<li>若节点被删除，但副本数量大于等于2个，可以参考服役新节点的方式重新服役一个新节点，并执行负载均衡。</ol><h3 id=6-4-6、集群压力测试><a class=headerlink href=#6-4-6、集群压力测试 title=6.4.6、集群压力测试></a>6.4.6、集群压力测试</h3><ol><li>使用kafka官方脚本来压测<ul><li>生产者：kafka-producer-perf-test.sh<li>消费者：kafka-consumer-perf-test.sh</ul><li>其他方式压测</ol><h1 id=7、查看日志分段><a class=headerlink href=#7、查看日志分段 title=7、查看日志分段></a>7、查看日志分段</h1><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>kafka-run-class.sh kafka.tools.DumpLogSegments --files 000000000000000.index/.log</span><br></pre></table></figure></div><footer class=post-footer><div class=post-tags><a href=/tags/KafKa/ rel=tag># KafKa</a><a href=/tags/KafKa%E5%8E%9F%E7%90%86/ rel=tag># KafKa原理</a></div><div class=post-nav><div class=post-nav-item><a href=/2024/08/21/JVM%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93/ rel=prev title=Java系列-JVM> <i class="fa fa-angle-left"></i> Java系列-JVM </a></div><div class=post-nav-item><a href=/2024/08/21/KafKa%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8/ rel=next title=Kafka系列-KafKa基础应用> Kafka系列-KafKa基础应用 <i class="fa fa-angle-right"></i> </a></div></div></footer></article></div></div></main><footer class=footer><div class=footer-inner><div class=copyright>© <span itemprop=copyrightYear>2024</span><span class=with-love> <i class="fa fa-heart"></i> </span><span class=author itemprop=copyrightHolder>豪哥</span></div></div></footer><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span><span class=toggle-line></span><span class=toggle-line></span></div><div class=sidebar-dimmer></div><div aria-label=返回顶部 class=back-to-top role=button><i class="fa fa-arrow-up fa-lg"></i><span>0%</span></div><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><script crossorigin=anonymous integrity=sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY= src=https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js></script><script src=/js/comments.js></script><script src=/js/utils.js></script><script src=/js/motion.js></script><script src=/js/sidebar.js></script><script src=/js/next-boot.js></script><script crossorigin=anonymous integrity=sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc= src=https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js></script><script src=/js/third-party/search/local-search.js></script>