<!doctypehtml><html lang=zh-CN><meta charset=UTF-8><meta content=width=device-width name=viewport><meta media="(prefers-color-scheme: light)" content=#222 name=theme-color><meta media="(prefers-color-scheme: dark)" content=#222 name=theme-color><meta content="Hexo 7.3.0" name=generator><link href=/images/apple-touch-icon-next.png rel=apple-touch-icon sizes=180x180><link href=/images/favicon-32x32-next.png rel=icon sizes=32x32 type=image/png><link href=/images/favicon-16x16-next.png rel=icon sizes=16x16 type=image/png><link color=#222 href=/images/logo.svg rel=mask-icon><link href=/css/main.css rel=stylesheet><link crossorigin=anonymous href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css integrity=sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA= rel=stylesheet><link crossorigin=anonymous href=https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css integrity=sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE= rel=stylesheet><script class=next-config data-name=main type=application/json>{"hostname":"hgprivate.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script src=/js/config.js></script><meta content="1、概述1.1、何为Zookeeper官方文档解释：Zookeeper是一个分布式服务框架，是Apache Hadoop 的一个子项目，主要用来解决分布式应用中经常遇到的一些数据管理问题，如：统一命名服务、状态同步服务、集群管理、分布式应用配置项管理等。 简单来说，zookeeper = 文件系统 + 监听通知机制。 1.2、使用场景zookeeper可实现 分布式应用配置管理、统一命名" name=description><meta content=article property=og:type><meta content=Zookeeper系列-Zookeeper基础应用 property=og:title><meta content=https://hgprivate.github.io/2024/08/21/Zookeeper%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8/index.html property=og:url><meta content=豪哥博客 property=og:site_name><meta content="1、概述1.1、何为Zookeeper官方文档解释：Zookeeper是一个分布式服务框架，是Apache Hadoop 的一个子项目，主要用来解决分布式应用中经常遇到的一些数据管理问题，如：统一命名服务、状态同步服务、集群管理、分布式应用配置项管理等。 简单来说，zookeeper = 文件系统 + 监听通知机制。 1.2、使用场景zookeeper可实现 分布式应用配置管理、统一命名" property=og:description><meta content=zh_CN property=og:locale><meta content=2024-08-21T13:39:14.874Z property=article:published_time><meta content=2023-10-02T09:38:21.683Z property=article:modified_time><meta content=豪哥 property=article:author><meta content=Zookeeper property=article:tag><meta content=Zookeeper基础 property=article:tag><meta content=summary name=twitter:card><link href=https://hgprivate.github.io/2024/08/21/Zookeeper%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8/ rel=canonical><script class=next-config data-name=page type=application/json>{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://hgprivate.github.io/2024/08/21/Zookeeper%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8/","path":"2024/08/21/Zookeeper基础入门/","title":"Zookeeper系列-Zookeeper基础应用"}</script><script class=next-config data-name=calendar type=application/json>""</script><title>Zookeeper系列-Zookeeper基础应用 | 豪哥博客</title><noscript><link href=/css/noscript.css rel=stylesheet></noscript><body class=use-motion itemscope itemtype=http://schema.org/WebPage><div class=headband></div><main class=main><div class=column><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=site-brand-container><div class=site-nav-toggle><div aria-label=切换导航栏 class=toggle role=button><span class=toggle-line></span><span class=toggle-line></span><span class=toggle-line></span></div></div><div class=site-meta><a class=brand href=/ rel=start> <i class=logo-line></i> <p class=site-title>豪哥博客</p> <i class=logo-line></i> </a><p class=site-subtitle itemprop=description>豪哥博客</div><div class=site-nav-right><div class="toggle popup-trigger" aria-label=搜索 role=button><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ rel=section><i class="fa fa-home fa-fw"></i>首页</a><li class="menu-item menu-item-tags"><a href=/tags/ rel=section><i class="fa fa-tags fa-fw"></i>标签</a><li class="menu-item menu-item-categories"><a href=/categories/ rel=section><i class="fa fa-th fa-fw"></i>分类</a><li class="menu-item menu-item-archives"><a href=/archives/ rel=section><i class="fa fa-archive fa-fw"></i>归档</a><li class="menu-item menu-item-search"><a class=popup-trigger role=button><i class="fa fa-search fa-fw"></i>搜索 </a></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon> <i class="fa fa-search"></i> </span><div class=search-input-container><input autocapitalize=off autocomplete=off class=search-input maxlength=80 placeholder=搜索... spellcheck=false type=search></div><span class=popup-btn-close role=button> <i class="fa fa-times-circle"></i> </span></div><div class=search-result-container><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></header><aside class=sidebar><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录<li class=sidebar-nav-overview>站点概览</ul><div class=sidebar-panel-container><!--noindex--><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class=nav><li class="nav-item nav-level-1"><a class=nav-link href=#1%E3%80%81%E6%A6%82%E8%BF%B0><span class=nav-number>1.</span> <span class=nav-text>1、概述</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#1-1%E3%80%81%E4%BD%95%E4%B8%BAZookeeper><span class=nav-number>1.1.</span> <span class=nav-text>1.1、何为Zookeeper</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#1-2%E3%80%81%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF><span class=nav-number>1.2.</span> <span class=nav-text>1.2、使用场景</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#1-3%E3%80%81%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84><span class=nav-number>1.3.</span> <span class=nav-text>1.3、文件系统架构</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#1-4%E3%80%81%E7%9B%91%E5%90%AC%E9%80%9A%E7%9F%A5%E6%9C%BA%E5%88%B6><span class=nav-number>1.4.</span> <span class=nav-text>1.4、监听通知机制</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#1-4-1%E3%80%81%E7%9B%91%E5%90%AC%E6%9C%BA%E5%88%B6%E7%AE%80%E4%BB%8B><span class=nav-number>1.4.1.</span> <span class=nav-text>1.4.1、监听机制简介</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#1-4-2%E3%80%81watcher%E7%89%B9%E6%80%A7><span class=nav-number>1.4.2.</span> <span class=nav-text>1.4.2、watcher特性</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#1-4-3%E3%80%81%E6%B3%A8%E5%86%8C%E4%BA%8B%E4%BB%B6%E6%9C%BA%E5%88%B6><span class=nav-number>1.4.3.</span> <span class=nav-text>1.4.3、注册事件机制</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#1-4-4%E3%80%81watcher%E4%BA%8B%E4%BB%B6%E7%B1%BB%E5%9E%8B><span class=nav-number>1.4.4.</span> <span class=nav-text>1.4.4、watcher事件类型</span></a></ol></ol><li class="nav-item nav-level-1"><a class=nav-link href=#3%E3%80%81Zookeeper%E5%8D%95%E6%9C%BA%E5%AE%89%E8%A3%85><span class=nav-number>2.</span> <span class=nav-text>3、Zookeeper单机安装</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#3-1%E3%80%81zookeeper%E5%90%AF%E5%8A%A8><span class=nav-number>2.1.</span> <span class=nav-text>3.1、zookeeper启动</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#3-2%E3%80%81zookeeper%E4%BD%BF%E7%94%A8><span class=nav-number>2.2.</span> <span class=nav-text>3.2、zookeeper使用</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#3-2-1%E3%80%81%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%91%BD%E4%BB%A4%E6%93%8D%E4%BD%9C><span class=nav-number>2.2.1.</span> <span class=nav-text>3.2.1、客户端命令操作</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#3-2-1-1%E3%80%81ls%E5%91%BD%E4%BB%A4><span class=nav-number>2.2.1.1.</span> <span class=nav-text>3.2.1.1、ls命令</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#3-2-1-2%E3%80%81ls2%E5%91%BD%E4%BB%A4><span class=nav-number>2.2.1.2.</span> <span class=nav-text>3.2.1.2、ls2命令</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#3-2-1-3%E3%80%81get%E5%91%BD%E4%BB%A4><span class=nav-number>2.2.1.3.</span> <span class=nav-text>3.2.1.3、get命令</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#3-2-1-4%E3%80%81stat%E5%91%BD%E4%BB%A4><span class=nav-number>2.2.1.4.</span> <span class=nav-text>3.2.1.4、stat命令</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#3-2-1-5%E3%80%81create%E5%91%BD%E4%BB%A4><span class=nav-number>2.2.1.5.</span> <span class=nav-text>3.2.1.5、create命令</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#3-2-1-6%E3%80%81set%E5%91%BD%E4%BB%A4><span class=nav-number>2.2.1.6.</span> <span class=nav-text>3.2.1.6、set命令</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#3-2-1-7%E3%80%81delete%E5%91%BD%E4%BB%A4><span class=nav-number>2.2.1.7.</span> <span class=nav-text>3.2.1.7、delete命令</span></a></ol><li class="nav-item nav-level-3"><a class=nav-link href=#3-2-2%E3%80%81Java%E6%93%8D%E4%BD%9C><span class=nav-number>2.2.2.</span> <span class=nav-text>3.2.2、Java操作</span></a></ol></ol><li class="nav-item nav-level-1"><a class=nav-link href=#4%E3%80%81%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B><span class=nav-number>3.</span> <span class=nav-text>4、数据类型</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#4-1%E3%80%81%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84><span class=nav-number>3.1.</span> <span class=nav-text>4.1、数据结构</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#4-2%E3%80%81znode%E7%8A%B6%E6%80%81%E5%B1%9E%E6%80%A7><span class=nav-number>3.2.</span> <span class=nav-text>4.2、znode状态属性</span></a></ol><li class="nav-item nav-level-1"><a class=nav-link href=#5%E3%80%81zookeeper-session><span class=nav-number>4.</span> <span class=nav-text>5、zookeeper session</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#5-1%E3%80%81Session%E5%88%9B%E5%BB%BA><span class=nav-number>4.1.</span> <span class=nav-text>5.1、Session创建</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#5-2%E3%80%81Session%E7%8A%B6%E6%80%81><span class=nav-number>4.2.</span> <span class=nav-text>5.2、Session状态</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#5-3%E3%80%81%E4%BC%9A%E8%AF%9D%E8%B6%85%E6%97%B6%E7%AE%A1%E7%90%86><span class=nav-number>4.3.</span> <span class=nav-text>5.3、会话超时管理</span></a></ol><li class="nav-item nav-level-1"><a class=nav-link href=#6%E3%80%81Zookeeper%E5%9B%9B%E5%AD%97%E5%91%BD%E4%BB%A4><span class=nav-number>5.</span> <span class=nav-text>6、Zookeeper四字命令</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#6-1%E3%80%81%E7%AE%80%E4%BB%8B><span class=nav-number>5.1.</span> <span class=nav-text>6.1、简介</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#6-2%E3%80%81%E5%9B%9B%E5%AD%97%E5%91%BD%E4%BB%A4%E4%BD%BF%E7%94%A8><span class=nav-number>5.2.</span> <span class=nav-text>6.2、四字命令使用</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#6-2-1%E3%80%81stat%E5%91%BD%E4%BB%A4><span class=nav-number>5.2.1.</span> <span class=nav-text>6.2.1、stat命令</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#6-2-2%E3%80%81ruok%E5%91%BD%E4%BB%A4><span class=nav-number>5.2.2.</span> <span class=nav-text>6.2.2、ruok命令</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#6-2-3%E3%80%81dump%E5%91%BD%E4%BB%A4><span class=nav-number>5.2.3.</span> <span class=nav-text>6.2.3、dump命令</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#6-2-4%E3%80%81conf%E5%91%BD%E5%90%8D><span class=nav-number>5.2.4.</span> <span class=nav-text>6.2.4、conf命名</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#6-2-5%E3%80%81cons%E5%91%BD%E4%BB%A4><span class=nav-number>5.2.5.</span> <span class=nav-text>6.2.5、cons命令</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#6-2-6%E3%80%81envi%E5%91%BD%E4%BB%A4><span class=nav-number>5.2.6.</span> <span class=nav-text>6.2.6、envi命令</span></a></ol></ol><li class="nav-item nav-level-1"><a class=nav-link href=#7%E3%80%81Zookeeper%E5%AE%89%E5%85%A8%E7%AE%A1%E7%90%86><span class=nav-number>6.</span> <span class=nav-text>7、Zookeeper安全管理</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#7-1%E3%80%81%E5%AE%89%E5%85%A8%E7%AE%80%E4%BB%8B><span class=nav-number>6.1.</span> <span class=nav-text>7.1、安全简介</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#7-2%E3%80%81%E6%9D%83%E9%99%90><span class=nav-number>6.2.</span> <span class=nav-text>7.2、权限</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#7-3%E3%80%81%E6%8E%88%E6%9D%83><span class=nav-number>6.3.</span> <span class=nav-text>7.3、授权</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#7-3-1%E3%80%81%E6%8E%88%E6%9D%83%E6%B5%81%E7%A8%8B><span class=nav-number>6.3.1.</span> <span class=nav-text>7.3.1、授权流程</span></a></ol></ol><li class="nav-item nav-level-1"><a class=nav-link href=#8%E3%80%81Zookeeper%E4%BA%8B%E4%BB%B6%E7%9B%91%E5%90%AC><span class=nav-number>7.</span> <span class=nav-text>8、Zookeeper事件监听</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#8-1%E3%80%81%E7%AE%80%E4%BB%8B><span class=nav-number>7.1.</span> <span class=nav-text>8.1、简介</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#8-2%E3%80%81%E4%BA%8B%E4%BB%B6%E8%A7%A6%E5%8F%91%E7%9B%91%E5%90%AC><span class=nav-number>7.2.</span> <span class=nav-text>8.2、事件触发监听</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#8-2-1%E3%80%81%E4%BA%8B%E4%BB%B6%E8%A7%A6%E5%8F%91><span class=nav-number>7.2.1.</span> <span class=nav-text>8.2.1、事件触发</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#8-2-1-1%E3%80%81%E4%BA%8B%E4%BB%B6%E7%B1%BB%E5%9E%8B><span class=nav-number>7.2.1.1.</span> <span class=nav-text>8.2.1.1、事件类型</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#8-2-1-2%E3%80%81%E7%9B%91%E5%90%AC%E4%BA%8B%E4%BB%B6><span class=nav-number>7.2.1.2.</span> <span class=nav-text>8.2.1.2、监听事件</span></a></ol><li class="nav-item nav-level-3"><a class=nav-link href=#8-2-2%E3%80%81watcher%E6%9C%BA%E5%88%B6><span class=nav-number>7.2.2.</span> <span class=nav-text>8.2.2、watcher机制</span></a></ol></ol></ol></div></div><!--/noindex--><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop=author itemscope itemtype=http://schema.org/Person><img alt=豪哥 class=site-author-image itemprop=image src=/static/imgs/avatar.png><p class=site-author-name itemprop=name>豪哥<div class=site-description itemprop=description>豪哥博客</div></div><div class="site-state-wrap animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/> <span class=site-state-item-count>117</span> <span class=site-state-item-name>日志</span> </a></div><div class="site-state-item site-state-categories"><a href=/categories/> <span class=site-state-item-count>36</span> <span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/> <span class=site-state-item-count>129</span> <span class=site-state-item-name>标签</span></a></div></nav></div></div></div></div></aside></div><div class="main-inner post posts-expand"><div class=post-block><article class=post-content itemscope itemtype=http://schema.org/Article lang=zh-CN><link href=https://hgprivate.github.io/2024/08/21/Zookeeper%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8/ itemprop=mainEntityOfPage><span hidden itemprop=author itemscope itemtype=http://schema.org/Person> <meta content=/static/imgs/avatar.png itemprop=image> <meta content=豪哥 itemprop=name> </span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization> <meta content=豪哥博客 itemprop=name> <meta content=豪哥博客 itemprop=description> </span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork> <meta content="Zookeeper系列-Zookeeper基础应用 | 豪哥博客" itemprop=name> <meta itemprop=description> </span><header class=post-header><h1 itemprop="name headline" class=post-title>Zookeeper系列-Zookeeper基础应用</h1><div class=post-meta-container><div class=post-meta><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar"></i> </span> <span class=post-meta-item-text>发表于</span> <time itemprop="dateCreated datePublished" title="创建时间：2024-08-21 21:39:14" datetime=2024-08-21T21:39:14+08:00>2024-08-21</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar-check"></i> </span> <span class=post-meta-item-text>更新于</span> <time title="修改时间：2023-10-02 17:38:21" datetime=2023-10-02T17:38:21+08:00 itemprop=dateModified>2023-10-02</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-folder"></i> </span> <span class=post-meta-item-text>分类于</span> <span itemprop=about itemscope itemtype=http://schema.org/Thing> <a href=/categories/Zookeeper/ itemprop=url rel=index><span itemprop=name>Zookeeper</span></a> </span> </span></div></div></header><div class=post-body itemprop=articleBody><h1 id=1、概述><a class=headerlink href=#1、概述 title=1、概述></a>1、概述</h1><h2 id=1-1、何为Zookeeper><a class=headerlink href=#1-1、何为Zookeeper title=1.1、何为Zookeeper></a>1.1、何为Zookeeper</h2><p>官方文档解释：<strong>Zookeeper是一个分布式服务框架，是Apache Hadoop 的一个子项目，主要用来解决分布式应用中经常遇到的一些数据管理问题，如：统一命名服务、状态同步服务、集群管理、分布式应用配置项管理等。</strong><p>简单来说，zookeeper = 文件系统 + 监听通知机制。<h2 id=1-2、使用场景><a class=headerlink href=#1-2、使用场景 title=1.2、使用场景></a>1.2、使用场景</h2><p><strong>zookeeper可实现 分布式应用配置管理、统一命名服务、状态同步服务、集群管理等功能。</strong><p>分布式系统中配置信息放入zookeeper中，所有系统都从zookeeper中读取配置信息。当配置信息修改后，<strong>通过 监听触发机制 通知每一个系统 重新读取最新配置。</strong><h2 id=1-3、文件系统架构><a class=headerlink href=#1-3、文件系统架构 title=1.3、文件系统架构></a>1.3、文件系统架构</h2><p>一个Zookeeper内部由一个根目录和多个子目录组成。每个子目录称为 znode，可以自由增加、删除znode，也可在znode中存储数据。<p>znode有四种类型：<ol><li><p><strong>PERSISTENT - 持久化目录节点</strong></p> <p>客户端与zookeeper断开连接后，该节点依旧存在。</p> <p>创建 持久目录节点 命令：</p> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>create /tmp_zk01 data01</span><br></pre></table></figure><li><p><strong>PERSISTENT_SEQUENTIAL - 持久化 顺序编号 目录节点</strong></p> <p>客户端与zookeeper断开连接后，该节点依旧存在，只是Zookeeper给该节点名称进行顺序编号。</p> <p>创建 持久顺序目录节点 命令：</p> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>create -s /tmp_zk01 data01 1</span><br></pre></table></figure> <ul><li>-s：SEQUENTIAL的简写，代表顺序节点。</ul><li><p><strong>EPHEMERAL-临时目录节点</strong></p> <p>客户端与zookeeper断开连接后，该节点被删除。</p> <p>创建 临时目录节点 命令：</p> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>create -e /tmp_zk01 data01</span><br></pre></table></figure> <ul><li>-e：EPHEMERAL的简写，代表临时节点。</ul><li><p><strong>EPHEMERAL_SEQUENTIAL-临时 顺序编号 目录节点</strong></p> <p>客户端与zookeeper断开连接后，该节点被删除，只是Zookeeper给该节点名称进行顺序编号。</p> <p>创建 临时顺序目录节点 命令：</p> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>create -e -s /tmp_zk01 data01</span><br></pre></table></figure></ol><blockquote><p>顺序节点：创建znode时设置顺序标识，znode名称后会附加一个顺序号，顺序号是一个单调递增的计数器，由父节点维护。</blockquote><h2 id=1-4、监听通知机制><a class=headerlink href=#1-4、监听通知机制 title=1.4、监听通知机制></a>1.4、监听通知机制</h2><h3 id=1-4-1、监听机制简介><a class=headerlink href=#1-4-1、监听机制简介 title=1.4.1、监听机制简介></a>1.4.1、监听机制简介</h3><p>Watcher 监听机制是 Zookeeper 中非常重要的特性，节点可以绑定监听事件，比如可以监听<strong>节点数据变更、节点删除、子节点状态变更</strong>等事件，<strong>通过事件机制可以实现分布式锁、集群管理等功能。</strong><h3 id=1-4-2、watcher特性><a class=headerlink href=#1-4-2、watcher特性 title=1.4.2、watcher特性></a>1.4.2、watcher特性</h3><p><strong>当数据发生变化时会触发一个 watcher 事件 并通知客户端。但客户端只会收到一次通知，后续同一节点再次发生变化时客户端将不会再收到消息。不过可以通过循环监听 来达到 永久监听效果。</strong><h3 id=1-4-3、注册事件机制><a class=headerlink href=#1-4-3、注册事件机制 title=1.4.3、注册事件机制></a>1.4.3、注册事件机制</h3><p>ZooKeeper 的 Watcher 机制可分为三个过程：<ol><li>客户端注册 Watcher；<li>服务器处理 Watcher；<li>客户端回调 Watcher；</ol><p>注册 watcher 有 3 种方式：<ol><li><strong>getData</strong><li><strong>exists</strong><li><strong>getChildren</strong></ol><h3 id=1-4-4、watcher事件类型><a class=headerlink href=#1-4-4、watcher事件类型 title=1.4.4、watcher事件类型></a>1.4.4、watcher事件类型</h3><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line>None (-<span class=number>1</span>), 				  <span class=comment>// 客户端连接状态发生变化的时候 会收到none事件</span></span><br><span class=line>NodeCreated (<span class=number>1</span>), 		  <span class=comment>// 节点创建事件</span></span><br><span class=line>NodeDeleted (<span class=number>2</span>), 		  <span class=comment>// 节点删除事件</span></span><br><span class=line>NodeDataChanged (<span class=number>3</span>), 	   <span class=comment>// 节点数据变化</span></span><br><span class=line>NodeChildrenChanged (<span class=number>4</span>);   <span class=comment>// 子节点被创建，删除触发该事件</span></span><br></pre></table></figure><h1 id=3、Zookeeper单机安装><a class=headerlink href=#3、Zookeeper单机安装 title=3、Zookeeper单机安装></a>3、Zookeeper单机安装</h1><h2 id=3-1、zookeeper启动><a class=headerlink href=#3-1、zookeeper启动 title=3.1、zookeeper启动></a>3.1、zookeeper启动</h2><p>1、配置Java环境。<p>2、安装zookeeper。<figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line><span class=comment># cd /usr/local</span></span><br><span class=line><span class=comment># wget http://mirror.bit.edu.cn/apache/zookeeper/stable/zookeeper-3.4.12.tar.gz</span></span><br><span class=line><span class=comment># tar -zxvf zookeeper-3.4.12.tar.gz</span></span><br><span class=line><span class=comment># cd zookeeper-3.4.12</span></span><br></pre></table></figure><p>3、重命名配置文件zoo_sample.cfg。<figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line><span class=comment># cp conf/zoo_sample.cfg conf/zoo.cfg</span></span><br></pre></table></figure><p>4、启动zookeeper。<figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line><span class=comment># bin/zkServer.sh start</span></span><br></pre></table></figure><p>5、检测是否成功启动，用zookeeper客户端连接服务端。<figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line><span class=comment># bin/zkCli.sh</span></span><br></pre></table></figure><h2 id=3-2、zookeeper使用><a class=headerlink href=#3-2、zookeeper使用 title=3.2、zookeeper使用></a>3.2、zookeeper使用</h2><h3 id=3-2-1、客户端命令操作><a class=headerlink href=#3-2-1、客户端命令操作 title=3.2.1、客户端命令操作></a>3.2.1、客户端命令操作</h3><h4 id=3-2-1-1、ls命令><a class=headerlink href=#3-2-1-1、ls命令 title=3.2.1.1、ls命令></a>3.2.1.1、ls命令</h4><p>作用：查看某个路径下目录列表。<p>命令格式如下：<figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line><span class=built_in>ls</span> path</span><br></pre></table></figure><p>path代表路径，查看/runoob节点示例：<figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line><span class=built_in>ls</span> /runoob</span><br></pre></table></figure><h4 id=3-2-1-2、ls2命令><a class=headerlink href=#3-2-1-2、ls2命令 title=3.2.1.2、ls2命令></a>3.2.1.2、ls2命令</h4><p>作用：查看某个路径下的目录列表，它比ls命令列出更多信息。用法和<code>ls</code>命令相同。<h4 id=3-2-1-3、get命令><a class=headerlink href=#3-2-1-3、get命令 title=3.2.1.3、get命令></a>3.2.1.3、get命令</h4><p>作用：获取节点数据和状态信息。<p>命令格式及示例如下：<figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line><span class=comment># 格式：</span></span><br><span class=line>get path [watch]</span><br><span class=line><span class=comment># 示例：</span></span><br><span class=line>get /runoob watch</span><br></pre></table></figure><ul><li>path：代表路径。<li>watch：对节点进行事件监听。</ul><h4 id=3-2-1-4、stat命令><a class=headerlink href=#3-2-1-4、stat命令 title=3.2.1.4、stat命令></a>3.2.1.4、stat命令</h4><p>作用：查看节点状态信息。<p>命令格式及示例如下：<figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line><span class=comment># 格式：</span></span><br><span class=line><span class=built_in>stat</span> path [watch]</span><br><span class=line><span class=comment># 示例：</span></span><br><span class=line><span class=built_in>stat</span> /runoob</span><br></pre></table></figure><ul><li>path：代表路径。<li>watch：对节点进行事件监听。</ul><h4 id=3-2-1-5、create命令><a class=headerlink href=#3-2-1-5、create命令 title=3.2.1.5、create命令></a>3.2.1.5、create命令</h4><p>作用：创建节点并赋值。<p>命令格式及示例如下：<figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line><span class=comment># 格式</span></span><br><span class=line>create [-s] [-e] path data acl</span><br><span class=line><span class=comment># 示例（添加临时顺序节点）</span></span><br><span class=line>create -s -e /runoob 0</span><br></pre></table></figure><ul><li>[-s] [-e]：两者都是可选项。-s代表顺序节点，-e代表临时节点，两者可同时使用，并且临时节点不能创建子节点。<li>path：指定要创建节点的路径。<li>data：要在此节点存储的数据。<li>acl：访问权限相关，默认是world，相当于全世界都能访问。</ul><h4 id=3-2-1-6、set命令><a class=headerlink href=#3-2-1-6、set命令 title=3.2.1.6、set命令></a>3.2.1.6、set命令</h4><p>作用：修改节点数据。<p>命令格式及示例如下：<figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre><td class=code><pre><span class=line><span class=comment># 格式</span></span><br><span class=line><span class=built_in>set</span> path data [version]</span><br><span class=line><span class=comment># 示例（只有正确的版本号才能设置成功）</span></span><br><span class=line><span class=built_in>set</span> /runoob 0 1</span><br><span class=line><span class=built_in>set</span> /runoob 0 2</span><br><span class=line><span class=built_in>set</span> /runoob 0 10</span><br><span class=line><span class=built_in>set</span> /runoob 0 6</span><br></pre></table></figure><ul><li>path：节点路径。<li>data：要存储的数据。<li>[version]：可选项，版本号（可用于乐观锁）。</ul><h4 id=3-2-1-7、delete命令><a class=headerlink href=#3-2-1-7、delete命令 title=3.2.1.7、delete命令></a>3.2.1.7、delete命令</h4><p>作用：删除某节点。<p>命令格式及示例如下：<figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre><td class=code><pre><span class=line><span class=comment># 格式</span></span><br><span class=line>delete path [version]</span><br><span class=line><span class=comment># 示例</span></span><br><span class=line><span class=built_in>ls</span> /runoob</span><br><span class=line>delete /runoob/child</span><br><span class=line>get /runoob/child</span><br></pre></table></figure><ul><li>path：节点路径。<li>[version]：可选项，版本号（同set命令）。</ul><h3 id=3-2-2、Java操作><a class=headerlink href=#3-2-2、Java操作 title=3.2.2、Java操作></a>3.2.2、Java操作</h3><p>1、加入Maven依赖<figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line><span class=tag><<span class=name>dependency</span>></span></span><br><span class=line>   <span class=tag><<span class=name>groupId</span>></span>org.apache.zookeeper<span class=tag>&LT/<span class=name>groupId</span>></span></span><br><span class=line>   <span class=tag><<span class=name>artifactId</span>></span>zookeeper<span class=tag>&LT/<span class=name>artifactId</span>></span></span><br><span class=line>   <span class=tag><<span class=name>version</span>></span>3.4.12<span class=tag>&LT/<span class=name>version</span>></span></span><br><span class=line><span class=tag>&LT/<span class=name>dependency</span>></span></span><br></pre></table></figure><p>2、添加一个目录节点<figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>create /test demo01</span><br></pre></table></figure><p>3、启动两个zookeeper客户端程序<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br></pre><td class=code><pre><span class=line><span class=keyword>import</span> java.util.concurrent.CountDownLatch;</span><br><span class=line><span class=keyword>import</span> org.apache.zookeeper.WatchedEvent;</span><br><span class=line><span class=keyword>import</span> org.apache.zookeeper.Watcher;</span><br><span class=line><span class=keyword>import</span> org.apache.zookeeper.Watcher.Event.EventType;</span><br><span class=line><span class=keyword>import</span> org.apache.zookeeper.Watcher.Event.KeeperState;</span><br><span class=line><span class=keyword>import</span> org.apache.zookeeper.ZooKeeper;</span><br><span class=line><span class=keyword>import</span> org.apache.zookeeper.data.Stat;</span><br><span class=line> </span><br><span class=line><span class=keyword>public</span> <span class=keyword>class</span> <span class="title class_">ZooKeeperProSync</span> <span class=keyword>implements</span> <span class="title class_">Watcher</span> {</span><br><span class=line>    <span class=keyword>private</span> <span class=keyword>static</span> <span class=type>CountDownLatch</span> <span class=variable>connectedSemaphore</span> <span class=operator>=</span> <span class=keyword>new</span> <span class="title class_">CountDownLatch</span>(<span class=number>1</span>);</span><br><span class=line>    <span class=keyword>private</span> <span class=keyword>static</span> <span class=type>ZooKeeper</span> <span class=variable>zk</span> <span class=operator>=</span> <span class=literal>null</span>;</span><br><span class=line>    <span class=keyword>private</span> <span class=keyword>static</span> <span class=type>Stat</span> <span class=variable>stat</span> <span class=operator>=</span> <span class=keyword>new</span> <span class="title class_">Stat</span>();</span><br><span class=line> </span><br><span class=line>    <span class=keyword>public</span> <span class=keyword>static</span> <span class=keyword>void</span> <span class="title function_">main</span><span class=params>(String[] args)</span> <span class=keyword>throws</span> Exception {</span><br><span class=line>        <span class=comment>//zookeeper配置数据存放路径</span></span><br><span class=line>        <span class=type>String</span> <span class=variable>path</span> <span class=operator>=</span> <span class=string>"/username"</span>;</span><br><span class=line>        <span class=comment>//连接zookeeper并且注册一个默认的监听器</span></span><br><span class=line>        zk = <span class=keyword>new</span> <span class="title class_">ZooKeeper</span>(<span class=string>"192.168.31.100:2181"</span>, <span class=number>5000</span>, <span class=comment>//</span></span><br><span class=line>                <span class=keyword>new</span> <span class="title class_">ZooKeeperProSync</span>());</span><br><span class=line>        <span class=comment>//等待zk连接成功的通知</span></span><br><span class=line>        connectedSemaphore.await();</span><br><span class=line>        <span class=comment>//获取path目录节点的配置数据，并注册默认的监听器</span></span><br><span class=line>        System.out.println(<span class=keyword>new</span> <span class="title class_">String</span>(zk.getData(path, <span class=literal>true</span>, stat)));</span><br><span class=line> </span><br><span class=line>        Thread.sleep(Integer.MAX_VALUE);</span><br><span class=line>    }</span><br><span class=line> </span><br><span class=line>    <span class=keyword>public</span> <span class=keyword>void</span> <span class="title function_">process</span><span class=params>(WatchedEvent event)</span> {</span><br><span class=line>        <span class=keyword>if</span> (KeeperState.SyncConnected == event.getState()) {  <span class=comment>//zk连接成功通知事件</span></span><br><span class=line>            <span class=keyword>if</span> (EventType.None == event.getType() && <span class=literal>null</span> == event.getPath()) {</span><br><span class=line>                connectedSemaphore.countDown();</span><br><span class=line>            } <span class=keyword>else</span> <span class=keyword>if</span> (event.getType() == EventType.NodeDataChanged) {  <span class=comment>//zk目录节点数据变化通知事件</span></span><br><span class=line>                <span class=keyword>try</span> {</span><br><span class=line>                    System.out.println(<span class=string>"配置已修改，新值为："</span> + <span class=keyword>new</span> <span class="title class_">String</span>(zk.getData(event.getPath(), <span class=literal>true</span>, stat)));</span><br><span class=line>                } <span class=keyword>catch</span> (Exception e) {</span><br><span class=line>                }</span><br><span class=line>            }</span><br><span class=line>        }</span><br><span class=line>    }</span><br><span class=line>}</span><br></pre></table></figure><p>两个程序启动后都读到了<code>/test</code>目录节点下的数据<code>demo01</code>。<p>4、修改test节点下的数据。<figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line><span class=built_in>set</span> /test demo02</span><br></pre></table></figure><p>修改完成后，我们看见两个程序后台都及时收到了他们监听的目录节点数据变更后的值。<h1 id=4、数据类型><a class=headerlink href=#4、数据类型 title=4、数据类型></a>4、数据类型</h1><h2 id=4-1、数据结构><a class=headerlink href=#4-1、数据结构 title=4.1、数据结构></a>4.1、数据结构</h2><p><strong>zookeeper以 key/value 形式存储数据。</strong>整体结构类似于linux文件系统的模式以树形结构存储。其中根路径以<code>/</code>开头。<h2 id=4-2、znode状态属性><a class=headerlink href=#4-2、znode状态属性 title=4.2、znode状态属性></a>4.2、znode状态属性</h2><ol><li><font color=orange>ctime</font>：创建节点的时间。<li><font color=orange>mZxid</font>：最后修改节点时的事务ID。<li><font color=orange>mtime</font>：最后修改节点时的时间。<li><font color=orange>pZxid</font>：鄙视该节点的子节点列表最后以此修改的事务ID，添加子节点或删除子节点就会影响子节点列表，但是修改子节点的数据内容则不影响ID（注意，只有子节点列表变更了才会变更pzxid，子节点内容变更不会影响paxid）。<li><font color=orange>cversion</font>：子节点版本号，子节点每次修改时该版本号加1。<li><font color=orange>dataversion</font>：数据版本号，数据每次修改时该版本号加1，<li><font color=orange>aclversion</font>：权限版本号，权限每次修改时该版本号加1。<li><font color=orange>ephemeralOwner</font>：创建该临时节点的会话的sessionID。（如果该节点为持久节点，那么这个属性值为0。）<li><font color=orange>dataLength</font>：节点数据长度。<li><font color=orange>numChildren</font>：该节点拥有子节点数量。（只统计第一级子节点的数量）</ol><h1 id=5、zookeeper-session><a title="5、zookeeper session" class=headerlink href=#5、zookeeper-session></a>5、zookeeper session</h1><p><strong>客户端与服务端之间的连接是基于 TCP长连接，默认端口2181。第一次连接建立后，每个会话都可设置超时时间。</strong><h2 id=5-1、Session创建><a class=headerlink href=#5-1、Session创建 title=5.1、Session创建></a>5.1、Session创建</h2><ul><li><p>sessionID</p> <p>会话ID，用来唯一标识一个会话，每次客户端创建会话时，zookeeper都会为其分配一个全局唯一的sessionID。zookeeper创建sessionID类SessionTrackerImpl中的源码。</p><li><p>Timeout</p> <p>会话超时时间。客户端在构造Zookeeper实例时，向服务端发送配置的超时时间，server端会根据自己的超时时间限制最终确认会话的超时时间。</p><li><p>TickTime</p> <p>下次会话超时时间点，默认2000毫秒。可在zoo.cfg配置文件中进行配置，便于server端对session会话实行分桶策略管理。</p><li><p>isClosing</p> <p>该属性标记一个会话是否已经被关闭，当server端检测到会话已经超时失效，该会话标记为“已关闭”，不再处理该会话的新请求。</p></ul><h2 id=5-2、Session状态><a class=headerlink href=#5-2、Session状态 title=5.2、Session状态></a>5.2、Session状态</h2><ul><li><p>connecting</p> <p>连接中，session一旦建立，状态就是connecting状态，时间短。</p><li><p>connected</p> <p>已连接，连接成功之后的状态。</p><li><p>closed</p> <p>已关闭，session过期，因 网络故障 客户端重连失败，服务器宕机 或 客户端主动断开。</p></ul><h2 id=5-3、会话超时管理><a class=headerlink href=#5-3、会话超时管理 title=5.3、会话超时管理></a>5.3、会话超时管理</h2><p>zookeeper的 leader服务器 在运行期间会定时执行会话超时检查，时间间隔是<code>ExpirationInterval</code>，单位是毫秒，默认值为<code>tickTime</code>，每隔<code>tickTime</code>进行一次会话超时检查。<p><code>ExpirationTime</code>计算方式：<figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line><span class=attr>ExpirationTime</span> = <span class=string>CurrentTime + SessionTimeout;</span></span><br><span class=line><span class=attr>ExpirationTime</span> = <span class=string>(ExpirationTime / ExpirationInterval + 1) * ExpirationInterval;</span></span><br></pre></table></figure><p>客户端在会话超时前向服务器发送请求来完成 会话激活，进而保持会话有效性。<h1 id=6、Zookeeper四字命令><a class=headerlink href=#6、Zookeeper四字命令 title=6、Zookeeper四字命令></a>6、Zookeeper四字命令</h1><h2 id=6-1、简介><a class=headerlink href=#6-1、简介 title=6.1、简介></a>6.1、简介</h2><p><strong>在客户端可以通过<code>telnet</code>或<code>nc（netcat）</code>向 zookeeper 提交命令。</strong><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line><span class=comment># centos</span></span><br><span class=line>yum install nc</span><br><span class=line><span class=comment># ubuntu</span></span><br><span class=line><span class=built_in>sudo</span> apt install netcat</span><br></pre></table></figure><p><strong>四字命令格式：</strong><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line><span class=built_in>echo</span> [<span class=built_in>command</span>] | nc [ip] [port]</span><br></pre></table></figure><p><strong>常用四字命令如下：</strong><ol><li>conf：3.3.0版本引入，打印服务相关配置的详细信息。<li>cons：3.3.0版本引入，列出所有连接到这台服务器的客户端全部连接/会话详细信息。包括“接收/发送”的包数量、会话ID、操作延迟、最后的操作执行等信息。<li>crst：3.3.0版本引入。重置所有连接的连接和会话统计信息。<li>dump：列出那些比较重要的会话和临时节点。该命令只限于leader节点上使用。<li>envi：打印出服务环境的详细信息。<li>reqs：列出未经处理的请求。<li>ruok：测试服务是否处于正确状态。如果确实如此，那么服务返回“imok”，否则不做任何响应。<li>stat：输入关于性能和连接的客户端的列表。<li>srst：重置服务器的统计。<li>srvr：3.3.0版本引入。列出连接服务器的详细信息。<li>wchs：3.3.0版本引入。列出服务器watch的详细信息。<li>wchc：3.3.0版本引入。通过session列出服务器watch的详细信息，它的输出是一个与watch相关的会话的列表。<li>wchp：3.3.0版本引入。通过路径列出服务器watch的详细i信息。它输出一个与session相关的路径。<li>mntr：3.4.0版本引入，输出可用于检测集群健康状态的变量列表。</ol><h2 id=6-2、四字命令使用><a class=headerlink href=#6-2、四字命令使用 title=6.2、四字命令使用></a>6.2、四字命令使用</h2><h3 id=6-2-1、stat命令><a class=headerlink href=#6-2-1、stat命令 title=6.2.1、stat命令></a>6.2.1、stat命令</h3><p>查看zk状态信息。<figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line><span class=built_in>echo</span> <span class=built_in>stat</span> | nc 192.168.3.38 2181</span><br></pre></table></figure><h3 id=6-2-2、ruok命令><a class=headerlink href=#6-2-2、ruok命令 title=6.2.2、ruok命令></a>6.2.2、ruok命令</h3><p>查看zk是否启动，若返回imok表示正常。<figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line><span class=built_in>echo</span> ruok | nc 192.168.3.38 2181</span><br></pre></table></figure><h3 id=6-2-3、dump命令><a class=headerlink href=#6-2-3、dump命令 title=6.2.3、dump命令></a>6.2.3、dump命令</h3><p>列出未经处理的会话和临时节点。<figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line><span class=built_in>echo</span> dump | nc 192.168.3.38 2181</span><br></pre></table></figure><h3 id=6-2-4、conf命名><a class=headerlink href=#6-2-4、conf命名 title=6.2.4、conf命名></a>6.2.4、conf命名</h3><p>查看服务器配置。<figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line><span class=built_in>echo</span> conf | nc 192.168.3.38 2181</span><br></pre></table></figure><h3 id=6-2-5、cons命令><a class=headerlink href=#6-2-5、cons命令 title=6.2.5、cons命令></a>6.2.5、cons命令</h3><p>展示连接到服务器的客户端信息。<figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line><span class=built_in>echo</span> cons | nc 192.168.3.38 2181</span><br></pre></table></figure><h3 id=6-2-6、envi命令><a class=headerlink href=#6-2-6、envi命令 title=6.2.6、envi命令></a>6.2.6、envi命令</h3><p>查看环境变量。<figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line><span class=built_in>echo</span> envi | nc 192.168.3.38 2181</span><br></pre></table></figure><h1 id=7、Zookeeper安全管理><a class=headerlink href=#7、Zookeeper安全管理 title=7、Zookeeper安全管理></a>7、Zookeeper安全管理</h1><h2 id=7-1、安全简介><a class=headerlink href=#7-1、安全简介 title=7.1、安全简介></a>7.1、安全简介</h2><p><strong>ZooKeeper节点有5种操作权限：CREATE(增)、READ(查)、WRITE(改)、DELETE(删)、ADMIN(管理)等权限，这5种权限可以简写为crwda，每个单词的首字符拼接而成。</strong><h2 id=7-2、权限><a class=headerlink href=#7-2、权限 title=7.2、权限></a>7.2、权限</h2><p><strong>Zookeeper 权限由 scheme : id : permissions 三部分组成。</strong><p>Scheme可选项：<ul><li><strong>world</strong>：默认模式，所有客户端都拥有指定的权限。world 下只有一个 id 选项，就是 anyone，通常组合写法为 <code>world:anyone:[permissons]</code>；<li><strong>auth</strong>：只有经过认证的用户才拥有指定的权限。通常组合写法为 <code>auth:user:password:[permissons]</code>，使用这种模式时，你需要先进行登录，之后采用 auth 模式设置权限时，<code>user</code> 和 <code>password</code> 都将使用登录的用户名和密码；<li><strong>digest</strong>：只有经过认证的用户才拥有指定的权限。通常组合写法为 <code>auth:user:BASE64(SHA1(password)):[permissons]</code>，这种形式下的密码必须通过 SHA1 和 BASE64 进行双重加密；<li><strong>ip</strong>：限制只有特定 IP 的客户端才拥有指定的权限。通常组成写法为 <code>ip:182.168.0.168:[permissions]</code>；<li><strong>super</strong>：代表超级管理员，拥有所有的权限，需要修改 Zookeeper 启动脚本进行配置。</ul><p>Permissions可选项：<ul><li><strong>CREATE</strong>：允许创建子节点；<li><strong>READ</strong>：允许从节点获取数据并列出其子节点；<li><strong>WRITE</strong>：允许为节点设置数据；<li><strong>DELETE</strong>：允许删除子节点；<li><strong>ADMIN</strong>：允许为节点设置权限。</ul><h2 id=7-3、授权><a class=headerlink href=#7-3、授权 title=7.3、授权></a>7.3、授权</h2><h3 id=7-3-1、授权流程><a class=headerlink href=#7-3-1、授权流程 title=7.3.1、授权流程></a>7.3.1、授权流程</h3><p>操作流程分析如下：<p>1）添加授权用户。<figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>addauth digest smile:123456</span><br></pre></table></figure><p>2）创建节点。<figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>create /cicada cicada</span><br></pre></table></figure><p>3）节点授权。<figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>setAcl /cicada auth:smile:123456:cdrwa</span><br></pre></table></figure><p>4）查看授权。<figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>getAcl /cicada</span><br></pre></table></figure><h1 id=8、Zookeeper事件监听><a class=headerlink href=#8、Zookeeper事件监听 title=8、Zookeeper事件监听></a>8、Zookeeper事件监听</h1><h2 id=8-1、简介><a class=headerlink href=#8-1、简介 title=8.1、简介></a>8.1、简介</h2><p><strong>接口类<code>Watcher</code>表示一个事件处理器，定义了事件通知相关逻辑，包含<code>KeeperState</code>和<code>EventType</code>两个枚举类。</strong><p>Watcher接口定义了事件回调方法 <code>process(WatchedEvent event)</code>。定义一个Watcher实例很简单，代码如下：<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre><td class=code><pre><span class=line><span class=type>Watcher</span> <span class=variable>w</span> <span class=operator>=</span> <span class=keyword>new</span> <span class="title class_">Watcher</span>() {</span><br><span class=line>    <span class=meta>@Override</span></span><br><span class=line>    <span class=keyword>public</span> <span class=keyword>void</span> <span class="title function_">process</span><span class=params>(WatchedEvent watchedEvent)</span> {</span><br><span class=line>        log.info(<span class=string>"监听器watchedEvent："</span> + watchedEvent);</span><br><span class=line>    }</span><br><span class=line>};</span><br></pre></table></figure><p>使用Watcher监听器很简单，在Curator调用链上使用<code>usingWatcher</code>方法即可，代码如下：<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line><span class=type>byte</span>[] content = client.getData().usingWatcher(w).forPath(workerPath);</span><br></pre></table></figure><h2 id=8-2、事件触发监听><a class=headerlink href=#8-2、事件触发监听 title=8.2、事件触发监听></a>8.2、事件触发监听</h2><h3 id=8-2-1、事件触发><a class=headerlink href=#8-2-1、事件触发 title=8.2.1、事件触发></a>8.2.1、事件触发</h3><h4 id=8-2-1-1、事件类型><a class=headerlink href=#8-2-1-1、事件类型 title=8.2.1.1、事件类型></a>8.2.1.1、事件类型</h4><ul><li>节点创建（NodeCreated）<li>节点删除（NodeDeleted）<li>节点数据变化（NodeDateChanged）<li>子节点变化（NodeChildrenChanged）</ul><h4 id=8-2-1-2、监听事件><a class=headerlink href=#8-2-1-2、监听事件 title=8.2.1.2、监听事件></a>8.2.1.2、监听事件</h4><p><font color=red>注意：事件监听是一次性的。</font><p>（1）监听节点创建、删除。<figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line><span class=comment># 监听节点 /test，当节点 /test 创建或删除时会通知。</span></span><br><span class=line><span class=comment># java API：exists()</span></span><br><span class=line><span class=built_in>stat</span> -w /test</span><br></pre></table></figure><p>（2）监听节点数据变化<figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line><span class=comment># 监听节点 /test 的数据变化，当节点 /test 的数据发生变化时会通知。</span></span><br><span class=line><span class=comment># java API：get()</span></span><br><span class=line>get -w /test</span><br></pre></table></figure><p>（3）监听子节点变化<figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line><span class=comment># 监听节点 /test 的子节点是否发生变化，当节点 /test 的子节点发生变化时会通知。</span></span><br><span class=line><span class=comment># java API：getChildren()</span></span><br><span class=line><span class=built_in>ls</span> -w /test</span><br></pre></table></figure><h3 id=8-2-2、watcher机制><a class=headerlink href=#8-2-2、watcher机制 title=8.2.2、watcher机制></a>8.2.2、watcher机制</h3><p>zookeeper 的 watcher 机制，可分为四个过程：<ol><li><p>客户端注册 watcher；客户端注册watcher有3种方式：getData、exists、getCildren。</p><li><p>服务端处理 watcher；</p><li><p>服务端触发 watcher 事件；</p><li><p>客户端回调 watcher；</p></ol><p>以exists注册方式为例，客户端注册事件并触发事件通知的流程分析如下：<ol><li><p>客户端 发送 事件通知请求；</p> <p>调用 exists 方法会把事件监听封装到 request 对象中，watch 属性设置为 true，待服务端返回 response 后把监听事件封装到客户端类<code>ZKWatchManager</code>中。</p><li><p>服务端 处理 watcher事件请求；</p> <ol><li>服务端<code>NIOServerCnxn</code>类用来处理客户端请求，最终调用<code>FinalRequestProcessor</code>。<li>在类<code>DataTree</code>方法中添加 watcher 事件，并保存至<code>WatchManager</code>的<code>watchTable</code>与<code>watchTable</code>中。</ol><li><p>服务端 触发 watcher事件；</p> <ol><li>若服务端某个被监听的节点发生事务请求，服务端处理请求时调用<code>FinalRequestProcessor</code>类<code>processRequest</code>方法。<li>删除调用链最终到 DataTree 类中删除节点分支的触发代码段。<li>进入 WatchManager 类的 triggerWatch 方法。<li>构建了一个 xid 为 -1，zxid 为 -1 的 ReplyHeader 对象，然后再调用 sendResponse 方法。</ol><li><p>客户端 回调 watcher事件；</p> <p>客户端类<code>SendThread</code>的<code>readResponse</code>方法接收服务端触发的事件通知，进入 xid 为 -1 流程，处理 Event 事件。</p></ol></div><footer class=post-footer><div class=post-tags><a href=/tags/Zookeeper/ rel=tag># Zookeeper</a><a href=/tags/Zookeeper%E5%9F%BA%E7%A1%80/ rel=tag># Zookeeper基础</a></div><div class=post-nav><div class=post-nav-item><a href=/2024/08/21/Tomcat%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/ rel=prev title=Tomcat系列-Tomcat原理解析> <i class="fa fa-angle-left"></i> Tomcat系列-Tomcat原理解析 </a></div><div class=post-nav-item><a href=/2024/08/21/%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/ rel=next title=计算机系列-磁盘管理> 计算机系列-磁盘管理 <i class="fa fa-angle-right"></i> </a></div></div></footer></article></div></div></main><footer class=footer><div class=footer-inner><div class=copyright>© <span itemprop=copyrightYear>2024</span><span class=with-love> <i class="fa fa-heart"></i> </span><span class=author itemprop=copyrightHolder>豪哥</span></div></div></footer><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span><span class=toggle-line></span><span class=toggle-line></span></div><div class=sidebar-dimmer></div><div aria-label=返回顶部 class=back-to-top role=button><i class="fa fa-arrow-up fa-lg"></i><span>0%</span></div><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><script crossorigin=anonymous integrity=sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY= src=https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js></script><script src=/js/comments.js></script><script src=/js/utils.js></script><script src=/js/motion.js></script><script src=/js/sidebar.js></script><script src=/js/next-boot.js></script><script crossorigin=anonymous integrity=sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc= src=https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js></script><script src=/js/third-party/search/local-search.js></script>