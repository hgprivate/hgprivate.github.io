<!doctypehtml><html lang=zh-CN><meta charset=UTF-8><meta content=width=device-width name=viewport><meta media="(prefers-color-scheme: light)" content=#222 name=theme-color><meta media="(prefers-color-scheme: dark)" content=#222 name=theme-color><meta content="Hexo 7.3.0" name=generator><link href=/images/apple-touch-icon-next.png rel=apple-touch-icon sizes=180x180><link href=/images/favicon-32x32-next.png rel=icon sizes=32x32 type=image/png><link href=/images/favicon-16x16-next.png rel=icon sizes=16x16 type=image/png><link color=#222 href=/images/logo.svg rel=mask-icon><link href=/css/main.css rel=stylesheet><link crossorigin=anonymous href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css integrity=sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA= rel=stylesheet><link crossorigin=anonymous href=https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css integrity=sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE= rel=stylesheet><script class=next-config data-name=main type=application/json>{"hostname":"hgprivate.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script src=/js/config.js></script><meta content=豪哥博客 name=description><meta content=website property=og:type><meta content=豪哥博客 property=og:title><meta content=https://hgprivate.github.io/page/7/index.html property=og:url><meta content=豪哥博客 property=og:site_name><meta content=豪哥博客 property=og:description><meta content=zh_CN property=og:locale><meta content=豪哥 property=article:author><meta content=HG property=article:tag><meta content=summary name=twitter:card><link href=https://hgprivate.github.io/page/7/ rel=canonical><script class=next-config data-name=page type=application/json>{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/7/index.html","title":""}</script><script class=next-config data-name=calendar type=application/json>""</script><title>豪哥博客</title><noscript><link href=/css/noscript.css rel=stylesheet></noscript><body class=use-motion itemscope itemtype=http://schema.org/WebPage><div class=headband></div><main class=main><div class=column><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=site-brand-container><div class=site-nav-toggle><div aria-label=切换导航栏 class=toggle role=button><span class=toggle-line></span><span class=toggle-line></span><span class=toggle-line></span></div></div><div class=site-meta><a class=brand href=/ rel=start> <i class=logo-line></i> <h1 class=site-title>豪哥博客</h1> <i class=logo-line></i> </a><p class=site-subtitle itemprop=description>豪哥博客</div><div class=site-nav-right><div class="toggle popup-trigger" aria-label=搜索 role=button><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ rel=section><i class="fa fa-home fa-fw"></i>首页</a><li class="menu-item menu-item-tags"><a href=/tags/ rel=section><i class="fa fa-tags fa-fw"></i>标签</a><li class="menu-item menu-item-categories"><a href=/categories/ rel=section><i class="fa fa-th fa-fw"></i>分类</a><li class="menu-item menu-item-archives"><a href=/archives/ rel=section><i class="fa fa-archive fa-fw"></i>归档</a><li class="menu-item menu-item-search"><a class=popup-trigger role=button><i class="fa fa-search fa-fw"></i>搜索 </a></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon> <i class="fa fa-search"></i> </span><div class=search-input-container><input autocapitalize=off autocomplete=off class=search-input maxlength=80 placeholder=搜索... spellcheck=false type=search></div><span class=popup-btn-close role=button> <i class="fa fa-times-circle"></i> </span></div><div class=search-result-container><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></header><aside class=sidebar><div class="sidebar-inner sidebar-overview-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录<li class=sidebar-nav-overview>站点概览</ul><div class=sidebar-panel-container><!--noindex--><div class="post-toc-wrap sidebar-panel"></div><!--/noindex--><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop=author itemscope itemtype=http://schema.org/Person><img alt=豪哥 class=site-author-image itemprop=image src=/static/imgs/avatar.png><p class=site-author-name itemprop=name>豪哥<div class=site-description itemprop=description>豪哥博客</div></div><div class="site-state-wrap animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/> <span class=site-state-item-count>116</span> <span class=site-state-item-name>日志</span> </a></div><div class="site-state-item site-state-categories"><a href=/categories/> <span class=site-state-item-count>36</span> <span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/> <span class=site-state-item-count>129</span> <span class=site-state-item-name>标签</span></a></div></nav></div></div></div></div></aside></div><div class="main-inner index posts-expand"><div class=post-block><article class=post-content itemscope itemtype=http://schema.org/Article><link href=https://hgprivate.github.io/2024/08/21/Nacos%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/ itemprop=mainEntityOfPage><span hidden itemprop=author itemscope itemtype=http://schema.org/Person> <meta content=/static/imgs/avatar.png itemprop=image> <meta content=豪哥 itemprop=name> </span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization> <meta content=豪哥博客 itemprop=name> <meta content=豪哥博客 itemprop=description> </span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork> <meta content="undefined | 豪哥博客" itemprop=name> <meta itemprop=description> </span><header class=post-header><h2 itemprop="name headline" class=post-title><a class=post-title-link href=/2024/08/21/Nacos%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/ itemprop=url>Nacos系列-Nacos原理解析</a></h2><div class=post-meta-container><div class=post-meta><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar"></i> </span> <span class=post-meta-item-text>发表于</span> <time itemprop="dateCreated datePublished" title="创建时间：2024-08-21 21:39:14" datetime=2024-08-21T21:39:14+08:00>2024-08-21</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar-check"></i> </span> <span class=post-meta-item-text>更新于</span> <time title="修改时间：2023-10-02 15:52:48" datetime=2023-10-02T15:52:48+08:00 itemprop=dateModified>2023-10-02</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-folder"></i> </span> <span class=post-meta-item-text>分类于</span> <span itemprop=about itemscope itemtype=http://schema.org/Thing> <a href=/categories/Nacos/ itemprop=url rel=index><span itemprop=name>Nacos</span></a> </span> </span></div></div></header><div class=post-body itemprop=articleBody><h1 id=1、服务注册><a class=headerlink href=#1、服务注册 title=1、服务注册></a>1、服务注册</h1><h2 id=1-1、客户端><a class=headerlink href=#1-1、客户端 title=1.1、客户端></a>1.1、客户端</h2><figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br></pre><td class=code><pre><span class=line>- SPring启动时 加载 自动配置类 NacosServiceRegistryAutoConfiguration</span><br><span class=line>- 注入 return new NacosAutoServiceRegistration(...)</span><br><span class=line>	- 其父类 AbstractAutoServiceRegistration 也被初始化了</span><br><span class=line>		- 实现了ApplicationListener接口，监听Spring容器启动过程中的事件</span><br><span class=line>		- 监听到 WebServerInitializedEvent（web服务初始化完成）的事件后，开启服务注册流程。</span><br><span class=line>			1、发布开始注册的事件</span><br><span class=line>			2、开始注册：register();</span><br><span class=line>			3、发布注册完成事件</span><br><span class=line>			4、服务状态设置为运行状态。</span><br><span class=line></span><br><span class=line>- 开始注册：register();</span><br><span class=line>- NacosServiceRegistry.register(Registration registration);</span><br><span class=line>	`NacosServiceRegistry`是Spring的`ServiceRegistry`接口的实现类，</span><br><span class=line>	而ServiceRegistry接口是服务注册、发现的规约接口，定义了register、</span><br><span class=line>	deregister等方法的声明。</span><br><span class=line>- NamingService.registerInstance(serviceId, group, instance);</span><br><span class=line>	NamingService接口的默认实现就是NacosNamingService。</span><br><span class=line>- NacosProxy.registerService(groupedServiceName, groupName, instance);</span><br><span class=line>	发送注册服务实例请求。发送到 /nacos/v1/ns/instance</span><br></pre></table></figure><h2 id=1-2、服务端><a class=headerlink href=#1-2、服务端 title=1.2、服务端></a>1.2、服务端</h2><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br></pre><td class=code><pre><span class=line>- 入口 com.alibaba.nacos.naming.controllers.InstanceController</span><br><span class=line></span><br><span class=line>- 将 实例信息 封装成 Instance对象。然后 执行注册实例方法。</span><br><span class=line>	ServiceManager.registerInstance(namespaceId, serviceName, instance);</span><br><span class=line>- 将 要注册的实例放入Service中</span><br><span class=line>	addInstance(namespaceId, serviceName, instance.isEphemeral(), instance);</span><br><span class=line>	</span><br><span class=line>	- 对服务加synchronized（不同服务不会阻塞，同一个服务的不同实例会被阻塞）</span><br><span class=line>		- 将实例列表封装成 instances 对象</span><br><span class=line>		- 更新注册表，完成 Nacos集群数据同步。 consistencyService.put(key, instances);</span><br><span class=line></span><br><span class=line>- 更新服务列表 ServiceManager.updateIpAddresses(...);</span><br><span class=line>	先获取旧的实例列表，然后把新的实例信息与旧的做对比，新的实例就添加，老的实例同步ID。</span><br><span class=line>	然后返回最新的实例列表。</span><br><span class=line></span><br><span class=line>- 集群一致性 更新 </span><br><span class=line>	- DelegateConsistencyServiceImpl.put(..);</span><br><span class=line>		- 根据实例是否是临时实例，判断委托对象</span><br><span class=line>			// 判断是否是临时实例：（默认情况下，所有实例都是临时实例，我们关注DistroConsistencyServiceImpl即可。）</span><br><span class=line>			// 是，选择 ephemeralConsistencyService，也就是 DistroConsistencyServiceImpl类</span><br><span class=line>			// 否，选择 persistentConsistencyService，也就是PersistentConsistencyServiceDelegateImpl</span><br><span class=line></span><br><span class=line>		- 先将要更新的实例信息写入本地实例列表，然后同步集群数据</span><br><span class=line>			- onPut(key, value);</span><br><span class=line>				- 将任务放入阻塞队列，通过线程池异步从队列中取出任务来执行。</span><br><span class=line>					notifier.addTask(key, DataOperation.CHANGE);</span><br><span class=line>					handle(pair);</span><br><span class=line>				- 根据 CHANGE事件 还是 DELETE 事件，来执行对应的操作。</span><br><span class=line>					- 获取旧实例列表</span><br><span class=line>					- 检查新加入实例状态</span><br><span class=line>					- 移除要删除的实例</span><br><span class=line>					- 覆盖旧实例。</span><br><span class=line>			- distroProtocol.sync(...);</span><br><span class=line>				- 遍历集群所有节点（除了自己），交给线程池去执行。</span><br><span class=line>					NacosDelayTaskExecuteEngine.addTask(distroKeyWithTarget, distroDelayTask);</span><br><span class=line>					NacosDelayTaskExecuteEngine，这个类维护了一个线程池，并且接收任务，执行任务。</span><br><span class=line>					去除任务来执行是基于Distro模式的同步是异步进行的，并且失败时会将任务重新入队，因此不保证强一致性，属于AP模式的一致性策略。</span><br></pre></table></figure><h2 id=1-3、总结><a class=headerlink href=#1-3、总结 title=1.3、总结></a>1.3、总结</h2><p><strong>（1）Nacos的注册表结构是什么样的？</strong><p>Nacos是多级存储模型，最外层通过namespace来实现环境隔离，然后是group分组，分组下就是服务，一个服务可分不同的集群，集群中包含多个实例。因此其注册表结构是一个Map结构：<p><code>Map&LTString, Map&LTString, Service>></code>，key是<code>namespace_id</code>，value代表的map结构的key是<code>group+serviceName</code>.<p>Service内部维护一个Map结构：<code>Map&LTString,Cluster></code>，key是clusterName，值是集群信息，Cluster内部维护一个Set集合，元素是Instance类型，代表集群中的多个实例。<p><strong>（2）Nacos如何保证并发写的安全性？</strong><p>注册实例时会对service加锁，不同service之间本身就不存在并发写问题，互不影响。相同service时通过锁来互斥。并且，在更新实例列表时，是基于异步的线程池来完成，且线程池的线程数量为1。<p><strong>（3）Nacos如何避免并发读写的冲突？</strong><p>Nacos在更新实例列表时，会<strong>采用 CopyOnWrite 技术</strong>，首先将Old实例列表拷贝一份，然后更新拷贝的实例列表，再用更新后的实例列表来覆盖旧的实例列表。<p><strong>（4）Nacos如何应对阿里内部数十万服务的并发写请求？</strong><p>Nacos内部会将服务注册的任务放入<em><strong>阻塞队列</strong></em>，采用<em><strong>线程池异步</strong></em>来完成实例更新，从而提高并发写能力。<h1 id=2、服务心跳><a class=headerlink href=#2、服务心跳 title=2、服务心跳></a>2、服务心跳</h1><h2 id=2-1、客户端><a class=headerlink href=#2-1、客户端 title=2.1、客户端></a>2.1、客户端</h2><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre><td class=code><pre><span class=line>- 入口 NacosNamingService.registerInstance(...);</span><br><span class=line>	- 触发心跳：BeatReactor.addBeatInfo(groupedServiceName, beatInfo)</span><br><span class=line>		- 利用线程池，定期执行心跳任务，周期为 beatInfo.getPeriod()，默认5S</span><br><span class=line>			executorService.schedule(new BeatTask(beatInfo), beatInfo.getPeriod(), TimeUnit.MILLISECONDS);</span><br><span class=line></span><br><span class=line>			发送心跳，然后判断心跳结果，若失败则重新 注册实例。</span><br><span class=line>- 发送心跳 NamingProxy.sendBeat(...)</span><br><span class=line>	请求地址：/v1/ns/instance/beat</span><br></pre></table></figure><h2 id=2-2、服务端><a class=headerlink href=#2-2、服务端 title=2.2、服务端></a>2.2、服务端</h2><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br></pre><td class=code><pre><span class=line>- 入口：InstanceController.beat();</span><br><span class=line></span><br><span class=line>- 从Nacos注册表中获取实例</span><br><span class=line>- 实例为null，表示获取失败 说明心跳失败，实例未注册</span><br><span class=line>	- 重新注册新实例</span><br><span class=line>- 实例不为null，则从注册表中获取服务service</span><br><span class=line>- 若service为null, 则服务不存在，抛出异常</span><br><span class=line>- 如果心跳没有问题，就处理 心跳结果。</span><br><span class=line></span><br><span class=line>- 处理心跳请求</span><br><span class=line>	- 从集群中找到当前的心跳实例</span><br><span class=line>	- 更新 该实例 最后一次心跳时间 lastBeat。</span><br></pre></table></figure><h3 id=2-2-1、异常检查><a class=headerlink href=#2-2-1、异常检查 title=2.2.1、异常检查></a>2.2.1、异常检查</h3><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br></pre><td class=code><pre><span class=line>- 入口 Service.init(); 服务注册时会被调用。</span><br><span class=line></span><br><span class=line>- 开启心跳检测任务</span><br><span class=line>	HealthCheckReactor.scheduleCheck(clientBeatCheckTask);</span><br><span class=line>	该任务会 每5秒对实例心跳状态 做一次检测。</span><br><span class=line></span><br><span class=line>	- clientBeatCheckTask</span><br><span class=line>		- 拿到 所有临时实例列表</span><br><span class=line>		- 判断 心跳间隔（当前时间-最后一次心跳时间）是否大于 心跳超时时间，默认15S</span><br><span class=line>			- 超时，则标记实例为 不健康。</span><br><span class=line>			- 不超时，发布实例状态变事件。</span><br><span class=line>		- 判断心跳间隔（当前时间 - 最后一次心跳时间）是否大于 实例被删除的最长超时时间，默认30秒</span><br><span class=line>			- 超过30S，删除实例。</span><br></pre></table></figure><h3 id=2-2-2、主动检查><a class=headerlink href=#2-2-2、主动检查 title=2.2.2、主动检查></a>2.2.2、主动检查</h3><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br></pre><td class=code><pre><span class=line>- 入口 ServiceManager.registerInstance(...)</span><br><span class=line></span><br><span class=line>- 若服务不存在，创建新服务。</span><br><span class=line>	- 尝试获取服务</span><br><span class=line>	- 服务不存在，开始创建新服务。</span><br><span class=line>	- 将服务写入注册表 并初始化。</span><br><span class=line>		- 初始化逻辑</span><br><span class=line>			- 开启心跳检测任务</span><br><span class=line>			- 遍历注册表中的集群</span><br><span class=line>			- 完成集群初始化</span><br><span class=line>				- 创建健康检测任务</span><br><span class=line>				- 开启对 非临时实例 的定时检测。</span><br><span class=line>- 非临时实例 定时检测逻辑</span><br><span class=line>	- 获取所有 非临时实例 集合</span><br><span class=line>	- 将检测信息 封装成 beat</span><br><span class=line>	- 放入阻塞队列中。</span><br><span class=line>	</span><br><span class=line>	- 拿出任务去执行</span><br><span class=line>		- 将任务封装为一个 TaskProcessor，并放入集合。</span><br><span class=line>		- 批量处理集合中的任务。</span><br><span class=line>			- 获取实例信息</span><br><span class=line>			- 基于NIO建立TCP连接</span><br><span class=line>			- 注册 连接、读取 事件。</span><br></pre></table></figure><h2 id=2-3、总结><a class=headerlink href=#2-3、总结 title=2.3、总结></a>2.3、总结</h2><p>Nacos的健康检测有两种模式：<ul><li>临时实例：<ul><li>采用客户端心跳检测模式，心跳周期5秒。<li>心跳间隔超过15秒就标记为不健康。<li>心跳间隔超过30秒会被从服务列表删除。</ul><li>永久实例：<ul><li>采用服务端主动健康检测方式。<li>周期为2000 + 5000毫秒内的随机数。<li>检测异常只会标记为不健康，不会删除。</ul></ul><p><strong>为什么Nacos有临时和永久两种实例呢？</strong><p>以淘宝为例，双十一大促期间，流量会比平常高出很多，此时需要增加更多实例来应对高并发，而这些实例在双十一之后就无需继续使用了，采用<strong>临时实例</strong>比较合适。而对于服务的一些常备实例，则使用<strong>永久实例</strong>更合适。<p>与eureka相比，Nacos与Eureka在临时实例上都是基于心跳模式实现，差别不大，主要是心跳周期不同，eureka是30秒，Nacos是5秒。<p>另外，Nacos支持永久实例，而Eureka不支持，Eureka只提供了心跳模式的健康监测，而没有主动检测功能。<h1 id=3、服务发现><a class=headerlink href=#3、服务发现 title=3、服务发现></a>3、服务发现</h1><h2 id=3-1、客户端><a class=headerlink href=#3-1、客户端 title=3.1、客户端></a>3.1、客户端</h2><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br></pre><td class=code><pre><span class=line>- 入口 NacosNamingService. getAllInstances(...);</span><br><span class=line></span><br><span class=line>- 判断 是否需要 订阅服务（默认true）</span><br><span class=line>	- 若要订阅，执行订阅逻辑。serviceInfo = hostReactor.getServiceInfo(...);</span><br><span class=line>	- 否则，执行拉取逻辑。serviceInfo = hostReactor.getServiceInfoDirectlyFromServer()</span><br><span class=line>- 从服务信息中获取实力列表并返回。</span><br><span class=line></span><br><span class=line>- 拉取服务</span><br><span class=line>	- 查看本地服务列表缓存是否存在，缓存是map</span><br><span class=line>	- 不存在</span><br><span class=line>		- 创建空ServiceInfo</span><br><span class=line>		- 放入缓存</span><br><span class=line>		- 放入待更新的服务列表</span><br><span class=line>		- 立即更新服务列表</span><br><span class=line>			- 执行HostReactor中的updateService()方法。</span><br><span class=line>				- 基于ServerProxy发起远程调用，查询服务列表</span><br><span class=line>		- 从 待更新服务列表 中删除</span><br><span class=line>	- 存在，但需要更新</span><br><span class=line>		- 执行更新逻辑。等待5秒中，待更新完成</span><br><span class=line>	- 开启定时更新服务列表的功能</span><br><span class=line>		scheduleUpdateIfAbsent(serviceName, clusters);</span><br><span class=line>	- 返回缓存中的服务信息</span><br><span class=line>		serviceInfoMap.get(serviceObj.getKey());</span><br><span class=line>	</span><br><span class=line>- 推送服务</span><br><span class=line>	基本思路是：</span><br><span class=line>		- 通过PushReceiver监听服务端推送的变更数据</span><br><span class=line>		- 解析数据后，通过NotifyCenter发布服务变更的事件</span><br><span class=line>		- InstanceChangeNotifier监听变更事件，完成对服务列表的更新</span><br><span class=line></span><br><span class=line>	入口 PushReceiver</span><br><span class=line>		- 创建 UDP客户端</span><br><span class=line>		- 准备线程池</span><br><span class=line>		- 开启线程任务，准备接收变更数据</span><br><span class=line>			- 接收推送数据</span><br><span class=line>			- 解析为json字符串</span><br><span class=line>			- 反序列化为对象</span><br><span class=line>			- 交给 HostReactor去处理</span><br><span class=line>			- 发送ACK回执</span><br><span class=line></span><br><span class=line>	- 处理接收到的数据 HostReactor.processServiceJson(String json);</span><br><span class=line>		- 解析 接收到的数据，解析出ServiceInfo</span><br><span class=line>		- 查询缓存中的 ServiceInfo</span><br><span class=line>		- 如果缓存存在，则需要校验哪些数据要更新</span><br><span class=line>			- 将接收到的ServiceInfo 放入缓存。</span><br><span class=line>			- 对缓存中的数据 与 接收到的数据 进行对比。拿到</span><br><span class=line>				新增实例、待删除实例、要修改实例。</span><br><span class=line>			- 发布实例状态修改事件。</span><br><span class=line>			- 将接收到的数据ServiceInfo写入缓存。</span><br><span class=line>		- 缓存不存在</span><br><span class=line>			- 放入缓存</span><br><span class=line>			- 直接发布状态修改事件。</span><br></pre></table></figure><h2 id=3-2、服务端><a class=headerlink href=#3-2、服务端 title=3.2、服务端></a>3.2、服务端</h2><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre><td class=code><pre><span class=line>- 入口 InstanceController.list();</span><br><span class=line></span><br><span class=line>- 获取客户端UDP端口</span><br><span class=line>- 获取服务列表并返回</span><br><span class=line>	- 将消费者UDP端口、IP等封装成一个PushClient对象，存储到PushService中，</span><br><span class=line>		后期服务变更时，方便推送消息。pushService.addClient()</span><br><span class=line>	- PushService实现了ApplicationListener接口，当服务列表变化时，就会通知我们。</span><br></pre></table></figure><h2 id=3-3、总结><a class=headerlink href=#3-3、总结 title=3.3、总结></a>3.3、总结</h2><p>Nacos的服务发现分为两种模式：<ul><li><strong>主动拉取模式</strong>。消费者定期主动从Nacos拉取服务列表并缓存起来，在调用服务时优先读取本地缓存中的服务列表。<li><strong>订阅模式</strong>。消费者订阅服务列表，并基于UDP协议来接收服务变更通知。服务列表更新时会发送UDP广播给所有订阅者。</ul><p>与Eureka相比，Nacos服务状态更新更及时，同步更新更快，避免了因同步慢造成的一系列问题。</div><footer class=post-footer><div class=post-eof></div></footer></article></div><div class=post-block><article class=post-content itemscope itemtype=http://schema.org/Article><link href=https://hgprivate.github.io/2024/08/21/MySQL%E7%B2%BE%E9%80%9A%E8%B0%83%E4%BC%98/ itemprop=mainEntityOfPage><span hidden itemprop=author itemscope itemtype=http://schema.org/Person> <meta content=/static/imgs/avatar.png itemprop=image> <meta content=豪哥 itemprop=name> </span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization> <meta content=豪哥博客 itemprop=name> <meta content=豪哥博客 itemprop=description> </span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork> <meta content="undefined | 豪哥博客" itemprop=name> <meta itemprop=description> </span><header class=post-header><h2 itemprop="name headline" class=post-title><a class=post-title-link href=/2024/08/21/MySQL%E7%B2%BE%E9%80%9A%E8%B0%83%E4%BC%98/ itemprop=url>MySQL系列-MySQL调优</a></h2><div class=post-meta-container><div class=post-meta><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar"></i> </span> <span class=post-meta-item-text>发表于</span> <time itemprop="dateCreated datePublished" title="创建时间：2024-08-21 21:39:14" datetime=2024-08-21T21:39:14+08:00>2024-08-21</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar-check"></i> </span> <span class=post-meta-item-text>更新于</span> <time title="修改时间：2024-10-25 20:04:22" datetime=2024-10-25T20:04:22+08:00 itemprop=dateModified>2024-10-25</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-folder"></i> </span> <span class=post-meta-item-text>分类于</span> <span itemprop=about itemscope itemtype=http://schema.org/Thing> <a href=/categories/MySQL/ itemprop=url rel=index><span itemprop=name>MySQL</span></a> </span> </span></div></div></header><div class=post-body itemprop=articleBody><h1 id=1、优化概述><a class=headerlink href=#1、优化概述 title=1、优化概述></a>1、优化概述</h1><p>优化分为几种类型：<ul><li>数据库级别优化；<li>硬件级别优化；<li>平衡便捷性和性能；</ul><h2 id=1-1、数据库级别优化><a class=headerlink href=#1-1、数据库级别优化 title=1.1、数据库级别优化></a>1.1、数据库级别优化</h2><p>数据库快速运行依赖于以下几项：<ol><li>正确的表结构、正确的列数据类型、必须的列；<li>正确优秀的索引设计；<li>正确合适的存储引擎；<li>表中采用正确的行格式；<li>正确的锁设计（行锁、表锁等）；<li>正确的缓存大小，这些缓存主要是<code>InnoDB</code>缓冲池，<code>MyISAM</code>键高速缓存和MySQL查询高速缓存；</ol><h2 id=1-2、硬件级别优化><a class=headerlink href=#1-2、硬件级别优化 title=1.2、硬件级别优化></a>1.2、硬件级别优化</h2><p>系统瓶颈通常有以下来源：<ol><li><p>磁盘搜索</p> <p>磁盘查找数据需要花费时间。对于现代磁盘，此操作的平均时间通常小于10毫秒，因此理论上我们可以执行约100秒钟的搜索。这段时间随着新磁盘的使用而缓慢改善，并且很难为单个表进行优化。优化寻道时间的方法是将数据分发到多个磁盘上。</p><li><p>磁盘读写</p> <p>当磁盘位于正确的位置时，我们需要读取或写入数据。对于现代磁盘，一个磁盘至少可提供10–20MB / s的吞吐量。与查找相比，优化起来更容易，因为您可以从多个磁盘并行读取。</p><li><p>CPU周期</p> <p>当数据位于主存储器中时，我们必须对其进行处理以获得结果。与内存量相比，拥有较大的表是最常见的限制因素。但是对于小表，速度通常不是问题。</p><li><p>内存带宽</p> <p>当CPU需要的数据超出CPU缓存的容量时，主内存带宽将成为瓶颈。对于大多数系统来说，这是一个不常见的瓶颈，但是要意识到这一点。</p></ol><h2 id=1-3、平衡便捷性和性能><a class=headerlink href=#1-3、平衡便捷性和性能 title=1.3、平衡便捷性和性能></a>1.3、平衡便捷性和性能</h2><p>MySQL Server支持三种注释样式：<ul><li>从<code>#</code>字符到行尾<li>从<code>-- </code>序列到行尾。在MySQL中，<code>-- </code>（双破折号）注释样式要求第二个破折号后必须至少包含一个空格或控制字符（例如空格，制表符，换行符等）。此语法与标准SQL注释语法略有不同。<li>从一个<code>/*</code>序列到以下 <code>*/</code>序列。此语法使注释可以扩展到多行，因为开始和结束序列不必在同一行上。</ul><p>下面演示了三种注释样式：<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre><td class=code><pre><span class=line>mysql<span class=operator>></span> <span class=keyword>SELECT</span> <span class=number>1</span><span class=operator>+</span><span class=number>1</span>;     # This comment continues <span class=keyword>to</span> the <span class=keyword>end</span> <span class=keyword>of</span> line</span><br><span class=line>mysql<span class=operator>></span> <span class=keyword>SELECT</span> <span class=number>1</span><span class=operator>+</span><span class=number>1</span>;     <span class=comment>-- This comment continues to the end of line</span></span><br><span class=line>mysql<span class=operator>></span> <span class=keyword>SELECT</span> <span class=number>1</span> 	  <span class=comment>/* this is an in-line comment */</span> <span class=operator>+</span> <span class=number>1</span>;</span><br><span class=line>mysql<span class=operator>></span> <span class=keyword>SELECT</span> <span class=number>1</span><span class=operator>+</span></span><br><span class=line><span class=comment>/*</span></span><br><span class=line><span class=comment>this is a</span></span><br><span class=line><span class=comment>multiple-line comment</span></span><br><span class=line><span class=comment>*/</span></span><br><span class=line><span class=number>1</span>;</span><br></pre></table></figure><h1 id=2、优化SQL语句><a class=headerlink href=#2、优化SQL语句 title=2、优化SQL语句></a>2、优化SQL语句</h1><h2 id=2-1、优化select语句><a class=headerlink href=#2-1、优化select语句 title=2.1、优化select语句></a>2.1、优化select语句</h2><h3 id=2-1-1-WHERE子句优化><a title="2.1.1 WHERE子句优化" class=headerlink href=#2-1-1-WHERE子句优化></a>2.1.1 WHERE子句优化</h3><ol><li><p>删除不必要的括号；</p><li><p>恒定折叠；</p> <figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>(a<span class=operator><</span>b <span class=keyword>AND</span> b<span class=operator>=</span>c) <span class=keyword>AND</span> a<span class=operator>=</span><span class=number>5</span>   <span class=operator>-</span><span class=operator>></span>    b<span class=operator>></span><span class=number>5</span> <span class=keyword>AND</span> b<span class=operator>=</span>c <span class=keyword>AND</span> a<span class=operator>=</span><span class=number>5</span></span><br></pre></table></figure><li><p>恒定条件删除；</p> <figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>(b<span class=operator>>=</span><span class=number>5</span> <span class=keyword>AND</span> b<span class=operator>=</span><span class=number>5</span>) <span class=keyword>OR</span> (b<span class=operator>=</span><span class=number>6</span> <span class=keyword>AND</span> <span class=number>5</span><span class=operator>=</span><span class=number>5</span>) <span class=keyword>OR</span> (b<span class=operator>=</span><span class=number>7</span> <span class=keyword>AND</span> <span class=number>5</span><span class=operator>=</span><span class=number>6</span>)   <span class=operator>-</span><span class=operator>></span>  b<span class=operator>=</span><span class=number>5</span> <span class=keyword>OR</span> b<span class=operator>=</span><span class=number>6</span></span><br></pre></table></figure><li><p>索引使用的表达式仅计算一次；</p><li><p>没有<code>WHERE</code>的单个 table 上的<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/aggregate-functions.html#function_count rel=noopener target=_blank>COUNT(*)</a>是直接从<code>MyISAM</code>和<code>MEMORY</code>table 的 table 信息中检索的。当仅与一个 table 一起使用时，对于任何<code>NOT NULL</code>表达式也将执行此操作。</p><li><p>早期检测无效的常量 table 达式。 MySQL 快速检测到某些<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/select.html rel=noopener target=_blank>SELECT</a>语句是不可能的，并且不返回任何行。</p><li><p>如果您不使用<code>GROUP BY</code>或集合函数(<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/aggregate-functions.html#function_count rel=noopener target=_blank>COUNT()</a>，<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/aggregate-functions.html#function_min rel=noopener target=_blank>MIN()</a>等)，则<code>HAVING</code>与<code>WHERE</code>合并。</p><li><p>对于联接中的每个 table，构造一个更简单的<code>WHERE</code>以获得 table 的快速<code>WHERE</code>评估，并尽快跳过行。</p><li><p>在查询中的所有其他 table 之前，首先读取所有常量 table。常量 table 可以是以下任意一个：</p> <ul><li>空表或具有一行的表。<li>与a或 索引<code>WHERE</code> 上的子句一起使用的表，其中所有索引部分都与常量表达式进行比较，并定义为。 <code>PRIMARY KEY``UNIQUE``NOT NULL</code></ul> <p>以下所有表均用作常量表：</p> <figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line><span class=keyword>SELECT</span> <span class=operator>*</span> <span class=keyword>FROM</span> t <span class=keyword>WHERE</span> primary_key<span class=operator>=</span><span class=number>1</span>;</span><br><span class=line><span class=keyword>SELECT</span> <span class=operator>*</span> <span class=keyword>FROM</span> t1,t2</span><br><span class=line>  <span class=keyword>WHERE</span> t1.primary_key<span class=operator>=</span><span class=number>1</span> <span class=keyword>AND</span> t2.primary_key<span class=operator>=</span>t1.id;</span><br></pre></table></figure><li><p>通过尝试所有可能的方法，找到用于联接 table 的最佳联接组合。如果<code>ORDER BY</code>和<code>GROUP BY</code>子句中的所有列都来自同一 table，则在联接时优先使用该 table。</p><li><p>如果有一个<code>ORDER BY</code>子句和另一个<code>GROUP BY</code>子句，或者<code>ORDER BY</code>或<code>GROUP BY</code>包含联接队列中第一个 table 以外的 table 中的列，则会创建一个临时 table。</p><li><p>如果使用<code>SQL_SMALL_RESULT</code>修饰符，则 MySQL 使用内存中的临时 table。</p><li><p>查询每个 table 索引，并使用最佳索引，除非优化程序认为使用 table 扫描更有效。一次使用扫描是基于最佳索引是否跨越了 table 的 30％以上，但是固定百分比不再决定使用索引还是扫描。现在，优化器更加复杂，其估计基于其他因素，例如 table 大小，行数和 I/O 块大小。</p><li><p>在某些情况下，MySQL 甚至可以在不查询数据文件的情况下从索引中读取行。如果索引中使用的所有列都是数字，则仅索引树用于解析查询。</p><li><p>在输出每一行之前，将跳过与<code>HAVING</code>子句不匹配的行。</p></ol><h3 id=2-1-2、范围优化><a class=headerlink href=#2-1-2、范围优化 title=2.1.2、范围优化></a>2.1.2、范围优化</h3><ol><li>单部分索引的范围访问方法<li>多部分索引的范围访问方法<li>多值比较的等距范围优化<li>行构造函数表达式的范围优化<li>限制内存使用以进行范围优化</ol><h3 id=2-1-3、索引合并优化><a class=headerlink href=#2-1-3、索引合并优化 title=2.1.3、索引合并优化></a>2.1.3、索引合并优化</h3><h3 id=2-1-4、发动机状态下推优化><a class=headerlink href=#2-1-4、发动机状态下推优化 title=2.1.4、发动机状态下推优化></a>2.1.4、发动机状态下推优化</h3><h3 id=2-1-5、索引条件下推优化><a class=headerlink href=#2-1-5、索引条件下推优化 title=2.1.5、索引条件下推优化></a>2.1.5、索引条件下推优化</h3><h3 id=2-1-6、嵌套循环联接算法><a class=headerlink href=#2-1-6、嵌套循环联接算法 title=2.1.6、嵌套循环联接算法></a>2.1.6、嵌套循环联接算法</h3><h3 id=2-1-7、嵌套联接优化><a class=headerlink href=#2-1-7、嵌套联接优化 title=2.1.7、嵌套联接优化></a>2.1.7、嵌套联接优化</h3><h3 id=2-1-8、外部联接优化><a class=headerlink href=#2-1-8、外部联接优化 title=2.1.8、外部联接优化></a>2.1.8、外部联接优化</h3><h3 id=2-1-9、外部联接简化><a class=headerlink href=#2-1-9、外部联接简化 title=2.1.9、外部联接简化></a>2.1.9、外部联接简化</h3><h3 id=2-1-10、多范围读取优化><a class=headerlink href=#2-1-10、多范围读取优化 title=2.1.10、多范围读取优化></a>2.1.10、多范围读取优化</h3><h3 id=2-1-11、块嵌套循环和批处理密钥访问联接><a class=headerlink href=#2-1-11、块嵌套循环和批处理密钥访问联接 title=2.1.11、块嵌套循环和批处理密钥访问联接></a>2.1.11、块嵌套循环和批处理密钥访问联接</h3><h3 id=2-1-12、条件过滤><a class=headerlink href=#2-1-12、条件过滤 title=2.1.12、条件过滤></a>2.1.12、条件过滤</h3><h3 id=2-1-13、IS-NULL优化><a title="2.1.13、IS NULL优化" class=headerlink href=#2-1-13、IS-NULL优化></a>2.1.13、IS NULL优化</h3><h3 id=2-1-14、按优化排序><a class=headerlink href=#2-1-14、按优化排序 title=2.1.14、按优化排序></a>2.1.14、按优化排序</h3><h3 id=2-1-15、按优化分组><a class=headerlink href=#2-1-15、按优化分组 title=2.1.15、按优化分组></a>2.1.15、按优化分组</h3><h3 id=2-1-16、DISTINCT优化><a class=headerlink href=#2-1-16、DISTINCT优化 title=2.1.16、DISTINCT优化></a>2.1.16、DISTINCT优化</h3><h3 id=2-1-17、LIMIT查询优化><a class=headerlink href=#2-1-17、LIMIT查询优化 title=2.1.17、LIMIT查询优化></a>2.1.17、LIMIT查询优化</h3><h3 id=2-1-18、函数调用优化><a class=headerlink href=#2-1-18、函数调用优化 title=2.1.18、函数调用优化></a>2.1.18、函数调用优化</h3><h3 id=2-1-19、行构造器表达式优化><a class=headerlink href=#2-1-19、行构造器表达式优化 title=2.1.19、行构造器表达式优化></a>2.1.19、行构造器表达式优化</h3><h3 id=2-1-20、避免全表扫描><a class=headerlink href=#2-1-20、避免全表扫描 title=2.1.20、避免全表扫描></a>2.1.20、避免全表扫描</h3><h2 id=2-2、优化子查询、派生表和视图引用><a class=headerlink href=#2-2、优化子查询、派生表和视图引用 title=2.2、优化子查询、派生表和视图引用></a>2.2、优化子查询、派生表和视图引用</h2><p>MySQL 查询优化器有多种策略可用于评估子查询：<ul><li>对于<code>IN</code>(或<code>=ANY</code>)子查询，优化器具有以下选择：<li>Semijoin<ul><li>Materialization<li><code>EXISTS</code>策略</ul><li>对于<code>NOT IN</code>(或<code><>ALL</code>)子查询，优化器具有以下选择：<li>Materialization<ul><li><code>EXISTS</code>策略</ul></ul><p>对于派生 table，优化器具有以下选择(这也适用于视图引用)：<ul><li>将派生 table 合并到外部查询块中<li>将派生 table 具体化为内部临时 table</ul><h3 id=2-2-1、使用半联接转换优化子查询，派生-table-和视图引用><a title="2.2.1、使用半联接转换优化子查询，派生 table 和视图引用" class=headerlink href=#2-2-1、使用半联接转换优化子查询，派生-table-和视图引用></a>2.2.1、使用半联接转换优化子查询，派生 table 和视图引用</h3><h3 id=2-2-2、通过物化优化子查询><a class=headerlink href=#2-2-2、通过物化优化子查询 title=2.2.2、通过物化优化子查询></a>2.2.2、通过物化优化子查询</h3><h3 id=2-2-3、使用exists策略优化子查询><a class=headerlink href=#2-2-3、使用exists策略优化子查询 title=2.2.3、使用exists策略优化子查询></a>2.2.3、使用exists策略优化子查询</h3><h3 id=2-2-4、通过合并或实现来优化派生表和视图引用><a class=headerlink href=#2-2-4、通过合并或实现来优化派生表和视图引用 title=2.2.4、通过合并或实现来优化派生表和视图引用></a>2.2.4、通过合并或实现来优化派生表和视图引用</h3><p>优化器可以使用两种策略来处理派生表引用（这也适用于视图引用）：<ul><li>将派生表合并到外部查询块中<li>将派生表具体化为内部临时表</ul><h2 id=2-3、优化INFORMATION-SCHEMA查询><a class=headerlink href=#2-3、优化INFORMATION-SCHEMA查询 title=2.3、优化INFORMATION_SCHEMA查询></a>2.3、优化INFORMATION_SCHEMA查询</h2><p>监视数据库的应用程序可能会频繁使用<code>INFORMATION_SCHEMA</code>table。可以对<code>INFORMATION_SCHEMA</code>table 的某些类型的查询进行优化以更快地执行。目标是最大程度地减少文件操作(例如，扫描目录或打开 table 文件)以收集构成这些动态 table 的信息。<ol><li>尝试对<code>WHERE</code>子句中的数据库和 table 名使用常量查找值；<li>编写查询以最小化必须打开的 table 文件的数量；<li>使用<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/explain.html rel=noopener target=_blank>EXPLAIN</a>确定服务器是否可以对查询使用<code>INFORMATION_SCHEMA</code>优化；</ol><h2 id=2-4、优化数据更改语句><a class=headerlink href=#2-4、优化数据更改语句 title=2.4、优化数据更改语句></a>2.4、优化数据更改语句</h2><h3 id=2-4-1、优化insert语句><a class=headerlink href=#2-4-1、优化insert语句 title=2.4.1、优化insert语句></a>2.4.1、优化insert语句</h3><p>为了优化插入速度，请将许多小操作合并为一个大操作。理想情况下，您进行单个连接，一次发送许多新行的数据，并将所有索引更新和一致性检查延迟到最后。<p>插入行所需的时间由以下因素决定，其中数字表示近似比例：<ul><li>Connecting: (3)<li>向服务器发送查询：(2)<li>解析查询：(2)<li>插入行：(1×行大小)<li>插入索引：(1×索引数)<li>Closing: (1)</ul><h3 id=2-4-2、优化update语句><a class=headerlink href=#2-4-2、优化update语句 title=2.4.2、优化update语句></a>2.4.2、优化update语句</h3><p>优化了一条更新语句，类似于<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/select.html rel=noopener target=_blank>SELECT</a>查询，但具有额外的写操作开销。写入速度取决于要更新的数据量和要更新的索引数。不变的索引不会更新。<p>获得快速更新的另一种方法是延迟更新，然后在以后连续进行许多更新。如果锁定 table，一起执行多个更新要比一次执行一次更新快得多。<p>对于使用动态行格式的<code>MyISAM</code>table，将行更新为更长的总长度可能会拆分该行。<h3 id=2-4-3、优化delete语句><a class=headerlink href=#2-4-3、优化delete语句 title=2.4.3、优化delete语句></a>2.4.3、优化delete语句</h3><p>删除<code>MyISAM</code>table 中的各个行所需的时间与索引的数量成正比。要更快地删除行，可以通过增加<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/server-system-variables.html#sysvar_key_buffer_size rel=noopener target=_blank>key_buffer_size</a>系统变量来增加键高速缓存的大小。<p>要删除<code>MyISAM</code>table 中的所有行，<code>TRUNCATE TABLE tbl_name</code>比<code>DELETE FROM tbl_name</code>快。截断操作不是事务安全的；<h2 id=2-5、优化数据库特权><a class=headerlink href=#2-5、优化数据库特权 title=2.5、优化数据库特权></a>2.5、优化数据库特权</h2><p>权限设置越复杂，所有 SQL 语句的开销就越大。简化由<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/grant.html rel=noopener target=_blank>GRANT</a>语句构建的特权，可使 MySQL 减少 Client 端执行语句时进行权限检查的开销。例如，如果您不授予任何 table 级或列级特权，则服务器无需检查<code>tables_priv</code>和<code>columns_priv</code>table 的内容。同样，如果您没有对任何帐户设置资源限制，则服务器不必执行资源计数。如果您有很高的语句处理负载，请考虑使用简化的授予结构以减少权限检查的开销。<h2 id=2-6、其它优化><a class=headerlink href=#2-6、其它优化 title=2.6、其它优化></a>2.6、其它优化</h2><ol><li>如果您的应用程序发出多个数据库请求以执行相关更新，则将这些语句组合到存储的例程中可以帮助提高性能。同样，如果您的应用程序根据多个列值或大量数据计算单个结果，则将计算结果合并到 UDF(用户定义的函数)中可以提高性能。然后，产生的快速数据库操作可用于其他查询，应用程序，甚至可以用不同的编程语言编写的代码重用。<li>要解决<code>ARCHIVE</code>table 出现的任何压缩问题，请使用<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/optimize-table.html rel=noopener target=_blank>OPTIMIZE TABLE</a>。<li>如果可能，将报告分类为“实时”或“统计”，其中仅根据从实时数据定期生成的汇总表中创建统计报告所需的数据。<li>如果您的数据与行和列的 table 结构不一致，则可以将数据打包并存储到<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/blob.html rel=noopener target=_blank>BLOB</a>列中。在这种情况下，您必须在应用程序中提供代码以打包和解压缩信息，但这可能会节省 I/O 操作，以读写相关值集。<li>对于 Web 服务器，将图像和其他二进制资产存储为文件，路径名存储在数据库中，而不是文件本身。大多数 Web 服务器比文件内容在缓存文件方面更胜一筹，因此使用文件通常更快。<li>如果您确实需要很高的速度，请查看底层的 MySQL 接口。</ol><h1 id=3、优化索引><a class=headerlink href=#3、优化索引 title=3、优化索引></a>3、优化索引</h1><p>MySQL使用索引的好处：<ol><li>快速查找与where子句匹配的行；<li>从考虑中消除行；<li>如果表具有多列索引，则优化器可以使用索引的任何最左前缀来查找行；<li>执行连接时从其它表中检索行；</ol><h2 id=3-1、主键优化><a class=headerlink href=#3-1、主键优化 title=3.1、主键优化></a>3.1、主键优化</h2><p>table主键表示您在最重要的查询中使用的一列或一组列。它具有关联的索引，可提高查询性能。查询性能受益于<code>NOT NULL</code>优化，因为它不能包含任何<code>NULL</code>值。使用<code>InnoDB</code>存储引擎，可以对 table 数据进行物理组织，以根据一个或多个主键列进行超快速查找和排序。<h2 id=3-2、外键优化><a class=headerlink href=#3-2、外键优化 title=3.2、外键优化></a>3.2、外键优化</h2><p>如果一个 table 有许多列，并且您查询了许多不同的列组合，将不常用的数据拆分为单独的 table(每个 table 包含几列)，然后通过复制数字 ID 将它们关联回主 table 可能会比较有效。<h2 id=3-3、列索引><a class=headerlink href=#3-3、列索引 title=3.3、列索引></a>3.3、列索引</h2><p>索引的最常见类型涉及单个列，该列将来自该列的值的副本存储在数据结构中，从而允许快速查找具有相应列值的行。 B 树数据结构使索引可以在<code>WHERE</code>子句中快速找到与诸如<code>=</code>，<code>></code>，<code>≤</code>，<code>BETWEEN</code>，<code>IN</code>等的运算符相对应的特定值，一组值或一系列值。<p>所有存储引擎每个 table 至少支持 16 个索引，并且总索引长度至少为 256 个字节。大多数存储引擎都有更高的限制。<h3 id=3-3-1、索引前缀><a class=headerlink href=#3-3-1、索引前缀 title=3.3.1、索引前缀></a>3.3.1、索引前缀</h3><p>使用字符串列的索引规范中的<code>col_name(N)</code>语法，可以创建仅使用该列的前* <code>N</code> <em>字符的索引。以这种方式仅索引列值的前缀可以使索引文件小得多。为<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/blob.html rel=noopener target=_blank>BLOB</a>或<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/blob.html rel=noopener target=_blank>TEXT</a>列构建索引时，</em>必须*为索引指定前缀长度。例如：<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>CREATE TABLE test (blob_col BLOB, INDEX(blob_col(10)));</span><br></pre></table></figure><p>前缀最长可以为 1000 个字节(对于<code>InnoDB</code>个 table，则为 767 个字节，除非您设置了innodb_large_prefix)。<h3 id=3-3-2、全文索引><a class=headerlink href=#3-3-2、全文索引 title=3.3.2、全文索引></a>3.3.2、全文索引</h3><p><code>FULLTEXT</code>索引用于全文搜索。仅<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/innodb-storage-engine.html rel=noopener target=_blank>InnoDB</a>和<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/myisam-storage-engine.html rel=noopener target=_blank>MyISAM</a>存储引擎支持<code>FULLTEXT</code>索引，并且仅支持<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/char.html rel=noopener target=_blank>CHAR</a>，<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/char.html rel=noopener target=_blank>VARCHAR</a>和<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/blob.html rel=noopener target=_blank>TEXT</a>列。索引始终在整个列上进行，并且不支持列前缀索引。<p>优化适用于针对单个<code>InnoDB</code>table 的某些类型的<code>FULLTEXT</code>查询。具有以下 Feature 的查询特别有效：<ul><li><code>FULLTEXT</code>查询仅返回文档 ID 或文档 ID 和搜索排名。<li><code>FULLTEXT</code>查询以分数的降序对匹配行进行排序，并应用<code>LIMIT</code>子句以获取前 N 个匹配行。为了应用此优化，必须没有<code>WHERE</code>子句，并且只有一个<code>ORDER BY</code>子句按降序排列。<li><code>FULLTEXT</code>查询仅检索与搜索词匹配的行的<code>COUNT(*)</code>值，而没有其他<code>WHERE</code>子句。将<code>WHERE</code>子句编码为<code>WHERE MATCH(text) AGAINST ('other_text')</code>，而无需任何<code>> 0</code>比较运算符。</ul><p>对于包含全文 table 达式的查询，MySQL 在查询执行的优化阶段评估这些表达式。优化器不仅查看全文 table 达式并进行估计，而且还在制定执行计划的过程中对它们进行评估。<p>此行为的含义是，对于全文查询，<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/explain.html rel=noopener target=_blank>EXPLAIN</a>通常比在优化阶段未进行表达式求值的非全文查询的慢。<h3 id=3-3-3、空间指数><a class=headerlink href=#3-3-3、空间指数 title=3.3.3、空间指数></a>3.3.3、空间指数</h3><p>您可以在空间数据类型上创建索引。 <code>MyISAM</code>和<code>InnoDB</code>支持有关空间类型的 R 树索引。其他存储引擎使用 B 树来索引空间类型(<code>ARCHIVE</code>除外，后者不支持空间类型索引)。<h3 id=3-3-4、memory引擎中的索引><a class=headerlink href=#3-3-4、memory引擎中的索引 title=3.3.4、memory引擎中的索引></a>3.3.4、memory引擎中的索引</h3><p><code>MEMORY</code>存储引擎默认使用<code>HASH</code>索引，但也支持<code>BTREE</code>索引。<h2 id=3-4、多列索引><a class=headerlink href=#3-4、多列索引 title=3.4、多列索引></a>3.4、多列索引</h2><p>MySQL 可以创建复合索引(即，多列上的索引)。一个索引最多可以包含 16 列。对于某些数据类型，您可以索引列的前缀。<p>MySQL 可以将多列索引用于测试索引中所有列的查询，或者仅测试第一列，前两列，前三列等等的查询。如果在索引定义中以正确的 Sequences 指定列，则单个复合索引可以加快对同一 table 的几种查询。<p>多列索引可以被认为是排序数组，其行包含通过串联索引列的值而创建的值。<h2 id=3-5、查看索引使用情况><a class=headerlink href=#3-5、查看索引使用情况 title=3.5、查看索引使用情况></a>3.5、查看索引使用情况</h2><p>使用<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/explain.html rel=noopener target=_blank>EXPLAIN</a>语句始终检查所有查询是否真的使用您在 table 中创建的索引。<h2 id=3-6、InnoDB-和-MyISAM-索引统计信息收集><a title="3.6、InnoDB 和 MyISAM 索引统计信息收集" class=headerlink href=#3-6、InnoDB-和-MyISAM-索引统计信息收集></a>3.6、InnoDB 和 MyISAM 索引统计信息收集</h2><p>存储引擎收集有关 table 的统计信息，以供优化器使用。table 统计信息基于值组，其中值组是一组具有相同键前缀值的行。出于优化目的，重要的统计数据是平均值组的大小。<p>MySQL 通过以下方式使用平均值组大小：<ul><li>估算每次<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/explain-output.html#jointype_ref rel=noopener target=_blank>ref</a>访问必须读取多少行<li>估计部分联接将产生多少行；也就是说，这种形式的操作将产生的行数：</ul><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>(...) JOIN tbl_name ON tbl_name.key = expr</span><br></pre></table></figure><p>随着索引的平均值组大小的增加，该索引在这两个用途中的作用不大，因为每次查找的平均行数增加：为了使索引更好地用于优化目的，最好将每个索引值作为目标 table 中的行数。当给定的索引值产生大量的行时，该索引的用处不大，MySQL 不太可能使用它。<p>平均值组的大小与 table 基数有关，table 基数是值组的数目。 <a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/show-index.html rel=noopener target=_blank>SHOW INDEX</a>语句显示基于* <code>N/S</code> <em>的基数值，其中</em> <code>N</code> <em>是 table 中的行数，而</em> <code>S</code> *是平均值组的大小。该比率在 table 中产生大约数量的值组。<h2 id=3-7、B-树索引和哈希索引的比较><a title="3.7、B 树索引和哈希索引的比较" class=headerlink href=#3-7、B-树索引和哈希索引的比较></a>3.7、B 树索引和哈希索引的比较</h2><h3 id=3-7-1、B树索引特征><a class=headerlink href=#3-7-1、B树索引特征 title=3.7.1、B树索引特征></a>3.7.1、B树索引特征</h3><p>B 树索引可用于使用<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/comparison-operators.html#operator_equal rel=noopener target=_blank>=</a>，<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/comparison-operators.html#operator_greater-than rel=noopener target=_blank>></a>，<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/comparison-operators.html#operator_greater-than-or-equal rel=noopener target=_blank>>=</a>，<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/comparison-operators.html#operator_less-than rel=noopener target=_blank><</a>，<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/comparison-operators.html#operator_less-than-or-equal rel=noopener target=_blank><=</a>或<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/comparison-operators.html#operator_between rel=noopener target=_blank>BETWEEN</a>运算符的 table 达式中的列比较。如果<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/string-comparison-functions.html#operator_like rel=noopener target=_blank>LIKE</a>的参数是不以通配符开头的常量字符串，则索引也可以用于<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/string-comparison-functions.html#operator_like rel=noopener target=_blank>LIKE</a>比较。例如，以下<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/select.html rel=noopener target=_blank>SELECT</a>语句使用索引：<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line><span class=keyword>SELECT</span> <span class=operator>*</span> <span class=keyword>FROM</span> tbl_name <span class=keyword>WHERE</span> key_col <span class=keyword>LIKE</span> <span class=string>'Patrick%'</span>;</span><br><span class=line><span class=keyword>SELECT</span> <span class=operator>*</span> <span class=keyword>FROM</span> tbl_name <span class=keyword>WHERE</span> key_col <span class=keyword>LIKE</span> <span class=string>'Pat%_ck%'</span>;</span><br></pre></table></figure><p>以下<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/select.html rel=noopener target=_blank>SELECT</a>语句不使用索引：<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line>SELECT * FROM tbl_name WHERE key_col LIKE '%Patrick%';</span><br><span class=line>SELECT * FROM tbl_name WHERE key_col LIKE other_col;</span><br></pre></table></figure><p>在第一条语句中，<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/string-comparison-functions.html#operator_like rel=noopener target=_blank>LIKE</a>值以通配符开头。在第二条语句中，<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/string-comparison-functions.html#operator_like rel=noopener target=_blank>LIKE</a>值不是常数。<p>如果您使用的<code>... LIKE '%string%'</code>和 <code>string</code> 的长度超过三个字符，则 MySQL 使用 Turbo Boyer-Moore 算法初始化字符串的模式，然后使用该模式更快地执行搜索。<p>如果 <code>col_name</code> 被索引，则使用<code>col_name IS NULL</code>的搜索将使用索引。<p>不能使用<code>WHERE</code>子句中未涵盖所有<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/logical-operators.html#operator_and rel=noopener target=_blank>AND</a>级别的任何索引来优化查询。换句话说，为了能够使用索引，必须在每个<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/logical-operators.html#operator_and rel=noopener target=_blank>AND</a>组中使用索引的前缀。<p>以下<code>WHERE</code>子句使用索引：<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br></pre><td class=code><pre><span class=line>... <span class=keyword>WHERE</span> index_part1<span class=operator>=</span><span class=number>1</span> <span class=keyword>AND</span> index_part2<span class=operator>=</span><span class=number>2</span> <span class=keyword>AND</span> other_column<span class=operator>=</span><span class=number>3</span></span><br><span class=line></span><br><span class=line>    <span class=comment>/* index = 1 OR index = 2 */</span></span><br><span class=line>... <span class=keyword>WHERE</span> index<span class=operator>=</span><span class=number>1</span> <span class=keyword>OR</span> A<span class=operator>=</span><span class=number>10</span> <span class=keyword>AND</span> index<span class=operator>=</span><span class=number>2</span></span><br><span class=line></span><br><span class=line>    <span class=comment>/* optimized like "index_part1='hello'" */</span></span><br><span class=line>... <span class=keyword>WHERE</span> index_part1<span class=operator>=</span><span class=string>'hello'</span> <span class=keyword>AND</span> index_part3<span class=operator>=</span><span class=number>5</span></span><br><span class=line></span><br><span class=line>    <span class=comment>/* Can use index on index1 but not on index2 or index3 */</span></span><br><span class=line>... <span class=keyword>WHERE</span> index1<span class=operator>=</span><span class=number>1</span> <span class=keyword>AND</span> index2<span class=operator>=</span><span class=number>2</span> <span class=keyword>OR</span> index1<span class=operator>=</span><span class=number>3</span> <span class=keyword>AND</span> index3<span class=operator>=</span><span class=number>3</span>;</span><br></pre></table></figure><p>这些<code>WHERE</code>子句<em>不</em>使用索引：<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre><td class=code><pre><span class=line><span class=comment>/* index_part1 is not used */</span></span><br><span class=line>... <span class=keyword>WHERE</span> index_part2<span class=operator>=</span><span class=number>1</span> <span class=keyword>AND</span> index_part3<span class=operator>=</span><span class=number>2</span></span><br><span class=line></span><br><span class=line>    <span class=comment>/*  Index is not used in both parts of the WHERE clause  */</span></span><br><span class=line>... <span class=keyword>WHERE</span> index<span class=operator>=</span><span class=number>1</span> <span class=keyword>OR</span> A<span class=operator>=</span><span class=number>10</span></span><br><span class=line></span><br><span class=line>    <span class=comment>/* No index spans all rows  */</span></span><br><span class=line>... <span class=keyword>WHERE</span> index_part1<span class=operator>=</span><span class=number>1</span> <span class=keyword>OR</span> index_part2<span class=operator>=</span><span class=number>10</span></span><br></pre></table></figure><p>有时，即使索引可用，MySQL 也不使用索引。发生这种情况的一种情况是，优化器估计使用索引将需要 MySQL 访问 table 中很大比例的行。 (在这种情况下，table 扫描可能会更快，因为它需要更少的查找.)但是，如果这样的查询使用<code>LIMIT</code>来仅检索某些行，则 MySQL 仍会使用索引，因为它可以更快地找到返回结果的几行。<h3 id=3-7-2、哈希索引特征><a class=headerlink href=#3-7-2、哈希索引特征 title=3.7.2、哈希索引特征></a>3.7.2、哈希索引特征</h3><ol><li>它们仅用于使用<code>=</code>或<code><=></code>运算符的相等比较(但非常快)。它们不用于比较运算符(例如<code><</code>)来查找值的范围。依赖于这种单值查找类型的系统称为“键值存储”。要将 MySQL 用于此类应用程序，请尽可能使用哈希索引。<li>优化器无法使用哈希索引来加快<code>ORDER BY</code>操作的速度。 (此索引类型不能用于按 Sequences 搜索下一个条目.)<li>MySQL 无法确定两个值之间大约有多少行(范围优化器使用它来决定使用哪个索引)。如果将<code>MyISAM</code>或<code>InnoDB</code>table 更改为哈希索引<code>MEMORY</code>table，这可能会影响某些查询。<li>仅整个键可用于搜索行。 (对于 B 树索引，键的任何最左边的前缀都可用于查找行。)</ol><h2 id=3-8、索引扩展的使用><a class=headerlink href=#3-8、索引扩展的使用 title=3.8、索引扩展的使用></a>3.8、索引扩展的使用</h2><p><a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/innodb-storage-engine.html rel=noopener target=_blank>InnoDB</a>通过向其附加主键列来自动扩展每个辅助索引。考虑此 table 定义：<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre><td class=code><pre><span class=line>CREATE TABLE t1 (</span><br><span class=line>  i1 INT NOT NULL DEFAULT 0,</span><br><span class=line>  i2 INT NOT NULL DEFAULT 0,</span><br><span class=line>  d DATE DEFAULT NULL,</span><br><span class=line>  PRIMARY KEY (i1, i2),</span><br><span class=line>  INDEX k_d (d)</span><br><span class=line>) ENGINE = InnoDB;</span><br></pre></table></figure><p>该 table 在第<code>(i1, i2)</code>列上定义了主键。它还在列<code>(d)</code>上定义了辅助索引<code>k_d</code>，但在内部<code>InnoDB</code>扩展了该索引并将其视为<code>(d, i1, i2)</code>列。<p>在确定如何以及是否使用该索引时，优化器会考虑扩展二级索引的主键列。这可以导致更有效的查询执行计划和更好的性能。<p>优化器可以将扩展的辅助索引用于<code>ref</code>，<code>range</code>和<code>index_merge</code>索引访问，松散索引扫描访问，联接和排序优化以及<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/aggregate-functions.html#function_min rel=noopener target=_blank>MIN()</a>/<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/aggregate-functions.html#function_max rel=noopener target=_blank>MAX()</a>优化。<p>以下示例显示了优化程序是否使用扩展二级索引如何影响执行计划。假设<code>t1</code>填充了以下行：<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br></pre><td class=code><pre><span class=line>INSERT INTO t1 VALUES</span><br><span class=line>(1, 1, '1998-01-01'), (1, 2, '1999-01-01'),</span><br><span class=line>(1, 3, '2000-01-01'), (1, 4, '2001-01-01'),</span><br><span class=line>(1, 5, '2002-01-01'), (2, 1, '1998-01-01'),</span><br><span class=line>(2, 2, '1999-01-01'), (2, 3, '2000-01-01'),</span><br><span class=line>(2, 4, '2001-01-01'), (2, 5, '2002-01-01'),</span><br><span class=line>(3, 1, '1998-01-01'), (3, 2, '1999-01-01'),</span><br><span class=line>(3, 3, '2000-01-01'), (3, 4, '2001-01-01'),</span><br><span class=line>(3, 5, '2002-01-01'), (4, 1, '1998-01-01'),</span><br><span class=line>(4, 2, '1999-01-01'), (4, 3, '2000-01-01'),</span><br><span class=line>(4, 4, '2001-01-01'), (4, 5, '2002-01-01'),</span><br><span class=line>(5, 1, '1998-01-01'), (5, 2, '1999-01-01'),</span><br><span class=line>(5, 3, '2000-01-01'), (5, 4, '2001-01-01'),</span><br><span class=line>(5, 5, '2002-01-01');</span><br></pre></table></figure><p>现在考虑以下查询：<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>EXPLAIN SELECT COUNT(*) FROM t1 WHERE i1 = 3 AND d = '2000-01-01'</span><br></pre></table></figure><p>执行计划取决于是否使用扩展索引。<p>当优化器不考虑索引扩展时，它会将索引<code>k_d</code>仅视为<code>(d)</code>。查询的<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/explain.html rel=noopener target=_blank>EXPLAIN</a>产生以下结果：<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br></pre><td class=code><pre><span class=line><span class="meta prompt_">mysql> </span><span class=language-bash>EXPLAIN SELECT COUNT(*) FROM t1 WHERE i1 = 3 AND d = <span class=string>'2000-01-01'</span>\G</span></span><br><span class=line>*************************** 1. row ***************************</span><br><span class=line>           id: 1</span><br><span class=line>  select_type: SIMPLE</span><br><span class=line>        table: t1</span><br><span class=line>         type: ref</span><br><span class=line>possible_keys: PRIMARY,k_d</span><br><span class=line>          key: k_d</span><br><span class=line>      key_len: 4</span><br><span class=line>          ref: const</span><br><span class=line>         rows: 5</span><br><span class=line>        Extra: Using where; Using index</span><br></pre></table></figure><p>当优化器考虑索引扩展时，会将<code>k_d</code>视为<code>(d, i1, i2)</code>。在这种情况下，它可以使用最左边的索引前缀<code>(d, i1)</code>来制定更好的执行计划：<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br></pre><td class=code><pre><span class=line><span class="meta prompt_">mysql> </span><span class=language-bash>EXPLAIN SELECT COUNT(*) FROM t1 WHERE i1 = 3 AND d = <span class=string>'2000-01-01'</span>\G</span></span><br><span class=line>*************************** 1. row ***************************</span><br><span class=line>           id: 1</span><br><span class=line>  select_type: SIMPLE</span><br><span class=line>        table: t1</span><br><span class=line>         type: ref</span><br><span class=line>possible_keys: PRIMARY,k_d</span><br><span class=line>          key: k_d</span><br><span class=line>      key_len: 8</span><br><span class=line>          ref: const,const</span><br><span class=line>         rows: 1</span><br><span class=line>        Extra: Using index</span><br></pre></table></figure><p>在这两种情况下，<code>key</code>table 示优化器将使用辅助索引<code>k_d</code>，但是<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/explain.html rel=noopener target=_blank>EXPLAIN</a>的输出显示了使用扩展索引的以下改进：<ul><li><code>key_len</code>从 4 字节变为 8 字节，table 示键查找使用的是<code>d</code>和<code>i1</code>列，而不仅仅是<code>d</code>。<li><code>ref</code>值从<code>const</code>变为<code>const,const</code>，因为键查找使用两个键部分，而不是一个。<li><code>rows</code>计数从 5 减少到 1，table 示<code>InnoDB</code>应该需要检查较少的行才能产生结果。<li><code>Extra</code>的值从<code>Using where; Using index</code>变为<code>Using index</code>。这意味着可以仅使用索引读取行，而无需查阅数据行中的列。</ul><p><a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/show-status.html rel=noopener target=_blank>SHOW STATUS</a>也可以看出使用扩展索引的优化器行为上的差异：<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line>FLUSH TABLE t1;</span><br><span class=line>FLUSH STATUS;</span><br><span class=line>SELECT COUNT(*) FROM t1 WHERE i1 = 3 AND d = '2000-01-01';</span><br><span class=line>SHOW STATUS LIKE 'handler_read%'</span><br></pre></table></figure><p>前面的语句包括<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/flush.html#flush-tables rel=noopener target=_blank>FLUSH TABLES</a>和<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/flush.html#flush-status rel=noopener target=_blank>FLUSH STATUS</a>以刷新 table 缓存并清除状态计数器。<p>没有索引 extensions，<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/show-status.html rel=noopener target=_blank>SHOW STATUS</a>会产生以下结果：<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br></pre><td class=code><pre><span class=line>+-----------------------+-------+</span><br><span class=line>| Variable_name         | Value |</span><br><span class=line>+-----------------------+-------+</span><br><span class=line>| Handler_read_first    | 0     |</span><br><span class=line>| Handler_read_key      | 1     |</span><br><span class=line>| Handler_read_last     | 0     |</span><br><span class=line>| Handler_read_next     | 5     |</span><br><span class=line>| Handler_read_prev     | 0     |</span><br><span class=line>| Handler_read_rnd      | 0     |</span><br><span class=line>| Handler_read_rnd_next | 0     |</span><br><span class=line>+-----------------------+-------+</span><br></pre></table></figure><p>使用索引 extensions，<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/show-status.html rel=noopener target=_blank>SHOW STATUS</a>产生此结果。 <a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/server-status-variables.html#statvar_Handler_read_next rel=noopener target=_blank>Handler_read_next</a>的值从 5 减少到 1，table 明索引的使用效率更高：<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br></pre><td class=code><pre><span class=line><span class=operator>+</span><span class=comment>-----------------------+-------+</span></span><br><span class=line><span class=operator>|</span> Variable_name         <span class=operator>|</span> <span class=keyword>Value</span> <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>-----------------------+-------+</span></span><br><span class=line><span class=operator>|</span> Handler_read_first    <span class=operator>|</span> <span class=number>0</span>     <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> Handler_read_key      <span class=operator>|</span> <span class=number>1</span>     <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> Handler_read_last     <span class=operator>|</span> <span class=number>0</span>     <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> Handler_read_next     <span class=operator>|</span> <span class=number>1</span>     <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> Handler_read_prev     <span class=operator>|</span> <span class=number>0</span>     <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> Handler_read_rnd      <span class=operator>|</span> <span class=number>0</span>     <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> Handler_read_rnd_next <span class=operator>|</span> <span class=number>0</span>     <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>-----------------------+-------+</span></span><br></pre></table></figure><p><a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/server-system-variables.html#sysvar_optimizer_switch rel=noopener target=_blank>optimizer_switch</a>系统变量的<code>use_index_extensions</code>标志允许控制在确定如何使用<code>InnoDB</code>table 的辅助索引时优化器是否考虑主键列。默认情况下，启用<code>use_index_extensions</code>。要检查禁用索引扩展的使用是否可以提高性能，请使用以下语句：<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line><span class=keyword>SET</span> optimizer_switch <span class=operator>=</span> <span class=string>'use_index_extensions=off'</span>;</span><br></pre></table></figure><p>优化程序对索引扩展的使用受制于对索引中关键部分的数量(16)和最大密钥长度(3072 字节)的通常限制。<h2 id=3-9、优化器对生成的列索引的使用><a class=headerlink href=#3-9、优化器对生成的列索引的使用 title=3.9、优化器对生成的列索引的使用></a>3.9、优化器对生成的列索引的使用</h2><p>MySQL 支持在生成的列上构建索引。例如：<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>CREATE TABLE t1 (f1 INT, gc INT AS (f1 + 1) STORED, INDEX (gc));</span><br></pre></table></figure><p>生成的列<code>gc</code>定义为 table 达式<code>f1 + 1</code>。该列也已构建索引，优化程序可以在执行计划构建期间考虑该索引。在以下查询中，<code>WHERE</code>子句引用<code>gc</code>，并且优化器考虑该列上的索引是否产生更有效的计划：<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>SELECT * FROM t1 WHERE gc > 9;</span><br></pre></table></figure><p>即使在查询中没有按名称直接引用那些列的情况下，优化器也可以使用所生成列的索引来生成执行计划。如果<code>WHERE</code>，<code>ORDER BY</code>或<code>GROUP BY</code>子句引用的 table 达式与某些索引生成的列的定义匹配，则会发生这种情况。以下查询不直接引用<code>gc</code>，而是使用与<code>gc</code>的定义匹配的 table 达式：<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>SELECT * FROM t1 WHERE f1 + 1 > 9;</span><br></pre></table></figure><p>优化器认识到 table 达式<code>f1 + 1</code>与<code>gc</code>的定义匹配，并且<code>gc</code>已被索引，因此它在执行计划构建期间会考虑该索引。您可以使用<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/explain.html rel=noopener target=_blank>EXPLAIN</a>查看此内容：<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br></pre><td class=code><pre><span class=line><span class="meta prompt_">mysql> </span><span class=language-bash>EXPLAIN SELECT * FROM t1 WHERE f1 + 1 > 9\G</span></span><br><span class=line>*************************** 1. row ***************************</span><br><span class=line>           id: 1</span><br><span class=line>  select_type: SIMPLE</span><br><span class=line>        table: t1</span><br><span class=line>   partitions: NULL</span><br><span class=line>         type: range</span><br><span class=line>possible_keys: gc</span><br><span class=line>          key: gc</span><br><span class=line>      key_len: 5</span><br><span class=line>          ref: NULL</span><br><span class=line>         rows: 1</span><br><span class=line>     filtered: 100.00</span><br><span class=line>        Extra: Using index condition</span><br></pre></table></figure><p>实际上，优化器已将 table 达式<code>f1 + 1</code>替换为与 table 达式匹配的生成列的名称。在由<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/show-warnings.html rel=noopener target=_blank>SHOW WARNINGS</a>显示的扩展<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/explain.html rel=noopener target=_blank>EXPLAIN</a>信息中可用的重写查询中，这也很明显：<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre><td class=code><pre><span class=line><span class="meta prompt_">mysql> </span><span class=language-bash>SHOW WARNINGS\G</span></span><br><span class=line>*************************** 1. row ***************************</span><br><span class=line>  Level: Note</span><br><span class=line>   Code: 1003</span><br><span class=line>Message: /* select#1 */ select `test`.`t1`.`f1` AS `f1`,`test`.`t1`.`gc`</span><br><span class=line>         AS `gc` from `test`.`t1` where (`test`.`t1`.`gc` > 9)</span><br></pre></table></figure><p>以下限制和条件适用于优化器对生成的列索引的使用：<ul><li>为了使查询 table 达式与生成的列定义匹配，该 table 达式必须相同并且其结果类型必须相同。例如，如果生成的列 table 达式为<code>f1 + 1</code>，则如果查询使用<code>1 + f1</code>或将<code>f1 + 1</code>(整数 table 达式)与字符串进行比较，则优化器将无法识别匹配项。<li>优化适用于以下运算符：<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/comparison-operators.html#operator_equal rel=noopener target=_blank>=</a>，<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/comparison-operators.html#operator_less-than rel=noopener target=_blank><</a>，<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/comparison-operators.html#operator_less-than-or-equal rel=noopener target=_blank><=</a>，<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/comparison-operators.html#operator_greater-than rel=noopener target=_blank>></a>，<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/comparison-operators.html#operator_greater-than-or-equal rel=noopener target=_blank>>=</a>，<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/comparison-operators.html#operator_between rel=noopener target=_blank>BETWEEN</a>和<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/comparison-operators.html#operator_in rel=noopener target=_blank>IN()</a>。</ul><p>对于<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/comparison-operators.html#operator_between rel=noopener target=_blank>BETWEEN</a>和<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/comparison-operators.html#operator_in rel=noopener target=_blank>IN()</a>以外的运算符，可以用匹配的生成列替换任何一个操作数。对于<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/comparison-operators.html#operator_between rel=noopener target=_blank>BETWEEN</a>和<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/comparison-operators.html#operator_in rel=noopener target=_blank>IN()</a>，只能将第一个参数替换为生成的匹配列，而其他参数必须具有相同的结果类型。涉及 JSON 值的比较尚不支持<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/comparison-operators.html#operator_between rel=noopener target=_blank>BETWEEN</a>和<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/comparison-operators.html#operator_in rel=noopener target=_blank>IN()</a>。<ul><li>必须将生成的列定义为至少包含一个函数调用或前一项中提到的运算符之一的 table 达式。该 table 达式不能包含对另一列的简单引用。例如，<code>gc INT AS (f1) STORED</code>仅由列引用组成，因此不考虑<code>gc</code>上的索引。<li>为了将字符串与索引生成的列进行比较，索引生成的列通过返回带引号的字符串的 JSON 函数计算值，在列定义中需要<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/json-modification-functions.html#function_json-unquote rel=noopener target=_blank>JSON_UNQUOTE()</a>才能从函数值中删除多余的引号。 (为了将字符串与函数结果直接进行比较，JSON 比较器会处理引号删除，但是对于索引查找不会发生这种情况.)例如，与其编写这样的列定义：</ul><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>doc_name TEXT AS (JSON_EXTRACT(jdoc, '$.name')) STORED</span><br></pre></table></figure><p>像这样写：<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>doc_name TEXT AS (JSON_UNQUOTE(JSON_EXTRACT(jdoc, '$.name'))) STORED</span><br></pre></table></figure><p>使用后一个定义，优化器可以为这两个比较检测到匹配：<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line>... WHERE JSON_EXTRACT(jdoc, '$.name') = 'some_string' ...</span><br><span class=line>... WHERE JSON_UNQUOTE(JSON_EXTRACT(jdoc, '$.name')) = 'some_string' ...</span><br></pre></table></figure><p>在列定义中没有<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/json-modification-functions.html#function_json-unquote rel=noopener target=_blank>JSON_UNQUOTE()</a>的情况下，优化器仅针对这些比较中的第一个比较检测到匹配项。<ul><li>如果优化器无法选择所需的索引，则可以使用索引提示来强制优化器做出其他选择。</ul><h2 id=3-10、TIMESTAMP-列中的索引查询><a title="3.10、TIMESTAMP 列中的索引查询" class=headerlink href=#3-10、TIMESTAMP-列中的索引查询></a>3.10、TIMESTAMP 列中的索引查询</h2><p>时间值作为 UTC 值存储在<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/datetime.html rel=noopener target=_blank>TIMESTAMP</a>列中，并且在会话时区和 UTC 之间转换插入和从<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/datetime.html rel=noopener target=_blank>TIMESTAMP</a>列中检索的值。 (这与<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/date-and-time-functions.html#function_convert-tz rel=noopener target=_blank>CONVERT_TZ()</a>函数执行的转换类型相同。如果会话时区为 UTC，则实际上没有时区转换。)<p>由于诸如夏令时(DST)等本地时区更改的约定，UTC 和非 UTC 时区之间的转换在两个方向上都不是一对一的。不同的 UTC 值在另一个时区可能不会不同。以下示例显示了不同的 UTC 值，它们在非 UTC 时区中变得相同：<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br></pre><td class=code><pre><span class=line><span class="meta prompt_">mysql> </span><span class=language-bash>CREATE TABLE tstable (ts TIMESTAMP);</span></span><br><span class=line><span class="meta prompt_">mysql> </span><span class=language-bash>SET time_zone = <span class=string>'UTC'</span>; -- insert UTC values</span></span><br><span class=line><span class="meta prompt_">mysql> </span><span class=language-bash>INSERT INTO tstable VALUES</span></span><br><span class=line>       ('2018-10-28 00:30:00'),</span><br><span class=line>       ('2018-10-28 01:30:00');</span><br><span class=line><span class="meta prompt_">mysql> </span><span class=language-bash>SELECT ts FROM tstable;</span></span><br><span class=line>+---------------------+</span><br><span class=line>| ts                  |</span><br><span class=line>+---------------------+</span><br><span class=line>| 2018-10-28 00:30:00 |</span><br><span class=line>| 2018-10-28 01:30:00 |</span><br><span class=line>+---------------------+</span><br><span class=line><span class="meta prompt_">mysql> </span><span class=language-bash>SET time_zone = <span class=string>'MET'</span>; -- retrieve non-UTC values</span></span><br><span class=line><span class="meta prompt_">mysql> </span><span class=language-bash>SELECT ts FROM tstable;</span></span><br><span class=line>+---------------------+</span><br><span class=line>| ts                  |</span><br><span class=line>+---------------------+</span><br><span class=line>| 2018-10-28 02:30:00 |</span><br><span class=line>| 2018-10-28 02:30:00 |</span><br><span class=line>+---------------------+</span><br></pre></table></figure><p>您可以看到两个不同的 UTC 值在转换为<code>'MET'</code>时区时是相同的。对于给定的<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/datetime.html rel=noopener target=_blank>TIMESTAMP</a>列查询，此现象可能导致不同的结果，具体取决于优化器是否使用索引来执行查询。<p>假设查询使用<code>WHERE</code>子句从前面显示的 table 中选择值，以在<code>ts</code>列中搜索单个特定值，例如用户提供的时间戳 Literals：<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line>SELECT ts FROM tstable</span><br><span class=line>WHERE ts = 'literal';</span><br></pre></table></figure><p>进一步假设查询在以下条件下执行：<ul><li>会话时区不是 UTC，并且具有 DST 偏移。例如：</ul><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>SET time_zone = 'MET';</span><br></pre></table></figure><ul><li>由于 DST 偏移，在<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/datetime.html rel=noopener target=_blank>TIMESTAMP</a>列中存储的唯一 UTC 值在会话时区中不是唯一的。 (前面显示的示例说明了这种情况的发生.)<li>该查询指定了在会话时区中 ImportingDST 小时内的搜索值。</ul><p>在这种情况下，对于未构建索引和构建索引的查找，<code>WHERE</code>子句中的比较以不同的方式发生，并导致不同的结果：<ul><li>如果没有索引或优化器无法使用它，则会在会话时区中进行比较。优化器执行 table 扫描，其中检索每个<code>ts</code>列值，将其从 UTC 转换为会话时区，并将其与搜索值(也在会话时区中解释)进行比较：</ul><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre><td class=code><pre><span class=line><span class="meta prompt_">mysql> </span><span class=language-bash>SELECT ts FROM tstable</span></span><br><span class=line>       WHERE ts = '2018-10-28 02:30:00';</span><br><span class=line>+---------------------+</span><br><span class=line>| ts                  |</span><br><span class=line>+---------------------+</span><br><span class=line>| 2018-10-28 02:30:00 |</span><br><span class=line>| 2018-10-28 02:30:00 |</span><br><span class=line>+---------------------+</span><br></pre></table></figure><p>由于已存储的<code>ts</code>值已转换为会话时区，因此查询有可能返回两个时间戳值，这些时间戳值与 UTC 值不同，但在会话时区中相等：更改时钟时，在 DST 移位之前出现的一个值，以及 DST 移位后出现的一个值。<ul><li>如果有可用的索引，则以 UTC 进行比较。优化器执行索引扫描，首先将搜索值从会话时区转换为 UTC，然后将结果与 UTC 索引条目进行比较：</ul><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre><td class=code><pre><span class=line><span class="meta prompt_">mysql> </span><span class=language-bash>ALTER TABLE tstable ADD INDEX (ts);</span></span><br><span class=line><span class="meta prompt_">mysql> </span><span class=language-bash>SELECT ts FROM tstable</span></span><br><span class=line>       WHERE ts = '2018-10-28 02:30:00';</span><br><span class=line>+---------------------+</span><br><span class=line>| ts                  |</span><br><span class=line>+---------------------+</span><br><span class=line>| 2018-10-28 02:30:00 |</span><br><span class=line>+---------------------+</span><br></pre></table></figure><p>在这种情况下，(转换后的)搜索值仅与索引条目匹配，并且由于不同存储的 UTC 值的索引条目也不同，因此搜索值只能匹配其中之一。<p>由于针对非索引和索引查找的优化器操作不同，因此在每种情况下查询都会产生不同的结果。非索引查找的结果将返回在会话时区中匹配的所有值。索引查找不能这样做：<ul><li>它在仅了解 UTC 值的存储引擎内执行。<li>对于 Map 到相同 UTC 值的两个不同的会话时区值，索引查找仅匹配相应的 UTC 索引条目，并且仅返回单行。</ul><p>在前面的讨论中，存储在<code>tstable</code>中的数据集恰好由不同的 UTC 值组成。在这种情况下，所示形式的所有使用索引的查询最多匹配一个索引条目。<p>如果索引不是<code>UNIQUE</code>，则 table(和索引)可以存储给定 UTC 值的多个实例。例如，<code>ts</code>列可能包含多个 UTC 值<code>'2018-10-28 00:30:00'</code>的实例。在这种情况下，使用索引的查询将返回它们中的每一个(在结果集中转换为 MET 值<code>'2018-10-28 02:30:00'</code>)。仍然使用索引的查询将转换后的搜索值与 UTC 索引条目中的单个值进行匹配，而不是将在会话时区中转换为搜索值的多个 UTC 值进行匹配。<p>如果返回在会话时区中匹配的所有<code>ts</code>值很重要，解决方法是禁止使用带有<code>IGNORE INDEX</code>提示的索引：<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre><td class=code><pre><span class=line><span class="meta prompt_">mysql> </span><span class=language-bash>SELECT ts FROM tstable</span></span><br><span class=line>       IGNORE INDEX (ts)</span><br><span class=line>       WHERE ts = '2018-10-28 02:30:00';</span><br><span class=line>+---------------------+</span><br><span class=line>| ts                  |</span><br><span class=line>+---------------------+</span><br><span class=line>| 2018-10-28 02:30:00 |</span><br><span class=line>| 2018-10-28 02:30:00 |</span><br><span class=line>+---------------------+</span><br></pre></table></figure><p>在其他情况下，例如使用<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/date-and-time-functions.html#function_from-unixtime rel=noopener target=_blank>FROM_UNIXTIME()</a>和<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/date-and-time-functions.html#function_unix-timestamp rel=noopener target=_blank>UNIX_TIMESTAMP()</a>函数执行的转换，在两个方向上也存在相同的缺少时空转换的双向 Map。<h1 id=4、优化数据结构><a class=headerlink href=#4、优化数据结构 title=4、优化数据结构></a>4、优化数据结构</h1><h2 id=4-1、优化数据大小><a class=headerlink href=#4-1、优化数据大小 title=4.1、优化数据大小></a>4.1、优化数据大小</h2><p>设计 table 以最小化它们在磁盘上的空间。通过减少写入磁盘和从磁盘读取的数据量，这可以带来巨大的改进。较小的 table 通常需要较少的主内存，而在查询执行期间对它们的内容进行有效处理时。table 数据的任何空间减少都会导致索引变小，从而可以更快地处理索引。<p>MySQL 支持许多不同的存储引擎(table 类型)和行格式。对于每个 table，您可以决定使用哪种存储和索引方法。为您的应用程序选择适当的 table 格式可以大大提高性能。<p>可以提高 table 的性能，并最大程度地减少存储空间的方法如下：<ul><li>表列<li>行格式<li>索引<li>join连接<li>正常化</ul><h3 id=4-1-1、表列><a class=headerlink href=#4-1-1、表列 title=4.1.1、表列></a>4.1.1、表列</h3><ol><li>尽可能使用最有效(最小)的数据类型。<li>尽可能将列声明为<code>NOT NULL</code>。</ol><h3 id=4-1-2、行格式><a class=headerlink href=#4-1-2、行格式 title=4.1.2、行格式></a>4.1.2、行格式</h3><p>默认情况下，<code>InnoDB</code>table 是使用<code>DYNAMIC</code>行格式创建。要使用<code>DYNAMIC</code>以外的行格式，请配置<code>innodb_default_row_format</code>，或在<code>CREATE TABLE</code>或<code>ALTER TABLE</code>语句中显式指定<code>ROW_FORMAT</code>选项。<p>紧凑的行格式系列(包括<code>COMPACT</code>，<code>DYNAMIC</code>和<code>COMPRESSED</code>)以增加某些操作的 CPU 使用为代价，减少了行存储空间。如果您的工作量是典型的工作量，受缓存命中率和磁盘速度的限制，则可能会更快。如果在极少数情况下受 CPU 速度的限制，则速度可能会更慢。<p>当使用可变长度字符集(例如<code>utf8mb3</code>或<code>utf8mb4</code>)时，紧凑的行格式系列还可以优化<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/char.html rel=noopener target=_blank>CHAR</a>列的存储。<h3 id=4-1-3、索引><a class=headerlink href=#4-1-3、索引 title=4.1.3、索引></a>4.1.3、索引</h3><ol><li>表主索引应尽量短；<li>仅创建需要提高查询性能的索引；<li>充分利用最左前缀匹配；</ol><h3 id=4-1-4、连接><a class=headerlink href=#4-1-4、连接 title=4.1.4、连接></a>4.1.4、连接</h3><ol><li>在某些情况下，将经常扫描的 table 分成两部分可能会有所帮助。<li>在具有相同数据类型的不同 table 中声明具有相同信息的列，以加快基于相应列的联接。<li>使列名保持简单，以便您可以在不同的 table 中使用相同的名称并简化联接查询。</ol><h3 id=4-1-5、其它建议><a class=headerlink href=#4-1-5、其它建议 title=4.1.5、其它建议></a>4.1.5、其它建议</h3><ol><li>通常，请尝试使所有数据保持非冗余(请注意数据库理论中称为第三范式的内容)。不必重复冗长的值(例如名称和地址)，而是给它们分配唯一的 ID，在多个较小的 table 中根据需要重复这些 ID，然后通过引用 join 子句中的 ID 在查询中联接这些 table。<li>如果速度比磁盘空间和保留多个数据副本的维护成本更为重要，例如在商业智能场景中，其中您分析大型 table 中的所有数据，则可以放宽规范化规则，复制信息或创建汇总 table 以提高速度。</ol><h2 id=4-2、优化数据类型><a class=headerlink href=#4-2、优化数据类型 title=4.2、优化数据类型></a>4.2、优化数据类型</h2><h3 id=4-2-1、优化数值类型><a class=headerlink href=#4-2-1、优化数值类型 title=4.2.1、优化数值类型></a>4.2.1、优化数值类型</h3><p>于可以 table 示为字符串或数字的唯一 ID 或其他值，与字符串列相比，首选数字列。由于大数值可以比相应字符串存储在更少的字节中，因此它传输速度更快，并且占用更少的内存来进行比较。<h3 id=4-2-2、优化字符和字符串类型><a class=headerlink href=#4-2-2、优化字符和字符串类型 title=4.2.2、优化字符和字符串类型></a>4.2.2、优化字符和字符串类型</h3><ol><li>当您不需要特定于语言的排序规则功能时，请使用二进制排序规则 Sequences 进行快速比较和排序操作。您可以使用<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/cast-functions.html#operator_binary rel=noopener target=_blank>BINARY</a>运算符在特定查询中使用二进制排序规则。<li>比较来自不同列的值时，请尽可能声明具有相同字符集和排序规则的那些列，以避免在运行查询时进行字符串转换。<li>对于小于 8KB 的列值，请使用二进制<code>VARCHAR</code>而不是<code>BLOB</code>。 <code>GROUP BY</code>和<code>ORDER BY</code>子句可以生成临时 table，并且如果原始 table 不包含任何<code>BLOB</code>列，则这些临时 table 可以使用<code>MEMORY</code>存储引擎。<li>如果 table 包含名称和地址之类的字符串列，但是许多查询未检索到这些列，请考虑将字符串列拆分为单独的 table，并在必要时使用带有外键的联接查询。当 MySQL 从一行中检索任何值时，它将读取一个包含该行所有列(可能还有其他相邻行)的数据块。保持每行较小，仅使用最常使用的列，可使更多行适合每个数据块。这样的紧凑 table 减少了常见查询的磁盘 I/O 和内存使用量。<li>当您将随机生成的值用作<code>InnoDB</code>table 中的主键时，请尽可能在其前面加上一个升值，例如当前日期和时间。当连续的主值在物理上彼此靠近存储时，<code>InnoDB</code>可以更快地插入和检索它们。</ol><h3 id=4-2-3、优化BLOB类型><a class=headerlink href=#4-2-3、优化BLOB类型 title=4.2.3、优化BLOB类型></a>4.2.3、优化BLOB类型</h3><ol><li>当存储包含文本数据的大 blob 时，请考虑首先对其进行压缩。当整个 table 由<code>InnoDB</code>或<code>MyISAM</code>压缩时，请勿使用此技术。<li>对于具有多个列的 table，为了减少不使用 BLOB 列的查询的内存需求，请考虑将 BLOB 列拆分为一个单独的 table，并在需要时使用联接查询对其进行引用。<li>由于检索和显示 BLOB 值的性能要求可能与其他数据类型完全不同，因此可以将特定于 BLOB 的 table 放在不同的存储设备上，甚至放在单独的数据库实例上。例如，要检索 BLOB，可能需要读取较大的 Sequences 磁盘，这比<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/glossary.html#glos_ssd rel=noopener target=_blank>SSD device</a>更适合传统硬盘驱动器。<li>您可以将列值的哈希存储在单独的列中，对该列进行索引并在查询中测试该哈希值，而不是针对非常长的文本字符串测试是否相等。</ol><h2 id=4-3、优化多表><a class=headerlink href=#4-3、优化多表 title=4.3、优化多表></a>4.3、优化多表</h2><h3 id=4-3-1、如何打开和关闭table><a class=headerlink href=#4-3-1、如何打开和关闭table title=4.3.1、如何打开和关闭table></a>4.3.1、如何打开和关闭table</h3><p>当执行<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/mysqladmin.html rel=noopener target=_blank>mysqladmin status</a>命令时，您应该看到类似以下的内容：<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line>Uptime: 426 Running threads: 1 Questions: 11082</span><br><span class=line>Reloads: 1 Open tables: 12</span><br></pre></table></figure><p>如果 table 少于 12 个，则<code>Open tables</code>的值 12 可能会令人困惑。<p>MySQL 是多线程的，因此可能有许多 Client 端同时为给定 table 发出查询。为了最大程度地减少同一张 table 上具有不同状态的多个 Client 端会话的问题，每个并发会话会独立打开该 table。这将使用额外的内存，但通常可以提高性能。对于<code>MyISAM</code>table，每个打开 table 的 Client 端的数据文件都需要一个额外的文件 Descriptors。 (相比之下，索引文件 Descriptors 在所有会话之间共享.)<p><a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/server-system-variables.html#sysvar_table_open_cache rel=noopener target=_blank>table_open_cache</a>和<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/server-system-variables.html#sysvar_max_connections rel=noopener target=_blank>max_connections</a>系统变量影响服务器保持打开状态的最大文件数。如果增加这两个值中的一个或两个，则可能会遇到 os 对打开文件 Descriptors 的每个进程数施加的限制。许多方法允许您增加打开文件的限制，尽管方法因系统而异。请查阅您的 os 文档，以确定是否可以增加限制以及如何增加限制。<p><a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/server-system-variables.html#sysvar_table_open_cache rel=noopener target=_blank>table_open_cache</a>与<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/server-system-variables.html#sysvar_max_connections rel=noopener target=_blank>max_connections</a>相关。例如，对于 200 个并发运行的连接，指定的 table 缓存大小至少为<code>200 * N</code>，其中* <code>N</code> *是您执行的任何查询中每个联接的最大 table 数。您还必须为临时 table 和文件保留一些额外的文件 Descriptors。<p>确保您的 os 可以处理<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/server-system-variables.html#sysvar_table_open_cache rel=noopener target=_blank>table_open_cache</a>设置所隐含的打开文件 Descriptors 的数量。如果<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/server-system-variables.html#sysvar_table_open_cache rel=noopener target=_blank>table_open_cache</a>设置得太高，MySQL 可能会用完文件 Descriptors，并 table 现出诸如拒绝连接或无法执行查询之类的症状。<p>还应考虑到<code>MyISAM</code>存储引擎为每个唯一的打开 table 都需要两个文件 Descriptors。对于<code>MyISAM</code>分区 table，打开的 table 的每个分区都需要两个文件 Descriptors。 (<code>MyISAM</code>打开分区 table 时，无论是否实际使用给定的分区，它都会打开该 table 的每个分区.请参见<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/partitioning-limitations.html#partitioning-limitations-myisam-file-descriptors rel=noopener target=_blank>MyISAM 和分区文件 Descriptors 的用法</a>。)要增加可用于 MySQL 的文件 Descriptors 的数量，请设置<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/server-system-variables.html#sysvar_open_files_limit rel=noopener target=_blank>open_files_limit</a>系统变量。参见<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/not-enough-file-handles.html rel=noopener target=_blank>B.4.2.17 节，“找不到文件和类似错误”</a>。<p>打开 table 的缓存保持在<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/server-system-variables.html#sysvar_table_open_cache rel=noopener target=_blank>table_open_cache</a>个条目的级别。服务器在启动时自动调整缓存大小。要显式设置大小，请在启动时设置<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/server-system-variables.html#sysvar_table_open_cache rel=noopener target=_blank>table_open_cache</a>系统变量。 MySQL 可能会临时打开更多 table 来执行查询，如本节后面所述。<p>在以下情况下，MySQL 关闭未使用的 table 并将其从 table 缓存中删除：<ul><li>当缓存已满并且线程尝试打开不在缓存中的 table 时。<li>当高速缓存包含多个<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/server-system-variables.html#sysvar_table_open_cache rel=noopener target=_blank>table_open_cache</a>个条目并且高速缓存中的 table 不再被任何线程使用时。<li>当进行 table 刷新操作时。当有人发出<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/flush.html#flush-tables rel=noopener target=_blank>FLUSH TABLES</a>语句或执行<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/mysqladmin.html rel=noopener target=_blank>mysqladmin flush-tables</a>或<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/mysqladmin.html rel=noopener target=_blank>mysqladmin refresh</a>命令时，就会发生这种情况。</ul><p>当 table 高速缓存填满时，服务器将使用以下过程找到要使用的高速缓存条目：<ul><li>从最近最少使用的 table 开始，释放当前未使用的 table。<li>如果必须打开一个新 table，但是缓存已满并且无法释放任何 table，则可以根据需要临时扩展缓存。当缓存处于临时扩展状态并且 table 从使用状态变为未使用状态时，table 将关闭并从缓存中释放。</ul><p>如果要使用<code>HANDLER tbl_name OPEN</code>语句打开 table，则会为该线程分配专用的 table 对象。该 table 对象不与其他线程共享，并且在线程调用<code>HANDLER tbl_name CLOSE</code>或线程终止之前不会关闭。发生这种情况时，会将 table 放回 table 缓存中(如果缓存未满)。参见<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/handler.html rel=noopener target=_blank>第 13.2.4 节“ HANDLER 语句”</a>。<p>要确定 table 缓存是否太小，请检查<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/server-status-variables.html#statvar_Opened_tables rel=noopener target=_blank>Opened_tables</a> status 变量，该变量指示自服务器启动以来 table 打开操作的数量：<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre><td class=code><pre><span class=line><span class="meta prompt_">mysql> </span><span class=language-bash>SHOW GLOBAL STATUS LIKE <span class=string>'Opened_tables'</span>;</span></span><br><span class=line>+---------------+-------+</span><br><span class=line>| Variable_name | Value |</span><br><span class=line>+---------------+-------+</span><br><span class=line>| Opened_tables | 2741  |</span><br><span class=line>+---------------+-------+</span><br></pre></table></figure><p>如果该值很大或迅速增加，即使您没有发出很多<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/flush.html#flush-tables rel=noopener target=_blank>FLUSH TABLES</a>语句，也要在服务器启动时增加<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/server-system-variables.html#sysvar_table_open_cache rel=noopener target=_blank>table_open_cache</a>值。<h3 id=4-3-2、一个数据库中创建多table的缺点><a class=headerlink href=#4-3-2、一个数据库中创建多table的缺点 title=4.3.2、一个数据库中创建多table的缺点></a>4.3.2、一个数据库中创建多table的缺点</h3><p>如果同一数据库目录中有许多<code>MyISAM</code>table，则打开，关闭和创建操作的速度很慢。如果在许多不同的 table 上执行<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/select.html rel=noopener target=_blank>SELECT</a>语句，则 table 高速缓存已满时会产生一些开销，因为对于必须打开的每个 table，必须关闭另一个 table。您可以通过增加 table 缓存中允许的条目数来减少此开销。<h2 id=4-4、内部临时表的使用><a class=headerlink href=#4-4、内部临时表的使用 title=4.4、内部临时表的使用></a>4.4、内部临时表的使用</h2><p>服务器在以下条件下创建临时 table：<ul><li>评估【UNION语句】，但稍后会有一些 exception。<li>评估某些视图，例如使用<code>TEMPTABLE</code>算法，UNION或聚合视图。<li>派生 table 的评估。<li>为子查询或半联接实现创建的 table。<li>评估包含<code>ORDER BY</code>子句和不同的<code>GROUP BY</code>子句的语句，或者<code>ORDER BY</code>或<code>GROUP BY</code>包含来自联接队列中第一个 table 以外的 table 的列的语句。<li>对<code>DISTINCT</code>和<code>ORDER BY</code>相结合的评估可能需要一个临时 table。<li>对于使用<code>SQL_SMALL_RESULT</code>修饰符的查询，MySQL 使用内存中临时 table，除非查询还包含需要磁盘存储的元素(稍后描述)。<li>为了评估从同一 table 中选择并插入到该 table 中的【插入…选择】语句，MySQL 创建一个内部临时 table 来保存SELECT中的行，然后将这些行插入目标 table 中。<li>评估多 table UPDATE语句。<li>评估【GROUP_CONCAT()】或【COUNT(DISTINCT) 表达式。</ul><p>要确定语句是否需要临时 table，请使用【EXPLAIN】并检查<code>Extra</code>列以查看其是否 table 示<code>Using temporary</code>。对于派生的或物化的临时 table，<code>EXPLAIN</code>不一定会说<code>Using temporary</code>。<p>某些查询条件阻止使用内存中的临时 table，在这种情况下，服务器将使用磁盘上的 table 代替：<ul><li>table 格中存在BLOB或TEXT列。这包括具有字符串值的用户定义变量，因为它们分别被视为 bob和text列，具体取决于它们的值是二进制字符串还是非二进制字符串。<li>如果使用了UNION或UNION ALL，则SELECT列 table 中存在任何最大长度大于 512(字符串为二进制字符串，非二进制为字符)的字符串列。<li>SHOW COLUMNS和DESCRIBE语句使用<code>BLOB</code>作为某些列的类型，因此用于结果的临时 table 是磁盘上的 table。</ul><p>这些条件使<code>UNION</code>可以在没有临时 table 的情况下进行评估：<ul><li>联合是<code>UNION ALL</code>，而不是<code>UNION</code>或<code>UNION DISTINCT</code>。<li>没有全局<code>ORDER BY</code>子句。<li>联合不是<code>{INSERT | REPLACE} ... SELECT ...</code>语句的顶级查询块。</ul><h3 id=4-4-1、内部临时表-存储引擎><a title="4.4.1、内部临时表 存储引擎" class=headerlink href=#4-4-1、内部临时表-存储引擎></a>4.4.1、内部临时表 存储引擎</h3><p>内部临时 table 可以保存在内存中，并由<code>MEMORY</code>存储引擎处理，或者由<code>InnoDB</code>或<code>MyISAM</code>存储引擎存储在磁盘上。<p>如果内部临时 table 被创建为内存 table，但又太大了，MySQL 会自动将其转换为磁盘 table。内存中临时 table 的最大大小由<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/server-system-variables.html#sysvar_tmp_table_size rel=noopener target=_blank>tmp_table_size</a>或<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/server-system-variables.html#sysvar_max_heap_table_size rel=noopener target=_blank>max_heap_table_size</a>值定义，以较小者为准。这与使用<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/create-table.html rel=noopener target=_blank>CREATE TABLE</a>显式创建的<code>MEMORY</code>table 不同。对于此类 table，只有<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/server-system-variables.html#sysvar_max_heap_table_size rel=noopener target=_blank>max_heap_table_size</a>变量确定 table 可以增长到多大，并且不转换为磁盘格式。<p><a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/server-system-variables.html#sysvar_internal_tmp_disk_storage_engine rel=noopener target=_blank>internal_tmp_disk_storage_engine</a>变量定义服务器用来 Management 磁盘内部临时 table 的存储引擎。允许的值为<code>INNODB</code>(默认值)和<code>MYISAM</code>。<p>当在内存或磁盘中创建内部临时 table 时，服务器将使<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/server-status-variables.html#statvar_Created_tmp_tables rel=noopener target=_blank>Created_tmp_tables</a>值递增。在磁盘上创建内部临时 table 时，服务器将使<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/server-status-variables.html#statvar_Created_tmp_disk_tables rel=noopener target=_blank>Created_tmp_disk_tables</a>值递增。如果在磁盘上创建了太多内部临时 table，请考虑增加<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/server-system-variables.html#sysvar_tmp_table_size rel=noopener target=_blank>tmp_table_size</a>和<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/server-system-variables.html#sysvar_max_heap_table_size rel=noopener target=_blank>max_heap_table_size</a>设置。<h3 id=4-4-2、内部临时表-存储格式><a title="4.4.2、内部临时表 存储格式" class=headerlink href=#4-4-2、内部临时表-存储格式></a>4.4.2、内部临时表 存储格式</h3><p>内存中的临时 table 由<code>MEMORY</code>存储引擎 Management，该引擎使用固定长度的行格式。 <code>VARCHAR</code>和<code>VARBINARY</code>列值被填充为最大列长度，实际上将它们存储为<code>CHAR</code>和<code>BINARY</code>列。<p>磁盘上的临时 table 由<code>InnoDB</code>或<code>MyISAM</code>存储引擎(取决于<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/server-system-variables.html#sysvar_internal_tmp_disk_storage_engine rel=noopener target=_blank>internal_tmp_disk_storage_engine</a>设置)Management。两个引擎都使用动态宽度行格式存储临时 table。列仅占用所需的存储空间，与使用固定长度行的磁盘 table 相比，这减少了磁盘 I/O，空间需求和处理时间。<p>对于最初在内存中创建内部临时 table 然后将其转换为磁盘上 table 的语句，跳过转换步骤并在磁盘上开始创建 table 可能会获得更好的性能。 <a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/server-system-variables.html#sysvar_big_tables rel=noopener target=_blank>big_tables</a>变量可用于强制内部临时 table 进行磁盘存储。<h2 id=4-5、数据库和表数量限制><a class=headerlink href=#4-5、数据库和表数量限制 title=4.5、数据库和表数量限制></a>4.5、数据库和表数量限制</h2><p>MySQL 对数据库的数量没有限制。基础文件系统可能对目录数有限制。<p>MySQL 对 table 的数量没有限制。基础文件系统可能会对 table 示 table 的文件数量有所限制。各个存储引擎可能会强加特定于引擎的约束。 <code>InnoDB</code>允许多达 40 亿张表。<h2 id=4-6、表格大小限制><a class=headerlink href=#4-6、表格大小限制 title=4.6、表格大小限制></a>4.6、表格大小限制</h2><p>MySQL 数据库的有效最大 table 大小通常由 os 对文件大小的限制来确定，而不是由 MySQL 内部限制来确定。有关 os 文件大小限制的最新信息，请参阅特定于您的 os 的文档。<p>Windows 用户，请注意 FAT 和 VFAT(FAT32)被认为不适合与 MySQL 一起用于生产。请改用 NTFS。<p>如果遇到全 table 错误，则可能由于多种原因导致它发生：<ul><li>磁盘可能已满。<li>您正在使用<code>InnoDB</code>table，并且<code>InnoDB</code>table 空间文件中的空间已用完。最大 table 空间大小也是 table 的最大大小。有关 table 空间大小的限制。</ul><p>通常，对于大于 1TB 的 table，建议将 table 划分为多个 table 空间文件。<ul><li>您已达到 os 文件大小限制。例如，您正在 os 上使用<code>MyISAM</code>table，该 table 仅支持最大 2GB 的文件，而数据文件或索引文件已达到此限制。<li>您正在使用<code>MyISAM</code>table，并且该 table 所需的空间超出了内部指针大小所允许的空间。 <code>MyISAM</code>允许数据和索引文件默认增加到 256TB，但此限制可以更改为最大允许大小 65,536TB(2567-1 字节)。</ul><p>解决<code>MyISAM</code>个 table 的文件大小限制的其他方法如下：<ul><li>如果您的大 table 是只读的，则可以使用<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/myisampack.html rel=noopener target=_blank>myisampack</a>对其进行压缩。 <a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/myisampack.html rel=noopener target=_blank>myisampack</a>通常会将 table 压缩至少 50％，因此实际上您可以拥有更大的 table。 <a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/myisampack.html rel=noopener target=_blank>myisampack</a>还可以将多个 table 合并为一个 table。<ul><li>MySQL 包括一个<code>MERGE</code>库，使您能够处理与单个<code>MERGE</code>table 具有相同结构的<code>MyISAM</code>table 的集合。</ul><li>您正在使用<code>MEMORY</code>(<code>HEAP</code>)存储引擎；在这种情况下，您需要增加<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/server-system-variables.html#sysvar_max_heap_table_size rel=noopener target=_blank>max_heap_table_size</a>系统变量的值。</ul><h2 id=4-7、表列数和行大小的限制><a class=headerlink href=#4-7、表列数和行大小的限制 title=4.7、表列数和行大小的限制></a>4.7、表列数和行大小的限制</h2><h3 id=4-7-1、列数限制><a class=headerlink href=#4-7-1、列数限制 title=4.7.1、列数限制></a>4.7.1、列数限制</h3><p>MySQL 对每个 table 有 4096 列的硬限制，但是对于给定的 table，有效最大值可能会更少。确切的列限制取决于几个因素：<ul><li>一个 table 的最大行大小限制了列的数量(可能还有大小)，因为所有列的总长度不能超过该大小。参见<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/column-count-limit.html#row-size-limits rel=noopener target=_blank>行大小限制</a>。<li>单个列的存储要求限制了给定最大行大小内的列数。某些数据类型的存储要求取决于存储引擎，存储格式和字符集等因素。参见<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/storage-requirements.html rel=noopener target=_blank>第 11.7 节“数据类型存储要求”</a>。<li>存储引擎可能会施加其他限制 table 列计数的限制。例如，<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/innodb-storage-engine.html rel=noopener target=_blank>InnoDB</a>每个 table 的限制为 1017 列。参见<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/innodb-limits.html rel=noopener target=_blank>第 14.23 节“ InnoDB 限制”</a>。有关其他存储引擎的信息，请参见<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/storage-engines.html rel=noopener target=_blank>第 15 章，备用存储引擎</a>。<li>每个 table 都有一个<code>.frm</code>文件，其中包含 table 定义。该定义以可能影响 table 中允许的列数的方式影响此文件的内容。参见<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/create-table-files.html#limits-frm-file rel=noopener target=_blank>.frm 文件结构施加的限制</a>。</ul><h3 id=4-7-2、行大小限制><a class=headerlink href=#4-7-2、行大小限制 title=4.7.2、行大小限制></a>4.7.2、行大小限制</h3><p>给定 table 的最大行大小由几个因素决定：<ul><li>MySQLtable 的内部 table 示具有 65,535 字节的最大行大小限制，即使存储引擎能够支持更大的行也是如此。 <a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/blob.html rel=noopener target=_blank>BLOB</a>和<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/blob.html rel=noopener target=_blank>TEXT</a>列仅占行大小限制的 9 到 12 个字节，因为它们的内容与其余行分开存储。<li><code>InnoDB</code>table 的最大行大小适用于数据库页面中本地存储的数据，对于 4KB，8KB，16KB 和 32KB <a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/innodb-parameters.html#sysvar_innodb_page_size rel=noopener target=_blank>innodb_page_size</a>设置，该行的最大行大小略小于一半。例如，对于默认的 16KB <code>InnoDB</code>页面大小，最大行大小略小于 8KB。对于 64KB 页面，最大行大小略小于 16KB。参见<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/innodb-limits.html rel=noopener target=_blank>第 14.23 节“ InnoDB 限制”</a>。</ul><p>如果包含<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/glossary.html#glos_variable_length_type rel=noopener target=_blank>variable-length columns</a>的行超过<code>InnoDB</code>的最大行大小，则<code>InnoDB</code>选择可变长度的列用于外部页外存储，直到该行适合<code>InnoDB</code>行大小的限制。对于行外存储的变长列，本地存储的数据量因行格式而异。<h4 id=4-7-2-1、行大小限制测试示例><a class=headerlink href=#4-7-2-1、行大小限制测试示例 title=4.7.2.1、行大小限制测试示例></a>4.7.2.1、行大小限制测试示例</h4><ul><li>以下<code>InnoDB</code>和<code>MyISAM</code>示例演示了 MySQL 最大行大小限制为 65,535 字节。不管存储引擎如何，都会强制执行该限制，即使存储引擎可能能够支持更大的行。</ul><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br></pre><td class=code><pre><span class=line><span class="meta prompt_">mysql> </span><span class=language-bash>CREATE TABLE t (a VARCHAR(10000), b VARCHAR(10000),</span></span><br><span class=line>       c VARCHAR(10000), d VARCHAR(10000), e VARCHAR(10000),</span><br><span class=line>       f VARCHAR(10000), g VARCHAR(6000)) ENGINE=InnoDB CHARACTER SET latin1;</span><br><span class=line>ERROR 1118 (42000): Row size too large. The maximum row size for the used</span><br><span class=line>table type, not counting BLOBs, is 65535. This includes storage overhead,</span><br><span class=line>check the manual. You have to change some columns to TEXT or BLOBs</span><br><span class=line><span class="meta prompt_">mysql> </span><span class=language-bash>CREATE TABLE t (a VARCHAR(10000), b VARCHAR(10000),</span></span><br><span class=line>       c VARCHAR(10000), d VARCHAR(10000), e VARCHAR(10000),</span><br><span class=line>       f VARCHAR(10000), g VARCHAR(6000)) ENGINE=MyISAM CHARACTER SET latin1;</span><br><span class=line>ERROR 1118 (42000): Row size too large. The maximum row size for the used</span><br><span class=line>table type, not counting BLOBs, is 65535. This includes storage overhead,</span><br><span class=line>check the manual. You have to change some columns to TEXT or BLOBs</span><br></pre></table></figure><p>在下面的<code>MyISAM</code>示例中，将列更改为<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/blob.html rel=noopener target=_blank>TEXT</a>可以避免 65,535 字节的行大小限制，并允许操作成功，因为<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/blob.html rel=noopener target=_blank>BLOB</a>和<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/blob.html rel=noopener target=_blank>TEXT</a>列仅对行大小贡献 9 至 12 个字节。<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line><span class="meta prompt_">mysql> </span><span class=language-bash>CREATE TABLE t (a VARCHAR(10000), b VARCHAR(10000),</span></span><br><span class=line>       c VARCHAR(10000), d VARCHAR(10000), e VARCHAR(10000),</span><br><span class=line>       f VARCHAR(10000), g TEXT(6000)) ENGINE=MyISAM CHARACTER SET latin1;</span><br><span class=line>Query OK, 0 rows affected (0.02 sec)</span><br></pre></table></figure><p>对于<code>InnoDB</code>table，该操作成功，因为将列更改为<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/blob.html rel=noopener target=_blank>TEXT</a>可以避免 MySQL 65,535 字节的行大小限制，而<code>InnoDB</code>可变长度列的页外存储可以避免<code>InnoDB</code>行大小限制。<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line><span class="meta prompt_">mysql> </span><span class=language-bash>CREATE TABLE t (a VARCHAR(10000), b VARCHAR(10000),</span></span><br><span class=line>       c VARCHAR(10000), d VARCHAR(10000), e VARCHAR(10000),</span><br><span class=line>       f VARCHAR(10000), g TEXT(6000)) ENGINE=InnoDB CHARACTER SET latin1;</span><br><span class=line>Query OK, 0 rows affected (0.02 sec)</span><br></pre></table></figure><ul><li>可变长度列的存储包括长度字节，该长度字节计入行大小。例如，<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/char.html rel=noopener target=_blank>VARCHAR(255)字符集 utf8mb3</a>列占用两个字节来存储值的长度，因此每个值最多可以占用 767 个字节。</ul><p>创建 table<code>t1</code>的语句成功，因为这些列需要 32,765 2 字节和 32,766 2 字节，这在最大行大小 65,535 字节之内：<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line><span class="meta prompt_">mysql> </span><span class=language-bash>CREATE TABLE t1</span></span><br><span class=line>       (c1 VARCHAR(32765) NOT NULL, c2 VARCHAR(32766) NOT NULL)</span><br><span class=line>       ENGINE = InnoDB CHARACTER SET latin1;</span><br><span class=line>Query OK, 0 rows affected (0.02 sec)</span><br></pre></table></figure><p>创建 table<code>t2</code>的语句失败，因为尽管列长度在最大长度 65,535 字节以内，但仍需要两个额外的字节来记录该长度，这会导致行大小超过 65,535 字节：<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre><td class=code><pre><span class=line><span class="meta prompt_">mysql> </span><span class=language-bash>CREATE TABLE t2</span></span><br><span class=line>       (c1 VARCHAR(65535) NOT NULL)</span><br><span class=line>       ENGINE = InnoDB CHARACTER SET latin1;</span><br><span class=line>ERROR 1118 (42000): Row size too large. The maximum row size for the used</span><br><span class=line>table type, not counting BLOBs, is 65535. This includes storage overhead,</span><br><span class=line>check the manual. You have to change some columns to TEXT or BLOBs</span><br></pre></table></figure><p>将列长度减少到 65,533 或更短，可以使语句成功。<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line><span class="meta prompt_">mysql> </span><span class=language-bash>CREATE TABLE t2</span></span><br><span class=line>       (c1 VARCHAR(65533) NOT NULL)</span><br><span class=line>       ENGINE = InnoDB CHARACTER SET latin1;</span><br><span class=line>Query OK, 0 rows affected (0.01 sec)</span><br></pre></table></figure><ul><li>对于<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/myisam-storage-engine.html rel=noopener target=_blank>MyISAM</a>个 table，<code>NULL</code>列在行中需要额外的空间以记录其值是否为<code>NULL</code>。每个<code>NULL</code>列都多加一位，四舍五入到最接近的字节。</ul><p>创建 table<code>t3</code>的语句失败，因为<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/myisam-storage-engine.html rel=noopener target=_blank>MyISAM</a>除了可变长度的列长度字节所需的空间外，还需要<code>NULL</code>列的空间，从而导致行大小超过 65,535 字节：<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre><td class=code><pre><span class=line><span class="meta prompt_">mysql> </span><span class=language-bash>CREATE TABLE t3</span></span><br><span class=line>       (c1 VARCHAR(32765) NULL, c2 VARCHAR(32766) NULL)</span><br><span class=line>       ENGINE = MyISAM CHARACTER SET latin1;</span><br><span class=line>ERROR 1118 (42000): Row size too large. The maximum row size for the used</span><br><span class=line>table type, not counting BLOBs, is 65535. This includes storage overhead,</span><br><span class=line>check the manual. You have to change some columns to TEXT or BLOBs</span><br></pre></table></figure><p>有关<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/innodb-storage-engine.html rel=noopener target=_blank>InnoDB</a> <code>NULL</code>列存储的信息，请参见<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/innodb-row-format.html rel=noopener target=_blank>第 14.11 节“ InnoDB 行格式”</a>。<ul><li><code>InnoDB</code>将 4KB，8KB，16KB 和 32KB <a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/innodb-parameters.html#sysvar_innodb_page_size rel=noopener target=_blank>innodb_page_size</a>设置的行大小(用于数据库页面中本地存储的数据)限制为略小于数据库页面的一半，而对于 64KB 页面，则限制为小于 16KB。</ul><p>创建 table<code>t4</code>的语句失败，因为定义的列超出了 16KB <code>InnoDB</code>页的行大小限制。<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br></pre><td class=code><pre><span class=line><span class="meta prompt_">mysql> </span><span class=language-bash>CREATE TABLE t4 (</span></span><br><span class=line>       c1 CHAR(255),c2 CHAR(255),c3 CHAR(255),</span><br><span class=line>       c4 CHAR(255),c5 CHAR(255),c6 CHAR(255),</span><br><span class=line>       c7 CHAR(255),c8 CHAR(255),c9 CHAR(255),</span><br><span class=line>       c10 CHAR(255),c11 CHAR(255),c12 CHAR(255),</span><br><span class=line>       c13 CHAR(255),c14 CHAR(255),c15 CHAR(255),</span><br><span class=line>       c16 CHAR(255),c17 CHAR(255),c18 CHAR(255),</span><br><span class=line>       c19 CHAR(255),c20 CHAR(255),c21 CHAR(255),</span><br><span class=line>       c22 CHAR(255),c23 CHAR(255),c24 CHAR(255),</span><br><span class=line>       c25 CHAR(255),c26 CHAR(255),c27 CHAR(255),</span><br><span class=line>       c28 CHAR(255),c29 CHAR(255),c30 CHAR(255),</span><br><span class=line>       c31 CHAR(255),c32 CHAR(255),c33 CHAR(255)</span><br><span class=line>       ) ENGINE=InnoDB ROW_FORMAT=COMPACT DEFAULT CHARSET latin1;</span><br><span class=line>ERROR 1118 (42000): Row size too large (> 8126). Changing some columns to TEXT or BLOB or using</span><br><span class=line>ROW_FORMAT=DYNAMIC or ROW_FORMAT=COMPRESSED may help. In current row format, BLOB prefix of 768</span><br><span class=line>bytes is stored inline.</span><br></pre></table></figure><h1 id=5、优化InnoDB表><a class=headerlink href=#5、优化InnoDB表 title=5、优化InnoDB表></a>5、优化InnoDB表</h1><ul><li><a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/optimizing-innodb-storage-layout.html rel=noopener target=_blank>5.1 为 InnoDBtable 优化存储布局</a><li><a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/optimizing-innodb-transaction-management.html rel=noopener target=_blank>5.2 优化 InnoDB 事务 Management</a><li><a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/innodb-performance-ro-txn.html rel=noopener target=_blank>5.3 优化 InnoDB 只读事务</a><li><a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/optimizing-innodb-logging.html rel=noopener target=_blank>5.4 优化 InnoDB 重做日志</a><li><a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/optimizing-innodb-bulk-data-loading.html rel=noopener target=_blank>5.5 InnoDBtable 的批量数据加载</a><li><a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/optimizing-innodb-queries.html rel=noopener target=_blank>5.6 优化 InnoDB 查询</a><li><a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/optimizing-innodb-ddl-operations.html rel=noopener target=_blank>5.7 优化 InnoDB DDL 操作</a><li><a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/optimizing-innodb-diskio.html rel=noopener target=_blank>5.8 优化 InnoDB 磁盘 I/O</a><li><a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/optimizing-innodb-configuration-variables.html rel=noopener target=_blank>5.9 优化 InnoDB 配置变量</a><li><a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/optimizing-innodb-many-tables.html rel=noopener target=_blank>5.10 为具有多个 table 的系统优化 InnoDB</a></ul><h1 id=6、优化MyISAM表><a class=headerlink href=#6、优化MyISAM表 title=6、优化MyISAM表></a>6、优化MyISAM表</h1><ul><li><a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/optimizing-queries-myisam.html rel=noopener target=_blank>6.1 优化 MyISAM 查询</a><li><a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/optimizing-myisam-bulk-data-loading.html rel=noopener target=_blank>6.2 MyISAMtable 的批量数据加载</a><li><a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/repair-table-optimization.html rel=noopener target=_blank>6.3 优化 REPAIR TABLE 语句</a></ul><h1 id=7、优化内存表><a class=headerlink href=#7、优化内存表 title=7、优化内存表></a>7、优化内存表</h1><p>考虑将<code>MEMORY</code>table 用于经常访问，只读或很少更新的非关键数据。在实际工作量下，将您的应用程序与等效的<code>InnoDB</code>或<code>MyISAM</code>table 进行基准测试，以确认任何额外的性能值得承担丢失数据的风险，或者值得在应用程序启动时从基于磁盘的 table 复制数据的开销。<p>为了使<code>MEMORY</code>table 具有最佳性能，请检查针对每个 table 的查询类型，并指定用于每个关联索引(B 树索引或哈希索引)的类型。在<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/create-index.html rel=noopener target=_blank>CREATE INDEX</a>语句上，使用<code>USING BTREE</code>或<code>USING HASH</code>子句。对于通过<code>></code>或<code>BETWEEN</code>等运算符进行大于或小于比较的查询，B 树索引速度很快。哈希索引仅适用于通过<code>=</code>运算符查找单个值或通过<code>IN</code>运算符查找有限值的查询。<h1 id=8、查询执行计划><a class=headerlink href=#8、查询执行计划 title=8、查询执行计划></a>8、查询执行计划</h1><ul><li><a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/using-explain.html rel=noopener target=_blank>8.1 使用 EXPLAIN 优化查询</a><li><a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/explain-output.html rel=noopener target=_blank>8.2 EXPLAIN 输出格式</a><li><a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/explain-extended.html rel=noopener target=_blank>8.3 扩展 EXPLAIN 输出格式</a><li><a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/explain-for-connection.html rel=noopener target=_blank>8.4 获取命名连接的执行计划信息</a><li><a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/estimating-performance.html rel=noopener target=_blank>8.5 估算查询性能</a></ul><h1 id=9、查询优化器><a class=headerlink href=#9、查询优化器 title=9、查询优化器></a>9、查询优化器</h1><ul><li><a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/controlling-query-plan-evaluation.html rel=noopener target=_blank>9.1 控制查询计划评估</a><li><a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/switchable-optimizations.html rel=noopener target=_blank>9.2 可切换的优化</a><li><a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/optimizer-hints.html rel=noopener target=_blank>9.3 优化器提示</a><li><a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/index-hints.html rel=noopener target=_blank>9.4 索引提示</a><li><a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/cost-model.html rel=noopener target=_blank>9.5 优化器成本模型</a></ul><h1 id=10、缓存和缓冲><a class=headerlink href=#10、缓存和缓冲 title=10、缓存和缓冲></a>10、缓存和缓冲</h1><ul><li><a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/innodb-buffer-pool-optimization.html rel=noopener target=_blank>10.1 InnoDB 缓冲池优化</a><li><a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/myisam-key-cache.html rel=noopener target=_blank>10.2 MyISAM 密钥缓存</a><li><a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/query-cache.html rel=noopener target=_blank>10.3 MySQL 查询缓存</a><li><a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/statement-caching.html rel=noopener target=_blank>10.4 缓存准备好的语句和存储的程序</a></ul><h1 id=11、优化锁定操作><a class=headerlink href=#11、优化锁定操作 title=11、优化锁定操作></a>11、优化锁定操作</h1><ul><li><a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/internal-locking.html rel=noopener target=_blank>11.1 内部锁定方法</a><li><a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/table-locking.html rel=noopener target=_blank>11.2table 锁定问题</a><li><a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/concurrent-inserts.html rel=noopener target=_blank>11.3 并发插入</a><li><a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/metadata-locking.html rel=noopener target=_blank>11.4 元数据锁定</a><li><a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/external-locking.html rel=noopener target=_blank>11.5 外部锁定</a></ul><h1 id=12、优化MySQL服务器><a class=headerlink href=#12、优化MySQL服务器 title=12、优化MySQL服务器></a>12、优化MySQL服务器</h1><ul><li><a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/system-optimization.html rel=noopener target=_blank>12.1 系统因素</a><li><a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/disk-issues.html rel=noopener target=_blank>12.2 优化磁盘 I/O</a><li><a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/symbolic-links.html rel=noopener target=_blank>12.3 使用符号链接</a><li><a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/optimizing-memory.html rel=noopener target=_blank>12.4 优化内存使用</a></ul><h1 id=13、评估效果><a class=headerlink href=#13、评估效果 title=13、评估效果></a>13、评估效果</h1><h2 id=13-1、测量表达式和函数的速度><a class=headerlink href=#13-1、测量表达式和函数的速度 title=13.1、测量表达式和函数的速度></a>13.1、测量表达式和函数的速度</h2><p>要测量特定 MySQLtable 达式或函数的速度，请使用<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/mysql.html rel=noopener target=_blank>mysql</a>Client 端程序调用<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/information-functions.html#function_benchmark rel=noopener target=_blank>BENCHMARK()</a>函数。它的语法是<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/information-functions.html#function_benchmark rel=noopener target=_blank>BENCHMARK(loop_count,expr)</a>。返回值始终为零，但是<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/mysql.html rel=noopener target=_blank>mysql</a>打印一行，显示大约执行该语句所需的时间。例如：<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre><td class=code><pre><span class=line><span class="meta prompt_">mysql> </span><span class=language-bash>SELECT BENCHMARK(1000000,1+1);</span></span><br><span class=line>+------------------------+</span><br><span class=line>| BENCHMARK(1000000,1+1) |</span><br><span class=line>+------------------------+</span><br><span class=line>|                      0 |</span><br><span class=line>+------------------------+</span><br><span class=line>1 row in set (0.32 sec)</span><br></pre></table></figure><p>该结果是在奔腾 II 400MHz 系统上获得的。它显示 MySQL 在该系统上可以在 0.32 秒内执行 1,000,000 个简单加法 table 达式。<p>内置的 MySQL 函数通常经过高度优化，但可能会有一些 exception。 <a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/information-functions.html#function_benchmark rel=noopener target=_blank>BENCHMARK()</a>是一个很好的工具，可以用来确定您的查询是否存在某些功能。<h2 id=13-2、使用自己的基准><a class=headerlink href=#13-2、使用自己的基准 title=13.2、使用自己的基准></a>13.2、使用自己的基准</h2><p>对您的应用程序和数据库进行基准测试，以找出瓶颈所在。在解决了一个瓶颈之后(或通过将其替换为“虚拟”模块)，您可以 continue 确定下一个瓶颈。即使您的应用程序的总体性能目前可以接受，您至少也应该为每个瓶颈制定一个计划，并在有一天确实需要额外的性能时决定如何解决它。<p>免费的基准套件是<a href=http://osdb.sourceforge.net/%E5%A4%84%E7%9A%84%E5%BC%80%E6%BA%90%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9F%BA%E5%87%86%E3%80%82 rel=noopener target=_blank>http://osdb.sourceforge.net/处的开源数据库基准。</a><p>仅当系统负载很重时才发生问题是很常见的。我们有许多 Client 在 Producing(经过测试)系统并遇到负载问题时与我们联系。在大多数情况下，性能问题可能是由于基本数据库设计问题(例如，table 扫描在高负载下效果不佳)或 os 或库问题引起的。在大多数情况下，如果系统尚未投入生产，这些问题将更容易解决。<p>为避免出现此类问题，请在可能的最坏负载下对整个应用程序进行基准测试：<ul><li><a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/mysqlslap.html rel=noopener target=_blank>mysqlslap</a>程序对于模拟多个 Client 端同时发出查询所产生的高负载可能会有所帮助。参见<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/mysqlslap.html rel=noopener target=_blank>第 4.5.8 节“ mysqlslap-一个负载仿真 Client 端”</a>。<li>您也可以尝试<a href=https://launchpad.net/sysbench%E5%92%8Chttp://osdldbt.sourceforge.net/#dbt2%E6%8F%90%E4%BE%9B%E7%9A%84%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95%E5%8C%85%EF%BC%8C%E4%BE%8B%E5%A6%82 rel=noopener target=_blank>https://launchpad.net/sysbench和http://osdldbt.sourceforge.net/#dbt2提供的基准测试包，例如</a> SysBench 和 DBT2.</ul><p>这些程序或软件包可以使系统崩溃，因此请确保仅在开发系统上使用它们。<h2 id=13-3、使用performance-schema><a class=headerlink href=#13-3、使用performance-schema title=13.3、使用performance_schema></a>13.3、使用performance_schema</h2><p>您可以查询<code>performance_schema</code>数据库中的 table 以查看有关服务器及其正在运行的应用程序的性能 Feature 的实时信息。有关详情，请参见<a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/performance-schema.html rel=noopener target=_blank>MySQL 性能模式</a>。<h1 id=14、检测服务器线程-进程信息><a class=headerlink href=#14、检测服务器线程-进程信息 title=14、检测服务器线程/进程信息></a>14、检测服务器线程/进程信息</h1><ul><li><a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/processlist-access.html rel=noopener target=_blank>14.1 访问进程列 table</a><li><a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/thread-commands.html rel=noopener target=_blank>14.2 线程命令值</a><li><a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/general-thread-states.html rel=noopener target=_blank>14.3 通用线程状态</a><li><a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/query-cache-thread-states.html rel=noopener target=_blank>14.4 查询缓存线程状态</a><li><a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/source-thread-states.html rel=noopener target=_blank>14.5 复制源线程状态</a><li><a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/replica-io-thread-states.html rel=noopener target=_blank>14.6 复制副本 I/O 线程状态</a><li><a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/replica-sql-thread-states.html rel=noopener target=_blank>14.7 复制副本 SQL 线程状态</a><li><a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/replica-connection-thread-states.html rel=noopener target=_blank>14.8 复制副本连接线程状态</a><li><a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/mysql-cluster-thread-states.html rel=noopener target=_blank>14.9 NDB 群集线程状态</a><li><a href=https://www.docs4dev.com/docs/zh/mysql/5.7/reference/event-scheduler-thread-states.html rel=noopener target=_blank>14.10 事件计划程序线程状态</a></ul><h1 id=XX查询优化><a class=headerlink href=#XX查询优化 title=XX查询优化></a>XX查询优化</h1><h2 id=查询慢><a class=headerlink href=#查询慢 title=查询慢></a>查询慢</h2><ol><li>网络<li>CPU<li>IO<li>上下文<li>系统调用<li>生成统计信息<li>锁等待时间</ol><h2 id=优化数据访问><a class=headerlink href=#优化数据访问 title=优化数据访问></a>优化数据访问</h2><ol><li>是某些查询需要筛选大量数据<ol><li>判断 程序是否在检索大量超过需要的数据；<li>判断 mysql服务器层是否在分析大量超过需要的数据；</ol><li>是否向数据库请求了不需要的数据<ol><li>查询不需要的数据；<li>多表关联时返回全部列；<li>总是取全部列；<li>重复查询相同数据；</ol></ol><h2 id=执行过程优化><a class=headerlink href=#执行过程优化 title=执行过程优化></a>执行过程优化</h2><h3 id=查询缓存><a class=headerlink href=#查询缓存 title=查询缓存></a>查询缓存</h3><h3 id=查询优化处理><a class=headerlink href=#查询优化处理 title=查询优化处理></a>查询优化处理</h3><h4 id=语法解析器><a class=headerlink href=#语法解析器 title=语法解析器></a>语法解析器</h4><h4 id=查询优化器><a class=headerlink href=#查询优化器 title=查询优化器></a>查询优化器</h4><ol><li>经过大量统计信息计算得出；<li>大多情况下，mysql会选择错误的执行计划；<li>优化器的优化策略；<li>优化器的优化类型；<li>关联查询；<li>排序优化；</ol><h2 id=优化特定类型的查询><a class=headerlink href=#优化特定类型的查询 title=优化特定类型的查询></a>优化特定类型的查询</h2><h3 id=优化count查询><a class=headerlink href=#优化count查询 title=优化count查询></a>优化count查询</h3><h3 id=优化关联查询><a class=headerlink href=#优化关联查询 title=优化关联查询></a>优化关联查询</h3><h3 id=优化子查询><a class=headerlink href=#优化子查询 title=优化子查询></a>优化子查询</h3><h3 id=优化group-by和distinct><a title="优化group by和distinct" class=headerlink href=#优化group-by和distinct></a>优化group by和distinct</h3><h3 id=优化limit分页><a class=headerlink href=#优化limit分页 title=优化limit分页></a>优化limit分页</h3><figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line><span class=keyword>select</span> <span class=operator>*</span> <span class=keyword>from</span> emp e <span class=keyword>join</span> (</span><br><span class=line>  <span class=keyword>select</span> eid <span class=keyword>from</span> emp e2 limit <span class=number>10000</span>,<span class=number>5</span></span><br><span class=line>)<span class=keyword>where</span> e.eid <span class=operator>=</span> e2.eid;</span><br></pre></table></figure><h3 id=优化union查询><a class=headerlink href=#优化union查询 title=优化union查询></a>优化union查询</h3><h3 id=使用自定义变量><a class=headerlink href=#使用自定义变量 title=使用自定义变量></a>使用自定义变量</h3></div><footer class=post-footer><div class=post-eof></div></footer></article></div><div class=post-block><article class=post-content itemscope itemtype=http://schema.org/Article><link href=https://hgprivate.github.io/2024/08/21/MySQL%E7%BB%8F%E5%85%B8SQL%E7%BB%83%E4%B9%A0%E9%A2%98%E4%B9%8BLeetcode%E7%AF%87%EF%BC%88%E4%B8%80%EF%BC%89/ itemprop=mainEntityOfPage><span hidden itemprop=author itemscope itemtype=http://schema.org/Person> <meta content=/static/imgs/avatar.png itemprop=image> <meta content=豪哥 itemprop=name> </span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization> <meta content=豪哥博客 itemprop=name> <meta content=豪哥博客 itemprop=description> </span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork> <meta content="undefined | 豪哥博客" itemprop=name> <meta itemprop=description> </span><header class=post-header><h2 itemprop="name headline" class=post-title><a class=post-title-link href=/2024/08/21/MySQL%E7%BB%8F%E5%85%B8SQL%E7%BB%83%E4%B9%A0%E9%A2%98%E4%B9%8BLeetcode%E7%AF%87%EF%BC%88%E4%B8%80%EF%BC%89/ itemprop=url>MySQL系列-MySQL经典SQL练习题之Leetcode篇（一）</a></h2><div class=post-meta-container><div class=post-meta><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar"></i> </span> <span class=post-meta-item-text>发表于</span> <time itemprop="dateCreated datePublished" title="创建时间：2024-08-21 21:39:14" datetime=2024-08-21T21:39:14+08:00>2024-08-21</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar-check"></i> </span> <span class=post-meta-item-text>更新于</span> <time title="修改时间：2023-09-01 16:41:34" datetime=2023-09-01T16:41:34+08:00 itemprop=dateModified>2023-09-01</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-folder"></i> </span> <span class=post-meta-item-text>分类于</span> <span itemprop=about itemscope itemtype=http://schema.org/Thing> <a href=/categories/MySQL/ itemprop=url rel=index><span itemprop=name>MySQL</span></a> </span> </span></div></div></header><div class=post-body itemprop=articleBody><h1 id=1、练习题><a class=headerlink href=#1、练习题 title=1、练习题></a>1、练习题</h1><h2 id=1-1、-175-组合两个表><a class=headerlink href=#1-1、-175-组合两个表 title=1.1、(175)组合两个表></a>1.1、(175)组合两个表</h2><p>编写一个SQL查询来报告 <code>Person</code> 表中每个人的姓、名、城市和州。如果 <code>personId</code> 的地址不在 <code>Address</code> 表中，则报告为空 <code>null</code> 。<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br></pre><td class=code><pre><span class=line>Person表:</span><br><span class=line><span class=operator>+</span><span class=comment>----------+----------+-----------+</span></span><br><span class=line><span class=operator>|</span> personId <span class=operator>|</span> lastName <span class=operator>|</span> firstName <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>----------+----------+-----------+</span></span><br><span class=line><span class=operator>|</span> <span class=number>1</span>        <span class=operator>|</span> Wang     <span class=operator>|</span> Allen     <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>2</span>        <span class=operator>|</span> Alice    <span class=operator>|</span> Bob       <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>----------+----------+-----------+</span></span><br><span class=line>Address表:</span><br><span class=line><span class=operator>+</span><span class=comment>-----------+----------+---------------+------------+</span></span><br><span class=line><span class=operator>|</span> addressId <span class=operator>|</span> personId <span class=operator>|</span> city          <span class=operator>|</span> state      <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>-----------+----------+---------------+------------+</span></span><br><span class=line><span class=operator>|</span> <span class=number>1</span>         <span class=operator>|</span> <span class=number>2</span>        <span class=operator>|</span> <span class=keyword>New</span> York City <span class=operator>|</span> <span class=keyword>New</span> York   <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>2</span>         <span class=operator>|</span> <span class=number>3</span>        <span class=operator>|</span> Leetcode      <span class=operator>|</span> California <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>-----------+----------+---------------+------------+</span></span><br><span class=line>输出: </span><br><span class=line><span class=operator>+</span><span class=comment>-----------+----------+---------------+----------+</span></span><br><span class=line><span class=operator>|</span> firstName <span class=operator>|</span> lastName <span class=operator>|</span> city          <span class=operator>|</span> state    <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>-----------+----------+---------------+----------+</span></span><br><span class=line><span class=operator>|</span> Allen     <span class=operator>|</span> Wang     <span class=operator>|</span> <span class=keyword>Null</span>          <span class=operator>|</span> <span class=keyword>Null</span>     <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> Bob       <span class=operator>|</span> Alice    <span class=operator>|</span> <span class=keyword>New</span> York City <span class=operator>|</span> <span class=keyword>New</span> York <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>-----------+----------+---------------+----------+</span></span><br><span class=line></span><br><span class=line>#解法<span class=number>1</span>：</span><br><span class=line><span class=keyword>select</span></span><br><span class=line>	p.firstName,</span><br><span class=line>	p.lastName,</span><br><span class=line>	a.city,</span><br><span class=line>	a.state</span><br><span class=line><span class=keyword>from</span> Person <span class=keyword>as</span> p</span><br><span class=line><span class=keyword>left</span> <span class=keyword>join</span> Address <span class=keyword>as</span> a <span class=keyword>on</span> p.personId <span class=operator>=</span> a.personId</span><br></pre></table></figure><h2 id=1-2、-176-第二高的薪水><a class=headerlink href=#1-2、-176-第二高的薪水 title=1.2、(176)第二高的薪水></a>1.2、(176)第二高的薪水</h2><p>查询并返回 <code>Employee</code> 表中第二高的薪水 。如果不存在第二高的薪水，查询应该返回 <code>null(Pandas 则返回 None)</code> 。<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br></pre><td class=code><pre><span class=line>Employee 表：</span><br><span class=line><span class=operator>+</span><span class=comment>----+--------+</span></span><br><span class=line><span class=operator>|</span> id <span class=operator>|</span> salary <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>----+--------+</span></span><br><span class=line><span class=operator>|</span> <span class=number>1</span>  <span class=operator>|</span> <span class=number>100</span>    <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>2</span>  <span class=operator>|</span> <span class=number>200</span>    <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>3</span>  <span class=operator>|</span> <span class=number>300</span>    <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>----+--------+</span></span><br><span class=line>输出：</span><br><span class=line><span class=operator>+</span><span class=comment>---------------------+</span></span><br><span class=line><span class=operator>|</span> SecondHighestSalary <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>---------------------+</span></span><br><span class=line><span class=operator>|</span> <span class=number>200</span>                 <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>---------------------+</span></span><br><span class=line># 解法<span class=number>1</span>：</span><br><span class=line><span class=keyword>select</span></span><br><span class=line>	IF(<span class=built_in>count</span>(<span class=operator>*</span>) <span class=operator>=</span> <span class=number>0</span>, <span class=keyword>null</span>, </span><br><span class=line>	IF(o1.s_level <span class=operator>=</span> <span class=number>2</span>, o1.salary, <span class=keyword>null</span>)) <span class=keyword>as</span> "SecondHighestSalary"</span><br><span class=line><span class=keyword>from</span> (</span><br><span class=line>	<span class=keyword>select</span></span><br><span class=line>		e.<span class=operator>*</span>,</span><br><span class=line>		<span class=built_in>DENSE_RANK</span>() <span class=keyword>over</span> (<span class=keyword>order</span> <span class=keyword>by</span> e.salary <span class=keyword>desc</span>) <span class=keyword>as</span> "s_level"</span><br><span class=line>	<span class=keyword>from</span> Employee <span class=keyword>as</span> e</span><br><span class=line>) <span class=keyword>as</span> o1</span><br><span class=line><span class=keyword>where</span> o1.s_level <span class=operator>=</span> <span class=number>2</span></span><br><span class=line></span><br><span class=line># 解法<span class=number>2</span>：</span><br><span class=line><span class=keyword>SELECT</span> (</span><br><span class=line>   <span class=keyword>SELECT</span> <span class=keyword>DISTINCT</span> salary</span><br><span class=line>   <span class=keyword>FROM</span> Employee e</span><br><span class=line>   <span class=keyword>ORDER</span> <span class=keyword>BY</span> e.salary <span class=keyword>DESC</span></span><br><span class=line>   LIMIT <span class=number>1</span> <span class=keyword>OFFSET</span> <span class=number>1</span></span><br><span class=line>) <span class=keyword>AS</span> SecondHighestSalary;</span><br><span class=line></span><br><span class=line># 解法<span class=number>3</span>：</span><br><span class=line><span class=keyword>SELECT</span> IFNULL(( </span><br><span class=line>     <span class=keyword>SELECT</span> <span class=keyword>DISTINCT</span> salary <span class=keyword>FROM</span> Employee e </span><br><span class=line>     <span class=keyword>ORDER</span> <span class=keyword>BY</span> e.Salary <span class=keyword>DESC</span></span><br><span class=line>     LIMIT <span class=number>1</span> <span class=keyword>OFFSET</span> <span class=number>1</span></span><br><span class=line>   ), <span class=keyword>NULL</span>) <span class=keyword>AS</span> SecondHighestSalary;</span><br></pre></table></figure><h2 id=1-3、-177-第N高的薪水><a class=headerlink href=#1-3、-177-第N高的薪水 title=1.3、(177)第N高的薪水></a>1.3、(177)第N高的薪水</h2><p>查询 <code>Employee</code> 表中第 <code>n</code> 高的工资。如果没有第 <code>n</code> 个最高工资，结果应该为 <code>null</code> 。<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br></pre><td class=code><pre><span class=line>Employee <span class=keyword>table</span>:</span><br><span class=line><span class=operator>+</span><span class=comment>----+--------+</span></span><br><span class=line><span class=operator>|</span> id <span class=operator>|</span> salary <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>----+--------+</span></span><br><span class=line><span class=operator>|</span> <span class=number>1</span>  <span class=operator>|</span> <span class=number>100</span>    <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>2</span>  <span class=operator>|</span> <span class=number>200</span>    <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>3</span>  <span class=operator>|</span> <span class=number>300</span>    <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>----+--------+</span></span><br><span class=line>输出: </span><br><span class=line><span class=operator>+</span><span class=comment>------------------------+</span></span><br><span class=line><span class=operator>|</span> getNthHighestSalary(<span class=number>2</span>) <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>------------------------+</span></span><br><span class=line><span class=operator>|</span> <span class=number>200</span>                    <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>------------------------+</span></span><br><span class=line></span><br><span class=line># 解法<span class=number>1</span>：</span><br><span class=line><span class=keyword>select</span> IFNULL(</span><br><span class=line>    <span class=keyword>select</span> e.salary</span><br><span class=line>    <span class=keyword>from</span> Employee <span class=keyword>as</span> e</span><br><span class=line>    <span class=keyword>order</span> <span class=keyword>by</span> e.salary <span class=keyword>desc</span></span><br><span class=line>    limit (N<span class=number>-1</span>) <span class=keyword>OFFSET</span> <span class=number>1</span></span><br><span class=line>    , <span class=keyword>null</span>) <span class=keyword>as</span> getNthHighestSalary(N)</span><br></pre></table></figure><h2 id=1-4、-178-分数排名><a class=headerlink href=#1-4、-178-分数排名 title=1.4、(178)分数排名></a>1.4、(178)分数排名</h2><p>查询并对分数进行排序。排名按以下规则计算:<ul><li>分数应按从高到低排列。<li>如果两个分数相等，那么两个分数的排名应该相同。<li>在排名相同的分数后，排名数应该是下一个连续的整数。换句话说，排名之间不应该有空缺的数字。</ul><p>按 <code>score</code> 降序返回结果表。<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br></pre><td class=code><pre><span class=line>Scores 表:</span><br><span class=line><span class=operator>+</span><span class=comment>----+-------+</span></span><br><span class=line><span class=operator>|</span> id <span class=operator>|</span> score <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>----+-------+</span></span><br><span class=line><span class=operator>|</span> <span class=number>1</span>  <span class=operator>|</span> <span class=number>3.50</span>  <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>2</span>  <span class=operator>|</span> <span class=number>3.65</span>  <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>3</span>  <span class=operator>|</span> <span class=number>4.00</span>  <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>4</span>  <span class=operator>|</span> <span class=number>3.85</span>  <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>5</span>  <span class=operator>|</span> <span class=number>4.00</span>  <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>6</span>  <span class=operator>|</span> <span class=number>3.65</span>  <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>----+-------+</span></span><br><span class=line>输出: </span><br><span class=line><span class=operator>+</span><span class=comment>-------+------+</span></span><br><span class=line><span class=operator>|</span> score <span class=operator>|</span> rank <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>-------+------+</span></span><br><span class=line><span class=operator>|</span> <span class=number>4.00</span>  <span class=operator>|</span> <span class=number>1</span>    <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>4.00</span>  <span class=operator>|</span> <span class=number>1</span>    <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>3.85</span>  <span class=operator>|</span> <span class=number>2</span>    <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>3.65</span>  <span class=operator>|</span> <span class=number>3</span>    <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>3.65</span>  <span class=operator>|</span> <span class=number>3</span>    <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>3.50</span>  <span class=operator>|</span> <span class=number>4</span>    <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>-------+------+</span></span><br><span class=line></span><br><span class=line># 解法<span class=number>1</span>：</span><br><span class=line><span class=keyword>select</span></span><br><span class=line>	s.score,</span><br><span class=line>	<span class=built_in>DENSE_RANK</span>() <span class=keyword>over</span> (<span class=keyword>order</span> <span class=keyword>by</span> s.score <span class=keyword>desc</span>) <span class=keyword>as</span> "rank"</span><br><span class=line><span class=keyword>from</span> Scores <span class=keyword>as</span> s</span><br></pre></table></figure><h2 id=1-5、-180-连续出现的数字><a class=headerlink href=#1-5、-180-连续出现的数字 title=1.5、(180)连续出现的数字></a>1.5、(180)连续出现的数字</h2><p>编写一个 SQL 查询，查找所有至少连续出现三次的数字。<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br></pre><td class=code><pre><span class=line>Logs 表：</span><br><span class=line><span class=operator>+</span><span class=comment>----+-----+</span></span><br><span class=line><span class=operator>|</span> Id <span class=operator>|</span> Num <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>----+-----+</span></span><br><span class=line><span class=operator>|</span> <span class=number>1</span>  <span class=operator>|</span> <span class=number>1</span>   <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>2</span>  <span class=operator>|</span> <span class=number>1</span>   <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>3</span>  <span class=operator>|</span> <span class=number>1</span>   <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>4</span>  <span class=operator>|</span> <span class=number>2</span>   <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>5</span>  <span class=operator>|</span> <span class=number>1</span>   <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>6</span>  <span class=operator>|</span> <span class=number>2</span>   <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>7</span>  <span class=operator>|</span> <span class=number>2</span>   <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>----+-----+</span></span><br><span class=line>输出：</span><br><span class=line><span class=operator>+</span><span class=comment>-----------------+</span></span><br><span class=line><span class=operator>|</span> ConsecutiveNums <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>-----------------+</span></span><br><span class=line><span class=operator>|</span> <span class=number>1</span>               <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>-----------------+</span></span><br><span class=line># 解法<span class=number>1</span>：</span><br><span class=line><span class=keyword>set</span> <span class=variable>@p</span>:<span class=operator>=</span><span class=number>0</span>;</span><br><span class=line><span class=keyword>set</span> <span class=variable>@q</span>:<span class=operator>=</span><span class=number>0</span>;</span><br><span class=line><span class=keyword>set</span> <span class=variable>@i</span>:<span class=operator>=</span><span class=number>0</span>;</span><br><span class=line><span class=keyword>select</span> o1.Num <span class=keyword>as</span> "ConsecutiveNums"</span><br><span class=line><span class=keyword>from</span> (</span><br><span class=line>	<span class=keyword>select</span></span><br><span class=line>		l.Num,</span><br><span class=line>		<span class=variable>@p</span>:<span class=operator>=</span>l.Num,</span><br><span class=line>		IF(<span class=variable>@p</span><span class=operator>=</span><span class=variable>@q</span>, <span class=variable>@i</span>, <span class=variable>@i</span>:<span class=operator>=</span><span class=variable>@i</span><span class=operator>+</span><span class=number>1</span>) <span class=keyword>as</span> "level",</span><br><span class=line>		<span class=variable>@q</span>:<span class=operator>=</span><span class=variable>@p</span></span><br><span class=line>	<span class=keyword>from</span> Logs <span class=keyword>as</span> l</span><br><span class=line>) <span class=keyword>as</span> o1</span><br><span class=line><span class=keyword>group</span> <span class=keyword>by</span> o1.level</span><br><span class=line><span class=keyword>having</span> <span class=built_in>COUNT</span>(o1.Id) <span class=operator>>=</span> <span class=number>3</span></span><br><span class=line></span><br><span class=line># 解法<span class=number>2</span>：</span><br><span class=line><span class=keyword>select</span> <span class=keyword>DISTINCT</span></span><br><span class=line>	l1.Num <span class=keyword>as</span> "ConsecutiveNums"</span><br><span class=line><span class=keyword>from</span> Logs l1 </span><br><span class=line><span class=keyword>join</span> Logs l2 <span class=keyword>on</span> l1.Id <span class=operator>=</span> l2.Id <span class=operator>-</span> <span class=number>1</span> <span class=keyword>and</span> l1.Num <span class=operator>=</span> l2.Num</span><br><span class=line><span class=keyword>join</span> Logs l3 <span class=keyword>on</span> l2.Id <span class=operator>=</span> l3.Id <span class=operator>-</span> <span class=number>1</span> <span class=keyword>and</span> l2.num <span class=operator>=</span> l3.num</span><br></pre></table></figure><h2 id=1-6、-181-超过经理收入的员工><a class=headerlink href=#1-6、-181-超过经理收入的员工 title=1.6、(181)超过经理收入的员工></a>1.6、(181)超过经理收入的员工</h2><p>编写一个SQL查询来查找收入比经理高的员工。<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br></pre><td class=code><pre><span class=line>Employee 表:</span><br><span class=line><span class=operator>+</span><span class=comment>----+-------+--------+-----------+</span></span><br><span class=line><span class=operator>|</span> id <span class=operator>|</span> name  <span class=operator>|</span> salary <span class=operator>|</span> managerId <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>----+-------+--------+-----------+</span></span><br><span class=line><span class=operator>|</span> <span class=number>1</span>  <span class=operator>|</span> Joe   <span class=operator>|</span> <span class=number>70000</span>  <span class=operator>|</span> <span class=number>3</span>         <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>2</span>  <span class=operator>|</span> Henry <span class=operator>|</span> <span class=number>80000</span>  <span class=operator>|</span> <span class=number>4</span>         <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>3</span>  <span class=operator>|</span> Sam   <span class=operator>|</span> <span class=number>60000</span>  <span class=operator>|</span> <span class=keyword>Null</span>      <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>4</span>  <span class=operator>|</span> Max   <span class=operator>|</span> <span class=number>90000</span>  <span class=operator>|</span> <span class=keyword>Null</span>      <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>----+-------+--------+-----------+</span></span><br><span class=line>输出: </span><br><span class=line><span class=operator>+</span><span class=comment>----------+</span></span><br><span class=line><span class=operator>|</span> Employee <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>----------+</span></span><br><span class=line><span class=operator>|</span> Joe      <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>----------+</span></span><br><span class=line># 解释: Joe 是唯一挣得比经理多的雇员。</span><br><span class=line></span><br><span class=line># 解法<span class=number>1</span>：</span><br><span class=line><span class=keyword>select</span> o1.name <span class=keyword>as</span> "Employee"</span><br><span class=line><span class=keyword>from</span> (</span><br><span class=line>	<span class=keyword>select</span></span><br><span class=line>		e.<span class=operator>*</span>,</span><br><span class=line>		e2.salary <span class=keyword>as</span> "m_s"</span><br><span class=line>	<span class=keyword>from</span> Employee <span class=keyword>as</span> e</span><br><span class=line>	<span class=keyword>left</span> <span class=keyword>join</span> Employee <span class=keyword>as</span> e2 <span class=keyword>on</span> e.managerId <span class=operator>=</span> e2.id</span><br><span class=line>) <span class=keyword>as</span> o1</span><br><span class=line><span class=keyword>where</span> o1.salary <span class=operator>></span> o1.m_s</span><br><span class=line></span><br><span class=line># 解法<span class=number>2</span>：</span><br><span class=line><span class=keyword>SELECT</span> </span><br><span class=line>   e.name <span class=keyword>as</span> Employee</span><br><span class=line><span class=keyword>FROM</span> Employee e</span><br><span class=line><span class=keyword>join</span> Employee e2 <span class=keyword>on</span> e.`ManagerId` <span class=operator>=</span> e2.id </span><br><span class=line>	<span class=keyword>AND</span> e.`salary` <span class=operator>></span> e2.`salary`</span><br></pre></table></figure><h2 id=1-7、-182-查找重复的电子邮箱><a class=headerlink href=#1-7、-182-查找重复的电子邮箱 title=1.7、(182)查找重复的电子邮箱></a>1.7、(182)查找重复的电子邮箱</h2><p>编写一个 SQL 查询来报告所有重复的电子邮件。 请注意，可以保证电子邮件字段不为 NULL。<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br></pre><td class=code><pre><span class=line>Person 表:</span><br><span class=line><span class=operator>+</span><span class=comment>----+---------+</span></span><br><span class=line><span class=operator>|</span> id <span class=operator>|</span> email   <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>----+---------+</span></span><br><span class=line><span class=operator>|</span> <span class=number>1</span>  <span class=operator>|</span> a<span class=variable>@b</span>.com <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>2</span>  <span class=operator>|</span> c<span class=variable>@d</span>.com <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>3</span>  <span class=operator>|</span> a<span class=variable>@b</span>.com <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>----+---------+</span></span><br><span class=line>输出: </span><br><span class=line><span class=operator>+</span><span class=comment>---------+</span></span><br><span class=line><span class=operator>|</span> Email   <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>---------+</span></span><br><span class=line><span class=operator>|</span> a<span class=variable>@b</span>.com <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>---------+</span></span><br><span class=line># 解释: a<span class=variable>@b</span>.com 出现了两次。</span><br><span class=line></span><br><span class=line># 解法<span class=number>1</span>:</span><br><span class=line><span class=keyword>select</span></span><br><span class=line>	p.email <span class=keyword>as</span> "Email"</span><br><span class=line><span class=keyword>from</span> Person <span class=keyword>as</span> p</span><br><span class=line><span class=keyword>group</span> <span class=keyword>by</span> p.email</span><br><span class=line><span class=keyword>having</span> <span class=built_in>count</span>(p.id) <span class=operator>></span> <span class=number>1</span></span><br></pre></table></figure><h2 id=1-8、-183-从不订购的客户><a class=headerlink href=#1-8、-183-从不订购的客户 title=1.8、(183)从不订购的客户></a>1.8、(183)从不订购的客户</h2><p>找出所有从不点任何东西的顾客。<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br></pre><td class=code><pre><span class=line>Customers <span class=keyword>table</span>:</span><br><span class=line><span class=operator>+</span><span class=comment>----+-------+</span></span><br><span class=line><span class=operator>|</span> id <span class=operator>|</span> name  <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>----+-------+</span></span><br><span class=line><span class=operator>|</span> <span class=number>1</span>  <span class=operator>|</span> Joe   <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>2</span>  <span class=operator>|</span> Henry <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>3</span>  <span class=operator>|</span> Sam   <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>4</span>  <span class=operator>|</span> Max   <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>----+-------+</span></span><br><span class=line>Orders <span class=keyword>table</span>:</span><br><span class=line><span class=operator>+</span><span class=comment>----+------------+</span></span><br><span class=line><span class=operator>|</span> id <span class=operator>|</span> customerId <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>----+------------+</span></span><br><span class=line><span class=operator>|</span> <span class=number>1</span>  <span class=operator>|</span> <span class=number>3</span>          <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>2</span>  <span class=operator>|</span> <span class=number>1</span>          <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>----+------------+</span></span><br><span class=line>输出：</span><br><span class=line><span class=operator>+</span><span class=comment>-----------+</span></span><br><span class=line><span class=operator>|</span> Customers <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>-----------+</span></span><br><span class=line><span class=operator>|</span> Henry     <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> Max       <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>-----------+</span></span><br><span class=line></span><br><span class=line># 解法<span class=number>1</span>：</span><br><span class=line><span class=keyword>select</span> c.name <span class=keyword>as</span> "Customers"</span><br><span class=line><span class=keyword>from</span> Customers <span class=keyword>as</span> c</span><br><span class=line><span class=keyword>where</span> c.id <span class=keyword>not</span> <span class=keyword>in</span> (</span><br><span class=line>	<span class=keyword>select</span> customerId <span class=keyword>from</span> Orders</span><br><span class=line>)</span><br></pre></table></figure><h2 id=1-9、-184-部门工资最高的员工><a class=headerlink href=#1-9、-184-部门工资最高的员工 title=1.9、(184)部门工资最高的员工></a>1.9、(184)部门工资最高的员工</h2><p>查找出每个部门中薪资最高的员工。<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br><span class=line>61</span><br><span class=line>62</span><br><span class=line>63</span><br><span class=line>64</span><br><span class=line>65</span><br><span class=line>66</span><br><span class=line>67</span><br><span class=line>68</span><br><span class=line>69</span><br><span class=line>70</span><br><span class=line>71</span><br><span class=line>72</span><br><span class=line>73</span><br><span class=line>74</span><br><span class=line>75</span><br><span class=line>76</span><br><span class=line>77</span><br><span class=line>78</span><br><span class=line>79</span><br><span class=line>80</span><br><span class=line>81</span><br><span class=line>82</span><br><span class=line>83</span><br><span class=line>84</span><br><span class=line>85</span><br><span class=line>86</span><br><span class=line>87</span><br><span class=line>88</span><br><span class=line>89</span><br><span class=line>90</span><br><span class=line>91</span><br><span class=line>92</span><br><span class=line>93</span><br><span class=line>94</span><br><span class=line>95</span><br><span class=line>96</span><br><span class=line>97</span><br><span class=line>98</span><br><span class=line>99</span><br><span class=line>100</span><br><span class=line>101</span><br><span class=line>102</span><br><span class=line>103</span><br><span class=line>104</span><br><span class=line>105</span><br><span class=line>106</span><br><span class=line>107</span><br><span class=line>108</span><br></pre><td class=code><pre><span class=line>Employee 表:</span><br><span class=line><span class=operator>+</span><span class=comment>----+-------+--------+--------------+</span></span><br><span class=line><span class=operator>|</span> id <span class=operator>|</span> name  <span class=operator>|</span> salary <span class=operator>|</span> departmentId <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>----+-------+--------+--------------+</span></span><br><span class=line><span class=operator>|</span> <span class=number>1</span>  <span class=operator>|</span> Joe   <span class=operator>|</span> <span class=number>70000</span>  <span class=operator>|</span> <span class=number>1</span>            <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>2</span>  <span class=operator>|</span> Jim   <span class=operator>|</span> <span class=number>90000</span>  <span class=operator>|</span> <span class=number>1</span>            <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>3</span>  <span class=operator>|</span> Henry <span class=operator>|</span> <span class=number>80000</span>  <span class=operator>|</span> <span class=number>2</span>            <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>4</span>  <span class=operator>|</span> Sam   <span class=operator>|</span> <span class=number>60000</span>  <span class=operator>|</span> <span class=number>2</span>            <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>5</span>  <span class=operator>|</span> Max   <span class=operator>|</span> <span class=number>90000</span>  <span class=operator>|</span> <span class=number>1</span>            <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>----+-------+--------+--------------+</span></span><br><span class=line>Department 表:</span><br><span class=line><span class=operator>+</span><span class=comment>----+-------+</span></span><br><span class=line><span class=operator>|</span> id <span class=operator>|</span> name  <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>----+-------+</span></span><br><span class=line><span class=operator>|</span> <span class=number>1</span>  <span class=operator>|</span> IT    <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>2</span>  <span class=operator>|</span> Sales <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>----+-------+</span></span><br><span class=line>输出：</span><br><span class=line><span class=operator>+</span><span class=comment>------------+----------+--------+</span></span><br><span class=line><span class=operator>|</span> Department <span class=operator>|</span> Employee <span class=operator>|</span> Salary <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>------------+----------+--------+</span></span><br><span class=line><span class=operator>|</span> IT         <span class=operator>|</span> Jim      <span class=operator>|</span> <span class=number>90000</span>  <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> Sales      <span class=operator>|</span> Henry    <span class=operator>|</span> <span class=number>80000</span>  <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> IT         <span class=operator>|</span> Max      <span class=operator>|</span> <span class=number>90000</span>  <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>------------+----------+--------+</span></span><br><span class=line># 解释：Max 和 Jim 在 IT 部门的工资都是最高的，Henry 在销售部的工资最高。</span><br><span class=line></span><br><span class=line># 解法<span class=number>1</span>：</span><br><span class=line><span class=keyword>set</span> <span class=variable>@p1</span>:<span class=operator>=</span><span class=number>0</span>;</span><br><span class=line><span class=keyword>set</span> <span class=variable>@p2</span>:<span class=operator>=</span><span class=number>0</span>;</span><br><span class=line><span class=keyword>set</span> <span class=variable>@q1</span>:<span class=operator>=</span><span class=number>0</span>;</span><br><span class=line><span class=keyword>set</span> <span class=variable>@q2</span>:<span class=operator>=</span><span class=number>0</span>;</span><br><span class=line><span class=keyword>set</span> <span class=variable>@i</span>:<span class=operator>=</span><span class=number>0</span>;</span><br><span class=line><span class=keyword>select</span></span><br><span class=line>	d.name <span class=keyword>as</span> "Department ",</span><br><span class=line>	o3.name <span class=keyword>as</span> "Employee ",</span><br><span class=line>	o3.salary <span class=keyword>as</span> "Salary "</span><br><span class=line><span class=keyword>from</span> s3_dept <span class=keyword>as</span> d</span><br><span class=line><span class=keyword>join</span> (</span><br><span class=line>	<span class=keyword>select</span></span><br><span class=line>		o2.id,</span><br><span class=line>		o2.name,</span><br><span class=line>		o2.salary,</span><br><span class=line>		o2.departmentId</span><br><span class=line>	<span class=keyword>from</span> (</span><br><span class=line>		<span class=keyword>select</span></span><br><span class=line>			o1.id,</span><br><span class=line>			o1.name,</span><br><span class=line>			o1.salary,</span><br><span class=line>			o1.departmentId,</span><br><span class=line>			<span class=variable>@p1</span>:<span class=operator>=</span>o1.departmentId,</span><br><span class=line>			<span class=variable>@p2</span>:<span class=operator>=</span>o1.salary,</span><br><span class=line>			IF(<span class=variable>@p1</span><span class=operator>=</span><span class=variable>@q1</span>, IF(<span class=variable>@p2</span><span class=operator>=</span><span class=variable>@q2</span>, <span class=variable>@i</span>, <span class=variable>@i</span>:<span class=operator>=</span><span class=variable>@i</span><span class=operator>+</span><span class=number>1</span>), <span class=variable>@i</span>:<span class=operator>=</span><span class=number>1</span>) <span class=keyword>as</span> "level",</span><br><span class=line>			<span class=variable>@q1</span>:<span class=operator>=</span><span class=variable>@p1</span>,</span><br><span class=line>			<span class=variable>@q2</span>:<span class=operator>=</span><span class=variable>@p2</span></span><br><span class=line>		<span class=keyword>from</span> (</span><br><span class=line>			<span class=keyword>select</span> e.<span class=operator>*</span></span><br><span class=line>			<span class=keyword>from</span> s3_emp <span class=keyword>as</span> e</span><br><span class=line>			<span class=keyword>order</span> <span class=keyword>by</span> e.departmentId <span class=keyword>asc</span>, e.salary <span class=keyword>desc</span></span><br><span class=line>		) <span class=keyword>as</span> o1</span><br><span class=line>	) <span class=keyword>as</span> o2</span><br><span class=line>	<span class=keyword>where</span> o2.level <span class=operator>=</span> <span class=number>1</span></span><br><span class=line>) <span class=keyword>as</span> o3 <span class=keyword>on</span> d.id <span class=operator>=</span> o3.departmentId</span><br><span class=line></span><br><span class=line># 解法<span class=number>2</span>：</span><br><span class=line><span class=keyword>select</span></span><br><span class=line>	d.name <span class=keyword>as</span> "Department",</span><br><span class=line>	o4.name <span class=keyword>as</span> "Employee",</span><br><span class=line>	o4.salary <span class=keyword>as</span> "Salary"</span><br><span class=line><span class=keyword>from</span> s3_dept <span class=keyword>as</span> d</span><br><span class=line><span class=keyword>join</span> (</span><br><span class=line>	<span class=keyword>select</span></span><br><span class=line>		o2.id,</span><br><span class=line>		o2.name,</span><br><span class=line>		o2.salary,</span><br><span class=line>		o2.departmentId</span><br><span class=line>	<span class=keyword>from</span> (</span><br><span class=line>		<span class=keyword>select</span></span><br><span class=line>			e.<span class=operator>*</span>,</span><br><span class=line>			<span class=built_in>DENSE_RANK</span>() <span class=keyword>over</span> (<span class=keyword>order</span> <span class=keyword>by</span> e.departmentId <span class=keyword>asc</span>, salary <span class=keyword>desc</span>) <span class=keyword>as</span> "level"</span><br><span class=line>		<span class=keyword>from</span> s3_emp <span class=keyword>as</span> e</span><br><span class=line>	) <span class=keyword>as</span> o2 </span><br><span class=line>	<span class=keyword>join</span>  (</span><br><span class=line>		<span class=keyword>select</span></span><br><span class=line>			<span class=built_in>min</span>(o1.level) <span class=keyword>as</span> "level2"</span><br><span class=line>		<span class=keyword>from</span> (</span><br><span class=line>			<span class=keyword>select</span></span><br><span class=line>				e.<span class=operator>*</span>,</span><br><span class=line>				<span class=built_in>DENSE_RANK</span>() <span class=keyword>over</span> (<span class=keyword>order</span> <span class=keyword>by</span> e.departmentId <span class=keyword>asc</span>, salary <span class=keyword>desc</span>) <span class=keyword>as</span> "level"</span><br><span class=line>			<span class=keyword>from</span> s3_emp <span class=keyword>as</span> e</span><br><span class=line>		) <span class=keyword>as</span> o1</span><br><span class=line>		<span class=keyword>group</span> <span class=keyword>by</span> o1.departmentId </span><br><span class=line>	) <span class=keyword>as</span> o3 <span class=keyword>on</span> o2.level <span class=operator>=</span> o3.level2</span><br><span class=line>) <span class=keyword>as</span> o4 <span class=keyword>on</span> d.id <span class=operator>=</span> o4.departmentId</span><br><span class=line><span class=keyword>order</span> <span class=keyword>by</span> o4.id</span><br><span class=line></span><br><span class=line># 解法<span class=number>3</span>：</span><br><span class=line><span class=keyword>select</span></span><br><span class=line>	d.name <span class=keyword>as</span> "Department",</span><br><span class=line>	e.name <span class=keyword>as</span> "Employee ",</span><br><span class=line>	e.salary <span class=keyword>as</span> "Salary " </span><br><span class=line><span class=keyword>from</span> s3_emp <span class=keyword>as</span> e</span><br><span class=line><span class=keyword>join</span> s3_dept <span class=keyword>as</span> d <span class=keyword>on</span> e.departmentId <span class=operator>=</span> d.id</span><br><span class=line><span class=keyword>where</span> (e.departmentId, e.salary) <span class=keyword>in</span> (</span><br><span class=line>	<span class=keyword>select</span> departmentId, <span class=built_in>MAX</span>(salary)</span><br><span class=line>	<span class=keyword>from</span> s3_emp</span><br><span class=line>	<span class=keyword>group</span> <span class=keyword>by</span> departmentId</span><br><span class=line>)</span><br></pre></table></figure><h2 id=1-10、-185-部门工资前三高的所有员工><a class=headerlink href=#1-10、-185-部门工资前三高的所有员工 title=1.10、(185)部门工资前三高的所有员工></a>1.10、(185)部门工资前三高的所有员工</h2><p>公司的主管们感兴趣的是公司每个部门中谁赚的钱最多。一个部门的 <strong>高收入者</strong> 是指一个员工的工资在该部门的 <strong>不同</strong> 工资中 <strong>排名前三</strong> 。<p>编写一个SQL查询，找出每个部门中 <strong>收入高的员工</strong> 。<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br><span class=line>61</span><br><span class=line>62</span><br><span class=line>63</span><br><span class=line>64</span><br><span class=line>65</span><br><span class=line>66</span><br><span class=line>67</span><br><span class=line>68</span><br><span class=line>69</span><br><span class=line>70</span><br><span class=line>71</span><br><span class=line>72</span><br><span class=line>73</span><br><span class=line>74</span><br><span class=line>75</span><br><span class=line>76</span><br><span class=line>77</span><br><span class=line>78</span><br><span class=line>79</span><br></pre><td class=code><pre><span class=line>Employee 表:</span><br><span class=line><span class=operator>+</span><span class=comment>----+-------+--------+--------------+</span></span><br><span class=line><span class=operator>|</span> id <span class=operator>|</span> name  <span class=operator>|</span> salary <span class=operator>|</span> departmentId <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>----+-------+--------+--------------+</span></span><br><span class=line><span class=operator>|</span> <span class=number>1</span>  <span class=operator>|</span> Joe   <span class=operator>|</span> <span class=number>85000</span>  <span class=operator>|</span> <span class=number>1</span>            <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>2</span>  <span class=operator>|</span> Henry <span class=operator>|</span> <span class=number>80000</span>  <span class=operator>|</span> <span class=number>2</span>            <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>3</span>  <span class=operator>|</span> Sam   <span class=operator>|</span> <span class=number>60000</span>  <span class=operator>|</span> <span class=number>2</span>            <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>4</span>  <span class=operator>|</span> Max   <span class=operator>|</span> <span class=number>90000</span>  <span class=operator>|</span> <span class=number>1</span>            <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>5</span>  <span class=operator>|</span> Janet <span class=operator>|</span> <span class=number>69000</span>  <span class=operator>|</span> <span class=number>1</span>            <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>6</span>  <span class=operator>|</span> Randy <span class=operator>|</span> <span class=number>85000</span>  <span class=operator>|</span> <span class=number>1</span>            <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>7</span>  <span class=operator>|</span> Will  <span class=operator>|</span> <span class=number>70000</span>  <span class=operator>|</span> <span class=number>1</span>            <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>----+-------+--------+--------------+</span></span><br><span class=line>Department  表:</span><br><span class=line><span class=operator>+</span><span class=comment>----+-------+</span></span><br><span class=line><span class=operator>|</span> id <span class=operator>|</span> name  <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>----+-------+</span></span><br><span class=line><span class=operator>|</span> <span class=number>1</span>  <span class=operator>|</span> IT    <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>2</span>  <span class=operator>|</span> Sales <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>----+-------+</span></span><br><span class=line>输出: </span><br><span class=line><span class=operator>+</span><span class=comment>------------+----------+--------+</span></span><br><span class=line><span class=operator>|</span> Department <span class=operator>|</span> Employee <span class=operator>|</span> Salary <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>------------+----------+--------+</span></span><br><span class=line><span class=operator>|</span> IT         <span class=operator>|</span> Max      <span class=operator>|</span> <span class=number>90000</span>  <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> IT         <span class=operator>|</span> Joe      <span class=operator>|</span> <span class=number>85000</span>  <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> IT         <span class=operator>|</span> Randy    <span class=operator>|</span> <span class=number>85000</span>  <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> IT         <span class=operator>|</span> Will     <span class=operator>|</span> <span class=number>70000</span>  <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> Sales      <span class=operator>|</span> Henry    <span class=operator>|</span> <span class=number>80000</span>  <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> Sales      <span class=operator>|</span> Sam      <span class=operator>|</span> <span class=number>60000</span>  <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>------------+----------+--------+</span></span><br><span class=line></span><br><span class=line># 解法<span class=number>1</span>：</span><br><span class=line><span class=keyword>select</span></span><br><span class=line>	d.name <span class=keyword>as</span> "Department",</span><br><span class=line>	o3.name <span class=keyword>as</span> "Employee",</span><br><span class=line>	o3.salary <span class=keyword>as</span> "Salary"</span><br><span class=line><span class=keyword>from</span> s3_dept <span class=keyword>as</span> d</span><br><span class=line><span class=keyword>join</span> (</span><br><span class=line>	<span class=keyword>select</span></span><br><span class=line>		o2.name,</span><br><span class=line>		o2.salary,</span><br><span class=line>		o2.departmentId</span><br><span class=line>	<span class=keyword>from</span> (</span><br><span class=line>		<span class=keyword>select</span></span><br><span class=line>			o1.<span class=operator>*</span>,</span><br><span class=line>			<span class=variable>@c1</span>:<span class=operator>=</span>o1.departmentId,</span><br><span class=line>			<span class=variable>@c2</span>:<span class=operator>=</span>o1.salary,</span><br><span class=line>			IF(<span class=variable>@c1</span><span class=operator>=</span><span class=variable>@o1</span>,IF(<span class=variable>@c2</span><span class=operator>=</span><span class=variable>@o2</span>, <span class=variable>@i</span>, <span class=variable>@i</span>:<span class=operator>=</span><span class=variable>@i</span><span class=operator>+</span><span class=number>1</span>), <span class=variable>@i</span>:<span class=operator>=</span><span class=number>1</span>) <span class=keyword>as</span> "level",</span><br><span class=line>			<span class=variable>@o1</span>:<span class=operator>=</span><span class=variable>@c1</span>,</span><br><span class=line>			<span class=variable>@o2</span>:<span class=operator>=</span><span class=variable>@c2</span></span><br><span class=line>		<span class=keyword>from</span> (</span><br><span class=line>			<span class=keyword>select</span></span><br><span class=line>				e.<span class=operator>*</span>,</span><br><span class=line>				<span class=variable>@c1</span>:<span class=operator>=</span><span class=number>0</span>,</span><br><span class=line>				<span class=variable>@c2</span>:<span class=operator>=</span><span class=number>0</span>,</span><br><span class=line>				<span class=variable>@o1</span>:<span class=operator>=</span><span class=number>0</span>,</span><br><span class=line>				<span class=variable>@o2</span>:<span class=operator>=</span><span class=number>0</span>,</span><br><span class=line>				<span class=variable>@i</span>:<span class=operator>=</span><span class=number>0</span></span><br><span class=line>			<span class=keyword>from</span> s3_emp <span class=keyword>as</span> e</span><br><span class=line>			<span class=keyword>order</span> <span class=keyword>by</span> e.departmentId <span class=keyword>asc</span>, e.salary <span class=keyword>desc</span></span><br><span class=line>		) <span class=keyword>as</span> o1</span><br><span class=line>	) <span class=keyword>as</span> o2</span><br><span class=line>	<span class=keyword>where</span> o2.level <span class=operator><=</span> <span class=number>3</span></span><br><span class=line>	<span class=keyword>order</span> <span class=keyword>by</span> o2.id </span><br><span class=line>) <span class=keyword>as</span> o3 <span class=keyword>on</span> d.id <span class=operator>=</span> o3.departmentId</span><br><span class=line></span><br><span class=line># 解法<span class=number>2</span>：</span><br><span class=line><span class=keyword>select</span></span><br><span class=line>	d.name <span class=keyword>as</span> "Department",</span><br><span class=line>	e1.name <span class=keyword>as</span> "Employee",</span><br><span class=line>	e1.salary <span class=keyword>as</span> "Salary"</span><br><span class=line><span class=keyword>from</span> s3_dept <span class=keyword>as</span> d</span><br><span class=line><span class=keyword>join</span> s3_emp <span class=keyword>as</span> e1 <span class=keyword>on</span> d.id<span class=operator>=</span> e1.departmentId</span><br><span class=line><span class=keyword>where</span> <span class=number>3</span> <span class=operator>></span> (</span><br><span class=line>	<span class=keyword>select</span> <span class=built_in>COUNT</span>(<span class=keyword>DISTINCT</span> e2.salary)</span><br><span class=line>	<span class=keyword>from</span> s3_emp <span class=keyword>as</span> e2</span><br><span class=line>	<span class=keyword>where</span> e1.departmentId <span class=operator>=</span> e2.departmentId <span class=keyword>and</span> e2.salary <span class=operator>></span> e1.salary</span><br><span class=line>)</span><br><span class=line><span class=keyword>order</span> <span class=keyword>by</span> d.id <span class=keyword>asc</span></span><br></pre></table></figure><h2 id=1-11、-196-删除重复的电子邮箱><a class=headerlink href=#1-11、-196-删除重复的电子邮箱 title=1.11、(196)删除重复的电子邮箱></a>1.11、(196)删除重复的电子邮箱</h2><p><strong>删除</strong> 所有重复的电子邮件，只保留一个具有最小 <code>id</code> 的唯一电子邮件。<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br></pre><td class=code><pre><span class=line>输入: </span><br><span class=line>Person 表:</span><br><span class=line><span class=operator>+</span><span class=comment>----+------------------+</span></span><br><span class=line><span class=operator>|</span> id <span class=operator>|</span> email            <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>----+------------------+</span></span><br><span class=line><span class=operator>|</span> <span class=number>1</span>  <span class=operator>|</span> john<span class=variable>@example</span>.com <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>2</span>  <span class=operator>|</span> bob<span class=variable>@example</span>.com  <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>3</span>  <span class=operator>|</span> john<span class=variable>@example</span>.com <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>----+------------------+</span></span><br><span class=line>输出: </span><br><span class=line><span class=operator>+</span><span class=comment>----+------------------+</span></span><br><span class=line><span class=operator>|</span> id <span class=operator>|</span> email            <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>----+------------------+</span></span><br><span class=line><span class=operator>|</span> <span class=number>1</span>  <span class=operator>|</span> john<span class=variable>@example</span>.com <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>2</span>  <span class=operator>|</span> bob<span class=variable>@example</span>.com  <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>----+------------------+</span></span><br><span class=line># 解释: john<span class=variable>@example</span>.com重复两次。我们保留最小的Id <span class=operator>=</span> <span class=number>1</span>。</span><br><span class=line></span><br><span class=line># 解法<span class=number>1</span>：</span><br><span class=line><span class=keyword>delete</span> p1</span><br><span class=line><span class=keyword>from</span> s3_person <span class=keyword>as</span> p1, s3_person <span class=keyword>as</span> p2</span><br><span class=line><span class=keyword>where</span> p1.email <span class=operator>=</span> p2.email <span class=keyword>and</span> p1.id <span class=operator>></span> p2.id</span><br><span class=line></span><br><span class=line># 解法<span class=number>2</span>：</span><br><span class=line><span class=keyword>delete</span> p1.<span class=operator>*</span></span><br><span class=line><span class=keyword>from</span> s3_person <span class=keyword>as</span> p1 </span><br><span class=line><span class=keyword>join</span> s3_person <span class=keyword>as</span> p2 </span><br><span class=line><span class=keyword>on</span> p1.email <span class=operator>=</span> p2.email <span class=keyword>and</span> p1.id <span class=operator>></span> p2.id</span><br></pre></table></figure><h2 id=1-12、-197-上升的温度><a class=headerlink href=#1-12、-197-上升的温度 title=1.12、(197)上升的温度></a>1.12、(197)上升的温度</h2><p>编写一个 SQL 查询，来查找与之前（昨天的）日期相比温度更高的所有日期的 <code>id</code> 。<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br></pre><td class=code><pre><span class=line>Weather 表：</span><br><span class=line><span class=operator>+</span><span class=comment>----+------------+-------------+</span></span><br><span class=line><span class=operator>|</span> id <span class=operator>|</span> recordDate <span class=operator>|</span> Temperature <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>----+------------+-------------+</span></span><br><span class=line><span class=operator>|</span> <span class=number>1</span>  <span class=operator>|</span> <span class=number>2015</span><span class=number>-01</span><span class=number>-01</span> <span class=operator>|</span> <span class=number>10</span>          <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>2</span>  <span class=operator>|</span> <span class=number>2015</span><span class=number>-01</span><span class=number>-02</span> <span class=operator>|</span> <span class=number>25</span>          <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>3</span>  <span class=operator>|</span> <span class=number>2015</span><span class=number>-01</span><span class=number>-03</span> <span class=operator>|</span> <span class=number>20</span>          <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>4</span>  <span class=operator>|</span> <span class=number>2015</span><span class=number>-01</span><span class=number>-04</span> <span class=operator>|</span> <span class=number>30</span>          <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>----+------------+-------------+</span></span><br><span class=line>输出：</span><br><span class=line><span class=operator>+</span><span class=comment>----+</span></span><br><span class=line><span class=operator>|</span> id <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>----+</span></span><br><span class=line><span class=operator>|</span> <span class=number>2</span>  <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>4</span>  <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>----+</span></span><br><span class=line># 解释：</span><br><span class=line><span class=number>2015</span><span class=number>-01</span><span class=number>-02</span> 的温度比前一天高（<span class=number>10</span> <span class=operator>-</span><span class=operator>></span> <span class=number>25</span>）</span><br><span class=line><span class=number>2015</span><span class=number>-01</span><span class=number>-04</span> 的温度比前一天高（<span class=number>20</span> <span class=operator>-</span><span class=operator>></span> <span class=number>30</span>）</span><br><span class=line></span><br><span class=line># 解法<span class=number>1</span>：</span><br><span class=line><span class=keyword>select</span></span><br><span class=line>	o2.id</span><br><span class=line><span class=keyword>from</span> (</span><br><span class=line>	<span class=keyword>select</span></span><br><span class=line>		o1.id,</span><br><span class=line>		o1.recordDate,</span><br><span class=line>		o1.Temperature,</span><br><span class=line>		<span class=variable>@cd</span>:<span class=operator>=</span>o1.recordDate,</span><br><span class=line>		<span class=variable>@ct</span>:<span class=operator>=</span>o1.Temperature,</span><br><span class=line>		IF(<span class=built_in>abs</span>(DATEDIFF(<span class=variable>@od</span>, <span class=variable>@cd</span>)) <span class=operator>=</span> <span class=number>1</span>,<span class=number>11</span>,<span class=number>22</span>) <span class=keyword>as</span> "tmp",</span><br><span class=line>		IF(<span class=built_in>abs</span>(DATEDIFF(<span class=variable>@od</span>, <span class=variable>@cd</span>)) <span class=operator>=</span> <span class=number>1</span>, IF(<span class=variable>@ct</span> <span class=operator>></span> <span class=variable>@ot</span>, <span class=variable>@v</span>:<span class=operator>=</span><span class=variable>@v</span><span class=operator>+</span><span class=number>1</span>, <span class=variable>@v</span>:<span class=operator>=</span><span class=number>1</span>), <span class=variable>@v</span>:<span class=operator>=</span><span class=number>1</span>) <span class=keyword>as</span> "level",</span><br><span class=line>		<span class=variable>@od</span>:<span class=operator>=</span><span class=variable>@cd</span>,</span><br><span class=line>		<span class=variable>@ot</span>:<span class=operator>=</span><span class=variable>@ct</span></span><br><span class=line>	<span class=keyword>from</span> (</span><br><span class=line>		<span class=keyword>select</span></span><br><span class=line>			w.<span class=operator>*</span>,</span><br><span class=line>			<span class=variable>@od</span>:<span class=operator>=</span>"1000-01-01",</span><br><span class=line>			<span class=variable>@cd</span>:<span class=operator>=</span>"1000-01-01",</span><br><span class=line>			<span class=variable>@ot</span>:<span class=operator>=</span><span class=number>0</span>,</span><br><span class=line>			<span class=variable>@ct</span>:<span class=operator>=</span><span class=number>0</span>,</span><br><span class=line>			<span class=variable>@v</span>:<span class=operator>=</span><span class=number>0</span></span><br><span class=line>		<span class=keyword>from</span> s3_weather <span class=keyword>as</span> w</span><br><span class=line>		<span class=keyword>order</span> <span class=keyword>by</span> w.recordDate <span class=keyword>asc</span></span><br><span class=line>	) <span class=keyword>as</span> o1</span><br><span class=line>) <span class=keyword>as</span> o2</span><br><span class=line><span class=keyword>where</span> o2.level <span class=operator>=</span> <span class=number>2</span></span><br><span class=line></span><br><span class=line># 解法<span class=number>2</span>：</span><br><span class=line><span class=keyword>select</span> w.id</span><br><span class=line><span class=keyword>from</span> s3_weather <span class=keyword>as</span> w</span><br><span class=line><span class=keyword>join</span> S3_weather <span class=keyword>as</span> w2 </span><br><span class=line>	<span class=keyword>on</span> w.recordDate <span class=operator>=</span> DATE_ADD(w2.recordDate, <span class=type>INTERVAL</span> <span class=number>1</span> <span class=keyword>DAY</span>)</span><br><span class=line>		<span class=keyword>and</span> w.temperature <span class=operator>></span> w2.temperature</span><br></pre></table></figure><h2 id=1-13、-262-行程和用户><a class=headerlink href=#1-13、-262-行程和用户 title=1.13、(262)行程和用户></a>1.13、(262)行程和用户</h2><p><strong>取消率</strong> 计算方式：(被司机或乘客取消的非禁止用户生成的订单数量) / (非禁止用户生成的订单总数)。<p>写一段 SQL 语句查出 <code>"2013-10-01"</code> 至 <code>"2013-10-03"</code> 期间非禁止用户（<strong>乘客和司机都必须未被禁止</strong>）的取消率。非禁止用户即 banned 为 No 的用户，禁止用户即 banned 为 Yes 的用户。<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br><span class=line>61</span><br><span class=line>62</span><br><span class=line>63</span><br><span class=line>64</span><br></pre><td class=code><pre><span class=line>Trips 表：</span><br><span class=line><span class=operator>+</span><span class=comment>----+-----------+-----------+---------+---------------------+------------+</span></span><br><span class=line><span class=operator>|</span> id <span class=operator>|</span> client_id <span class=operator>|</span> driver_id <span class=operator>|</span> city_id <span class=operator>|</span> status              <span class=operator>|</span> request_at <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>----+-----------+-----------+---------+---------------------+------------+</span></span><br><span class=line><span class=operator>|</span> <span class=number>1</span>  <span class=operator>|</span> <span class=number>1</span>         <span class=operator>|</span> <span class=number>10</span>        <span class=operator>|</span> <span class=number>1</span>       <span class=operator>|</span> completed           <span class=operator>|</span> <span class=number>2013</span><span class=number>-10</span><span class=number>-01</span> <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>2</span>  <span class=operator>|</span> <span class=number>2</span>         <span class=operator>|</span> <span class=number>11</span>        <span class=operator>|</span> <span class=number>1</span>       <span class=operator>|</span> cancelled_by_driver <span class=operator>|</span> <span class=number>2013</span><span class=number>-10</span><span class=number>-01</span> <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>3</span>  <span class=operator>|</span> <span class=number>3</span>         <span class=operator>|</span> <span class=number>12</span>        <span class=operator>|</span> <span class=number>6</span>       <span class=operator>|</span> completed           <span class=operator>|</span> <span class=number>2013</span><span class=number>-10</span><span class=number>-01</span> <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>4</span>  <span class=operator>|</span> <span class=number>4</span>         <span class=operator>|</span> <span class=number>13</span>        <span class=operator>|</span> <span class=number>6</span>       <span class=operator>|</span> cancelled_by_client <span class=operator>|</span> <span class=number>2013</span><span class=number>-10</span><span class=number>-01</span> <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>5</span>  <span class=operator>|</span> <span class=number>1</span>         <span class=operator>|</span> <span class=number>10</span>        <span class=operator>|</span> <span class=number>1</span>       <span class=operator>|</span> completed           <span class=operator>|</span> <span class=number>2013</span><span class=number>-10</span><span class=number>-02</span> <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>6</span>  <span class=operator>|</span> <span class=number>2</span>         <span class=operator>|</span> <span class=number>11</span>        <span class=operator>|</span> <span class=number>6</span>       <span class=operator>|</span> completed           <span class=operator>|</span> <span class=number>2013</span><span class=number>-10</span><span class=number>-02</span> <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>7</span>  <span class=operator>|</span> <span class=number>3</span>         <span class=operator>|</span> <span class=number>12</span>        <span class=operator>|</span> <span class=number>6</span>       <span class=operator>|</span> completed           <span class=operator>|</span> <span class=number>2013</span><span class=number>-10</span><span class=number>-02</span> <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>8</span>  <span class=operator>|</span> <span class=number>2</span>         <span class=operator>|</span> <span class=number>12</span>        <span class=operator>|</span> <span class=number>12</span>      <span class=operator>|</span> completed           <span class=operator>|</span> <span class=number>2013</span><span class=number>-10</span><span class=number>-03</span> <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>9</span>  <span class=operator>|</span> <span class=number>3</span>         <span class=operator>|</span> <span class=number>10</span>        <span class=operator>|</span> <span class=number>12</span>      <span class=operator>|</span> completed           <span class=operator>|</span> <span class=number>2013</span><span class=number>-10</span><span class=number>-03</span> <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>10</span> <span class=operator>|</span> <span class=number>4</span>         <span class=operator>|</span> <span class=number>13</span>        <span class=operator>|</span> <span class=number>12</span>      <span class=operator>|</span> cancelled_by_driver <span class=operator>|</span> <span class=number>2013</span><span class=number>-10</span><span class=number>-03</span> <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>----+-----------+-----------+---------+---------------------+------------+</span></span><br><span class=line>Users 表：</span><br><span class=line><span class=operator>+</span><span class=comment>----------+--------+--------+</span></span><br><span class=line><span class=operator>|</span> users_id <span class=operator>|</span> banned <span class=operator>|</span> role   <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>----------+--------+--------+</span></span><br><span class=line><span class=operator>|</span> <span class=number>1</span>        <span class=operator>|</span> <span class=keyword>No</span>     <span class=operator>|</span> client <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>2</span>        <span class=operator>|</span> Yes    <span class=operator>|</span> client <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>3</span>        <span class=operator>|</span> <span class=keyword>No</span>     <span class=operator>|</span> client <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>4</span>        <span class=operator>|</span> <span class=keyword>No</span>     <span class=operator>|</span> client <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>10</span>       <span class=operator>|</span> <span class=keyword>No</span>     <span class=operator>|</span> driver <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>11</span>       <span class=operator>|</span> <span class=keyword>No</span>     <span class=operator>|</span> driver <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>12</span>       <span class=operator>|</span> <span class=keyword>No</span>     <span class=operator>|</span> driver <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>13</span>       <span class=operator>|</span> <span class=keyword>No</span>     <span class=operator>|</span> driver <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>----------+--------+--------+</span></span><br><span class=line>输出：</span><br><span class=line><span class=operator>+</span><span class=comment>------------+-------------------+</span></span><br><span class=line><span class=operator>|</span> <span class=keyword>Day</span>        <span class=operator>|</span> Cancellation Rate <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>------------+-------------------+</span></span><br><span class=line><span class=operator>|</span> <span class=number>2013</span><span class=number>-10</span><span class=number>-01</span> <span class=operator>|</span> <span class=number>0.33</span>              <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>2013</span><span class=number>-10</span><span class=number>-02</span> <span class=operator>|</span> <span class=number>0.00</span>              <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>2013</span><span class=number>-10</span><span class=number>-03</span> <span class=operator>|</span> <span class=number>0.50</span>              <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>------------+-------------------+</span></span><br><span class=line></span><br><span class=line># 解法<span class=number>1</span>：</span><br><span class=line><span class=keyword>select</span></span><br><span class=line>	t.request_at <span class=keyword>as</span> "Day",</span><br><span class=line>	ROUND(<span class=built_in>SUM</span>(IF(t.status <span class=operator>=</span> "completed", <span class=number>0</span>, <span class=number>1</span>)) <span class=operator>/</span> <span class=built_in>count</span>(t.status), <span class=number>2</span>) <span class=keyword>as</span> "Cancellation Rate"</span><br><span class=line><span class=keyword>from</span> trips <span class=keyword>as</span> t</span><br><span class=line><span class=keyword>where</span> t.client_id <span class=keyword>not</span> <span class=keyword>in</span>(</span><br><span class=line>	<span class=keyword>select</span> users_id <span class=keyword>from</span> users <span class=keyword>where</span> banned <span class=operator>=</span> "yes"</span><br><span class=line>) <span class=keyword>and</span> t.driver_id <span class=keyword>not</span> <span class=keyword>in</span>(</span><br><span class=line>	<span class=keyword>select</span> users_id <span class=keyword>from</span> users <span class=keyword>where</span> banned <span class=operator>=</span> "yes"</span><br><span class=line>) <span class=keyword>and</span> t.request_at <span class=keyword>BETWEEN</span> "2013-10-01" <span class=keyword>and</span> "2013-10-03"</span><br><span class=line><span class=keyword>group</span> <span class=keyword>by</span> t.request_at</span><br><span class=line></span><br><span class=line># 解法<span class=number>2</span>：</span><br><span class=line><span class=keyword>select</span></span><br><span class=line>	t.request_at <span class=keyword>as</span> "Day",</span><br><span class=line>	ROUND(<span class=built_in>SUM</span>(IF(t.status <span class=operator>=</span> "completed", <span class=number>0</span>, <span class=number>1</span>)) <span class=operator>/</span> <span class=built_in>count</span>(t.status), <span class=number>2</span>) <span class=keyword>as</span> "`Cancellation Rate`"</span><br><span class=line><span class=keyword>from</span> trips <span class=keyword>as</span> t</span><br><span class=line><span class=keyword>left</span> <span class=keyword>join</span> (</span><br><span class=line>	<span class=keyword>select</span> users_id <span class=keyword>from</span> users <span class=keyword>where</span> banned <span class=operator>=</span> "yes"</span><br><span class=line>) <span class=keyword>as</span> o1 <span class=keyword>on</span> t.client_id <span class=operator>=</span> o1.users_id</span><br><span class=line><span class=keyword>left</span> <span class=keyword>join</span> (</span><br><span class=line>	<span class=keyword>select</span> users_id <span class=keyword>from</span> users <span class=keyword>where</span> banned <span class=operator>=</span> "yes"</span><br><span class=line>) <span class=keyword>as</span> o2 <span class=keyword>on</span> t.driver_id <span class=operator>=</span> o2.users_id</span><br><span class=line><span class=keyword>where</span> o1.users_id <span class=keyword>is</span> <span class=keyword>null</span> </span><br><span class=line>	<span class=keyword>and</span> o2.users_id <span class=keyword>is</span> <span class=keyword>null</span> </span><br><span class=line>	<span class=keyword>and</span> t.request_at <span class=keyword>BETWEEN</span> "2013-10-01" <span class=keyword>and</span> "2013-10-03"</span><br><span class=line><span class=keyword>group</span> <span class=keyword>by</span> t.request_at </span><br></pre></table></figure><h2 id=1-14、-511-游戏玩法分析1><a class=headerlink href=#1-14、-511-游戏玩法分析1 title=1.14、(511)游戏玩法分析1></a>1.14、(511)游戏玩法分析1</h2><p>查询每位玩家 <strong>第一次登陆平台的日期</strong>。<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br></pre><td class=code><pre><span class=line>Activity 表：</span><br><span class=line><span class=operator>+</span><span class=comment>-----------+-----------+------------+--------------+</span></span><br><span class=line><span class=operator>|</span> player_id <span class=operator>|</span> device_id <span class=operator>|</span> event_date <span class=operator>|</span> games_played <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>-----------+-----------+------------+--------------+</span></span><br><span class=line><span class=operator>|</span> <span class=number>1</span>         <span class=operator>|</span> <span class=number>2</span>         <span class=operator>|</span> <span class=number>2016</span><span class=number>-03</span><span class=number>-01</span> <span class=operator>|</span> <span class=number>5</span>            <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>1</span>         <span class=operator>|</span> <span class=number>2</span>         <span class=operator>|</span> <span class=number>2016</span><span class=number>-05</span><span class=number>-02</span> <span class=operator>|</span> <span class=number>6</span>            <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>2</span>         <span class=operator>|</span> <span class=number>3</span>         <span class=operator>|</span> <span class=number>2017</span><span class=number>-06</span><span class=number>-25</span> <span class=operator>|</span> <span class=number>1</span>            <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>3</span>         <span class=operator>|</span> <span class=number>1</span>         <span class=operator>|</span> <span class=number>2016</span><span class=number>-03</span><span class=number>-02</span> <span class=operator>|</span> <span class=number>0</span>            <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>3</span>         <span class=operator>|</span> <span class=number>4</span>         <span class=operator>|</span> <span class=number>2018</span><span class=number>-07</span><span class=number>-03</span> <span class=operator>|</span> <span class=number>5</span>            <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>-----------+-----------+------------+--------------+</span></span><br><span class=line><span class=keyword>Result</span> 表：</span><br><span class=line><span class=operator>+</span><span class=comment>-----------+-------------+</span></span><br><span class=line><span class=operator>|</span> player_id <span class=operator>|</span> first_login <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>-----------+-------------+</span></span><br><span class=line><span class=operator>|</span> <span class=number>1</span>         <span class=operator>|</span> <span class=number>2016</span><span class=number>-03</span><span class=number>-01</span>  <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>2</span>         <span class=operator>|</span> <span class=number>2017</span><span class=number>-06</span><span class=number>-25</span>  <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>3</span>         <span class=operator>|</span> <span class=number>2016</span><span class=number>-03</span><span class=number>-02</span>  <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>-----------+-------------+</span></span><br><span class=line></span><br><span class=line># 解法<span class=number>1</span>：</span><br><span class=line><span class=keyword>select</span></span><br><span class=line>	a.player_id,</span><br><span class=line>	<span class=built_in>min</span>(a.event_date) <span class=keyword>as</span> "d"</span><br><span class=line><span class=keyword>from</span> Activity <span class=keyword>as</span> a</span><br><span class=line><span class=keyword>group</span> <span class=keyword>by</span> a.player_id</span><br></pre></table></figure><h2 id=1-15、-550-游戏玩法分析4><a class=headerlink href=#1-15、-550-游戏玩法分析4 title=1.15、(550)游戏玩法分析4></a>1.15、(550)游戏玩法分析4</h2><p>编写一个 SQL 查询，报告在首次登录的第二天再次登录的玩家的比率，四舍五入到小数点后两位。换句话说，您需要计算从首次登录日期开始至少连续两天登录的玩家的数量，然后除以玩家总数。<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br></pre><td class=code><pre><span class=line># 解法<span class=number>1</span>：</span><br><span class=line><span class=keyword>select</span></span><br><span class=line>	ROUND(<span class=built_in>AVG</span>(a2.event_date <span class=keyword>is</span> <span class=keyword>not</span> <span class=keyword>null</span>), <span class=number>2</span>)</span><br><span class=line><span class=keyword>from</span> (</span><br><span class=line>	<span class=keyword>select</span> </span><br><span class=line>		a.player_id,</span><br><span class=line>		<span class=built_in>min</span>(a.event_date) <span class=keyword>as</span> "firstL" </span><br><span class=line>	<span class=keyword>from</span> s3_activity <span class=keyword>as</span> a</span><br><span class=line>	<span class=keyword>group</span> <span class=keyword>by</span> a.player_id</span><br><span class=line>) <span class=keyword>as</span> o1</span><br><span class=line><span class=keyword>left</span> <span class=keyword>join</span> s3_activity <span class=keyword>as</span> a2 <span class=keyword>on</span> o1.player_id <span class=operator>=</span> a2.player_id <span class=keyword>and</span> DATEDIFF(a2.event_date, o1.firstL) <span class=operator>=</span> <span class=number>1</span></span><br><span class=line></span><br><span class=line># 解法<span class=number>2</span>：</span><br><span class=line><span class=keyword>select</span> </span><br><span class=line>	round(o3.p_count <span class=operator>/</span> (<span class=keyword>select</span> <span class=built_in>count</span>(<span class=keyword>DISTINCT</span> a.player_id) <span class=keyword>from</span> s3_activity <span class=keyword>as</span> a), <span class=number>2</span>) <span class=keyword>as</span> "fraction"</span><br><span class=line><span class=keyword>from</span> (</span><br><span class=line>	<span class=keyword>select</span> </span><br><span class=line>		<span class=built_in>count</span>(<span class=keyword>DISTINCT</span> o2.player_id) <span class=keyword>as</span> "p_count"</span><br><span class=line>	<span class=keyword>from</span> (</span><br><span class=line>		<span class=keyword>select</span></span><br><span class=line>			o1.<span class=operator>*</span>,</span><br><span class=line>			<span class=variable>@op</span>:<span class=operator>=</span>o1.player_id,</span><br><span class=line>			<span class=variable>@cp</span>:<span class=operator>=</span>o1.player_id,</span><br><span class=line>			<span class=variable>@cd</span>:<span class=operator>=</span>o1.event_date,</span><br><span class=line>			IF(<span class=variable>@cp</span><span class=operator>=</span><span class=variable>@op</span> <span class=operator>||</span> (<span class=variable>@t</span>:<span class=operator>=</span><span class=number>0</span>)<span class=operator>!=</span><span class=number>0</span>, IF(<span class=built_in>abs</span>(DATEDIFF(<span class=variable>@od</span>, <span class=variable>@cd</span>))<span class=operator>=</span><span class=number>1</span> <span class=operator>||</span> (<span class=variable>@t</span>:<span class=operator>=</span><span class=number>1</span>)<span class=operator>!=</span><span class=number>1</span>, IF(<span class=variable>@t</span><span class=operator>=</span><span class=number>0</span>,<span class=variable>@v</span>:<span class=operator>=</span><span class=variable>@v</span><span class=operator>+</span><span class=number>1</span>,<span class=number>0</span>), <span class=variable>@v</span>:<span class=operator>=</span><span class=number>1</span>), <span class=variable>@v</span>:<span class=operator>=</span><span class=number>1</span>) <span class=keyword>as</span> "level",</span><br><span class=line>			<span class=variable>@op</span>:<span class=operator>=</span><span class=variable>@cp</span>,</span><br><span class=line>			<span class=variable>@od</span>:<span class=operator>=</span><span class=variable>@cd</span></span><br><span class=line>		<span class=keyword>from</span> (</span><br><span class=line>			<span class=keyword>select</span></span><br><span class=line>				a.<span class=operator>*</span>,</span><br><span class=line>				<span class=variable>@op</span>:<span class=operator>=</span><span class=number>0</span>,</span><br><span class=line>				<span class=variable>@cp</span>:<span class=operator>=</span><span class=number>0</span>,</span><br><span class=line>				<span class=variable>@od</span>:<span class=operator>=</span>"1000-01-01",</span><br><span class=line>				<span class=variable>@cd</span>:<span class=operator>=</span>"1000-01-01",</span><br><span class=line>				<span class=variable>@v</span>:<span class=operator>=</span><span class=number>0</span>,</span><br><span class=line>				<span class=variable>@t</span>:<span class=operator>=</span><span class=number>0</span></span><br><span class=line>			<span class=keyword>from</span> s3_activity <span class=keyword>as</span> a</span><br><span class=line>			<span class=keyword>order</span> <span class=keyword>by</span> a.player_id <span class=keyword>asc</span>, a.event_date <span class=keyword>asc</span></span><br><span class=line>		) <span class=keyword>as</span> o1</span><br><span class=line>	) <span class=keyword>as</span> o2</span><br><span class=line>	<span class=keyword>where</span> o2.level <span class=operator>=</span> <span class=number>2</span></span><br><span class=line>) <span class=keyword>as</span> o3</span><br></pre></table></figure><h2 id=1-16、-570-至少有5名直接下属的经理><a class=headerlink href=#1-16、-570-至少有5名直接下属的经理 title=1.16、(570)至少有5名直接下属的经理></a>1.16、(570)至少有5名直接下属的经理</h2><p>查询<strong>至少有5名直接下属</strong>的经理 。<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br></pre><td class=code><pre><span class=line>Employee 表:</span><br><span class=line><span class=operator>+</span><span class=comment>-----+-------+------------+-----------+</span></span><br><span class=line><span class=operator>|</span> id  <span class=operator>|</span> name  <span class=operator>|</span> department <span class=operator>|</span> managerId <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>-----+-------+------------+-----------+</span></span><br><span class=line><span class=operator>|</span> <span class=number>101</span> <span class=operator>|</span> John  <span class=operator>|</span> A          <span class=operator>|</span> <span class=keyword>None</span>      <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>102</span> <span class=operator>|</span> Dan   <span class=operator>|</span> A          <span class=operator>|</span> <span class=number>101</span>       <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>103</span> <span class=operator>|</span> James <span class=operator>|</span> A          <span class=operator>|</span> <span class=number>101</span>       <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>104</span> <span class=operator>|</span> Amy   <span class=operator>|</span> A          <span class=operator>|</span> <span class=number>101</span>       <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>105</span> <span class=operator>|</span> Anne  <span class=operator>|</span> A          <span class=operator>|</span> <span class=number>101</span>       <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>106</span> <span class=operator>|</span> Ron   <span class=operator>|</span> B          <span class=operator>|</span> <span class=number>101</span>       <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>-----+-------+------------+-----------+</span></span><br><span class=line>输出: </span><br><span class=line><span class=operator>+</span><span class=comment>------+</span></span><br><span class=line><span class=operator>|</span> name <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>------+</span></span><br><span class=line><span class=operator>|</span> John <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>------+</span></span><br><span class=line></span><br><span class=line># 解法<span class=number>1</span>：</span><br><span class=line><span class=keyword>select</span></span><br><span class=line>	e2.name</span><br><span class=line><span class=keyword>from</span> Employee <span class=keyword>as</span> e2</span><br><span class=line><span class=keyword>join</span> (</span><br><span class=line>	<span class=keyword>select</span> e.managerId</span><br><span class=line>	<span class=keyword>from</span> Employee <span class=keyword>as</span> e</span><br><span class=line>	<span class=keyword>group</span> <span class=keyword>by</span> e.managerId</span><br><span class=line>	<span class=keyword>having</span> <span class=built_in>count</span>(e.id) <span class=operator>>=</span> <span class=number>5</span></span><br><span class=line>) <span class=keyword>as</span> o1 <span class=keyword>on</span> e2.id <span class=operator>=</span> o1.managerId</span><br></pre></table></figure><h2 id=1-17、-577-员工奖金><a class=headerlink href=#1-17、-577-员工奖金 title=1.17、(577)员工奖金></a>1.17、(577)员工奖金</h2><p>选出所有 bonus < 1000 的员工的 name 及其 bonus。<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br></pre><td class=code><pre><span class=line>Employee表</span><br><span class=line><span class=operator>+</span><span class=comment>-------+--------+-----------+--------+</span></span><br><span class=line><span class=operator>|</span> empId <span class=operator>|</span>  name  <span class=operator>|</span> supervisor<span class=operator>|</span> salary <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>-------+--------+-----------+--------+</span></span><br><span class=line><span class=operator>|</span>   <span class=number>1</span>   <span class=operator>|</span> John   <span class=operator>|</span>  <span class=number>3</span>        <span class=operator>|</span> <span class=number>1000</span>   <span class=operator>|</span></span><br><span class=line><span class=operator>|</span>   <span class=number>2</span>   <span class=operator>|</span> Dan    <span class=operator>|</span>  <span class=number>3</span>        <span class=operator>|</span> <span class=number>2000</span>   <span class=operator>|</span></span><br><span class=line><span class=operator>|</span>   <span class=number>3</span>   <span class=operator>|</span> Brad   <span class=operator>|</span>  <span class=keyword>null</span>     <span class=operator>|</span> <span class=number>4000</span>   <span class=operator>|</span></span><br><span class=line><span class=operator>|</span>   <span class=number>4</span>   <span class=operator>|</span> Thomas <span class=operator>|</span>  <span class=number>3</span>        <span class=operator>|</span> <span class=number>4000</span>   <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>-------+--------+-----------+--------+</span></span><br><span class=line>Bonus 表单</span><br><span class=line><span class=operator>+</span><span class=comment>-------+-------+</span></span><br><span class=line><span class=operator>|</span> empId <span class=operator>|</span> bonus <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>-------+-------+</span></span><br><span class=line><span class=operator>|</span> <span class=number>2</span>     <span class=operator>|</span> <span class=number>500</span>   <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>4</span>     <span class=operator>|</span> <span class=number>2000</span>  <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>-------+-------+</span></span><br><span class=line>输出示例：</span><br><span class=line><span class=operator>+</span><span class=comment>-------+-------+</span></span><br><span class=line><span class=operator>|</span> name  <span class=operator>|</span> bonus <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>-------+-------+</span></span><br><span class=line><span class=operator>|</span> John  <span class=operator>|</span> <span class=keyword>null</span>  <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> Dan   <span class=operator>|</span> <span class=number>500</span>   <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> Brad  <span class=operator>|</span> <span class=keyword>null</span>  <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>-------+-------+</span></span><br><span class=line></span><br><span class=line># 解法<span class=number>1</span>：</span><br><span class=line><span class=keyword>select</span></span><br><span class=line>	e.name, </span><br><span class=line>	b.bonus</span><br><span class=line><span class=keyword>from</span> Employee <span class=keyword>as</span> e</span><br><span class=line><span class=keyword>left</span> <span class=keyword>join</span> Bonus <span class=keyword>as</span> b <span class=keyword>on</span> e.empId <span class=operator>=</span> b.empId</span><br><span class=line><span class=keyword>where</span> b.bonus <span class=operator><</span> <span class=number>1000</span> <span class=keyword>or</span> b.bonus <span class=keyword>is</span> <span class=keyword>null</span></span><br></pre></table></figure><h2 id=1-18、-584-寻找用户推荐人><a class=headerlink href=#1-18、-584-寻找用户推荐人 title=1.18、(584)寻找用户推荐人></a>1.18、(584)寻找用户推荐人</h2><p>找出那些 <strong>没有被</strong> <code>id = 2</code> 的客户 <strong>推荐</strong> 的客户的姓名。<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br></pre><td class=code><pre><span class=line>customer表</span><br><span class=line><span class=operator>+</span><span class=comment>------+------+-----------+</span></span><br><span class=line><span class=operator>|</span> id   <span class=operator>|</span> name <span class=operator>|</span> referee_id<span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>------+------+-----------+</span></span><br><span class=line><span class=operator>|</span>    <span class=number>1</span> <span class=operator>|</span> Will <span class=operator>|</span>      <span class=keyword>NULL</span> <span class=operator>|</span></span><br><span class=line><span class=operator>|</span>    <span class=number>2</span> <span class=operator>|</span> Jane <span class=operator>|</span>      <span class=keyword>NULL</span> <span class=operator>|</span></span><br><span class=line><span class=operator>|</span>    <span class=number>3</span> <span class=operator>|</span> Alex <span class=operator>|</span>         <span class=number>2</span> <span class=operator>|</span></span><br><span class=line><span class=operator>|</span>    <span class=number>4</span> <span class=operator>|</span> Bill <span class=operator>|</span>      <span class=keyword>NULL</span> <span class=operator>|</span></span><br><span class=line><span class=operator>|</span>    <span class=number>5</span> <span class=operator>|</span> Zack <span class=operator>|</span>         <span class=number>1</span> <span class=operator>|</span></span><br><span class=line><span class=operator>|</span>    <span class=number>6</span> <span class=operator>|</span> Mark <span class=operator>|</span>         <span class=number>2</span> <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>------+------+-----------+</span></span><br><span class=line></span><br><span class=line># 解法<span class=number>1</span>：</span><br><span class=line><span class=keyword>select</span> c.name</span><br><span class=line><span class=keyword>from</span> customer <span class=keyword>as</span> c</span><br><span class=line><span class=keyword>where</span> c.referee_id <span class=operator>!=</span> <span class=number>2</span> <span class=keyword>or</span> c.referee_id <span class=keyword>is</span> <span class=keyword>null</span></span><br></pre></table></figure><h2 id=1-19、-585-2016年的投资><a class=headerlink href=#1-19、-585-2016年的投资 title=1.19、(585)2016年的投资></a>1.19、(585)2016年的投资</h2><p>请你编写一个 SQL 查询，报告 2016 年 (tiv_2016) 所有满足下述条件的投保人的投保金额之和：<ul><li>他在 2015 年的投保额 (tiv_2015) 至少跟一个其他投保人在 2015 年的投保额相同。<li>他所在的城市必须与其他投保人都不同（也就是说 (lat, lon) 不能跟其他任何一个投保人完全相同）。<br>输入：</ul><figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br></pre><td class=code><pre><span class=line>Insurance 表：</span><br><span class=line><span class=operator>+</span><span class=comment>-----+----------+----------+-----+-----+</span></span><br><span class=line><span class=operator>|</span> pid <span class=operator>|</span> tiv_2015 <span class=operator>|</span> tiv_2016 <span class=operator>|</span> lat <span class=operator>|</span> lon <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>-----+----------+----------+-----+-----+</span></span><br><span class=line><span class=operator>|</span> <span class=number>1</span>   <span class=operator>|</span> <span class=number>10</span>       <span class=operator>|</span> <span class=number>5</span>        <span class=operator>|</span> <span class=number>10</span>  <span class=operator>|</span> <span class=number>10</span>  <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>2</span>   <span class=operator>|</span> <span class=number>20</span>       <span class=operator>|</span> <span class=number>20</span>       <span class=operator>|</span> <span class=number>20</span>  <span class=operator>|</span> <span class=number>20</span>  <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>3</span>   <span class=operator>|</span> <span class=number>10</span>       <span class=operator>|</span> <span class=number>30</span>       <span class=operator>|</span> <span class=number>20</span>  <span class=operator>|</span> <span class=number>20</span>  <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>4</span>   <span class=operator>|</span> <span class=number>10</span>       <span class=operator>|</span> <span class=number>40</span>       <span class=operator>|</span> <span class=number>40</span>  <span class=operator>|</span> <span class=number>40</span>  <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>-----+----------+----------+-----+-----+</span></span><br><span class=line>输出：</span><br><span class=line><span class=operator>+</span><span class=comment>----------+</span></span><br><span class=line><span class=operator>|</span> tiv_2016 <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>----------+</span></span><br><span class=line><span class=operator>|</span> <span class=number>45.00</span>    <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>----------+</span></span><br><span class=line></span><br><span class=line>解法<span class=number>1</span>：</span><br><span class=line><span class=keyword>select</span> <span class=built_in>SUM</span>(i.tiv_2016) <span class=keyword>as</span> "tiv_2016"</span><br><span class=line><span class=keyword>from</span> s3_insurance <span class=keyword>as</span> i</span><br><span class=line><span class=keyword>join</span> (</span><br><span class=line>	<span class=keyword>select</span> <span class=keyword>DISTINCT</span> pid <span class=keyword>from</span> s3_insurance</span><br><span class=line>) <span class=keyword>as</span> o1 <span class=keyword>on</span> i.pid <span class=operator>=</span> o1.pid</span><br><span class=line><span class=keyword>where</span> i.tiv_2015 <span class=keyword>in</span> (</span><br><span class=line>	<span class=keyword>select</span> i.tiv_2015</span><br><span class=line>	<span class=keyword>from</span> s3_insurance <span class=keyword>as</span> i</span><br><span class=line>	<span class=keyword>join</span> (</span><br><span class=line>		<span class=keyword>select</span> <span class=keyword>DISTINCT</span> pid</span><br><span class=line>		<span class=keyword>from</span> s3_insurance</span><br><span class=line>	) <span class=keyword>as</span> o1 <span class=keyword>on</span> i.pid <span class=operator>=</span> o1.pid</span><br><span class=line>	<span class=keyword>group</span> <span class=keyword>by</span> i.tiv_2015</span><br><span class=line>	<span class=keyword>having</span> <span class=built_in>count</span>(i.tiv_2015) <span class=operator>></span> <span class=number>1</span></span><br><span class=line>) <span class=keyword>and</span> (i.lat, i.lon) <span class=keyword>in</span> (</span><br><span class=line>	<span class=keyword>select</span> i2.lat, i2.lon</span><br><span class=line>	<span class=keyword>from</span> s3_insurance <span class=keyword>as</span> i2</span><br><span class=line>	<span class=keyword>join</span> (</span><br><span class=line>		<span class=keyword>select</span> <span class=keyword>DISTINCT</span> pid</span><br><span class=line>		<span class=keyword>from</span> s3_insurance</span><br><span class=line>	) <span class=keyword>as</span> o1 <span class=keyword>on</span> i2.pid <span class=operator>=</span> o1.pid</span><br><span class=line>	<span class=keyword>group</span> <span class=keyword>by</span> i2.lat, i2.lon</span><br><span class=line>	<span class=keyword>having</span> <span class=built_in>count</span>(i2.pid) <span class=operator>=</span> <span class=number>1</span></span><br><span class=line>)</span><br></pre></table></figure><h2 id=1-20、-586-订单最多的客户><a class=headerlink href=#1-20、-586-订单最多的客户 title=1.20、(586)订单最多的客户></a>1.20、(586)订单最多的客户</h2><p>查找下了 <strong>最多订单</strong> 的客户的 <code>customer_number</code> 。<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br></pre><td class=code><pre><span class=line>Orders 表:</span><br><span class=line><span class=operator>+</span><span class=comment>--------------+-----------------+</span></span><br><span class=line><span class=operator>|</span> order_number <span class=operator>|</span> customer_number <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>--------------+-----------------+</span></span><br><span class=line><span class=operator>|</span> <span class=number>1</span>            <span class=operator>|</span> <span class=number>1</span>               <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>2</span>            <span class=operator>|</span> <span class=number>2</span>               <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>3</span>            <span class=operator>|</span> <span class=number>3</span>               <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>4</span>            <span class=operator>|</span> <span class=number>3</span>               <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>--------------+-----------------+</span></span><br><span class=line>输出: </span><br><span class=line><span class=operator>+</span><span class=comment>-----------------+</span></span><br><span class=line><span class=operator>|</span> customer_number <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>-----------------+</span></span><br><span class=line><span class=operator>|</span> <span class=number>3</span>               <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>-----------------+</span></span><br><span class=line></span><br><span class=line># 解法<span class=number>1</span>：</span><br><span class=line><span class=keyword>select</span></span><br><span class=line>	o1.customer_number</span><br><span class=line><span class=keyword>from</span> (</span><br><span class=line>	<span class=keyword>select</span></span><br><span class=line>		o.customer_number,</span><br><span class=line>		<span class=built_in>count</span>(o.order_number) <span class=keyword>as</span> "o_count"</span><br><span class=line>	<span class=keyword>from</span> orders <span class=keyword>as</span> o</span><br><span class=line>	<span class=keyword>group</span> <span class=keyword>by</span> o.customer_number</span><br><span class=line>	<span class=keyword>order</span> <span class=keyword>by</span> o_count <span class=keyword>desc</span></span><br><span class=line>) <span class=keyword>as</span> o1</span><br><span class=line>limit <span class=number>0</span>, <span class=number>1</span></span><br></pre></table></figure><h2 id=1-21、-595-大的国家><a class=headerlink href=#1-21、-595-大的国家 title=1.21、(595)大的国家></a>1.21、(595)大的国家</h2><p>如果一个国家满足下述两个条件之一，则认为该国是大国 ：<ul><li>面积至少为 300 万平方公里（即，3000000 km2）<li>人口至少为 2500 万（即 25000000）</ul><p>编写SQL找出 大国 的国家名称、人口和面积。<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br></pre><td class=code><pre><span class=line>World 表：</span><br><span class=line><span class=operator>+</span><span class=comment>-------------+-----------+---------+------------+--------------+</span></span><br><span class=line><span class=operator>|</span> name        <span class=operator>|</span> continent <span class=operator>|</span> area    <span class=operator>|</span> population <span class=operator>|</span> gdp          <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>-------------+-----------+---------+------------+--------------+</span></span><br><span class=line><span class=operator>|</span> Afghanistan <span class=operator>|</span> Asia      <span class=operator>|</span> <span class=number>652230</span>  <span class=operator>|</span> <span class=number>25500100</span>   <span class=operator>|</span> <span class=number>20343000000</span>  <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> Albania     <span class=operator>|</span> Europe    <span class=operator>|</span> <span class=number>28748</span>   <span class=operator>|</span> <span class=number>2831741</span>    <span class=operator>|</span> <span class=number>12960000000</span>  <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> Algeria     <span class=operator>|</span> Africa    <span class=operator>|</span> <span class=number>2381741</span> <span class=operator>|</span> <span class=number>37100000</span>   <span class=operator>|</span> <span class=number>188681000000</span> <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> Andorra     <span class=operator>|</span> Europe    <span class=operator>|</span> <span class=number>468</span>     <span class=operator>|</span> <span class=number>78115</span>      <span class=operator>|</span> <span class=number>3712000000</span>   <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> Angola      <span class=operator>|</span> Africa    <span class=operator>|</span> <span class=number>1246700</span> <span class=operator>|</span> <span class=number>20609294</span>   <span class=operator>|</span> <span class=number>100990000000</span> <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>-------------+-----------+---------+------------+--------------+</span></span><br><span class=line>输出：</span><br><span class=line><span class=operator>+</span><span class=comment>-------------+------------+---------+</span></span><br><span class=line><span class=operator>|</span> name        <span class=operator>|</span> population <span class=operator>|</span> area    <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>-------------+------------+---------+</span></span><br><span class=line><span class=operator>|</span> Afghanistan <span class=operator>|</span> <span class=number>25500100</span>   <span class=operator>|</span> <span class=number>652230</span>  <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> Algeria     <span class=operator>|</span> <span class=number>37100000</span>   <span class=operator>|</span> <span class=number>2381741</span> <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>-------------+------------+---------+</span></span><br><span class=line></span><br><span class=line># 解法<span class=number>1</span>：</span><br><span class=line><span class=keyword>select</span></span><br><span class=line>	w.name,</span><br><span class=line>	w.population,</span><br><span class=line>	w.area</span><br><span class=line><span class=keyword>from</span> world <span class=keyword>as</span> w</span><br><span class=line><span class=keyword>where</span> w.area <span class=operator>>=</span> <span class=number>3000000</span> <span class=keyword>or</span> w.population <span class=operator>>=</span> <span class=number>25000000</span></span><br></pre></table></figure><h2 id=1-22、-596-超过5名学生的课><a class=headerlink href=#1-22、-596-超过5名学生的课 title=1.22、(596)超过5名学生的课></a>1.22、(596)超过5名学生的课</h2><p>查询 至少有5个学生 的所有班级。<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br></pre><td class=code><pre><span class=line>Courses <span class=keyword>table</span>:</span><br><span class=line><span class=operator>+</span><span class=comment>---------+----------+</span></span><br><span class=line><span class=operator>|</span> student <span class=operator>|</span> class    <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>---------+----------+</span></span><br><span class=line><span class=operator>|</span> A       <span class=operator>|</span> Math     <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> B       <span class=operator>|</span> English  <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> C       <span class=operator>|</span> Math     <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> D       <span class=operator>|</span> Biology  <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> E       <span class=operator>|</span> Math     <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> F       <span class=operator>|</span> Computer <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> G       <span class=operator>|</span> Math     <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> H       <span class=operator>|</span> Math     <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> I       <span class=operator>|</span> Math     <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>---------+----------+</span></span><br><span class=line>输出: </span><br><span class=line><span class=operator>+</span><span class=comment>---------+ </span></span><br><span class=line><span class=operator>|</span> class   <span class=operator>|</span> </span><br><span class=line><span class=operator>+</span><span class=comment>---------+ </span></span><br><span class=line><span class=operator>|</span> Math    <span class=operator>|</span> </span><br><span class=line><span class=operator>+</span><span class=comment>---------+</span></span><br><span class=line></span><br><span class=line># 解法<span class=number>1</span>：</span><br><span class=line><span class=keyword>select</span> c.class</span><br><span class=line><span class=keyword>from</span> courses <span class=keyword>as</span> c</span><br><span class=line><span class=keyword>group</span> <span class=keyword>by</span> c.class</span><br><span class=line><span class=keyword>having</span> <span class=built_in>count</span>(c.student) <span class=operator>>=</span> <span class=number>5</span></span><br></pre></table></figure><h2 id=1-23、-601-体育馆的人流量><a class=headerlink href=#1-23、-601-体育馆的人流量 title=1.23、(601)体育馆的人流量></a>1.23、(601)体育馆的人流量</h2><p>编写一个 SQL 查询以找出每行的人数大于或等于 100 且 id 连续的三行或更多行记录。<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br><span class=line>61</span><br><span class=line>62</span><br><span class=line>63</span><br><span class=line>64</span><br><span class=line>65</span><br><span class=line>66</span><br><span class=line>67</span><br><span class=line>68</span><br><span class=line>69</span><br><span class=line>70</span><br><span class=line>71</span><br><span class=line>72</span><br><span class=line>73</span><br><span class=line>74</span><br><span class=line>75</span><br><span class=line>76</span><br><span class=line>77</span><br><span class=line>78</span><br><span class=line>79</span><br><span class=line>80</span><br><span class=line>81</span><br><span class=line>82</span><br><span class=line>83</span><br><span class=line>84</span><br><span class=line>85</span><br><span class=line>86</span><br><span class=line>87</span><br><span class=line>88</span><br><span class=line>89</span><br><span class=line>90</span><br><span class=line>91</span><br><span class=line>92</span><br><span class=line>93</span><br><span class=line>94</span><br><span class=line>95</span><br><span class=line>96</span><br><span class=line>97</span><br><span class=line>98</span><br><span class=line>99</span><br><span class=line>100</span><br><span class=line>101</span><br><span class=line>102</span><br><span class=line>103</span><br><span class=line>104</span><br><span class=line>105</span><br><span class=line>106</span><br><span class=line>107</span><br><span class=line>108</span><br></pre><td class=code><pre><span class=line>Stadium 表:</span><br><span class=line><span class=operator>+</span><span class=comment>------+------------+-----------+</span></span><br><span class=line><span class=operator>|</span> id   <span class=operator>|</span> visit_date <span class=operator>|</span> people    <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>------+------------+-----------+</span></span><br><span class=line><span class=operator>|</span> <span class=number>1</span>    <span class=operator>|</span> <span class=number>2017</span><span class=number>-01</span><span class=number>-01</span> <span class=operator>|</span> <span class=number>10</span>        <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>2</span>    <span class=operator>|</span> <span class=number>2017</span><span class=number>-01</span><span class=number>-02</span> <span class=operator>|</span> <span class=number>109</span>       <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>3</span>    <span class=operator>|</span> <span class=number>2017</span><span class=number>-01</span><span class=number>-03</span> <span class=operator>|</span> <span class=number>150</span>       <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>4</span>    <span class=operator>|</span> <span class=number>2017</span><span class=number>-01</span><span class=number>-04</span> <span class=operator>|</span> <span class=number>99</span>        <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>5</span>    <span class=operator>|</span> <span class=number>2017</span><span class=number>-01</span><span class=number>-05</span> <span class=operator>|</span> <span class=number>145</span>       <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>6</span>    <span class=operator>|</span> <span class=number>2017</span><span class=number>-01</span><span class=number>-06</span> <span class=operator>|</span> <span class=number>1455</span>      <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>7</span>    <span class=operator>|</span> <span class=number>2017</span><span class=number>-01</span><span class=number>-07</span> <span class=operator>|</span> <span class=number>199</span>       <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>8</span>    <span class=operator>|</span> <span class=number>2017</span><span class=number>-01</span><span class=number>-09</span> <span class=operator>|</span> <span class=number>188</span>       <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>------+------------+-----------+</span></span><br><span class=line>输出：</span><br><span class=line><span class=operator>+</span><span class=comment>------+------------+-----------+</span></span><br><span class=line><span class=operator>|</span> id   <span class=operator>|</span> visit_date <span class=operator>|</span> people    <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>------+------------+-----------+</span></span><br><span class=line><span class=operator>|</span> <span class=number>5</span>    <span class=operator>|</span> <span class=number>2017</span><span class=number>-01</span><span class=number>-05</span> <span class=operator>|</span> <span class=number>145</span>       <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>6</span>    <span class=operator>|</span> <span class=number>2017</span><span class=number>-01</span><span class=number>-06</span> <span class=operator>|</span> <span class=number>1455</span>      <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>7</span>    <span class=operator>|</span> <span class=number>2017</span><span class=number>-01</span><span class=number>-07</span> <span class=operator>|</span> <span class=number>199</span>       <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>8</span>    <span class=operator>|</span> <span class=number>2017</span><span class=number>-01</span><span class=number>-09</span> <span class=operator>|</span> <span class=number>188</span>       <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>------+------------+-----------+</span></span><br><span class=line></span><br><span class=line># 解法<span class=number>1</span>：</span><br><span class=line><span class=keyword>select</span></span><br><span class=line>	o3.id,</span><br><span class=line>	o3.visit_date,</span><br><span class=line>	o3.people</span><br><span class=line><span class=keyword>from</span> (</span><br><span class=line>	<span class=keyword>select</span></span><br><span class=line>		o1.<span class=operator>*</span>,</span><br><span class=line>		<span class=variable>@c2</span>:<span class=operator>=</span>o1.id,</span><br><span class=line>		IF(<span class=variable>@c2</span><span class=operator>-</span><span class=variable>@oc2</span><span class=operator>=</span><span class=number>1</span>, <span class=variable>@v2</span>, <span class=variable>@v2</span>:<span class=operator>=</span><span class=variable>@v2</span><span class=operator>+</span><span class=number>1</span>) <span class=keyword>as</span> "level",</span><br><span class=line>		<span class=variable>@oc2</span>:<span class=operator>=</span><span class=variable>@c2</span></span><br><span class=line>	<span class=keyword>from</span> (</span><br><span class=line>		<span class=keyword>select</span> s.<span class=operator>*</span>, <span class=variable>@v2</span>:<span class=operator>=</span><span class=number>0</span></span><br><span class=line>		<span class=keyword>from</span> s3_stadium <span class=keyword>as</span> s</span><br><span class=line>		<span class=keyword>where</span> s.people <span class=operator>>=</span> <span class=number>100</span></span><br><span class=line>		<span class=keyword>order</span> <span class=keyword>by</span> s.id</span><br><span class=line>	) <span class=keyword>as</span> o1</span><br><span class=line>) <span class=keyword>as</span> o3 </span><br><span class=line><span class=keyword>where</span> o3.level <span class=keyword>in</span> (</span><br><span class=line>	<span class=keyword>select</span></span><br><span class=line>		o2.level</span><br><span class=line>	<span class=keyword>from</span> (</span><br><span class=line>		<span class=keyword>select</span></span><br><span class=line>			o1.<span class=operator>*</span>,</span><br><span class=line>			<span class=variable>@c</span>:<span class=operator>=</span>o1.id,</span><br><span class=line>			IF(<span class=variable>@c</span><span class=operator>-</span><span class=variable>@oc</span><span class=operator>=</span><span class=number>1</span>, <span class=variable>@v</span>, <span class=variable>@v</span>:<span class=operator>=</span><span class=variable>@v</span><span class=operator>+</span><span class=number>1</span>) <span class=keyword>as</span> "level",</span><br><span class=line>			<span class=variable>@oc</span>:<span class=operator>=</span><span class=variable>@c</span></span><br><span class=line>		<span class=keyword>from</span> (</span><br><span class=line>			<span class=keyword>select</span> s.<span class=operator>*</span>, <span class=variable>@v</span>:<span class=operator>=</span><span class=number>0</span></span><br><span class=line>			<span class=keyword>from</span> s3_stadium <span class=keyword>as</span> s</span><br><span class=line>			<span class=keyword>where</span> s.people <span class=operator>>=</span> <span class=number>100</span></span><br><span class=line>			<span class=keyword>order</span> <span class=keyword>by</span> s.id</span><br><span class=line>		) <span class=keyword>as</span> o1</span><br><span class=line>	) <span class=keyword>as</span> o2</span><br><span class=line>	<span class=keyword>group</span> <span class=keyword>by</span> o2.level</span><br><span class=line>	<span class=keyword>having</span> <span class=built_in>count</span>(o2.id) <span class=operator>>=</span> <span class=number>3</span></span><br><span class=line>)</span><br><span class=line></span><br><span class=line># 解法<span class=number>2</span>：</span><br><span class=line><span class=keyword>select</span> <span class=keyword>DISTINCT</span> s.<span class=operator>*</span></span><br><span class=line><span class=keyword>from</span> s3_stadium <span class=keyword>as</span> s</span><br><span class=line><span class=keyword>inner</span> <span class=keyword>join</span> s3_stadium <span class=keyword>as</span> s2</span><br><span class=line><span class=keyword>inner</span> <span class=keyword>join</span> s3_stadium <span class=keyword>as</span> s3</span><br><span class=line><span class=keyword>where</span> s.people <span class=operator>></span> <span class=number>100</span> <span class=keyword>and</span> s2.people <span class=operator>></span> <span class=number>100</span> <span class=keyword>and</span> s3.people <span class=operator>></span> <span class=number>100</span></span><br><span class=line>	<span class=keyword>and</span> (</span><br><span class=line>		(s.id <span class=operator>-</span> s2.id <span class=operator>=</span> <span class=number>1</span> <span class=keyword>and</span> s.id <span class=operator>-</span> s3.id <span class=operator>=</span> <span class=number>2</span> <span class=keyword>and</span> s2.id <span class=operator>-</span> s3.id <span class=operator>=</span> <span class=number>1</span>) <span class=keyword>or</span></span><br><span class=line>		(s2.id <span class=operator>-</span> s.id <span class=operator>=</span> <span class=number>1</span> <span class=keyword>and</span> s2.id <span class=operator>-</span> s3.id <span class=operator>=</span> <span class=number>2</span> <span class=keyword>and</span> s.id <span class=operator>-</span> s3.id <span class=operator>=</span> <span class=number>1</span>) <span class=keyword>or</span></span><br><span class=line>		(s3.id <span class=operator>-</span> s2.id <span class=operator>=</span> <span class=number>1</span> <span class=keyword>and</span> s2.id <span class=operator>-</span> s.id <span class=operator>=</span> <span class=number>1</span> <span class=keyword>and</span> s3.id <span class=operator>-</span> s.id <span class=operator>=</span> <span class=number>2</span>)</span><br><span class=line>	)</span><br><span class=line><span class=keyword>order</span> <span class=keyword>by</span> s.id</span><br><span class=line></span><br><span class=line># 解法<span class=number>3</span>：</span><br><span class=line><span class=keyword>with</span> t1 <span class=keyword>as</span> (</span><br><span class=line>	<span class=keyword>select</span></span><br><span class=line>		s.<span class=operator>*</span>,</span><br><span class=line>		s.id <span class=operator>-</span> <span class=built_in>ROW_NUMBER</span>() <span class=keyword>over</span>(<span class=keyword>order</span> <span class=keyword>by</span> s.id) <span class=keyword>as</span> "rn"</span><br><span class=line>	<span class=keyword>from</span> s3_stadium <span class=keyword>as</span> s</span><br><span class=line>	<span class=keyword>where</span> s.people <span class=operator>>=</span> <span class=number>100</span></span><br><span class=line>)</span><br><span class=line><span class=keyword>select</span></span><br><span class=line>	id,</span><br><span class=line>	visit_date,</span><br><span class=line>	people</span><br><span class=line><span class=keyword>from</span> t1</span><br><span class=line><span class=keyword>where</span> rn <span class=keyword>in</span> (</span><br><span class=line>	<span class=keyword>select</span> rn <span class=keyword>from</span> t1 <span class=keyword>group</span> <span class=keyword>by</span> rn <span class=keyword>having</span> <span class=built_in>count</span>(id) <span class=operator>>=</span> <span class=number>3</span></span><br><span class=line>)</span><br><span class=line></span><br><span class=line># 解法<span class=number>4</span>：</span><br><span class=line><span class=keyword>with</span> t1 <span class=keyword>as</span> (</span><br><span class=line>	<span class=keyword>select</span></span><br><span class=line>		s.<span class=operator>*</span>,</span><br><span class=line>		s.id <span class=operator>-</span> <span class=built_in>ROW_NUMBER</span>() <span class=keyword>over</span>(<span class=keyword>order</span> <span class=keyword>by</span> s.id) <span class=keyword>as</span> "rn"</span><br><span class=line>	<span class=keyword>from</span> s3_stadium <span class=keyword>as</span> s</span><br><span class=line>	<span class=keyword>where</span> s.people <span class=operator>>=</span> <span class=number>100</span></span><br><span class=line>)</span><br><span class=line><span class=keyword>select</span></span><br><span class=line>	o1.id,</span><br><span class=line>	o1.visit_date,</span><br><span class=line>	o1.people</span><br><span class=line><span class=keyword>from</span> (</span><br><span class=line>	<span class=keyword>select</span> <span class=operator>*</span>, <span class=built_in>count</span>(rn) <span class=keyword>over</span>(<span class=keyword>partition</span> <span class=keyword>by</span> rn) <span class=keyword>as</span> "pb" <span class=keyword>from</span> t1</span><br><span class=line>) <span class=keyword>as</span> o1</span><br><span class=line><span class=keyword>where</span> o1.pb <span class=operator>>=</span> <span class=number>3</span></span><br><span class=line><span class=keyword>order</span> <span class=keyword>by</span> o1.id</span><br></pre></table></figure><h2 id=1-24、-602-好友申请2：谁有最多的好友><a class=headerlink href=#1-24、-602-好友申请2：谁有最多的好友 title=1.24、(602)好友申请2：谁有最多的好友></a>1.24、(602)好友申请2：谁有最多的好友</h2><p>写一个查询语句，找出拥有最多的好友的人和他拥有的好友数目。<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br></pre><td class=code><pre><span class=line>RequestAccepted 表：</span><br><span class=line><span class=operator>+</span><span class=comment>--------------+-------------+-------------+</span></span><br><span class=line><span class=operator>|</span> requester_id <span class=operator>|</span> accepter_id <span class=operator>|</span> accept_date <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>--------------+-------------+-------------+</span></span><br><span class=line><span class=operator>|</span> <span class=number>1</span>            <span class=operator>|</span> <span class=number>2</span>           <span class=operator>|</span> <span class=number>2016</span><span class=operator>/</span><span class=number>06</span><span class=operator>/</span><span class=number>03</span>  <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>1</span>            <span class=operator>|</span> <span class=number>3</span>           <span class=operator>|</span> <span class=number>2016</span><span class=operator>/</span><span class=number>06</span><span class=operator>/</span><span class=number>08</span>  <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>2</span>            <span class=operator>|</span> <span class=number>3</span>           <span class=operator>|</span> <span class=number>2016</span><span class=operator>/</span><span class=number>06</span><span class=operator>/</span><span class=number>08</span>  <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>3</span>            <span class=operator>|</span> <span class=number>4</span>           <span class=operator>|</span> <span class=number>2016</span><span class=operator>/</span><span class=number>06</span><span class=operator>/</span><span class=number>09</span>  <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>--------------+-------------+-------------+</span></span><br><span class=line>输出：</span><br><span class=line><span class=operator>+</span><span class=comment>----+-----+</span></span><br><span class=line><span class=operator>|</span> id <span class=operator>|</span> num <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>----+-----+</span></span><br><span class=line><span class=operator>|</span> <span class=number>3</span>  <span class=operator>|</span> <span class=number>3</span>   <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>----+-----+</span></span><br><span class=line></span><br><span class=line># 解法<span class=number>1</span>：</span><br><span class=line><span class=keyword>with</span> t1 <span class=keyword>as</span> (</span><br><span class=line>	<span class=keyword>select</span> <span class=operator>*</span></span><br><span class=line>	<span class=keyword>from</span> (</span><br><span class=line>		<span class=keyword>select</span> ra.requester_id</span><br><span class=line>		<span class=keyword>from</span> s3_requestaccepted <span class=keyword>as</span> ra</span><br><span class=line>		<span class=keyword>union</span> <span class=keyword>all</span></span><br><span class=line>		<span class=keyword>select</span> ra2.accepter_id</span><br><span class=line>		<span class=keyword>from</span> s3_requestaccepted <span class=keyword>as</span> ra2</span><br><span class=line>	) <span class=keyword>as</span> alldata</span><br><span class=line>)</span><br><span class=line><span class=keyword>select</span></span><br><span class=line>	requester_id,</span><br><span class=line>	<span class=built_in>count</span>(requester_id) <span class=keyword>as</span> "cn"</span><br><span class=line><span class=keyword>from</span> t1</span><br><span class=line><span class=keyword>group</span> <span class=keyword>by</span> requester_id</span><br><span class=line><span class=keyword>order</span> <span class=keyword>by</span> cn <span class=keyword>desc</span></span><br><span class=line>limit <span class=number>0</span>, <span class=number>1</span></span><br></pre></table></figure><h2 id=1-25、-607-销售员><a class=headerlink href=#1-25、-607-销售员 title=1.25、(607)销售员></a>1.25、(607)销售员</h2><p>查询没有任何与名为 “RED” 的公司相关的订单的所有销售人员的姓名。<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br></pre><td class=code><pre><span class=line>SalesPerson 表:</span><br><span class=line><span class=operator>+</span><span class=comment>----------+------+--------+-----------------+------------+</span></span><br><span class=line><span class=operator>|</span> sales_id <span class=operator>|</span> name <span class=operator>|</span> salary <span class=operator>|</span> commission_rate <span class=operator>|</span> hire_date  <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>----------+------+--------+-----------------+------------+</span></span><br><span class=line><span class=operator>|</span> <span class=number>1</span>        <span class=operator>|</span> John <span class=operator>|</span> <span class=number>100000</span> <span class=operator>|</span> <span class=number>6</span>               <span class=operator>|</span> <span class=number>4</span><span class=operator>/</span><span class=number>1</span><span class=operator>/</span><span class=number>2006</span>   <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>2</span>        <span class=operator>|</span> Amy  <span class=operator>|</span> <span class=number>12000</span>  <span class=operator>|</span> <span class=number>5</span>               <span class=operator>|</span> <span class=number>5</span><span class=operator>/</span><span class=number>1</span><span class=operator>/</span><span class=number>2010</span>   <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>3</span>        <span class=operator>|</span> Mark <span class=operator>|</span> <span class=number>65000</span>  <span class=operator>|</span> <span class=number>12</span>              <span class=operator>|</span> <span class=number>12</span><span class=operator>/</span><span class=number>25</span><span class=operator>/</span><span class=number>2008</span> <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>4</span>        <span class=operator>|</span> Pam  <span class=operator>|</span> <span class=number>25000</span>  <span class=operator>|</span> <span class=number>25</span>              <span class=operator>|</span> <span class=number>1</span><span class=operator>/</span><span class=number>1</span><span class=operator>/</span><span class=number>2005</span>   <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>5</span>        <span class=operator>|</span> Alex <span class=operator>|</span> <span class=number>5000</span>   <span class=operator>|</span> <span class=number>10</span>              <span class=operator>|</span> <span class=number>2</span><span class=operator>/</span><span class=number>3</span><span class=operator>/</span><span class=number>2007</span>   <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>----------+------+--------+-----------------+------------+</span></span><br><span class=line>Company 表:</span><br><span class=line><span class=operator>+</span><span class=comment>--------+--------+----------+</span></span><br><span class=line><span class=operator>|</span> com_id <span class=operator>|</span> name   <span class=operator>|</span> city     <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>--------+--------+----------+</span></span><br><span class=line><span class=operator>|</span> <span class=number>1</span>      <span class=operator>|</span> RED    <span class=operator>|</span> Boston   <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>2</span>      <span class=operator>|</span> ORANGE <span class=operator>|</span> <span class=keyword>New</span> York <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>3</span>      <span class=operator>|</span> YELLOW <span class=operator>|</span> Boston   <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>4</span>      <span class=operator>|</span> GREEN  <span class=operator>|</span> Austin   <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>--------+--------+----------+</span></span><br><span class=line>Orders 表:</span><br><span class=line><span class=operator>+</span><span class=comment>----------+------------+--------+----------+--------+</span></span><br><span class=line><span class=operator>|</span> order_id <span class=operator>|</span> order_date <span class=operator>|</span> com_id <span class=operator>|</span> sales_id <span class=operator>|</span> amount <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>----------+------------+--------+----------+--------+</span></span><br><span class=line><span class=operator>|</span> <span class=number>1</span>        <span class=operator>|</span> <span class=number>1</span><span class=operator>/</span><span class=number>1</span><span class=operator>/</span><span class=number>2014</span>   <span class=operator>|</span> <span class=number>3</span>      <span class=operator>|</span> <span class=number>4</span>        <span class=operator>|</span> <span class=number>10000</span>  <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>2</span>        <span class=operator>|</span> <span class=number>2</span><span class=operator>/</span><span class=number>1</span><span class=operator>/</span><span class=number>2014</span>   <span class=operator>|</span> <span class=number>4</span>      <span class=operator>|</span> <span class=number>5</span>        <span class=operator>|</span> <span class=number>5000</span>   <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>3</span>        <span class=operator>|</span> <span class=number>3</span><span class=operator>/</span><span class=number>1</span><span class=operator>/</span><span class=number>2014</span>   <span class=operator>|</span> <span class=number>1</span>      <span class=operator>|</span> <span class=number>1</span>        <span class=operator>|</span> <span class=number>50000</span>  <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>4</span>        <span class=operator>|</span> <span class=number>4</span><span class=operator>/</span><span class=number>1</span><span class=operator>/</span><span class=number>2014</span>   <span class=operator>|</span> <span class=number>1</span>      <span class=operator>|</span> <span class=number>4</span>        <span class=operator>|</span> <span class=number>25000</span>  <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>----------+------------+--------+----------+--------+</span></span><br><span class=line>输出：</span><br><span class=line><span class=operator>+</span><span class=comment>------+</span></span><br><span class=line><span class=operator>|</span> name <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>------+</span></span><br><span class=line><span class=operator>|</span> Amy  <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> Mark <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> Alex <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>------+</span></span><br><span class=line></span><br><span class=line># 解法<span class=number>1</span>：</span><br><span class=line><span class=keyword>select</span> sp.name</span><br><span class=line><span class=keyword>from</span> SalesPerson <span class=keyword>as</span> sp</span><br><span class=line><span class=keyword>where</span> sp.sales_id <span class=keyword>not</span> <span class=keyword>in</span> (</span><br><span class=line>	<span class=keyword>select</span> o.sales_id</span><br><span class=line>	<span class=keyword>from</span> orders <span class=keyword>as</span> o</span><br><span class=line>	<span class=keyword>where</span> o.com_id <span class=keyword>in</span> (</span><br><span class=line>		<span class=keyword>select</span> c.com_id</span><br><span class=line>		<span class=keyword>from</span> company <span class=keyword>as</span> c</span><br><span class=line>		<span class=keyword>where</span> c.name <span class=operator>=</span> "RED"</span><br><span class=line>	)</span><br><span class=line>)</span><br></pre></table></figure></div><footer class=post-footer><div class=post-eof></div></footer></article></div><div class=post-block><article class=post-content itemscope itemtype=http://schema.org/Article><link href=https://hgprivate.github.io/2024/08/21/MySQL%E7%BB%8F%E5%85%B8SQL%E7%BB%83%E4%B9%A0%E9%A2%98%E7%AC%AC%E4%B8%80%E7%AF%87/ itemprop=mainEntityOfPage><span hidden itemprop=author itemscope itemtype=http://schema.org/Person> <meta content=/static/imgs/avatar.png itemprop=image> <meta content=豪哥 itemprop=name> </span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization> <meta content=豪哥博客 itemprop=name> <meta content=豪哥博客 itemprop=description> </span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork> <meta content="undefined | 豪哥博客" itemprop=name> <meta itemprop=description> </span><header class=post-header><h2 itemprop="name headline" class=post-title><a class=post-title-link href=/2024/08/21/MySQL%E7%BB%8F%E5%85%B8SQL%E7%BB%83%E4%B9%A0%E9%A2%98%E7%AC%AC%E4%B8%80%E7%AF%87/ itemprop=url>MySQL系列-MySQL经典SQL练习题第一篇</a></h2><div class=post-meta-container><div class=post-meta><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar"></i> </span> <span class=post-meta-item-text>发表于</span> <time itemprop="dateCreated datePublished" title="创建时间：2024-08-21 21:39:14" datetime=2024-08-21T21:39:14+08:00>2024-08-21</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar-check"></i> </span> <span class=post-meta-item-text>更新于</span> <time title="修改时间：2023-09-01 14:40:41" datetime=2023-09-01T14:40:41+08:00 itemprop=dateModified>2023-09-01</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-folder"></i> </span> <span class=post-meta-item-text>分类于</span> <span itemprop=about itemscope itemtype=http://schema.org/Thing> <a href=/categories/MySQL/ itemprop=url rel=index><span itemprop=name>MySQL</span></a> </span> </span></div></div></header><div class=post-body itemprop=articleBody><h1 id=1、准备环境><a class=headerlink href=#1、准备环境 title=1、准备环境></a>1、准备环境</h1><h2 id=1-1、建表><a class=headerlink href=#1-1、建表 title=1.1、建表></a>1.1、建表</h2><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br></pre><td class=code><pre><span class=line>CREATE TABLE `s1_student` (</span><br><span class=line>  `sid` int(11) NOT NULL COMMENT '学生ID',</span><br><span class=line>  `sname` varchar(255) COLLATE utf8mb4_general_ci NOT NULL COMMENT '学生名字',</span><br><span class=line>  `age` tinyint(4) DEFAULT NULL COMMENT '学生年龄',</span><br><span class=line>  `sex` char(2) COLLATE utf8mb4_general_ci DEFAULT NULL COMMENT '学生性别'</span><br><span class=line>) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;</span><br><span class=line></span><br><span class=line>CREATE TABLE `s1_teacher` (</span><br><span class=line>  `tid` int(11) NOT NULL COMMENT '教师ID',</span><br><span class=line>  `tname` varchar(255) COLLATE utf8mb4_general_ci NOT NULL COMMENT '教师名字',</span><br><span class=line>  PRIMARY KEY (`tid`)</span><br><span class=line>) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;</span><br><span class=line></span><br><span class=line>CREATE TABLE `s1_course` (</span><br><span class=line>  `cid` int(11) NOT NULL COMMENT '课程ID',</span><br><span class=line>  `cname` varchar(255) COLLATE utf8mb4_general_ci NOT NULL COMMENT '课程名字',</span><br><span class=line>  `tid` int(11) NOT NULL COMMENT '教师ID',</span><br><span class=line>  PRIMARY KEY (`cid`)</span><br><span class=line>) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;</span><br><span class=line></span><br><span class=line>CREATE TABLE `s1_score` (</span><br><span class=line>  `sid` int(11) NOT NULL COMMENT '学生ID',</span><br><span class=line>  `cid` int(11) NOT NULL COMMENT '课程ID',</span><br><span class=line>  `score` smallint(6) NOT NULL COMMENT '成绩',</span><br><span class=line>  PRIMARY KEY (`sid`)</span><br><span class=line>) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;</span><br></pre></table></figure><h2 id=1-2、插入数据><a class=headerlink href=#1-2、插入数据 title=1.2、插入数据></a>1.2、插入数据</h2><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br></pre><td class=code><pre><span class=line>insert into s1_student values</span><br><span class=line>(1 , '赵雷' , 18 , '男'),</span><br><span class=line>(2 , '钱电' , 18 , '男'),</span><br><span class=line>(3 , '孙风' , 18 , '男'), </span><br><span class=line>(4 , '李云' , 18 , '男'), </span><br><span class=line>(5 , '周梅' , 19 , '女'), </span><br><span class=line>(6 , '吴兰' , 19 , '女'), </span><br><span class=line>(7 , '郑竹' , 19 , '女'), </span><br><span class=line>(8 , '张三' , 21 , '女'), </span><br><span class=line>(9 , '李四' , 21 , '女'), </span><br><span class=line>(10 , '李四' , 22 , '女'), </span><br><span class=line>(12 , '赵六' , 23 , '女'), </span><br><span class=line>(13 , '孙七' , 25 , '女'); </span><br><span class=line></span><br><span class=line>insert into s1_teacher values</span><br><span class=line>(1, '张三'),</span><br><span class=line>(2, '李四'),</span><br><span class=line>(3, '王五'); </span><br><span class=line></span><br><span class=line>insert into s1_course values</span><br><span class=line>(1 , '语文' , 2),</span><br><span class=line>(2 , '数学', 1),</span><br><span class=line>(3 , '英语', 3);</span><br><span class=line></span><br><span class=line>insert into s1_score values</span><br><span class=line>(1, 1, 80),</span><br><span class=line>(1, 2, 90),</span><br><span class=line>(1, 3, 99), </span><br><span class=line>(2, 1, 70), </span><br><span class=line>(2, 2, 60),</span><br><span class=line>(2, 3, 80), </span><br><span class=line>(3, 1, 80), </span><br><span class=line>(3, 2, 80), </span><br><span class=line>(3, 3, 80), </span><br><span class=line>(4, 1, 50), </span><br><span class=line>(4, 2, 30), </span><br><span class=line>(4, 3, 20), </span><br><span class=line>(5, 1, 76), </span><br><span class=line>(5, 2, 87), </span><br><span class=line>(6, 1, 31), </span><br><span class=line>(6, 3, 34), </span><br><span class=line>(7, 2, 89), </span><br><span class=line>(7, 3, 98);</span><br></pre></table></figure><h2 id=1-3、检查表数据是否插入成功><a class=headerlink href=#1-3、检查表数据是否插入成功 title=1.3、检查表数据是否插入成功></a>1.3、检查表数据是否插入成功</h2><figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line><span class=keyword>select</span> <span class=operator>*</span> <span class=keyword>from</span> s1_student;</span><br><span class=line><span class=keyword>select</span> <span class=operator>*</span> <span class=keyword>from</span> s1_teacher;</span><br><span class=line><span class=keyword>select</span> <span class=operator>*</span> <span class=keyword>from</span> s1_course;</span><br><span class=line><span class=keyword>select</span> <span class=operator>*</span> <span class=keyword>from</span> s1_score;</span><br></pre></table></figure><h1 id=2、SQL练习><a class=headerlink href=#2、SQL练习 title=2、SQL练习></a>2、SQL练习</h1><h2 id=2-1、查询-课程1比课程2成绩高的学生信息及课程分数><a title="2.1、查询 课程1比课程2成绩高的学生信息及课程分数" class=headerlink href=#2-1、查询-课程1比课程2成绩高的学生信息及课程分数></a>2.1、查询 课程1比课程2成绩高的学生信息及课程分数</h2><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br></pre><td class=code><pre><span class=line>select ss1.sid, st.sname, s.cid, s.score</span><br><span class=line>from(</span><br><span class=line>	select s1.sid, s1.cid, s1.score as '语文', s2.score as '数学'</span><br><span class=line>	from (</span><br><span class=line>		select sid, cid, score from s1_score s where s.cid = 1</span><br><span class=line>	) s1</span><br><span class=line>	left join (</span><br><span class=line>		select sid, cid, score from s1_score s where s.cid = 2</span><br><span class=line>	) s2</span><br><span class=line>	on s1.sid = s2.sid</span><br><span class=line>	where s1.score > s2.score</span><br><span class=line>) ss1</span><br><span class=line>join s1_student st on ss1.sid = st.sid</span><br><span class=line>join s1_score s on ss1.sid = s.sid; </span><br><span class=line></span><br><span class=line></span><br><span class=line># 解法2</span><br><span class=line>select </span><br><span class=line>	st.*,</span><br><span class=line>	oo1.c1_score as "课程1成绩",</span><br><span class=line>	oo1.c2_score as "课程2成绩"</span><br><span class=line>from s1_student as st</span><br><span class=line>join(</span><br><span class=line>	select </span><br><span class=line>		o1.sid, </span><br><span class=line>		o1.score as "c1_score",</span><br><span class=line>		o2.score as "c2_score"</span><br><span class=line>	from (</span><br><span class=line>		select s.sid, s.cid, s.score</span><br><span class=line>		from s1_score as s</span><br><span class=line>		where s.cid = 1</span><br><span class=line>	) as o1</span><br><span class=line>	left join (</span><br><span class=line>		select s.sid, s.cid, s.score</span><br><span class=line>		from s1_score as s</span><br><span class=line>		where s.cid = 2</span><br><span class=line>	) as o2 on o1.sid = o2.sid</span><br><span class=line>	where o1.score > o2.score</span><br><span class=line>) as oo1 on st.sid = oo1.sid</span><br></pre></table></figure><h2 id=2-2、查询-课程1和课程2都学习的学生信息><a title="2.2、查询 课程1和课程2都学习的学生信息" class=headerlink href=#2-2、查询-课程1和课程2都学习的学生信息></a>2.2、查询 课程1和课程2都学习的学生信息</h2><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br></pre><td class=code><pre><span class=line>select st.sid, st.sname</span><br><span class=line>from(</span><br><span class=line>	select ss1.sid</span><br><span class=line>	from(</span><br><span class=line>		select s.sid from s1_score s where s.cid = 1</span><br><span class=line>	) as ss1</span><br><span class=line>	join(</span><br><span class=line>		select s.sid from s1_score s where s.cid = 2</span><br><span class=line>	) as ss2</span><br><span class=line>	on ss1.sid = ss2.sid</span><br><span class=line>) as r</span><br><span class=line>join s1_student st on r.sid = st.sid</span><br><span class=line></span><br><span class=line># 解法2</span><br><span class=line>select st.*</span><br><span class=line>from (</span><br><span class=line>	select o1.sid</span><br><span class=line>	from (</span><br><span class=line>		select *</span><br><span class=line>		from s1_score as s</span><br><span class=line>		where s.cid = 1 or s.cid = 2</span><br><span class=line>	) as o1</span><br><span class=line>	group by o1.sid</span><br><span class=line>	having count(o1.cid) = 2</span><br><span class=line>) as oo1</span><br><span class=line>join s1_student as st on oo1.sid = st.sid</span><br></pre></table></figure><h2 id=2-3、查询-只学课程1不学课程2的情况，不存在显示null><a title="2.3、查询 只学课程1不学课程2的情况，不存在显示null" class=headerlink href=#2-3、查询-只学课程1不学课程2的情况，不存在显示null></a>2.3、查询 只学课程1不学课程2的情况，不存在显示null</h2><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre><td class=code><pre><span class=line>select ss1.sid, ss1.cid, ss1.score, ss2.cid as 'v2cid', ss2.score as 'v2score'</span><br><span class=line>from(</span><br><span class=line>	select s.sid, s.cid, s.score from s1_score s where s.cid = 1</span><br><span class=line>) as ss1</span><br><span class=line>left join(</span><br><span class=line>	select s.sid, s.cid, s.score from s1_score s where s.cid = 2</span><br><span class=line>) as ss2</span><br><span class=line>on ss1.sid = ss2.sid;</span><br></pre></table></figure><h2 id=2-4、查询-不存在课程1，但存在课程2的情况><a title="2.4、查询 不存在课程1，但存在课程2的情况" class=headerlink href=#2-4、查询-不存在课程1，但存在课程2的情况></a>2.4、查询 不存在课程1，但存在课程2的情况</h2><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre><td class=code><pre><span class=line>select ss1.sid, ss1.cid, ss1.score, ss2.cid as 'v2cid', ss2.score as 'v2score'</span><br><span class=line>from(</span><br><span class=line>	select s.sid, s.cid, s.score from s1_score s where s.cid = 1</span><br><span class=line>) as ss1</span><br><span class=line>right join(</span><br><span class=line>	select s.sid, s.cid, s.score from s1_score s where s.cid = 2</span><br><span class=line>) as ss2</span><br><span class=line>on ss1.sid = ss2.sid;</span><br></pre></table></figure><h2 id=2-5、查询-平均成绩等于60分的学生编号、学生姓名、平均成绩><a title="2.5、查询 平均成绩等于60分的学生编号、学生姓名、平均成绩" class=headerlink href=#2-5、查询-平均成绩等于60分的学生编号、学生姓名、平均成绩></a>2.5、查询 平均成绩等于60分的学生编号、学生姓名、平均成绩</h2><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br></pre><td class=code><pre><span class=line>select s1_student.sid, s1_student.sname, ss2.avg_score</span><br><span class=line>from s1_student</span><br><span class=line>right join(</span><br><span class=line>	select * from(</span><br><span class=line>		select sid, avg(score) as 'avg_score' from s1_score group by sid</span><br><span class=line>	) as ss1 </span><br><span class=line>	where ss1.avg_score >= 60</span><br><span class=line>) as ss2</span><br><span class=line>on s1_student.sid = ss2.sid</span><br><span class=line></span><br><span class=line># 解法2</span><br><span class=line>select</span><br><span class=line>	st.sid,</span><br><span class=line>	st.sname,</span><br><span class=line>	o1.score_avg as "平均成绩"</span><br><span class=line>from s1_student as st</span><br><span class=line>join (</span><br><span class=line>	select s.sid, avg(score) as "score_avg"</span><br><span class=line>	from s1_score as s</span><br><span class=line>	group by s.sid </span><br><span class=line>	having avg(s.score) >= 60</span><br><span class=line>) as o1</span><br><span class=line>where st.sid = o1.sid</span><br></pre></table></figure><h2 id=2-6、查询-在表s1-score有成绩数据的学生信息><a title="2.6、查询 在表s1_score有成绩数据的学生信息" class=headerlink href=#2-6、查询-在表s1-score有成绩数据的学生信息></a>2.6、查询 在表s1_score有成绩数据的学生信息</h2><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br></pre><td class=code><pre><span class=line>select s1.sid, st.sname</span><br><span class=line>from(</span><br><span class=line>	select DISTINCT sid from s1_score</span><br><span class=line>)as s1 </span><br><span class=line>join s1_student st on s1.sid = st.sid;</span><br><span class=line></span><br><span class=line># 解法2</span><br><span class=line>select</span><br><span class=line>	st.*</span><br><span class=line>from s1_student as st</span><br><span class=line>join (</span><br><span class=line>	select distinct s.sid</span><br><span class=line>	from s1_score as s</span><br><span class=line>) as o1 on st.sid = o1.sid</span><br></pre></table></figure><h2 id=2-7、查询-所有同学的学生编号、学生姓名、选课总数、所有课程总成绩，没成绩显示为null><a title="2.7、查询 所有同学的学生编号、学生姓名、选课总数、所有课程总成绩，没成绩显示为null" class=headerlink href=#2-7、查询-所有同学的学生编号、学生姓名、选课总数、所有课程总成绩，没成绩显示为null></a>2.7、查询 所有同学的学生编号、学生姓名、选课总数、所有课程总成绩，没成绩显示为null</h2><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br></pre><td class=code><pre><span class=line>select st.sid, st.sname, ss1.cnum as '选课数量', ss1.ssum as '总成绩'</span><br><span class=line>from(</span><br><span class=line>	select sid, count(cid) as 'cnum', sum(score) as 'ssum' </span><br><span class=line>	from s1_score </span><br><span class=line>	group by sid</span><br><span class=line>)as ss1 </span><br><span class=line>right join s1_student st on ss1.sid = st.sid</span><br><span class=line></span><br><span class=line># 解法2</span><br><span class=line>select</span><br><span class=line>	st.sid,</span><br><span class=line>	st.sname,</span><br><span class=line>	o1.c_count as "课程数量",</span><br><span class=line>	o1.score_sum as "总成绩"</span><br><span class=line>from s1_student as st</span><br><span class=line>left join (</span><br><span class=line>	select </span><br><span class=line>		s.sid,</span><br><span class=line>		count(s.cid) as "c_count",</span><br><span class=line>		sum(s.score) as "score_sum"</span><br><span class=line>	from s1_score as s</span><br><span class=line>	group by s.sid</span><br><span class=line>)as o1 on st.sid = o1.sid</span><br></pre></table></figure><h2 id=2-8、查询-李姓老师的数量><a title="2.8、查询 李姓老师的数量" class=headerlink href=#2-8、查询-李姓老师的数量></a>2.8、查询 李姓老师的数量</h2><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre><td class=code><pre><span class=line>select count(*) as '李姓老师数量'</span><br><span class=line>from s1_teacher t</span><br><span class=line>where t.tname like '李%'</span><br><span class=line></span><br><span class=line># 解法2</span><br><span class=line>select </span><br><span class=line>	count(t.tid) as "李姓老师数量"</span><br><span class=line>from s1_teacher as t</span><br><span class=line>where t.tname like "李%"</span><br></pre></table></figure><h2 id=2-9、查询-学过张三老师课程的学生信息><a title="2.9、查询 学过张三老师课程的学生信息" class=headerlink href=#2-9、查询-学过张三老师课程的学生信息></a>2.9、查询 学过张三老师课程的学生信息</h2><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br></pre><td class=code><pre><span class=line>select ss2.sid, ss2.sname</span><br><span class=line>from(</span><br><span class=line>	select s.sid from s1_score s where s.cid = (</span><br><span class=line>		select c.cid from s1_course c where c.tid = (</span><br><span class=line>			select t.tid from s1_teacher t where t.tname='张三'</span><br><span class=line>		)</span><br><span class=line>	)</span><br><span class=line>) as ss1</span><br><span class=line>join s1_student ss2 on ss1.sid = ss2.sid</span><br><span class=line></span><br><span class=line># 解法2</span><br><span class=line>select st.*</span><br><span class=line>from s1_student as st</span><br><span class=line>where st.sid in (</span><br><span class=line>	select s.sid</span><br><span class=line>	from s1_score as s</span><br><span class=line>	where s.cid in (</span><br><span class=line>		select c.cid</span><br><span class=line>		from s1_course as c</span><br><span class=line>		where c.tid = (</span><br><span class=line>			select t.tid</span><br><span class=line>			from s1_teacher as t</span><br><span class=line>			where t.tname = "张三"</span><br><span class=line>		)</span><br><span class=line>	)</span><br><span class=line>)</span><br></pre></table></figure><h2 id=2-10、查询-没有学完所有课程的学生信息><a title="2.10、查询 没有学完所有课程的学生信息" class=headerlink href=#2-10、查询-没有学完所有课程的学生信息></a>2.10、查询 没有学完所有课程的学生信息</h2><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br></pre><td class=code><pre><span class=line># 解法1</span><br><span class=line>select ss1.sid, ss1.sname, count(ss1.cid) as cnum</span><br><span class=line>from(</span><br><span class=line>	select s.sid, s.cid, st.sname</span><br><span class=line>	from s1_score s </span><br><span class=line>	join s1_student st on s.sid = st.sid</span><br><span class=line>)as ss1 </span><br><span class=line>group by ss1.sid, ss1.sname</span><br><span class=line>having cnum < (select count(*) from s1_course)</span><br><span class=line></span><br><span class=line># 解法2</span><br><span class=line>select st.sid, st.sname</span><br><span class=line>from s1_student st</span><br><span class=line>join(</span><br><span class=line>	select s.sid, count(*) as 'cnum'</span><br><span class=line>	from s1_score s </span><br><span class=line>	group by s.sid </span><br><span class=line>	having cnum < (select count(*) from s1_course)</span><br><span class=line>)as ss1 on st.sid = ss1.sid</span><br><span class=line></span><br><span class=line># 解法3</span><br><span class=line>select st.*</span><br><span class=line>from s1_student as st</span><br><span class=line>join (</span><br><span class=line>	select s.sid</span><br><span class=line>	from s1_score as s</span><br><span class=line>	group by s.sid</span><br><span class=line>	having count(s.cid) < (</span><br><span class=line>		select count(*) from s1_course</span><br><span class=line>	)</span><br><span class=line>)as o1 on st.sid = o1.sid</span><br></pre></table></figure><h2 id=2-11、查询-至少有一门与学生ID为1的学生学习的课程相同的学生信息><a title="2.11、查询 至少有一门与学生ID为1的学生学习的课程相同的学生信息" class=headerlink href=#2-11、查询-至少有一门与学生ID为1的学生学习的课程相同的学生信息></a>2.11、查询 至少有一门与学生ID为1的学生学习的课程相同的学生信息</h2><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br></pre><td class=code><pre><span class=line>select st.sid, st.sname</span><br><span class=line>from s1_student st</span><br><span class=line>join(</span><br><span class=line>	select DISTINCT s1.sid</span><br><span class=line>	from s1_score s1</span><br><span class=line>	where s1.sid != 1 and s1.cid in(</span><br><span class=line>		select s.cid</span><br><span class=line>		from s1_score s</span><br><span class=line>		where s.sid = 1</span><br><span class=line>	)</span><br><span class=line>)as ss1 on st.sid = ss1.sid</span><br><span class=line></span><br><span class=line># 解法2</span><br><span class=line>select st.*</span><br><span class=line>from s1_student as st</span><br><span class=line>join (</span><br><span class=line>	select distinct s.sid</span><br><span class=line>	from s1_score as s</span><br><span class=line>	where s.cid in (</span><br><span class=line>		select s.cid</span><br><span class=line>		from s1_score as s</span><br><span class=line>		where s.sid = 1</span><br><span class=line>	) and s.sid != 1</span><br><span class=line>) as o1 on st.sid = o1.sid</span><br></pre></table></figure><h2 id=2-12、查询-与学生ID为1的学生所学课程完全相同的学生信息><a title="2.12、查询 与学生ID为1的学生所学课程完全相同的学生信息" class=headerlink href=#2-12、查询-与学生ID为1的学生所学课程完全相同的学生信息></a>2.12、查询 与学生ID为1的学生所学课程完全相同的学生信息</h2><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br></pre><td class=code><pre><span class=line>select st.*</span><br><span class=line>from s1_student st</span><br><span class=line>where st.sid in(</span><br><span class=line>	select ss1.sid</span><br><span class=line>	from(</span><br><span class=line>		select os.sid, os.cid</span><br><span class=line>		from s1_score os</span><br><span class=line>		where os.sid in(</span><br><span class=line>			select s.sid</span><br><span class=line>			from s1_score s</span><br><span class=line>			where s.sid != 1</span><br><span class=line>			group by s.sid</span><br><span class=line>			having count(*) = (select count(*) from s1_score where sid = 1)</span><br><span class=line>		)</span><br><span class=line>	) as ss1</span><br><span class=line>	group by ss1.sid</span><br><span class=line>	having sum(ss1.cid) = (</span><br><span class=line>		select sum(cid)</span><br><span class=line>		from s1_score</span><br><span class=line>		where sid = 1</span><br><span class=line>	)</span><br><span class=line>)</span><br><span class=line></span><br><span class=line># 解法2</span><br><span class=line>select st.*</span><br><span class=line>from s1_student as st</span><br><span class=line>join (</span><br><span class=line>	select s.sid</span><br><span class=line>	from s1_score as s</span><br><span class=line>	join (</span><br><span class=line>		select cid</span><br><span class=line>		from s1_score</span><br><span class=line>		where sid = 1</span><br><span class=line>	) as o1 on s.cid = o1.cid and s.sid != 1</span><br><span class=line>	group by s.sid</span><br><span class=line>	having count(o1.cid) = (</span><br><span class=line>		select count(cid) from s1_score where sid = 1 group by sid </span><br><span class=line>	)</span><br><span class=line>) as o1 on st.sid = o1.sid</span><br></pre></table></figure><h2 id=2-13、查询没学过”张三”老师课程的学生姓名><a class=headerlink href=#2-13、查询没学过”张三”老师课程的学生姓名 title=2.13、查询没学过”张三”老师课程的学生姓名></a>2.13、查询没学过”张三”老师课程的学生姓名</h2><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br></pre><td class=code><pre><span class=line>select st.sid, st.sname</span><br><span class=line>from s1_student st</span><br><span class=line>where st.sid not in(</span><br><span class=line>	select s.sid</span><br><span class=line>	from s1_score as s</span><br><span class=line>	where s.cid = (</span><br><span class=line>		select c.cid</span><br><span class=line>		from s1_course as c</span><br><span class=line>		where c.tid = (select tid from s1_teacher where tname = '张三')</span><br><span class=line>	)</span><br><span class=line>)</span><br><span class=line></span><br><span class=line># 解法2</span><br><span class=line>select st.*</span><br><span class=line>from s1_student as st</span><br><span class=line>where st.sid not in (</span><br><span class=line>	select s.sid</span><br><span class=line>	from s1_score as s</span><br><span class=line>	where s.cid in (</span><br><span class=line>		select c.cid</span><br><span class=line>		from s1_course as c</span><br><span class=line>		where c.tid = (</span><br><span class=line>			select t.tid</span><br><span class=line>			from s1_teacher as t</span><br><span class=line>			where t.tname = "张三"</span><br><span class=line>		)</span><br><span class=line>	)</span><br><span class=line>)</span><br></pre></table></figure><h2 id=2-14、查询有两门及以上课程不及格的同学学号，姓名及其平均成绩><a class=headerlink href=#2-14、查询有两门及以上课程不及格的同学学号，姓名及其平均成绩 title=2.14、查询有两门及以上课程不及格的同学学号，姓名及其平均成绩></a>2.14、查询有两门及以上课程不及格的同学学号，姓名及其平均成绩</h2><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br></pre><td class=code><pre><span class=line>select ost.sid, ost.sname, ss1.avg_score </span><br><span class=line>from s1_student ost</span><br><span class=line>join(</span><br><span class=line>	select os.sid, avg(os.score) as avg_score</span><br><span class=line>	from s1_score os</span><br><span class=line>	where os.sid in(</span><br><span class=line>		select s.sid</span><br><span class=line>		from s1_score as s</span><br><span class=line>		where s.score < 60</span><br><span class=line>		group by s.sid</span><br><span class=line>		having count(s.sid) >= 2</span><br><span class=line>	)</span><br><span class=line>	group by os.sid</span><br><span class=line>) as ss1 on ost.sid = ss1.sid</span><br><span class=line></span><br><span class=line># 解法2</span><br><span class=line>select</span><br><span class=line>	st.*,</span><br><span class=line>	o2.score_avg as "平均成绩"</span><br><span class=line>from s1_student as st</span><br><span class=line>join (</span><br><span class=line>	select s2.sid, avg(s2.score) as "score_avg"</span><br><span class=line>	from s1_score as s2</span><br><span class=line>	where s2.sid in (</span><br><span class=line>		select o1.sid</span><br><span class=line>		from (</span><br><span class=line>			select *</span><br><span class=line>			from s1_score as s</span><br><span class=line>			where s.score < 60 </span><br><span class=line>		) as o1</span><br><span class=line>		group by o1.sid</span><br><span class=line>		having count(o1.cid) >= 2</span><br><span class=line>	)</span><br><span class=line>	group by s2.sid</span><br><span class=line>) as o2 on st.sid = o2.sid</span><br></pre></table></figure><h2 id=2-15、检索”-01-“课程分数小于-60，按分数降序排列的学生信息><a title="2.15、检索” 01 “课程分数小于 60，按分数降序排列的学生信息" class=headerlink href=#2-15、检索”-01-“课程分数小于-60，按分数降序排列的学生信息></a>2.15、检索” 01 “课程分数小于 60，按分数降序排列的学生信息</h2><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br></pre><td class=code><pre><span class=line>select st.*, ss1.cid, ss1.score</span><br><span class=line>from s1_student st</span><br><span class=line>	join(</span><br><span class=line>		select s.sid, s.cid, s.score</span><br><span class=line>		from s1_score as s</span><br><span class=line>		where s.cid = 1 and s.score < 60</span><br><span class=line>		order by s.score desc</span><br><span class=line>	) as ss1 on st.sid = ss1.sid</span><br><span class=line>order by ss1.score desc</span><br><span class=line></span><br><span class=line># 解法2</span><br><span class=line>select s.*</span><br><span class=line>from s1_score as s</span><br><span class=line>where s.cid = 1 and s.score < 60</span><br><span class=line>order by s.score desc</span><br></pre></table></figure><h2 id=2-16、按照平均成绩从高到低展示所有学生的所有课程的成绩以及平均成绩><a class=headerlink href=#2-16、按照平均成绩从高到低展示所有学生的所有课程的成绩以及平均成绩 title=2.16、按照平均成绩从高到低展示所有学生的所有课程的成绩以及平均成绩></a>2.16、按照平均成绩从高到低展示所有学生的所有课程的成绩以及平均成绩</h2><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br></pre><td class=code><pre><span class=line>select st.*, c.cname, s.score, ss1.avg_score</span><br><span class=line>from s1_student as st</span><br><span class=line>	left join(</span><br><span class=line>		select sid, avg(score) as avg_score</span><br><span class=line>		from s1_score</span><br><span class=line>		group by sid</span><br><span class=line>	) as ss1 on st.sid = ss1.sid</span><br><span class=line>	left join s1_score as s on ss1.sid = s.sid</span><br><span class=line>	left join s1_course c on s.cid = c.cid</span><br><span class=line>order by ss1.avg_score desc</span><br><span class=line></span><br><span class=line># 解法2</span><br><span class=line>select </span><br><span class=line>	st.*,</span><br><span class=line>	s2.cid,</span><br><span class=line>	s2.score,</span><br><span class=line>	o1.score_avg as "平均成绩"</span><br><span class=line>from s1_student as st</span><br><span class=line>left join (</span><br><span class=line>	select s.sid, avg(s.score) as "score_avg"</span><br><span class=line>	from s1_score as s</span><br><span class=line>	group by s.sid </span><br><span class=line>) as o1 on st.sid = o1.sid </span><br><span class=line>join s1_score as s2 on o1.sid = s2.sid</span><br><span class=line>join s1_course as c on s2.cid = c.cid</span><br><span class=line>order by o1.score_avg desc</span><br></pre></table></figure><h2 id=2-17、查询各科成绩最高分、最低分和平均分：-以如下形式显示：课程-ID，课程-name，最分，最低分，平均分，及格率，中等率，优良率，优秀率-及格为-60，中等为：70-80，优良为：80-90，优秀为：-90要求输出课程号和选修人数，查询结果按人数降序排列，若人数相同，按课程号升序排列><a title="2.17、查询各科成绩最高分、最低分和平均分： 以如下形式显示：课程 ID，课程 name，最分，最低分，平均分，及格率，中等率，优良率，优秀率 及格为>=60，中等为：70-80，优良为：80-90，优秀为：>=90要求输出课程号和选修人数，查询结果按人数降序排列，若人数相同，按课程号升序排列" class=headerlink href=#2-17、查询各科成绩最高分、最低分和平均分：-以如下形式显示：课程-ID，课程-name，最分，最低分，平均分，及格率，中等率，优良率，优秀率-及格为-60，中等为：70-80，优良为：80-90，优秀为：-90要求输出课程号和选修人数，查询结果按人数降序排列，若人数相同，按课程号升序排列></a>2.17、查询各科成绩最高分、最低分和平均分： 以如下形式显示：课程 ID，课程 name，最分，最低分，平均分，及格率，中等率，优良率，优秀率 及格为>=60，中等为：70-80，优良为：80-90，优秀为：>=90要求输出课程号和选修人数，查询结果按人数降序排列，若人数相同，按课程号升序排列</h2><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br></pre><td class=code><pre><span class=line>select s.cid, c.cname,</span><br><span class=line>			max(s.score) as '最高分',</span><br><span class=line>			min(s.score) as '最低分',</span><br><span class=line>			avg(s.score) as '平均分',</span><br><span class=line>			concat(round(sum(if(s.score >= 60, 1, 0)) * 100 / count(s.score), 2), "%") as '及格率',</span><br><span class=line>			concat(round(sum(if(s.score >= 70, 1, 0)) * 100 / count(s.score), 2), "%") as '中等率',</span><br><span class=line>			concat(round(sum(if(s.score >= 80, 1, 0)) * 100 / count(s.score), 2), "%") as '优良率',</span><br><span class=line>			concat(round(sum(if(s.score >= 90, 1, 0)) * 100 / count(s.score), 2), "%") as '优秀率',</span><br><span class=line>			count(s.score) as '人数'</span><br><span class=line>from s1_score as s</span><br><span class=line>join s1_course c on s.cid = c.cid</span><br><span class=line>group by s.cid, c.cname</span><br><span class=line></span><br><span class=line># 解法2</span><br><span class=line>select</span><br><span class=line>	s.cid,</span><br><span class=line>	c.cname,</span><br><span class=line>	max(s.score) as "最高分",</span><br><span class=line>	min(s.score) as "最低分",</span><br><span class=line>	avg(s.score) as "平均分",</span><br><span class=line>	CONCAT(ROUND(SUM(IF(s.score >= 60, 1, 0)) * 100 / COUNT(s.score), 2), "%") as "及格率",</span><br><span class=line>	CONCAT(ROUND(SUM(IF(s.score >= 70 and s.score < 80, 1, 0)) * 100 / COUNT(s.score), 2), "%") as "中等率",</span><br><span class=line>	CONCAT(ROUND(SUM(IF(s.score >= 80 and s.score < 90, 1, 0)) * 100 / COUNT(s.score), 2), "%") as "优良率",</span><br><span class=line>	CONCAT(ROUND(SUM(IF(s.score >= 90, 1, 0)) * 100 / COUNT(s.score), 2), "%") as "优秀率",</span><br><span class=line>	count(s.sid) as "人数"</span><br><span class=line>from s1_score as s</span><br><span class=line>join s1_course as c on s.cid = c.cid</span><br><span class=line>group by s.cid, c.cname</span><br><span class=line>order by "人数" desc, s.cid asc</span><br></pre></table></figure><h2 id=2-18、按各科平均成绩进行排序，并显示排名><a class=headerlink href=#2-18、按各科平均成绩进行排序，并显示排名 title=2.18、按各科平均成绩进行排序，并显示排名></a>2.18、按各科平均成绩进行排序，并显示排名</h2><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br></pre><td class=code><pre><span class=line>set @i:=0;</span><br><span class=line>select ss1.cid, ss1.avg_score, @i:=@i + 1 as '名次'</span><br><span class=line>from (</span><br><span class=line>	select s.cid, avg(s.score) as avg_score</span><br><span class=line>	from s1_score s</span><br><span class=line>	group by s.cid</span><br><span class=line>	order by avg_score desc</span><br><span class=line>) as ss1</span><br><span class=line></span><br><span class=line># 解法2</span><br><span class=line>set @i:=0;</span><br><span class=line>select </span><br><span class=line>	o1.cid,</span><br><span class=line>	o1.score_avg as "平均成绩",</span><br><span class=line>	@i := @i + 1 as "排名"</span><br><span class=line>from (</span><br><span class=line>	select s.cid, avg(s.score) as "score_avg"</span><br><span class=line>	from s1_score as s</span><br><span class=line>	group by s.cid</span><br><span class=line>	order by score_avg desc</span><br><span class=line>) as o1</span><br></pre></table></figure><h2 id=2-19、按各科平均成绩进行排序，并显示排名，重复时不保留名次空缺><a class=headerlink href=#2-19、按各科平均成绩进行排序，并显示排名，重复时不保留名次空缺 title=2.19、按各科平均成绩进行排序，并显示排名，重复时不保留名次空缺></a>2.19、按各科平均成绩进行排序，并显示排名，重复时不保留名次空缺</h2><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br></pre><td class=code><pre><span class=line>set @a:=0;</span><br><span class=line>select ss1.cid, ss1.avg_score, @a:=@a+1 as '排名'</span><br><span class=line>from (</span><br><span class=line>	select s.cid, avg(s.score) as avg_score</span><br><span class=line>	from s1_score as s</span><br><span class=line>	group by s.cid</span><br><span class=line>) as ss1</span><br><span class=line></span><br><span class=line># rank函数：1、2、3、3、5、6</span><br><span class=line>select </span><br><span class=line>	rank() over (order by s.score desc) as s_rank,</span><br><span class=line>	s.sid,</span><br><span class=line>	s.cid,</span><br><span class=line>	s.score</span><br><span class=line>from s1_score s</span><br><span class=line></span><br><span class=line># dense_rank函数：1、2、3、3、4、5</span><br><span class=line>select </span><br><span class=line>	dense_rank() over (order by s.score desc) as s_dense_rank,</span><br><span class=line>	s.sid,</span><br><span class=line>	s.cid,</span><br><span class=line>	s.score</span><br><span class=line>from s1_score s</span><br><span class=line></span><br><span class=line># row_numver函数：1、2、3、4、5、6</span><br><span class=line>select </span><br><span class=line>	row_number() over (order by s.score desc) as s_row_number,</span><br><span class=line>	s.sid,</span><br><span class=line>	s.cid,</span><br><span class=line>	s.score</span><br><span class=line>from s1_score s</span><br></pre></table></figure><h2 id=2-20、查询学生的总成绩，并进行排名，总分重复时保留名次空缺><a class=headerlink href=#2-20、查询学生的总成绩，并进行排名，总分重复时保留名次空缺 title=2.20、查询学生的总成绩，并进行排名，总分重复时保留名次空缺></a>2.20、查询学生的总成绩，并进行排名，总分重复时保留名次空缺</h2><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br></pre><td class=code><pre><span class=line>set @i := 0;</span><br><span class=line>set @j := 0;</span><br><span class=line>set @p := 0;</span><br><span class=line>set @q := 0;</span><br><span class=line>select </span><br><span class=line>	ss1.sid,</span><br><span class=line>	ss1.sum_score as '总分',</span><br><span class=line>	@j := @j + 1,</span><br><span class=line>	@p := ss1.sum_score,</span><br><span class=line>	if(@p = @q, @j, @i := @j) as '排名',</span><br><span class=line>	@q := @p</span><br><span class=line>from (</span><br><span class=line>	select sid, sum(score) as sum_score</span><br><span class=line>	from s1_score</span><br><span class=line>	group by sid</span><br><span class=line>	order by sum_score desc</span><br><span class=line>) as ss1</span><br><span class=line></span><br><span class=line></span><br><span class=line># 解法2</span><br><span class=line>select </span><br><span class=line>	dense_rank() over(order by ss1.sum_score desc) as '排名',</span><br><span class=line>	ss1.sid,</span><br><span class=line>	ss1.sum_score</span><br><span class=line>from (</span><br><span class=line>	select s.sid, sum(s.score) as sum_score</span><br><span class=line>	from s1_score as s</span><br><span class=line>	group by s.sid</span><br><span class=line>) as ss1</span><br><span class=line></span><br><span class=line></span><br><span class=line># 解法3</span><br><span class=line>set @p:=0;</span><br><span class=line>set @q:=0;</span><br><span class=line>set @i:=0;</span><br><span class=line>select</span><br><span class=line>	o1.sid, </span><br><span class=line>	o1.score_sum,</span><br><span class=line>	@p:=o1.score_sum,</span><br><span class=line>	IF(@p=@q, @i, @i:=@i+1) as "名次",</span><br><span class=line>	@q:=@p</span><br><span class=line>from (</span><br><span class=line>	select</span><br><span class=line>		s.sid,</span><br><span class=line>		sum(s.score) as "score_sum"</span><br><span class=line>	from s1_score as s</span><br><span class=line>	group by s.sid</span><br><span class=line>	order by score_sum desc</span><br><span class=line>) as o1</span><br></pre></table></figure><h2 id=2-21、查询学生的总成绩，并进行排名，总分重复时不保留名次空缺><a class=headerlink href=#2-21、查询学生的总成绩，并进行排名，总分重复时不保留名次空缺 title=2.21、查询学生的总成绩，并进行排名，总分重复时不保留名次空缺></a>2.21、查询学生的总成绩，并进行排名，总分重复时不保留名次空缺</h2><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br></pre><td class=code><pre><span class=line>set @p:=0;</span><br><span class=line>set @q:=0;</span><br><span class=line>set @i:=0;</span><br><span class=line>select</span><br><span class=line>	o1.sid, </span><br><span class=line>	o1.score_sum,</span><br><span class=line>	@p:=o1.score_sum,</span><br><span class=line>	IF(@p=@q, @i, @i:=@i+1) as "名次",</span><br><span class=line>	@q:=@p</span><br><span class=line>from (</span><br><span class=line>	select</span><br><span class=line>		s.sid,</span><br><span class=line>		sum(s.score) as "score_sum"</span><br><span class=line>	from s1_score as s</span><br><span class=line>	group by s.sid</span><br><span class=line>	order by score_sum desc</span><br><span class=line>) as o1</span><br></pre></table></figure><h2 id=2-22、统计各科成绩各分数段人数：课程编号，课程名称，-100-85），-85-70），-70-60），-60-0）及所占百分。><a class=headerlink href=#2-22、统计各科成绩各分数段人数：课程编号，课程名称，-100-85），-85-70），-70-60），-60-0）及所占百分。 title=2.22、统计各科成绩各分数段人数：课程编号，课程名称，[100-85），[85-70），[70-60），[60-0）及所占百分。></a>2.22、统计各科成绩各分数段人数：课程编号，课程名称，[100-85），[85-70），[70-60），[60-0）及所占百分。</h2><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br></pre><td class=code><pre><span class=line>select </span><br><span class=line>	s.cid,</span><br><span class=line>	c.cname,</span><br><span class=line>	CONCAT(ROUND(SUM(IF(score <= 100 and score > 85, 1, 0)) * 100 / COUNT(s.sid), 2), "%") as "[100, 85)",</span><br><span class=line>	CONCAT(ROUND(SUM(IF(score <= 85 and score > 70, 1, 0)) * 100 / COUNT(s.sid), 2), "%") as "[85, 70)",</span><br><span class=line>	CONCAT(ROUND(SUM(IF(score <= 70 and score > 60, 1, 0)) * 100 / COUNT(s.sid), 2), "%") as "[70, 60)",</span><br><span class=line>	CONCAT(ROUND(SUM(IF(score <= 60 and score > 0, 1, 0)) * 100 / COUNT(s.sid), 2), "%") as "[60, 0)"</span><br><span class=line>from s1_score as s</span><br><span class=line>join s1_course as c on s.cid = c.cid</span><br><span class=line>group by s.cid, c.cname</span><br></pre></table></figure><h2 id=2-23、查询各科成绩前三名的记录><a class=headerlink href=#2-23、查询各科成绩前三名的记录 title=2.23、查询各科成绩前三名的记录></a>2.23、查询各科成绩前三名的记录</h2><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br></pre><td class=code><pre><span class=line>set @i := 0;</span><br><span class=line>set @p := 0;</span><br><span class=line>set @q := 0;</span><br><span class=line>select</span><br><span class=line>	o2.sid,</span><br><span class=line>	st.sname,</span><br><span class=line>	o2.cid,</span><br><span class=line>	o2.score,</span><br><span class=line>	o2.rn</span><br><span class=line>from (</span><br><span class=line>	select</span><br><span class=line>		o1.sid,</span><br><span class=line>		o1.cid,</span><br><span class=line>		o1.score,</span><br><span class=line>		@p := o1.cid,</span><br><span class=line>		IF(@p = @q, @i := @i + 1, @i := 1) as rn,</span><br><span class=line>		@q := @p</span><br><span class=line>	from (</span><br><span class=line>		select s.sid, s.cid, s.score</span><br><span class=line>		from s1_score s</span><br><span class=line>		order by s.cid asc, s.score desc</span><br><span class=line>	) as o1</span><br><span class=line>) as o2 </span><br><span class=line>	join s1_student st on o2.sid = st.sid and o2.rn <=3</span><br><span class=line>order by cid, rn</span><br><span class=line></span><br><span class=line></span><br><span class=line># 解法2</span><br><span class=line>set @p:=0;</span><br><span class=line>set @q:=0;</span><br><span class=line>set @i:=0;</span><br><span class=line>select</span><br><span class=line>	o1.sid,</span><br><span class=line>	o1.cid,</span><br><span class=line>	o1.score,</span><br><span class=line>	o1.score_level as "名次"</span><br><span class=line>from (</span><br><span class=line>	select</span><br><span class=line>		s.*,</span><br><span class=line>		@p:=s.cid,</span><br><span class=line>		IF(@p=@q, @i:=@i+1, @i:=1) as "score_level",</span><br><span class=line>		@q:=@p</span><br><span class=line>	from s1_score as s</span><br><span class=line>	order by s.cid asc, s.score desc</span><br><span class=line>) as o1</span><br><span class=line>where o1.score_level < 4</span><br></pre></table></figure><h2 id=2-24、查询每门课程被选修的学生数><a class=headerlink href=#2-24、查询每门课程被选修的学生数 title=2.24、查询每门课程被选修的学生数></a>2.24、查询每门课程被选修的学生数</h2><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br></pre><td class=code><pre><span class=line>select c.cid, c.cname, o1.count_st as "学生数量"</span><br><span class=line>from s1_course c</span><br><span class=line>join (</span><br><span class=line>	select</span><br><span class=line>		s.cid,</span><br><span class=line>		count(s.sid) as count_st</span><br><span class=line>	from s1_score s</span><br><span class=line>	group by s.cid</span><br><span class=line>) as o1 on c.cid = o1.cid</span><br><span class=line></span><br><span class=line># 解法2</span><br><span class=line>select</span><br><span class=line>	c.cname,</span><br><span class=line>	o1.s_count as "人数"</span><br><span class=line>from s1_course as c</span><br><span class=line>join (</span><br><span class=line>	select</span><br><span class=line>		s.cid,</span><br><span class=line>		count(s.sid) as "s_count"</span><br><span class=line>	from s1_score as s</span><br><span class=line>	group by s.cid</span><br><span class=line>) as o1 on c.cid = o1.cid</span><br></pre></table></figure><h2 id=2-25、查询出只选修两门课程的学生学号和姓名><a class=headerlink href=#2-25、查询出只选修两门课程的学生学号和姓名 title=2.25、查询出只选修两门课程的学生学号和姓名></a>2.25、查询出只选修两门课程的学生学号和姓名</h2><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br></pre><td class=code><pre><span class=line>select st.sid, st.sname</span><br><span class=line>from s1_student as st</span><br><span class=line>	join (</span><br><span class=line>		select s.sid, count(s.cid) as count_cid</span><br><span class=line>		from s1_score s</span><br><span class=line>		group by s.sid</span><br><span class=line>		having count_cid = 2</span><br><span class=line>	) as o1 on st.sid = o1.sid</span><br><span class=line></span><br><span class=line># 解法2</span><br><span class=line>select</span><br><span class=line>	st.sid,</span><br><span class=line>	st.sname</span><br><span class=line>from s1_student as st</span><br><span class=line>join (</span><br><span class=line>	select s.sid, count(s.cid) as "c_count"</span><br><span class=line>	from s1_score as s</span><br><span class=line>	group by s.sid</span><br><span class=line>	having c_count = 2</span><br><span class=line>) as o1 on st.sid = o1.sid</span><br></pre></table></figure><h2 id=2-26、查询男生、女生人数><a class=headerlink href=#2-26、查询男生、女生人数 title=2.26、查询男生、女生人数></a>2.26、查询男生、女生人数</h2><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br></pre><td class=code><pre><span class=line>select st.sex, count(st.sid) as "人数"</span><br><span class=line>from s1_student st</span><br><span class=line>group by st.sex</span><br><span class=line></span><br><span class=line># 解法2</span><br><span class=line>select</span><br><span class=line>	st.sex,</span><br><span class=line>	count(st.sid) as "人数"</span><br><span class=line>from s1_student as st</span><br><span class=line>group by st.sex</span><br></pre></table></figure><h2 id=2-27、查询名字中含有「风」字的学生信息><a class=headerlink href=#2-27、查询名字中含有「风」字的学生信息 title=2.27、查询名字中含有「风」字的学生信息></a>2.27、查询名字中含有「风」字的学生信息</h2><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre><td class=code><pre><span class=line>select st.*</span><br><span class=line>from s1_student as st</span><br><span class=line>where st.sname like "%风%";</span><br><span class=line></span><br><span class=line># 解法2</span><br><span class=line>select st.*</span><br><span class=line>from s1_student as st</span><br><span class=line>where st.sname like "%风%";</span><br></pre></table></figure><h2 id=2-28、查询同名同性学生名单，并统计同名同性人数><a class=headerlink href=#2-28、查询同名同性学生名单，并统计同名同性人数 title=2.28、查询同名同性学生名单，并统计同名同性人数></a>2.28、查询同名同性学生名单，并统计同名同性人数</h2><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br></pre><td class=code><pre><span class=line>select st.sname, st.sex, count(st.sid) as count_sid</span><br><span class=line>from s1_student as st</span><br><span class=line>group by st.sname, st.sex</span><br><span class=line>having count_sid > 1</span><br><span class=line></span><br><span class=line># 解法2</span><br><span class=line>select</span><br><span class=line>	st.sname,</span><br><span class=line>	count(st.sid) as "s_count"</span><br><span class=line>from s1_student as st</span><br><span class=line>group by st.sname</span><br><span class=line>having s_count > 1</span><br></pre></table></figure><h2 id=2-29、查询-1990-年出生的学生名单><a title="2.29、查询 1990 年出生的学生名单" class=headerlink href=#2-29、查询-1990-年出生的学生名单></a>2.29、查询 1990 年出生的学生名单</h2><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br></pre><td class=code><pre><span class=line>set @c := 0;</span><br><span class=line>select </span><br><span class=line>	o1.sid,</span><br><span class=line>	o1.sname,</span><br><span class=line>	o1.age,</span><br><span class=line>	o1.sex</span><br><span class=line>from (</span><br><span class=line>	select </span><br><span class=line>		st.sid,</span><br><span class=line>		st.sname,</span><br><span class=line>		st.age,</span><br><span class=line>		st.sex,</span><br><span class=line>		@c := st.age,</span><br><span class=line>		IF(@c = (2023 - 1990), 1, 0) as is90</span><br><span class=line>	from s1_student as st</span><br><span class=line>) as o1</span><br><span class=line>where o1.is90 = 1</span><br><span class=line></span><br><span class=line># 解法2</span><br><span class=line>select st.*</span><br><span class=line>from s1_student as st</span><br><span class=line>where st.birth like "1990%"</span><br><span class=line></span><br><span class=line># 解法3</span><br><span class=line>select st.*</span><br><span class=line>from s1_student as st</span><br><span class=line>where EXTRACT(year from st.birth) = 1990</span><br></pre></table></figure><h2 id=2-30、查询每门课程的平均成绩，结果按平均成绩降序排列，平均成绩相同时，按课程编号升序排列><a class=headerlink href=#2-30、查询每门课程的平均成绩，结果按平均成绩降序排列，平均成绩相同时，按课程编号升序排列 title=2.30、查询每门课程的平均成绩，结果按平均成绩降序排列，平均成绩相同时，按课程编号升序排列></a>2.30、查询每门课程的平均成绩，结果按平均成绩降序排列，平均成绩相同时，按课程编号升序排列</h2><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br></pre><td class=code><pre><span class=line>select s.cid, avg(s.score) as avg_score</span><br><span class=line>from s1_score s</span><br><span class=line>group by s.cid</span><br><span class=line>order by avg_score desc, cid asc</span><br><span class=line></span><br><span class=line># 解法2</span><br><span class=line>select</span><br><span class=line>	s.cid,</span><br><span class=line>	avg(s.score) as "score_avg"</span><br><span class=line>from s1_score as s</span><br><span class=line>group by s.cid</span><br><span class=line>order by score_avg desc, s.cid asc</span><br></pre></table></figure><h2 id=2-31、查询平均成绩大于等于-85-的所有学生的学号、姓名和平均成绩><a title="2.31、查询平均成绩大于等于 85 的所有学生的学号、姓名和平均成绩" class=headerlink href=#2-31、查询平均成绩大于等于-85-的所有学生的学号、姓名和平均成绩></a>2.31、查询平均成绩大于等于 85 的所有学生的学号、姓名和平均成绩</h2><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br></pre><td class=code><pre><span class=line>select st.sid, st.sname, o1.avg_score as "平均成绩"</span><br><span class=line>from s1_student as st</span><br><span class=line>join (</span><br><span class=line>	select s.sid, avg(s.score) as avg_score</span><br><span class=line>	from s1_score as s</span><br><span class=line>	group by s.sid</span><br><span class=line>	having avg_score >= 85</span><br><span class=line>) as o1 on st.sid = o1.sid</span><br><span class=line></span><br><span class=line># 解法2</span><br><span class=line>select</span><br><span class=line>	st.sid,</span><br><span class=line>	st.sname,</span><br><span class=line>	o1.score_avg as "平均成绩"</span><br><span class=line>from s1_student as st</span><br><span class=line>join (</span><br><span class=line>	select</span><br><span class=line>		s.sid,</span><br><span class=line>		avg(s.score) as score_avg</span><br><span class=line>	from s1_score as s</span><br><span class=line>	group by s.sid</span><br><span class=line>	having score_avg >= 85</span><br><span class=line>) as o1 on st.sid = o1.sid</span><br></pre></table></figure><h2 id=2-32、查询课程名称为「数学」，且分数低于-60-的学生姓名和分数><a title="2.32、查询课程名称为「数学」，且分数低于 60 的学生姓名和分数" class=headerlink href=#2-32、查询课程名称为「数学」，且分数低于-60-的学生姓名和分数></a>2.32、查询课程名称为「数学」，且分数低于 60 的学生姓名和分数</h2><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br></pre><td class=code><pre><span class=line>select st.sname, c.cname, s.score</span><br><span class=line>from s1_course as c</span><br><span class=line>join s1_score as s on c.cid = s.cid</span><br><span class=line>join s1_student as st on s.sid = st.sid</span><br><span class=line>where c.cname = "数学" and s.score < 60</span><br><span class=line></span><br><span class=line># 解法2</span><br><span class=line>select</span><br><span class=line>	st.sname,</span><br><span class=line>	o1.score</span><br><span class=line>from s1_student as st</span><br><span class=line>join (</span><br><span class=line>	select s.sid, s.score</span><br><span class=line>	from s1_score as s</span><br><span class=line>	where s.score < 60 and s.cid = (</span><br><span class=line>		select cid from s1_course where cname = "数学"</span><br><span class=line>	)</span><br><span class=line>) as o1 on st.sid = o1.sid</span><br></pre></table></figure><h2 id=2-33、查询所有学生的课程及分数情况（存在学生没成绩，没选课的情况）><a class=headerlink href=#2-33、查询所有学生的课程及分数情况（存在学生没成绩，没选课的情况） title=2.33、查询所有学生的课程及分数情况（存在学生没成绩，没选课的情况）></a>2.33、查询所有学生的课程及分数情况（存在学生没成绩，没选课的情况）</h2><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br></pre><td class=code><pre><span class=line>select </span><br><span class=line>	st.sname,</span><br><span class=line>	o1.语文成绩, </span><br><span class=line>	o1.数学成绩,</span><br><span class=line>	o1.英语成绩 </span><br><span class=line>from s1_student as st</span><br><span class=line>left join (</span><br><span class=line>	select </span><br><span class=line>		s.sid,</span><br><span class=line>		SUM(CASE s.cid when 1 then s.score else 0 end) as "数学成绩",</span><br><span class=line>		SUM(CASE s.cid when 2 then s.score else 0 end) as "语文成绩",</span><br><span class=line>		SUM(CASE s.cid when 3 then s.score else 0 end) as "英语成绩"</span><br><span class=line>	from s1_score as s</span><br><span class=line>	group by s.sid</span><br><span class=line>) as o1 on st.sid = o1.sid</span><br><span class=line></span><br><span class=line># 解法2</span><br><span class=line>select</span><br><span class=line>	st.sid,</span><br><span class=line>	st.sname,</span><br><span class=line>	o1.语文成绩,</span><br><span class=line>	o1.数学成绩,</span><br><span class=line>	o1.英语成绩</span><br><span class=line>from s1_student as st</span><br><span class=line>left join (</span><br><span class=line>	select</span><br><span class=line>		s.sid,</span><br><span class=line>		SUM(case s.cid when 2 then score else 0 end) as "语文成绩",</span><br><span class=line>		SUM(case s.cid when 1 then score else 0 end) as "数学成绩",</span><br><span class=line>		SUM(case s.cid when 3 then score else 0 end) as "英语成绩"</span><br><span class=line>	from s1_score as s</span><br><span class=line>	group by s.sid</span><br><span class=line>) as o1 on st.sid = o1.sid</span><br></pre></table></figure><h2 id=2-34、查询任何一门课程成绩在-70-分以上的姓名、课程名称和分数><a title="2.34、查询任何一门课程成绩在 70 分以上的姓名、课程名称和分数" class=headerlink href=#2-34、查询任何一门课程成绩在-70-分以上的姓名、课程名称和分数></a>2.34、查询任何一门课程成绩在 70 分以上的姓名、课程名称和分数</h2><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br></pre><td class=code><pre><span class=line>select </span><br><span class=line>	o1.sid,</span><br><span class=line>	SUM(case s.cid when 2 then s.score else 0 end) as "语文成绩",</span><br><span class=line>	SUM(case s.cid when 1 then s.score else 0 end) as "数学成绩",</span><br><span class=line>	SUM(case s.cid when 3 then s.score else 0 end) as "英语成绩"</span><br><span class=line>from (</span><br><span class=line>	select o1.sid</span><br><span class=line>	from (</span><br><span class=line>		select s.*</span><br><span class=line>		from s1_score as s</span><br><span class=line>		where s.score > 70</span><br><span class=line>	) as o1</span><br><span class=line>	group by o1.sid</span><br><span class=line>	having count(o1.cid) = (select count(cid) from s1_course)</span><br><span class=line>) as o1 </span><br><span class=line>	join s1_student as st on o1.sid = st.sid</span><br><span class=line>	join s1_score as s on st.sid = s.sid</span><br><span class=line>	join s1_course as c on s.cid = c.cid</span><br><span class=line>group by o1.sid</span><br><span class=line></span><br><span class=line># 解法2</span><br><span class=line>select st.sname, c.cname, o1.score</span><br><span class=line>from (</span><br><span class=line>	select s.sid, s.cid, s.score</span><br><span class=line>	from s1_score as s</span><br><span class=line>	where s.score > 70</span><br><span class=line>) as o1 </span><br><span class=line>	join s1_student as st on o1.sid = st.sid</span><br><span class=line>	join s1_course as c on o1.cid = c.cid</span><br><span class=line></span><br><span class=line># 解法3</span><br><span class=line>select</span><br><span class=line>	st.sname,</span><br><span class=line>	c.cname,</span><br><span class=line>	o1.score</span><br><span class=line>from s1_course as c</span><br><span class=line>join (</span><br><span class=line>	select s.sid, s.cid, s.score</span><br><span class=line>	from s1_score as s</span><br><span class=line>	where s.score > 70</span><br><span class=line>) as o1 on c.cid = o1.cid</span><br><span class=line>join s1_student as st on o1.sid = st.sid</span><br></pre></table></figure><h2 id=2-35、查询不及格的课程><a class=headerlink href=#2-35、查询不及格的课程 title=2.35、查询不及格的课程></a>2.35、查询不及格的课程</h2><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br></pre><td class=code><pre><span class=line>select</span><br><span class=line>	st.sname,</span><br><span class=line>	c.cname,</span><br><span class=line>	o1.score</span><br><span class=line>from (</span><br><span class=line>	select s.sid, s.cid, s.score</span><br><span class=line>	from s1_score as s</span><br><span class=line>	where s.score < 60</span><br><span class=line>)as o1</span><br><span class=line>	join s1_student as st on o1.sid = st.sid</span><br><span class=line>	join s1_course as c on o1.cid = c.cid</span><br><span class=line></span><br><span class=line># 解法2</span><br><span class=line>select</span><br><span class=line>	o1.sid,</span><br><span class=line>	c.cname,</span><br><span class=line>	o1.score</span><br><span class=line>from s1_course as c</span><br><span class=line>join (</span><br><span class=line>	select s.*</span><br><span class=line>	from s1_score as s</span><br><span class=line>	where s.score < 60</span><br><span class=line>) as o1 on c.cid = o1.cid</span><br></pre></table></figure><h2 id=2-36、查询课程编号为-01-且课程成绩在-80-分以上的学生的学号和姓名><a title="2.36、查询课程编号为 01 且课程成绩在 80 分以上的学生的学号和姓名" class=headerlink href=#2-36、查询课程编号为-01-且课程成绩在-80-分以上的学生的学号和姓名></a>2.36、查询课程编号为 01 且课程成绩在 80 分以上的学生的学号和姓名</h2><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br></pre><td class=code><pre><span class=line>select st.sid, st.sname</span><br><span class=line>from s1_student as st</span><br><span class=line>	join (</span><br><span class=line>		select s.sid</span><br><span class=line>		from s1_score as s</span><br><span class=line>		where s.cid = 1 and s.score >= 80</span><br><span class=line>	) as o1 on st.sid = o1.sid</span><br><span class=line></span><br><span class=line># 解法2</span><br><span class=line>select</span><br><span class=line>	st.sid,</span><br><span class=line>	st.sname,</span><br><span class=line>	o1.score</span><br><span class=line>from s1_student as st</span><br><span class=line>join (</span><br><span class=line>	select s.sid, s.score</span><br><span class=line>	from s1_score as s</span><br><span class=line>	where s.cid = 1 and s.score > 80</span><br><span class=line>) as o1 on st.sid = o1.sid</span><br></pre></table></figure><h2 id=2-37、求每门课程的学生人数><a class=headerlink href=#2-37、求每门课程的学生人数 title=2.37、求每门课程的学生人数></a>2.37、求每门课程的学生人数</h2><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br></pre><td class=code><pre><span class=line>select s.cid, count(s.sid) as "人数"</span><br><span class=line>from s1_score as s</span><br><span class=line>group by s.cid</span><br><span class=line></span><br><span class=line># 解法2</span><br><span class=line>select</span><br><span class=line>	c.cname,</span><br><span class=line>	o1.s_count as "人数"</span><br><span class=line>from s1_course as c</span><br><span class=line>join (</span><br><span class=line>	select</span><br><span class=line>		s.cid,</span><br><span class=line>		count(s.sid) as "s_count"</span><br><span class=line>	from s1_score as s</span><br><span class=line>	group by s.cid </span><br><span class=line>) as o1 on c.cid = o1.cid</span><br></pre></table></figure><h2 id=2-38、成绩不重复，查询选修「张三」老师所授课程的学生中，成绩最高的学生信息及其成绩><a class=headerlink href=#2-38、成绩不重复，查询选修「张三」老师所授课程的学生中，成绩最高的学生信息及其成绩 title=2.38、成绩不重复，查询选修「张三」老师所授课程的学生中，成绩最高的学生信息及其成绩></a>2.38、成绩不重复，查询选修「张三」老师所授课程的学生中，成绩最高的学生信息及其成绩</h2><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br></pre><td class=code><pre><span class=line>select </span><br><span class=line>	st.sid,</span><br><span class=line>	st.sname, </span><br><span class=line>	o1.score</span><br><span class=line>from (</span><br><span class=line>	select s.sid, s.cid, s.score</span><br><span class=line>	from s1_score as s</span><br><span class=line>	where s.cid in (</span><br><span class=line>		select c.cid</span><br><span class=line>		from s1_course as c </span><br><span class=line>		where c.tid = (</span><br><span class=line>			select t.tid from s1_teacher as t where t.tname = "张三"</span><br><span class=line>		)</span><br><span class=line>	)</span><br><span class=line>	order by s.score desc</span><br><span class=line>	limit 1</span><br><span class=line>) as o1 </span><br><span class=line>	join s1_student as st on o1.sid = st.sid</span><br><span class=line></span><br><span class=line># 解法2</span><br><span class=line>select</span><br><span class=line>	st.*,</span><br><span class=line>	o2.score</span><br><span class=line>from s1_student as st</span><br><span class=line>join (</span><br><span class=line>	select o1.*</span><br><span class=line>	from (</span><br><span class=line>		select s.*</span><br><span class=line>		from s1_score as s</span><br><span class=line>		where s.cid in (</span><br><span class=line>			select c.cid</span><br><span class=line>			from s1_course as c</span><br><span class=line>			where c.tid = (</span><br><span class=line>				select t.tid</span><br><span class=line>				from s1_teacher as t</span><br><span class=line>				where t.tname = "张三"</span><br><span class=line>			)</span><br><span class=line>		)</span><br><span class=line>	) as o1</span><br><span class=line>	order by o1.score desc</span><br><span class=line>	limit 0, 1</span><br><span class=line>) as o2 on st.sid = o2.sid</span><br></pre></table></figure><h2 id=2-39、成绩有重复的情况下，查询选修「张三」老师所授课程的学生中，成绩最高的学生信息及其成绩><a class=headerlink href=#2-39、成绩有重复的情况下，查询选修「张三」老师所授课程的学生中，成绩最高的学生信息及其成绩 title=2.39、成绩有重复的情况下，查询选修「张三」老师所授课程的学生中，成绩最高的学生信息及其成绩></a>2.39、成绩有重复的情况下，查询选修「张三」老师所授课程的学生中，成绩最高的学生信息及其成绩</h2><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br><span class=line>61</span><br><span class=line>62</span><br><span class=line>63</span><br><span class=line>64</span><br><span class=line>65</span><br><span class=line>66</span><br><span class=line>67</span><br><span class=line>68</span><br></pre><td class=code><pre><span class=line>set @i := 0;</span><br><span class=line>set @p := 0;</span><br><span class=line>set @q := 0;</span><br><span class=line>select </span><br><span class=line>	st.sname,</span><br><span class=line>	o2.sid,</span><br><span class=line>	o2.cid,</span><br><span class=line>	o2.score</span><br><span class=line>from (</span><br><span class=line>	select </span><br><span class=line>		o1.sid,</span><br><span class=line>		o1.cid,</span><br><span class=line>		o1.score,</span><br><span class=line>		@p := o1.score,</span><br><span class=line>		IF(@p = @q, @i, @i :=@i + 1) as paix,</span><br><span class=line>		@q := @p</span><br><span class=line>	from (</span><br><span class=line>		select s.sid, s.cid, s.score</span><br><span class=line>		from s1_score as s </span><br><span class=line>		where s.cid in (</span><br><span class=line>			select c.cid</span><br><span class=line>			from s1_course as c</span><br><span class=line>			where c.tid = (</span><br><span class=line>				select t.tid</span><br><span class=line>				from s1_teacher as t </span><br><span class=line>				where t.tname = "张三"</span><br><span class=line>			)</span><br><span class=line>		)</span><br><span class=line>		order by s.score desc</span><br><span class=line>	) as o1</span><br><span class=line>) as o2</span><br><span class=line>join s1_student as st on o2.sid = st.sid and o2.paix = 1</span><br><span class=line></span><br><span class=line></span><br><span class=line># 解法2</span><br><span class=line>set @p:=0;</span><br><span class=line>set @q:=0;</span><br><span class=line>set @i:=0;</span><br><span class=line>select</span><br><span class=line>	st.*,</span><br><span class=line>	o3.score</span><br><span class=line>from s1_student as st</span><br><span class=line>join (</span><br><span class=line>	select o2.*</span><br><span class=line>	from (</span><br><span class=line>		select</span><br><span class=line>			o1.sid,</span><br><span class=line>			o1.score,</span><br><span class=line>			@p:=o1.score,</span><br><span class=line>			IF(@p=@q, @i, @i:=@i+1) as "score_level",</span><br><span class=line>			@q=@p</span><br><span class=line>		from (</span><br><span class=line>			select s.*</span><br><span class=line>			from s1_score as s</span><br><span class=line>			where s.cid in (</span><br><span class=line>				select c.cid</span><br><span class=line>				from s1_course as c</span><br><span class=line>				where c.tid = (</span><br><span class=line>					select t.tid</span><br><span class=line>					from s1_teacher as t</span><br><span class=line>					where t.tname = "张三"</span><br><span class=line>				)</span><br><span class=line>			)</span><br><span class=line>			order by s.score desc</span><br><span class=line>		) as o1</span><br><span class=line>	) as o2 </span><br><span class=line>	where o2.score_level = 1</span><br><span class=line>) as o3 on st .sid = o3.sid</span><br></pre></table></figure><h2 id=2-40、查询不同课程成绩相同的学生的学生编号、课程编号、学生成绩><a class=headerlink href=#2-40、查询不同课程成绩相同的学生的学生编号、课程编号、学生成绩 title=2.40、查询不同课程成绩相同的学生的学生编号、课程编号、学生成绩></a>2.40、查询不同课程成绩相同的学生的学生编号、课程编号、学生成绩</h2><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br></pre><td class=code><pre><span class=line>select </span><br><span class=line>	st.sname,</span><br><span class=line>	s.cid,</span><br><span class=line>	s.score</span><br><span class=line>from s1_score as s</span><br><span class=line>	join s1_score as s2 on s.score = s2.score and s.cid != s2.cid</span><br><span class=line>	join s1_student as st on s2.sid = st.sid</span><br><span class=line></span><br><span class=line># 解法2</span><br><span class=line>select distinct</span><br><span class=line>	s.sid,</span><br><span class=line>	s.cid,</span><br><span class=line>	s.score</span><br><span class=line>from s1_score as s</span><br><span class=line>join (</span><br><span class=line>	select * from s1_score</span><br><span class=line>) as o1 on s.score = o1.score and s.cid != o1.cid</span><br></pre></table></figure><h2 id=2-41、查询每门课程成绩最好的前两名><a class=headerlink href=#2-41、查询每门课程成绩最好的前两名 title=2.41、查询每门课程成绩最好的前两名></a>2.41、查询每门课程成绩最好的前两名</h2><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br></pre><td class=code><pre><span class=line>set @p := 0;</span><br><span class=line>set @q := 0;</span><br><span class=line>set @i := 0;</span><br><span class=line>select </span><br><span class=line>	o1.sid,</span><br><span class=line>	st.sname,</span><br><span class=line>	o1.cid,</span><br><span class=line>	o1.score</span><br><span class=line>from (</span><br><span class=line>	select </span><br><span class=line>		s.sid,</span><br><span class=line>		s.cid,</span><br><span class=line>		s.score,</span><br><span class=line>		@p := s.cid,</span><br><span class=line>		IF(@p = @q, @i := @i + 1, @i := 1) as px,</span><br><span class=line>		@q:=@p</span><br><span class=line>	from s1_score as s</span><br><span class=line>	order by s.cid asc, s.score desc</span><br><span class=line>) as o1</span><br><span class=line>	join s1_student as st on o1.sid = st.sid and o1.px < 3</span><br><span class=line>order by o1.cid, o1.px</span><br><span class=line></span><br><span class=line># 解法2</span><br><span class=line>select</span><br><span class=line>	o2.sid,</span><br><span class=line>	o2.cid,</span><br><span class=line>	o2.score,</span><br><span class=line>	o2.score_level as "名次"</span><br><span class=line>from (</span><br><span class=line>	select</span><br><span class=line>		o1.sid,</span><br><span class=line>		o1.cid,</span><br><span class=line>		o1.score,</span><br><span class=line>		@p:=o1.cid,</span><br><span class=line>		IF(@p=@q, @i:=@i+1, @i:=1) as "score_level",</span><br><span class=line>		@q:=@p</span><br><span class=line>	from (</span><br><span class=line>		select *</span><br><span class=line>		from s1_score</span><br><span class=line>		order by cid asc, score desc</span><br><span class=line>	) as o1</span><br><span class=line>) as o2</span><br><span class=line>where o2.score_level < 3</span><br></pre></table></figure><h2 id=2-42、统计每门课程的学生选修人数（超过-5-人的课程才统计）。><a title="2.42、统计每门课程的学生选修人数（超过 5 人的课程才统计）。" class=headerlink href=#2-42、统计每门课程的学生选修人数（超过-5-人的课程才统计）。></a>2.42、统计每门课程的学生选修人数（超过 5 人的课程才统计）。</h2><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br></pre><td class=code><pre><span class=line>select </span><br><span class=line>	s.cid,</span><br><span class=line>	count(s.sid) as count_st</span><br><span class=line>from s1_score as s</span><br><span class=line>group by s.cid</span><br><span class=line></span><br><span class=line># 解法2</span><br><span class=line>select</span><br><span class=line>	s.cid,</span><br><span class=line>	count(s.sid) as s_count </span><br><span class=line>from s1_score as s</span><br><span class=line>group by s.cid</span><br><span class=line>having s_count > 5</span><br></pre></table></figure><h2 id=2-43、检索至少选修两门课程的学生学号><a class=headerlink href=#2-43、检索至少选修两门课程的学生学号 title=2.43、检索至少选修两门课程的学生学号></a>2.43、检索至少选修两门课程的学生学号</h2><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br></pre><td class=code><pre><span class=line>select </span><br><span class=line>	s.sid</span><br><span class=line>from s1_score as s</span><br><span class=line>group by s.sid</span><br><span class=line>having count(s.cid) >= 2</span><br><span class=line></span><br><span class=line># 解法2</span><br><span class=line>select</span><br><span class=line>	s.sid,</span><br><span class=line>	count(s.cid) as "c_count"</span><br><span class=line>from s1_score as s</span><br><span class=line>group by s.sid</span><br><span class=line>having c_count > 1</span><br></pre></table></figure><h2 id=2-44、查询选修了全部课程的学生信息><a class=headerlink href=#2-44、查询选修了全部课程的学生信息 title=2.44、查询选修了全部课程的学生信息></a>2.44、查询选修了全部课程的学生信息</h2><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br></pre><td class=code><pre><span class=line>select </span><br><span class=line>	st.sid,</span><br><span class=line>	st.sname,</span><br><span class=line>	st.age,</span><br><span class=line>	st.sex</span><br><span class=line>from (</span><br><span class=line>	select s.sid</span><br><span class=line>	from s1_score as s</span><br><span class=line>	group by s.sid</span><br><span class=line>	having count(s.cid) = (</span><br><span class=line>		select count(cid) from s1_course </span><br><span class=line>	)</span><br><span class=line>)as o1</span><br><span class=line>	join s1_student as st on o1.sid = st.sid</span><br><span class=line></span><br><span class=line># 解法2</span><br><span class=line>select</span><br><span class=line>	st.*</span><br><span class=line>from s1_student as st</span><br><span class=line>join (</span><br><span class=line>	select s.sid</span><br><span class=line>	from s1_score as s</span><br><span class=line>	group by s.sid</span><br><span class=line>	having count(s.cid) = (</span><br><span class=line>		select count(cid) from s1_course</span><br><span class=line>	)</span><br><span class=line>) as o1 on st.sid = o1.sid</span><br></pre></table></figure><h2 id=2-45、查询各学生的年龄，只按年份来算><a class=headerlink href=#2-45、查询各学生的年龄，只按年份来算 title=2.45、查询各学生的年龄，只按年份来算></a>2.45、查询各学生的年龄，只按年份来算</h2><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br></pre><td class=code><pre><span class=line>select</span><br><span class=line>	st.sname,</span><br><span class=line>	DATE_FORMAT(st.birth, '%Y') as '出生年',</span><br><span class=line>	YEAR(NOW()) as '当前年',</span><br><span class=line>	YEAR(NOW()) - DATE_FORMAT(st.birth, '%Y') as age</span><br><span class=line>from s1_student as st</span><br><span class=line></span><br><span class=line># 解法2</span><br><span class=line>select</span><br><span class=line>	st.sid,</span><br><span class=line>	st.sname,</span><br><span class=line>	st.age,</span><br><span class=line>	st.birth,</span><br><span class=line>	ABS(2023 - EXTRACT(year from st.birth)) as "年龄"</span><br><span class=line>from s1_student as st</span><br></pre></table></figure><h2 id=2-46、按照出生日期来算，当前月日-出生年月的月日，则年龄减一><a title="2.46、按照出生日期来算，当前月日 < 出生年月的月日，则年龄减一" class=headerlink href=#2-46、按照出生日期来算，当前月日-出生年月的月日，则年龄减一></a>2.46、按照出生日期来算，当前月日 < 出生年月的月日，则年龄减一</h2><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br></pre><td class=code><pre><span class=line>select</span><br><span class=line>	o1.sid,</span><br><span class=line>	o1.sname,</span><br><span class=line>	o1.age,</span><br><span class=line>	CASE WHEN o1.currday < o1.mounth </span><br><span class=line>	THEN o1.age - 1 </span><br><span class=line>	ELSE o1.age </span><br><span class=line>	END as newage</span><br><span class=line>from (</span><br><span class=line>	select </span><br><span class=line>		st.sid,</span><br><span class=line>		st.sname,</span><br><span class=line>		YEAR(NOW()) - DATE_FORMAT(st.birth, '%Y') as age,</span><br><span class=line>		DATE_FORMAT(st.birth, '%m-%d') as mounth,</span><br><span class=line>		DATE_FORMAT(NOW(), '%m-%d') as currday</span><br><span class=line>	from s1_student as st</span><br><span class=line>)as o1</span><br><span class=line></span><br><span class=line></span><br><span class=line># 解法2</span><br><span class=line>select</span><br><span class=line>	o1.sid,</span><br><span class=line>	o1.sname,</span><br><span class=line>	o1.birth,</span><br><span class=line>	IF(EXTRACT(month from NOW()) < o1.m and EXTRACT(day from NOW()) < o1.d, </span><br><span class=line>	ABS(EXTRACT(year from NOW()) - o1.y) - 1,</span><br><span class=line>	ABS(EXTRACT(year from NOW()) - o1.y) + 1) as "年龄"</span><br><span class=line>from (</span><br><span class=line>	select</span><br><span class=line>		st.sid,</span><br><span class=line>		st.sname,</span><br><span class=line>		st.birth,</span><br><span class=line>		EXTRACT(year from st.birth) as "y",</span><br><span class=line>		EXTRACT(month from st.birth) as "m",</span><br><span class=line>		EXTRACT(day from st.birth) as "d"</span><br><span class=line>	from s1_student as st</span><br><span class=line>) as o1</span><br></pre></table></figure><h2 id=2-47、查询本周过生日的学生><a class=headerlink href=#2-47、查询本周过生日的学生 title=2.47、查询本周过生日的学生></a>2.47、查询本周过生日的学生</h2><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br></pre><td class=code><pre><span class=line>select </span><br><span class=line>	st.sid,</span><br><span class=line>	st.sname,</span><br><span class=line>	WEEK(st.birth) as '出生周',</span><br><span class=line>	WEEK(NOW()) as '当前周'</span><br><span class=line>from s1_student as st</span><br><span class=line>where WEEK(st.birth) = WEEK(NOW())</span><br><span class=line></span><br><span class=line># 解法2</span><br><span class=line>select</span><br><span class=line>	st.*</span><br><span class=line>from s1_student as st</span><br><span class=line>where EXTRACT(week from st.birth) = EXTRACT(week from NOW())</span><br></pre></table></figure><h2 id=2-48、查询下周过生日的学生><a class=headerlink href=#2-48、查询下周过生日的学生 title=2.48、查询下周过生日的学生></a>2.48、查询下周过生日的学生</h2><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br></pre><td class=code><pre><span class=line>select </span><br><span class=line>	st.sid,</span><br><span class=line>	st.sname,</span><br><span class=line>	st.birth,</span><br><span class=line>	WEEK(st.birth) as '出生周',</span><br><span class=line>	WEEK(DATE_ADD(NOW(),INTERVAL 1 WEEK)) as '下周'</span><br><span class=line>from s1_student as st</span><br><span class=line>where WEEK(st.birth) = WEEK(DATE_ADD(NOW(),INTERVAL 1 WEEK))</span><br><span class=line></span><br><span class=line># 解法2</span><br><span class=line>select</span><br><span class=line>	st.*</span><br><span class=line>from s1_student as st</span><br><span class=line>where EXTRACT(week from DATE_ADD(st.birth, INTERVAL 1 week)) = EXTRACT(week from NOW())</span><br></pre></table></figure><h2 id=2-49、查询本月过生日的学生><a class=headerlink href=#2-49、查询本月过生日的学生 title=2.49、查询本月过生日的学生></a>2.49、查询本月过生日的学生</h2><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br></pre><td class=code><pre><span class=line>select </span><br><span class=line>	st.sname,</span><br><span class=line>	st.birth,</span><br><span class=line>	MONTH(st.birth) as "出生月",</span><br><span class=line>	MONTH(NOW()) as "当前月"</span><br><span class=line>from s1_student as st</span><br><span class=line>where MONTH(st.birth) = MONTH(NOW())</span><br><span class=line></span><br><span class=line># 解法2</span><br><span class=line>select st.*</span><br><span class=line>from s1_student as st</span><br><span class=line>where EXTRACT(month from st.birth) = EXTRACT(month from NOW())</span><br></pre></table></figure><h2 id=2-50、查询下月过生日的学生><a class=headerlink href=#2-50、查询下月过生日的学生 title=2.50、查询下月过生日的学生></a>2.50、查询下月过生日的学生</h2><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br></pre><td class=code><pre><span class=line>select </span><br><span class=line>	sid,</span><br><span class=line>	sname,</span><br><span class=line>	birth,</span><br><span class=line>	MONTH(birth) as '出生月',</span><br><span class=line>	MONTH(DATE_ADD(NOW(), INTERVAL 1 MONTH)) as '下月'</span><br><span class=line>from s1_student</span><br><span class=line>where MONTH(birth) = MONTH(DATE_ADD(NOW(), INTERVAL 1 MONTH))</span><br><span class=line></span><br><span class=line># 解法2</span><br><span class=line>select st.*</span><br><span class=line>from s1_student as st</span><br><span class=line>where EXTRACT(month from st.birth) = EXTRACT(month from DATE_ADD(NOW(), INTERVAL 1 month))</span><br></pre></table></figure><h1 id=3、函数扩展><a class=headerlink href=#3、函数扩展 title=3、函数扩展></a>3、函数扩展</h1><h2 id=3-1、字符串函数><a class=headerlink href=#3-1、字符串函数 title=3.1、字符串函数></a>3.1、字符串函数</h2><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre><td class=code><pre><span class=line># SQL Runoob Gooogle Facebook</span><br><span class=line>SELECT CONCAT("SQL ", "Runoob ", "Gooogle ", "Facebook") AS ConcatenatedString;</span><br><span class=line></span><br><span class=line># SQL-Tutorial-is-fun!</span><br><span class=line>SELECT CONCAT_WS("-", "SQL", "Tutorial", "is", "fun!")AS ConcatenatedString;</span><br><span class=line></span><br><span class=line># 小写转大写</span><br><span class=line>SELECT UCASE("runoob"); -- RUNOOB</span><br><span class=line>SELECT UPPER("runoob"); -- RUNOOB</span><br></pre></table></figure><h2 id=3-2、数字函数><a class=headerlink href=#3-2、数字函数 title=3.2、数字函数></a>3.2、数字函数</h2><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre><td class=code><pre><span class=line># 绝对值</span><br><span class=line>SELECT ABS(-1) -- 返回1</span><br><span class=line></span><br><span class=line># 大于或等于当前值的最小整数</span><br><span class=line>SELECT CEIL(1.5) -- 返回2</span><br><span class=line>SELECT CEILING(1.5); -- 返回2</span><br><span class=line></span><br><span class=line># 小于或等于当前值的最大整数</span><br><span class=line>SELECT FLOOR(1.5) -- 返回1</span><br></pre></table></figure><h2 id=3-3、日期函数><a class=headerlink href=#3-3、日期函数 title=3.3、日期函数></a>3.3、日期函数</h2><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br></pre><td class=code><pre><span class=line># 返回当前日期</span><br><span class=line>SELECT CURDATE();-- 2018-09-19</span><br><span class=line>SELECT CURRENT_DATE();-- 2018-09-19</span><br><span class=line># 返回当前时间</span><br><span class=line>SELECT CURTIME();-- 19:59:02</span><br><span class=line>SELECT CURRENT_TIME();-- 19:59:02</span><br><span class=line># 返回当前日期和时间</span><br><span class=line>SELECT CURRENT_TIMESTAMP();-- 2018-09-19 20:57:43</span><br><span class=line>select LOCALTIME(); -- 2013-08-31 21:09:52</span><br><span class=line>select LOCALTIMESTAMP(); -- 2013-08-31 21:10:31</span><br><span class=line>select SYSDATE(); -- 2013-03-31 21:10:31</span><br><span class=line></span><br><span class=line># 返回指定日期中的指定字段值,函数名可取值：</span><br><span class=line># DAYNAME(d) / DAYOFWEEK(d) 返回日期 d 是星期几</span><br><span class=line># DAYOFMONTH(d) 日期d是本月第几天</span><br><span class=line># DAYOFYEAR(d) 日期d是本年第几天</span><br><span class=line># 除了上面几个还有很多，详情查看官网。</span><br><span class=line>SELECT DATE("2017-06-15"); -- 2017-06-15</span><br><span class=line>SELECT DAY ( "2017-06-15" );-- 15</span><br><span class=line># EXTRACT(type FROM d)从日期d中获取type指定的值</span><br><span class=line>SELECT EXTRACT(MINUTE FROM '2011-11-11 11:11:11'); -- 11</span><br><span class=line># 返回给定日期当月的最后一天</span><br><span class=line>SELECT LAST_DAY("2017-06-20"); -- 2017-06-30</span><br><span class=line></span><br><span class=line># 加上一个指定的日期或时间，最后一位参数值可改变，取值范围较多，详情查看官网。</span><br><span class=line>SELECT ADDDATE( "2017-06-15", INTERVAL 10 DAY );-- 2017-06-25</span><br><span class=line>SELECT DATE_ADD( "2017-06-15", INTERVAL 10 DAY );-- 2017-06-25</span><br><span class=line>SELECT DATE_ADD( "2017-06-15 09:34:21", INTERVAL 15 MINUTE );-- 2017-06-15 09:49:21</span><br><span class=line>SELECT DATE_ADD( "2017-06-15 09:34:21", INTERVAL - 3 HOUR );-- 2017-06-15 06:34:21</span><br><span class=line>SELECT DATE_ADD( "2017-06-15 09:34:21", INTERVAL - 3 MONTH );-- 2017-04-15</span><br><span class=line># 指定日期时间加上指定时间</span><br><span class=line>SELECT ADDTIME( "2020-06-15 09:34:21", "2:10:5" );-- 2020-06-15 11:44:26</span><br><span class=line></span><br><span class=line># 减去指定日期或时间</span><br><span class=line>SELECT DATE_SUB("2017-06-15", INTERVAL 2 DAY); -- "2017-06-13"</span><br><span class=line># 减去指定天数（天）</span><br><span class=line>select SUBDATE("2017-06-15", 1);</span><br><span class=line></span><br><span class=line># 两个日期之间天数差</span><br><span class=line>SELECT DATEDIFF( '2001-01-01', '2001-02-02' );-- -32</span><br><span class=line># 将日期按指定格式输出</span><br><span class=line>SELECT DATE_FORMAT('2011-11-11 11:11:11','%Y-%m-%d %r');</span><br></pre></table></figure></div><footer class=post-footer><div class=post-eof></div></footer></article></div><div class=post-block><article class=post-content itemscope itemtype=http://schema.org/Article><link href=https://hgprivate.github.io/2024/08/21/MySQL%E7%BB%8F%E5%85%B8SQL%E7%BB%83%E4%B9%A0%E9%A2%98%E7%AC%AC%E4%BA%8C%E7%AF%87/ itemprop=mainEntityOfPage><span hidden itemprop=author itemscope itemtype=http://schema.org/Person> <meta content=/static/imgs/avatar.png itemprop=image> <meta content=豪哥 itemprop=name> </span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization> <meta content=豪哥博客 itemprop=name> <meta content=豪哥博客 itemprop=description> </span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork> <meta content="undefined | 豪哥博客" itemprop=name> <meta itemprop=description> </span><header class=post-header><h2 itemprop="name headline" class=post-title><a class=post-title-link href=/2024/08/21/MySQL%E7%BB%8F%E5%85%B8SQL%E7%BB%83%E4%B9%A0%E9%A2%98%E7%AC%AC%E4%BA%8C%E7%AF%87/ itemprop=url>MySQL系列-MySQL经典SQL练习题第二篇</a></h2><div class=post-meta-container><div class=post-meta><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar"></i> </span> <span class=post-meta-item-text>发表于</span> <time itemprop="dateCreated datePublished" title="创建时间：2024-08-21 21:39:14" datetime=2024-08-21T21:39:14+08:00>2024-08-21</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar-check"></i> </span> <span class=post-meta-item-text>更新于</span> <time title="修改时间：2023-08-02 01:08:15" datetime=2023-08-02T01:08:15+08:00 itemprop=dateModified>2023-08-02</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-folder"></i> </span> <span class=post-meta-item-text>分类于</span> <span itemprop=about itemscope itemtype=http://schema.org/Thing> <a href=/categories/MySQL/ itemprop=url rel=index><span itemprop=name>MySQL</span></a> </span> </span></div></div></header><div class=post-body itemprop=articleBody><h1 id=1、环境准备><a class=headerlink href=#1、环境准备 title=1、环境准备></a>1、环境准备</h1><h2 id=1-1、建表><a class=headerlink href=#1-1、建表 title=1.1、建表></a>1.1、建表</h2><figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br></pre><td class=code><pre><span class=line><span class=keyword>CREATE</span> <span class=keyword>TABLE</span> s2_student(</span><br><span class=line>  sno <span class=type>VARCHAR</span>(<span class=number>3</span>) <span class=keyword>NOT</span> <span class=keyword>NULL</span>,</span><br><span class=line>  sname <span class=type>VARCHAR</span>(<span class=number>4</span>) <span class=keyword>NOT</span> <span class=keyword>NULL</span>,</span><br><span class=line>  sex <span class=type>VARCHAR</span>(<span class=number>2</span>) <span class=keyword>NOT</span> <span class=keyword>NULL</span>,</span><br><span class=line>  birthday DATETIME,</span><br><span class=line>  class <span class=type>VARCHAR</span>(<span class=number>5</span>)</span><br><span class=line>);</span><br><span class=line></span><br><span class=line><span class=keyword>CREATE</span> <span class=keyword>TABLE</span> s2_teacher(</span><br><span class=line>  tno <span class=type>VARCHAR</span>(<span class=number>3</span>) <span class=keyword>NOT</span> <span class=keyword>NULL</span>,</span><br><span class=line>  tname <span class=type>VARCHAR</span>(<span class=number>4</span>) <span class=keyword>NOT</span> <span class=keyword>NULL</span>,</span><br><span class=line>  sex <span class=type>VARCHAR</span>(<span class=number>2</span>)  <span class=keyword>NOT</span> <span class=keyword>NULL</span>,</span><br><span class=line>  birthday DATETIME <span class=keyword>NOT</span> <span class=keyword>NULL</span>,</span><br><span class=line>  prof <span class=type>VARCHAR</span>(<span class=number>6</span>),</span><br><span class=line>  depart <span class=type>VARCHAR</span>(<span class=number>10</span>) <span class=keyword>NOT</span> <span class=keyword>NULL</span></span><br><span class=line>);</span><br><span class=line></span><br><span class=line><span class=keyword>CREATE</span> <span class=keyword>TABLE</span> s2_course(</span><br><span class=line>  cno <span class=type>VARCHAR</span>(<span class=number>5</span>) <span class=keyword>NOT</span> <span class=keyword>NULL</span>,</span><br><span class=line>  cname <span class=type>VARCHAR</span>(<span class=number>10</span>) <span class=keyword>NOT</span> <span class=keyword>NULL</span>,</span><br><span class=line>  tno <span class=type>VARCHAR</span>(<span class=number>10</span>) <span class=keyword>NOT</span> <span class=keyword>NULL</span></span><br><span class=line>);</span><br><span class=line></span><br><span class=line><span class=keyword>CREATE</span> <span class=keyword>TABLE</span> s2_score(</span><br><span class=line>  sno <span class=type>VARCHAR</span>(<span class=number>3</span>) <span class=keyword>NOT</span> <span class=keyword>NULL</span>,</span><br><span class=line>  cno <span class=type>VARCHAR</span>(<span class=number>5</span>) <span class=keyword>NOT</span> <span class=keyword>NULL</span>,</span><br><span class=line>  degree <span class=type>NUMERIC</span>(<span class=number>10</span>, <span class=number>1</span>) <span class=keyword>NOT</span> <span class=keyword>NULL</span></span><br><span class=line>);</span><br></pre></table></figure><h2 id=1-2、插入数据><a class=headerlink href=#1-2、插入数据 title=1.2、插入数据></a>1.2、插入数据</h2><figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br></pre><td class=code><pre><span class=line><span class=keyword>INSERT</span> <span class=keyword>INTO</span> s2_student <span class=keyword>VALUES</span></span><br><span class=line>(<span class=number>108</span>, <span class=string>'曾华'</span>, <span class=string>'男'</span>, <span class=string>'1977-09-01'</span>, <span class=number>95033</span>),</span><br><span class=line>(<span class=number>105</span>, <span class=string>'匡明'</span>, <span class=string>'男'</span>, <span class=string>'1975-10-02'</span>, <span class=number>95031</span>),</span><br><span class=line>(<span class=number>107</span>, <span class=string>'王丽'</span>, <span class=string>'女'</span>, <span class=string>'1976-01-23'</span>, <span class=number>95033</span>),</span><br><span class=line>(<span class=number>101</span>, <span class=string>'李军'</span>, <span class=string>'男'</span>, <span class=string>'1976-02-20'</span>, <span class=number>95033</span>),</span><br><span class=line>(<span class=number>109</span>, <span class=string>'王芳'</span>, <span class=string>'女'</span>, <span class=string>'1975-02-10'</span>, <span class=number>95031</span>),</span><br><span class=line>(<span class=number>103</span>, <span class=string>'陆君'</span>, <span class=string>'男'</span>, <span class=string>'1974-06-03'</span>, <span class=number>95031</span>);</span><br><span class=line></span><br><span class=line><span class=keyword>INSERT</span> <span class=keyword>INTO</span> s2_teacher <span class=keyword>VALUES</span></span><br><span class=line>(<span class=number>804</span>, <span class=string>'李诚'</span>, <span class=string>'男'</span>, <span class=string>'1958-12-02'</span>, <span class=string>'副教授'</span>, <span class=string>'计算机系'</span>),</span><br><span class=line>(<span class=number>856</span>, <span class=string>'张旭'</span>, <span class=string>'男'</span>, <span class=string>'1969-03-12'</span>, <span class=string>'讲师'</span>, <span class=string>'电子工程系'</span>),</span><br><span class=line>(<span class=number>825</span>, <span class=string>'王萍'</span>, <span class=string>'女'</span>, <span class=string>'1972-05-05'</span>, <span class=string>'助教'</span>, <span class=string>'计算机系'</span>),</span><br><span class=line>(<span class=number>831</span>, <span class=string>'刘冰'</span>, <span class=string>'女'</span>, <span class=string>'1977-08-14'</span>, <span class=string>'助教'</span>, <span class=string>'电子工程系'</span>);</span><br><span class=line></span><br><span class=line><span class=keyword>INSERT</span> <span class=keyword>INTO</span> s2_course <span class=keyword>VALUES</span></span><br><span class=line>(<span class=string>'3-105'</span>, <span class=string>'计算机导论'</span>, <span class=number>825</span>),</span><br><span class=line>(<span class=string>'3-245'</span>, <span class=string>'操作系统'</span>, <span class=number>804</span>),</span><br><span class=line>(<span class=string>'6-166'</span>, <span class=string>'数据电路'</span>, <span class=number>856</span>),</span><br><span class=line>(<span class=string>'9-888'</span>, <span class=string>'高等数学'</span>, <span class=number>100</span>);</span><br><span class=line></span><br><span class=line><span class=keyword>INSERT</span> <span class=keyword>INTO</span> s2_score <span class=keyword>VALUES</span></span><br><span class=line>(<span class=number>103</span>, <span class=string>'3-245'</span>, <span class=number>86</span>),</span><br><span class=line>(<span class=number>105</span>, <span class=string>'3-245'</span>, <span class=number>75</span>),</span><br><span class=line>(<span class=number>109</span>, <span class=string>'3-245'</span>, <span class=number>68</span>),</span><br><span class=line>(<span class=number>103</span>, <span class=string>'3-105'</span>, <span class=number>92</span>),</span><br><span class=line>(<span class=number>105</span>, <span class=string>'3-105'</span>, <span class=number>88</span>),</span><br><span class=line>(<span class=number>109</span>, <span class=string>'3-105'</span>, <span class=number>76</span>),</span><br><span class=line>(<span class=number>101</span>, <span class=string>'3-105'</span>, <span class=number>64</span>),</span><br><span class=line>(<span class=number>107</span>, <span class=string>'3-105'</span>, <span class=number>91</span>),</span><br><span class=line>(<span class=number>101</span>, <span class=string>'6-166'</span>, <span class=number>85</span>),</span><br><span class=line>(<span class=number>107</span>, <span class=string>'6-106'</span>, <span class=number>79</span>),</span><br><span class=line>(<span class=number>108</span>, <span class=string>'3-105'</span>, <span class=number>78</span>),</span><br><span class=line>(<span class=number>108</span>, <span class=string>'6-166'</span>, <span class=number>81</span>);</span><br></pre></table></figure><h1 id=2、练习><a class=headerlink href=#2、练习 title=2、练习></a>2、练习</h1><h2 id=2-1、查询Score表中成绩在60到80之间的所有记录><a class=headerlink href=#2-1、查询Score表中成绩在60到80之间的所有记录 title=2.1、查询Score表中成绩在60到80之间的所有记录></a>2.1、查询Score表中成绩在60到80之间的所有记录</h2><figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line><span class=keyword>select</span> s.<span class=operator>*</span></span><br><span class=line><span class=keyword>from</span> s2_score <span class=keyword>as</span> s</span><br><span class=line><span class=keyword>where</span> s.degree <span class=keyword>BETWEEN</span> <span class=number>60</span> <span class=keyword>and</span> <span class=number>80</span>;</span><br></pre></table></figure><h2 id=2-2、查询-score-表中成绩为85，86或88的记录><a title="2.2、查询 score 表中成绩为85，86或88的记录" class=headerlink href=#2-2、查询-score-表中成绩为85，86或88的记录></a>2.2、查询 score 表中成绩为85，86或88的记录</h2><figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line><span class=keyword>select</span> s.<span class=operator>*</span></span><br><span class=line><span class=keyword>from</span> s2_score <span class=keyword>as</span> s</span><br><span class=line><span class=keyword>where</span> s.degree <span class=operator>=</span> <span class=number>85</span> <span class=keyword>or</span> s.degree <span class=operator>=</span> <span class=number>86</span> <span class=keyword>or</span> s.degree <span class=operator>=</span> <span class=number>88</span>;</span><br></pre></table></figure><h2 id=2-3、以-cno-升序、degree降序查询-score-表的所有记录><a title="2.3、以 cno 升序、degree降序查询 score 表的所有记录" class=headerlink href=#2-3、以-cno-升序、degree降序查询-score-表的所有记录></a>2.3、以 cno 升序、degree降序查询 score 表的所有记录</h2><figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line><span class=keyword>select</span> s.<span class=operator>*</span></span><br><span class=line><span class=keyword>from</span> s2_score <span class=keyword>as</span> s</span><br><span class=line><span class=keyword>order</span> <span class=keyword>by</span> s.cno <span class=keyword>asc</span>, s.degree <span class=keyword>desc</span>;</span><br></pre></table></figure><h2 id=2-4、查询“95031”班的学生人数。><a class=headerlink href=#2-4、查询“95031”班的学生人数。 title=2.4、查询“95031”班的学生人数。></a>2.4、查询“95031”班的学生人数。</h2><figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line><span class=keyword>select</span> <span class=built_in>COUNT</span>(<span class=operator>*</span>) <span class=keyword>as</span> "人数"</span><br><span class=line><span class=keyword>from</span> s2_student <span class=keyword>as</span> st</span><br><span class=line><span class=keyword>where</span> st.class <span class=operator>=</span> "95031";</span><br></pre></table></figure><h2 id=2-5、查询Score表中的最高分的学生学号和课程号><a class=headerlink href=#2-5、查询Score表中的最高分的学生学号和课程号 title=2.5、查询Score表中的最高分的学生学号和课程号></a>2.5、查询Score表中的最高分的学生学号和课程号</h2><figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre><td class=code><pre><span class=line><span class=keyword>select</span></span><br><span class=line>	s.sno,</span><br><span class=line>	s.cno,</span><br><span class=line>	s.degree</span><br><span class=line><span class=keyword>from</span> s2_score <span class=keyword>as</span> s</span><br><span class=line><span class=keyword>order</span> <span class=keyword>by</span> s.degree <span class=keyword>desc</span></span><br><span class=line>limit <span class=number>0</span>, <span class=number>1</span>;</span><br></pre></table></figure><h2 id=2-6、查询‘3-105’号课程的平均分><a class=headerlink href=#2-6、查询‘3-105’号课程的平均分 title=2.6、查询‘3-105’号课程的平均分></a>2.6、查询‘3-105’号课程的平均分</h2><figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre><td class=code><pre><span class=line><span class=keyword>select</span></span><br><span class=line>	s.cno,</span><br><span class=line>	<span class=built_in>avg</span>(s.degree) <span class=keyword>as</span> "平均分"</span><br><span class=line><span class=keyword>from</span> s2_score <span class=keyword>as</span> s</span><br><span class=line><span class=keyword>where</span> s.cno <span class=operator>=</span> "3-105"</span><br><span class=line><span class=keyword>group</span> <span class=keyword>by</span> s.cno</span><br></pre></table></figure><h2 id=2-7、查询Score表中至少有5名学生选修的并以3开头的课程的平均分数><a class=headerlink href=#2-7、查询Score表中至少有5名学生选修的并以3开头的课程的平均分数 title=2.7、查询Score表中至少有5名学生选修的并以3开头的课程的平均分数></a>2.7、查询Score表中至少有5名学生选修的并以3开头的课程的平均分数</h2><figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre><td class=code><pre><span class=line><span class=keyword>select</span></span><br><span class=line>	s.cno,</span><br><span class=line>	<span class=built_in>avg</span>(s.degree) <span class=keyword>as</span> "平均分"</span><br><span class=line><span class=keyword>from</span> s2_score <span class=keyword>as</span> s</span><br><span class=line><span class=keyword>where</span> s.cno <span class=keyword>like</span> "3%"</span><br><span class=line><span class=keyword>group</span> <span class=keyword>by</span> s.cno</span><br><span class=line><span class=keyword>having</span> <span class=built_in>count</span>(s.sno) <span class=operator>>=</span> <span class=number>5</span></span><br></pre></table></figure><h2 id=2-8、查询最低分大于70，最高分小于90的Sno列><a class=headerlink href=#2-8、查询最低分大于70，最高分小于90的Sno列 title=2.8、查询最低分大于70，最高分小于90的Sno列></a>2.8、查询最低分大于70，最高分小于90的Sno列</h2><figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line><span class=keyword>select</span></span><br><span class=line>	s.sno</span><br><span class=line><span class=keyword>from</span> s2_score <span class=keyword>as</span> s</span><br><span class=line><span class=keyword>where</span> s.degree <span class=operator>></span> <span class=number>70</span> <span class=keyword>and</span> s.degree <span class=operator><</span> <span class=number>90</span></span><br></pre></table></figure><h2 id=2-9、查询所有学生的Sname、Cno和Degree列><a class=headerlink href=#2-9、查询所有学生的Sname、Cno和Degree列 title=2.9、查询所有学生的Sname、Cno和Degree列></a>2.9、查询所有学生的Sname、Cno和Degree列</h2><figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre><td class=code><pre><span class=line><span class=keyword>select</span></span><br><span class=line>	st.sname,</span><br><span class=line>	o1.cno,</span><br><span class=line>	o1.degree</span><br><span class=line><span class=keyword>from</span> s2_student <span class=keyword>as</span> st</span><br><span class=line><span class=keyword>join</span> (</span><br><span class=line>	<span class=keyword>select</span> s.<span class=operator>*</span></span><br><span class=line>	<span class=keyword>from</span> s2_score <span class=keyword>as</span> s</span><br><span class=line>) <span class=keyword>as</span> o1 <span class=keyword>on</span> st.sno <span class=operator>=</span> o1.sno</span><br></pre></table></figure><h2 id=2-10、查询所有学生的Sno、Cname和Degree列><a class=headerlink href=#2-10、查询所有学生的Sno、Cname和Degree列 title=2.10、查询所有学生的Sno、Cname和Degree列></a>2.10、查询所有学生的Sno、Cname和Degree列</h2><figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre><td class=code><pre><span class=line><span class=keyword>select</span></span><br><span class=line>	o1.sno,</span><br><span class=line>	c.cname,</span><br><span class=line>	o1.degree</span><br><span class=line><span class=keyword>from</span> s2_course <span class=keyword>as</span> c</span><br><span class=line><span class=keyword>join</span> (</span><br><span class=line>	<span class=keyword>select</span> s.<span class=operator>*</span></span><br><span class=line>	<span class=keyword>from</span> s2_score <span class=keyword>as</span> s</span><br><span class=line>) <span class=keyword>as</span> o1 <span class=keyword>on</span> c.cno <span class=operator>=</span> o1.cno</span><br></pre></table></figure><h2 id=2-11、查询所有学生的Sname、Cname和Degree列><a class=headerlink href=#2-11、查询所有学生的Sname、Cname和Degree列 title=2.11、查询所有学生的Sname、Cname和Degree列></a>2.11、查询所有学生的Sname、Cname和Degree列</h2><figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br></pre><td class=code><pre><span class=line><span class=keyword>select</span></span><br><span class=line>	st.sname,</span><br><span class=line>	c.cname,</span><br><span class=line>	o1.degree</span><br><span class=line><span class=keyword>from</span> s2_course <span class=keyword>as</span> c</span><br><span class=line><span class=keyword>join</span> (</span><br><span class=line>	<span class=keyword>select</span> s.<span class=operator>*</span></span><br><span class=line>	<span class=keyword>from</span> s2_score <span class=keyword>as</span> s</span><br><span class=line>) <span class=keyword>as</span> o1 <span class=keyword>on</span> c.cno <span class=operator>=</span> o1.cno</span><br><span class=line><span class=keyword>join</span> s2_student <span class=keyword>as</span> st <span class=keyword>on</span> o1.sno <span class=operator>=</span> st.sno</span><br></pre></table></figure><h2 id=2-12、查询“95033”班所选课程的平均分><a class=headerlink href=#2-12、查询“95033”班所选课程的平均分 title=2.12、查询“95033”班所选课程的平均分></a>2.12、查询“95033”班所选课程的平均分</h2><figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br></pre><td class=code><pre><span class=line><span class=keyword>select</span></span><br><span class=line>	o2.cno,</span><br><span class=line>	<span class=built_in>avg</span>(o2.degree) <span class=keyword>as</span> "平均分"</span><br><span class=line><span class=keyword>from</span> (</span><br><span class=line>	<span class=keyword>select</span> s.<span class=operator>*</span></span><br><span class=line>	<span class=keyword>from</span> s2_score <span class=keyword>as</span> s</span><br><span class=line>	<span class=keyword>join</span> (</span><br><span class=line>		<span class=keyword>select</span> st.sno</span><br><span class=line>		<span class=keyword>from</span> s2_student <span class=keyword>as</span> st</span><br><span class=line>		<span class=keyword>where</span> st.class <span class=operator>=</span> "95033"</span><br><span class=line>	) <span class=keyword>as</span> o1 <span class=keyword>on</span> s.sno <span class=operator>=</span> o1.sno</span><br><span class=line>) <span class=keyword>as</span> o2</span><br><span class=line><span class=keyword>group</span> <span class=keyword>by</span> o2.cno</span><br></pre></table></figure><h2 id=2-13、查询所有同学的Sno、Cno和评级。（60分以下级别为E，60-70为D，70-80为C，80-90为B，90-100为A）><a class=headerlink href=#2-13、查询所有同学的Sno、Cno和评级。（60分以下级别为E，60-70为D，70-80为C，80-90为B，90-100为A） title=2.13、查询所有同学的Sno、Cno和评级。（60分以下级别为E，60-70为D，70-80为C，80-90为B，90-100为A）></a>2.13、查询所有同学的Sno、Cno和评级。（60分以下级别为E，60-70为D，70-80为C，80-90为B，90-100为A）</h2><figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br></pre><td class=code><pre><span class=line><span class=keyword>select</span></span><br><span class=line>	s.sno,</span><br><span class=line>	s.cno,</span><br><span class=line>	s.degree,</span><br><span class=line>	IF(s.degree <span class=operator><=</span> <span class=number>100</span> <span class=keyword>and</span> s.degree <span class=operator>></span> <span class=number>90</span>, "A",</span><br><span class=line>	IF(s.degree <span class=operator><=</span> <span class=number>90</span> <span class=keyword>and</span> s.degree <span class=operator>></span> <span class=number>80</span>, "B", </span><br><span class=line>	IF(s.degree <span class=operator><=</span> <span class=number>80</span> <span class=keyword>and</span> s.degree <span class=operator>></span> <span class=number>70</span>, "C",</span><br><span class=line>	IF(s.degree <span class=operator><=</span> <span class=number>70</span> <span class=keyword>and</span> s.degree <span class=operator>></span> <span class=number>60</span>, "D",</span><br><span class=line>	IF(s.degree <span class=operator><=</span> <span class=number>60</span>, "E", ""))))) <span class=keyword>as</span> "评级"</span><br><span class=line><span class=keyword>from</span> s2_score <span class=keyword>as</span> s</span><br><span class=line><span class=keyword>order</span> <span class=keyword>by</span> s.degree <span class=keyword>desc</span></span><br></pre></table></figure><h2 id=2-14、查询选修“3-105”课程的成绩高于“109”号同学成绩的所有同学的记录><a class=headerlink href=#2-14、查询选修“3-105”课程的成绩高于“109”号同学成绩的所有同学的记录 title=2.14、查询选修“3-105”课程的成绩高于“109”号同学成绩的所有同学的记录></a>2.14、查询选修“3-105”课程的成绩高于“109”号同学成绩的所有同学的记录</h2><figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line><span class=keyword>select</span> s.<span class=operator>*</span></span><br><span class=line><span class=keyword>from</span> s2_score <span class=keyword>as</span> s</span><br><span class=line><span class=keyword>where</span> s.cno <span class=operator>=</span> "3-105" <span class=keyword>and</span> s.degree <span class=operator>></span> (</span><br><span class=line>	<span class=keyword>select</span> degree <span class=keyword>from</span> s2_score <span class=keyword>where</span> cno <span class=operator>=</span> "3-105" <span class=keyword>and</span> sno <span class=operator>=</span> "109"</span><br><span class=line>)</span><br></pre></table></figure><h2 id=2-15、查询score中选学一门以上课程的同学中分数为非最高分成绩的记录><a class=headerlink href=#2-15、查询score中选学一门以上课程的同学中分数为非最高分成绩的记录 title=2.15、查询score中选学一门以上课程的同学中分数为非最高分成绩的记录></a>2.15、查询score中选学一门以上课程的同学中分数为非最高分成绩的记录</h2><figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br></pre><td class=code><pre><span class=line><span class=keyword>select</span></span><br><span class=line>	o2.sno,</span><br><span class=line>	o2.cno,</span><br><span class=line>	o2.degree</span><br><span class=line><span class=keyword>from</span> (</span><br><span class=line>	<span class=keyword>select</span></span><br><span class=line>		s.<span class=operator>*</span>,</span><br><span class=line>		<span class=built_in>ROW_NUMBER</span>() <span class=keyword>over</span> (<span class=keyword>order</span> <span class=keyword>by</span> s.degree <span class=keyword>desc</span>) <span class=keyword>as</span> "d_level"</span><br><span class=line>	<span class=keyword>from</span> s2_score <span class=keyword>as</span> s</span><br><span class=line>	<span class=keyword>join</span> (</span><br><span class=line>		<span class=keyword>select</span></span><br><span class=line>			s.sno</span><br><span class=line>		<span class=keyword>from</span> s2_score <span class=keyword>as</span> s</span><br><span class=line>		<span class=keyword>group</span> <span class=keyword>by</span> s.sno</span><br><span class=line>		<span class=keyword>having</span> <span class=built_in>count</span>(s.cno) <span class=operator>></span> <span class=number>1</span></span><br><span class=line>	) <span class=keyword>as</span> o1 <span class=keyword>on</span> s.sno <span class=operator>=</span> o1.sno</span><br><span class=line>) <span class=keyword>as</span> o2</span><br><span class=line><span class=keyword>where</span> o2.d_level <span class=operator>></span> <span class=number>1</span></span><br></pre></table></figure><h2 id=2-16、查询和学号为108的同学同年出生的所有学生的Sno、Sname和Sbirthday列><a class=headerlink href=#2-16、查询和学号为108的同学同年出生的所有学生的Sno、Sname和Sbirthday列 title=2.16、查询和学号为108的同学同年出生的所有学生的Sno、Sname和Sbirthday列></a>2.16、查询和学号为108的同学同年出生的所有学生的Sno、Sname和Sbirthday列</h2><figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre><td class=code><pre><span class=line><span class=keyword>select</span></span><br><span class=line>	st.sno,</span><br><span class=line>	st.sname,</span><br><span class=line>	st.birthday</span><br><span class=line><span class=keyword>from</span> s2_student <span class=keyword>as</span> st</span><br><span class=line><span class=keyword>where</span> <span class=keyword>YEAR</span>(st.birthday) <span class=operator>=</span> (</span><br><span class=line>	<span class=keyword>select</span> <span class=keyword>YEAR</span>(birthday) <span class=keyword>from</span> s2_student <span class=keyword>where</span> sno <span class=operator>=</span> "108"</span><br><span class=line>) <span class=keyword>and</span> st.sno <span class=operator>!=</span> "108"</span><br></pre></table></figure><h2 id=2-17、查询“张旭“教师任课的学生成绩><a class=headerlink href=#2-17、查询“张旭“教师任课的学生成绩 title=2.17、查询“张旭“教师任课的学生成绩></a>2.17、查询“张旭“教师任课的学生成绩</h2><figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br></pre><td class=code><pre><span class=line><span class=keyword>select</span> s.<span class=operator>*</span></span><br><span class=line><span class=keyword>from</span> s2_score <span class=keyword>as</span> s</span><br><span class=line><span class=keyword>join</span> (</span><br><span class=line>	<span class=keyword>select</span> c.cno</span><br><span class=line>	<span class=keyword>from</span> s2_course <span class=keyword>as</span> c</span><br><span class=line>	<span class=keyword>join</span> (</span><br><span class=line>		<span class=keyword>select</span> t.tno</span><br><span class=line>		<span class=keyword>from</span> s2_teacher <span class=keyword>as</span> t</span><br><span class=line>		<span class=keyword>where</span> t.tname <span class=operator>=</span> "张旭"</span><br><span class=line>	) <span class=keyword>as</span> o1 <span class=keyword>on</span> c.tno <span class=operator>=</span> o1.tno</span><br><span class=line>) <span class=keyword>as</span> o2 <span class=keyword>on</span> s.cno <span class=operator>=</span> o2.cno</span><br></pre></table></figure><h2 id=2-18、查询选修某课程的同学人数多于5人的教师姓名><a class=headerlink href=#2-18、查询选修某课程的同学人数多于5人的教师姓名 title=2.18、查询选修某课程的同学人数多于5人的教师姓名></a>2.18、查询选修某课程的同学人数多于5人的教师姓名</h2><figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br></pre><td class=code><pre><span class=line><span class=keyword>select</span> t.<span class=operator>*</span></span><br><span class=line><span class=keyword>from</span> s2_teacher <span class=keyword>as</span> t</span><br><span class=line><span class=keyword>join</span> (</span><br><span class=line>	<span class=keyword>select</span> c.tno</span><br><span class=line>	<span class=keyword>from</span> s2_course <span class=keyword>as</span> c</span><br><span class=line>	<span class=keyword>join</span> (</span><br><span class=line>		<span class=keyword>select</span> s.cno</span><br><span class=line>		<span class=keyword>from</span> s2_score <span class=keyword>as</span> s</span><br><span class=line>		<span class=keyword>group</span> <span class=keyword>by</span> s.cno</span><br><span class=line>		<span class=keyword>having</span> <span class=built_in>count</span>(s.sno) <span class=operator>></span> <span class=number>5</span></span><br><span class=line>	) <span class=keyword>as</span> o1 <span class=keyword>on</span> c.cno <span class=operator>=</span> o1.cno</span><br><span class=line>) <span class=keyword>as</span> o2 <span class=keyword>on</span> t.tno <span class=operator>=</span> o2.tno</span><br></pre></table></figure><h2 id=2-19、查询95033班和95031班全体学生的记录><a class=headerlink href=#2-19、查询95033班和95031班全体学生的记录 title=2.19、查询95033班和95031班全体学生的记录></a>2.19、查询95033班和95031班全体学生的记录</h2><figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line><span class=keyword>select</span> st.<span class=operator>*</span></span><br><span class=line><span class=keyword>from</span> s2_student <span class=keyword>as</span> st</span><br><span class=line><span class=keyword>where</span> st.class <span class=operator>=</span> "95033" <span class=keyword>or</span> st.class <span class=operator>=</span> "95031"</span><br></pre></table></figure><h2 id=2-20、查询存在有85分以上成绩的课程Cno><a class=headerlink href=#2-20、查询存在有85分以上成绩的课程Cno title=2.20、查询存在有85分以上成绩的课程Cno></a>2.20、查询存在有85分以上成绩的课程Cno</h2><figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line><span class=keyword>select</span> <span class=keyword>DISTINCT</span> s.cno</span><br><span class=line><span class=keyword>from</span> s2_score <span class=keyword>as</span> s</span><br><span class=line><span class=keyword>where</span> s.degree <span class=operator>></span> <span class=number>85</span></span><br></pre></table></figure><h2 id=2-21、查询出“计算机系“教师所教课程的成绩表><a class=headerlink href=#2-21、查询出“计算机系“教师所教课程的成绩表 title=2.21、查询出“计算机系“教师所教课程的成绩表></a>2.21、查询出“计算机系“教师所教课程的成绩表</h2><figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br></pre><td class=code><pre><span class=line><span class=keyword>select</span> s.<span class=operator>*</span></span><br><span class=line><span class=keyword>from</span> s2_score <span class=keyword>as</span> s</span><br><span class=line><span class=keyword>join</span> (</span><br><span class=line>	<span class=keyword>select</span> c.cno</span><br><span class=line>	<span class=keyword>from</span> s2_course <span class=keyword>as</span> c</span><br><span class=line>	<span class=keyword>join</span> (</span><br><span class=line>		<span class=keyword>select</span> t.tno</span><br><span class=line>		<span class=keyword>from</span> s2_teacher <span class=keyword>as</span> t</span><br><span class=line>		<span class=keyword>where</span> t.depart <span class=operator>=</span> "计算机系"</span><br><span class=line>	) <span class=keyword>as</span> o1 <span class=keyword>on</span> c.tno <span class=operator>=</span> o1.tno</span><br><span class=line>) <span class=keyword>as</span> o2 <span class=keyword>on</span> s.cno <span class=operator>=</span> o2.cno</span><br></pre></table></figure><h2 id=2-22、查询所有教师和同学的name、sex和birthday><a class=headerlink href=#2-22、查询所有教师和同学的name、sex和birthday title=2.22、查询所有教师和同学的name、sex和birthday></a>2.22、查询所有教师和同学的name、sex和birthday</h2><figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br></pre><td class=code><pre><span class=line><span class=keyword>select</span></span><br><span class=line>	st.sname,</span><br><span class=line>	st.sex,</span><br><span class=line>	st.birthday</span><br><span class=line><span class=keyword>from</span> s2_student <span class=keyword>as</span> st</span><br><span class=line><span class=keyword>union</span> <span class=keyword>all</span></span><br><span class=line><span class=keyword>select</span></span><br><span class=line>	t.tname,</span><br><span class=line>	t.sex,</span><br><span class=line>	t.birthday</span><br><span class=line><span class=keyword>from</span> s2_teacher <span class=keyword>as</span> t</span><br></pre></table></figure><h2 id=2-23、查询所有“女”教师和“女”同学的name、sex和birthday><a class=headerlink href=#2-23、查询所有“女”教师和“女”同学的name、sex和birthday title=2.23、查询所有“女”教师和“女”同学的name、sex和birthday></a>2.23、查询所有“女”教师和“女”同学的name、sex和birthday</h2><figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br></pre><td class=code><pre><span class=line><span class=keyword>select</span></span><br><span class=line>	st.sname,</span><br><span class=line>	st.sex,</span><br><span class=line>	st.birthday</span><br><span class=line><span class=keyword>from</span> s2_student <span class=keyword>as</span> st</span><br><span class=line><span class=keyword>where</span> st.sex <span class=operator>=</span> "女"</span><br><span class=line><span class=keyword>union</span> <span class=keyword>all</span></span><br><span class=line><span class=keyword>select</span></span><br><span class=line>	t.tname,</span><br><span class=line>	t.sex,</span><br><span class=line>	t.birthday</span><br><span class=line><span class=keyword>from</span> s2_teacher <span class=keyword>as</span> t</span><br><span class=line><span class=keyword>where</span> t.sex <span class=operator>=</span> "女"</span><br></pre></table></figure><h2 id=2-24、查询成绩比该课程平均成绩低的同学的成绩表><a class=headerlink href=#2-24、查询成绩比该课程平均成绩低的同学的成绩表 title=2.24、查询成绩比该课程平均成绩低的同学的成绩表></a>2.24、查询成绩比该课程平均成绩低的同学的成绩表</h2><figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br></pre><td class=code><pre><span class=line><span class=keyword>select</span> o2.<span class=operator>*</span></span><br><span class=line><span class=keyword>from</span> (</span><br><span class=line>	<span class=keyword>select</span></span><br><span class=line>		s.<span class=operator>*</span>,</span><br><span class=line>		o1.degree_avg</span><br><span class=line>	<span class=keyword>from</span> s2_score <span class=keyword>as</span> s</span><br><span class=line>	<span class=keyword>join</span> (</span><br><span class=line>		<span class=keyword>select</span></span><br><span class=line>			s.cno,</span><br><span class=line>			<span class=built_in>avg</span>(s.degree) <span class=keyword>as</span> "degree_avg"</span><br><span class=line>		<span class=keyword>from</span> s2_score <span class=keyword>as</span> s</span><br><span class=line>		<span class=keyword>group</span> <span class=keyword>by</span> s.cno</span><br><span class=line>	) <span class=keyword>as</span> o1 <span class=keyword>on</span> s.cno <span class=operator>=</span> o1.cno</span><br><span class=line>) <span class=keyword>as</span> o2</span><br><span class=line><span class=keyword>where</span> o2.degree <span class=operator><</span> o2.degree_avg</span><br></pre></table></figure><h2 id=2-25、查询所有任课教师的Tname和Depart><a class=headerlink href=#2-25、查询所有任课教师的Tname和Depart title=2.25、查询所有任课教师的Tname和Depart></a>2.25、查询所有任课教师的Tname和Depart</h2><figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre><td class=code><pre><span class=line><span class=keyword>select</span></span><br><span class=line>	t.tname,</span><br><span class=line>	t.depart</span><br><span class=line><span class=keyword>from</span> s2_teacher <span class=keyword>as</span> t</span><br><span class=line><span class=keyword>join</span> (</span><br><span class=line>	<span class=keyword>select</span> c.tno</span><br><span class=line>	<span class=keyword>from</span> s2_course <span class=keyword>as</span> c</span><br><span class=line>) <span class=keyword>as</span> o1 <span class=keyword>on</span> t.tno <span class=operator>=</span> o1.tno</span><br></pre></table></figure><h2 id=2-26、查询至少有2名男生的班号><a class=headerlink href=#2-26、查询至少有2名男生的班号 title=2.26、查询至少有2名男生的班号></a>2.26、查询至少有2名男生的班号</h2><figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre><td class=code><pre><span class=line><span class=keyword>select</span></span><br><span class=line>	st.class</span><br><span class=line><span class=keyword>from</span> s2_student <span class=keyword>as</span> st</span><br><span class=line><span class=keyword>where</span> st.sex <span class=operator>=</span> "男"</span><br><span class=line><span class=keyword>group</span> <span class=keyword>by</span> st.class</span><br><span class=line><span class=keyword>having</span> <span class=built_in>count</span>(st.sex) <span class=operator>>=</span> <span class=number>2</span></span><br></pre></table></figure><h2 id=2-27、查询Student表中不姓“王”的同学记录><a class=headerlink href=#2-27、查询Student表中不姓“王”的同学记录 title=2.27、查询Student表中不姓“王”的同学记录></a>2.27、查询Student表中不姓“王”的同学记录</h2><figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line><span class=keyword>select</span> st.<span class=operator>*</span></span><br><span class=line><span class=keyword>from</span> s2_student <span class=keyword>as</span> st</span><br><span class=line><span class=keyword>where</span> st.sname <span class=keyword>not</span> <span class=keyword>like</span> "王%";</span><br></pre></table></figure><h2 id=2-28、查询Student表中每个学生的姓名和年龄><a class=headerlink href=#2-28、查询Student表中每个学生的姓名和年龄 title=2.28、查询Student表中每个学生的姓名和年龄></a>2.28、查询Student表中每个学生的姓名和年龄</h2><figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line><span class=keyword>select</span></span><br><span class=line>	st.sno,</span><br><span class=line>	st.sname,</span><br><span class=line>	(<span class=keyword>YEAR</span>(NOW()) <span class=operator>-</span> <span class=keyword>YEAR</span>(st.birthday)) <span class=keyword>as</span> "年龄"</span><br><span class=line><span class=keyword>from</span> s2_student <span class=keyword>as</span> st</span><br></pre></table></figure></div><footer class=post-footer><div class=post-eof></div></footer></article></div><div class=post-block><article class=post-content itemscope itemtype=http://schema.org/Article><link href=https://hgprivate.github.io/2024/08/21/MySQL%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95/ itemprop=mainEntityOfPage><span hidden itemprop=author itemscope itemtype=http://schema.org/Person> <meta content=/static/imgs/avatar.png itemprop=image> <meta content=豪哥 itemprop=name> </span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization> <meta content=豪哥博客 itemprop=name> <meta content=豪哥博客 itemprop=description> </span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork> <meta content="undefined | 豪哥博客" itemprop=name> <meta itemprop=description> </span><header class=post-header><h2 itemprop="name headline" class=post-title><a class=post-title-link href=/2024/08/21/MySQL%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95/ itemprop=url>MySQL系列-MySQL基础应用</a></h2><div class=post-meta-container><div class=post-meta><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar"></i> </span> <span class=post-meta-item-text>发表于</span> <time itemprop="dateCreated datePublished" title="创建时间：2024-08-21 21:39:14" datetime=2024-08-21T21:39:14+08:00>2024-08-21</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar-check"></i> </span> <span class=post-meta-item-text>更新于</span> <time title="修改时间：2024-10-22 11:27:17" datetime=2024-10-22T11:27:17+08:00 itemprop=dateModified>2024-10-22</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-folder"></i> </span> <span class=post-meta-item-text>分类于</span> <span itemprop=about itemscope itemtype=http://schema.org/Thing> <a href=/categories/MySQL/ itemprop=url rel=index><span itemprop=name>MySQL</span></a> </span> </span></div></div></header><div class=post-body itemprop=articleBody><h1 id=1、MySQL基础><a class=headerlink href=#1、MySQL基础 title=1、MySQL基础></a>1、MySQL基础</h1><h2 id=1-1、MySQL体系结构><a class=headerlink href=#1-1、MySQL体系结构 title=1.1、MySQL体系结构></a>1.1、MySQL体系结构</h2><p>MySQL体系结构如下：<p><img alt=image-20220410152916029 src=https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/06/image-20220410152916029.png><p><strong>MySQL在系统角度就是一个进程。实例与数据库的关系相互对应</strong>。<blockquote><p>Oracle的Windows版也是单进程多线程架构。</blockquote><p>MySQL由以下几部分组成：<ol><li>连接池<li>管理服务和工具组件<li>SQL接口组件<li>查询分析组件<li>优化组件<li>缓冲组件<li>插件式存储引擎<li>物理文件</ol><blockquote><p><font color=red>注意：存储引擎基于表，而非基于数据库。</font></blockquote><h2 id=1-2、字符集><a class=headerlink href=#1-2、字符集 title=1.2、字符集></a>1.2、字符集</h2><h3 id=1-2-1、字符集级别><a class=headerlink href=#1-2-1、字符集级别 title=1.2.1、字符集级别></a>1.2.1、字符集级别</h3><h4 id=简介><a class=headerlink href=#简介 title=简介></a>简介</h4><p>MySQL有4个级别的字符集和比较规则：<ul><li>服务器级别<li>数据库级别<li>表级别<li>列级别</ul><p>命令<code>show variables like 'character%';</code>可打印当前数据库生效的各种字符集信息：<ul><li><strong>character_set_client</strong>：服务器解码请求时使用的字符集。<li><strong>character_set_connection</strong>：服务器把请求字符串从character_set_client转为 character_set_connection。<li><strong>character_set_database</strong>：数据库的字符集。<li><strong>character_set_filesystem</strong>：文件系统字符集。<li><strong>character_set_results</strong>：服务器向客户端返回数据时使用的字符集。<li><strong>character_set_server</strong>：服务器级别的字符集。<li><strong>character_set_system</strong>：系统字符集。<li><strong>character_sets_dir</strong>：字符集设置路径。</ul><h4 id=服务器级别><a class=headerlink href=#服务器级别 title=服务器级别></a>服务器级别</h4><p>参数<code>character_set_server</code>用来设置 服务器字符集。可在服务器运行中通过set语句来修改，也可直接在配置文件中配置。配置文件配置示例如下：<figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line><span class=attr>[server]</span></span><br><span class=line><span class=attr>character_set_server</span>=<span class=string>gbk 			 # 默认字符集</span></span><br><span class=line><span class=attr>collation_server</span>=<span class=string>gbk_chinese_ci    	 # 默认比较规则</span></span><br></pre></table></figure><h4 id=数据库级别><a class=headerlink href=#数据库级别 title=数据库级别></a>数据库级别</h4><p>参数<code>character_set_database</code>用来设置 数据库字符集。<p>创建和修改数据库的时候可以指定该数据库的字符集和比较规则，具体语法如下：<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line>CREATE DATABASE 数据库名 [[DEFAULT] CHARACTER SET 字符集名称] [[DEFAULT] COLLATE 比较规则名称];</span><br><span class=line>ALTER DATABASE 数据库名 [[DEFAULT] CHARACTER SET 字符集名称]</span><br></pre></table></figure><h4 id=表级别><a class=headerlink href=#表级别 title=表级别></a>表级别</h4><p>在创建和修改表时可以设置表的字符集和比较规则，语法如下：<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line>CREATE TABLE 表名 (列的信息) [[DEFAULT] CHARACTER SET 字符集名称] [COLLATE 比较规则名称]]</span><br><span class=line>ALTER TABLE 表名 [[DEFAULT] CHARACTER SET 字符集名称] [COLLATE 比较规则名称]</span><br></pre></table></figure><p>如果创建和修改表时没有指明字符集和比较规则，将使用该表所在数据库的字符集和比较规则。<h4 id=列级别><a class=headerlink href=#列级别 title=列级别></a>列级别</h4><p>对于存储字符串的列，同一个表中的不同的列也可以有不同的字符集和比较规则。我们在创建和修改列 定义的时候可以指定该列的字符集和比较规则，语法如下：<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre><td class=code><pre><span class=line>CREATE TABLE 表名(</span><br><span class=line>	列名 字符串类型 [CHARACTER SET 字符集名称] [COLLATE 比较规则名称],</span><br><span class=line>	其他列...</span><br><span class=line>);</span><br><span class=line></span><br><span class=line>ALTER TABLE 表名 MODIFY 列名 字符串类型 [CHARACTER SET 字符集名称] [COLLATE 比较规则名称];</span><br></pre></table></figure><p>如果在创建和修改的语句中没有指明字符集和比较规则，将使用该列所在表的字符集和比较规则作为该列的字符集和比较规则。<p><font color=red>注意：在转换列字符集前，列中存储的数据不能用转换后的字符集来表示时会发生错误。</font><h4 id=小结><a class=headerlink href=#小结 title=小结></a>小结</h4><p>字符集和比较规则的关系如下：<ul><li>如果 创建或修改列时 没有显式指定字符集和比较规则，则该列 <strong>使用表的字符集和比较规则</strong>。<li>如果 创建表时 没有显式指定字符集和比较规则，则该表 <strong>使用数据库的字符集和比较规则</strong>。<li>如果 创建数据库时 没有显式指定字符集和比较规则，则该数据库 <strong>使用服务器的字符集和比较规则</strong>。</ul><p>utf8 字符集有两种：<ul><li><strong>utf8mb3</strong>：阉割过的 utf8 字符集，只使用1～3个字节表示1个字符。<li><strong>utf8mb4</strong>：正宗的 utf8 字符集，使用1～4个字节表示1个字符。</ul><h3 id=1-2-2、请求响应字符集><a class=headerlink href=#1-2-2、请求响应字符集 title=1.2.2、请求响应字符集></a>1.2.2、请求响应字符集</h3><p>请求响应字符集主要有如下 3 种：<ul><li><strong>character_set_client</strong>：服务器 解码请求时 使用的字符集。<li><strong>character_set_connection</strong>：服务器 处理请求时 会把请求字符串从character_set_client 转为 character_set_connection。<li><strong>character_set_results</strong>：服务器 返回数据给客户端时 使用的字符集。</ul><h3 id=1-2-3、比较规则><a class=headerlink href=#1-2-3、比较规则 title=1.2.3、比较规则></a>1.2.3、比较规则</h3><p>MySQL支持多种字符集，对应的也有很多种比较规则。<p><strong>比较规则的后缀也有一定的含义，比如是否区分语言中的重音、大小写等</strong>。具体如下：<table><thead><tr><th align=center>比较规则后缀<th align=center>描述<tbody><tr><td align=center>_ai<td align=center>不区分重音<tr><td align=center>_as<td align=center>区分重音<tr><td align=center>_ci<td align=center>不区分大小写<tr><td align=center>_cs<td align=center>区分大小写<tr><td align=center>_bin<td align=center>以二进制方式比较</table><h3 id=1-2-4、字符集设置><a class=headerlink href=#1-2-4、字符集设置 title=1.2.4、字符集设置></a>1.2.4、字符集设置</h3><p><strong>MySQL 5.7 默认的客户端和服务器都用了 latin1 ，不支持中文</strong>。<p><strong>MySQL 8.0 前默认字符集为<code>latin1</code>，utf8字符集指向<code>utf8mb3</code>。MySQL 8.0及之后默认编码为<code>utf8mb4</code>。</strong><h4 id=查看字符集><a class=headerlink href=#查看字符集 title=查看字符集></a>查看字符集</h4><ol><li>使用 SHOW CREATE TABLE 语句；<li>使用 DESCRIBE 语句；<li>使用 INFORMATION_SCHEMA 数据库；<li>使用 SHOW TABLE STATUS 语句；<li>使用 SHOW FULL COLUMNS 语句；<li>使用 SHOW VARIABLES 语句；</ol><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre><td class=code><pre><span class=line># 查看数据库连接情况</span><br><span class=line>show processlist;</span><br><span class=line># 查看数据库中可用的字符集</span><br><span class=line>show character set;</span><br><span class=line># 查看数据库表的字符集</span><br><span class=line>show create table tbl_user1;</span><br><span class=line># 查看字符集（latin1）的校对规则</span><br><span class=line>SHOW COLLATION LIKE 'latin1%';</span><br></pre></table></figure><h4 id=修改字符集><a class=headerlink href=#修改字符集 title=修改字符集></a>修改字符集</h4><p>1、修改字符集<p>编辑 my.cnf 文件，添加配置如下内容：<figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line><span class=comment># 在MySQL5.7或之前的版本中，在文件最后加上中文字符集配置</span></span><br><span class=line><span class=attr>character_set_server</span>=<span class=string>utf8</span></span><br></pre></table></figure><p>2、修改 已创建数据库 的字符集：<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>alter database dbtest1 character set 'utf8';</span><br></pre></table></figure><p>3、修改 已创建表 的字符集：<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>alter table t_emp convert to character set 'utf8';</span><br></pre></table></figure><p><font color=red>注意：原有数据如果基于非’utf8’编码存储，那么原有数据编码不会发生改变。若需修改原有数据的字符集编码，那么只能将 原有数据 导出或删除后 重新插入来实现修改效果。</font><p>4、、重启MySQL服务。<p>字符集修改后不会对原库、原表产生修改，参数修改只对新建的数据库生效。<h2 id=1-3、数据类型><a class=headerlink href=#1-3、数据类型 title=1.3、数据类型></a>1.3、数据类型</h2><h3 id=1-3-1、数据分类><a class=headerlink href=#1-3-1、数据分类 title=1.3.1、数据分类></a>1.3.1、数据分类</h3><p>MySQL支持多种数据类型，整体可分为如下几种：<ul><li><strong>数值类型</strong><ul><li>整数类型（精确值）：TINYINT、SMALLINT、MEDIUMINT、INT、INTEGER、BIGINT；<li>浮点类型（近似值）：FLOAT、DOUBLE；<li>定点类型（精确值）：DECIMAL、NUMERIC；<li>位值类型：BIT；</ul><li><strong>字符串类型</strong>：<ul><li>CHAR 和 VARCHAR 类型<li>BINARY 和 VARBINARY 类型<li>BLOB 和 TEXT 类型<li>ENUM 类型<li>SET 类型</ul><li><strong>日期和时间类型</strong>：YEAR、DATE、TIME、TIMESTAMP、DATETIME；<li><strong>空间类型</strong><li><strong>JSON类型</strong></ul><p>数据类型也有属性，<strong>常见属性如：NULL、NOT NULL、DEFAULT、PRIMARY KEY、AUTO_INCREMENT、USSIGNED（无符号，非负）、CHARACTER SET name</strong>；<h3 id=1-3-2、数值类型><a class=headerlink href=#1-3-2、数值类型 title=1.3.2、数值类型></a>1.3.2、数值类型</h3><p>数值类型有TINYINT、SMALLINT、MEDIUMINT、INT或INTEGER、BIGINT、FLOAT、DOUBLE、DECIMAL等类型。具体对比如下：<table><thead><tr><th align=left>类型<th align=left>范围（有符号）<th align=left>大小<th align=left>范围（无符号）<tbody><tr><td align=left>TINYINT<td align=left>(-128，127)<td align=left>1 Bytes<td align=left>(0，255)<tr><td align=left>SMALLINT<td align=left>(-32 768，32 767)<td align=left>2 Bytes<td align=left>(0，65 535)<tr><td align=left>MEDIUMINT<td align=left>(-8 388 608，8 388 607)<td align=left>3 Bytes<td align=left>(0，16 777 215)<tr><td align=left>INT或INTEGER<td align=left>(-2 147 483 648，2 147 483 647)<td align=left>4 Bytes<td align=left>(0，4 294 967 295)<tr><td align=left>BIGINT<td align=left>(-9,223,372,036,854,775,808，9 223 372 036 854 775 807)<td align=left>8 Bytes<td align=left>(0，18 446 744 073 709 551 615)<tr><td align=left>FLOAT<td align=left>(-3.402 823 466 E+38，-1.175 494 351 E-38)，0，(1.175 494 351 E-38，3.402 823 466 351 E+38)<td align=left>4 Bytes<td align=left>0，(1.175 494 351 E-38，3.402 823 466 E+38)<tr><td align=left>DOUBLE<td align=left>(-1.797 693 134 862 315 7 E+308，-2.225 073 858 507 201 4 E-308)，0，(2.225 073 858 507 201 4 E-308，1.797 693 134 862 315 7 E+308)<td align=left>8 Bytes<td align=left>0，(2.225 073 858 507 201 4 E-308，1.797 693 134 862 315 7 E+308)<tr><td align=left>DECIMAL<td align=left>依赖于M和D的值<td align=left>对于DECIMAL(M,D) ，M>D时为M+2，否则为D+2<td align=left>依赖于M和D的值</table><h4 id=整数类型><a class=headerlink href=#整数类型 title=整数类型></a>整数类型</h4><p><strong><code>INT(5) ZEROFILL</code>中的 5 表示显示宽度，当数字不够5位时用数字0来补齐，当数字超过5位时，不会受宽度5限制的影响，是多少位就显示多少位</strong>。ZEROFILL表示不够位数时使用0来填充，要注意，ZEROFILL修饰字段时会自动加上UNSIGNED修饰，这样字段值就只能为正数了。<h4 id=浮点类型><a class=headerlink href=#浮点类型 title=浮点类型></a>浮点类型</h4><p><strong>MySQL存储浮点数的格式为：符号、尾数、阶码。无论有没有符号，浮点数都会存储表示符号的部分。所以，无符号取值范围就是无符号取值范围中大于等于0的那部分</strong>。<p>MySQL中<strong>单精度值使用4字节，双精度值使用 8字节</strong>。<ul><li>MySQL允许使用非标准语法：FLOAT(M, D)、DOUBLE(M, D)，其中M称为精度（整数位+小数位），D称为标度（小数位）。精度与标度取值范围：D <= M <=255，0 <=D <= 30。<li><strong>FLOAT 和 DOUBLE 不指定(M,D)时，默认按实际精度来显示</strong>。<li><strong>浮点类型可以加UNSIGNED，但不会改变数值范围</strong>。<li>无论设置精度与否，MySQL处理规则如下：<ul><li>以 二进制 形式存储，因小数对应的二进制有时不能准确表示，会进行四舍五入，导致不精准。<li>整数部分超过设定精度时直接报错。<li>小数部分超过设定精度时 执行 四舍五入：<ul><li>四舍五入后，整数部分没有超过范围，则只是警告，但能删除五入后多余的小数。<li>四舍入五后，整数部分超过范围，则会报错拒绝处理。</ul></ul></ul><h4 id=定点类型><a class=headerlink href=#定点类型 title=定点类型></a>定点类型</h4><p><strong>MySQL中定点类型只有 DECIMAL。MySQL中的定点数基于 字符串 形式存储，这决定了它是精确的</strong>。<p><code>DECIMAL(M, D) DESC NUMERIC</code>占用 M+2 个字节，M称为精度，D称为标度，有效范围由 M 和 D 决定。精度与标度取值范围：0 <= M <= 65，0 <= D <= 30，最大取值范围与DOUBLE类型一样。<p><strong>DECIMAL不指定精度和标度时默认为DECIMAL(10, 0)，当数据精度超过阈值范围时会执行四舍五入</strong>。<h4 id=位值类型><a class=headerlink href=#位值类型 title=位值类型></a>位值类型</h4><p><strong><code>BIT(M)</code>中M表示长度，长度范围：1 <= M <= 64，占用<code>(M+7)/8</code>个字节</strong>。<p><strong>BIT类型没有指定M时，默认为<code>BIT(1)</code>，表示只能存储1位的二进制值，M表示二进制数字的位数</strong>。<h3 id=1-3-3、字符串类型><a class=headerlink href=#1-3-3、字符串类型 title=1.3.3、字符串类型></a>1.3.3、字符串类型</h3><p>字符串类型有CHAR、VARCHAR、TINYBLOB、TINYTEXT、BLOB、TEXT、MEDIUMBLOB、MEDIUMTEXT、LONGBLOB、LONGTEXT等类型。具体对比如下：<table><thead><tr><th align=center>类型<th align=center>长度<th align=left>用途<tbody><tr><td align=center>CHAR<td align=center>0-255<td align=left>定长字符串<tr><td align=center>VARCHAR<td align=center>0-65535<td align=left>变长字符串<tr><td align=center>TINYBLOB<td align=center>0-255<td align=left>不超过 255 个字符的二进制字符串<tr><td align=center>TINYTEXT<td align=center>0-255<td align=left>短文本字符串<tr><td align=center>BLOB<td align=center>0-65 535（64K）<td align=left>二进制形式的长文本数据<tr><td align=center>TEXT<td align=center>0-65 535（64K）<td align=left>长文本数据<tr><td align=center>MEDIUMBLOB<td align=center>0-16 777 215（16M）<td align=left>二进制形式的中等长度文本数据<tr><td align=center>MEDIUMTEXT<td align=center>0-16 777 215（16M）<td align=left>中等长度文本数据<tr><td align=center>LONGBLOB<td align=center>0-4 294 967 295（4G）<td align=left>二进制形式的极大文本数据<tr><td align=center>LONGTEXT<td align=center>0-4 294 967 295（4G）<td align=left>极大文本数据<tr><td align=center>ENUM<td align=center>0 - 65535<td align=left>1或2个字节<tr><td align=center>SET<td align=center>0 - 64<td align=left>1、2、3、4或8个字节</table><h4 id=CHAR与VARCHAR类型><a class=headerlink href=#CHAR与VARCHAR类型 title=CHAR与VARCHAR类型></a>CHAR与VARCHAR类型</h4><ul><li>CHAR类型<ul><li><strong>需要预先定义字符长度，不指定时默认长度为1个字符。若设定了长度，则该长度表示所占字节数。</strong><li>字段值实际长度小于设定长度时，会在字段值右边以空格来填充至设定长度。MySQL检索CHAR类型字段值时，会去掉字段值尾部空格。</ul><li>VARCHAR类型<ul><li><strong>定义字段为VARCHAR类型时，必须指定长度，否则报错</strong>。<li>MySQL 4.0 前，varchar(20) 表示 20个字节，可以存储 6 个 UTF-8编码的汉字（每个汉字占3字节）。MySQL 5.0 后，varchar(20) 表示 20个字符。<li>检索VARCHAR类型字段值时，会保留数据末尾空格。VARCHAR类型字段占用空间大小为字符串实际长度+1。</ul></ul><p>Varchar类型限制：<ul><li><strong>存储限制</strong>：varchar类型的字段值会单独存储到聚簇索引之外，第1个字节不存储，第2、3个字节表示实际内容的长度，剩余的字节空间存储真实数据，最大不超过65535。<li><strong>编码长度限制</strong>：gbk下，每个字符2个字节，最大长度不超过32766（65535/2）。utf8下，每个字符3个字节，最大长度不超过21845（65535/3）。<li><strong>行长和表列数限制</strong>：mysql规定最大行大小为65535字节，表的最大列数为4096。</ul><h4 id=TEXT类型><a class=headerlink href=#TEXT类型 title=TEXT类型></a>TEXT类型</h4><p><strong>因为实际长度不确定，MySQL不允许TEXT类型的字段做主键</strong>。<h4 id=BLOB类型><a class=headerlink href=#BLOB类型 title=BLOB类型></a>BLOB类型</h4><p><strong>BLOB是一个二进制大对象，可以容纳可变数量的数据。主要用来存储图片、音频、视频等</strong>。<p>生产中不会使用BLOB类型来存储大对象数据，通常会将 图片、音频、视频等文件存储到服务器磁盘上，并将它们的访问路径存储到MySQL中。<p>TEXT和BLOB类型使用注意事项如下：<ol><li><strong>执行大量删除或修改会导致数据表存在很大的空洞（碎片），为提高性能，建议定期使用OPTIMIZE TABLE功能对表进行碎片整理</strong>。<li>虽然MySQL为检索大文本提供了前缀索引，但还是要减少对大型BLOB或TEXT值的模糊检索。<li>如果需要使用BLOB或TEXT数据类型，那么建议将TEXT列和BLOB列分离到一个单独的表中。</ol><h3 id=1-3-4、时间类型><a class=headerlink href=#1-3-4、时间类型 title=1.3.4、时间类型></a>1.3.4、时间类型</h3><p>时间类型有YEAR、DATA、TIME、TIMESTAMP、DATETIME等类型。具体对比如下：<table><thead><tr><th align=center>类型<th align=center>大小<th align=center>范围<tbody><tr><td align=center>YEAR<td align=center>1Byte<td align=center>1901 ~ 2155<tr><td align=center>DATE<td align=center>3Byte<td align=center>1000-01-01 ~ 9999-12-31<tr><td align=center>TIME<td align=center>3Byte<td align=center>‘-838:59:59’ ~ ‘838:59:59’<tr><td align=center>TIMESTAMP<td align=center>4Byte<td align=center>1970-01-01 00:00:00 ~ 2038-01-19 03:14:07。结束时间：北京时间2038-1-19_11:14:07，格林尼治时间2038-01-19_03:14:07<tr><td align=center>DATETIME<td align=center>8Byte<td align=center>1000-01-01 00:00:00/9999-12-31 23:59:59</table><h4 id=DATETIME类型><a class=headerlink href=#DATETIME类型 title=DATETIME类型></a>DATETIME类型</h4><p><strong>DATETIME类型占用8字节，在所有日期和时间类型中占用空间最大</strong>。<p>向DATETIME类型的字段插入数据时，需要满足一定的格式条件：<ul><li>推荐使用<code>YYYY-mm-DD HH:MM:SS</code>格式来插入。<li>可以使用<code>CURRENT_TIMESTAMP()</code> 、<code>NOW()</code>函数的返回值来作为字段值进行插入。</ul><h4 id=TIMESTAMP类型><a class=headerlink href=#TIMESTAMP类型 title=TIMESTAMP类型></a>TIMESTAMP类型</h4><p><strong>TIMESTAMP类型占用4字节存储空间。显示格式与DATETIME类型一样</strong>。<p>TIMESTAMP类型字段中存储数据时 <strong>需要对当前时间所在的时区进行转换，查询时再将时区转换回当前时区</strong>。使用TIMESTAMP存储的同一时间，在不同时区环境下会显示不同时间。<p>向TIMESTAMP类型的字段插入数据的格式可以使用<code>YY-MM-DD HH:MM:SS</code>。<blockquote><p>若无特殊需求，生产中推荐使用DATETIME类型来存储时间。DATETIME数据类型包含了完整的日期和时间，取值范围很大，使用较方便。</blockquote><h3 id=1-3-5、数据类型总结><a class=headerlink href=#1-3-5、数据类型总结 title=1.3.5、数据类型总结></a>1.3.5、数据类型总结</h3><p>定义字段数据类型时，参考建议如下：<ul><li>定义数据类型时，<strong>确定是整数就用INT，确定是小数就用DECIMAL(M, D)，如果是日期类型就用DATETIME</strong>。<li><strong>如果存储的字符串长度几乎相等，推荐使用CHAR定长字符串类型</strong>。<li><strong>VARCHAR是可变长字符串，不预先分配空间，建议长度不要超过5000。如果长度超过5000，建议定义字段类型为TEXT，且将之单独放于一张表中</strong>，然后使用主键来关联原表，避免影响其它字段索引效率。</ul><p>字节与字符关系如下：<ul><li>ASCII 码中，一个英文字母（不分大小写）为一个字节，一个中文汉字为两个字节。<li>UTF-8 编码中，一个英文字为一个字节，一个中文为三个字节。<li>Unicode 编码中，一个英文为一个字节，一个中文为两个字节。<li>符号：英文标点为一个字节，中文标点为两个字节。例如：英文句号 <strong>.</strong> 占1个字节的大小，中文句号 <strong>。</strong>占2个字节的大小。<li>UTF-16 编码中，一个英文字母字符或一个汉字字符存储都需要 2 个字节（Unicode 扩展区的一些汉字存储需要 4 个字节）。<li>UTF-32 编码中，世界上任何字符的存储都需要 4 个字节。</ul><h2 id=1-4、存储引擎><a class=headerlink href=#1-4、存储引擎 title=1.4、存储引擎></a>1.4、存储引擎</h2><h3 id=引擎分类><a class=headerlink href=#引擎分类 title=引擎分类></a>引擎分类</h3><ul><li><strong>InnoDB</strong>：<ul><li>支持行锁、表锁、外键、事务。<li>5.5.8及之后版本，默认采用InnoDB引擎 。<li>InnoDB是目前MySQL的默认事务型引擎 。<li>InnoDB是处理巨大数据量的最大性能设计 。<li>InnoDB写处理效率差一些。<li>InnoDB不仅缓存索引还要缓存真实数据， 对内存要求较高 ，而且内存大小对性能有决定性影响；MyISAM只缓存索引，不缓存真实数据；</ul><li><strong>MyISAM</strong><ul><li>不支持行锁、外键、事务，崩溃后无法安全恢复 。<li>5.5版本前是默认存储引擎。<li>适用于只读或多读场景。</ul><li><strong>Memory</strong>：将数据存储在内存中，速度快，但不会持久化，适合缓存、临时表场景。<li>Blackhole：不会存储数据，但会将接收到的数据记录在二进制日志中，适合数据同步、备份等场景<li><strong>Federated</strong>：将不同mysql服务器中的表关联起来，使其逻辑上看起来像是一张表，实现MySQL服务器之间的数据共享。<li><strong>NDB</strong>：支持分布式数据库，适合海量数据存储和高可用场景。<li><strong>Archive</strong>：将数据以压缩格式存储在文件中，适合存储历史数据或不经常使用的数据。<li><strong>CSV</strong>：将数据以CSV格式存储在文件中，适合存储大量数据且不需要索引的场景。</ul><h3 id=引擎比较><a class=headerlink href=#引擎比较 title=引擎比较></a>引擎比较</h3><ul><li><strong>InnoDB</strong>：支持行锁、外键、事务、非锁定读，5.5.8版本开始为默认引擎。<ul><li>MySQL 5.7：字符集+排序规则等信息保存在<strong>db.opt</strong>文件中。<ul><li>独立表空间：**.frm**文件（表结构） / <strong>.ibd</strong>文件（索引+数据）。<li>系统表空间：<strong>ibdata1</strong>，默认12M。</ul><li>MySQL 8<ul><li>独立表空间：**.ibd**文件（字符集+排序规则+表结构+表数据）。</ul></ul><li><strong>MyISAM</strong>：不支持事务，但支持表锁、全文索引，5.5.8版本之前的默认引擎（除了windows版）。<ul><li>MySQL 5.7：字符集+排序规则等信息保存在<strong>db.opt</strong>文件中。<ul><li>独立表空间：**.frm**文件（表结构） / <strong>.MYD</strong>文件（数据）/ <strong>.MYI</strong>（索引）<li>系统表空间：<strong>ibdata1</strong>中，默认12M</ul><li>MySQL 8<ul><li>独立表空间：**.xxx.sdi**（表结构，相当于5.7中的frm） / <strong>.MYD</strong>（数据）/ <strong>.MYI</strong>（索引）</ul></ul><li><strong>Memory</strong>：数据存放于内存，适合存储临时数据、数据仓库维度表，使用哈希索引。</ul><h3 id=系统存储引擎管理><a class=headerlink href=#系统存储引擎管理 title=系统存储引擎管理></a>系统存储引擎管理</h3><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre><td class=code><pre><span class=line># 查看</span><br><span class=line>show engines;</span><br><span class=line>show engines \G;</span><br><span class=line></span><br><span class=line># 设置</span><br><span class=line>show variables like '%storage_engine%';</span><br><span class=line>SELECT @@default_storage_engine;</span><br></pre></table></figure><p>也可以 修改配置文件 来实现相同效果：<figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line><span class=attr>default-storage-engine</span>=<span class=string>MyISAM</span></span><br><span class=line><span class=comment># 重启服务</span></span><br><span class=line><span class=attr>systemctl</span> <span class=string>restart mysqld.service</span></span><br></pre></table></figure><h3 id=表存储引擎管理><a class=headerlink href=#表存储引擎管理 title=表存储引擎管理></a>表存储引擎管理</h3><p>创建表时执行：<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line>CREATE TABLE 表名(</span><br><span class=line>	建表语句;</span><br><span class=line>) ENGINE = 存储引擎名称;</span><br></pre></table></figure><p>修改表的存储引擎：<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>ALTER TABLE 表名 ENGINE = 存储引擎名称;</span><br></pre></table></figure><h2 id=1-5、SQL运行><a class=headerlink href=#1-5、SQL运行 title=1.5、SQL运行></a>1.5、SQL运行</h2><h3 id=1-5-1、执行流程><a class=headerlink href=#1-5-1、执行流程 title=1.5.1、执行流程></a>1.5.1、执行流程</h3><p><img alt=image-20220410153114801 src=https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/06/image-20220410153114801.png><h4 id=1-5-1-1、查询缓存><a class=headerlink href=#1-5-1-1、查询缓存 title=1.5.1.1、查询缓存></a>1.5.1.1、查询缓存</h4><p>如果发现了要加工执行的 SQL 语句已经存在于查询缓存中，则会直接将结果返回给客户端；如果没有，则继续走SQL解析、处理等流程。<p>只要表结构或数据被修改（INSERT 、 UPDATE 、 DELETE 、 TRUNCATE TABLE 、 ALTER TABLE 、 DROP TABLE 或 DROP DATABASE），则该表涉及的所有高速缓存都将失效且被清空！对于更新压力大的数据库来说，查询缓存的命中率会非常低。<p><strong>因为查询缓存效率不高，所以 MySQL8.0 后废弃了查询缓存</strong>。<h4 id=1-5-1-2、解析器><a class=headerlink href=#1-5-1-2、解析器 title=1.5.1.2、解析器></a>1.5.1.2、解析器</h4><p><strong>在解析器中对SQL语句 执行 语法分析、语义分析</strong>。<p>分析器<em><strong>先做“ 词法分析 ”</strong></em>。你输入的是由多个字符串和空格组成的一条 SQL 语句，MySQL 需要识别出里面的字符串分别是什么，代表什么。 MySQL 从你输入的”select”这个关键字识别出来，这是一个查询语句。它也要把字符串“T”识别成“表名 T”，把字符串“ID”识别成“列 ID”。<p>然后<em><strong>再做“ 语法分析 ”</strong></em>。根据词法分析的结果，语法分析器（比如：Bison）会根据语法规则，判断你输 入的这个 SQL 语句是否 满足 MySQL 语法 。<h4 id=1-5-1-3、优化器><a class=headerlink href=#1-5-1-3、优化器 title=1.5.1.3、优化器></a>1.5.1.3、优化器</h4><p><strong>在优化器中会确定 SQL 执行路径，比如是否使用索引</strong>。<h4 id=1-5-1-4、执行器><a class=headerlink href=#1-5-1-4、执行器 title=1.5.1.4、执行器></a>1.5.1.4、执行器</h4><p><strong>执行前会先判断用户是否具备权限</strong> 。如果没有，会返回权限错误。如果具备权限，会执行SQL并返回结果。<p>MySQL8.0 前，如果设置了查询缓存，则会将查询结果缓存起来。<h4 id=总结><a class=headerlink href=#总结 title=总结></a>总结</h4><p>SQL执行流程：<strong>SQL语句 - 查询缓存 - 解析器 - 优化器 - 执行器</strong>。<p><img alt=image-20220410153913664 src=https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/06/image-20220410153913664.png><p>oracle执行流程：<p><img alt=image-20220410154843126 src=https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/06/image-20220410154843126.png><h3 id=1-5-2、MySQL8执行信息><a class=headerlink href=#1-5-2、MySQL8执行信息 title=1.5.2、MySQL8执行信息></a>1.5.2、MySQL8执行信息</h3><p><strong>（1）确认profiling 是否开启</strong><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line>select @@profiling;</span><br><span class=line>show variables like 'profiling';</span><br></pre></table></figure><p><strong>（2）多次执行相同SQL查询</strong><p><strong>（3）查看profiles</strong><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>show profiles; # 显示最近的几次查询</span><br></pre></table></figure><p><strong>（4）查看profile</strong><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>show profile;</span><br></pre></table></figure><h3 id=1-5-3、MySQL5-7执行信息><a class=headerlink href=#1-5-3、MySQL5-7执行信息 title=1.5.3、MySQL5.7执行信息></a>1.5.3、MySQL5.7执行信息</h3><p>（1）配置文件中开启查询缓存<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>query_cache_type=1</span><br></pre></table></figure><p>（2）重启MySQL服务<p>（3）开启查询执行计划<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>set profiling=1;</span><br></pre></table></figure><p>（4）执行语句<p>（5）查看profiles<p>（6）查看profile<h3 id=1-5-4、SQL语法顺序><a class=headerlink href=#1-5-4、SQL语法顺序 title=1.5.4、SQL语法顺序></a>1.5.4、SQL语法顺序</h3><p><img alt=image-20220410154740134 src=https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/06/image-20220410154740134.png><h2 id=1-6、增删改查><a class=headerlink href=#1-6、增删改查 title=1.6、增删改查></a>1.6、增删改查</h2><h3 id=1-6-1、增><a class=headerlink href=#1-6-1、增 title=1.6.1、增></a>1.6.1、增</h3><h3 id=1-6-4、查><a class=headerlink href=#1-6-4、查 title=1.6.4、查></a>1.6.4、查</h3><h4 id=1-6-4-1、子查询><a class=headerlink href=#1-6-4-1、子查询 title=1.6.4.1、子查询></a>1.6.4.1、子查询</h4><h5 id=子查询分类><a class=headerlink href=#子查询分类 title=子查询分类></a>子查询分类</h5><ul><li>根据内查询返回结果的条目数量来说，<strong>分为 单行子查询 和 多行子查询</strong>。<li>根据内查询是否被执行多次来说，<strong>分为：相关子查询 和 不相关子查询</strong>。</ul><h3 id=1-6-3、改><a class=headerlink href=#1-6-3、改 title=1.6.3、改></a>1.6.3、改</h3><h3 id=1-6-2、删><a class=headerlink href=#1-6-2、删 title=1.6.2、删></a>1.6.2、删</h3><h1 id=2、InnoDB存储引擎><a class=headerlink href=#2、InnoDB存储引擎 title=2、InnoDB存储引擎></a>2、InnoDB存储引擎</h1><h2 id=2-1、InnoDB体系架构><a class=headerlink href=#2-1、InnoDB体系架构 title=2.1、InnoDB体系架构></a>2.1、InnoDB体系架构</h2><h3 id=2-1-1、后台线程><a class=headerlink href=#2-1-1、后台线程 title=2.1.1、后台线程></a>2.1.1、后台线程</h3><ul><li><strong>Master Thread</strong>：将缓冲池中的数据异步刷新到磁盘，包括脏页刷新、合并插入缓冲、undo页回收<li><strong>IO Thread</strong>：InnoDB中用了大量AIO来处理IO请求，而IO Thread负责这些请求的回调处理。<li><strong>Purge Thread</strong>：事务提交后，undo log可能还会需要，故最终是否回收undo页由<code>puurge thread</code>决定。InnoDB 1.1前，purge操作在Master Thread中完成。1.1版本开始基于单独线程来完成。可在配置文件配置参数<code>innodb_purge_threads=1;</code> 来开启独立purge thread<li><strong>Page Cleaner Thread</strong>：InnoDB 1.2.x版本引入，将之前版本中的 脏页刷新 升级为 独立线程来完成，目的是减轻Master Thread工作、用户查询线程的阻塞。</ul><p><h3 id=2-1-2、内存><a class=headerlink href=#2-1-2、内存 title=2.1.2、内存></a>2.1.2、内存</h3><h4 id=缓冲池><a class=headerlink href=#缓冲池 title=缓冲池></a>缓冲池</h4><p>InnoDB引擎基于磁盘存储，其中的记录以页为单位来管理，故称之为基于磁盘的数据库系统。由于CPU和磁盘IO速度的巨大差异，故使用【缓冲池】来提高性能。<p><strong>数据库读取页时会先从磁盘读取，然后放入缓冲池</strong>，该过程称为将页“FIX”在缓冲池中。下次再读取时先判断缓冲池中是否存在，存在则称为“命中”，直接读取该页，否则就从磁盘读取。<p><strong>修改数据库页时，先修改缓冲池中的页，然后再通过<code>CheckPoint</code>机制刷新至磁盘（并非每次修改页都会刷新），这也是为了提高数据库整体性能</strong>。<p>缓冲池中页的种类有：索引页、数据页、undo页、插入缓冲、自适应哈希索引、InnoDB存储的锁信息、数据字典信息等。<p><strong>从InnoDB 1.0.x版本开始，允许有多个缓冲池实例，每个页可通过哈希映射到不同的缓冲池实例中</strong>。其可以通过参数<code>innodb_buffer_pool_instances</code>进行配置，默认为1。查看缓冲状态可以通过命令：<code>SHOW ENGINE INNODB STATUS</code>来实现，MySQL5.6开始，可通过表<code>INNODB_BUFFER_POOL_STATUS</code>来观察。<h4 id=LRU-List、Free-List、Flush-List><a title="LRU List、Free List、Flush List" class=headerlink href=#LRU-List、Free-List、Flush-List></a>LRU List、Free List、Flush List</h4><p><strong>数据库缓冲池基于LRU（最近最少使用）算法来管理</strong>。频繁使用的数据会放在LRU列表前端，最少使用的放在列表末端，当缓冲池空闲容量不足以缓冲新数据时，会抛弃释放掉列表末端的页。<p><strong>InnoDB缓冲池中页的大小为16KB，要注意的是，这里的LRU算法是在原算法基础上做了优化</strong>。LRU列表中加入了midpoint位置（默认列表5/8位置），新读取的页放在midpoint位置，该算法在InnoDB下称为“midpoint insertion strategy”。midpoint位置可通过参数<code>innodb_old_blocks_pct</code>来设置，M以SQL8默认值为 37。<p>为何不将新读取的页放在LRU列表前端呢？因为某些SQL操作会使得缓冲池中的页被刷新出去。为解决该问题，引入一个参数<code>innodb_old_blocks_time</code>来管理LRU列表，该参数表示读取页到mid位置后需要多久才会被加入到LRU列表前端（频繁使用，热端）。<p><strong>数据库刚启动时，LRU列表是空的，此时页都被放在Free列表中。当要从缓冲池中分页时，先从Free列表中查找是否有可用页，若有则将该页复制一份放至LRU列表并将原页删除</strong>。页从LRU列表的old部分加入到new部分时，称之为“page made young”。因为参数”innodb_old_blocks_time”原因导致页没有从old部分加入到new部分的操作称为“page not made young”。可以通过命令<code>SHOW ENGINE INNODB STATUS</code>来观察LRU列表和Free列表的情况。<p><strong>InnoDB1.0.x 开始支持【页压缩】功能，可将16K的页压缩至1、2、4、8KB，对于非16KB的页会通过unzip_LRU列表来管理</strong>。LRU中的页包括unzip_LRU列表中的页，unzip_LRU列表是通过伙伴算法为不同大小的页进行内存分配，分配内存时只能按照1、2、4、8KB的大小空间进行申请并存储。<p><strong>LRU列表中的页被修改后称为“脏页”，脏页需要通过CHECKPOINT机制刷新到磁盘</strong>。Flush列表是脏页列表，注意脏页既存在于LRU列表中，也存在于Flush列表中，LRU列表用于管理页的可用性，Flush列表用于将页刷新至磁盘，二者互不影响。<h4 id=重做日志缓冲><a class=headerlink href=#重做日志缓冲 title=重做日志缓冲></a>重做日志缓冲</h4><p><strong>InnoDB的内存除了缓冲池，还有重做日志缓冲。先将重做日志放至重做日志缓冲中，再按一定规则刷新至磁盘上的重做日志文件中</strong>。重做日志文件无需太大，只需满足每秒产生的日志数量即可。该值由参数<code>innodb_log_buffer_size</code>控制，MySQL5.7.33和MySQL 8中默认16M。<p>重做日志缓冲刷新到磁盘的三种情况：<ol><li>Master Thread <em><strong>每秒</strong></em> 将重做日志刷新至磁盘重做日志文件中。<li>每个<em><strong>事务提交时</strong></em>会将重做日志缓冲 刷新至 重做日志文件。<li>重做日志<em><strong>缓冲池空闲容量小于1/2时</strong></em>，会刷新至重做日志文件。</ol><h4 id=额外内存池><a class=headerlink href=#额外内存池 title=额外内存池></a>额外内存池</h4><p><strong>InnoDB通过内存堆方式来管理内存</strong>。在对一些数据结构本身进行内存分配时需要从额外内存池中申请，该内存不够时会从缓冲池中进行申请。分配了缓冲池，但每个缓冲池中的帧缓冲还有对应的缓冲控制对象，这些对象记录了LRU、锁、等待等信息，而这个对象也需要从额外内存池中申请，故应尽量增大该内存池容量。<h2 id=2-2、Checkpoint技术><a class=headerlink href=#2-2、Checkpoint技术 title=2.2、Checkpoint技术></a>2.2、Checkpoint技术</h2><p><strong>缓冲池的存在是为了协调CPU速度和磁盘速度的鸿沟</strong>。<p>页中记录被修改后，该页就被称为脏页。脏页需要从缓冲池被刷新到磁盘，磁盘刷新过程存在诸多问题，为解决这些问题，提出了<code>Write Ahead Log</code>策略，即事务提交时先写重做日志，再修改页。<p>InnoDB是通过LSN（Log Sequence Number）来标记版本。LSN通过8字节大小的数字来表示，单位为字节。每个页都有LSN，重做日志也有LSN，CheckPoint也有LSN。<h3 id=2-2-1、Checkpoint功能><a class=headerlink href=#2-2-1、Checkpoint功能 title=2.2.1、Checkpoint功能></a>2.2.1、Checkpoint功能</h3><ol><li><p><strong>缩短数据库的恢复时间</strong>。数据库宕机时，无需重做所有日志，因为checkpoint之前的页都已经刷新到磁盘，故只需对cp之后的重做日志进行恢复即可。</p><li><p><strong>缓冲池不够用时，刷新脏页到磁盘</strong>。缓冲池不够用时，根据LRU算法会溢出最近最少使用的页，若该页是脏页，那么需要强制执行Checkpoint，将脏页刷新到磁盘。</p><li><p><strong>重做日志不可用时，刷新脏页</strong>。重做日志是可以循环使用，而非无限增大。重做日志可以被重用的前提是该日志中内容已经刷新到磁盘，若此时重做日志还没有刷新到磁盘，那么就需要强制cp，将缓冲池的页至少刷新到当前重做日志的位置。</p></ol><h3 id=2-2-2、Checkpoint分类><a class=headerlink href=#2-2-2、Checkpoint分类 title=2.2.2、Checkpoint分类></a>2.2.2、Checkpoint分类</h3><ol><li><p><strong>Sharp Checkpoint</strong></p> <p><strong>数据库关闭时将所有脏页刷新到磁盘，这是默认方式，即参数 innodb_fast_shutdown=1</strong>。使用该check point会降低数据库的可用性，故InnoDB内部使用Fuzzy Checkpoint来刷新部分脏页，而非全部脏页。</p><li><p><strong>Fuzzy Checkpoint</strong></p> <p>InnoDB中可能发生的FCP情况：</p> <ol><li><p><strong>Master Thread CheckPoint</strong></p> <p>以每秒或者每十秒的速度<strong>异步</strong>从缓冲池脏页列表（Flush列表）中刷新一定比例的脏页到磁盘中。</p><li><p><strong>FLUSH_LRU_LIST CheckPoint</strong></p> <p>InnoDB要保证LRU列表中至少有100个空闲页可供使用，如果低于100个空闲页会清除LRU列表尾端的页，但如果尾端的页又是脏页那么就需要强制执行CheckPoint。</p> <p>从MySQL5.6开始，这个检查机制被放在单独的Page Cleaner线程中进行，可通过参数<code>innodb_lru_scan_depth</code>控制LRU列表中可用页的数量，默认值为1024。</p><li><p><strong>Async/Sync Flush CheckPoint</strong></p> <p><strong>重做日志不可用时要强制刷新部分脏页到磁盘，此时脏页是从脏页列表（Flush列表）中选取的</strong>。若已经写入到重做日志的LSN标记为 redo_lsn，已经刷新到磁盘最新页的LSN标记为checkpoint_lsn，则：</p> <p><code>checkpoint_age = redo_lsn - checkpoint_lsn</code>，再定义如下变量：</p> <figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line><span class=attr>async_water_mark</span> = <span class=string>75% * total_redo_log_file_size</span></span><br><span class=line><span class=attr>sync_water_mark</span> = <span class=string>90% * total_redo_log_file_size</span></span><br></pre></table></figure> <p>若每个重做日志文件大小为1G，且定义了两个重做日志，则重做日志总大小为2G，那么async_water_mark=1.5G，sync_water_mark=1.8G，则：</p> <ol><li>当checkpoint_age < async_water_mark时，不需要刷新任何脏页至磁盘；<li>当async_water_mark < checkpoint_age < sync_water_mark时触发 Async Flush，从Flush列表刷新足够的脏页至磁盘，使得刷新后满足 checkpoint_age < async_water_mark；<li>checkpoint_age > sync_water_mark的情况很难发生，除非重做日志文件太小，且进行类似 LOAD DATE的BULK INSERT 操作。此时触发Sync Flush操作，从Flush列表刷新足够的脏页至磁盘，使得刷新后满足 checkpoint_age < async_water_mark；</ol></ol><li><p>脏页太多导致 CheckPoint</p> <p><strong>脏页数量太多，导致 InnoDB强制进行 CheckPoint，其目的是为了保证缓冲池中有足够可用的页</strong>。其可由参数<code>innodb_max_dirty_pages_pct</code>控制，该值表示当缓冲池中脏页数量占据总量的百分比，当达到这个值时，就执行Checkpoint操作。InnoDB 1.0.x之前，默认值为90，之后版本都为75。</p></ol><h2 id=2-3、InnoDB关键特性><a class=headerlink href=#2-3、InnoDB关键特性 title=2.3、InnoDB关键特性></a>2.3、InnoDB关键特性</h2><h3 id=2-3-1、插入缓冲><a class=headerlink href=#2-3-1、插入缓冲 title=2.3.1、插入缓冲></a>2.3.1、插入缓冲</h3><h4 id=Insert-Buffer><a title="Insert Buffer" class=headerlink href=#Insert-Buffer></a>Insert Buffer</h4><p>插入缓冲区是InnoDB引擎的一项优化技术。当使用辅助索引插入新记录时，会先将新记录写入插入缓冲区而并非直接写入磁盘。<p>插入缓冲区可以减少随机磁盘写入的数量，提高插入性能。在特定情况下，会将插入缓冲区中的数据刷新到对应的辅助索引页中。<p>使用 插入缓冲 需要满足两个条件：<ol><li><p><strong>索引是辅助索引</strong>；</p><li><p><strong>索引不是唯一的</strong>；</p> <p>因为使用唯一索引会导致在插入缓冲时查找索引页来判断插入记录的唯一性，导致离散读取，Insert Buffer也将失去意义。</p></ol><p>Insert Bufffer存在一个问题：写密集环境下，插入缓冲会占用大量缓冲池内存，默认最大可占用1/2的缓冲池。<h4 id=Change-Buffer><a title="Change Buffer" class=headerlink href=#Change-Buffer></a>Change Buffer</h4><p><strong>InnoDB 1.0.x 开始引入 Change Buffer，可视为 Insert Buffer 升级版</strong>。InnoDB可以对DML操作都进行缓冲，它们分别是：Insert Buffer、Delete Buffer、Purge Buffer。<p>Update操作可分为两个过程：<ol><li><strong>将记录标记为删除</strong>；<li><strong>真正将记录删除</strong>；</ol><p><strong>Delete Buffer对应Update操作的第一个过程，Purge Buffer对应Update操作的第二个过程</strong>。<p>InnoDB提供参数<code>innodb_change_buffering</code>来开启各种Buffer选项，该参数可选值有：inserts、deletes、purges、changes、all、none，<strong>默认值为all</strong>。其中inserts、deletes、purges表示三种情况。changes表示inserts和deletes，all表示所有，none表示都不启用。<p>InnoDB 1.2.x开始可通过参数<code>innodb_change_buffer_max_size</code>来控制Change Buffer最大可用内存比例。<strong>默认25，表示最多可以使用1/4大小的缓冲池内存，该参数最大有效值为50</strong>。<h4 id=Insert-Buffer内部实现><a title="Insert Buffer内部实现" class=headerlink href=#Insert-Buffer内部实现></a>Insert Buffer内部实现</h4><p><strong>Innsert Buffer数据结构是一颗B+树，由 叶节点 和 非叶节点 组成。MySQL 4.1前每张表有一颗 Insert Buffer B+树，后续版本，全局只有一颗 Insert Buffer B+树，负责对所有表的辅助索引进行 Insert Buffer</strong>。该B+树存放于共享表空间中，默认就在<code>ibdate1</code>中。因此通过独立表空间ibd文件恢复表中数据时往往会导致Check TABLE失败，所以通过ibd恢复后，还需通过REPAIR TABLE操作来重建表上所有的辅助索引。<h4 id=Merge-Insert-Buffer><a title="Merge Insert Buffer" class=headerlink href=#Merge-Insert-Buffer></a>Merge Insert Buffer</h4><p>Merge Insert Buffer操作发生于以下几种情况：<ol><li>辅助索引页 被读取至 缓冲池 中；<li>Insert Buffer Bitmap页 追踪到该辅助索引页 已无可用空间时；<li>Master Thread；</ol><h3 id=2-3-2、两次写><a class=headerlink href=#2-3-2、两次写 title=2.3.2、两次写></a>2.3.2、两次写</h3><p>InnoDB引擎下，数据存储在页中，页通常大小为16KB。当进行数据写入操作时，通常先将数据写入到内存中的缓冲区中，然后再异步将缓冲区的数据刷新到磁盘上的文件中。数据在被刷新到磁盘前，发生了系统崩溃或其它异常情况，那么可能导致数据写入不完整或被损坏。<p>为了保证数据的完整性和持久性，InnoDB引擎引入了“两次写”技术。两次写的原理是：<strong>当进行数据写入操作时，先将数据写入到一个 double write buffer 的缓冲区中，该缓冲区大小与页大小相同（通常16KB）。然后将该缓冲区中的数据同时写到磁盘上的两个不同位置，这样即使其中一个出现异常导致不可用，那么另一个作为备份也可以继续使用</strong>。<p>在系统崩溃或重新启动后，InnoDB需要进行数据恢复，以确保数据的一致性和完整性。恢复过程中，首先检查数据文件中的页和 double write buffer 中的数据是否一致。如果某个页上的数据不完整，InnoDB可以从另一个备份中获取正确数据，从而恢复其数据，保证其完整一致。<p>其实，两次写说的是——利用 重做日志 来恢复数据前，用户需要一个页的副本，当写入失效发生时，先通过副本还原该页，再进行重做，这就是两次写。<p>两次写由两部分组成，一部分是内存中doublewrite buffer，大小为2m；另一个是物理磁盘上共享表空间中连续的128个页，即2个区，大小同样为2m。<p>缓冲池脏页刷新过程：<ol><li>通过<code>memcpy</code>函数 先将脏页 复制到 内存中的<code>double write buffer</code>。<li>dwb分两次，每次1m顺序写入共享表空间的物理磁盘上，严格来说是先到 PageCache 中。<li>马上调用 fsync 函数同步到磁盘，避免缓冲写带来的问题。</ol><h3 id=2-3-3、自适应哈希索引><a class=headerlink href=#2-3-3、自适应哈希索引 title=2.3.3、自适应哈希索引></a>2.3.3、自适应哈希索引</h3><p><strong>自适应索引查找时间复杂度一般为O(1)。InnoDB引擎会监控对表上各索引页的查询，如果发现建立哈希索引会有速度提升，那么会自动建立哈希索引，称之为自适应哈希索引（Adaptive Hash Index，AHI），这个判断并创建的过程用户无法干预</strong>。<p>AHI 通过缓冲池的 B+ 树页构造而来，因此建立速度非常快，且不需要对整张表构建哈希索引。InnoDB引擎会根据访问的频率和模式自动建立哈希索引。<p>AHI要求：对页的连续访问模式必须是一样的；以该模式访问了100次。**页通过该模式被访问了N次，其中N = (页中记录数量/16)**。<blockquote><p>访问模式是指：查询条件一样，若交替执行两种查询，且次数也达到了100次，那么也不会构建AHI。</blockquote><p>自适应哈希索引存在如下特点：<ul><li>InnoDB引擎自动创建，无需手动干预。<li>一个索引键被频繁访问时，会将该键会对应的物理位置添加到哈希索引中，加速其查询。<li>不会占用磁盘空间，只在内存中维护。</ul><h3 id=2-3-4、异步IO><a class=headerlink href=#2-3-4、异步IO title=2.3.4、异步IO></a>2.3.4、异步IO</h3><p>MySQL中，<strong>InnoDB引擎使用了异步IO来进行IO操作，进一步提升了读写效率</strong>。<p>mysql 5.5之前，异步IO默认关闭，需要手动开启。<strong>mysql 5.5开始，异步IO默认开启</strong>，可通过配置文件进行调整。<h4 id=AIO优点><a class=headerlink href=#AIO优点 title=AIO优点></a>AIO优点</h4><ol><li>发出一个IO请求后，可以再次发送另一个IO请求，当全部发送完毕，等待IO请求完成即可。<li>可以进行IO Merge操作，即将多个IO合并为一个IO，这提高了IOPS的性能。</ol><h3 id=2-3-5、刷新邻接页><a class=headerlink href=#2-3-5、刷新邻接页 title=2.3.5、刷新邻接页></a>2.3.5、刷新邻接页</h3><h4 id=工作原理><a class=headerlink href=#工作原理 title=工作原理></a>工作原理</h4><p><strong>当刷新一个脏页时，InnoDB引擎会检测该页所在区的所有页，如果这些页中也有脏页那么会将它们一起刷新</strong>。<blockquote><p>InnoDB1.2.x提供了参数 <code>innodb_flush_neighbors</code>来控制是否开启该特性。对于机械硬盘建议开启，对于有较高IOPS的固态硬盘建议关闭。</blockquote><h2 id=2-4、启动、关闭与恢复><a class=headerlink href=#2-4、启动、关闭与恢复 title=2.4、启动、关闭与恢复></a>2.4、启动、关闭与恢复</h2><p>服务关闭时，参数<code>innodb_fast_shutdown</code>影响着InnoDB的行为，该参数可取值为0、1、2，默认为1。<ul><li>0：数据库关闭时，InnoDB需要<strong>完成所有的<code>full purge</code>和<code>merge insert buffer</code><strong>，该过程时间很长，可能长达几个小时，</strong>并将所有脏页刷新到磁盘</strong>。（InnoDB升级时，必须将该参数置为0，然后再关闭数据库。）<li>1：参数默认值，不需要完成<code>full purge</code>和<code>merge insert buffer</code>操作，但<strong>缓冲池中的脏页会刷新到磁盘</strong>。<li>2：不完成<code>full purge</code>和<code>merge insert buffer</code>操作，也不将缓冲池中的脏页刷新至磁盘，而是<strong>将日志都写入日志文件</strong>。下次数据库启动时，会进行恢复操作。</ul><p><strong>参数<code>innodb_force_recovery</code>影响整个InnoDB引擎恢复的情况</strong>。该参数值有7个：0~6，分别代表不同意思：<ul><li>0：需要恢复时会执行所有的恢复操作；当不能进行有效恢复且发生错误时，会把错误写入错误日志中。<li>1：忽略检查到的corrupt页；<li>2：阻止Master Thread线程运行，如MT需要进行full purge操作，而这会导致崩溃。<li>3：不进行事务的回滚操作；<li>4：不进行插入缓冲的合并操作；<li>5：不查看撤销日志，InnoDB引擎会将未提交的事务视为已提交；<li>6：不进行前滚操作；</ul><h1 id=3、文件><a class=headerlink href=#3、文件 title=3、文件></a>3、文件</h1><p>构成MySQL数据库和InnoDB引擎表的各种类型文件有：<ol><li><p><strong>参数文件</strong>：告诉MySQL启动时从哪获取数据库文件，并初始化一些参数。</p><li><p><strong>日志文件</strong>：记录MySQL对某种条件做出响应时写入的文件，如错误日志文件、二进制日志文件、慢查询日志、查询日志文件等。</p><li><p><strong>socket文件</strong>：当用 UNIX域套接字方式进行连接时需要的文件。</p><li><p><strong>pid文件</strong>：MySQL实例的进程ID文件。</p><li><p><strong>MySQL表结构文件</strong>：存放MySQL表结构定义文件。</p><li><p><strong>存储引擎文件</strong>：每个存储引擎都会有自己的文件来保存各种数据。存储引擎记录了记录和索引数据。</p></ol><h2 id=3-1、参数文件><a class=headerlink href=#3-1、参数文件 title=3.1、参数文件></a>3.1、参数文件</h2><p><strong>MySQL启动时会先读取配置文件来做相关初始化</strong>。<p>Oracle实例启动时找不到参数文件会无法启动装载，而MySQL实例启动时可以不需要参数文件，此时所有参数使用默认值。<p>mysql结构中记录了访问该实例的权限，如果找不到该架构，则实例无法启动成功。<h3 id=3-1-1、参数定义><a class=headerlink href=#3-1-1、参数定义 title=3.1.1、参数定义></a>3.1.1、参数定义</h3><p>简单说，可以把数据库参数看成一个键/值对。<h3 id=3-1-2、参数类型><a class=headerlink href=#3-1-2、参数类型 title=3.1.2、参数类型></a>3.1.2、参数类型</h3><p>参数可分为两类：<ol><li><p><strong>动态参数</strong>：可以在实例运行中进行修改。更改可通过 SET命令 实现，SET语法如下：</p> <figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line><span class=attr>set</span> <span class=string></span></span><br><span class=line><span class=attr>|</span> <span class=string>[global | session] system_var_name=expr</span></span><br><span class=line><span class=attr>|</span> <span class=string>[@@global. | @@session. | @@] system_var_name=expr</span></span><br></pre></table></figure><li><p><strong>静态参数</strong>：整个实例生命周期内都不得进行更改。</p></ol><h2 id=3-2、日志文件><a class=headerlink href=#3-2、日志文件 title=3.2、日志文件></a>3.2、日志文件</h2><p>常见日志文件有：<ol><li><strong>错误日志</strong><li><strong>查询日志</strong><li><strong>慢查询日志</strong><li><strong>二进制日志</strong><li><strong>中继日志（MySQL8）</strong><li><strong>数据定义语句日志（MySQL8）</strong></ol><h3 id=3-2-1、错误日志><a class=headerlink href=#3-2-1、错误日志 title=3.2.1、错误日志></a>3.2.1、错误日志</h3><p>错误日志记录了MySQL服务器在启动、运行、关闭过程中的所有错误信息。<h3 id=3-2-2、查询日志><a class=headerlink href=#3-2-2、查询日志 title=3.2.2、查询日志></a>3.2.2、查询日志</h3><p>查询日志记录了MySQL服务器收到的所有查询请求，默认文件名为：<code>主机名.log</code>。<strong>开启查询日志会对性能产生影响，因此通常只在调试时开启</strong>。<h3 id=3-2-3、慢查询日志><a class=headerlink href=#3-2-3、慢查询日志 title=3.2.3、慢查询日志></a>3.2.3、慢查询日志</h3><p>慢查询日志记录了执行时间超过设定阈值的查询请求。这个阈值可以通过参数<code>long_query_time</code>来设置，默认为10秒。<p>有两点需要注意：<ol><li><strong>阈值设置后，只会记录查询耗时超过该阈值的 SQL，等于的不会被记录</strong>。<li><strong>MySQL 5.1开始，该参数以 微妙 为单位记录SQL语句运行时间</strong>。</ol><p>相关参数：<ol><li><strong>log_queries_not_using_indexes</strong>：可选值为OFF/ON，ON代表当前SQL没有使用索引时也会被记录到慢查询日志，OFF则相反。<li><strong>log_throttle_queries_not_using_indexes</strong>：MySQL 5.6.5 开始支持，表示每分钟可以记录未使用索引的慢SQL数量，默认值为0。</ol><p><strong>注意：MySQL 5.1 开始可以将慢查询日志放入一个表中，该表在mysql架构下，名为slow_log。</strong><h3 id=3-2-4、二进制日志><a class=headerlink href=#3-2-4、二进制日志 title=3.2.4、二进制日志></a>3.2.4、二进制日志</h3><h4 id=简介-1><a class=headerlink href=#简介-1 title=简介></a>简介</h4><p><strong>二进制日志记录了MySQL数据库的所有修改操作，但不包括 SELECT、SHOW 该类操作</strong>。若操作本身并没有导致数据库发生变化，那么该操作可能也会写入到二进制日志（比如年龄为25，修改后依然是25，则也会被写入到日志）。<p>MySQL创建二进制日志文件时，先创建一个以“filename”为名称、以“.index”为后缀的文件，再创建一 个以“filename”为名称、以“.000001”为后缀的文件。<p>MySQL服务每重启一次 ，以“.000001”为后缀的文件就会增加一个，且后缀名以1递增。即日志文件的 个数与MySQL服务启动次数相同；如果日志长度超过了参数<code>max_binlog_size</code>值（默认是1GB），就会创建一个新日志文件。<p>二进制日志主要作用：<ol><li><p><strong>恢复</strong>：某些数据的恢复需要二进制日志。</p><li><p><strong>复制</strong>：其原理和恢复类似，通过复制和执行二进制日志可以使一台远程的MySQL数据库（一般为slave或standby）与一台MySQL数据库（一般为master或primary）进行实时同步。</p><li><p><strong>审计</strong>：可通过二进制日志中的信息来进行审计，判断是否有对数据库进行注入的攻击行为。</p></ol><h4 id=底层实现><a class=headerlink href=#底层实现 title=底层实现></a>底层实现</h4><h5 id=binlog-cache><a title="binlog cache" class=headerlink href=#binlog-cache></a>binlog cache</h5><p><strong>事务执行过程中，先把日志写到<code>binlog cache</code> ，事务提交时再把<code>binlog cache</code>中的数据写入<code>binlog</code>文件</strong>。因为一个事务的<code>binlog</code>不能被拆开，无论这个事务多大也要确保一次性写入，所以系统会给每个线程分配一个块内存作为<code>binlog cache</code>。<h5 id=write-fsync><a class=headerlink href=#write-fsync title=write/fsync></a>write/fsync</h5><p>write 和 fsync 的执行时间由参数<code>sync_binlog</code>控制，默认0。参数值为0表示每次提交事务仅仅执行write，后面则由系统自行判断何时执行fsync。<strong>参数值设置为1表示每次提交事务都会执行fsync</strong>。参数值设为N（N>1）表示每次提交事务都执行write，但累积N个事务后才执行fsync。<p><strong>将<code>sync_binlog</code>设置为一个较大值可提升性能。但如果机器宕机，也会丢失最近N个事务的binlog日志</strong>。<h5 id=两阶段提交><a class=headerlink href=#两阶段提交 title=两阶段提交></a>两阶段提交</h5><p>执行更新语句的过程中会记录 redo log 与 bin log 两块日志，以基本的事务为单位，redo log在事务执行过程中可以不断写入，而binlog只有在提交事务时才写入，所以 redo log 与 bin log 写入时机不一样。<p><strong>redo log 与 binlog 逻辑不一致会出现问题，为解决该问题使用了两阶段提交方案</strong>。<p>两阶段提交图示如下：</p><img src=https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/06/binlog%E4%B8%8Eredo%E4%B8%A4%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4%E5%9B%BE%E7%A4%BA1.png style=zoom:80%;><p>使用两阶段提交后，写入<code>binlog</code>时发生异常不会损失太大，因为有事务回滚存在。<code>redo log</code>设置<code>commit</code>阶段发生异常时并不会回滚事务，因为虽然<code>redo log</code>是处于<code>prepare</code>阶段，但能通过事务id找到对应的<code>binlog</code>日志，所以MySQL认为是完整的，就会提交事务恢复数据。<p>具体处理流程参考下图：<p><img src=https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/06/binlog%E4%B8%8Eredo%E4%B8%A4%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4%E4%B8%ADredo%E6%8F%90%E4%BA%A4%E9%98%B6%E6%AE%B5%E5%87%BA%E9%94%99%E6%97%B6%E4%B8%8D%E4%BC%9A%E5%9B%9E%E6%BB%9A.png><h4 id=开启二进制日志><a class=headerlink href=#开启二进制日志 title=开启二进制日志></a>开启二进制日志</h4><p><strong>MySQL 8 之前默认没有启用二进制日志文件，MySQL 8 中默认启用了二进制文件</strong>。<p><strong>开启二进制日志会降低性能，但可以使用复制、point-in-time恢复功能</strong>。<h5 id=永久性设置><a class=headerlink href=#永久性设置 title=永久性设置></a>永久性设置</h5><p>若要永久性开启二进制日志功能，可以在 my.cnf 或 my.ini 文件中配置如下参数：<figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line><span class=attr>log-bin</span>=<span class=string>shh-binlog</span></span><br><span class=line><span class=attr>binlog_expire_logs_seconds</span>=<span class=string>600</span></span><br><span class=line><span class=attr>max_binlog_size</span>=<span class=string>100M</span></span><br></pre></table></figure><p><strong>设置参数 log-bin=name 可以启动二进制日志，如果不指定name，则默认为主机名，后缀名为二进制日志序列号，路径一般是数据库所在目录</strong>（datadir）。<p>binlog.index 为二进制索引文件，用来存储产生的二进制序号，通常不建议手工修改该文件。<h5 id=二进制日志设置><a class=headerlink href=#二进制日志设置 title=二进制日志设置></a>二进制日志设置</h5><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre><td class=code><pre><span class=line><span class=comment># global 级别</span></span><br><span class=line>mysql> <span class=built_in>set</span> global sql_log_bin=0;</span><br><span class=line>ERROR 1228 (HY000): Variable <span class=string>'sql_log_bin'</span> is a SESSION variable and can`t be used</span><br><span class=line>with SET GLOBAL</span><br><span class=line></span><br><span class=line><span class=comment># session级别</span></span><br><span class=line>mysql> SET sql_log_bin=0;</span><br><span class=line>Query OK, 0 rows affected (0.01 秒)</span><br></pre></table></figure><h4 id=常用参数><a class=headerlink href=#常用参数 title=常用参数></a>常用参数</h4><p>二进制日志常用参数有：<ol><li><p><strong>max_binlog_size</strong></p> <p>单个二进制日志文件的最大值，超过该值则会生成新的文件，后缀名+1，并记录到<code>.index</code>文件。从MySQL 5.0开始，<em><strong>默认值为1073 741 824，即1G</strong></em>（之前的版本默认1.1G）。</p><li><p><strong>binlog_cache_size</strong></p> <p>当使用支持事务的表存储引擎时，所有未提交的二进制日志会被记录到一个缓存中，等事务提交时直接将缓冲中的二进制日志写入到二进制文件，该缓冲的大小由参数<code>binlog_cache_size</code>决定，<em><strong>默认大小为 32K（MySQL5.7版本）</strong></em>。</p> <p>该参数是基于会话的，当开始一个事务时就会自动分配一个大小为该参数指定值的缓存，故设置该值时要小心。当一个事务的记录大于该参数指定的值，会把缓冲中的日志写入到一个临时文件中，因此该值也不能设置的太小。那如何选择呢？可以通过命令<code>SHOW GLOBAL STATUS</code>命令查看 ``binlog_cache_use<code>(使用缓冲写二进制的次数)、</code>binlog_cache_disk_use`（使用临时文件写二进制的次数）的状态，通过其状态来判断设置为多少合适。</p><li><p><strong>sync_binlog</strong></p> <p>二进制日志并非每次写完缓存就同步到磁盘，那么具体写入缓冲几次后再同步到磁盘由该参数<code>sync_binlog</code>决定，参数值为1表示采用同步写二进制日志。该参数默认值为0。如果使用InnoDB进行复制，且想得到最大的高可用性，<em><strong>建议将该值设置为0</strong></em>。</p><li><p><strong>binlog-do-db</strong></p> <p>表示需要写入或忽略写入哪些库的日志，默认为空，表示需要同步所有库的日志到二进制日志。</p><li><p><strong>binlog-ignore-db</strong></p> <p>表示需要写入或忽略写入哪些库的日志，默认为空，表示需要同步所有库的日志到二进制日志。</p><li><p><strong>log-slave-update</strong></p> <p>如果当前数据库是复制中的slave角色，则它不会把从master取得的二进制日志写入到自己的二进制日志中去。如果需要写入，则要设置该参数即<code>log-slave-update</code>。如果需要搭建master -> slave -> slave架构的复制，则必须设置该参数。</p><li><p><strong>binlog_format</strong>（动态参数）</p> <p>它会影响记录二进制日志的格式。MySQL 5.1版本前没有这个参数，所有二进制文件的格式都是基于SQL语句级别的，主服务器运行rand、uuid等函数，又或者使用触发器等操作，其会导致主从服务器上表中数据的不一致。另一个影响是，会发现InnoDB引擎的默认事务隔离级别是REPEATABLE READ。如果使用 READ COMMITTED事务隔离级别，会出现丢失更新的现象，从而导致主从数据库上的数据不一致。</p> <p>MySQL 5.1 开始引入<code>binlog_format</code>参数，该参数可选值有：</p> <ol><li><p><strong>STATEMENT</strong></p> <p>该格式和之前的MySQL版本一样，记录的是逻辑SQL语句。</p><li><p><strong>ROW</strong></p> <p>记录表的行更改情况。基于ROW格式的复制类似于Oracle的Standby，同时解决了STATEMENT格式下复制的问题。MySQL 5.1开始，如果设置了该格式，可以将InnoDB的事务隔离级别设置为 READ COMMITTED，以获得更好的并发性。（查看隔离级别命令：<code>select @@global.transaction_isolation,@@transaction_isolation;</code>）</p><li><p><strong>MIXED</strong></p> <p>默认采用STATEMENT格式进行二进制日志文件的记录，但在一些情况下会使用ROW格式，这些情况有：</p> <ol><li>表存储引擎为NDB，此时对表的DML操作都会以ROW格式记录。<li>使用了UUID()、USER()、CURRENT_USER()、FOUND_ROWS()、ROW_COUNT()等不确定函数。<li>使用了INSERT DELAY语句。<li>使用了用户自定义函数（UDF）。<li>使用了临时表（temporary table）。</ol></ol> <p>此外，<code>binlog_format</code>参数还存在对存储引擎的限制：</p> <ul><li>STATEMENT格式：除了NDB引擎，其它都支持。<li>ROW格式：除了Blockhole引擎，其它都支持。</ul></ol><h4 id=查看日志><a class=headerlink href=#查看日志 title=查看日志></a>查看日志</h4><p>（1）查看当前的二进制日志文件列表及大小：<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>SHOW BINARY LOGS;</span><br></pre></table></figure><p>（2）将行事件以 伪SQL形式 表现出来：<figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line><span class=comment># 会显示binlog格式的语句</span></span><br><span class=line>mysqlbinlog -v <span class=string>"/var/lib/mysql/binlog/atguigu-bin.000002"</span></span><br><span class=line><span class=comment># 不会显示binlog格式的语句</span></span><br><span class=line>mysqlbinlog -v --base64-output=DECODE-ROWS <span class=string>"/var/lib/mysql/binlog/atguigu-bin.000002"</span></span><br></pre></table></figure><p>（3）其它命令<figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line><span class=comment># 格式：show binlog events [IN 'log_name'] [FROM pos] [LIMIT [offset,] row_count];</span></span><br><span class=line>show binlog events <span class=keyword>in</span> <span class=string>'atguigu-bin.000002'</span>;</span><br></pre></table></figure><p>二进制日志有 3 种格式：ROW（默认）、Statement、Mixed。<p>查看二进制日志格式命令：<code>show variables like 'binlog_format';</code>。<h4 id=恢复数据><a class=headerlink href=#恢复数据 title=恢复数据></a>恢复数据</h4><p>mysql binlog 恢复数据的语法如下：<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>mysqlbinlog [option] filename | mysql –uuser -ppass;</span><br></pre></table></figure><p><strong>使用mysqlbinlog命令读取filename中的内容，然后使用mysql命令将这些内容恢复到数据库中</strong>。<p>命令解析：<ul><li>filename：日志文件名。<li>option：可选项，可选值中有两对重要的参数：<ul><li>–start-date 和 –stop-date ：可以指定恢复数据库的起始时间点和结束时间点。<li>–start-position和–stop-position ：可以指定恢复数据的开始位置和结束位置。</ul></ul><blockquote><p>注意：使用mysqlbinlog命令进行恢复操作时，必须是编号小的先恢复，例如atguigu-bin.000001必 须在atguigu-bin.000002之前恢复。</blockquote><h4 id=删除日志><a class=headerlink href=#删除日志 title=删除日志></a>删除日志</h4><p><strong>MySQL二进制文件可以通过配置自动删除，也可以手动删除二进制文件</strong>。<p><strong>PURGE MASTER LOGS 只删除指定部分的二进制日志文件， RESET MASTER 删除所有的二进制日志文件</strong>。<p>PURGE MASTER LOGS语法如下：<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line>PURGE {MASTER | BINARY} LOGS TO '指定日志文件名'</span><br><span class=line>PURGE {MASTER | BINARY} LOGS BEFORE '指定日期'</span><br></pre></table></figure><h3 id=3-2-5、中继日志><a class=headerlink href=#3-2-5、中继日志 title=3.2.5、中继日志></a>3.2.5、中继日志</h3><h4 id=简介-2><a class=headerlink href=#简介-2 title=简介></a>简介</h4><p><strong>MySQL 8 中引入中继日志，用于主从服务架构</strong>。<p>从服务器使用中继日志存放主服务器二进制日志内容，然后读取中继日志来同步主服务器上的操作。<p>文件格式是<code>从服务器名-relay-bin.序号</code>。中继日志索引文件格式：<code>从服务器名-relaybin.index</code>，用来定位当前正在使用的中继日志。<h4 id=查看日志-1><a class=headerlink href=#查看日志-1 title=查看日志></a>查看日志</h4><p>中继日志与二进制日志的格式相同，可以用 mysqlbinlog 工具进行查看。<h4 id=同步数据><a class=headerlink href=#同步数据 title=同步数据></a>同步数据</h4><p>中继日志记录了从服务器名，从服务器名与新服务器名不同会导致无法从中继日志中读取数据来恢复从服务器数据，故只要保证从服务器名与新服务器名相同即可实现数据恢复。<h3 id=3-2-6、数据定义语句日志><a class=headerlink href=#3-2-6、数据定义语句日志 title=3.2.6、数据定义语句日志></a>3.2.6、数据定义语句日志</h3><p><strong>MySQL 8 中引入数据定义语句日志，用来记录数据定义语句执行的元数据操作</strong>。<h2 id=3-3、套接字><a class=headerlink href=#3-3、套接字 title=3.3、套接字></a>3.3、套接字</h2><p>UNIX系统下本地连接MySQL可采用UNIX域套接字方式，只需要一个套接字文件。套接字文件可由参数socket控制，一般在<code>/tmp</code>目录下，名为 mysql.sock。<h2 id=3-4、PID文件><a class=headerlink href=#3-4、PID文件 title=3.4、PID文件></a>3.4、PID文件</h2><p>MySQL实例启动时，会将自己的进程ID写入一个文件中——该文件即为PID文件。该文件可由参数pid_file控制，默认存放在数据库目录下，文件名为：主机名.pid。<h2 id=3-5、表结构定义文件><a class=headerlink href=#3-5、表结构定义文件 title=3.5、表结构定义文件></a>3.5、表结构定义文件</h2><p>因为MySQL插件式存储引擎体系架构的关系，MySQL数据库是根据表进行的，每个表都有对应的文件。无论表采用何种存储引擎，都有一个以frm为后缀名的文件，这个文件记录了该表的表结构定义。<p>frm还用来存储视图的定义，如果创建一个v_a视图，那么会对应产生一个v_a.frm文件，用来记录视图定义，该文件是文本文件，可直接查看。<h2 id=3-6、InnoDB存储引擎文件><a class=headerlink href=#3-6、InnoDB存储引擎文件 title=3.6、InnoDB存储引擎文件></a>3.6、InnoDB存储引擎文件</h2><p><strong>每个表存储引擎都有自己独有的文件，这些文件包括重做日志文件、表空间文件</strong>。<h3 id=3-6-1、表空间文件><a class=headerlink href=#3-6-1、表空间文件 title=3.6.1、表空间文件></a>3.6.1、表空间文件</h3><p><strong>InnoDB将存储的数据按表空间进行存放，默认有一个初始大小为12M，名为 ibdata1的文件，该文件就是默认表空间文件，可通过参数<code>innodb_data_file_path</code>进行配置</strong>。<p><strong>可配置将多个文件组成一个表空间，同时指定文件属性</strong>，命令示例如下：<figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line><span class=attr>innodb_data_file_path</span> = <span class=string>/db/ibdata1:2000M;/dir2/db/ibdata2:2000M:autoextend</span></span><br></pre></table></figure><p>如果指定的两个文件位于不同的磁盘上，磁盘的负载可能被平均，进而提高数据库的整体性能。同时，两个文件都有指定大小为2000M，如果用完这2000M，则该文件可以自动增长（autoextend）。<p>参数<code>innodb_data_file_path</code>会导致所有InnoDB表的数据都会记录到该共享表空间中。若设置参数<code>innodb_file_per_table</code>的值为ON，则用户可以基于InnoDB每个表生成一个独立表空间，独立表空间命名规则为：表名.ibd。<h3 id=3-6-2、重做日志文件><a class=headerlink href=#3-6-2、重做日志文件 title=3.6.2、重做日志文件></a>3.6.2、重做日志文件</h3><h4 id=重做日志简介><a class=headerlink href=#重做日志简介 title=重做日志简介></a>重做日志简介</h4><p><strong>默认情况下，InnoDB引擎数据目录下会有两个名为<code>ib_logfile0</code>和<code>ib_logfile1</code>的文件。官方称之为InnoDB引擎日志文件，不过更准确的定义应该是重做日志文件</strong>。重做日志文件对于InnoDB引擎极其重要，它记录了InnoDB的事务日志。<h4 id=重做日志文件组><a class=headerlink href=#重做日志文件组 title=重做日志文件组></a>重做日志文件组</h4><p><strong>每个InnoDB至少有1个重做日志文件组，每个文件组至少有2个重做日志文件，比如默认的 ib_logfile0 和 ib_logfile1</strong>。为提高可靠性，可以设置多个镜像日志组，将不同的文件组放在不同的磁盘上，以此提高重做日志的高可用性。日志组中的两个文件大小一致，并以循环写入的方式运行，即 先写文件1，写满后会切换到文件2，文件2写满后再切换到文件1。<h4 id=重做日志相关参数><a class=headerlink href=#重做日志相关参数 title=重做日志相关参数></a>重做日志相关参数</h4><p>下列参数影响着重做日志文件的属性：<ol><li><p><strong>innodb_log_file_size</strong>：每个重做日志文件的大小，MySQL 8.0.22下默认48M（MySQL5.7.33相同）。InnoDB 1.2.X之前，文件总大小不得大于等于4G，而1.2.x将其限制扩大为512G。</p><li><p><strong>innodb_log_files_in_group</strong>：文件组中文件的数量，默认为2。</p><li><p><strong>innodb_mirrored_log_groups</strong>：日志镜像文件组的数量，默认为1。如果磁盘本身已经做了高可用方案，如磁盘阵列，则可不开启该功能。</p><li><p><strong>innodb_log_group_home_dir</strong>：文件组所在路径默认为 / ，表示MySQL数据库的数据目录。</p></ol><p>重做日志文件的大小设置会对InnoDB引擎的性能有很大影响：<ul><li>如果很大，恢复时会需要很长时间；<li>如果很小，可能导致一个事务的日志需要多次切换重做日志文件；此外会导致频繁发生 async checkpoint，出现性能抖动。</ul><p>重做日志文件还有一个capacity变量，该值代表最后的检查点不能超过这个阈值，如果超过则必须将缓冲池中脏页列表（Flush List）中的部分脏页写回磁盘，此时会导致用户线程的阻塞。<h4 id=redo-log和bin-log的区别><a title="redo log和bin log的区别" class=headerlink href=#redo-log和bin-log的区别></a>redo log和bin log的区别</h4><ol><li><p><strong>记录范围</strong></p> <p>二进制日志会记录所有与MySQL数据库有关的日志记录，包括InnoDB、MyISAM、Heap等引擎的日志，不包括查询日志；</p> <p>重做日志只记录InnoDB引擎本身的事务日志。</p><li><p><strong>记录内容</strong></p> <p>无论二进制日志记录格式是STATEMENT，ROW，或是MIXED，记录的都是一个事务的具体操作内容，即该日志是逻辑日志。</p> <p>重做日志记录的是每个页更改的物理情况。</p><li><p><strong>写入时间</strong></p> <p>二进制日志在事务提交前进行提交，即只写磁盘一次，不论此时该事务有多大。</p> <p>事务进行过程中，会不断有重做日志条目被写入到重做日志文件中。</p></ol><h4 id=重做日志条目结构><a class=headerlink href=#重做日志条目结构 title=重做日志条目结构></a>重做日志条目结构</h4><p>InnoDB引擎中，不同的操作会有不同的重做日志格式，截止InnoDB 1.2.x版本为止，总共定义了51种重做日志类型。虽然类型多种多样，但有着基本的格式。重做日志条目结构由四部分组成：<ol><li><p><strong>redo_log_type</strong>：占用1字节，表示重做日志的类型。</p><li><p><strong>space</strong>：表示表空间的ID，但采用压缩方式，因此占用空间可能小于4字节。</p><li><p><strong>page_no</strong>：表示页的偏移量，同样采用压缩方式。</p><li><p><strong>redo_log_body</strong>：表示每个重做日志的数据部分，恢复时需要调用相应的函数进行解析。</p></ol><h4 id=重做日志缓冲写入><a class=headerlink href=#重做日志缓冲写入 title=重做日志缓冲写入></a>重做日志缓冲写入</h4><p><strong>缓冲是以 512 字节大小的块为单位进行写入，512字节是一个扇区的大小。因为扇区是磁盘写入最小单位，写入必定成功，故写入过程不需要 double write</strong>。<p>Master Thread每秒会将重做日志缓冲写入磁盘的日志文件中，无论事务是否提交。另一个触发写磁盘的过程由参数<code>innodb_flush_log_at_trx_commit</code>控制，表示事务提交时重做日志的刷新方式，该参数可选值有：<ul><li>0：事务提交时，并不将事务的重做日志写入磁盘，而是等待主线程每秒刷新。<li>1：事务提交时，将重做日志缓冲同步写入磁盘，即伴有fsync调用。<li>2：事务提交时，重做日志异步写入缓存，即写入文件系统缓存中（非磁盘）。</ul><p>因此为了保证事务ACID中的持久性，<strong>建议将该参数值设置为1</strong>。<h1 id=4、表><a class=headerlink href=#4、表 title=4、表></a>4、表</h1><h2 id=4-1、索引组织表><a class=headerlink href=#4-1、索引组织表 title=4.1、索引组织表></a>4.1、索引组织表</h2><p><strong>InnoDB引擎中表是根据主键顺序组织存放，该种组织方式的表被称为索引组织表</strong>。InnoDB引擎中的每张表都有主键，如果创建表时没有主动创建主键，则InnoDB会按如下方式创建一个主键：<ol><li>判断表中是否存在<strong>非空的唯一索引</strong>（Unique NOT NULL），若有，则该列即为主键。<li>若没有非空唯一索引，则自动创建一个6字节的row_id列作为主键。</ol><p>若表中有多个非空唯一索引，则会选择第一个非空唯一索引作为主键。主键的选择根据的是定义索引的顺序，而不是建表时列的顺序。<h2 id=4-2、InnoDB逻辑存储结构><a class=headerlink href=#4-2、InnoDB逻辑存储结构 title=4.2、InnoDB逻辑存储结构></a>4.2、InnoDB逻辑存储结构</h2><p>所有数据逻辑存放在表空间。表空间又由段、区、页组成。InnnoDB逻辑存储结构大致如图所示（page页有时也被称为块block）：<p><img alt=image-20200814123555813 src=https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/06/image-20200814123555813.png><h3 id=4-2-1、表空间><a class=headerlink href=#4-2-1、表空间 title=4.2.1、表空间></a>4.2.1、表空间</h3><p><strong>表空间存放所有数据，如果设置参数<code>innodb_file_per_table</code>，则每张表的数据将会被单独放到一个表空间内</strong>。<p><font color=red>注意：每张表的表空间中存放的只是数据、索引和插入缓冲Bitmap页，其它的数据（undo信息、插入缓冲索引页、系统事务信息、二次写缓冲等）还是会存放到原来的共享表空间中。</font><p>自动提交关闭环境下，执行update操作但不执行commit/rollback，会产生大量undo操作语句，从而导致共享表空间增大。执行rollback后，其共享表空间容量也不会缩减到原来的大小。但是会自动判断这些undo信息是否还需要，如果不需要，则会将其标记为可用空间，供下次undo使用。<h3 id=4-2-2、段><a class=headerlink href=#4-2-2、段 title=4.2.2、段></a>4.2.2、段</h3><p><strong>表空间由段组成，常见的段有：数据段、索引段、回滚段等</strong>。因为InnoDB引擎表是索引组织的，因此数据即索引，索引即数据。那么数据段即为B+树的叶子节点，索引段即为B+树的非叶子节点。<h3 id=4-2-3、区><a class=headerlink href=#4-2-3、区 title=4.2.3、区></a>4.2.3、区</h3><p><strong>区由连续页组成，每个区大小固定为1M</strong>。为保证区中页的连续性，<strong>InnoDB引擎一次从磁盘申请4~5个区。默认情况下，InnoDB引擎页的大小为16K，即一个区共有64个页</strong>。<p>InnoDB 1.0.x 引入压缩页，<strong>每个页大小可通过参数 <code>KEY_BLOCK_SIZE</code>设置为2k、4k、8k，因此每个区的页数量就会是512、256、128</strong>。<p>InnoDB 1.2.x 开始通过<strong>参数<code>innodb_page_size</code>可以将页默认大小设置为4k、8k，但页中的数据不会被压缩。此时页的数量同样为256、128，总之页大小不管怎么变，区大小总是为1M</strong>。<p>每个段开始时，会先用32个页大小的碎片页来存放数据，用完之后再申请64个页。这样做的目的对于一些小表来说，或者undo这种段，可以在申请时申请较少的空间，节省磁盘开销。<h3 id=4-2-4、页><a class=headerlink href=#4-2-4、页 title=4.2.4、页></a>4.2.4、页</h3><p>页是InnoDB进行磁盘管理的最小单位<strong>InnoDB引擎中每个页默认大小为16K，从InnoDB 1.2.x开始，可通过参数<code>innodb_page_size</code>来设置页的大小为4k、8k、16k</strong>。若设置完成，所有表中页的大小就是该值，不可再次对其进行更改，除非通过 mysqldump导入和导出操作来生成新库。<p>InnoDB引擎中，常见的页类型有：<ol><li>数据页<li>undo页<li>系统页<li>事务数据页<li>插入缓冲位图页<li>插入缓冲空闲列表页<li>未压缩的二进制大对象页<li>压缩的二进制大对象页</ol><h3 id=4-2-5、行><a class=headerlink href=#4-2-5、行 title=4.2.5、行></a>4.2.5、行</h3><p>InnoDB引擎是面向列的。每个页存放的行记录最多为(16K / 2-200)行记录，即7992行记录。<p>MySQL infobright存储引擎会按照列来存储数据，这对于数据仓库下的分析类SQL语句的执行及数据压缩非常有帮助。类似的数据库还有Sybase IQ、Google Big Table。面向列的数据库是数据库发展的一个方向。<h2 id=4-3、InnoDB行记录格式><a class=headerlink href=#4-3、InnoDB行记录格式 title=4.3、InnoDB行记录格式></a>4.3、InnoDB行记录格式</h2><p>InnoDB引擎下，记录是以行的形式存储，这意味着页中保存着一行行的数据。InnoDB 1.0.x前，InnoDB提供 Compact 和 Redundant（为兼容之前版本而保留） 两种格式来存放行记录数据。MySQL 5.1版本中，默认设为Compact行格式。用户可以通过命令 <code>show table status like 'table_name'</code>来查看当前表使用的行格式。<h3 id=4-3-1、Compact行记录格式><a class=headerlink href=#4-3-1、Compact行记录格式 title=4.3.1、Compact行记录格式></a>4.3.1、Compact行记录格式</h3><p>该行记录格式在MySQL5.0中引入，目标是高效存储数据，简单说，<em><strong>一个页中存放的行数据越多，其性能就越高</strong></em>。<p><img alt=image-20201212184714449 src=https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/06/image-20201212184714449.png><ol><li><p><strong>变长字段长度列表</strong></p> <p>其是一个非NULL变长字段长度列表，且按照列的顺序逆序存放，其长度为：</p> <ol><li>若列的长度小于255字节，yong1字节表示。<li>若大于255个字节，用2个字节表示。</ol><li><p><strong>NULL标志位</strong></p></ol><p>表示该行数据中是否有NULL值，有则用1表示，占1字节。<ol start=3><li><strong>记录头信息</strong></ol><p>固定占用5字节（40位），每位含义见表：<p><img alt=image-20201212185453950 src=https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/06/image-20201212185453950.png><ol start=4><li><strong>列数据</strong></ol><p>需要注意，NULL除了占有NULL标志位外，不占该部分空间。每行除了用户定义的列外，还有两个列，事务ID列（6字节） 和 回滚指针列（7字节），若InnoDB表没有定义主键，每行还会增加一个6字节的rowid列。<h3 id=4-3-2、Redundant行记录格式><a class=headerlink href=#4-3-2、Redundant行记录格式 title=4.3.2、Redundant行记录格式></a>4.3.2、Redundant行记录格式</h3><p>该记录格式是MySQL5.0之前InnoDB引擎的行记录存储方式，5.0支持该格式是为了兼容之前版本的页格式。该记录采用如下图所示的方式存储：<p><img alt=image-20201212190244966 src=https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/06/image-20201212190244966.png><ol><li><p><strong>字段长度偏移列表</strong>：与 Compact 一样。</p><li><p><strong>记录头信息</strong>：占6字节（48位），每位含义见表：</p> <p><img alt=image-20201212190633971 src=https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/06/image-20201212190633971.png></p><li><p><strong>列数据</strong>：实际存储的列数据。</p></ol><h3 id=4-3-3、行溢出数据><a class=headerlink href=#4-3-3、行溢出数据 title=4.3.3、行溢出数据></a>4.3.3、行溢出数据</h3><p>InnoDB引擎可以将一条记录中的某些数据存储在数据页面之外。一般认为BLOB、LOB这类大对象类型数据会存储在数据页面之外，但也可以不存储在外面。且即便是VARCHAR列数据类型，也有可能存储在页面之外。<p>普遍认为，<strong>MySQL的VARCHAR类型可以存储65535字节，但实际上创建VARCHAR长度为65535的表时，会报错。因为还有别的开销，实际测试VARCHAR类型可以创建的最大长度为65532</strong>。<blockquote><p>这里要注意，如果没有将SQL_MODE设为严格模式，创建VARCHAR长度为65535的表时会成功，但会抛出一个warning，这个warning提示这次可以创建成功是因为自动将VARCHAR类型转换成了TEXT类型。</blockquote><p>成功创建VARCHAR长度为65535的表时的字符类型是latin1，如果换成 GBK 或 UTF-8，则在创建时会再次报错。由此可以得出：VARCHAR(N)中的N指的是字符长度，而官方指定的65535说的是字节。<p><font color=red>注意：官方规定65535长度是表中所有列的长度总和，如果列的长度总和超过这个长度，依然无法创建。</font><p>一般情况下，InnoDB引擎的数据存放在B树节点中。但当发生行溢出时，数据会存放至Uncompress BLOB类型页中。<h3 id=4-3-4、Compressed和Dynamic行记录格式><a class=headerlink href=#4-3-4、Compressed和Dynamic行记录格式 title=4.3.4、Compressed和Dynamic行记录格式></a>4.3.4、Compressed和Dynamic行记录格式</h3><p><strong>InnoDB 1.0.x开始引入新的文件格式 Barracuda，该格式下有两种新的行记录格式：Compressed 和 Dynamic 行记录格式。以前支持的 Compact 和 Redundant 格式称之为 Antelope 文件格式</strong>。<p>两种新的行记录格式对于存放在BLOB中的数据采用了完全行溢出的方式。Compressed行记录格式的另一个功能是，存储在其中的行数据会以 zlib 算法进行压缩，因此对于BLOB、TEXT、VARCHAR这类大长度类型的数据能进行有效存储。<h3 id=4-3-5、CHAR行结构存储><a class=headerlink href=#4-3-5、CHAR行结构存储 title=4.3.5、CHAR行结构存储></a>4.3.5、CHAR行结构存储</h3><p><strong>MySQL 4.1开始，CHAR(N)中的N指 字符长度，而不是字节长度</strong>。在不同字符集下，CHAR类型列内部存储的可能不是定长数据。<h2 id=4-4、InnoDB数据页结构><a class=headerlink href=#4-4、InnoDB数据页结构 title=4.4、InnoDB数据页结构></a>4.4、InnoDB数据页结构</h2><p>InnoDB数据页由7个部分组成：<ol><li><p>File Header：固定38字节。记录页的头信息。</p><li><p>Page Header：固定56字节。记录数据页的状态信息，由14个部分组成。</p><li><p>Infimun 和 Supremum Records</p> <p>InnoDB引擎中，每个数据页有两个虚拟的行记录，用来限定记录的边界。Infimum记录是当前页中最小的值，Supremum记录是最大的值。这两个值在页创建时被建立，且不会被删除。在Compact行格式和Redundant行记录格式下，两者占用的字节数各不相同。</p><li><p>User Records：动态大小，实际存储行记录的内容。</p><li><p>Free Space：动态大小，指的是空闲空间，是个链表结构。在一条记录被删除后，该空间会被加入到空闲链表中。</p><li><p>Page Directory</p> <p>动态大小，存放了记录的相对位置（页相对位置，而不是偏移量），有时候这些记录指针被称为Slots（槽）或目录槽。InnoDB的槽中可能包含多个记录。伪记录Infimum的n_owned值总是1，记录Supremum的n_owned的取值范围为[1, 8]，其它用户记录n_owned的取值范围为[4, 8]。当记录被插入或删除时需要对槽进行分裂或平衡操作。</p> <p>Slots中记录按照索引键值顺序存放，这样可以利用二叉查找迅速找到记录的指针。</p> <p>要牢记，B+树索引本身并不能找到具体的一条记录，能找到的只是该记录所在的页。数据库把页载入到内存，然后通过Page Directory在进行二叉查找。</p><li><p>File Trailer</p> <p>固定8字节。该部分是为了检测页是否完整地写入磁盘。File Trailer只有一个FIL_PAGE_END_LSN部分，占用8字节，前4字节代表该页的checksum值，后4字节和File Header中的FIL_PAGE_LSN一样。将这两个值与File Header中的FIL_PAGE_SPACE_OR_CHKSUM 和 FIL_PAGE_LSN值进行比较，看是否一致，以此确保页的完整性。</p> <p>默认InnoDB引擎每次从磁盘读取一个页就会检查其完整性，检查有一定的开销，可通过参数<code>innodb_checksums</code>来开启或关闭这个检查功能。</p> <p>MySQL 5.6.6开始新增参数 <code>innodb_checksum_algorithm</code>，该参数用来控制检测checksum函数的算法，默认crc32，可选值有：innodb、crc32、none、strict_innodb、strict_crc32、strict_none。</p></ol><p><strong>7个部分的大小总和就是Page Size的值，3和4合称为行记录。</strong><h2 id=4-5、Named-File-Formats机制><a title="4.5、Named File Formats机制" class=headerlink href=#4-5、Named-File-Formats机制></a>4.5、Named File Formats机制</h2><p><strong>从InnoDB 1.0.x开始，InnoDB通过Named File Formats机制来解决不同版本页结构兼容性问题</strong>。<p>未来版本的InnoDB引擎还将引入新文件格式，此文件格式的名称取自动物名字。<p>参数<code>innodb_file_format</code>用来指定文件格式。参数<code>innodb_file_format_check</code>表示是否开启检测当前InnoDB引擎文件格式的支持度，默认为ON。<h2 id=4-6、约束><a class=headerlink href=#4-6、约束 title=4.6、约束></a>4.6、约束</h2><h3 id=4-6-1、数据完整性><a class=headerlink href=#4-6-1、数据完整性 title=4.6.1、数据完整性></a>4.6.1、数据完整性</h3><p>域完整性可以通过以下方式来保证：<ol><li><strong>选择合适的数据类型确保一个数据值满足特定条件</strong>。<li><strong>外键约束</strong>。<li><strong>编写触发器</strong>。<li><strong>还可考虑使用DEFAULT约束作为强制域完整性的一个方面</strong>。</ol><p>InnoDB引擎提供了以下几种约束：<ol><li>Primary Key（主键约束）<li>Unique Key（唯一性约束）<li>Foreign Key（外键约束）<li>Default（默认约束）<li>Not Null（非空约束）</ol><h3 id=4-6-2、约束创建><a class=headerlink href=#4-6-2、约束创建 title=4.6.2、约束创建></a>4.6.2、约束创建</h3><p>约束创建有两种方式：<ol><li>表建立时就进行约束定义。<li>利用ALTER TABLE命令创建约束。</ol><h3 id=4-6-3、约束和索引的区别><a class=headerlink href=#4-6-3、约束和索引的区别 title=4.6.3、约束和索引的区别></a>4.6.3、约束和索引的区别</h3><p>约束和索引的概念不同，约束是一个逻辑概念，用来保证数据完整性，而索引是一个数据结构，既有逻辑概念，也代表着物理存储的方式。<h3 id=4-6-4、错误数据约束><a class=headerlink href=#4-6-4、错误数据约束 title=4.6.4、错误数据约束></a>4.6.4、错误数据约束</h3><p>可通过参数<code>sql_mode</code>来严格审核输入的参数，该参数的可选值有很多，具体参考官方文档。<h3 id=4-6-5、ENUM-和-SET约束><a title="4.6.5、ENUM 和 SET约束" class=headerlink href=#4-6-5、ENUM-和-SET约束></a>4.6.5、ENUM 和 SET约束</h3><p>MySQL不支持传统的CHECK约束，但通过ENUM和SET可以解决部分这样的需求。有时还需要配合参数 <code>sql_mode</code>。<h3 id=4-6-6、触发器约束><a class=headerlink href=#4-6-6、触发器约束 title=4.6.6、触发器约束></a>4.6.6、触发器约束</h3><p>最多可以为一个表创建6个触发器，即INSERT、UPDATE、DELETE的BEFORE和AFTER各定义一个。<h3 id=4-6-7、外键约束><a class=headerlink href=#4-6-7、外键约束 title=4.6.7、外键约束></a>4.6.7、外键约束</h3><p>外键用来保证参照完整性。MyISAM引擎不支持外键，而InnoDB引擎完全支持。<p><strong>一般来说，被引用表称为父表，引用表称为子表。外键定义时的 ON DELETE 和 ON UPDATE 表示在对父表执行 DELETE 和 UPDATE 操作时，子表应被如何对待</strong>，可选操作有：<ol><li><p><strong>CASCADE</strong>：父表被怎么操作，子表就被怎么操作。</p><li><p><strong>SET NULL</strong>：父表被操作时，子表中相对应的数据被更新为NULL值（列必须允许NULL值）。</p><li><p><strong>NO ACTION</strong>：父表被操作时，抛出错误，不允许这类操作发生。</p><li><p><strong>RESTRICT</strong>：父表被操作时，抛出错误，不允许这类操作发生。</p></ol><p><font color=red>注意：如果定义外键时没有指定ON DELETE 或 ON UPDATE，那么默认是RESTRICT。</font><h2 id=4-7、视图><a class=headerlink href=#4-7、视图 title=4.7、视图></a>4.7、视图</h2><p><strong>MySQL 5.0开始支持视图。视图是一个虚表，它由一个SQL查询来定义，可做表使用，且视图中的数据没有实际的物理存储</strong>。<h3 id=4-7-1、视图作用><a class=headerlink href=#4-7-1、视图作用 title=4.7.1、视图作用></a>4.7.1、视图作用</h3><p><strong>视图充当了一个安全层</strong>。<p>要查询视图的一些元数据，可以访问<code>information_schema</code>架构下的VIEWS表，该表有视图的详细信息。查看命令如下：<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line><span class=keyword>select</span> <span class=operator>*</span> <span class=keyword>from</span> infomation_schema.VIEWS </span><br><span class=line><span class=keyword>where</span> table_schema <span class=operator>=</span> database() \G;</span><br></pre></table></figure><h3 id=4-7-2、物化视图><a class=headerlink href=#4-7-2、物化视图 title=4.7.2、物化视图></a>4.7.2、物化视图</h3><p>物化视图 指：将视图对应的数据插入到一张实表中。物化视图可以提高一些复杂统计类查询的性能。<p>物化视图刷新 指：当基表发生DML操作后，物化视图会在某一时刻以某种方式进行同步。同步的方式有两种：<ol><li><p><strong>ON DEMAND</strong>：用户需要时进行刷新。</p><li><p><strong>ON COMMIT</strong>：基表的DML操作提交的同时进行刷新。</p></ol><p>刷新方法有四种：<ol><li><p><strong>FAST</strong>：只刷新自上次刷新后执行的修改。</p><li><p><strong>COMPLETE</strong>：对整个物化视图进行完全刷新。</p><li><p><strong>FORCE</strong>：刷新时判断是否可以快速刷新，如果可以，采用FAST方式，否则采用COMPLETE的方式。</p><li><p><strong>NEVER</strong>：不进行任何刷新。</p></ol><p><font color=red>注意：MySQL本身不支持物化视图，但可通过定时把数据导入到一张表来实现。</font><h2 id=4-8、分区表><a class=headerlink href=#4-8、分区表 title=4.8、分区表></a>4.8、分区表</h2><h3 id=4-8-1、简介><a class=headerlink href=#4-8-1、简介 title=4.8.1、简介></a>4.8.1、简介</h3><p><strong>MySQL 5.1 开始支持分区，分区指：将一个表或索引分解为多个更小、更可管理的部分</strong>。<p>局部分区索引指：一个分区中既存放数据又存放索引。全局分区指：数据存放在各个分区中，数据的索引放在一个对象中。<p><font color=red>注意：MySQL仅支持水平分区，并不支持垂直分区。MySQL仅支持局部分区，还不支持全局分区。</font><p>当前数据库是否开启了分区功能，可通过如下命令查看<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line><span class=keyword>SHOW</span> VARIABLES <span class=keyword>LIKE</span> <span class=string>'%partition%'</span> \G;</span><br></pre></table></figure><p>当前MySQL支持的分区类型有：<ol><li><strong>RANGE分区</strong><li><strong>LIST分区</strong><li><strong>HASH分区</strong><li><strong>KEY分区</strong></ol><p><font color=red>注意：不论创建哪一种分区，如果表中存在主键或唯一索引，分区列必须是唯一索引的组成部分。</font><h3 id=4-8-2、子分区><a class=headerlink href=#4-8-2、子分区 title=4.8.2、子分区></a>4.8.2、子分区</h3><p><strong>子分区是在分区的基础上再进行分区，子分区也被称为复合分区。MySQL允许在RANGE 和 LIST 分区上再进行 HASH 和 KEY 的子分区</strong>。<p>子分区建立注意事项如下：<ol><li>每个子分区的数量必须相同。<li>要在一个分区表的任何分区上使用SUBPARTITION 来明确定义任何子分区，就必须定义所有的子分区。<li>每个 SUBPARTITION 子句必须包括子分区的一个名字。<li>子分区的名字必须唯一。</ol><h3 id=4-8-3、分区中的NULL值><a class=headerlink href=#4-8-3、分区中的NULL值 title=4.8.3、分区中的NULL值></a>4.8.3、分区中的NULL值</h3><p><strong>MySQL允许对NULL值做分区，且总是认为NULL值小于任何一个非NULL值，这和处理NULL值的ORDER BY操作一样。</strong><p><strong>不同的分区类型对于NULL值的处理也不相同。对于NULL值，RANGE分区会放在分区最左边，LIST分区就必须显式指出哪个区中放入NULL值，否则会报错。HASH 和 KEY 对于NULL值的记录会返回0</strong>。<h3 id=4-8-4、分区和性能><a class=headerlink href=#4-8-4、分区和性能 title=4.8.4、分区和性能></a>4.8.4、分区和性能</h3><p>数据库的应用分为两类：<ul><li><strong>OLTP（在线事务处理）</strong>：不适合分区，因为该类应用通常获取的数据一般在表数据的10%左右。<li><strong>OLAP（在线分析处理）</strong>：对于该类应用，分区可以提高查询的性能，因为该应用大多数需要扫描一张大表。</ul><h3 id=4-8-5、在表和分区间交换数据><a class=headerlink href=#4-8-5、在表和分区间交换数据 title=4.8.5、在表和分区间交换数据></a>4.8.5、在表和分区间交换数据</h3><p>MySQL 5.6开始支持 ALTER TABLE … EXCHANGE PARTITION 语法，该语句允许分区或子分区中的数据与另一个非分区的表中的数据进行交换。<p>要使用这个语句，需满足下列条件：<ol><li>要交换的表需要和分区表有着相同的表结构，但表不能含有分区。<li>在非分区表中的数据必须在交换的分区定义内。<li>被交换的表中不能还有外键，或者其它表含有对该表的外键引用。<li>用户除了需要 ALTER、INSERT 和 CREATE权限外，还需要 DROP 的权限。此外，有两个小细节要注意：<ol><li>使用该语句时，不会触发交换表和被交换表上的触发器。<li>AUTO_INCREMENT列将被重置。</ol></ol><h1 id=5、索引><a class=headerlink href=#5、索引 title=5、索引></a>5、索引</h1><h2 id=5-1、索引简介><a class=headerlink href=#5-1、索引简介 title=5.1、索引简介></a>5.1、索引简介</h2><h3 id=5-1-1、索引分类><a class=headerlink href=#5-1-1、索引分类 title=5.1.1、索引分类></a>5.1.1、索引分类</h3><ul><li>基于功能划分，可分为 4 种：普通、唯一、主键、全文。<li>基于物理划分，可分为 2 种：聚簇索引、非聚簇索引（二级索引 / 辅助索引）。<li>基于字段数量划分，可分为 2 种：单列索引、多列（联合）索引</ul><blockquote><p>所有存储引擎支持每个表至少16个索引，总索引长度至少为256字节。其它个别存储引擎支持更多的索引数量和更大的索引长度。</blockquote><h3 id=5-1-2、索引优缺点><a class=headerlink href=#5-1-2、索引优缺点 title=5.1.2、索引优缺点></a>5.1.2、索引优缺点</h3><p>选择使用索引时，需要综合考虑索引的优缺点。<p>优点：<ul><li>降低数据库IO成本。<li>保证每行数据唯一性。<li>加速表之间的连接。<li>减少查询过程中的分组和排序时间。</ul><p>缺点：<ul><li>创建和维护耗费时间。<li>索引存储需要占用较大磁盘空间。若有大量索引，则索引文件可能比数据文件更快到达最大文件尺寸。<li>降低了表的更新速度。</ul><blockquote><p>索引可以提高查询速度，但同时也会降低插入速度。为应对此问题，提出一条合理性建议：先删除索引，再插入数据，然后再建立索引。</blockquote><h2 id=5-2、索引实现><a class=headerlink href=#5-2、索引实现 title=5.2、索引实现></a>5.2、索引实现</h2><p>InnoDB引擎支持的索引如下：<ol><li>聚簇索引与非聚簇索引。<li>全文索引。<li>自适应哈希索引（不能人为干预创建）。</ol><p>MyISAM引擎支持的索引如下：<ul><li>非聚簇索引<li>普通索引</ul><h2 id=5-3、B-树索引><a class=headerlink href=#5-3、B-树索引 title=5.3、B+树索引></a>5.3、B+树索引</h2><h3 id=5-3-1、B-树结构><a class=headerlink href=#5-3-1、B-树结构 title=5.3.1、B+树结构></a>5.3.1、B+树结构</h3><h4 id=简介-3><a class=headerlink href=#简介-3 title=简介></a>简介</h4><p>B+树由B树和索引顺序访问方法演化而来。<p>B+树中的B代表平衡（balance），B+树是从平衡二叉树演化而来，但B+树不是一个二叉树。<h4 id=B-树插入><a class=headerlink href=#B-树插入 title=B+树插入></a>B+树插入</h4><p>B+树的插入必须保证插入后叶子节点中的记录依然有序，同时需要考虑插入到B+树的三种情况：<p><img alt=image-20201213123240100 src=https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/06/image-20201213123240100.png><h4 id=B-树删除><a class=headerlink href=#B-树删除 title=B+树删除></a>B+树删除</h4><p>B+树使用填充因子来控制树的删除变化，50%是填充因子可设置的最小值。B+树删除操作必须保证删除后叶子节点中的记录依然有序，与插入一样，删除同样需要考虑三种情况：<p><img alt=image-20201213123536278 src=https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/06/image-20201213123536278.png><p>B+树有一个特点是高扇出性，因此B+树的高度一般在2<del>4层，也就是说需要2</del>4次IO。机械硬盘每秒至少100次IO，2<del>4次IO意味着查询时间只需0.02</del>0.04秒。<p>InnoDB引擎将B+树分为聚集索引和辅助索引。两者的区别是，叶子节点存放的是否是一整行的数据。<blockquote><p>B+树中的B不是二叉 ，而是代表平衡（balance），因为B+树是从最早的平衡二叉树演化而来，但B+树不是一个二叉树。<p>B+树索引不能找到一个给定键值的具体数据，B+树索引能找到的只是被查找数据所在的页，然后数据库需要把页读到内存中进行再次查找，最后找到需要的数据。</blockquote><h3 id=5-3-2、B-树索引分裂><a class=headerlink href=#5-3-2、B-树索引分裂 title=5.3.2、B+树索引分裂></a>5.3.2、B+树索引分裂</h3><p>B+树索引页的分裂并不会经常性从页的中间记录开始，这样可能会导致页空间的浪费。<p>InnoDB引擎的<code>Page header</code>由以下几部分用来保存插入顺序信息：<ol><li><strong>PAGE_LAST_INSERT</strong><li><strong>PAGE_DIRECTION</strong><li><strong>PAGE_N_DIRECTION</strong></ol><p>通过这些信息可以判断是向左分裂还是向右分裂，同时决定将分裂点记录为哪一个。<ul><li>若插入是随机的，则取中间记录为分裂点记录。<li>若向同一方向插入的记录数量为5，且目前已经定位到的记录之后还有3条记录，则分裂点记录是定位的记录后的第三条记录。否则分裂点的记录就是待插入的记录的第一条记录。</ul><h3 id=5-3-3、B-树索引分类><a class=headerlink href=#5-3-3、B-树索引分类 title=5.3.3、B+树索引分类></a>5.3.3、B+树索引分类</h3><h4 id=5-3-3-1、聚簇索引><a class=headerlink href=#5-3-3-1、聚簇索引 title=5.3.3.1、聚簇索引></a>5.3.3.1、聚簇索引</h4><p>聚簇索引 是根据表中主键 构造的B+树，叶子节点中存放的就是表数据，也将聚簇索引的叶子节点称为数据页，每个数据页通过一个双向链表来进行链接。由于实际的数据页只能按照一颗B+树来进行排序，因此一张表只能拥有一个聚簇索引。<p>聚簇索引不仅包含索引的键值，还包含所有表数据。聚集索引中的记录根据键值顺序存放，这个顺序指逻辑顺序。<h4 id=5-3-3-2、辅助索引><a class=headerlink href=#5-3-3-2、辅助索引 title=5.3.3.2、辅助索引></a>5.3.3.2、辅助索引</h4><p><strong>辅助索引 又称为 二级索引 或 非聚簇索引</strong>。其结构也为B+树。辅助索引的叶子节点并不保存表的全部数据，叶子节点除了包含键值外，每个叶子节点的索引行中还包含了一个书签，这个书签就是相应行数据的聚集索引键。<p>**辅助索引叶子节点保存的是<键值, (记录)地址>**。记录地址可以存在两种形式：<ol><li>记录的物理地址，页号：槽号：偏移量。（MyISAM引擎B+树存储方式）<li>记录的主键值。（InnoDB引擎下的存储方式）InnoDB引擎是索引组织表，所有记录都放在聚簇索引中，辅助索引中记录地址存放的是主键的键值。</ol><p><strong>InnoDB引擎下，辅助索引叶子节点存放的是主键，因此查找完整记录需要通过 聚簇索引 再次查询，一般称这种查询方式为 书签查找回表</strong>。<p><strong>辅助索引的非叶子节点存放的记录格式为<键值，主键值，地址>。辅助索引节点的记录不保存隐藏列<code>trx_id</code>和<code>roll_ptr</code>，这是辅助索引和聚集索引不相同的另一方面</strong>。<h4 id=联合索引><a class=headerlink href=#联合索引 title=联合索引></a>联合索引</h4><p>可以为多个列建立索引，比方说我们想让B+树按照 c2和c3列 的大小进行排序，这个包含两层含义：<ul><li>先把各个记录和页按照c2列进行排序。<li>在记录的c2列相同的情况下，采用c3列进行排序。</ul><p><strong>以 c2 和 c3 列的大小为排序规则建立的 B+ 树称为 联合索引，本质上也是一个二级索引</strong>。<h4 id=覆盖索引><a class=headerlink href=#覆盖索引 title=覆盖索引></a>覆盖索引</h4><h5 id=简介-4><a class=headerlink href=#简介-4 title=简介></a>简介</h5><p><strong>仅通过二级索引且无需回表就可拿到需要查询的数据，这种索引称为覆盖索引</strong>。<h5 id=优缺点><a class=headerlink href=#优缺点 title=优缺点></a>优缺点</h5><ul><li>优点<ul><li>避免了索引的二次查询。<li>可以把随机IO变成顺序IO。</ul><li>缺点<ul><li>索引字段维护需要代价，故在建立冗余字段提升效率时需要权衡考虑。</ul></ul><h3 id=5-3-4、B-树索引管理><a class=headerlink href=#5-3-4、B-树索引管理 title=5.3.4、B+树索引管理></a>5.3.4、B+树索引管理</h3><h4 id=索引创建与删除><a class=headerlink href=#索引创建与删除 title=索引创建与删除></a>索引创建与删除</h4><p><strong>索引的创建和删除有两种方式：一种是 ALTER TABLE，另一种是 CREATE / DROP INDEX</strong>。<p><code>SHOW INDEX</code>命令返回的结果中有一个<code>Cardinality</code>值非常关键，优化器会根据这个值来判断是否使用这个索引。但这个值的更新不是实时的，因为实时更新代价会很大。如果需要更新该值，可以使用 <code>ANALYZE TABLE TABLE_NAME</code> 命令来实现。<h3 id=5-3-5、B-树索引使用><a class=headerlink href=#5-3-5、B-树索引使用 title=5.3.5、B+树索引使用></a>5.3.5、B+树索引使用</h3><h4 id=联合索引-1><a class=headerlink href=#联合索引-1 title=联合索引></a>联合索引</h4><h5 id=简介-5><a class=headerlink href=#简介-5 title=简介></a>简介</h5><p><strong>联合索引指的是为表上多个列建立索引</strong>。联合索引的创建方法与单个索引的创建方法一样，不同的是有多个索引列。<p>例如，创建一张表 t，并且idx_a_b是联合索引，联合的列为（a, b）：<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre><td class=code><pre><span class=line><span class=keyword>create</span> <span class=keyword>table</span> t(</span><br><span class=line>  a <span class=type>int</span>,</span><br><span class=line>  b <span class=type>int</span>,</span><br><span class=line>  <span class=keyword>primary</span> key (a),</span><br><span class=line>  key idx_a_b (a, b)</span><br><span class=line>)engine<span class=operator>=</span>innodb;</span><br></pre></table></figure><p><strong>联合索引也是一颗B+树，不同的是联合索引的键值数量不是 1，而是大于等于 2</strong>。<p><img alt=image-20210102183237223 src=https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/06/image-20210102183237223.png><p>上图是多个键值的B+树，其实和单个键值的B+树没有什么不同，键值都是有序的，通过叶子节点可以逻辑上顺序的读到所有数据，就如图说，即 (1, 1)、(1, 2)、(2, 1)、(2, 4)、(3, 1)、(3, 2)。数据按 (a, b) 的顺序进行存放。<p>因此，对于select * from t where a=xxx and b=xxx，是可以使用联合索引 (a, b) 的，对于单个 a 列的查询也是可以使用这个联合索引的，但对于单个 b 列的查询，却不能使用这个索引。我们可以发现叶子节点上的 b 值为1、2、1、4、1、2，显然不是有序的，因此对于单个 b 列的查询是使用不到这个联合索引的。<p><strong>联合索引的第二好处是已经对第二个键值进行了排序处理，这样就避免了某种情况下的排序要求</strong>。<p>对于联合索引 (a, b)，下列 SQL 可以使用到这个索引：<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line><span class=keyword>select</span> <span class=operator>*</span> <span class=keyword>from</span> t <span class=keyword>where</span> a <span class=operator>=</span> xxx <span class=keyword>order</span> <span class=keyword>by</span> b;</span><br></pre></table></figure><p>对于联合索引 (a, b, c)，下列 SQL 可以使用到这个索引：<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line><span class=keyword>select</span> <span class=operator>*</span> <span class=keyword>from</span> t <span class=keyword>where</span> a <span class=operator>=</span> xxx <span class=keyword>order</span> <span class=keyword>by</span> b;</span><br><span class=line><span class=keyword>select</span> <span class=operator>*</span> <span class=keyword>from</span> t <span class=keyword>where</span> a <span class=operator>=</span> xxx <span class=keyword>and</span> b <span class=operator>=</span> xxx <span class=keyword>order</span> <span class=keyword>by</span> c;</span><br></pre></table></figure><p>但对于下列 SQL，通过联合索引不能直接得到结果，还需要执行一次额外的排序操作：<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line><span class=keyword>select</span> <span class=operator>*</span> <span class=keyword>from</span> t <span class=keyword>where</span> a <span class=operator>=</span> xxx <span class=keyword>order</span> <span class=keyword>by</span> c;</span><br></pre></table></figure><h5 id=优点><a class=headerlink href=#优点 title=优点></a>优点</h5><ol><li><strong>对于两个列的查询可以使用联合索引，单个列的查询也可以使用联合索引</strong>。<li><strong>已经对第二个键值进行了排序处理</strong>。</ol><h4 id=覆盖索引-1><a class=headerlink href=#覆盖索引-1 title=覆盖索引></a>覆盖索引</h4><p>InnoDB引擎支持覆盖索引（covering index），即<strong>从辅助索引中就可以得到查询结果，而不需要回表查询</strong>。通常辅助索引不包含整行全部记录，故大小要小于聚集索引，可以减少大量IO操作。<p>创建一个测试表 buy_log：<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre><td class=code><pre><span class=line><span class=keyword>create</span> <span class=keyword>table</span> buy_log(</span><br><span class=line>  userid <span class=type>int</span> unsigned <span class=keyword>not</span> <span class=keyword>null</span>,</span><br><span class=line>  buy_date <span class=type>date</span>,</span><br><span class=line>  key (userid),</span><br><span class=line>  key (userid, buy_date)</span><br><span class=line>)engine<span class=operator>=</span>innodb;</span><br></pre></table></figure><p>InnoDB辅助索引由于包含了主键信息，因此其叶子节点存放的数据为 (primary key, primary key2, …, key1, key2, …)。<p>覆盖索引也可适用于统计问题，如下列 SQL ：<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line><span class=keyword>select</span> <span class=built_in>count</span>(<span class=operator>*</span>) <span class=keyword>from</span> buy_log;</span><br></pre></table></figure><p>对于如上查询，如果表中有辅助索引的话，InnoDB引擎不会选择通过聚集索引来统计，因为选择辅助索引可以减少IO操作。<p>通常情况下，诸如 (a, b) 的联合索引，一般是不可以选择列 b 中所谓的查询条件。但如果是对于统计操作，且是覆盖索引的，则优化器会选择这个索引。如下列 SQL：<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line><span class=keyword>select</span> <span class=built_in>count</span>(<span class=operator>*</span>) <span class=keyword>from</span> buy_log </span><br><span class=line><span class=keyword>where</span> buy_date <span class=operator>>=</span> <span class=string>'2011-01-01'</span> <span class=keyword>and</span> buy_date <span class=operator><</span> <span class=string>'2011-02-01'</span>;</span><br></pre></table></figure><p><strong>表 buy_log 有 (userid, buy_date) 联合索引，只对 b 列进行条件查询一般不走联合索引，但这个 SQL 是统计操作且可使用到覆盖索引信息，因此优化器会选择该联合索引</strong>。<h4 id=索引提示><a class=headerlink href=#索引提示 title=索引提示></a>索引提示</h4><p><strong>MySQL支持索引提示（INDEX HINT），显式告诉优化器使用哪个索引</strong>。需要用到索引提示的情况如下：<ol><li>MySQL优化器错误地选择了某个索引。<li>某SQL语句可以选择的索引比较多，此时优化器选择索引的时间开销可能比SQL语句本身都要大。</ol><p>显式指定索引来执行查询，可以通过以下关键字实现：<ul><li>USE：为MySQL提供参考的索引列表，让MySQL不再考虑使用其他可用索引。<li>FORCE：强制使用一个特定的索引。<li>IGNORE：忽略一个或多个索引。</ul><p>使用示例如下：<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line># 告诉MySQL 使用 指定索引</span><br><span class=line><span class=keyword>select</span> emp_no, salary <span class=keyword>from</span> salaries </span><br><span class=line>use index(s_f_t) </span><br><span class=line><span class=keyword>where</span> emp_no <span class=operator><</span> <span class=number>11010</span> <span class=keyword>and</span> salary <span class=operator><</span> <span class=number>60000</span>;</span><br></pre></table></figure><figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line># 告诉MySQL 强制使用 指定索引</span><br><span class=line><span class=keyword>SELECT</span> <span class=operator>*</span> <span class=keyword>FROM</span> `yrd_pay_flow` </span><br><span class=line>force index(`idx_trxn_date`)</span><br><span class=line><span class=keyword>WHERE</span>  trxn_date <span class=operator>></span> <span class=string>'2017-08-12 59:59:59'</span> <span class=keyword>AND</span> trxn_date <span class=operator><</span> <span class=string>'2016-06-23 00:00:00'</span>;</span><br></pre></table></figure><h3 id=5-3-6、B-树索引优化><a class=headerlink href=#5-3-6、B-树索引优化 title=5.3.6、B+树索引优化></a>5.3.6、B+树索引优化</h3><h4 id=Multi-Range-Read><a title="Multi-Range Read" class=headerlink href=#Multi-Range-Read></a>Multi-Range Read</h4><h5 id=简介-6><a class=headerlink href=#简介-6 title=简介></a>简介</h5><p><strong>MySQL 5.6开始支持Multi-Range Read优化。目的是减少磁盘的随机访问，将 随机访问 转为 顺序数据访问</strong>。<p>MRR优化是基于B+树的一种查询优化，可以同时使用多个范围查询条件，避免了多次进行索引查找的问题，提高了查询效率。<p>MRR优化优点如下：<ol><li>MRR可以顺序访问数据。通过辅助索引查找到主键后进行排序，然后再通过排序后的主键到聚簇索引中查找。<li>减少 缓冲池中 页替换次数。<li>批量处理 键值查询操作。</ol><p>对于InnoDB 和 MyISAM引擎的范围查询和JOIN，MRR工作方式如下：<ol><li>将依据 辅助索引 查询的数据放到缓存中，缓存中的数据已经通过辅助索引键值排好序。<li>将缓存中的键值再根据 RowID 进行排序。<li>根据RowID排序的结果再来访问实际数据文件。</ol><p><font color=red>注意：如果 InnoDB 和 MyISAM 的缓冲池不足以存放一张表的所有数据，那么频繁离散读取会导致缓存中的页被 替换出缓冲池，然后又不断被 读进缓冲池。若按照主键顺序进行访问，则可以将此重复行为降到最低。</font><h5 id=实现原理><a class=headerlink href=#实现原理 title=实现原理></a>实现原理</h5><p>例如对于如下SQL：<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line><span class=keyword>select</span> <span class=operator>*</span> <span class=keyword>from</span> t </span><br><span class=line><span class=keyword>where</span> key_part1 <span class=operator>>=</span> <span class=number>1000</span> <span class=keyword>and</span> key_part1 <span class=operator><</span> <span class=number>2000</span> <span class=keyword>and</span> key_part2 <span class=operator>=</span> <span class=number>1000</span>;</span><br></pre></table></figure><p>表 t 有 (key_part1, key_part2)联合索引，因此索引根据 key_part1、key_part2 的位置关系进行排序。若没有 MRR 优化，此时查询类型为 Range，SQL优化器会先将 key_part1 大于 1000 且小于 2000 的数据都取出，即使 key_part2 不等于 1000。待取出行数据后再根据 key_part2 的条件进行过滤。这会导致无用数据被取出。<p>若启用了 MRR 优化，优化器会先将查询条件进行拆分，然后再进行数据查询。对于上面那个 SQL，优化器会先将查询条件拆分为 (1000, 1000)、(1001, 1000)、(1002, 1000)、…、(1999, 1000)，最后再根据这些拆分出的条件进行数据查询。<h5 id=如何启用><a class=headerlink href=#如何启用 title=如何启用></a>如何启用</h5><p>是否启用 MRR 优化可以通过参数 <code>optimizer_switch</code>中的标记来控制。当 mrr 为 on 时，表示启用 MRR 优化。<code>mrr_cost_based</code> 标记表示是否通过 cost based 的方式来选择是否启用 mrr。若将 mrr 设为 on，mrr_cost_based 设为 off，则表示总是启用 MRR 优化。如下命令可以将 MRR 优化设为一直开启状态：<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line><span class=keyword>set</span> @<span class=variable>@optimizer_switch</span><span class=operator>=</span><span class=string>'mrr=on,mrr_cost_based=off'</span>;</span><br></pre></table></figure><p><strong>参数 <code>read_rnd_buffer_size</code>用来控制键值缓冲区大小，默认值为256KB。当大于该值时执行器会将已经缓存的数据通过 RowID 进行排序并取得行数据。</strong><h4 id=ICP><a class=headerlink href=#ICP title=ICP></a>ICP</h4><h5 id=简介-7><a class=headerlink href=#简介-7 title=简介></a>简介</h5><p><strong>ICP是 Index Condition Pushdown 的首字母，意为索引下推</strong>。<p><strong>MySQL 5.6开始支持一种基于索引进行查询的优化</strong>。不支持该优化时，会先通过索引查找记录，然后根据 WHERE 进行过滤。<strong>开启该优化后，会在基于索引查找记录的同时就判断是否可以进行Where过滤，也就是将WHERE过滤放到了存储引擎层</strong>。对于某些查询，该方式可大大减少上层SQL层对记录的索取，进而提高数据库的整体性能。<p>ICP优化支持range、ref、eq_ref、ref_or_null类型的查询，且支持MyISAM和InnoDB引擎。当优化器选择 ICP 优化时，可以在执行计划的列 Extra 看到 Using index condition提示。<p>若支持ICP优化，则会在通过索引取出记录时就进行WHERE过滤，然后再回表查询。当然Where过滤的条件是该索引可以覆盖的范围。<h5 id=实现原理-1><a class=headerlink href=#实现原理-1 title=实现原理></a>实现原理</h5><p>假设某张表有联合索引 (zip_code, last_name, first_name)，且查询 SQL 如下：<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line>slect <span class=operator>*</span> <span class=keyword>from</span> people</span><br><span class=line><span class=keyword>where</span> zipcode <span class=operator>=</span> <span class=string>'95054'</span> </span><br><span class=line><span class=keyword>and</span> lastname <span class=keyword>like</span> <span class=string>'%etrunia%'</span> </span><br><span class=line><span class=keyword>and</span> address <span class=keyword>like</span> <span class=string>'Main Street'</span>;</span><br></pre></table></figure><p>对于上述 SQL，可以通过索引定位 zipcode 等于 95054 的记录，但是索引对于 where 的后两个过滤条件没有任何帮助。若不支持 ICP 优化，则需要先通过索引取出所有 zipcode 等于 95054 的记录，然后再过滤 where 之后的两个条件。若支持 ICP 优化，则通过索引取出数据时，就会进行 where 条件过滤，然后再去获取记录。这将极大提高查询的效率。当然，where 可以过滤的条件是要该索引可以覆盖到的范围。<h5 id=如何启用-1><a class=headerlink href=#如何启用-1 title=如何启用></a>如何启用</h5><p><strong>ICP优化默认是开启状态</strong>，当然也可通过下列命令开启或关闭：<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line><span class=keyword>set</span> @<span class=variable>@optimizer_switch</span><span class=operator>=</span><span class=string>'index_condition_pushdown=on'</span>;</span><br></pre></table></figure><p>ICP 优化可以将查询效率在原有MySQL 5.5版本技术上提高 23%左右。而再同时开启 MRR 优化，性能还能有 400% 的提升。<h4 id=Fast-Index-Creation><a title="Fast Index Creation" class=headerlink href=#Fast-Index-Creation></a>Fast Index Creation</h4><p><strong>InnoDB引擎从 1.0.x 开始支持一种称为 Fast Index Creation（快速索引创建）的索引创建方式——简称FIC</strong>。<p>InnoDB引擎会<strong>对创建辅助索引的表加上一个S锁。创建过程中无需重建表</strong>，因此速度较之前提高很多，且数据库可用性也得到提高。<p>删除辅助索引更简单，InnoDB引擎只需更新内部视图，并将辅助索引的空间标为可用，同时删除MySQL内部视图上对该表的索引定义即可。<blockquote><p>注意，临时表的创建路径是通过参数 <code>tmpdir</code>进行设置，用户必须保证参数tmpdir设定的位置有足够的空间可以存放临时表，否则会导致创建索引失败。<p>FIC方式只限定于辅助索引，对于主键的创建和删除同样需要重建一张表。</blockquote><h4 id=Online-Schema-Change><a title="Online Schema Change" class=headerlink href=#Online-Schema-Change></a>Online Schema Change</h4><p>Online Schema Change（简称OSC）最早由FaceBook实现的一种在线 DDL 的方式，并广泛应用于 Facebook 的MySQL数据库。所谓<strong>在线说的是事务创建过程中，允许执行读写事务</strong>，该种方式极大提高了MySQL并发能力。<p><font color=red>注意：Facebook采用 PHP 脚本来实现 OSC，而并非是修改 InnoDB源码来实现。</font><h4 id=Online-DDL><a title="Online DDL" class=headerlink href=#Online-DDL></a>Online DDL</h4><p>FIC可以避免InnoDB创建临时表，但索引创建时会阻塞表上的DML操作。OSC虽然解决了上述的部分问题，但还是有很大局限性。<strong>MySQL 5.6开始支持 Online DDL（在线数据定义）操作，允许创建辅助索引的同时可以执行insert、update、delete等操作</strong>，极大提高了MySQL性能和可用性。<p>不仅是辅助索引，以下几类DDL操作都可以通过”在线“方式进行操作：<ol><li><strong>辅助索引的创建与删除</strong><li><strong>改变自增长值</strong><li><strong>添加或删除外键约束</strong><li><strong>列的重命名</strong></ol><p>通过新的 ALTER TABLE 语法，可以选择索引的创建方式：<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line><span class=keyword>alter</span> <span class=keyword>table</span> table_name</span><br><span class=line><span class=operator>|</span> <span class=keyword>add</span> (index <span class=operator>|</span> key) [index_name]</span><br><span class=line>[index_type] (index_col_name, ...) [index_option] ...</span><br><span class=line>ALGORITHM [<span class=operator>=</span>] (<span class=keyword>DEFAULT</span> <span class=operator>|</span> INPLACE <span class=operator>|</span> <span class=keyword>COPY</span>)</span><br><span class=line>LOCK [<span class=operator>=</span>] (<span class=keyword>DEFAULT</span> <span class=operator>|</span> <span class=keyword>NONE</span> <span class=operator>|</span> SHARED <span class=operator>|</span> EXCLUSIVE)</span><br></pre></table></figure><p><strong>ALGORITHM指定了创建或删除索引的算法</strong>，可选值有：<ol><li><p><strong>DEFAULT</strong>：根据参数 old_alter_table（默认为OFF，采用INPLACE） 来判断是通过 INPLACE 还是 COPY。</p><li><p><strong>INPLACE</strong>：不需要创建临时表。</p><li><p><strong>COPY</strong>：创建临时表方式。</p></ol><p>LOCK表示索引创建或删除时为表添加锁的情况，可选值有：<ol><li><p><strong>NONE</strong>：不对目标表添加任何锁，可提高最大并发度。</p><li><p><strong>SHARE</strong>：对目标表加一个S锁。如果存储引擎不支持该模式，则会报错。</p><li><p><strong>EXCLUSIVE</strong>：对目标表加一个X锁。</p><li><p><strong>DEFFAULT</strong>：会先判断当前操作是否可以使用NONE模式，若不能，再判断是否可以使用SHARE模式，最后判断是否可以使用EXCLUSIVE模式。</p></ol><p>InnoDB实现Online DDL的原理是：<strong>执行创建或删除操作时先将这些操作放入缓存中，待完成索引创建后再将之应用到表上</strong>，以此达到数据一致性。缓存大小取决于参数<code>innodb_online_alter_log_max_size</code> 的设置，默认大小为128M。如果存放的内容大小超过参数设定的值会抛出错误。<blockquote><p>索引创建过程中，SQL优化器不会选择正在创建中的索引。</blockquote><h3 id=5-3-7、B-树优缺点><a class=headerlink href=#5-3-7、B-树优缺点 title=5.3.7、B+树优缺点></a>5.3.7、B+树优缺点</h3><p>优点：<ul><li>数据访问效率块。<li>聚簇索引对于【顺序查找】与【范围查找】速度很快。<li>因叶子节点数据排列有序，范围查询时可大大减少IO操作。</ul><p>缺点：<ul><li>插入速度严重依赖插入顺序。（尽量保证主键升序。）<li>更新主键代价很高。（更新会导致节点分裂与合并）<li>二级索引访问需要两次索引查找。</ul><h3 id=5-3-8、总结><a class=headerlink href=#5-3-8、总结 title=5.3.8、总结></a>5.3.8、总结</h3><p>B+树注意事项：<ol><li>根页面位置万年不动。<li>内节点中目录项记录的唯一性。<li>一个页面最少存储2条记录。</ol><p>B+树限制：<ul><li>只有InnoDB支持聚簇索引，MyISAM不支持聚簇索引。<li>一个表只能有一个聚簇索引，该索引一般都是表的主键。<li>没有主键，InnoDB会选择【非空唯一索引】来代替，若唯一索引也没有，会创建隐藏列唯一【rowId】作为聚簇索引。<li>InnoDB表的主键尽量使用有序ID，而不建议设计无序字段作为主键。</ul><h2 id=5-5、Cardinality值><a class=headerlink href=#5-5、Cardinality值 title=5.5、Cardinality值></a>5.5、Cardinality值</h2><h3 id=5-5-1、什么是Cardinality><a class=headerlink href=#5-5-1、什么是Cardinality title=5.5.1、什么是Cardinality></a>5.5.1、什么是Cardinality</h3><p><strong>Cardinality值非常关键，表示索引中不重复记录的数量预估值。</strong>实际中 <code>Cardinality / n_rows_in_table</code> 应尽可能接近1，如果非常小，就不适合创建这个索引。故在访问高选择性属性的字段并从表中取出很少一部分数据时，对这个字段添加B+树索引会变得 非常必要。<h3 id=5-5-2、InnoDB中Cardinality统计><a class=headerlink href=#5-5-2、InnoDB中Cardinality统计 title=5.5.2、InnoDB中Cardinality统计></a>5.5.2、InnoDB中Cardinality统计</h3><p>InnoDB更新Cardinality的策略为：<ol><li>表中 1/16 的数据已发生过变化。<li>stat_modified_counter > 2 000 000 000。（stat_modified_counter代表行数据变化的次数）</ol><p><strong>InnoDB引擎对Cardinality信息的统计和更新是通过 采样方法 实现。</strong>默认InnoDB对8个叶子节点进行采样。采样过程如下：<ol><li>取得B+树索引中叶子节点的数量，记为A。<li>随机取得B+树索引中的8个叶子节点。统计每个页不同记录的个数，记为P1、P2、….P8。<li>根据采样信息给出Cardinality预估值：Cardinality = (P1 + P2 + …. +P8) * A / 8。</ol><h2 id=5-6、哈希算法><a class=headerlink href=#5-6、哈希算法 title=5.6、哈希算法></a>5.6、哈希算法</h2><p>哈希算法的时间复杂度为O(1)，且不只存在于索引中，每个数据库应用中都存在该数据结构。<h3 id=5-6-1、哈希表><a class=headerlink href=#5-6-1、哈希表 title=5.6.1、哈希表></a>5.6.1、哈希表</h3><p><strong>哈希表 又叫 散列表，由 直接寻址表 改进而来。</strong><h4 id=直接寻址表><a class=headerlink href=#直接寻址表 title=直接寻址表></a>直接寻址表</h4><p>假设 某应用 要用到 一个动态集合，其中每个元素都有一个取自全域 U = {0, 1, …, m-1} 的关键字。同时假设没有具有相同关键字的元素。用一个数组（直接寻址表）T[0 … m-1] 表示动态集合，其中每个位置（或称槽或称桶）对应全域 U 中的一个关键字。如下图所示，槽 K 指向集合中的一个关键字为 K 的元素，如果集合中没有关键字为 K 的元素，则 T[K] = null。<p><img alt=image-20210103220241478 src=https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/06/image-20210103220241478.png><p>直接寻址表有以下操作：<ol><li>INSERT：插入一个元素。<li>DELETE：删除一个元素。<li>SEARCH：查找一个元素。</ol><p>这里要注意，要是集合U的元素键值并不唯一，即keyikeyi和keyjkeyj(i≠j)(i≠j)有可能相等，那么采用链表的形式将相同键值的元素串成一串，全都挂在A[keyi]A[keyi]的后面，比如键值1重复：<p><img alt=image-20210103214822207 src=https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/06/image-20210103214822207.png><p>直接寻址技术有一个问题：如果域 U 很大，在一台典型计算机的可用容量的限制下，要在机器中存储大小为 U 的一张表 T 就有点不实际，甚至不可能。如果实际要存储的关键字集合 K 相对于 U 来说很小，那么分配给 T 的大部分空间都要浪费掉。因为这个问题，哈希表出现了。<h4 id=哈希表><a class=headerlink href=#哈希表 title=哈希表></a>哈希表</h4><p>哈希表也有一个小问题：<strong>两个关键字可能映射到同一个槽上。这种情况称为 碰撞，解决方法是 链表法</strong>。<p>在链表法中，把散列到同一槽中的所有元素都放在一个链表中。槽 j 中有一个指针，它指向所有散列到 j 的元素构成的链表的头。如果不存在这样的元素，则 j 中为 null。<p><img alt=image-20210103221109942 src=https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/06/image-20210103221109942.png><p>映射到哪一个槽是通过哈希函数计算的，这个哈希函数基于 除法散列 方式实现。即 通过取 K 除以 M 的余数，将关键字 K 映射到 M 个槽的某一个中去。<h3 id=5-6-2、InnoDB实现><a class=headerlink href=#5-6-2、InnoDB实现 title=5.6.2、InnoDB实现></a>5.6.2、InnoDB实现</h3><p><strong>InnoDB引擎使用哈希算法来对字典进行查找，其碰撞会采用链表方式解决，哈希函数采用除法散列方式。对于缓冲池页的哈希表来说，缓冲池中的page页都有一个chain指针，它指向相同哈希值的页。而对于除法散列，m的取值略大于2倍的缓冲池页数量的质数。</strong><p>对于参数 <code>innodb_buffer_pool_size</code>的大小为 10M，则共有640个 16K 的页。对于缓冲池页内存的哈希表来说，需要分配 640 x 2 = 1280 个槽，但是由于 1280 不是一个质数，需要取 比之大的一个质数，应该是 1399，所以启动时会分配一个具有 1399 个槽的哈希表，用来哈希 查询缓冲池中的页。<p>InnoDB缓冲池的页如何查找呢？InnoDB表空间都有一个space_id，用户要查询的应该是某个表空间的某个连续的 16K 的页，即偏移量 offset。InnoDB将space_id左移20位，然后加上这个space_id 和 offset，即关键字 K = space_id << 20 + space_id + offset，然后通过触发散列到各个槽中。<h3 id=5-6-3、自适应哈希索引><a class=headerlink href=#5-6-3、自适应哈希索引 title=5.6.3、自适应哈希索引></a>5.6.3、自适应哈希索引</h3><p><strong>自适应哈希索引基于哈希表实现，数据库会根据特殊情况自动创建并使用，不能人为干预</strong>。<p>自适应哈希索引 对于 字典类型的查找非常快，但对于范围查找就无能为力了。通过命令 SHOW ENGINE INNODB STATUS 可以看到当前自适应哈希索引的使用状况。<p><strong>可通过参数 <code>innodb_adaptive_hash_index</code> 来禁用或启用自适应哈希索引这个特性，默认开启</strong>。<h2 id=5-7、全文检索><a class=headerlink href=#5-7、全文检索 title=5.7、全文检索></a>5.7、全文检索</h2><p><strong>InnoDB引擎从1.2.x开始支持全文检索</strong>。<p>全文检索功能是指在文本数据中进行全文检索的功能。在mysql中，全文检索是通过创建全文索引来实现的。全文索引是一种特殊的索引，用于加速文本数据的搜索。<p>使用全文检索时需要注意以下几点：<ul><li>只有innodb和myisam支持全文检索。<li>全文检索只适用于char、varchar、text类型。<li>全文检索默认不区分大小写，但可以通过配置来修改。<li>全文检索可以使用 in boolean mode指定布尔模式进行搜索，也可以使用in natural language mode指定自然语言模型来进行搜索。</ul><h3 id=5-7-1、倒排索引><a class=headerlink href=#5-7-1、倒排索引 title=5.7.1、倒排索引></a>5.7.1、倒排索引</h3><p><strong>全文检索基于 倒排索引 实现，倒排索引在辅助表中存储了单词与单词在一个或多个文档中所在位置之间的映射。这通常利用关联数组实现，其有两种表现形式</strong>：<ol><li>inverted file index。其表现形式为<code>{单词, 单词所在文档的ID}</code><li>full inverted index。其变现形式为<code>{单词, (单词所在文档的ID， 在具体文档中的位置)}</code></ol><h3 id=5-7-2、InnoDB全文检索><a class=headerlink href=#5-7-2、InnoDB全文检索 title=5.7.2、InnoDB全文检索></a>5.7.2、InnoDB全文检索</h3><p><strong>InnoDB引擎采用full inverted index方式。InnoDB引擎中，将（DocumentID, Position）视为一个“ilist”，因此在全文检索表中有两个列，word字段 和 ilist字段，且word字段上设有索引。此外由于InnoDB引擎在ilist字段中存放了Position信息，故可以进行Proximity Search，而MyISAM不支持该特性。</strong><p>倒排索引需要将word存放到 Auxiliary Table（辅助表）中，它是持久表，存放于磁盘上。此外还有一个重要概念 FTS Index Cache（全文检索索引缓存），用来提高全文检索的性能。<p>FTS Index Cache是一个红黑树结构，根据（word, ilist）进行排序。InnoDB引擎会批量对 Auxiliary Table进行更新，而不是每次插入后就更新。当对全文检索进行查询时，AT首先会将FTS Index Cache中对应的word字段合并到AT中，然年再进行查询。<p><strong>可通过参数<code>innodb_ft_aux_table</code>来观察倒排索引的 Auxiliary Table。</strong><p><strong>参数<code>innodb_ft_cache_size</code>用来控制FTS Index Cache的大小，默认32M。 存满后会将其中的（word, ilist）分词信息同步到磁盘的AT中。</strong><p>要想InnoDB支持全文检索，必须有一个列与word进行映射，这个列命名为 FTS_DOC_ID，其类型必须是 BIGINT UNSIGNED NOT NULL，且InnoDB引擎会自动在该列上加入一个命名为FTS_DOC_ID_INDEX 的 Unique Index。<p>InnnoDB全文检索存在以下控制：<ol><li>每张表只能有一个全文检索索引。<li>有多列组合而成的全文检索的索引列必须使用相同的字符集与排序规则。<li>不支持没有单词界定符的语言，如中文、日语、韩语等。</ol><h3 id=5-7-3、全文检索实现><a class=headerlink href=#5-7-3、全文检索实现 title=5.7.3、全文检索实现></a>5.7.3、全文检索实现</h3><p>MySQL<strong>通过MATCH() … AGAINST()语法支持全文检索的查询，MATCH指需要被查询的列，AGAINST指定了使用何种方法进行查询</strong>。可查询模式如下 ：<ol><li><p>Natural Language：全文检索通过MATCH函数进行查询，默认采用 Natural Language模式，表示查询带有指定word的文档。</p><li><p>Boolean：使用 IN BOOLEAN MODE修饰符进行全文检索，使用该修饰符时，查询字符串的前后字符会有特殊的含义。+ 和 - 代表这个单词必须出现，或一定不出现。</p><li><p>Query Expansion：全文检索的扩展查询，该种查询通常在查询的关键词太短，用户需要implied knowledge（隐含知识）时进行。</p> <p>通过在查询短语中添加 WITH QUERY EXPANSION 或 IN NATURAL LANGUAGE MODE WITH QUERY EXPANSION 可以开启 blind query expansion（又称为automatic relevance feedback）。该查询分为两个阶段：</p> <ol><li>第一阶段：根据搜索的单词进行全文索引查询。</ol><li><p>第二阶段：根据第一阶段产生的分词再进行以此全文检索的查询。</p></ol><h2 id=5-8、索引总结><a class=headerlink href=#5-8、索引总结 title=5.8、索引总结></a>5.8、索引总结</h2><h3 id=5-8-1、索引代价><a class=headerlink href=#5-8-1、索引代价 title=5.8.1、索引代价></a>5.8.1、索引代价</h3><p><strong>（1）空间代价</strong><p>每建立一个索引都要为它建立一棵B+树，每一棵B+树的每一个节点都是一个数据页，一个页默认会占用 16KB 的存储空间，一棵很大的B+树由许多数据页组成，那就是很大一个存储空间。<p><strong>（2）时间代价</strong><p><strong>每次对表中的数据进行 增、删、改操作时，都需要去旋转优化B+树索引结构，使其符合相应规则</strong>。B+树 每层节点都是按照索引列的值 从小到大的顺序排序 组成了 双向链表 。不论是叶子节点中的记录，还是内节点中的记录（也就是不论是用户记录还是目录项记录）都是按照索引列的值从小到大的顺序 而形成了一个单向链表。而增、删、改操作可能会对节点和记录的排序造成破坏，所以存储引擎需 要额外的时间进行一些 记录移位 ， 页面分裂 、 页面回收 等操作来维护好节点和记录的排序。如果 我们建了许多索引，每个索引对应的B+树都要进行相关的维护操作，会给性能拖后腿。<h3 id=5-8-2、适合建立索引的场景><a class=headerlink href=#5-8-2、适合建立索引的场景 title=5.8.2、适合建立索引的场景></a>5.8.2、适合建立索引的场景</h3><ol><li>字段的数值有唯一性的限制。<li>频繁作为 WHERE 查询条件的字段。<li>经常 GROUP BY 和 ORDER BY 的列。<li>UPDATE、DELETE 的 WHERE 条件列。<li>DISTINCT 字段需要创建索引。<li>多表 JOIN 连接操作时，创建索引注意事项。<ol><li>连接表的数量尽量不要超过 3 张 。<li>对 WHERE 条件创建索引 。<li>用于连接的字段创建索引 。</ol><li>使用列的类型小的创建索引<li>使用字符串前缀创建索引。<li>区分度高(散列性高)的列适合作为索引。<li>使用最频繁的列放到联合索引的左侧。<li>多个字段都要创建索引的情况下，联合索引优于单值索引</ol><h3 id=5-8-3、B树与B-树的区别><a class=headerlink href=#5-8-3、B树与B-树的区别 title=5.8.3、B树与B+树的区别></a>5.8.3、B树与B+树的区别</h3><ol><li>有 k 个孩子的节点就有 k 个关键字。也就是孩子数量 = 关键字数，而 B 树中，孩子数量 = 关键字数 +1。 索引 / 存储引擎 MyISAM InnoDB Memory R-Tree索引 支持 支持 不支持<li>非叶子节点的关键字也会存在于子节点中，且在子节点中是所有关键字的最大（或最小）。<li>非叶子节点仅用于索引，不保存数据记录，跟记录有关的信息都放在叶子节点中。而 B 树中， 非 叶子节点既保存索引，也保存数据记录 。<li>所有关键字都在叶子节点出现，叶子节点构成一个有序链表，而且叶子节点本身按照关键字从小到大顺序链接。</ol><h3 id=5-8-4、索引限制><a class=headerlink href=#5-8-4、索引限制 title=5.8.4、索引限制></a>5.8.4、索引限制</h3><p>64位系统，版本5.0后，mysql 单表可支持16个索引，最大索引长度256字节。<ul><li>InnoDB: 最多1017列，最多64个二级索引，单个索引最多包含16列，索引最大长度767字节(其实行格式为REDUNDANT，COMPACT最高为767字节，但行格式为DYNAMIC，COMPRESSED最高可达为3072字节)，行大小最大65536字节。<li>MyISAM: 最多4096列，最多64个二级索引，单个索引最多包含16列，索引最大长度1000字节，行大小最大65536字节。</ul><h3 id=5-8-5、Explain关键字><a class=headerlink href=#5-8-5、Explain关键字 title=5.8.5、Explain关键字></a>5.8.5、Explain关键字</h3><h4 id=简介-8><a class=headerlink href=#简介-8 title=简介></a>简介</h4><p><strong>通过 慢查询日志 可定位查询较慢的SQL，通过explain命令可查看SQL的执行计划</strong>。<p>expain命令执行结果有12列，按顺序分别是：<strong>id、select_type、table、PARTITIONS、type、possible_keys、key、key_len、ref、rows、FILTERED、Extra</strong>。每项定义如下：：<ol><li>查询标识符，同一条查询语句id相同。<li>select_type：查询类型。<li>table：查询的表名。<li>partitions：查询的分区表名。<li>type：查询类型。<li>possible_keys：可能使用的索引。<li>key：实际使用的索引。<li>key_len：索引字段的长度。<li>ref：索引如何被使用。<li>rows：扫描行数。<li>filtered：表数据过滤百分比。<li>Extra：执行情况的描述和说明。</ol><h4 id=详解12列><a class=headerlink href=#详解12列 title=详解12列></a>详解12列</h4><p><strong>（1）ID</strong><p>SELECT识别符。这是SELECT的查询序列号。SQL从大到小的执行：<ol><li><p>id相同时，执行顺序由上至下。</p><li><p>如果是子查询，id的序号会递增，id值越大优先级越高，越先被执行。</p><li><p>id如果相同，可以认为是一组，从上往下顺序执行；在所有组中，id值越大，优先级越高，越先执行。</p></ol><p><strong>（2）SELECT_TYPE</strong><p>查询中每个select子句的类型，可选值有：<ol><li>SIMPLE（简单SELECT，不使用UNION或子查询等）。<li>PRIMARY（子查询中最外层查询，查询中若包含任何复杂的子部分，最外层的select被标记为PRIMARY）。<li>UNION（UNION中的第二个或后面的SELECT语句）。<li>DEPENDENT UNION（UNION中的第二个或后面的SELECT语句，取决于外面的查询）。<li>UNION RESULT（UNION的结果，union语句中第二个select开始后面所有select）。<li>SUBQUERY（子查询中的第一个SELECT，结果不依赖于外部查询）。<li>DEPENDENT SUBQUERY（子查询中的第一个SELECT，依赖于外部查询）。<li>DERIVED（派生表的SELECT, FROM子句的子查询）。<li>UNCACHEABLE SUBQUERY（一个子查询的结果不能被缓存，必须重新评估外链接的第一行）。</ol><p><strong>（3）TABLE</strong><p>使用到的表的名称（显示这一行的数据是关于哪张表的），有时不是真实的表名字，可能是简称，例如可能是e，d，也可能是第几步执行的结果的简称。<p><strong>（4）PARTITIONS</strong><p>官方定义为The matching partitions（匹配的分区），该字段应该是看table所在分区。值为NULL表示表未被分区。<p><strong>（5）TYPE</strong><p><strong>索取数据方式，又称“访问类型”</strong>。常用类型有： <strong>Null、system、const、eq_ref、ref、range、index、all</strong>（从左到右，性能从好到差），各项定义如下：<ol><li><p>NULL</p> <p>MySQL优化过程中分解语句，执行时甚至不用访问表或索引，例如从一个索引列里选取最小值可以通过单独索引查找完成。</p><li><p><strong>system（查询系统表）</strong></p> <p>表只有一行记录（等于系统表），是const的特例类型，平时不会出现，可以忽略不计。对于system，官网的解释：The table has only one row(=system table). This is a special case of the const join type.</p> <p>当MySQL对查询某部分进行优化，并转换为一个常量时，使用这些类型访问。如将主键置于where列表中，MySQL就能将该查询转换为一个常量，system是const类型的特例，当查询的表只有一行的情况下，使用system。</p><li><p><strong>const（主键查询）</strong></p> <p>表示通过一次索引就找到了结果，常出现于primary key或unique索引。因为只匹配一行数据，所以查询非常快。如将主键置于where条件中，MySQL就能将查询转换为一个常量。</p><li><p><strong>eq_ref（主键索引或唯一索引查询）</strong></p> <p>类似ref，区别就在使用的索引是唯一索引，对于每个索引键值，表中只有一条记录匹配，简单来说，就是多表连接中使用primary key或者 unique key作为关联条件</p><li><p><strong>ref（索引查询）</strong></p> <p>非唯一索引扫描，返回匹配某个单独值的所有行。本质上也是一种索引访问，返回匹配某值（某条件）的多行值，属于查找和扫描的混合体。</p><li><p><strong>range（范围查询）</strong></p> <p>只检索给定范围的行，使用一个索引来检索行，可以在key列中查看使用的索引，一般出现在where语句的条件中，如使用between、>、<、in等查询。</p><li><p><strong>index（索引树扫描）</strong></p> <p>Full Index Scan（全索引扫描），index与ALL的区别为 index类型只遍历索引树，通常比ALL快，因为索引文件通常比数据文件小。虽说index和ALL都是全表扫描，但是index是从索引中读取，ALL是从磁盘中读取。</p><li><p><strong>ALL（全盘扫描）</strong></p> <p>Full Table Scan（全表扫描）， MySQL将遍历全表以找到匹配的行。注：一般来说，需保证查询至少达到range级别，最好能达到ref。</p></ol><p><strong>（6）POSSIBLE_KEYS</strong><p>可以使用的索引的列表，可能一个或多个。查询涉及到的字段若存在索引，则该索引将被列出，但不一定被查询实际使用。<p><strong>（7）KEY</strong><p>实际使用的索引，如为NULL，则表示未使用索引。若查询中使用了覆盖索引，则该索引和查询的select字段重叠。<p><strong>（8）KEY_LEN</strong><p>表示索引中所使用的字节数，可通过该列计算查询中使用的索引长度。在不损失精确性的情况下，长度越短越好。key_len显示的值为索引字段的最大可能长度，并非实际使用长度，即key_len是根据表定义计算而得，并不是通过表内检索出的。<p><strong>（9）REF</strong><p>显示关联的字段。如果使用常数等值查询，则显示const，如果是连接查询，则会显示关联的字段。<p><strong>（10）ROWS</strong><p>根据表统计信息及索引选用情况大致估算出找到所需记录所要读取的行数。当然该值越小越好。<p><strong>（11）FILTERED</strong><p>百分比值，表示存储引擎返回的数据过滤后，满足查询条件的记录所占的比例。<p><strong>（12）EXTRA</strong><p>额外信息。取值范围如下：<ol><li><p><strong>Using filesort</strong>：使用外部索引排序，并没有走表索引。需要优化。</p><li><p><strong>Using temporary</strong>：使用临时表保存中间结果。常见于order by、group by，需要优化。</p><li><p><strong>Using where</strong>：存储引擎层返回行数据后，服务器层再通过WHERE条件进行过滤。需要优化。</p><li><p><strong>Using index</strong>：使用了覆盖索引。</p> <p>如果同时出现了Using where，表明索引被用来执行索引键值的查找。（where deptid=1）。</p> <p>如果没有同时出现Using where，表明索引用来读取数据而非执行查找动作。</p><li><p>Using join buffer：在获取连接条件时没有使用索引，并且需要连接缓冲区来存储中间结果。如果出现了这个值，那应该注意，根据查询的具体情况可能需要添加索引来改进。</p><li><p>Impossible where：where没有匹配到任何数据。</p><li><p>Select tables optimized awa：表示仅通过使用索引，优化器可能仅从聚合函数结果中返回一行。</p><li><p>Using MRR：使用了 Multi Range Read 优化。</p><li><p>Using index condition：使用了Index Condition Pushdown优化，即索引下推。</p></ol><h2 id=5-9、索引测试><a class=headerlink href=#5-9、索引测试 title=5.9、索引测试></a>5.9、索引测试</h2><h3 id=5-9-1、准备数据><a class=headerlink href=#5-9-1、准备数据 title=5.9.1、准备数据></a>5.9.1、准备数据</h3><p><strong>（1）创建表</strong><figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br></pre><td class=code><pre><span class=line><span class=keyword>create</span> <span class=keyword>table</span> idx_test1(</span><br><span class=line>    id <span class=type>INTEGER</span>,</span><br><span class=line>    name <span class=type>VARCHAR</span>(<span class=number>32</span>),</span><br><span class=line>    age TINYINT,</span><br><span class=line>    email <span class=type>VARCHAR</span>(<span class=number>128</span>),</span><br><span class=line>    address <span class=type>VARCHAR</span>(<span class=number>256</span>),</span><br><span class=line>    info <span class=type>VARCHAR</span>(<span class=number>512</span>)</span><br><span class=line>)</span><br><span class=line></span><br><span class=line><span class=keyword>show</span> <span class=keyword>create</span> <span class=keyword>table</span> idx_test1;</span><br></pre></table></figure><p><strong>（2）创建索引</strong><figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br></pre><td class=code><pre><span class=line># 主键索引（id）</span><br><span class=line><span class=keyword>alter</span> <span class=keyword>table</span> idx_test1 <span class=keyword>add</span> <span class=keyword>PRIMARY</span> key (id);</span><br><span class=line># 唯一索引（email）</span><br><span class=line><span class=keyword>create</span> <span class=keyword>unique</span> index idx_uq_email <span class=keyword>on</span> idx_test1(email);</span><br><span class=line># 普通索引（name）</span><br><span class=line><span class=keyword>create</span> index idx_name <span class=keyword>on</span> idx_test1(name);</span><br><span class=line># 全文索引</span><br><span class=line><span class=keyword>create</span> FULLTEXT index idx_ft_info <span class=keyword>on</span> idx_test1(info(<span class=number>20</span>)); </span><br><span class=line># 联合索引（name,age）</span><br><span class=line><span class=keyword>create</span> index idx_name_age <span class=keyword>on</span> idx_test1(name, age);</span><br><span class=line></span><br><span class=line># 删除索引</span><br><span class=line><span class=keyword>alter</span> <span class=keyword>table</span> idx_test1 <span class=keyword>drop</span> index idx_ft_info;</span><br><span class=line><span class=keyword>drop</span> index idx_ft_info <span class=keyword>on</span> idx_test1;</span><br></pre></table></figure><p><strong>（3）通过存储过程向表中插入测试数据</strong><p>一次性插入10万条数据，耗时会较长，可根据实际情况适当降低插入的数据量。<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br></pre><td class=code><pre><span class=line><span class=comment>-- 创建一个存储过程，用于向 idx_test1 表插入 10 万行数据</span></span><br><span class=line>DELIMITER <span class=operator>/</span><span class=operator>/</span></span><br><span class=line><span class=keyword>CREATE</span> <span class=keyword>PROCEDURE</span> InsertTestData()</span><br><span class=line><span class=keyword>BEGIN</span></span><br><span class=line>    <span class=keyword>DECLARE</span> i <span class=type>INT</span> <span class=keyword>DEFAULT</span> <span class=number>1</span>;</span><br><span class=line>    <span class=keyword>DECLARE</span> name_prefix <span class=type>VARCHAR</span>(<span class=number>32</span>);</span><br><span class=line>    <span class=keyword>DECLARE</span> email_domain <span class=type>VARCHAR</span>(<span class=number>128</span>);</span><br><span class=line>    <span class=keyword>DECLARE</span> address_prefix <span class=type>VARCHAR</span>(<span class=number>256</span>);</span><br><span class=line>    <span class=keyword>DECLARE</span> info_text <span class=type>VARCHAR</span>(<span class=number>512</span>);</span><br><span class=line></span><br><span class=line>    <span class=comment>-- 设置循环次数为 10 万</span></span><br><span class=line>    WHILE i <span class=operator><=</span> <span class=number>100000</span> DO</span><br><span class=line>        <span class=comment>-- 生成随机数据</span></span><br><span class=line>        <span class=keyword>SET</span> name_prefix <span class=operator>=</span> CONCAT(<span class=string>'User'</span>, i);</span><br><span class=line>        <span class=keyword>SET</span> email_domain <span class=operator>=</span> CONCAT(<span class=string>'example'</span>, i, <span class=string>'@domain.com'</span>);</span><br><span class=line>        <span class=keyword>SET</span> address_prefix <span class=operator>=</span> CONCAT(<span class=string>'Address'</span>, i);</span><br><span class=line>        <span class=keyword>SET</span> info_text <span class=operator>=</span> CONCAT(<span class=string>'Info for user'</span>, i);</span><br><span class=line></span><br><span class=line>        <span class=comment>-- 插入数据</span></span><br><span class=line>        <span class=keyword>INSERT</span> <span class=keyword>INTO</span> idx_test1 (id, name, age, email, address, info)</span><br><span class=line>        <span class=keyword>VALUES</span> (i, name_prefix, <span class=built_in>FLOOR</span>(RAND() <span class=operator>*</span> <span class=number>100</span>), email_domain, address_prefix, info_text);</span><br><span class=line></span><br><span class=line>        <span class=keyword>SET</span> i <span class=operator>=</span> i <span class=operator>+</span> <span class=number>1</span>;</span><br><span class=line>    <span class=keyword>END</span> WHILE;</span><br><span class=line><span class=keyword>END</span> <span class=operator>/</span><span class=operator>/</span></span><br><span class=line>DELIMITER ;</span><br><span class=line></span><br><span class=line><span class=comment>-- 调用存储过程来插入数据</span></span><br><span class=line><span class=keyword>CALL</span> InsertTestData();</span><br></pre></table></figure><h1 id=6、锁><a class=headerlink href=#6、锁 title=6、锁></a>6、锁</h1><h2 id=6-1、锁结构><a class=headerlink href=#6-1、锁结构 title=6.1、锁结构></a>6.1、锁结构</h2><h3 id=6-1-1、简介><a class=headerlink href=#6-1-1、简介 title=6.1.1、简介></a>6.1.1、简介</h3><p><strong>对一条记录加锁，本质上是在内存中创建一个锁结构与之关联</strong>。<p>一个事务对多条记录加锁是否需要创建多个锁结构呢？理论上可以，但实际要分情况。符合以下条件的记录会被放在一个锁结构中：<ul><li>同一个事务中进行加锁操作。<li>被加锁的记录在同一个页面中。<li>加锁类型一样。<li>等待状态一样。</ul><h3 id=6-1-2、InnoDB锁结构><a class=headerlink href=#6-1-2、InnoDB锁结构 title=6.1.2、InnoDB锁结构></a>6.1.2、InnoDB锁结构</h3><p>InnoDB锁结构图如下：</p><img style="zoom: 60%;" src=https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/06/InnoDB%E9%94%81%E7%BB%93%E6%9E%84%E5%9B%BE.png><h4 id=锁所在的事务信息><a class=headerlink href=#锁所在的事务信息 title=锁所在的事务信息></a>锁所在的事务信息</h4><p><strong>不论是 表锁 还是 行锁，都是在事务执行过程中生成的，哪个事务生成了这个锁结构 ，就记录这个事务的信息</strong>。 此锁所在的事务信息在内存结构中只是一个指针，通过指针可以找到内存中关于该事务的更多信息，比方说事务id等。<h4 id=索引信息><a class=headerlink href=#索引信息 title=索引信息></a>索引信息</h4><p>对于 行锁 来说，需要记录一下加锁的记录属于哪个索引。这里也是一个指针。<h4 id=表锁行锁信息><a class=headerlink href=#表锁行锁信息 title=表锁行锁信息></a>表锁行锁信息</h4><p>表锁结构 和 行锁结构 在这个位置的内容是不同的：<ul><li><p>表锁： 记录加锁的表和一些其它信息。</p><li><p>行锁： 记载了三个重要信息：</p> <ul><li><p>Space ID ：记录所在表空间。</p><li><p>Page Number ：记录所在页号。</p><li><p>n_bits ：对于行锁来说，一条记录就对应着一个比特位，一个页面中包含很多记录，用不同的比特位来区分到底是哪一条记录加了锁。为此在行锁结构的末尾放置了一堆比特位，这个 n_bits 属性代表使用了多少比特位。</p></ul></ul><h4 id=type-mode><a class=headerlink href=#type-mode title=type_mode></a>type_mode</h4><p>这是一个32位数，被<strong>分成了<code>lock_mode</code>、<code>lock_type</code>和<code>rec_lock_type</code>三个部分</strong>，<p>如图所示：<p><img src=https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/06/InnoDB%E9%94%81%E7%BB%93%E6%9E%84-typemodel%E5%90%84%E4%B8%AA%E4%BD%8D%E4%BD%9C%E7%94%A8%E8%A7%A3%E6%9E%90.png><ul><li><p><strong>锁的模式（ lock_mode ），占用低4位</strong>，可选值如下：</p> <ul><li>LOCK_IS （十进制的 0 ）：表示共享意向锁，也就是 IS锁 。<li>LOCK_IX （十进制的 1 ）：表示独占意向锁，也就是 IX锁 。<li>LOCK_S （十进制的 2 ）：表示共享锁，也就是 S锁 。<li>LOCK_X （十进制的 3 ）：表示独占锁，也就是 X锁 。<li>LOCK_AUTO_INC （十进制的 4 ）：表示 AUTO-INC锁 。</ul> <p>InnoDB引擎中，LOCK_IS，LOCK_IX，LOCK_AUTO_INC都算是表级锁的模式，LOCK_S和 LOCK_X既可以算是表级锁的模式，也可以是行级锁的模式。</p><li><p><strong>锁的类型（ lock_type ），占用第5～8位</strong>，不过现阶段只有第5位和第6位被使用：</p> <ul><li>LOCK_TABLE （十进制的 16 ），也就是当第5个比特位置为1时，表示表级锁。<li>LOCK_REC （十进制的 32 ），也就是当第6个比特位置为1时，表示行级锁。</ul><li><p><strong>行锁具体类型（ rec_lock_type ）使用其余位来表示</strong>。lock_type 是 LOCK_REC 时，也就是该锁为行级锁时才会被细分为更多类型：</p> <ul><li>LOCK_ORDINARY （十进制的 0 ）：表示 next-key锁 。<li>LOCK_GAP （十进制的 512 ）：也就是当第10个比特位置为1时，表示 gap锁 。<li>LOCK_REC_NOT_GAP （十进制的 1024 ）：也就是当第11个比特位置为1时，表示正经记录锁 。<li>LOCK_INSERT_INTENTION （十进制的 2048 ）：也就是当第12个比特位置为1时，表示插入意向锁。其他的类型：还有一些不常用的类型我们就不多说了。</ul><li><p>is_waiting，为节省内存空间，把 is_waiting 属性放到了 type_mode 这个32 位的数字中：</p> <ul><li>LOCK_WAIT （十进制的 256 ） ：当第9个比特位置为 1 时，表示 is_waiting 为 true ，也 就是当前事务尚未获取到锁，现处于等待状态；当这个比特位为 0 时，表示 is_waiting 为 false ，也就是当前事务获取锁成功。</ul></ul><h4 id=其他信息><a class=headerlink href=#其他信息 title=其他信息></a>其他信息</h4><p>为更好的管理系统运行过程中生成的各种锁结构，设计了各种哈希表和链表。<h4 id=一堆比特位><a class=headerlink href=#一堆比特位 title=一堆比特位></a>一堆比特位</h4><p>行锁结构末尾会放置一堆比特位，比特位的数量是由上边提到的 n_bits 属性值决定。InnoDB数据页中每条记录的记录头中都包含一个 heap_no 属性，伪记录 Infimum 的 heap_no 值为 0 ， Supremum 的 heap_no 值为 1 ，之后每插入一条记录heap_no 值就增1。 锁结构最后的一堆比特位就对应着一个页面中的记录，一个比特位映射一个 heap_no ，即一个比特位 映射 页内一条记录。<h2 id=6-2、锁实现><a class=headerlink href=#6-2、锁实现 title=6.2、锁实现></a>6.2、锁实现</h2><h3 id=6-2-1、锁分类><a class=headerlink href=#6-2-1、锁分类 title=6.2.1、锁分类></a>6.2.1、锁分类</h3><h4 id=整体划分><a class=headerlink href=#整体划分 title=整体划分></a>整体划分</h4><p>从不同角度来划分不同类型的锁，其详细表示如下：<ul><li>基于 操作类型 可划分为 2 种：<ul><li>读锁 / 共享锁<li>写锁 / 排它锁。</ul><li>基于 锁粒度 可划分为 3 种：<ul><li>表锁：表级别S锁、X锁；意向锁；自增锁；MDL锁；<li>行锁：Record Locks；Gap Locks；Next-Key Locks；插入意向锁；<li>页锁</ul><li>基于 锁态度 可划分为 2 种：<ul><li>悲观锁<li>乐观锁</ul><li>基于 加锁方式 可划分为 2 种：<ul><li>隐式锁<li>显式锁</ul></ul><h4 id=InnoDB锁><a class=headerlink href=#InnoDB锁 title=InnoDB锁></a>InnoDB锁</h4><p><strong>InnoDB引擎支持表锁、行锁、页锁</strong>。<p>行锁分类：<ol><li>共享锁，允许事务读一行数据。<li>排他锁，允许事务删除或更新一行数据。</ol><p>表锁分类：<ol><li>意向共享锁，事务想要获得一张表中某几行的共享锁。<li>意向排他锁，事务想要获得一张表中某几行的排他锁。</ol><p>行锁与表锁兼容性如下：<p><img alt=image-20200814173602295 src=https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/06/image-20200814173602295.png><blockquote><p>InnoDB 1.0开始，INFORMATION_SCHEMA 架构下新增了三张表：INNODB_TRX、INNODB_LOCKS、INNODB_LOCK_WAITS。通过这三张表可以监控当前事务并分析可能存在的问题。</blockquote><h4 id=MyISAM锁><a class=headerlink href=#MyISAM锁 title=MyISAM锁></a>MyISAM锁</h4><p><strong>MyISAM引擎支持表锁</strong>。<h3 id=6-2-2、表锁><a class=headerlink href=#6-2-2、表锁 title=6.2.2、表锁></a>6.2.2、表锁</h3><h4 id=简介-9><a class=headerlink href=#简介-9 title=简介></a>简介</h4><p>表锁会锁定整张表，它是MySQL锁的基本策略，不依赖于存储引擎。表锁可以避免死锁问题，但同时降低了并发。<h4 id=表级S锁-X锁><a class=headerlink href=#表级S锁-X锁 title=表级S锁/X锁></a>表级S锁/X锁</h4><p><strong>表级别的S锁、X锁一般不会使用，只会在 崩溃恢复 等特殊场景中使用</strong>。<p>对于InnoDB引擎来说，表级别的S锁和X锁不仅不会提供保护，反而会降低并发能力。<p>表级别S锁/X锁使用方式如下：<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line>-- 表级S锁</span><br><span class=line>LOCK TABLES T READ</span><br><span class=line>-- 表级X锁</span><br><span class=line>LOCK TABLES T WRITE</span><br></pre></table></figure><h4 id=意向锁（自动）><a class=headerlink href=#意向锁（自动） title=意向锁（自动）></a>意向锁（自动）</h4><p><strong>InnoDB引擎支持多粒度锁，它允许行锁与表锁共存，而意向锁就是表锁的一种</strong>。<p>意向锁作用如下：<ul><li>协调行锁与读锁的关系，支持多粒度锁并存。<li>表明表中已经有事务正在获取锁，或已经获取了锁，其它线程无需再尝试。</ul><p>意向锁由存储引擎维护，用户无需干预。在对数据行加共享锁、排它锁之前，InnoDB引擎会先获取该表的意向锁。<p>意向锁分为两种：<ul><li>意向共享锁：事务对表中行记录加共享锁时，InnoDB会自动为表级别加意向共享锁。<li>意向排它锁：事务对表中行记录加排它锁时，InnoDB会自动为表级别加意向排它锁。</ul><h4 id=自增锁（自动）><a class=headerlink href=#自增锁（自动） title=自增锁（自动）></a>自增锁（自动）</h4><h5 id=简介-10><a class=headerlink href=#简介-10 title=简介></a>简介</h5><p><strong>InnoDB的内存结构中，每个含有自增长值的表都有一个自增长计数器。当对含有计数器的表执行插入操作时，这个计数器会被初始化</strong>。执行下列语句来得到计数器的值：<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line><span class=keyword>SELECT</span> <span class=built_in>MAX</span>(auto_inc_col) <span class=keyword>FROM</span> t <span class=keyword>FOR</span> <span class=keyword>UPDATE</span>;</span><br></pre></table></figure><p><strong>插入操作会初始化自增长列的计数器值，这种方式称为AUTO-INC Locking</strong>。这种锁其实采用的是一种特殊的表锁机制，为了提高插入性能，锁不是在一个事务完成后才释放，而是执行完SQL后立即释放。<p>AUTO-INC Locking缺点：<ol><li>对于有自增长值的列的并发插入性能较差，事务必须等待前一个插入的完成。<li>对于INSERT … SELECT的大数据量的插入会影响插入性能，因为另一个事务会被阻塞。</ol><h5 id=自增长模式><a class=headerlink href=#自增长模式 title=自增长模式></a>自增长模式</h5><p>MySQL 5.1.22开始，InnoDB提供了一种轻量级互斥量的自增长实现机制，该机制极大提高了自增长值的插入性能。其可以通过参数<code>innodb_autoinc_lock_mode</code>来控制自增长模式，参数默认值为1，可选值有0、1、2。<p><img alt=image-20201214194656633 src=https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/06/image-20201214194656633.png><p>InnoDB引擎和MyISAM的自增长实现不同，InnoDB中，自增长值的列必须是索引，同时必须是索引的第一个列，否则会抛出错误。而MyISAM没有这个问题。<h4 id=元数据锁（自动）><a class=headerlink href=#元数据锁（自动） title=元数据锁（自动）></a>元数据锁（自动）</h4><p><strong>MySQL 5.7 引入了 meta data lock，简称 MDL 锁，属于表锁范畴</strong>。<p>MDL锁会自动添加，无需显式使用，MDL锁作用是保证读写正确性。当对一个表执行 增删改查 操作时会加 MDL 读锁；当对 表结构 做改变时会加 MDL 写锁。读锁之间不互斥，写锁之间、写读锁之间是互斥的。<h3 id=6-2-3、行锁><a class=headerlink href=#6-2-3、行锁 title=6.2.3、行锁></a>6.2.3、行锁</h3><h4 id=6-2-3-1、简介><a class=headerlink href=#6-2-3-1、简介 title=6.2.3.1、简介></a>6.2.3.1、简介</h4><p>行锁有如下特点：<p><strong>（1）两个“原则”</strong><ol><li>加锁的基本单位是next-key lock，next-key lock是前开后闭区间。<li>查找过程中访问到的对象才会加锁。</ol><p><strong>（2）两个“优化”</strong><ol><li>索引上的等值查询，给唯一索引加锁时，next-key lock会变为Record Lock（记录锁）。<li>索引上的等值查询，向右遍历时且最后一个值不满足等值条件时，next-key lock会变为间隙锁。</ol><p><strong>（3）一个“bug”</strong><ol><li>唯一索引上的范围查询会访问到不满足条件的第一个值为止。</ol><h4 id=6-2-3-2、记录锁（Record-Lock）><a title="6.2.3.2、记录锁（Record Lock）" class=headerlink href=#6-2-3-2、记录锁（Record-Lock）></a>6.2.3.2、记录锁（Record Lock）</h4><p><strong>记录锁，仅仅锁住索引记录的一行，在单条索引记录上加锁</strong>。<p>record lock锁住的永远是索引，而非记录本身，即使该表上没有任何索引，那么innodb会在后台创建一个隐藏的聚集主键索引。<p>所以说当一条sql没有走任何索引时，那么将会在每一条聚合索引后面加X锁，这个类似于表锁，但原理上和表锁应该是完全不同的。<h4 id=6-2-3-3、间隙锁（Gap-Lock）><a title="6.2.3.3、间隙锁（Gap Lock）" class=headerlink href=#6-2-3-3、间隙锁（Gap-Lock）></a>6.2.3.3、间隙锁（Gap Lock）</h4><p><strong>间隙锁，仅仅锁住一个索引区间（开区间，不包括双端端点）</strong>。在索引记录之间的间隙中加锁，或者是在某一条索引记录之前或者之后加锁，并不包括该索引记录本身。<p>间隙锁可用于防止幻读，保证索引间不会插入新数据。<p><strong>显式关闭 Gap Lock 的两种方式</strong>：<ol><li>将事务的隔离级别设为 READ COMMITED。<li>将参数 <code>innodb_locks_unsafe_for-binlog</code> 设为1。</ol><h4 id=6-2-3-4、临键锁（Next-Key-Lock）><a title="6.2.3.4、临键锁（Next-Key Lock）" class=headerlink href=#6-2-3-4、临键锁（Next-Key-Lock）></a>6.2.3.4、临键锁（Next-Key Lock）</h4><p><strong>Next-Key Lock = Gap Lock + Record Lock，锁定一个范围，且锁定记录本身， 左开右闭区间</strong>。<p>默认情况下，innodb使用next-key locks来锁定记录。当查询的索引含有唯一属性时，Next-Key Lock 会进行优化，将其降级为Record Lock。<p>Next-Key Lock在不同场景中会退化：<ol><li>使用 unique index 精确匹配，且记录存在，则会退化为 记录锁。<li>使用 unique index 精确匹配，但记录不存在，则会退化为 间隙锁。<li>使用 unique index 范围匹配，则会退化为 临键锁。</ol><h4 id=6-2-3-5、插入意向锁><a class=headerlink href=#6-2-3-5、插入意向锁 title=6.2.3.5、插入意向锁></a>6.2.3.5、插入意向锁</h4><h5 id=简介-11><a class=headerlink href=#简介-11 title=简介></a>简介</h5><p><strong>一个事务插入一条记录时会判断插入位置是否被加了GAP锁（next-key 包含 gap 锁），如果存在 gap 锁，则插入操作需要等待，直到 gap 锁被释放。InnoDB规定事务等待时需要在内存中生成一个锁结构，表明有事务想在某个间隙插入新记录，但目前处于等待状态。InnoDB称该种锁为<code>LOCK_INSERT_TNTENTION</code>，意为插入意向锁</strong>。<p>插入意向锁是一种GAP锁，而不是意向锁，在插入时产生。<h5 id=特性><a class=headerlink href=#特性 title=特性></a>特性</h5><p>插入意向锁是插入一条记录前，由插入操作产生的一种间隙锁。插入意向锁的特性分为两种：<ul><li>插入意向锁是一种特殊的间隙锁。<li>插入意向锁之间不互斥。</ul><p>插入意向锁不会排斥其它任何类型的锁。<h3 id=6-2-4、页锁><a class=headerlink href=#6-2-4、页锁 title=6.2.4、页锁></a>6.2.4、页锁</h3><h4 id=简介-12><a class=headerlink href=#简介-12 title=简介></a>简介</h4><p>页锁开销介于表锁和行锁之间，会出现死锁。锁定粒度介于表锁与行锁之间，并发度一般。<h3 id=6-2-5、读写锁><a class=headerlink href=#6-2-5、读写锁 title=6.2.5、读写锁></a>6.2.5、读写锁</h3><h4 id=简介-13><a class=headerlink href=#简介-13 title=简介></a>简介</h4><p>读写锁可以加在表上，也可以加在行上。<h4 id=加读锁><a class=headerlink href=#加读锁 title=加读锁></a>加读锁</h4><p>在 SELECT 语句后加上 LOCK IN SHARE MODE，即可实现为读取的记录加 读锁（共享锁）。<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>SELECT ... FROM TABLE_NAME WHERE ... LOCK IN SHARE MODE;</span><br></pre></table></figure><p>当指定记录被加上S锁后，其它事务可继续对该记录加S锁，但不可加X锁。其它事务加X锁会被阻塞，直到当前记录上的S锁被释放。<h4 id=加写锁><a class=headerlink href=#加写锁 title=加写锁></a>加写锁</h4><p>在 SELECT 语句后加上 FOR UPDATE，即可实现为读取的记录加 写锁（排它锁）。<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>SELECT ... FROM TABLE_NAME WHERE ... FOR UPDATE;</span><br></pre></table></figure><p>当指定记录被加上X锁后，其它事务不能加X锁，也不能加S锁。其他事务加X锁、S锁都会被阻塞，知道当前记录上的X锁被释放。<blockquote><p>MySQL 5.7 之前，SELECT…FOR UPDATE 获取不到锁时会一直等待，直到参数<code>innodb_lock_wait_timeout</code>设置的超时时间。MySQL 8.0中，SELECT…FOR UPDATE、SELECT…FOR SHARE 添加了NOWAIT、SKIP LOCKED语法，可跳过锁等待。<p>如果当前记录已经加了锁，那么NOWAIT会跳过锁等待立即返回；SKIP LOCKED也会立即返回，但返回结果中不包含被锁定的记录。</blockquote><h3 id=6-2-6、全局锁><a class=headerlink href=#6-2-6、全局锁 title=6.2.6、全局锁></a>6.2.6、全局锁</h3><p><strong>全局锁是对整个数据库实例加锁，当需要让整个库为只读状态时，就需要使用全局锁</strong>。<p>全局锁典型使用场景：全库逻辑备份。<p>全局锁命令如下：<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>FLUSH TABLES WITH READ LOCK;</span><br></pre></table></figure><h3 id=6-2-7、一致性读><a class=headerlink href=#6-2-7、一致性读 title=6.2.7、一致性读></a>6.2.7、一致性读</h3><h4 id=一致性非锁定读><a class=headerlink href=#一致性非锁定读 title=一致性非锁定读></a>一致性非锁定读</h4><p>一致性非锁定读是指： InnoDB从 行的多个版本 中读取数据。如果正在被读取的行正在被执行 DELETE、UPDATE 操作，此时读取操作不会阻塞，它会去读取行的一个快照数据。<p>快照数据是行数据之前的版本，其通过undo段来实现。undo用来在事务中回滚数据，因此快照数据没有额外开销。<strong>一个行记录可能不止一个快照数据，我们称之为行多版本技术，由此带来的控制，称为多版本并发控制（Multi Version Concurrency Control, MVCC）</strong>。<p>不同事务隔离级别下，InnoDB一致性非锁定读 的 读取方式不同：<ol><li><p>READ COMMITTED：读取最新快照数据。</p><li><p>REPEATABLE READ：读取事务开始时的行数据版本。</p></ol><h4 id=一致性锁定读><a class=headerlink href=#一致性锁定读 title=一致性锁定读></a>一致性锁定读</h4><p>InnoDB对于SELECT语句支持两种一致性锁定读操作：<ol><li><p>SELECT … FOR UPDATE：对读取的行加一个X锁，同时其它事务不能加任何锁。</p><li><p>SELECT … LOCK IN SHARE MODE：对读取的行加一个S锁，同时其它事务可以加S锁，但不能加X锁。</p></ol><p><font color=red>注意：以上两种操作必须在一个事务中，当事务提交了，锁也就释放了。因此在使用以上两种操作时，务必加上BEGIN、START TRANSACTION 或 SET AUTOCOMMIT = 0。</font><h3 id=6-2-8、外键和锁><a class=headerlink href=#6-2-8、外键和锁 title=6.2.8、外键和锁></a>6.2.8、外键和锁</h3><p>对于一个外键列，如果没有加索引，InnoDB会自动为其添加一个索引，这样可以避免表锁。<p>对外键插入或更新时，会先查询父表记录，且会使用SELECT … LOCK IN SHARE MODE 为父表加S锁。<h3 id=6-2-9、lock与latch><a class=headerlink href=#6-2-9、lock与latch title=6.2.9、lock与latch></a>6.2.9、lock与latch</h3><p><strong>数据库中lock与latch都可以称为“锁”，但两者有着截然不同的含义</strong>。<h4 id=6-2-9-1、Latch><a class=headerlink href=#6-2-9-1、Latch title=6.2.9.1、Latch></a>6.2.9.1、Latch</h4><p>latch称为闩锁（轻量级锁），要求锁定的时间要短，时间长会降低应用性能。InnoDB中，latch又分为mutex（互斥量）和rwlock（读写锁），其目的是用来保证并发线程操作临界资源的正确性，且通常没有死锁检测机制。<p>InnoDB中可以通过参数 <code>SHOW ENGINE INNODB MUTEX</code>来查看latch状况。输出结果说明如下：<p><img alt=image-20201214164811212 src=https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/06/image-20201214164811212.png><h4 id=6-2-9-2、Lock><a class=headerlink href=#6-2-9-2、Lock title=6.2.9.2、Lock></a>6.2.9.2、Lock</h4><p><strong>lock的对象是事务，且lock的对象仅在事务commit或rollback后释放。此外，lock没有死锁机制</strong>。<h4 id=Lock-VS-Latch><a title="Lock VS Latch" class=headerlink href=#Lock-VS-Latch></a>Lock VS Latch</h4><p><img alt=image-20200814172748394 src=https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/06/image-20200814172748394.png><h2 id=6-3、锁问题><a class=headerlink href=#6-3、锁问题 title=6.3、锁问题></a>6.3、锁问题</h2><h3 id=6-3-1、脏读><a class=headerlink href=#6-3-1、脏读 title=6.3.1、脏读></a>6.3.1、脏读</h3><h4 id=定义><a class=headerlink href=#定义 title=定义></a>定义</h4><p>脏页是指缓冲池中已修改但没有刷新到磁盘中的页。<p>脏数据是指：事务对缓冲池中行记录的修改，且还没有提交。<p>脏读是指：在不同事务下，当前事务可以读到其他事务未提交的数据，简单来说就是可以读到脏数据。<h4 id=解决方法><a class=headerlink href=#解决方法 title=解决方法></a>解决方法</h4><p>使用 READ COMMITTED 隔离级别 可解决脏读问题。<h3 id=6-3-2、不可重复度><a class=headerlink href=#6-3-2、不可重复度 title=6.3.2、不可重复度></a>6.3.2、不可重复度</h3><h4 id=定义-1><a class=headerlink href=#定义-1 title=定义></a>定义</h4><p>不可重复读是指：同一事务下的同一SQL，两次执行返回的结果不同。<h4 id=解决方法-1><a class=headerlink href=#解决方法-1 title=解决方法></a>解决方法</h4><p>使用 REPEATABLE READ 隔离级可解决 不可重复读问题。<h3 id=6-3-3、幻读><a class=headerlink href=#6-3-3、幻读 title=6.3.3、幻读></a>6.3.3、幻读</h3><h4 id=定义-2><a class=headerlink href=#定义-2 title=定义></a>定义</h4><p>幻读（Phantom Problem）指：在同一事物下，两次执行同一句SQL，其结果不同，第二次执行结果中存在第一次执行后不存在的行。<h4 id=解决方法-2><a class=headerlink href=#解决方法-2 title=解决方法></a>解决方法</h4><p>默认事务隔离级别下，即REPEATABLE READ下，InnoDB引擎采用<strong>Next-Key Locking机制</strong>来避免Phantom Problem（幻读问题）。<h3 id=6-3-4、丢失更新><a class=headerlink href=#6-3-4、丢失更新 title=6.3.4、丢失更新></a>6.3.4、丢失更新</h3><p>丢失更新是指：<strong>一个事务的更新操作会被另一个事务的更新操作所覆盖，从而导致数据的不一致</strong>。<h3 id=6-3-5、阻塞><a class=headerlink href=#6-3-5、阻塞 title=6.3.5、阻塞></a>6.3.5、阻塞</h3><p>因为不同锁之间的兼容性关系，一个事务中的锁需要等待另一个事务中的锁释放占用的资源，该场景被称为阻塞。阻塞并不是一件坏事，其是为了确保事务并发且正常的执行。<p>InnoDB引擎中，动态参数<code>innodb_lock_wait_timeout</code>用来控制等待时间（默认50s），静态参数<code>innodb_rollback_on_timeout</code>用来设定是否在等待超时时对执行中的事务执行回滚操作（默认OFF，不回滚）。<h3 id=6-3-6、死锁><a class=headerlink href=#6-3-6、死锁 title=6.3.6、死锁></a>6.3.6、死锁</h3><h4 id=简介-14><a class=headerlink href=#简介-14 title=简介></a>简介</h4><p>死锁是指：<strong>两个或两个以上的事务在执行过程中，因争夺锁资源而造成的一种互相等待的现象</strong>。除了超时机制，当前数据库普遍采用<code>wait-for-graph</code>（等待图）方式来执行死锁检测。InnoDB引擎也采用这种方式。<p>wait-for graph 的死锁检测通常采用 深度优先算法实现。InnoDB 1.2之前，采用递归方式实现，1.2开始，将递归用非递归的方式实现。<p><code>wait-forgraph</code>要求数据库保存以下两种信息：<ol><li>锁的信息链表。<li>事务等待链表。</ol><h4 id=死锁概率><a class=headerlink href=#死锁概率 title=死锁概率></a>死锁概率</h4><p>死锁应该较少发生才合适，若经常性发生，则系统是不可用的。此外死锁次数还要少于等待次数。<p>事务发生死锁的概率与以下几点相关：<ol><li>系统中事务的数量，事务越多发生死锁的概率越大。<li>每个事务操作的数量（r），每个事务操作的数量越多，其概率越大。<li>操作数据的集合，越小则概率越大。</ol><h2 id=6-4、锁升级><a class=headerlink href=#6-4、锁升级 title=6.4、锁升级></a>6.4、锁升级</h2><p><strong>每个层级的锁数量是有限制的，锁空间大小也有限。当某个层级的锁数量超过该层级阈值时会进行锁升级</strong>。<p><strong>锁升级就是用更大粒度的锁 替代 更小粒度的锁。比如行锁升级为表锁</strong>。<p>升级可以降低锁空间占用，但同时会降低并发度。<p><font color=red>注意：InnoDB中不存在锁升级。因为行锁的产生不依赖于每一条数据记录，而是根据每个事务访问的每个页对锁进行管理，采用的是“位图”方式，因此不管事务锁住页中一个记录还是多个记录，其开销通常都是一样的。</font><h2 id=6-5、锁监控><a class=headerlink href=#6-5、锁监控 title=6.5、锁监控></a>6.5、锁监控</h2><h3 id=6-5-1、innodb-row-lock监控><a class=headerlink href=#6-5-1、innodb-row-lock监控 title=6.5.1、innodb_row_lock监控></a>6.5.1、innodb_row_lock监控</h3><p><strong>一般可以通过检查 InnoDB_row_lock 状态变量来监控锁使用情况</strong>。<p>对各个状态量的说明如下：<ul><li>Innodb_row_lock_current_waits：当前正在等待锁定的数量；<li>Innodb_row_lock_time_max：系统启动到现在等待最常的一次所花的时间；<li>Innodb_row_lock_waits ：系统启动后到现在总共等待的次数；（等待总次数）<li>Innodb_row_lock_time ：系统启动到现在锁定总时间长度；（等待总时长）<li>Innodb_row_lock_time_avg ：每次等待所花平均时间；（等待平均时长）</ul><h3 id=6-5-2、其它监控><a class=headerlink href=#6-5-2、其它监控 title=6.5.2、其它监控></a>6.5.2、其它监控</h3><p><strong>MySQL把事务和锁的信息记录在了<code>information_schema</code>库中，涉及到的三张表分别是 INNODB_TRX 、 INNODB_LOCKS 和 INNODB_LOCK_WAITS</strong> 。<p>MySQL5.7及之前 ，可以通过information_schema.INNODB_LOCKS查看事务的锁情况，但只能看到阻塞事务的锁；如果事务并未被阻塞，则在该表中看不到该事务的锁情况。<p>MySQL8.0删除了<code>information_schema.INNODB_LOCKS</code>，可通过<code>performance_schema.data_locks</code>查看事务的锁情况，<code>performance_schema.data_locks</code>不但可以看到阻塞该事务的锁，还可以看到该事务所持有的锁。<h1 id=7、事务><a class=headerlink href=#7、事务 title=7、事务></a>7、事务</h1><p><strong>事务是数据库区别于文件系统的重要特性之一。InnoDB中的事务完全符合ACID特性</strong>。<h2 id=7-1、认识事务><a class=headerlink href=#7-1、认识事务 title=7.1、认识事务></a>7.1、认识事务</h2><h3 id=7-1-1、概述><a class=headerlink href=#7-1-1、概述 title=7.1.1、概述></a>7.1.1、概述</h3><p><strong>事务由一条非常简单的SQL语句组成，也可以由一组非常复杂的SQL语句组成。事务是访问并更新数据库中各数据项的一个程序执行单元。事务中的操作要么都执行，要么都不执行</strong>。<p>事务有着严格的定义，它必须满足四个特性：<ul><li><strong>A（Atomicity）</strong>：原子性。是指整个数据库事务是不可再分割的工作单位。<li><strong>C（Consistency）</strong>：一致性。是指事务将数据库从一种状态转为另一种状态，且事务开始前和结束后，数据库的完整性约束没有被破坏。<li><strong>I（Isolation）</strong>：隔离性。也可被称为并发控制、科串行化、锁等。事务间相互隔离，谁也不影响谁。<li><strong>D（Durability）</strong>：持久性。事务一旦提交就是永久性的。</ul><h3 id=7-1-2、分类><a class=headerlink href=#7-1-2、分类 title=7.1.2、分类></a>7.1.2、分类</h3><p>理论角度来说，可把事务分为以下几种类型：<ol><li><p><strong>扁平事务（Flat Transactions）</strong></p> <p>最简单的一种事务，生产环境中使用较频繁的事务。扁平事务中，所有操作都处于一层，由<code>BEGIN WORK</code>开始，由<code>COMMIT WORK</code>或<code>ROLLBACK WORK</code>结束，期间的操作都是原子的，要么都执行，要么都回滚。</p> <p>扁平事务的限制是不能提交或者回滚事务的一部分，或几个步骤进行提交。</p><li><p><strong>带有保存点的扁平事务（Flat Transaction With Savepoints）</strong></p> <p>支持扁平事务的所有功能外，还允许在事务执行过程中回滚到同一事物中较早的一个状态。某些事务在执行过程中出现的错误并不会导致所有操作都无效，放弃整个事务的话就不太现实。保存点用来通知系统应该记住事务当前状态，以便发生错误时，能回到保存点当时的状态。</p><li><p><strong>链事务</strong></p> <p>该事务可以看作是保存点模式的一种变种。有保存点的扁平事务，在系统崩溃时，其保存点都将消失，这意味着进行恢复时，会从开始处重新执行，而不能从最近的一个保存点继续执行。</p> <p>链事务的思想：提交一个事务时，释放不需要的数据对象，将必要的处理上下文隐式地传给下一个要开始的事务。要注意的是——提交事务操作和开始下一个事务操作将合并为一个原子操作。</p><li><p><strong>嵌套事务</strong></p> <p>是一个层次结构框架。由一个顶层事务控制着各个层次的事务。顶层事务下嵌套的事务被称为子事务，其控制着每一个局部的变换。</p><li><p><strong>分布式事务</strong></p> <p>通常是一个在分布式环境下运行的扁平事务，因此需要根据数据所在位置来访问网络中的不同节点。</p></ol><h2 id=7-2、事务实现><a class=headerlink href=#7-2、事务实现 title=7.2、事务实现></a>7.2、事务实现</h2><p>原子性、一致性、持久性通过数据库的<code>redo log</code>和<code>undo log</code>来完成。<p><strong><code>redo log</code>称为重做日志，是物理日志。保证了事务的持久性</strong>。<p><strong><code>undo log</code>称为回滚日志，是逻辑日志。保证了事务的一致性。实现了事务回滚 和 MVCC功能</strong>。<h3 id=7-2-1、redo><a class=headerlink href=#7-2-1、redo title=7.2.1、redo></a>7.2.1、redo</h3><h4 id=基本概念><a class=headerlink href=#基本概念 title=基本概念></a>基本概念</h4><p><strong>重做日志 用来实现 事务持久性</strong>。其由两部分组成：<ol><li>内存中的重做日志缓冲，是易失的。<li>重做日志文件（redo log file），是持久的。</ol><p>InnoDB引擎通过Force Log at Commit机制实现事务的持久性，即当事务提交时，必须先将该事务的所有日志写入到重做日志文件进行持久化，待COMMIT操作完成才算完成。<p><strong>为确保日志每次都能被正确写入重做日志文件，则每次将缓冲数据写入文件时都要调用一次 fsync操作。由于重做日志文件的打开没有使用 O_DIRECT选项，因此重做日志缓冲先写入文件系统缓存。为了确保写入磁盘，必须进行一次 fsync操作</strong>。<p><strong>参数 <code>innodb_flush_log_at_trx_commit</code> 用来控制重做日志刷新到磁盘的策略</strong>，可选值有0、1、2：<ul><li>0：事务提交时不会立即执行重做日志写操作，而是让Master Thread每秒调用fsync进行刷盘为主。<li>1 ：事务提交时必须调用一次 fsync操作。<li>2：事务提交时将重做日志写入重做日志文件，但仅写入文件系统的缓存，不进行fsync操作。</ul><h4 id=log-buffer><a title="log buffer" class=headerlink href=#log-buffer></a>log buffer</h4><h5 id=log-block><a title="log block" class=headerlink href=#log-block></a>log block</h5><p><strong>InnoDB中，重做日志以 块 的方式进行保存，称之为重做日志块，每块大小 512 字节。其大小和磁盘扇区大小一样，因此重做日志写入可以保证原子性，无需 doublewrite技术</strong>。<p>重做日志块由3部分组成：<ol><li><p><strong>日志块头（12字节）</strong></p> <p>日志块头由4部分组成：</p> <ol><li><p>LOG_BLOCK_HDR_NO（4字节）：log buffer由log block组成，log buffer内部好似一个数组，因此该选项用来标记log block在数组中的位置。</p><li><p>LOG_BLOCK_HDR_DATA_LEN（2字节）：表示log block所占用的大小。</p><li><p>LOG_BLOCK_FIRST_REC_GROUP（2字节）：表示 log block 中第一个日志所在的偏移量，如果和2标题相同，表示当前 log block 不包含新的日志。</p><li><p>LOG_BLOCK_CHECKPOINT_NO（4字节）：表示 log block 最后被写入时的检查点第 4 字节的值。</p></ol><li><p><strong>日志内容（492字节）</strong></p><li><p><strong>日志块尾（8字节</strong>）</p> <p>由 1个部分组成：LOG_BLOCK_TRL_NO（4字节），其值和LOG_BLOCK_HDR_NO相同（在函数 log_block_init中被初始化）。</p></ol><h4 id=redo-log-文件><a title="redo log 文件" class=headerlink href=#redo-log-文件></a>redo log 文件</h4><h5 id=redo-log-格式><a title="redo log 格式" class=headerlink href=#redo-log-格式></a>redo log 格式</h5><p>不同的数据库操作会有对应的重做日志格式，InnoDB的存储管理是基于页的，故格式也是基于页的。虽然格式不同，但有着通用的头部格式。</p><img alt=image-20201214212237416 src=https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/06/image-20201214212237416.png style=zoom:150%;><p>通用头部格式由3部分组成：<ol><li>redo_log_type：重做日志的类型。<li>space：表空间ID。<li>page_no：页的偏移量。<li>redo log body：重做日志体</ol><p><strong>InnoDB 1.2.x 时，一共有51种重做日志类型</strong>。<h5 id=redo-log-group><a title="redo log group" class=headerlink href=#redo-log-group></a>redo log group</h5><p><strong>log group为重做日志组，其中有多个重做日志文件。虽然源码中支持 log group 的镜像功能，但在 ha_innobase.cc 文件中禁止了该功能。因此InnoDB实际只有一个 log group</strong>。<p>log group由多个重做日志文件组成，其中每个日志文件的大小一样，且在InnoDB 1.2.x 前，重做日志文件的总大小要小于 4G（不包括4G），1.2.x开始重做日志文件总大小限制提高为 512G.<p>InnoDB运行中，log buffer会将内存中的 log block以一种规则刷新到磁盘，这个规则如下：<ol><li>事务提交时。<li>当 log buffer 中有一半的内存空间已经被使用时。<li>log checkpoint时。</ol><p><strong>log block 的写入追加在 redo log file 的最后部分，当一个 redo log file 被写满时，会接着写下一个 redo log file，其使用的方式为 round-robin（轮询调度）</strong>。<p>可能认为 redo log file 的写入是顺序的，其实不然，因为每个 redo log file 的前2K部分不保存 log block 信息，而是4个512字节的块，4个块的内容如下：<ol><li>log file header（512字节）<li>checkpoint1（512字节）<li>空（512字节）<li>checkpoint2（512字节）</ol><p><font color=red>注意：上述这几项信息仅在每个 log group 中的第一个 redo log file中进行存储，其它redo log file中仅保留这些空间，但不保存上述这些信息。</font><h4 id=LSN><a class=headerlink href=#LSN title=LSN></a>LSN</h4><p><strong>LSN是 Log Sequence Number 的缩写，代表日志序列号。InnoDB中，LSN占用 8 字节，且单调递增</strong>。<p>LSN含义有：<ol><li>重做日志写入总量。<li>checkpoint位置。<li>页的版本。</ol><p><strong>Log sequence number 表示当前的LSN，Log flushed up to 表示刷新到重做日志文件的LSN，Last checkpoint at 表示刷新到磁盘的LSN</strong>。<h4 id=恢复><a class=headerlink href=#恢复 title=恢复></a>恢复</h4><p><strong>InnoDB在启动时会尝试进行恢复操作。因为重做日志是物理日志，因此恢复的速度比逻辑日志要快。与此同时InnoDB自身也对此进行了优化，如顺序读取及并行应用重做日志</strong>。<p>由于 checkpoint 表示已经刷新到磁盘页上的LSN，因此恢复时只需恢复LSN开始的日志部分。<h3 id=7-2-2、undo><a class=headerlink href=#7-2-2、undo title=7.2.2、undo></a>7.2.2、undo</h3><h4 id=基本概念-1><a class=headerlink href=#基本概念-1 title=基本概念></a>基本概念</h4><p><strong>undo日志为事务回滚提供服务</strong>。<p><strong>redo存放于日志文件中，undo存放在数据库内部一个段中，这个段称为 undo段。undo段位于共享表空间中</strong>。<p>InnoDB回滚时，实际上做的是与先前相反的工作。每个INSERT，会有一个DELETE；每个DELETE，会有一个INSERT；对于UPDATE，会执行一个相反的UPDATE，将修改前的行放回去。<p><strong>除了回滚，undo另一个作用是MVCC。undo log会产生redo log，因undo log也需要持久性保护</strong>。<h4 id=undo存储管理><a class=headerlink href=#undo存储管理 title=undo存储管理></a>undo存储管理</h4><p><strong>InnoDB对undo的管理方式同样采用段的方式，该段和之前介绍的段有所不同。首先InnoDB有rollback segment，每个回滚段中记录了1024个undo log segment，而在每个undo log segment中进行undo页的申请</strong>。共享表空间偏移量为 5 的页记录了所有rollback segement header所在的页，这个页的类型为<code>FIL_PAGE_TYPE_SYS</code>。<p>InnoDB 1.1之前只有一个回滚段，因此同时在线事务限制为1024。从 1.1开始支持128个rollback segment，故同时在线事务数提高为128 * 1024。但是这些回滚段都存储于共享表空间中。从InnoDB 1.2版本开始，可通过参数对回滚段做进一步的设置。这些参数如下：<ol><li><p><strong>innodb_undo_directory</strong>：设置回滚段文件所在的路径。意味着可以存放在共享表空间以外的位置，即可以设置为独立表空间。参数默认值为“.”，表示当前InnoDB的目录。</p><li><p><strong>innodb_undo_logs</strong>：设置回滚段的个数，默认值为128。InnoDB 1.2版本中，该参数用来替换之前版本的参innodb_rollback_segments。</p><li><p><strong>innodb_undo_tablespaces</strong>：设置构成 回滚段 文件的数量，默认值为2。设置该参数后，会在路径 innodb_undo_directory看到undo为前缀的文件，该文件代表 回滚段 文件。</p></ol><p>要注意，事务在 undo log segment 中分配页并写入 undo log 的同时需要写入重做日志。当事务提交时，InnoDB会做以下两件事：<ol><li>将 undo log 放入列表中，以供之后的 purge操作。<li>然后判断 undo页的使用空间是否小于3/4，若小于，则表示该undo页可以重用。</ol><p>事务提交后不能马上删除 undo log 及 undo log 所在的页，因为此时可能还有其它事务需要通过 undo log 来获取行记录的旧版本。故事务提交时将 undo log 放入一个链表中，然后判断 undo页的使用空间是否小于3/4，若小于，则表示该undo页可以重用，之后新的undo log记录在当前undo log的后面。是否可以最终删除 undo log 及 undo log 所在的页将由 purge线程来判断。purge操作需要涉及磁盘的离散读取操作，是一个比较慢的过程。<p>可以通过命令<code>SHOW ENGINE INNODB STATUS</code>来查看链表中 undo log 的数量。<h4 id=undo-log格式><a title="undo log格式" class=headerlink href=#undo-log格式></a>undo log格式</h4><p>InnoDB中，undo log分为：<ol><li><p><strong>insert undo log</strong></p> <p>指 insert操作中产生的 undo log，因为 insert操作的记录只对事务本身可见，故该 undo log 可以在事务提交后直接删除。无需进行 purge操作。</p> <p>下图中显示了 insert undo log的格式，其中 * 代表对存储的字段进行了压缩。nex记录的是下一个 undo log 的位置，通过该next可知一个 undo log 所占空间字节数；type_cmpl占用1个字节，记录的是 undo 的类型，对于 insert undo log，该值总为11；undo_no记录事务的ID；table_id记录 undo log 所对应的表对象；</p><li><p><strong>update undo log</strong>（记录内容多，占用空间大）</p> <p><strong>记录 delete 和 update 操作产生的 undo log</strong>。该 undo log 可能需要提供 MVCC机制，因此不能在事务提交时就删除。提交时放入 undo log 链表，等待 purge线程进行最后的删除。</p> <p>next、start、undo、undo_no、table_id与上面的insert undo log相同，这里的 type_cmpl 由于update undo log 本身还有分类，故可能的值如下：</p> <ul><li>12：TRX_UNDO_UPD_EXIST_REC 更新 non-delete-mark 的记录。<li>13：TRX_UNDO_UPD_DEL_REC 将 delete的记录标记为 not delete。<li>14：TRX_UNDO_DEL_MARK_REC 将记录标记为 delete。</ul></ol><p>两种log的格式如下：<p><img alt=image-20201215172344342 src=https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/06/image-20201215172344342.png><h4 id=查看undo信息><a class=headerlink href=#查看undo信息 title=查看undo信息></a>查看undo信息</h4><ol><li>通过查看数据字典表<code>INNODB_TRX_ROLLBACK_SEGMENT</code>来获取。该表记录了回滚段信息。<li>通过查看数据字典表<code>INNODB_TRX_UNDO</code>来获取，该表记录了事务对应的 undo log。</ol><h3 id=7-2-3、purge><a class=headerlink href=#7-2-3、purge title=7.2.3、purge></a>7.2.3、purge</h3><h4 id=purge职责><a class=headerlink href=#purge职责 title=purge职责></a>purge职责</h4><p><strong>delete和update操作可能并不会直接删除原有的数据，而真正的删除由purge线程来完成</strong>。<p>InnoDB支持MVCC，故记录不能在事务提交时立即被处理，因为此时该记录可能正在被其它事务使用，所以是否可以真正删除可以交给purge来判断。<h4 id=purge原理><a class=headerlink href=#purge原理 title=purge原理></a>purge原理</h4><p><strong>InnoDB中有一个 history 列表，它根据 事务提交顺序 将 undo log 进行链接</strong>。<p><img alt=image-20201215201507990 src=https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/06/image-20201215201507990.png><p>purge执行过程中，InnoDB会先从 history list 中找到第一个需要被清理的记录，这里为 trx1，清理后InnoDB会在 trx1 的 undo log 所在的页中继续寻找是否存在其它可以被清理的记录，这里会找到事务 trx3，接着找到 trx5，但发现 trx5 被其他事务所引用而不能清理，故会再次去 history list 中按顺序继续查找，发现了 trx2，接着找到 trx2所在的页，然后再把事务trx6、trx4的记录进行处理。由于 undo page2 中所有的页都被清理了，因此该 undo page 可以被重用。<h4 id=purge相关参数><a class=headerlink href=#purge相关参数 title=purge相关参数></a>purge相关参数</h4><ol><li><p><code>innodb_purge_batch_size</code>：全局动态参数，用来设置每次 purge 操作清理的 undo page 数量。InnoDB 1.2之前，默认值为20。从 1.2 开始，默认值为300（MySQL5.7.33）。</p><li><p><code>innodb_max_purge_lag</code>：该参数用来控制 history list 的长度，若实际长度超过该值，会“延缓”DML操作。默认值为0，表示不对 history list 做任何限制，当大于0时，就会延缓 DML操作，延缓算法如下：</p> <figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line><span class=attr>delay(毫秒)</span> = <span class=string>((length(history_list) - innodb_max_purge_lag) * 10) - 5</span></span><br></pre></table></figure> <p><strong>delay对象是行，而并非是一个DML操作。delay的统计会在每一次 purge 操作完成后，重新进行计算</strong>。</p><li><p><code>innodb_max_purge_lag_delay</code>：InnoDB 1.2 新增该参数，用来控制 delay 的最大毫秒数。当2中的公式计算后的delay值大于该参数值时以该参数值为准。进而避免由于 purge 操作缓慢导致其它 SQL 线程出现无限制的等待。</p></ol><h3 id=7-2-4、group-commit><a title="7.2.4、group commit" class=headerlink href=#7-2-4、group-commit></a>7.2.4、group commit</h3><h4 id=group-commit定义><a title="group commit定义" class=headerlink href=#group-commit定义></a>group commit定义</h4><p><strong>若事务是非只读事务，则每次事务提交时需要执行一次fsync操作，来保证重做日志准确写入磁盘。fsync性能有限，为提高磁盘fsync性能，提供了group commit功能，即一次fsync可以刷新多个日志至文件</strong>。<p>InnoDB下的事务提交会执行两个阶段操作：<ol><li>修改内存中事务对应的信息，并且将日志写入重做日志缓冲。<li>调用fsync将确保日志都从重做日志缓冲写入磁盘。</ol><p>第二步较第一步是一个更慢的过程，因为该过程需要与磁盘打交道。当事务A执行第二步时事务B可以同时继续执行第一步，事务B执行完第一步后，事务A和事务B的重做日志就可以通过一次fsync操作即可全部刷新到磁盘，大大提高了数据库整体的性能。<h4 id=group-commit问题><a title="group commit问题" class=headerlink href=#group-commit问题></a>group commit问题</h4><p><font color=red>注意：InnoDB 1.2之前，开启二进制日志会使group commit功能失效。原因是：为了保证存储引擎层事务和二进制日志的一致性，二者之间使用了两阶段事务，</font>其步骤如下：<ol><li>当事务提交时，InnoDB进行prepare操作。<li>MySQL上层写入二进制日志。<li>InnoDB引擎将日志写入重做日志文件。<ol><li>修改内存中事务对应的信息，且将日志写入重做日志缓冲。<li>调用fsync将确保日志都从重做日志缓冲写入磁盘。</ol></ol><p><font color=red>注意：每个步骤都需要进行一次 fsync 操作才能保证上下两层数据的一致性。步骤2的 fsync 由参数 <code>sync_binlog</code>控制，步骤3的 fsync 由参数 <code>innodb_flush_log_at_trx_commit</code>控制。</font><p>为了保证二进制日志写入顺序和InnoDB层事务提交顺序一致，提供 prepare_commit_mutex 锁，但开启该锁后，步骤3中的步骤1 不能在其他事务执行步骤3中的步骤2时执行，进而导致 group commit 失效。<p>那为何要保证两者的一致性呢？因为备份及恢复的需要。<p><strong>最终解决方法为 Binary Log Group Commit。</strong><p><strong>MySQL数据库上层进行提交时按顺序将其放入一个队列中，队列中第一个事务是leader，其它事务是follower，leader控制其它follower的行为。</strong>BLGC的步骤分为三步：<ol><li><strong>Flush阶段</strong>：将每个事务的二进制日志写入内存中的队列中。<li><strong>Sync阶段</strong>：将队列中的二进制日志刷新到磁盘，若队列中有多个事务，则一次fsync操作就可以完成所有二进制日志的写入，这就是BLGC。<li><strong>Commit阶段</strong>：从leader开始根据顺序调用存储引擎层事务的提交，InnoDB本身就支持GroupCommit，因此修复了之前GroupCommit失效的问题。</ol><h4 id=group-commit参数><a title="group commit参数" class=headerlink href=#group-commit参数></a>group commit参数</h4><p>group commit 效果 依赖于 队列中的事务数量，队列事务数量多，效果相对就会好。参数 <code>binlog_max_flush_queue_time</code>用来控制 Flush 阶段 事务等待的时间，即事务完成提交后不会立即进入 Sync阶段，而是等待 事务数量增多后一同处理。参数默认为0，推荐为0，除非数据中有大量连接，且不断进行事务的写入或更新。<h2 id=7-3、事务隔离级别><a class=headerlink href=#7-3、事务隔离级别 title=7.3、事务隔离级别></a>7.3、事务隔离级别</h2><h3 id=7-3-1、简介><a class=headerlink href=#7-3-1、简介 title=7.3.1、简介></a>7.3.1、简介</h3><p>SQL标准定义的四个隔离级别为：<ul><li><p><strong>READ UNCOMMITTED：读未提交</strong></p><li><p><strong>READ COMMITTED：读已提交</strong></p> <p>MySQL 5.1中，该隔离级别只能适用于 replication 二进制日志为 ROW 的格式。如果二进制日志工作在 STATEMENT 下，则会出错。</p><li><p><strong>REPEATABLE READ（MySQL默认）：可重复读</strong></p> <p>InnoDB在该隔离级别下，使用Next-Key Lock锁算法，因此可避免幻读发生。</p><li><p><strong>SERIALIZABLE：串行化</strong></p> <p>该隔离级别下，InnoDB会对每个 SELECT 语句后自动加上 LOCK IN SHARE MODE，即加一个共享锁。通常该隔离级别被用于分布式事务。</p></ul><blockquote><p>Oracle并不支持读未提交和可重复读隔离级别。</blockquote><h3 id=7-3-2、配置隔离级别><a class=headerlink href=#7-3-2、配置隔离级别 title=7.3.2、配置隔离级别></a>7.3.2、配置隔离级别</h3><p>在InnoDB中，可以使用以下命令来设置当前会话或全局的事务隔离级别：<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre><td class=code><pre><span class=line><span class=keyword>SET</span> [<span class=keyword>GLOBAL</span> <span class=operator>|</span> SESSION] TRANSACTION ISOLATION LEVEL</span><br><span class=line>(</span><br><span class=line>	READ UNCOMMITTED <span class=operator>|</span></span><br><span class=line>	READ COMMITTED <span class=operator>|</span></span><br><span class=line>	REPEATABLE READ <span class=operator>|</span></span><br><span class=line>	SERIALIZABLE</span><br><span class=line>)</span><br></pre></table></figure><p>设置隔离级别的示例如下：<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line># 配置当前会话隔离级别</span><br><span class=line><span class=keyword>set</span> session transaction isolation level read committed;</span><br><span class=line># 配置全局隔离级别</span><br><span class=line><span class=keyword>set</span> <span class=keyword>global</span> transaction isolation level read committed;</span><br></pre></table></figure><p><strong>如果想在 MySQL启动时就设置事务的隔离级别，则需要修改MySQL配置文件</strong>，加入如下内容：<figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line><span class=attr>[mysqld]</span></span><br><span class=line><span class=attr>transaction-isolation</span> = <span class=string>READ-COMMITTED</span></span><br></pre></table></figure><h3 id=7-3-3、查看隔离级别><a class=headerlink href=#7-3-3、查看隔离级别 title=7.3.3、查看隔离级别></a>7.3.3、查看隔离级别</h3><p>查看当前会话的隔离级别，可以使用：<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line><span class=keyword>select</span> @<span class=variable>@transaction_isolation</span>; </span><br><span class=line><span class=comment>-- 或者</span></span><br><span class=line><span class=keyword>show</span> variables <span class=keyword>like</span> <span class=string>'%transaction_isolation%'</span>;</span><br></pre></table></figure><p>查看全局隔离级别，可以通过如下方式：<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line><span class=keyword>select</span> @<span class=variable>@global</span>.transaction_isolation;</span><br></pre></table></figure><h2 id=7-4、分布式事务><a class=headerlink href=#7-4、分布式事务 title=7.4、分布式事务></a>7.4、分布式事务</h2><h3 id=7-4-1、MySQL分布式事务><a class=headerlink href=#7-4-1、MySQL分布式事务 title=7.4.1、MySQL分布式事务></a>7.4.1、MySQL分布式事务</h3><p>InnoDB引擎提供了对XA事务的支持，并通过XA事务来支持分布式事务的实现。分布式事务指的是允许多个独立的事务资源参与到一个安全的事务中。事务资源通常是关系型数据库系统，但也可以是其他类型的资源。全局事务要求在其中的所有事务要么都提交，要么都回滚，这对于事务原有的ACID要求又有了提高。另外，在使用分布式事务时，InnoDB引擎的事务隔离级别必须设置为SERIALIZABLE。<p>XA事务由一个或多个资源管理器、一个事务管理器以及一个应用程序组成。<ol><li>资源管理器：提供访问事务资源的方法，通常一个数据库就是一个资源管理器。<li>事务管理器：协调参与全局事务中的各个事务。需要和参与全局事务的所有资源管理器进行通信。<li>应用程序：定义事务的边界，指定全局事务中的操作。</ol><p>在MySQL数据库的分布式事务中，资源管理器就是MySQL数据库，事务管理器为连接MySQL的客户端。<h3 id=7-4-2、内部XA事务><a class=headerlink href=#7-4-2、内部XA事务 title=7.4.2、内部XA事务></a>7.4.2、内部XA事务</h3><p>内部XA事务存在于 引擎与插件 之间，或引擎与引擎之间。常见的是内部XA事务存在于 binlog 与 InnoDB 引擎之间。<h2 id=7-5、长事务><a class=headerlink href=#7-5、长事务 title=7.5、长事务></a>7.5、长事务</h2><p>长事务是执行时间较长的事务。可能需要1个小时，也可能需要4、5个小时，这取决于数据库的硬件配置。<p>长事务可以通过转化为小批量的事务来进行处理。当事务发生错误时，只需恢复一部分数据。<h2 id=7-6、MVCC><a class=headerlink href=#7-6、MVCC title=7.6、MVCC></a>7.6、MVCC</h2><h3 id=7-6-1、定义><a class=headerlink href=#7-6-1、定义 title=7.6.1、定义></a>7.6.1、定义</h3><p><strong>MVCC （Multiversion Concurrency Control）意为多版本并发控制。MVCC 通过数据记录的多个版本来实现并发控制，且保证了InnoDB引擎下的一致性读</strong>。<h3 id=7-6-2、快照读与当前读><a class=headerlink href=#7-6-2、快照读与当前读 title=7.6.2、快照读与当前读></a>7.6.2、快照读与当前读</h3><p>InnoDB引擎下，MVCC较好的处理了读写冲突，提高了数据库并发性能。即使存在读写冲突也无需加锁，还可以非阻塞并发读 ，这里的读指的是【快照读】。当前读需要加锁，是悲观锁的一种体现。MVCC本质是乐观锁的一种体现。<h4 id=快照读><a class=headerlink href=#快照读 title=快照读></a>快照读</h4><p>快照读又叫一致性读，读取的是快照数据。不加锁的 SELECT 都属于快照读，即不加锁的非阻塞读。<p>快照读基于MVCC实现，避免加锁，降低了开销。<p><strong>快照读的前提是不能设置隔离级别为串行级别，串行级别下的快照读会退化成当前读</strong>。<h4 id=当前读><a class=headerlink href=#当前读 title=当前读></a>当前读</h4><p><strong>当前读读取的是最新数据，且会对记录加锁，加锁的SELECT及普通的增删改都会执行当前读</strong>。<h3 id=7-6-3、隐藏字段><a class=headerlink href=#7-6-3、隐藏字段 title=7.6.3、隐藏字段></a>7.6.3、隐藏字段</h3><p>InnoDB 引擎的聚簇索引中包含两个必要的隐藏列。<ul><li>trx_id：每次一个事务对某条聚簇索引记录进行改动时，都会把该事务的 事务id 赋值给trx_id 隐藏列。<li>roll_pointer：每次对某条聚簇索引记录进行改动时，都会把旧的版本写入到 undo日志中，然后这个隐藏列就相当于一个指针，可以通过它来找到该记录修改前的信息。</ul><p><img src=https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/06/undo%E6%97%A5%E5%BF%97-%E7%89%88%E6%9C%AC%E9%93%BE%E5%9B%BE1.png><blockquote><p>除了以上两个隐藏字段外，还有一个隐藏字段<code>row_id</code>。当一个表中没有主键时会使用Unique列来做主键，若没有Unique列，那么会生成一个row_id来作为主键。<p>insert undo只在事务回滚时起作用，当事务提交后，该类型的undo日志就没用了，它占用的Undo Log Segment也会被系统回收（也就是该undo日志占用的Undo页面链表要么被重用，要么被释放）。</blockquote><h3 id=7-6-4、版本链><a class=headerlink href=#7-6-4、版本链 title=7.6.4、版本链></a>7.6.4、版本链</h3><p>假设之后两个事务id分别为 10 、 20 的事务对这条记录进行 UPDATE 操作，操作流程如下：<table><thead><tr><th align=center>时间顺序<th align=left>事务10<th align=left>事务20<tbody><tr><td align=center>1<td align=left>BEGIN;<td align=left><tr><td align=center>2<td align=left><td align=left>BEGIN;<tr><td align=center>3<td align=left>UPDATE student SET name=”李四” WHERE id=1<td align=left><tr><td align=center>4<td align=left>UPDATE student SET name=”王五” WHERE id=1;<td align=left><tr><td align=center>5<td align=left>COMMIT;<td align=left><tr><td align=center>6<td align=left><td align=left>UPDATE student SET name=”钱七” WHERE id=1;<tr><td align=center>7<td align=left><td align=left>UPDATE student SET name=”宋八” WHERE id=1;<tr><td align=center>8<td align=left><td align=left>COMMIT;</table><p>每次对记录进行改动，都会记录一条undo日志，每条undo日志也都有一个 roll_pointer 属性 （ INSERT 操作对应的undo日志没有该属性，因为该记录并没有更早的版本），将这些 undo日志 连起来会形成一个链表：<p><img src=https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/06/undo%E6%97%A5%E5%BF%97-%E7%89%88%E6%9C%AC%E9%93%BE%E5%9B%BE2.png><p>对该记录每次更新后，都会将旧值放到一条 undo日志中，就算是该记录的一个旧版本，随着更新次数 的增多，所有的版本都会被 roll_pointer 属性连接成一个链表，这个链表称为【版本链】 ，版本链的头节点就是当前记录最新的值。<p>每个版本中还包含生成该版本时对应的 事务id 。<h3 id=7-6-5、实现原理><a class=headerlink href=#7-6-5、实现原理 title=7.6.5、实现原理></a>7.6.5、实现原理</h3><p><strong>MVCC 的实现依赖于：隐藏字段、Undo Log、Read View</strong>。<h4 id=Read-View简介><a title="Read View简介" class=headerlink href=#Read-View简介></a>Read View简介</h4><p>READ UNCOMMITTED 隔离级别的事务可以读取最新数据。SERIALIZABLE 隔离级别的事务，InnoDB规定使用加锁的方式来访问记录。READ COMMITTED 和 REPEATABLE READ 隔离级别的事务可以读到 已提交 的最新数据。<p><strong>undo日志版本链中，哪个版本当前事务可见，哪个版本当前事务不可见。这些问题都由ReadView来解决</strong>。<p>ReadView中主要包含4个重要内容：<ul><li><strong>creator_trx_id</strong>：创建这个 Read View 的事务 ID。<li><strong>trx_ids</strong>：生成ReadView时当前系统中活跃的读写事务的事务id列表 。<li><strong>up_limit_id</strong>：活跃事务中最小事务 ID。<li><strong>low_limit_id</strong>：表示生成ReadView时系统中应该分配给下一个事务的 id 值。low_limit_id 是系统最大的事务id值，这里要注意是系统中的事务id，需要区别于正在活跃的事务ID。</ul><blockquote><p>注意：low_limit_id并不是trx_ids中的最大值，事务id是递增分配的。比如，现在有id为1， 2，3这三个事务，之后id为3的事务提交了。那么一个新的读事务在生成ReadView时， trx_ids就包括1和2，up_limit_id的值就是1，low_limit_id的值就是4。</blockquote><h4 id=Read-View规则><a title="Read View规则" class=headerlink href=#Read-View规则></a>Read View规则</h4><p>有了ReadView，在访问某条记录时，只需要按照如下逻辑顺序来判断就可知道某个版本是否可见。<ol><li>如果被访问版本的trx_id属性值与ReadView中的 creator_trx_id 值相同，意味着当前事务在访问 它自己修改过的记录，所以该版本【可以】被当前事务访问。<li>如果被访问版本的trx_id属性值小于ReadView中的 up_limit_id 值，表明生成该版本的事务在当前事务生成ReadView前已经提交，所以该版本【可以】被当前事务访问。<li>如果被访问版本的trx_id属性值大于或等于ReadView中的 low_limit_id 值，表明生成该版本的事务在当前事务生成ReadView后才开启，所以该版本【不可以】被当前事务访问。<li>如果被访问版本的trx_id属性值在ReadView的 up_limit_id 和 low_limit_id 之间，那就需要判断一下trx_id属性值是不是在 trx_ids 列表中。<ul><li>如果在，说明创建ReadView时生成该版本的事务还是活跃的，该版本不可以被访问。<li>如果不在，说明创建ReadView时生成该版本的事务已经被提交，该版本可以被访问。</ul></ol><h3 id=7-6-6、MVCC操作流程><a class=headerlink href=#7-6-6、MVCC操作流程 title=7.6.6、MVCC操作流程></a>7.6.6、MVCC操作流程</h3><p>当查询一条记录的时候，系统如何通过MVCC找到它：<ol><li>首先获取事务自己的版本号，也就是事务 ID；<li>获取 ReadView；<li>查询得到的数据，然后与 ReadView 中的事务版本号进行比较；<li>如果不符合 ReadView 规则，就需要从 Undo Log 中获取历史快照；<li>最后返回符合规则的数据。</ol><p><strong>当隔离级别是读已提交（Read Committed）时，每一次 SELECT 都会重新获取一次 Read View</strong>。<blockquote><p>注意，此时同样的查询语句都会重新获取一次 Read View，这时如果 Read View 不同，就可能产生 不可重复读或者幻读的情况。</blockquote><p><strong>当隔离级别是可重复读时，仅在第一次 SELECT 时获取一次Read View，后面所有SELECT都会复用这个Read View</strong>。这也就解决了不可重复读的问题。<h3 id=7-6-7、总结><a class=headerlink href=#7-6-7、总结 title=7.6.7、总结></a>7.6.7、总结</h3><p><strong>MVCC仅在 READ COMMITTD、REPEATABLE READ两种隔离级别下会执行快照读</strong>，进而提高并发性能。<p>核心在于ReadView，READ COMMITTD、REPEATABLE READ 两个隔离级别的最大不同点就是ReadView生成时机不同：<ul><li>READ COMMITTD 会在每一次普通SELECT操作前生成一个ReadView。<li>REPEATABLE READ 仅在第一次普通SELECT操作前生成一个ReadView，之后查询都会复用这一个ReadView。</ul><p>通过MVCC可解决：<ul><li>读写阻塞问题。<li>降低死锁概率。<li>解决快照读问题。</ul><h2 id=7-7、总结><a class=headerlink href=#7-7、总结 title=7.7、总结></a>7.7、总结</h2><h3 id=7-7-1、事务使用禁忌><a class=headerlink href=#7-7-1、事务使用禁忌 title=7.7.1、事务使用禁忌></a>7.7.1、事务使用禁忌</h3><ul><li>严禁 循环中提交。<li>严禁 使用自动提交。<li>严禁 使用自动回滚。</ul><h1 id=8、备份与恢复><a class=headerlink href=#8、备份与恢复 title=8、备份与恢复></a>8、备份与恢复</h1><h2 id=8-1、概述><a class=headerlink href=#8-1、概述 title=8.1、概述></a>8.1、概述</h2><p>根据备份方法的不同，备份可分为：<ol><li><strong>Hot Backup（热备）</strong>：指在数据库运行中直接备份，对正在运行的数据库操作没有任何的影响。<li><strong>Cold Backup（冷备）</strong>：指在数据库停止的情况下，一般只需要复制相关的数据库物理文件即可。<li><strong>Warm Backup（温备）</strong>：指在数据库运行中进行的，但是会对当前数据库的操作有所影响，如加一个全局读锁以保证备份数据的完整性。</ol><p><p>按照备份后文件的内容，备份又可分为：<ol><li><strong>逻辑备份</strong>：指备份出的文件内容是可读的，一般是文本文件，内容一般是由一条条SQL语句，或表内实际数据组成。<li><strong>裸文件备份</strong>：指复制数据库的物理文件，既可以是在数据库运行中的复制，也可以是在数据库停止时直接的数据文件复制。</ol><p>按照备份数据库的内容，备份可分为：<ol><li><strong>完全备份</strong>：对数据库进行一个完整备份。<li><strong>增量备份</strong>：在上次完全备份的基础上，对于更改的数据进行备份。<li><strong>日志备份</strong>：对于MySQL数据库二进制日志的备份，通过对一个完全备份进行二进制日志的重做来完成数据库的point-in-time的恢复工作。</ol><h2 id=8-2、逻辑备份与恢复><a class=headerlink href=#8-2、逻辑备份与恢复 title=8.2、逻辑备份与恢复></a>8.2、逻辑备份与恢复</h2><h3 id=8-2-1、备份><a class=headerlink href=#8-2-1、备份 title=8.2.1、备份></a>8.2.1、备份</h3><h4 id=8-2-1-1、mysqldump><a class=headerlink href=#8-2-1-1、mysqldump title=8.2.1.1、mysqldump></a>8.2.1.1、mysqldump</h4><h5 id=简介-15><a class=headerlink href=#简介-15 title=简介></a>简介</h5><p><strong>mysqldump工具最初由Igor Romanenko编写，通常用来完成数据库备份的转存及不同数据库间的移植</strong>。<p>mysqldump语法如下：<figure class="highlight tex"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>mysqldump [arguments] > file<span class=built_in>_</span>name</span><br></pre></table></figure><h5 id=常用命令><a class=headerlink href=#常用命令 title=常用命令></a>常用命令</h5><p>（1）仅导出结构，不导出数据<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>mysqldump <span class=operator>-</span>uroot <span class=operator>-</span>p <span class=comment>--opt -d 数据库名 > xxx-schema.sql　　</span></span><br></pre></table></figure><p>（2）仅导出数据，不导出结构<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>mysqldump <span class=operator>-</span>uroot <span class=operator>-</span>p <span class=operator>-</span>t 数据库名 <span class=operator>></span> xxx<span class=operator>-</span>data.sql</span><br></pre></table></figure><p>（3）导出表结构和数据<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>mysqldump <span class=operator>-</span>uroot <span class=operator>-</span>p 数据库名 <span class=operator>></span> xxx<span class=operator>-</span>all.sql</span><br></pre></table></figure><p>（4）导出某个表的表结构<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>mysqldump <span class=operator>-</span>uroot <span class=operator>-</span>p <span class=operator>-</span>B 数据库名 <span class=comment>--table 表名 > xxx-table-schema.sql</span></span><br></pre></table></figure><p>（5）导出指定的数据库<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>mysqldump <span class=comment>--databases db1 db2 db3 > dump.sql</span></span><br></pre></table></figure><p>(6）导出所有数据库<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>mysqldump <span class=comment>--all-databases > dump.sql</span></span><br></pre></table></figure><p>（7）备份test架构<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>mysqldump <span class=comment>--single-transaction test > test_backup.sql</span></span><br></pre></table></figure><h4 id=8-2-1-2、select…into-outfile><a title="8.2.1.2、select…into outfile" class=headerlink href=#8-2-1-2、select…into-outfile></a>8.2.1.2、select…into outfile</h4><h5 id=简介-16><a class=headerlink href=#简介-16 title=简介></a>简介</h5><p>SELECT…INTO语句也是一种逻辑备份的方法，准确的说是导出一张表中的数据。<h5 id=使用示例><a class=headerlink href=#使用示例 title=使用示例></a>使用示例</h5><p>select into outfile 用法如下：<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line><span class=keyword>SELECT</span> ... <span class=keyword>FROM</span> TABLE_A</span><br><span class=line><span class=keyword>INTO</span> OUTFILE "/path/to/file"</span><br><span class=line>FIELDS TERMINATED <span class=keyword>BY</span> <span class=string>','</span> </span><br><span class=line>OPTIONALLY ENCLOSED <span class=keyword>BY</span> <span class=string>'"'</span></span><br><span class=line>LINES TERMINATED <span class=keyword>BY</span> <span class=string>'\n'</span>;</span><br></pre></table></figure><p>load data infile 用法如下：<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>LOAD DATA INFILE "/path/to/file" <span class=keyword>INTO</span> <span class=keyword>TABLE</span> table_name;</span><br></pre></table></figure><p>注意：如果导出时使用了<code>(FIELDS TERMINATED BY ',')</code>、<code>(OPTIONALLY ENCLOSED BY '"')</code>、<code>(LINES TERMINATED BY '\n')</code>语句，那么LODA时也要加上同样的分隔限制语句。<h3 id=8-2-2、恢复><a class=headerlink href=#8-2-2、恢复 title=8.2.2、恢复></a>8.2.2、恢复</h3><h4 id=8-2-2-1、mysqlimport><a class=headerlink href=#8-2-2-1、mysqlimport title=8.2.2.1、mysqlimport></a>8.2.2.1、mysqlimport</h4><p><strong>mysqlimport是MySQL数据库提供的一个命令行程序，本质上是 LOAD DATA INFILE 的命令接口，而且大多数的选项都和 LOAD DATA INFILE 语法相同</strong>，其语法格式如下：<figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>mysqlimport [option] db_name textfile1 [textfile2 ...]</span><br></pre></table></figure><p><font color=red>注意：与 LOAD DATA INFILE不同的是，mysqlimport命令可以用来导入多张表。并且通过<code>-user-thread</code>参数并发地导入不同的文件，这里的并发指的是并发导入多个文件，而并非并发地导入一个文件，这是明显区别。</font><p>mysqldump的恢复操作较简单，备份文件就是导出的SQL语句，一般只要执行该文件即可。可通过如下方法实现该操作：<figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>mysql -uroot -p < test_backup.sql</span><br></pre></table></figure><p>因为逻辑备份的文件是由 SQL 语句组成，故可以通过 SOURCE 命令来执行逻辑备份文件，命令如下：<figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line><span class=built_in>source</span> /home/mysql/test_backup.sql;</span><br></pre></table></figure><h4 id=8-2-2-2、load-data-infile><a title="8.2.2.2、load data infile" class=headerlink href=#8-2-2-2、load-data-infile></a>8.2.2.2、load data infile</h4><p><strong>通过<code>mysqldump-tab</code>或<code>SELECT INTO OUTFILE</code>导出的数据可通过命令<code>LOAD DATA INFILE</code>来进行导入</strong>。<p>要对服务器文件使用<code>LOAD DATA INFILE</code>，必须拥有FILE权。使用该命令导入文件的示例如下：<figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>load data infile <span class=string>'/home/mysql/a.txt'</span> into table a;</span><br></pre></table></figure><p><strong>为了加快 InnoDB 的导入，可以在导入时忽略对外键的检查</strong>，具体操作如下：<ol><li>导入前修改: set @@foreign_key_checks=0;<li>执行导入操作：…………….<li>导入后恢复：set @@foreign_key_checks=1;</ol><h2 id=8-3、BinLog备份与恢复><a class=headerlink href=#8-3、BinLog备份与恢复 title=8.3、BinLog备份与恢复></a>8.3、BinLog备份与恢复</h2><h3 id=8-3-1、备份><a class=headerlink href=#8-3-1、备份 title=8.3.1、备份></a>8.3.1、备份</h3><p><strong>二进制日志非常关键，用户可以通过它完成 point-in-time 恢复工作</strong>。MySQL replication同样需要二进制日志。<p>如需使用二进制日志，则必须开启并配置：<figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line><span class=attr>[mysqld]</span></span><br><span class=line><span class=attr>log-bin</span> = <span class=string>mysql-bin</span></span><br><span class=line><span class=attr>sync_binlog</span> = <span class=string>1</span></span><br><span class=line><span class=attr>innodb_support_xa</span> = <span class=string>1</span></span><br></pre></table></figure><p>在备份二进制日志文件前，可通过 <code>FLUSH LOGS</code> 命令来生成一个新的二进制日志文件，然后备份之前的二进制日志。<h3 id=8-3-2、恢复><a class=headerlink href=#8-3-2、恢复 title=8.3.2、恢复></a>8.3.2、恢复</h3><p><strong>要通过二进制日志恢复数据很简单，使用命令 mysqlbinlog 即可实现</strong>，使用方法如下：<figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>mysqlbinlog [options] log_file ...</span><br></pre></table></figure><p>例如，要恢复还原 binlog.0000001，可以使用如下命令：<figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>mysqlbinlog binlog.0000001 | mysql -uroot -p <span class=built_in>test</span></span><br></pre></table></figure><p>如需恢复多个二进制日志文件，最好是同时恢复多个，不建议一个一个恢复。方法如下：<figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>mysqlbinlog binlog.[0-10]* | mysql -uroot -p <span class=built_in>test</span></span><br></pre></table></figure><h2 id=8-4、冷备与热备><a class=headerlink href=#8-4、冷备与热备 title=8.4、冷备与热备></a>8.4、冷备与热备</h2><h3 id=8-4-1、冷备><a class=headerlink href=#8-4-1、冷备 title=8.4.1、冷备></a>8.4.1、冷备</h3><h4 id=简介-17><a class=headerlink href=#简介-17 title=简介></a>简介</h4><p><strong>对于InnoDB引擎的冷备，只需要备份MySQL数据库的frm文件，共享表空间文件，独立表空间文件，重做日志文件。另外建议定期备份MySQL数据库的配置文件my.cnf，这有利于恢复</strong>。<h4 id=冷备优点><a class=headerlink href=#冷备优点 title=冷备优点></a>冷备优点</h4><ol><li>备份简单，只要复制相关文件即可。<li>备份文件易于在不同操作系统，不同MySQL版本上进行恢复。<li>恢复相当简单，只需要把文件恢复到指定位置即可。<li>恢复速度快，不需要执行任何SQL语句，也不需要重建索引。</ol><h4 id=冷备缺点><a class=headerlink href=#冷备缺点 title=冷备缺点></a>冷备缺点</h4><ol><li>InnoDB引擎冷备的文件通常比逻辑文件大很多，因为表空间中存放着很多其他的数据，如undo段等。<li>冷备也不总是可以轻易地跨平台。操作系统、MySQL版本、文件大小写敏感和浮点数格式都会成为问题。</ol><h3 id=8-4-2、热备><a class=headerlink href=#8-4-2、热备 title=8.4.2、热备></a>8.4.2、热备</h3><h4 id=8-4-2-1、ibbackup><a class=headerlink href=#8-4-2-1、ibbackup title=8.4.2.1、ibbackup></a>8.4.2.1、ibbackup</h4><p><strong>ibbackup是InnoDB官方提供的热备工具，可同时备份MyISAM引擎和InnoDB引擎表</strong>，对InnoDB表来说，备份工作的原理如下：<ol><li>记录备份的开始，InnoDB存储引擎重做日志文件检查点的LSN。<li>复制共享表空间以及独立表空间文件。<li>记录复制完表空间文件后，InnoDB引擎重做日志文件检查点的LSN。<li>复制在备份时产生的重做日志。</ol><p>ibackup优点如下：<ol><li>在线备份，不阻塞任何的SQL语句。<li>备份性能好，备份的实质是复制数据库文件和重做日志文件。<li>支持压缩备份，通过选项，可以支持不同级别的压缩。<li>跨平台支持，ibbackup可以运行在Linux、Windows以及主流的UNIX系统平台上。</ol><p>ibbackup对InnoDB引擎表的恢复步骤：<ol><li>恢复表空间文件。<li>应用重做日志文件。</ol><p>ibbackup收费，Percona公司提供了开源、免费的XtraBackup工具，它实现了 ibbackup 所有功能，且扩展支持了真正的增量备份功能。故可使用该产品。<h4 id=8-4-2-2、XtraBackup><a class=headerlink href=#8-4-2-2、XtraBackup title=8.4.2.2、XtraBackup></a>8.4.2.2、XtraBackup</h4><p><strong>XtraBackup 是Percona公司的开源热备工具。支持MySQL5.0以上版本。XtraBackup在GPL v2开源下发布</strong>。<p>xtrabackup包含两个工具：xtrabackup 和 innobackupex，二者区别如下：<ol><li>xtrabackup：只能备份innodb和xtradb两种引擎的表；<li>innobackupex：是一个封装了xtrabackup的Perl脚本，支持同时备份innodb和myisam，但备份myisam时要加一个全局读锁。且myisam不支持增量备份。</ol><h4 id=8-4-2-3、XtraBackup备份><a class=headerlink href=#8-4-2-3、XtraBackup备份 title=8.4.2.3、XtraBackup备份></a>8.4.2.3、XtraBackup备份</h4><p><strong>StraBackup工具支持对于 InnoDB 的增量备份</strong>，其工作原理如下：<ol><li>首选完成一个全备，并记录下此时检查点的LSN。<li>在进行增量备份时，比较表空间中每个页的LSN是否大于上次备份时的LSN，如果是，则备份该页，同时记录当前检查点的LSN。</ol><h2 id=8-5、快照备份><a class=headerlink href=#8-5、快照备份 title=8.5、快照备份></a>8.5、快照备份</h2><h3 id=8-5-1、简介><a class=headerlink href=#8-5-1、简介 title=8.5.1、简介></a>8.5.1、简介</h3><p><strong>MySQL不支持快照功能，因此快照备份说的是通过文件系统支持的快照功能对数据库进行备份</strong>。<h3 id=8-5-2、备份方法><a class=headerlink href=#8-5-2、备份方法 title=8.5.2、备份方法></a>8.5.2、备份方法</h3><p>备份前提是将所有数据库文件放在同一文件分区中，然后对该分区进行快照操作。<blockquote><p>LVM是Linux系统下对磁盘分区进行管理的一种机制。LVM使用 写时复制技术 来创建快照。</blockquote><h2 id=8-6、复制><a class=headerlink href=#8-6、复制 title=8.6、复制></a>8.6、复制</h2><h3 id=8-6-1、简介><a class=headerlink href=#8-6-1、简介 title=8.6.1、简介></a>8.6.1、简介</h3><p><strong>复制是MySQL数据库提供的一种高可用解决方案，一般用来建立大型应用</strong>。replication工作过程分3个步骤：<ol><li>主服务器把数据更改记录到二进制日志中。<li>从服务器把主服务器的二进制日志复制到自己的中继日志中。<li>从服务器重做中继日志中的日志，把更改应用到自己的数据库上，以达到数据的最终一致性。</ol><h3 id=8-6-2、快照加复制><a class=headerlink href=#8-6-2、快照加复制 title=8.6.2、快照加复制></a>8.6.2、快照加复制</h3><p>复制可以用来作为备份，也具备以下一些功能：<ol><li><p><strong>数据分布</strong>：由于MySQL的复制并不需要很大的带宽，因此可以在不同的数据中心之间实现数据的复制。</p><li><p><strong>读取的负载平衡</strong>：通过建立多个从服务器，可以将读取平均分布到这些从服务器中，且减少了主服务器的压力。一般通过 DNS 的 Round-Robin 和 Linux 的 LVS 功能都可以实现负载平衡。</p><li><p><strong>数据库备份</strong>：复制对备份很有帮助，但从服务器不是备份，不能完全代替备份。</p><li><p><strong>高可用性和故障转移</strong>：通过复制建立的从服务器有助于故障转移，减少故障的停机时间和恢复时间。</p></ol><p><strong>建议在从服务器上启用<code>read-only</code> 选项，这可以保证从服务器上的数据仅与主服务器进行同步，避免其他线程修改数据</strong>。如：<figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line><span class=attr>[mysqld]</span></span><br><span class=line><span class=attr>read-only</span> = <span class=string>true</span></span><br></pre></table></figure><p>设置该选项后，如果操作从服务器的用户没有 SUPER 权限，则对从服务器的任何修改操作都会抛出一个错误。</div><footer class=post-footer><div class=post-eof></div></footer></article></div><div class=post-block><article class=post-content itemscope itemtype=http://schema.org/Article><link href=https://hgprivate.github.io/2024/08/21/MySQL%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/ itemprop=mainEntityOfPage><span hidden itemprop=author itemscope itemtype=http://schema.org/Person> <meta content=/static/imgs/avatar.png itemprop=image> <meta content=豪哥 itemprop=name> </span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization> <meta content=豪哥博客 itemprop=name> <meta content=豪哥博客 itemprop=description> </span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork> <meta content="undefined | 豪哥博客" itemprop=name> <meta itemprop=description> </span><header class=post-header><h2 itemprop="name headline" class=post-title><a class=post-title-link href=/2024/08/21/MySQL%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/ itemprop=url>MySQL系列-MySQL环境搭建</a></h2><div class=post-meta-container><div class=post-meta><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar"></i> </span> <span class=post-meta-item-text>发表于</span> <time itemprop="dateCreated datePublished" title="创建时间：2024-08-21 21:39:14" datetime=2024-08-21T21:39:14+08:00>2024-08-21</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar-check"></i> </span> <span class=post-meta-item-text>更新于</span> <time title="修改时间：2023-10-03 11:11:51" datetime=2023-10-03T11:11:51+08:00 itemprop=dateModified>2023-10-03</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-folder"></i> </span> <span class=post-meta-item-text>分类于</span> <span itemprop=about itemscope itemtype=http://schema.org/Thing> <a href=/categories/MySQL/ itemprop=url rel=index><span itemprop=name>MySQL</span></a> </span> </span></div></div></header><div class=post-body itemprop=articleBody><h1 id=1、主从复制><a class=headerlink href=#1、主从复制 title=1、主从复制></a>1、主从复制</h1><h2 id=1-1、配置文件><a class=headerlink href=#1-1、配置文件 title=1.1、配置文件></a>1.1、配置文件</h2><p>主节点配置文件：<figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre><td class=code><pre><span class=line><span class=attr>server-id</span>=<span class=string>1</span></span><br><span class=line><span class=attr>log-bin</span>=<span class=string>mysql-bin</span></span><br><span class=line><span class=attr>binlog-ignore-db</span>=<span class=string>mysql</span></span><br><span class=line><span class=attr>binlog-ignore-db</span>=<span class=string>information_schema</span></span><br><span class=line><span class=attr>binlog-do-db</span>=<span class=string>test_mycat</span></span><br><span class=line><span class=attr>binlog_format</span>=<span class=string>STATEMENT</span></span><br></pre></table></figure><p>从节点配置文件：<figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line><span class=attr>server-id</span>=<span class=string>2</span></span><br><span class=line><span class=attr>relay-log</span>=<span class=string>mysql-relay</span></span><br></pre></table></figure><h2 id=1-2、配置访问环境><a class=headerlink href=#1-2、配置访问环境 title=1.2、配置访问环境></a>1.2、配置访问环境</h2><p>1）在主节点中创建一个用户，该用户用于从主节点拉取数据到slave节点来执行同步操作。<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>GRANT REPLICATION SLAVE ON *.* TO 'bakcup'@'%' IDENTIFIED BY 'backup';</span><br></pre></table></figure><p>2）查看主节点状态。<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line>show master status;</span><br><span class=line></span><br><span class=line># 输出结果</span><br><span class=line>mysql-bin.000009  157  test_mycat  mysql,information_schema	</span><br></pre></table></figure><p>3）在从节点中执行连接命令。<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre><td class=code><pre><span class=line>CHANGE MASTER TO MASTER_HOST='192.168.2.6',	# 主节点地址。</span><br><span class=line>MASTER_USER='backup',	# 同步数据的账户（主节点中创建的）。</span><br><span class=line>MASTER_PASSWORD='backup',</span><br><span class=line>MASTER_LOG_FILE='mysql-bin.000009',	# 主节点当前状态打印信息中的二进制日志文件名。</span><br><span class=line>MASTER_LOG_POS=157,		# 二进制日志文件数据偏移量。</span><br><span class=line>MASTER_PORT=3306;</span><br></pre></table></figure><p>4）在从节点中开启slave同步。<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>start slave;</span><br></pre></table></figure><p>5）查看slave（从）节点状态。<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>show slave status;</span><br></pre></table></figure><p>如果打印信息中的字段<code>Slave_IO_Running</code>，<code>Slave_SQL_Running</code>的值都是 YES，那么表示同步环境搭建成功。<h2 id=1-3、问题篇><a class=headerlink href=#1-3、问题篇 title=1.3、问题篇></a>1.3、问题篇</h2><p><strong>1）报错：Authentication plugin ‘caching_sha2_password’ reported error:Authentication require secure connection。</strong><p>错误原因：MySQL8.0之前，身份验证的插件是mysql_native_password，MySQL 8.0中，默认的身份验证插件为caching_sha2_password，安全性更高。从库连接主库时使用的是不被 caching_sha2_password认可的RSA公钥，所以主库MySQL拒绝了数据库连接请求。<p>解决方法一：<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br></pre><td class=code><pre><span class=line># 使用同步用户来请求服务器公钥</span><br><span class=line>mysql -u backup -pbackup -h 192.168.2.6 -P3306 --get-server-public-key</span><br><span class=line></span><br><span class=line># 停止主从复制，清空之前的主从复制配置信息</span><br><span class=line>stop slave;</span><br><span class=line>reset slave;</span><br><span class=line></span><br><span class=line># 重新 配置主从复制</span><br><span class=line>change master to master_user='backup', master_password='backup', master_host='192.168.2.6', master_port=3306, master_auto_position=1;</span><br><span class=line></span><br><span class=line>start slave;</span><br></pre></table></figure><p>解决方法二：<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br></pre><td class=code><pre><span class=line># 使用同步用户来请求服务器公钥</span><br><span class=line>mysql -u repl -p123 -h 118.31.127.96 -P3307 --server-public-key-path=/mysqldata/my3308/data/public_key1.pem</span><br><span class=line></span><br><span class=line># 停止主从复制，清空之前的主从复制配置信息</span><br><span class=line>stop slave;</span><br><span class=line>reset slave;</span><br><span class=line></span><br><span class=line># 重新 配置主从复制</span><br><span class=line>change master to master_user='backup', master_password='backup', master_host='192.168.2.6',</span><br><span class=line>master_port=3306, master_auto_position=1;</span><br><span class=line></span><br><span class=line>start slave;</span><br></pre></table></figure><p>解决方式三：<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line># 修改用户密码加密方式</span><br><span class=line>ALTER USER 'root'@'%' IDENTIFIED BY 'password' PASSWORD EXPIRE NEVER;</span><br><span class=line>ALTER USER 'root'@'%' IDENTIFIED WITH mysql_native_password BY 'root666'; </span><br></pre></table></figure><p><strong>2）报错：The slave I/O thread stops because master and slave have equal MySQL server UUIDs</strong><p>原因：replication 架构中需要保证每个 mysql 实例 UUID（UUID 保存在 datadir 目录下的 auto.cnf 文件中）唯一，而现在两者不是唯一的。<p>解决方法：停掉备库实例，删除备库 data 文件夹下的的 auto.cnf（Windows 下名为 auto）文件，启动备库实例，此时备库就会产生一个新的 auto.cnf 文件 ( 产生新的 UUID) 。</div><footer class=post-footer><div class=post-eof></div></footer></article></div><div class=post-block><article class=post-content itemscope itemtype=http://schema.org/Article><link href=https://hgprivate.github.io/2024/08/21/Mybatis%E5%9F%BA%E7%A1%80%E5%BA%94%E7%94%A8/ itemprop=mainEntityOfPage><span hidden itemprop=author itemscope itemtype=http://schema.org/Person> <meta content=/static/imgs/avatar.png itemprop=image> <meta content=豪哥 itemprop=name> </span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization> <meta content=豪哥博客 itemprop=name> <meta content=豪哥博客 itemprop=description> </span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork> <meta content="undefined | 豪哥博客" itemprop=name> <meta itemprop=description> </span><header class=post-header><h2 itemprop="name headline" class=post-title><a class=post-title-link href=/2024/08/21/Mybatis%E5%9F%BA%E7%A1%80%E5%BA%94%E7%94%A8/ itemprop=url>MyBatis系列-MyBatis基础应用</a></h2><div class=post-meta-container><div class=post-meta><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar"></i> </span> <span class=post-meta-item-text>发表于</span> <time itemprop="dateCreated datePublished" title="创建时间：2024-08-21 21:39:13" datetime=2024-08-21T21:39:13+08:00>2024-08-21</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar-check"></i> </span> <span class=post-meta-item-text>更新于</span> <time title="修改时间：2024-10-29 02:38:36" datetime=2024-10-29T02:38:36+08:00 itemprop=dateModified>2024-10-29</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-folder"></i> </span> <span class=post-meta-item-text>分类于</span> <span itemprop=about itemscope itemtype=http://schema.org/Thing> <a href=/categories/MyBatis/ itemprop=url rel=index><span itemprop=name>MyBatis</span></a> </span> </span></div></div></header><div class=post-body itemprop=articleBody><h1 id=1、MyBatis基础><a class=headerlink href=#1、MyBatis基础 title=1、MyBatis基础></a>1、MyBatis基础</h1><h2 id=1-1、概述><a class=headerlink href=#1-1、概述 title=1.1、概述></a>1.1、概述</h2><h3 id=1-1-1、简介><a class=headerlink href=#1-1-1、简介 title=1.1.1、简介></a>1.1.1、简介</h3><p><strong>MyBatis是一款优秀的持久层框架，支持自定义SQL、存储过程以及高级映射</strong>。MyBatis免除了几乎所有的JDBC代码以及设置参数和获取结果集的工作。MyBatis可以通过简单的XML或注解配置和映射原始类型、接口和Java POJO（Plain Old Java Objects，普通老式Java对象）为数据库中的记录。<p><strong>Mybatis可以自定义SQL来执行，故称为半自动 ORM 映射工具。</strong><blockquote><p>MyBatis与Hibernate的区别如下：<ol><li>MyBatis是一个半自动ORM 框架，Hibernate是一个全自动ORM框架。<li>MyBatis灵活度高，适用于 对关系数据模型要求不高的场景，但数据库无关性差；Hibernate反之。</ol></blockquote><h3 id=1-1-2、使用场景><a class=headerlink href=#1-1-2、使用场景 title=1.1.2、使用场景></a>1.1.2、使用场景</h3><ol><li>MyBatis 专注于 SQL 本身，是一个足够灵活的持久层框架。<li>对性能要求很高，或需求变化大的项目。</ol><h3 id=1-1-3、优缺点><a class=headerlink href=#1-1-3、优缺点 title=1.1.3、优缺点></a>1.1.3、优缺点</h3><p>优点如下：<ol><li>降低与代码的耦合，手动编写SQL，灵活度高；<li>与 JDBC 相比，代码量较少；<li>兼容多种数据库（MyBatis 基于 JDBC 实现，故 JDBC 支持的 MyBatis 都支持）；<li>可与 Spring 完美集成；<li>提供映射标签，支持对象与数据库的 ORM 字段关系映射；</ol><p>缺点如下：<ol><li>SQL编写工作量稍大；<li>SQL本身依赖于数据库，数据库移植性差；</ol><h2 id=1-2、Mapper接口><a class=headerlink href=#1-2、Mapper接口 title=1.2、Mapper接口></a>1.2、Mapper接口</h2><h3 id=1-2-1、接口绑定><a class=headerlink href=#1-2-1、接口绑定 title=1.2.1、接口绑定></a>1.2.1、接口绑定</h3><p>接口绑定定义：<strong>Dao接口中的方法 与 mapper xml中的 SQL 进行绑定。</strong>调用接口方法即可实现执行SQL。<p>接口绑定有两种实现方式：<ol><li><strong>注解绑定</strong>：在接口的方法上添加注解<code>@Select、@Update</code>等，然后在注解中直接编写SQL来绑定；<li><strong>MapperXML绑定</strong>：xml 映射文件中的 namespace 属性值必须为接口的全路径名。</ol><blockquote><p>建议：SQL较简单时用注解绑定，较复杂时用 xml 绑定。xml 绑定方式使用较多<p>注意事项：接口不能重载，因底层使用<em><strong>全限名+方法名</strong></em>作为保存和寻找策略。</blockquote><h3 id=1-2-2、传参><a class=headerlink href=#1-2-2、传参 title=1.2.2、传参></a>1.2.2、传参</h3><h4 id=1-2-2-1、简介><a class=headerlink href=#1-2-2-1、简介 title=1.2.2.1、简介></a>1.2.2.1、简介</h4><p>调用Mapper接口方法就会执行MapperXML中对应的SQL，当Mapper接口方法有参数，且在执行MapperXML中的SQL时需要使用接口传递过来的参数，那么可以通过两个取值表达式来实现。这两个表达式如下：<ul><li>**#{}**：预编译处理，占位符赋值。在处理时会替换为?号，调用 PreparedStatement 的 set 方法来赋值。该表达式可以防止SQL注入。<li>**${}**：字符串拼接替换。在处理时会直接替换成变量的值。</ul><p>参数的名字是什么分以下几种情况：<ul><li>mapper接口方法参数为<strong>基础包装类型</strong>：参数名字为arg0、arg1…，或param1、param2…。<li>mapper接口方法参数为<strong>基础包装类型且使用注解@Param修饰形参</strong>：参数名字为注解中自定义的字符，或param1、param2…。<li>mapper接口方法参数为<strong>map类型</strong>：参数名字为map中的key。<li>mapper接口方法参数为<strong>实体类类型</strong>：参数名字为实体类中的set和get方法名字去掉set和get字符后剩下的字符的小写形式。例如，方法名为getId()，那么参数名字为id。</ul><h4 id=1-2-2-2、使用注解（推荐）><a class=headerlink href=#1-2-2-2、使用注解（推荐） title=1.2.2.2、使用注解（推荐）></a>1.2.2.2、使用注解（推荐）</h4><p>Java代码如下：<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line><span class=keyword>public</span> <span class=keyword>interface</span> <span class="title class_">usermapper</span> {</span><br><span class=line>    user <span class="title function_">selectuser</span><span class=params>(<span class=meta>@param(“username”)</span> string username, <span class=meta>@param(“hashedpassword”)</span> string hashedpassword)</span>;</span><br><span class=line>}</span><br></pre></table></figure><p>Mapper XML中使用方式：<figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre><td class=code><pre><span class=line><span class=tag><<span class=name>select</span> <span class=attr>id</span>=<span class=string>”selectuser”</span> <span class=attr>resulttype</span>=<span class=string>”user”</span>></span></span><br><span class=line>    select id, username, hashedpassword</span><br><span class=line>    from some_table</span><br><span class=line>    where username = #{username}</span><br><span class=line>    and hashedpassword = #{hashedpassword}</span><br><span class=line><span class=tag>&LT/<span class=name>select</span>></span></span><br></pre></table></figure><h4 id=1-2-2-3、使用索引><a class=headerlink href=#1-2-2-3、使用索引 title=1.2.2.3、使用索引></a>1.2.2.3、使用索引</h4><p>Java代码如下：<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line><span class=comment>// 对应xml来说，#{0}代表接收的第一个参数name，#{1}代表接收第二个参数area，以此类推。</span></span><br><span class=line><span class=keyword>public</span> User <span class="title function_">selectUser</span><span class=params>(String name, String area)</span>;</span><br></pre></table></figure><p>Mapper XML中使用方式：<figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line><span class=tag><<span class=name>select</span> <span class=attr>id</span>=<span class=string>"selectUser"</span> <span class=attr>resultMap</span>=<span class=string>"BaseResultMap"</span>></span></span><br><span class=line>    select * fromuser_user_t</span><br><span class=line>    whereuser_name = #{0}</span><br><span class=line>    anduser_area=#{1}</span><br><span class=line><span class=tag>&LT/<span class=name>select</span>></span></span><br></pre></table></figure><h4 id=1-2-2-4、使用Map><a class=headerlink href=#1-2-2-4、使用Map title=1.2.2.4、使用Map></a>1.2.2.4、使用Map</h4><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre><td class=code><pre><span class=line><span class=comment>// 映射文件的命名空间.SQL 片段的 ID，就可以调用对应的映射文件中的 SQL</span></span><br><span class=line><span class=comment>// 由于我们的参数超过了两个，而方法中只有一个 Object 参数收集，因此我们使用 Map 集合来装载我们的参数</span></span><br><span class=line>Map < String, Object > map = <span class=keyword>new</span> <span class="title class_">HashMap</span>();</span><br><span class=line>map.put(<span class=string>"start"</span>, start);</span><br><span class=line>map.put(<span class=string>"end"</span>, end);</span><br><span class=line><span class=keyword>return</span> sqlSession.selectList(<span class=string>"StudentID.pagination"</span>, map);</span><br></pre></table></figure><h3 id=1-2-3、原理><a class=headerlink href=#1-2-3、原理 title=1.2.3、原理></a>1.2.3、原理</h3><p>namespace 是接口全限名；MapperStatement id是接口方法名；传递给 sql 的参数是接口方法参数。<p>把 <strong>接口全限名+方法名</strong> 作为 key可定位一个MapperStatement。Mybatis 中的<code>&LTselect></code>、<code>&LTinsert></code>、<code>&LTupdate></code>、<code>&LTdelete></code>标签都会被解析成一个<code>MapperStatement</code>对象。<p><strong>MyBatis 使用JDK动态代理为 Mapper接口生成代理对象，代理对象会拦截对接口方法的调用，转而执行 MapperStatement 中的SQL，最后将 SQL 执行结果返回</strong>。<h2 id=1-3、XML映射文件><a class=headerlink href=#1-3、XML映射文件 title=1.3、XML映射文件></a>1.3、XML映射文件</h2><h3 id=1-3-1、XML标签><a class=headerlink href=#1-3-1、XML标签 title=1.3.1、XML标签></a>1.3.1、XML标签</h3><p>SQL映射文件中只有少数几个顶级标签元素：<ol><li><strong>cache</strong>：当前命名空间的缓存配置。<li><strong>cache-ref</strong>：引用其它命名空间的缓存配置。<li><strong>resultMap</strong>：描述如何从数据库结果集中加载对象。<li><strong>parameterMap</strong>：老式风格的参数映射。该标签已被废弃，推荐使用行内参数映射。<li><strong>sql</strong>：可被其它语句引用的可重用语句块。<li><strong>insert</strong>：映射插入语句。<li><strong>update</strong>：映射更新语句。<li><strong>delete</strong>：映射删除语句。<li><strong>select</strong>：映射查询语句。</ol><p>除了上面几个顶级标签外，<strong>还有9个动态sql标签</strong>。<h3 id=1-3-2、命名空间><a class=headerlink href=#1-3-2、命名空间 title=1.3.2、命名空间></a>1.3.2、命名空间</h3><p>如果Mapper XML中配置了namespace，不同xml中的SQL语句所在的标签中的id可以重复。因为namespace+id 会当作 Map 的 key 来使用，如果没有 namespace，id重复会造成数据覆盖。<h3 id=1-3-3、字段映射><a class=headerlink href=#1-3-3、字段映射 title=1.3.3、字段映射></a>1.3.3、字段映射</h3><h4 id=1-3-3-1、简介><a class=headerlink href=#1-3-3-1、简介 title=1.3.3.1、简介></a>1.3.3.1、简介</h4><p>查询到数据后会将查询结果数据映射封装到实体类或集合容器中，要注意的是，sql查询字段需要与实体类中的属性相同。当数据库表字段与Java实体类字段不同时需要进行处理，处理方法有：定义别名、resultMap映射等。<p><strong>MyBatis 通过反射创建对象，然后初始化对象属性，无映射关系的属性无法完成初始化</strong>。<p>ResultMap VS ResultType<ol><li>resultMap 可实现延迟加载，而 resultType 无法实现；<li>无特殊要求情况下，查询选择 resultType，否则选择 resultMap；<li>使用 resultType 时通过 pojo 对象来实现结果集映射；<li>使用 resultMap 时，利用 association 和 collection 可实现一对多、多对多的结果映射；</ol><h4 id=1-3-3-2、定义别名><a class=headerlink href=#1-3-3-2、定义别名 title=1.3.3.2、定义别名></a>1.3.3.2、定义别名</h4><p>通过在 SQL 中定义字段别名：<figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line><span class=tag><<span class=name>select</span> <span class=attr>id</span>=<span class=string>”selectorder”</span> <span class=attr>parametertype</span>=<span class=string>”int”</span> <span class=attr>resultetype</span>=<span class=string>”me.gacl.domain.order”</span>></span></span><br><span class=line>    select order_id id, order_no orderno, order_price price </span><br><span class=line>    from orders </span><br><span class=line>    where order_id=#{id};</span><br><span class=line><span class=tag>&LT/<span class=name>select</span>></span></span><br></pre></table></figure><h4 id=1-3-3-3、设置resultMap><a class=headerlink href=#1-3-3-3、设置resultMap title=1.3.3.3、设置resultMap></a>1.3.3.3、设置resultMap</h4><p>通过映射字段名和实体类属性名来达到一致：<figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre><td class=code><pre><span class=line><span class=tag><<span class=name>resultMap</span> <span class=attr>type</span>=<span class=string>”me.gacl.domain.order”</span> <span class=attr>id</span>=<span class=string>”orderresultmap”</span>></span></span><br><span class=line>    <span class=tag><<span class=name>id</span> <span class=attr>property</span>=<span class=string>”id”</span> <span class=attr>column</span>=<span class=string>”order_id”</span>></span></span><br><span class=line>    <span class=tag><<span class=name>result</span> <span class=attr>property</span> = <span class=string>“orderno”</span> <span class=attr>column</span> =<span class=string>”order_no”/</span>></span></span><br><span class=line>    <span class=tag><<span class=name>result</span> <span class=attr>property</span>=<span class=string>”price”</span> <span class=attr>column</span>=<span class=string>”order_price”</span> /></span></span><br><span class=line><span class=tag>&LT/<span class=name>reslutMap</span>></span></span><br><span class=line>    </span><br><span class=line><span class=tag><<span class=name>select</span> <span class=attr>id</span>=<span class=string>"getOrder"</span> <span class=attr>parameterType</span>=<span class=string>"int"</span>  <span class=attr>resultMap</span>=<span class=string>"orderresultmap"</span>></span></span><br><span class=line>    select * from orders where order_id = #{id}</span><br><span class=line><span class=tag>&LT/<span class=name>select</span>></span></span><br></pre></table></figure><h3 id=1-3-4、关联查询><a class=headerlink href=#1-3-4、关联查询 title=1.3.4、关联查询></a>1.3.4、关联查询</h3><p>关联查询有 联合查询 和 嵌套查询 两种方式：<ul><li><strong>联合查询</strong>：几个表连接后只查询一次，使用resultMap来作为结果的返回类型。<li><strong>嵌套查询</strong>：先查一个表，然后根据该表返回结果中的外键 id再去查询另一个表。</ul><p>代码实现<figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br></pre><td class=code><pre><span class=line><span class=tag><<span class=name>mapper</span> <span class=attr>namespace</span>=<span class=string>"com.lcb.mapping.userMapper"</span>></span></span><br><span class=line>    <span class=comment>&LT!--association 一对一或多对一关联查询 --></span></span><br><span class=line>    <span class=tag><<span class=name>resultMap</span> <span class=attr>type</span>=<span class=string>"com.lcb.user.Classes"</span> <span class=attr>id</span>=<span class=string>"ClassesResultMap"</span>></span></span><br><span class=line>        <span class=tag><<span class=name>id</span> <span class=attr>property</span>=<span class=string>"id"</span> <span class=attr>column</span>=<span class=string>"c_id"</span>/></span></span><br><span class=line>        <span class=tag><<span class=name>result</span> <span class=attr>property</span>=<span class=string>"name"</span> <span class=attr>column</span>=<span class=string>"c_name"</span>/></span></span><br><span class=line>        <span class=tag><<span class=name>association</span> <span class=attr>property</span>=<span class=string>"teacher"</span> <span class=attr>javaType</span>=<span class=string>"com.lcb.user.Teacher"</span>></span></span><br><span class=line>            <span class=tag><<span class=name>id</span> <span class=attr>property</span>=<span class=string>"id"</span> <span class=attr>column</span>=<span class=string>"t_id"</span>/></span></span><br><span class=line>            <span class=tag><<span class=name>result</span> <span class=attr>property</span>=<span class=string>"name"</span> <span class=attr>column</span>=<span class=string>"t_name"</span>/></span></span><br><span class=line>        <span class=tag>&LT/<span class=name>association</span>></span></span><br><span class=line>    <span class=tag>&LT/<span class=name>resultMap</span>></span></span><br><span class=line>    <span class=tag><<span class=name>select</span> <span class=attr>id</span>=<span class=string>"getClass"</span> <span class=attr>parameterType</span>=<span class=string>"int"</span> <span class=attr>resultMap</span>=<span class=string>"ClassesResultMap"</span>></span></span><br><span class=line>        select * </span><br><span class=line>        from class c, teacher t</span><br><span class=line>        where c.teacher_id = t.t_id and c.c_id = #{id}</span><br><span class=line>    <span class=tag>&LT/<span class=name>select</span>></span></span><br><span class=line>    </span><br><span class=line>    <span class=comment>&LT!--collection 一对多关联查询 --></span></span><br><span class=line>    <span class=tag><<span class=name>resultMap</span> <span class=attr>type</span>=<span class=string>"com.lcb.user.Classes"</span> <span class=attr>id</span>=<span class=string>"ClassesResultMap2"</span>></span></span><br><span class=line>        <span class=tag><<span class=name>id</span> <span class=attr>property</span>=<span class=string>"id"</span> <span class=attr>column</span>=<span class=string>"c_id"</span>/></span></span><br><span class=line>        <span class=tag><<span class=name>result</span> <span class=attr>property</span>=<span class=string>"name"</span> <span class=attr>column</span>=<span class=string>"c_name"</span>/></span></span><br><span class=line>        <span class=tag><<span class=name>association</span> <span class=attr>property</span>=<span class=string>"teacher"</span> <span class=attr>javaType</span>=<span class=string>"com.lcb.user.Teacher"</span>></span></span><br><span class=line>            <span class=tag><<span class=name>id</span> <span class=attr>property</span>=<span class=string>"id"</span> <span class=attr>column</span>=<span class=string>"t_id"</span>/></span></span><br><span class=line>            <span class=tag><<span class=name>result</span> <span class=attr>property</span>=<span class=string>"name"</span> <span class=attr>column</span>=<span class=string>"t_name"</span>/></span></span><br><span class=line>        <span class=tag>&LT/<span class=name>association</span>></span></span><br><span class=line>        <span class=tag><<span class=name>collection</span> <span class=attr>property</span>=<span class=string>"student"</span> <span class=attr>ofType</span>=<span class=string>"com.lcb.user.Student"</span>></span></span><br><span class=line>            <span class=tag><<span class=name>id</span> <span class=attr>property</span>=<span class=string>"id"</span> <span class=attr>column</span>=<span class=string>"s_id"</span>/></span></span><br><span class=line>            <span class=tag><<span class=name>result</span> <span class=attr>property</span>=<span class=string>"name"</span> <span class=attr>column</span>=<span class=string>"s_name"</span>/></span></span><br><span class=line>        <span class=tag>&LT/<span class=name>collection</span>></span></span><br><span class=line>    <span class=tag>&LT/<span class=name>resultMap</span>></span></span><br><span class=line>    <span class=tag><<span class=name>select</span> <span class=attr>id</span>=<span class=string>"getClass2"</span> <span class=attr>parameterType</span>=<span class=string>"int"</span> <span class=attr>resultMap</span>=<span class=string>"ClassesResultMap2"</span>></span></span><br><span class=line>        select * </span><br><span class=line>        from class c, teacher t, student s </span><br><span class=line>        where c.teacher_id = t.t_id and c.c_id = s.class_id and c.c_id = #{id}</span><br><span class=line>    <span class=tag>&LT/<span class=name>select</span>></span></span><br><span class=line><span class=tag>&LT/<span class=name>mapper</span>></span></span><br></pre></table></figure><h3 id=1-3-5、动态SQL><a class=headerlink href=#1-3-5、动态SQL title=1.3.5、动态SQL></a>1.3.5、动态SQL</h3><h4 id=1-3-5-1、简介><a class=headerlink href=#1-3-5-1、简介 title=1.3.5.1、简介></a>1.3.5.1、简介</h4><p>在 Xml 映射文件内以标签形式编写动态SQL，可以满足不同业务逻辑的需要。<p>常见动态标签有：<em><strong>if、trim、where、set、foreach、when、choose、bind、otherwise；</strong></em><h4 id=1-3-5-2、原理><a class=headerlink href=#1-3-5-2、原理 title=1.3.5.2、原理></a>1.3.5.2、原理</h4><p>原理：<strong>根据 表达式值 完成 逻辑判断 和 SQL动态拼接</strong>。<h1 id=2、增删改查><a class=headerlink href=#2、增删改查 title=2、增删改查></a>2、增删改查</h1><h2 id=2-1、查询操作><a class=headerlink href=#2-1、查询操作 title=2.1、查询操作></a>2.1、查询操作</h2><h3 id=2-1-1、概述><a class=headerlink href=#2-1-1、概述 title=2.1.1、概述></a>2.1.1、概述</h3><p>查询一条数据时，返回值类型可以是实体类、集合Map<p>查询多条数据时，返回值类型可以选择：集合List、集合Map+泛型（方法使用注解@MapKey来标识，在该注解中可从查询结果中选择某个字段来作为Map的键。）<h3 id=2-1-2、模糊查询><a class=headerlink href=#2-1-2、模糊查询 title=2.1.2、模糊查询></a>2.1.2、模糊查询</h3><h4 id=2-1-2-1、简介><a class=headerlink href=#2-1-2-1、简介 title=2.1.2.1、简介></a>2.1.2.1、简介</h4><p>在SQL中使用通配符<code>%</code>可以实现模糊查询。<h4 id=2-1-2-2、分类><a class=headerlink href=#2-1-2-2、分类 title=2.1.2.2、分类></a>2.1.2.2、分类</h4><p>（1）双引号 + #{} + %（推荐）<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line><span class=keyword>select</span> <span class=operator>*</span> <span class=keyword>from</span> foo <span class=keyword>where</span> bar <span class=keyword>like</span> "%"#{<span class=keyword>value</span>}"%";</span><br></pre></table></figure><p>（2）单引号 + ${} + %<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line><span class=keyword>select</span> <span class=operator>*</span> <span class=keyword>from</span> foo <span class=keyword>where</span> bar <span class=keyword>like</span> <span class=string>'%${value}%'</span>;</span><br></pre></table></figure><p>（3）通过concat函数拼接<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line><span class=keyword>select</span> <span class=operator>*</span> <span class=keyword>from</span> foo <span class=keyword>where</span> bar <span class=keyword>like</span> concat(<span class=string>'%'</span>, #{name}, <span class=string>'%'</span>);</span><br></pre></table></figure><p>（4）通过StringBuilder拼接%和参数值，xml中直接使用#{}<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line><span class=type>String</span> <span class=variable>searchText</span> <span class=operator>=</span> <span class=keyword>new</span> <span class="title class_">StringBuilder</span>(<span class=string>"%"</span>).append(text).append(<span class=string>"%"</span>).toString();</span><br><span class=line><span class=comment>// sql</span></span><br><span class=line>select * from foo where bar like #{value}</span><br></pre></table></figure><p><font color=red>注意：在SQL语句中拼接通配符易导致SQL注入，不推荐该种方式。</font><h3 id=2-1-3、延迟查询><a class=headerlink href=#2-1-3、延迟查询 title=2.1.3、延迟查询></a>2.1.3、延迟查询</h3><h4 id=2-1-3-1、简介><a class=headerlink href=#2-1-3-1、简介 title=2.1.3.1、简介></a>2.1.3.1、简介</h4><p><strong>Mybatis 仅支持 association 关联对象和 collection 关联集合对象的延迟加载</strong>。<h4 id=2-1-3-2、使用步骤><a class=headerlink href=#2-1-3-2、使用步骤 title=2.1.3.2、使用步骤></a>2.1.3.2、使用步骤</h4><p><strong>（1）开启延迟加载功能</strong><p>在mybatis配置文件中settings标签中进行配置。<figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line><span class=tag><<span class=name>settings</span>></span></span><br><span class=line>	<span class=tag><<span class=name>setting</span> <span class=attr>name</span>=<span class=string>"lazyLoadingEnabled"</span> <span class=attr>value</span>=<span class=string>"true"</span>/></span></span><br><span class=line>    <span class=tag><<span class=name>setting</span> <span class=attr>name</span>=<span class=string>"aggressiveLazyLoading"</span> <span class=attr>value</span>=<span class=string>"false"</span>/></span></span><br><span class=line><span class=tag>&LT/<span class=name>settings</span>></span></span><br></pre></table></figure><p><strong>（2）mapper xml中配置多对一映射</strong><figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br></pre><td class=code><pre><span class=line><span class=tag><<span class=name>resultMap</span> <span class=attr>id</span>=<span class=string>"empResult3"</span> <span class=attr>type</span>=<span class=string>"Emp"</span>></span></span><br><span class=line>    <span class=tag><<span class=name>id</span> <span class=attr>column</span>=<span class=string>"e_id"</span> <span class=attr>property</span>=<span class=string>"eId"</span>/></span></span><br><span class=line>    <span class=tag><<span class=name>result</span> <span class=attr>column</span>=<span class=string>"e_name"</span> <span class=attr>property</span>=<span class=string>"eName"</span>/></span></span><br><span class=line>    <span class=tag><<span class=name>result</span> <span class=attr>column</span>=<span class=string>"e_age"</span> <span class=attr>property</span>=<span class=string>"eAge"</span>/></span></span><br><span class=line>    <span class=tag><<span class=name>result</span> <span class=attr>column</span>=<span class=string>"e_gender"</span> <span class=attr>property</span>=<span class=string>"eGender"</span>/></span></span><br><span class=line>    <span class=comment>&LT!-- fetchType表示提取类型，可取值为eaager（立即加载）、lazy（延迟加载）。 --></span></span><br><span class=line>    <span class=tag><<span class=name>association</span> <span class=attr>property</span>=<span class=string>"dept"</span> <span class=attr>select</span>=<span class=string>"cn.shh.mybatis.mapper.DeptMapper.getDeptById"</span> </span></span><br><span class=line><span class=tag>                 <span class=attr>column</span>=<span class=string>"d_id"</span> <span class=attr>fetchType</span>=<span class=string>"lazy/eager"</span>></span></span><br><span class=line>    <span class=tag>&LT/<span class=name>association</span>></span></span><br><span class=line><span class=tag>&LT/<span class=name>reslutMap</span>></span></span><br><span class=line></span><br><span class=line><span class=tag><<span class=name>selec</span> <span class=attr>id</span>=<span class=string>"getEmpById"</span> <span class=attr>parameterType</span>=<span class=string>"int"</span> <span class=attr>resultMap</span>=<span class=string>"empResult3"</span>></span></span><br><span class=line>	select * from tbl_emp e left join tbl_dept d on e.d_id = d.d_id where e.e_id = #{eId}</span><br><span class=line><span class=tag>&LT/<span class=name>selec</span>></span></span><br></pre></table></figure><h4 id=2-1-3-3、底层原理><a class=headerlink href=#2-1-3-3、底层原理 title=2.1.3.3、底层原理></a>2.1.3.3、底层原理</h4><p>原理就是<strong>使用 CGLIB 创建目标对象的代理对象，调用目标方法时先进入拦截器方法执行相关操作</strong>。<p>比如：调用 a.getB().getName()，拦截器 invoke()方法发现 a.getB()是null 值，那么就会单独发送事先保存好的查询关联 B 对象的 sql，把 B 查询出来并调用 a.setB(b)进行初始化，然后调用getName()方法获取结果。这就是延迟加载基本原理。<blockquote><p>其它 持久层框架 延迟加载原理 与MyBatis一样。</blockquote><h3 id=2-1-4、分页查询><a class=headerlink href=#2-1-4、分页查询 title=2.1.4、分页查询></a>2.1.4、分页查询</h3><h4 id=2-1-4-1、简介><a class=headerlink href=#2-1-4-1、简介 title=2.1.4.1、简介></a>2.1.4.1、简介</h4><p><strong>Mybatis通过 RowBounds 对象进行分页，通过操作 ResultSet 结果集实现内存分页，而非物理分页</strong>。<p>注意：可编写分页SQL完成物理分页功能，也可使用分页插件来完成物理分页。<h4 id=2-1-4-2、分页原理><a class=headerlink href=#2-1-4-2、分页原理 title=2.1.4.2、分页原理></a>2.1.4.2、分页原理</h4><p>基本原理是 <strong>通过实现Mybatis插件接口来自定义插件，插件会拦截待执行SQL，并重写SQL来实现分页</strong>。<h3 id=2-1-5、一对多查询><a class=headerlink href=#2-1-5、一对多查询 title=2.1.5、一对多查询></a>2.1.5、一对多查询</h3><figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br></pre><td class=code><pre><span class=line><span class=comment>&LT!-- 方式一：collection --></span></span><br><span class=line><span class=tag><<span class=name>resultMap</span> <span class=attr>id</span>=<span class=string>"deptResult"</span> <span class=attr>type</span>=<span class=string>"Dept"</span>></span></span><br><span class=line>    <span class=tag><<span class=name>id</span> <span class=attr>column</span>=<span class=string>"d_id"</span> <span class=attr>property</span>=<span class=string>"dId"</span>/></span></span><br><span class=line>    <span class=tag><<span class=name>result</span> <span class=attr>column</span>=<span class=string>"d_name"</span> <span class=attr>property</span>=<span class=string>"dName"</span>/></span></span><br><span class=line>    <span class=tag><<span class=name>collection</span> <span class=attr>property</span>=<span class=string>"emps"</span> <span class=attr>ofType</span>=<span class=string>"Emp"</span>></span></span><br><span class=line>    	<span class=tag><<span class=name>id</span> <span class=attr>column</span>=<span class=string>"e_id"</span> <span class=attr>property</span>=<span class=string>"eId"</span>/></span></span><br><span class=line>        <span class=tag><<span class=name>result</span> <span class=attr>column</span>=<span class=string>"e_name"</span> <span class=attr>property</span>=<span class=string>"eName"</span>/></span></span><br><span class=line>        <span class=tag><<span class=name>result</span> <span class=attr>column</span>=<span class=string>"e_age"</span> <span class=attr>property</span>=<span class=string>"eAge"</span>/></span></span><br><span class=line>        <span class=tag><<span class=name>result</span> <span class=attr>column</span>=<span class=string>"e_gender"</span> <span class=attr>property</span>=<span class=string>"eGender"</span>/></span></span><br><span class=line>    <span class=tag>&LT/<span class=name>collection</span>></span></span><br><span class=line><span class=tag>&LT/<span class=name>reslutMap</span>></span></span><br><span class=line></span><br><span class=line><span class=comment>&LT!-- 方式二：分步查询 --></span></span><br><span class=line><span class=tag><<span class=name>resultMap</span> <span class=attr>id</span>=<span class=string>"deptResult2"</span> <span class=attr>type</span>=<span class=string>"Dept"</span>></span></span><br><span class=line>	<span class=tag><<span class=name>id</span> <span class=attr>column</span>=<span class=string>"d_id"</span> <span class=attr>property</span>=<span class=string>"dId"</span>/></span></span><br><span class=line>    <span class=tag><<span class=name>result</span> <span class=attr>column</span>=<span class=string>"d_name"</span> <span class=attr>property</span>=<span class=string>"dName"</span>/></span></span><br><span class=line>    <span class=comment>&LT!-- fetch表示数据提取方式，可取值lazy和eager，eager表示立即加载，lazy表示延迟加载 --></span></span><br><span class=line>    <span class=tag><<span class=name>collection</span> <span class=attr>property</span>=<span class=string>"emps"</span> <span class=attr>fetch</span>=<span class=string>"lazy|eager"</span> <span class=attr>select</span>=<span class=string>"cn.shh.mybatis.mapper.EmpMapper.getEmpById"</span> <span class=attr>column</span>=<span class=string>"d_id"</span>/></span></span><br><span class=line><span class=tag>&LT/<span class=name>resultMap</span>></span></span><br></pre></table></figure><h3 id=2-1-6、多对一查询><a class=headerlink href=#2-1-6、多对一查询 title=2.1.6、多对一查询></a>2.1.6、多对一查询</h3><figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br></pre><td class=code><pre><span class=line><span class=comment>&LT!-- 方式一：级联查询 --></span></span><br><span class=line><span class=tag><<span class=name>resultMap</span> <span class=attr>id</span>=<span class=string>"empResult"</span> <span class=attr>type</span>=<span class=string>"Emp"</span>></span></span><br><span class=line>    <span class=tag><<span class=name>id</span> <span class=attr>column</span>=<span class=string>"e_id"</span> <span class=attr>property</span>=<span class=string>"eId"</span>/></span></span><br><span class=line>    <span class=tag><<span class=name>result</span> <span class=attr>column</span>=<span class=string>"e_name"</span> <span class=attr>property</span>=<span class=string>"eName"</span>/></span></span><br><span class=line>    <span class=tag><<span class=name>result</span> <span class=attr>column</span>=<span class=string>"e_age"</span> <span class=attr>property</span>=<span class=string>"eAge"</span>/></span></span><br><span class=line>    <span class=tag><<span class=name>result</span> <span class=attr>column</span>=<span class=string>"e_gender"</span> <span class=attr>property</span>=<span class=string>"eGender"</span>/></span></span><br><span class=line>    <span class=tag><<span class=name>result</span> <span class=attr>column</span>=<span class=string>"d_id"</span> <span class=attr>property</span>=<span class=string>"dept.dId"</span>/></span></span><br><span class=line>    <span class=tag><<span class=name>result</span> <span class=attr>column</span>=<span class=string>"d_name"</span> <span class=attr>property</span>=<span class=string>"dept.dName"</span>/></span></span><br><span class=line><span class=tag>&LT/<span class=name>reslutMap</span>></span></span><br><span class=line></span><br><span class=line><span class=comment>&LT!-- 方式二：association --></span></span><br><span class=line><span class=tag><<span class=name>resultMap</span> <span class=attr>id</span>=<span class=string>"empResult2"</span> <span class=attr>type</span>=<span class=string>"Emp"</span>></span></span><br><span class=line>    <span class=tag><<span class=name>id</span> <span class=attr>column</span>=<span class=string>"e_id"</span> <span class=attr>property</span>=<span class=string>"eId"</span>/></span></span><br><span class=line>    <span class=tag><<span class=name>result</span> <span class=attr>column</span>=<span class=string>"e_name"</span> <span class=attr>property</span>=<span class=string>"eName"</span>/></span></span><br><span class=line>    <span class=tag><<span class=name>result</span> <span class=attr>column</span>=<span class=string>"e_age"</span> <span class=attr>property</span>=<span class=string>"eAge"</span>/></span></span><br><span class=line>    <span class=tag><<span class=name>result</span> <span class=attr>column</span>=<span class=string>"e_gender"</span> <span class=attr>property</span>=<span class=string>"eGender"</span>/></span></span><br><span class=line>    <span class=tag><<span class=name>association</span> <span class=attr>property</span>=<span class=string>"dept"</span> <span class=attr>javaType</span>=<span class=string>"Dept"</span>></span></span><br><span class=line>    	<span class=tag><<span class=name>id</span> <span class=attr>column</span>=<span class=string>"d_id"</span> <span class=attr>property</span>=<span class=string>"dId"</span>/></span></span><br><span class=line>        <span class=tag><<span class=name>result</span> <span class=attr>column</span>=<span class=string>"d_name"</span> <span class=attr>property</span>=<span class=string>"dName"</span>/></span></span><br><span class=line>    <span class=tag>&LT/<span class=name>association</span>></span></span><br><span class=line><span class=tag>&LT/<span class=name>reslutMap</span>></span></span><br><span class=line></span><br><span class=line><span class=comment>&LT!-- 方式三：分步查询 --></span></span><br><span class=line><span class=tag><<span class=name>resultMap</span> <span class=attr>id</span>=<span class=string>"empResult3"</span> <span class=attr>type</span>=<span class=string>"Emp"</span>></span></span><br><span class=line>    <span class=tag><<span class=name>id</span> <span class=attr>column</span>=<span class=string>"e_id"</span> <span class=attr>property</span>=<span class=string>"eId"</span>/></span></span><br><span class=line>    <span class=tag><<span class=name>result</span> <span class=attr>column</span>=<span class=string>"e_name"</span> <span class=attr>property</span>=<span class=string>"eName"</span>/></span></span><br><span class=line>    <span class=tag><<span class=name>result</span> <span class=attr>column</span>=<span class=string>"e_age"</span> <span class=attr>property</span>=<span class=string>"eAge"</span>/></span></span><br><span class=line>    <span class=tag><<span class=name>result</span> <span class=attr>column</span>=<span class=string>"e_gender"</span> <span class=attr>property</span>=<span class=string>"eGender"</span>/></span></span><br><span class=line>    <span class=comment>&LT!-- fetch表示数据提取方式，可取值lazy和eager，eager表示立即加载，lazy表示延迟加载 --></span></span><br><span class=line>    <span class=tag><<span class=name>association</span> <span class=attr>property</span>=<span class=string>"dept"</span> <span class=attr>fetch</span>=<span class=string>"lazy|eager"</span> <span class=attr>select</span>=<span class=string>"cn.shh.mybatis.mapper.DeptMapper.getDeptById"</span> <span class=attr>column</span>=<span class=string>"d_id"</span>></span><span class=tag>&LT/<span class=name>association</span>></span></span><br><span class=line><span class=tag>&LT/<span class=name>reslutMap</span>></span></span><br></pre></table></figure><h2 id=2-2、插入操作><a class=headerlink href=#2-2、插入操作 title=2.2、插入操作></a>2.2、插入操作</h2><h3 id=2-2-1、自增长键值><a class=headerlink href=#2-2-1、自增长键值 title=2.2.1、自增长键值></a>2.2.1、自增长键值</h3><p><strong>insert 方法总是返回一个 int 值，该值表示插入行数</strong>。<p>如果采用自增长策略，自动生成的键值在 insert 方法执行完后会被设置到传入的参数对象中。<p>java代码：<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre><td class=code><pre><span class=line><span class=keyword>private</span> <span class=keyword>void</span> <span class="title function_">save</span><span class=params>()</span>{</span><br><span class=line>    <span class=type>User</span> <span class=variable>u</span> <span class=operator>=</span> <span class=keyword>new</span> <span class="title class_">User</span>();</span><br><span class=line>    u.setname(“fred”);</span><br><span class=line>    <span class=type>int</span> <span class=variable>rows</span> <span class=operator>=</span> mapper.saveUser(u);</span><br><span class=line>    system.out.println(“插入行数 = ” + rows);</span><br><span class=line>    system.out.println(“自增长值 = ” + u.getid());</span><br><span class=line>}</span><br></pre></table></figure><p>xml代码：<p>参数<code>usegeneratedkeys</code>可设置是否开启自动生成ID值。参数<code>keyproperty</code>用来设置接收生成的ID值。<figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line><span class=tag><<span class=name>insert</span> <span class=attr>id</span>=<span class=string>”saveUser”</span> <span class=attr>usegeneratedkeys</span>=<span class=string>”true”</span> <span class=attr>keyproperty</span>=<span class=string>”id”</span>></span></span><br><span class=line>    insert into users(name) values(#{name})</span><br><span class=line><span class=tag>&LT/<span class=name>insert</span>></span></span><br></pre></table></figure><h3 id=2-2-2、批量插入><a class=headerlink href=#2-2-2、批量插入 title=2.2.2、批量插入></a>2.2.2、批量插入</h3><h4 id=2-2-2-1、foreach标签模式><a class=headerlink href=#2-2-2-1、foreach标签模式 title=2.2.2.1、foreach标签模式></a>2.2.2.1、foreach标签模式</h4><p>java代码：<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line><span class=comment>// java代码</span></span><br><span class=line>List&LTYourType> dataList = ...;</span><br><span class=line>yourMapper.insertBatch(dataList);</span><br></pre></table></figure><p>xml代码：<figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre><td class=code><pre><span class=line><span class=tag><<span class=name>insert</span> <span class=attr>id</span>=<span class=string>"insertBatch"</span> <span class=attr>parameterType</span>=<span class=string>"list"</span>></span></span><br><span class=line>    INSERT INTO table_name (column1, column2, column3)</span><br><span class=line>    VALUES</span><br><span class=line>    <span class=tag><<span class=name>foreach</span> <span class=attr>collection</span>=<span class=string>"list"</span> <span class=attr>item</span>=<span class=string>"item"</span> <span class=attr>separator</span>=<span class=string>","</span>></span></span><br><span class=line>        (#{item.column1}, #{item.column2}, #{item.column3})</span><br><span class=line>    <span class=tag>&LT/<span class=name>foreach</span>></span></span><br><span class=line><span class=tag>&LT/<span class=name>insert</span>></span></span><br></pre></table></figure><p>优点：<ul><li>实现简单，适合小批量数据的插入操作。</ul><p>缺点：<ul><li>如果数据量较大，生成的SQL语句也会较大，可能会超出数据库的SQL语句长度限制。<li>性能较差，因为数据量增多时SQL拼接和执行效率较低。</ul><p>适用场景： 适用于小规模的数据批量插入操作（例如上百条左右）。<h4 id=2-2-2-2、ExecutorType-BATCH模式><a class=headerlink href=#2-2-2-2、ExecutorType-BATCH模式 title=2.2.2.2、ExecutorType.BATCH模式></a>2.2.2.2、ExecutorType.BATCH模式</h4><p>java代码：<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br></pre><td class=code><pre><span class=line><span class=type>SqlSession</span> <span class=variable>sqlSession</span> <span class=operator>=</span> sqlSessionFactory.openSession(ExecutorType.BATCH);</span><br><span class=line><span class=type>YourMapper</span> <span class=variable>mapper</span> <span class=operator>=</span> sqlSession.getMapper(YourMapper.class);</span><br><span class=line><span class=keyword>try</span> {</span><br><span class=line>    <span class=keyword>for</span> (YourType item : dataList) {</span><br><span class=line>        mapper.insert(item);</span><br><span class=line>    }</span><br><span class=line>    sqlSession.commit();</span><br><span class=line>} <span class=keyword>catch</span> (Exception e) {</span><br><span class=line>    sqlSession.rollback();</span><br><span class=line>    <span class=keyword>throw</span> e;</span><br><span class=line>} <span class=keyword>finally</span> {</span><br><span class=line>    sqlSession.close();</span><br><span class=line>}</span><br></pre></table></figure><p>优点：<ul><li>减少了数据库连接次数，性能相比逐条插入有较大提升。<li>不受SQL语句长度限制，适用于中大规模的数据批量插入。</ul><p>缺点：<ul><li>需要手动管理事务和<code>sqlSession</code>。<li>出错时难以定位具体的出错数据。</ul><p>适用场景： 适合中等规模的数据批量插入操作。<h4 id=2-2-2-3、数据库批量插入模式><a class=headerlink href=#2-2-2-3、数据库批量插入模式 title=2.2.2.3、数据库批量插入模式></a>2.2.2.3、数据库批量插入模式</h4><p>有些数据库（如MySQL、PostgreSQL）支持批量插入的语法，可以将多条数据一次性插入。例如在MySQL中，可以使用<code>INSERT INTO ... VALUES ...</code>的多值格式，这种方式通常会在性能上有所提升。<p>xml代码：<figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre><td class=code><pre><span class=line><span class=tag><<span class=name>insert</span> <span class=attr>id</span>=<span class=string>"insertBatch"</span> <span class=attr>parameterType</span>=<span class=string>"list"</span>></span></span><br><span class=line>    INSERT INTO table_name (column1, column2, column3)</span><br><span class=line>    VALUES</span><br><span class=line>    <span class=tag><<span class=name>foreach</span> <span class=attr>collection</span>=<span class=string>"list"</span> <span class=attr>item</span>=<span class=string>"item"</span> <span class=attr>separator</span>=<span class=string>","</span>></span></span><br><span class=line>        (#{item.column1}, #{item.column2}, #{item.column3})</span><br><span class=line>    <span class=tag>&LT/<span class=name>foreach</span>></span></span><br><span class=line><span class=tag>&LT/<span class=name>insert</span>></span></span><br></pre></table></figure><p>优点：<ul><li>效率较高，能充分利用数据库的批量插入特性。</ul><p>缺点：<ul><li>依赖于数据库的特性，可能在不支持批量插入的数据库中不可用。</ul><p>适用场景： 适用于MySQL和PostgreSQL等支持批量插入语法的数据库。<h4 id=2-2-2-4、第三方工具模式><a class=headerlink href=#2-2-2-4、第三方工具模式 title=2.2.2.4、第三方工具模式></a>2.2.2.4、第三方工具模式</h4><p>可以利用一些第三方库（如Spring的<code>JdbcTemplate</code>）或MyBatis插件来实现批量插入。这些工具和插件内部会优化批量插入的效率，例如Spring的<code>JdbcTemplate</code>会将批量插入作为一条命令进行执行。<p>java代码：<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br></pre><td class=code><pre><span class=line><span class=meta>@Autowired</span></span><br><span class=line><span class=keyword>private</span> JdbcTemplate jdbcTemplate;</span><br><span class=line></span><br><span class=line><span class=keyword>public</span> <span class=keyword>void</span> <span class="title function_">insertBatch</span><span class=params>(List&LTYourType> dataList)</span> {</span><br><span class=line>    <span class=type>String</span> <span class=variable>sql</span> <span class=operator>=</span> <span class=string>"INSERT INTO table_name (column1, column2, column3) VALUES (?, ?, ?)"</span>;</span><br><span class=line>    List&LTObject[]> batchArgs = <span class=keyword>new</span> <span class="title class_">ArrayList</span><>();</span><br><span class=line>    <span class=keyword>for</span> (YourType item : dataList) {</span><br><span class=line>        batchArgs.add(<span class=keyword>new</span> <span class="title class_">Object</span>[] { item.getColumn1(), item.getColumn2(), item.getColumn3() });</span><br><span class=line>    }</span><br><span class=line>    jdbcTemplate.batchUpdate(sql, batchArgs);</span><br><span class=line>}</span><br></pre></table></figure><p>优点：<ul><li>插入效率高，适合大规模批量操作。<li>能有效管理事务，错误时回滚数据。</ul><p>缺点：<ul><li>增加了项目的依赖和复杂度。</ul><p>适用场景： 适合对性能有较高要求的批量插入操作场景。<blockquote><p>推荐使用<strong>ExecutorType.BATCH模式</strong>或<strong>数据库特定的批量插入语法</strong>，根据实际的需求和数据库类型选择最合适的方案。</blockquote><h2 id=2-3、删除操作><a class=headerlink href=#2-3、删除操作 title=2.3、删除操作></a>2.3、删除操作</h2><h3 id=2-3-1、批量删除><a class=headerlink href=#2-3-1、批量删除 title=2.3.1、批量删除></a>2.3.1、批量删除</h3><p><strong>（1）使用foreach标签批量删除</strong><p>java代码：<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line>List&LTInteger> idsToDelete = Arrays.asList(<span class=number>1</span>, <span class=number>2</span>, <span class=number>3</span>, <span class=number>4</span>, <span class=number>5</span>);</span><br><span class=line>yourMapper.deleteBatch(idsToDelete);</span><br></pre></table></figure><p>xml代码：<figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre><td class=code><pre><span class=line><span class=tag><<span class=name>delete</span> <span class=attr>id</span>=<span class=string>"deleteBatch"</span> <span class=attr>parameterType</span>=<span class=string>"list"</span>></span></span><br><span class=line>    DELETE FROM table_name</span><br><span class=line>    WHERE id IN</span><br><span class=line>    <span class=tag><<span class=name>foreach</span> <span class=attr>collection</span>=<span class=string>"list"</span> <span class=attr>item</span>=<span class=string>"id"</span> <span class=attr>open</span>=<span class=string>"("</span> <span class=attr>separator</span>=<span class=string>","</span> <span class=attr>close</span>=<span class=string>")"</span>></span></span><br><span class=line>        #{id}</span><br><span class=line>    <span class=tag>&LT/<span class=name>foreach</span>></span></span><br><span class=line><span class=tag>&LT/<span class=name>delete</span>></span></span><br></pre></table></figure><p><strong>（2）使用ExecutorType.BATCH模式批量删除</strong><p>代码：<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br></pre><td class=code><pre><span class=line><span class=type>SqlSession</span> <span class=variable>sqlSession</span> <span class=operator>=</span> sqlSessionFactory.openSession(ExecutorType.BATCH);</span><br><span class=line><span class=type>YourMapper</span> <span class=variable>mapper</span> <span class=operator>=</span> sqlSession.getMapper(YourMapper.class);</span><br><span class=line><span class=keyword>try</span> {</span><br><span class=line>    <span class=keyword>for</span> (Integer id : idsToDelete) {</span><br><span class=line>        mapper.deleteById(id);</span><br><span class=line>    }</span><br><span class=line>    sqlSession.commit();</span><br><span class=line>} <span class=keyword>catch</span> (Exception e) {</span><br><span class=line>    sqlSession.rollback();</span><br><span class=line>    <span class=keyword>throw</span> e;</span><br><span class=line>} <span class=keyword>finally</span> {</span><br><span class=line>    sqlSession.close();</span><br><span class=line>}</span><br></pre></table></figure><h1 id=3、缓存><a class=headerlink href=#3、缓存 title=3、缓存></a>3、缓存</h1><h2 id=3-1、简介><a class=headerlink href=#3-1、简介 title=3.1、简介></a>3.1、简介</h2><p>当需要查询并加载数据库中的数据时，会先检查缓存中是否已经存在需要的数据，如果存在则直接读取缓冲中的数据并返回，如果不存才会从数据库中查询。<p>检查缓存的顺序如下：<ol><li>先查二级缓存，因为二级缓存可能已经执行了查询操作。<li>如果二级缓存没有，再查找一级缓存。<li>如果一级缓存也没有，则查询数据库。<li>SqlSession关闭后，一级缓存中的数据会写入二级缓存中。</ol><h2 id=3-2、一级缓存><a class=headerlink href=#3-2、一级缓存 title=3.2、一级缓存></a>3.2、一级缓存</h2><h3 id=3-2-1、简介><a class=headerlink href=#3-2-1、简介 title=3.2.1、简介></a>3.2.1、简介</h3><p><strong>一级缓存是基于PerpetualCache的HashMap本地缓存，作用域为 Session，默认打开</strong>。<h3 id=3-2-2、缓存失效><a class=headerlink href=#3-2-2、缓存失效 title=3.2.2、缓存失效></a>3.2.2、缓存失效</h3><p>一级缓存失效的四种情况：<ol><li>不同的SqlSession对应不同的一级缓存。<li>同一个SqlSession，但查询条件不同。<li>同一个SqlSession，两次查询期间执行了其它增删改操作。<li>同一个SqlSeesion，两次查询期间手动清空了缓存。（调用了clearCahche()方法）</ol><h2 id=3-3、二级缓存><a class=headerlink href=#3-3、二级缓存 title=3.3、二级缓存></a>3.3、二级缓存</h2><h3 id=3-3-1、简介><a class=headerlink href=#3-3-1、简介 title=3.3.1、简介></a>3.3.1、简介</h3><p><strong>二级缓存是基于PerpetualCache的HashMap本地缓存，作用域为Mapper(Namespace)，可自定义存储源</strong>。<h3 id=3-3-2、开启条件><a class=headerlink href=#3-3-2、开启条件 title=3.3.2、开启条件></a>3.3.2、开启条件</h3><p>二级缓存开启条件：<ol><li>在核心配置文件中，设置全局属性<code>cacheEnabled</code>为<code>true</code>（默认为true，无需设置）。<li>映射文件中设置标签<code>&LTcache/></code>。<li>二级缓存必须在SqlSession关闭或提交后有效。<li>查询结果转换的实体类必须实现序列化接口。</ol><p><font color=red>注意：要实现二级缓存效果，需要执行完查询操作后关闭SqlSession，因为关闭操作会触发缓存保存。</font><h3 id=3-3-3、缓存失效><a class=headerlink href=#3-3-3、缓存失效 title=3.3.3、缓存失效></a>3.3.3、缓存失效</h3><p>二级缓存失效的情况：两次查询期间执行了任意的增删改操作。<blockquote><p><font color=red>注意事项：在执行完 增删改 操作后，会对一级缓存和二级缓存进行清理。</font></blockquote><h3 id=3-3-4、配置参数><a class=headerlink href=#3-3-4、配置参数 title=3.3.4、配置参数></a>3.3.4、配置参数</h3><p>二级缓存相关配置参数如下：<ul><li><p><strong>eviction属性</strong>：缓存回收策略。</p> <ul><li>LRU（默认）：最近最少使用，默认配置。<li>FIFO：先进先出。<li>SOFT：软引用。<li>WEAK：弱引用。</ul><li><p><strong>flushInterval属性</strong>：刷新间隔，单位毫秒。默认没有配置该参数，缓存仅在调用语句时刷新。</p><li><p><strong>size属性</strong>：引用数量，正整数。表示缓存最多可以存储对象的数量，太大会导致内存溢出。</p><li><p><strong>readOnly属性</strong>：只读，可选值有true/false，默认值为false。值为true表示只读缓存。值为false表示读写缓存。</p></ul><h2 id=3-4、EhCache缓存><a class=headerlink href=#3-4、EhCache缓存 title=3.4、EhCache缓存></a>3.4、EhCache缓存</h2><h3 id=3-4-1、简介><a class=headerlink href=#3-4-1、简介 title=3.4.1、简介></a>3.4.1、简介</h3><p><strong>Ehcache由Greg Luck于2003年开发</strong>。2009年该项目被Terracotta收购，该公司提供有偿支持。<p>Ehcache是一个开源的Java分布式缓存，用于通用缓存、Java EE和轻量级容器。Ehcache在Apache开源许可下可用。<h3 id=3-4-2、使用步骤><a class=headerlink href=#3-4-2、使用步骤 title=3.4.2、使用步骤></a>3.4.2、使用步骤</h3><p><strong>（1）添加依赖</strong><figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line><span class=tag><<span class=name>dependency</span>></span></span><br><span class=line>    <span class=tag><<span class=name>groupId</span>></span>org.mybatis.caches<span class=tag>&LT/<span class=name>groupId</span>></span></span><br><span class=line>    <span class=tag><<span class=name>artifactId</span>></span>mybatis-ehcache<span class=tag>&LT/<span class=name>artifactId</span>></span></span><br><span class=line>    <span class=tag><<span class=name>version</span>></span>1.2.2<span class=tag>&LT/<span class=name>version</span>></span></span><br><span class=line><span class=tag>&LT/<span class=name>dependency</span>></span></span><br></pre></table></figure><p><strong>（2）添加ehcache.xml文件</strong><figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br></pre><td class=code><pre><span class=line><span class=meta>&LT?xml version=<span class=string>"1.0"</span> encoding=<span class=string>"UTF-8"</span>?></span></span><br><span class=line><span class=tag><<span class=name>ehcache</span> <span class=attr>xmlns:xsi</span>=<span class=string>"http://www.w3.org/2001/XMLSchema-instance"</span> <span class=attr>xsi:noNamespaceSchemaLocation</span>=<span class=string>"http://ehcache.org/ehcache.xsd"</span></span></span><br><span class=line><span class=tag>                    <span class=attr>updateCheck</span>=<span class=string>"false"</span>></span></span><br><span class=line></span><br><span class=line>    <span class=tag><<span class=name>diskStore</span> <span class=attr>path</span>=<span class=string>"D:\tmp\ssm"</span>/></span></span><br><span class=line>    <span class=tag><<span class=name>defaultCache</span></span></span><br><span class=line><span class=tag>        <span class=attr>eternal</span>=<span class=string>"false"</span></span></span><br><span class=line><span class=tag>        <span class=attr>maxElementsInMemory</span>=<span class=string>"10000"</span></span></span><br><span class=line><span class=tag>        <span class=attr>overflowToDisk</span>=<span class=string>"false"</span></span></span><br><span class=line><span class=tag>        <span class=attr>diskPersistent</span>=<span class=string>"false"</span></span></span><br><span class=line><span class=tag>        <span class=attr>timeToIdleSeconds</span>=<span class=string>"1800"</span></span></span><br><span class=line><span class=tag>        <span class=attr>timeToLiveSeconds</span>=<span class=string>"259200"</span></span></span><br><span class=line><span class=tag>        <span class=attr>memoryStoreEvictionPolicy</span>=<span class=string>"LRU"</span>/></span></span><br><span class=line>    <span class=tag><<span class=name>cache</span></span></span><br><span class=line><span class=tag>        <span class=attr>name</span>=<span class=string>"test_mybatis2l"</span></span></span><br><span class=line><span class=tag>        <span class=attr>eternal</span>=<span class=string>"false"</span></span></span><br><span class=line><span class=tag>        <span class=attr>maxElementsInMemory</span>=<span class=string>"5000"</span></span></span><br><span class=line><span class=tag>        <span class=attr>overflowToDisk</span>=<span class=string>"false"</span></span></span><br><span class=line><span class=tag>        <span class=attr>diskPersistent</span>=<span class=string>"false"</span></span></span><br><span class=line><span class=tag>        <span class=attr>timeToIdleSeconds</span>=<span class=string>"1800"</span></span></span><br><span class=line><span class=tag>        <span class=attr>timeToLiveSeconds</span>=<span class=string>"1800"</span></span></span><br><span class=line><span class=tag>        <span class=attr>memoryStoreEvictionPolicy</span>=<span class=string>"LRU"</span>/></span></span><br><span class=line><span class=tag>&LT/<span class=name>ehcache</span>></span></span><br></pre></table></figure><p><strong>（3）配置缓存标签，开启缓存</strong><p>在mapper映射文件中<strong>添加cache标签</strong>，设置type属性为EhcacheCache。<figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line><span class=tag><<span class=name>cache</span> <span class=attr>type</span>=<span class=string>"org.mybatis.caches.ehcache.EhcacheCache"</span>/></span></span><br></pre></table></figure><h1 id=4、插件><a class=headerlink href=#4、插件 title=4、插件></a>4、插件</h1><h2 id=4-1、底层原理><a class=headerlink href=#4-1、底层原理 title=4.1、底层原理></a>4.1、底层原理</h2><p><strong>Mybatis 仅可以编写针对 ParameterHandler、ResultSetHandler、StatementHandler、Executor 等4种接口类型的插件</strong>。Mybatis <strong>使用JDK 动态代理来实现接口方法拦截增强</strong>。每当执行这 4 种接口对象方法时，就会进入拦截方法（ InvocationHandler 的 invoke()方法）。<h2 id=4-2、自定义插件><a class=headerlink href=#4-2、自定义插件 title=4.2、自定义插件></a>4.2、自定义插件</h2><p>实现 Mybatis 的 Interceptor 接口并重写 intercept()方法，给插件编写注解，指定要拦截哪一个接口的哪些方法。<p><font color=red>注意：插件开发完毕后，要在配置文件中进行配置才会生效。</font><h2 id=4-3、分页插件><a class=headerlink href=#4-3、分页插件 title=4.3、分页插件></a>4.3、分页插件</h2><p>1）引入依赖<figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre><td class=code><pre><span class=line><span class=comment>&LT!--mybatis分页插件--></span></span><br><span class=line><span class=tag><<span class=name>dependency</span>></span></span><br><span class=line>    <span class=tag><<span class=name>groupId</span>></span>com.github.pagehelper<span class=tag>&LT/<span class=name>groupId</span>></span></span><br><span class=line>    <span class=tag><<span class=name>artifactId</span>></span>pagehelper<span class=tag>&LT/<span class=name>artifactId</span>></span></span><br><span class=line>    <span class=tag><<span class=name>version</span>></span>5.2.0<span class=tag>&LT/<span class=name>version</span>></span></span><br><span class=line><span class=tag>&LT/<span class=name>dependency</span>></span></span><br></pre></table></figure><p>2）配置分页插件<figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line><span class=comment>&LT!--分页插件--></span></span><br><span class=line><span class=tag><<span class=name>plugin</span> <span class=attr>interceptor</span>=<span class=string>"com.github.pagehelper.PageInterceptor"</span>></span><span class=tag>&LT/<span class=name>plugin</span>></span></span><br></pre></table></figure><p>3）使用示例<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br></pre><td class=code><pre><span class=line><span class=keyword>public</span> <span class=keyword>void</span> <span class="title function_">testGetUserPage</span><span class=params>()</span>{</span><br><span class=line>    <span class=keyword>try</span>(<span class=type>SqlSession</span> <span class=variable>sqlSession</span> <span class=operator>=</span> MyBatisUtil.getSqlSession()) {</span><br><span class=line>        <span class=type>UserMapper</span> <span class=variable>userMapper</span> <span class=operator>=</span> sqlSession.getMapper(UserMapper.class);</span><br><span class=line>        <span class=comment>// 开启分页</span></span><br><span class=line>        Page&LTObject> page = PageHelper.startPage(<span class=number>2</span>, <span class=number>3</span>);</span><br><span class=line>        List&LTUser> userList = userMapper.getAll();</span><br><span class=line>        PageInfo&LTUser> userPageInfo = <span class=keyword>new</span> <span class="title class_">PageInfo</span><>(userList);</span><br><span class=line>        userList.forEach(System.out::println);</span><br><span class=line>        System.out.println(<span class=string>"page: "</span> + page);</span><br><span class=line>        System.out.println(<span class=string>"pageInfo: "</span> + userPageInfo);</span><br><span class=line>    }</span><br><span class=line>}</span><br></pre></table></figure><h1 id=总结><a class=headerlink href=#总结 title=总结></a>总结</h1><h2 id=实体类对比><a class=headerlink href=#实体类对比 title=实体类对比></a>实体类对比</h2><h3 id=POJO><a class=headerlink href=#POJO title=POJO></a>POJO</h3><p>按照Martin Fowler的解释，<strong>POJO指的是“Plain Old Java Object”的首字母，字面翻译为纯洁老式Java对象，一般称为简单Java对象</strong>。<p>POJO是指那些 <strong>没有继承任何类、没有实现任何接口，没有业务方法，更没有被其它框架侵入的Java对象</strong>。<h3 id=Java-Bean><a title="Java Bean" class=headerlink href=#Java-Bean></a>Java Bean</h3><p>JavaBean是JAVA实现的<em><strong>可重用组件</strong></em>。必须符合如下约定：<ol><li>这个类<strong>必须有一个公共缺省构造函数</strong>。<li>这个<strong>类的属性使用getter和setter来访问</strong>，其他方法遵从标准命名规范。<li>这个<strong>类可以被序列化</strong>。</ol><blockquote><p>注意：<ol><li><em><strong>缺省构造函数 又叫 默认构造函数</strong></em>，也就是声明对象时会被编译器调用的一个构造函数。<li>若类中没有编写构造函数，编译器会自动添加一个缺省构造函数，该函数相当于一个不接受任何参数，不进行任何操作的构造函数。而当类中已经有编写的构造函数时，编译器就不会再自动生成。</ol></blockquote><blockquote><p>PoJo VS JavaBean：<ul><li>pojo用于数据的临时传递，它仅用于装数据，而不具有业务逻辑处理能力。<li>JavaBean的数据获取与pojo一样，但Java Bean中可以编写其它方法逻辑。</ul></blockquote><h3 id=Entity><a class=headerlink href=#Entity title=Entity></a>Entity</h3><p><strong>实体bean一般用于ORM对象关系映射，一个实体映射一张表，一般无业务逻辑代码</strong>。<blockquote><p>操作EntityBean就等于操作了数据库，是面向对象编程的一种体现。</blockquote><p><strong>Entity使用场景</strong>：广泛应用于领域驱动设计，用于表示业务模型与数据库表的映射。<h3 id=DTO><a class=headerlink href=#DTO title=DTO></a>DTO</h3><p><strong>DTO是数据传输对象（Data Transfer Object）的简称，用于在不同层或服务之间传输数据，用于解耦不同层之间的数据传输。</strong><p>DTO特点如下：<ul><li>轻量级的数据对象，<strong>仅包含所需的数据字段，不包含业务逻辑或复杂的方法</strong>。<li>可以在不同的系统或服务之间进行序列化和传输。<li>可以通过映射与实体对象进行相互转换。</ul><p>DTO的使用场景：通常在分层架构或微服务架构中使用，用于在不同的层或服务之间传输数据。可以减少层之间的耦合度。</div><footer class=post-footer><div class=post-eof></div></footer></article></div><div class=post-block><article class=post-content itemscope itemtype=http://schema.org/Article><link href=https://hgprivate.github.io/2024/08/21/MyBatis%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/ itemprop=mainEntityOfPage><span hidden itemprop=author itemscope itemtype=http://schema.org/Person> <meta content=/static/imgs/avatar.png itemprop=image> <meta content=豪哥 itemprop=name> </span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization> <meta content=豪哥博客 itemprop=name> <meta content=豪哥博客 itemprop=description> </span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork> <meta content="undefined | 豪哥博客" itemprop=name> <meta itemprop=description> </span><header class=post-header><h2 itemprop="name headline" class=post-title><a class=post-title-link href=/2024/08/21/MyBatis%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/ itemprop=url>MyBatis系列-MyBatis原理解析</a></h2><div class=post-meta-container><div class=post-meta><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar"></i> </span> <span class=post-meta-item-text>发表于</span> <time itemprop="dateCreated datePublished" title="创建时间：2024-08-21 21:39:13" datetime=2024-08-21T21:39:13+08:00>2024-08-21</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar-check"></i> </span> <span class=post-meta-item-text>更新于</span> <time title="修改时间：2024-10-21 10:06:19" datetime=2024-10-21T10:06:19+08:00 itemprop=dateModified>2024-10-21</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-folder"></i> </span> <span class=post-meta-item-text>分类于</span> <span itemprop=about itemscope itemtype=http://schema.org/Thing> <a href=/categories/MyBatis/ itemprop=url rel=index><span itemprop=name>MyBatis</span></a> </span> </span></div></div></header><div class=post-body itemprop=articleBody><h1 id=SqlSessionFactory><a class=headerlink href=#SqlSessionFactory title=SqlSessionFactory></a>SqlSessionFactory</h1><p>获取一个SqlSessionFactory对象：<ol><li><p>创建SqlSessionFactoryBuilder对象，并调用build()方法。</p> <ol><li><p><strong>创建 配置构建器对象</strong>：parser = new XMLConfigBuilder(inputStream, environment, properties);</p><li><p><strong>创建 配置 对象</strong>：解析核心配置文件（各个标签信息）并封装成Configuration对象：config = parser.parse();</p> <p>配置文件中的增删改查标签会被封装成一个MapperStatement。</p><li><p>通过上一步解析拿到的配置来<strong>创建DefaultSqlSessionFactory对象</strong>：new DefaultSqlSessionFactory(config);</p></ol><li><p><strong>最终返回DefaultSqlSessionFactory</strong>。</p></ol><h1 id=SqlSession><a class=headerlink href=#SqlSession title=SqlSession></a>SqlSession</h1><p>获取一个SqlSession对象：<ol><li><p>调用DefaultSqlSessionFactory.openSession()方法 <strong>获取SqlSession</strong>。</p> <ol><li><p><strong>获取执行器类型</strong>：configuration.getDefaultExecutorType()，若显式指定则以指定为准。</p> <p>执行器类型<em><strong>共有三种：SIMPLE（简单） / REUSE（可复用） / BATCH（批量操作），默认为SIMPLE</strong></em>。</p><li><p><strong>从数据源中获取session</strong>：调用openSessionFromDataSource(executorType…)方法</p> <ol><li><strong>获取环境信息</strong>：environment = configuration.getEnvironment();<li><strong>获取事务工厂</strong>：getTransactionFactoryFromEnvironment(environment);<li><strong>获取事务对象</strong>：transactionFactory.newTransaction(environment.getDataSource(), level, autoCommit);<li><strong>创建执行器对象</strong>： executor = configuration.newExecutor(tx, execType);<ol><li>根据execType创建不同的执行器。<li>如果开启二级缓存，那么使用CachingExecutor进行包装并返回CachingExecutor对象。<li>拦截器链封装executor对象（代理）：interceptorChain.pluginAll(executor);</ol><li><strong>创建DefaultSqlSession对象</strong>：new DefaultSqlSession(configuration, executor, autoCommit);<li><strong>最终重置错误上下文</strong>：ErrorContext.instance().reset();</ol></ol><li><p>返回一个DefaultSqlSession对象。</p></ol><h1 id=Mapper代理><a class=headerlink href=#Mapper代理 title=Mapper代理></a>Mapper代理</h1><p>获取Mapper代理对象：<ol><li><strong>通过SqlSession获取Mapper</strong>：调用DefaultSqlSession.getMapper(Class<t> type)<ol><li><strong>通过MapperRegistry获取Mapper</strong>：<code>MapperRegistry.getMapper(type, sqlSession);</code>。<ol><li><strong>获取MapperProxy工厂</strong>：<code>mapperProxyFactory = (MapperProxyFactory&LTT>) knownMappers.get(type);</code>若MapperProxyFactory 为空就抛异常，否则继续执行。<li><strong>创建MapperProxy实例</strong>：<code>mapperProxyFactory.newInstance(sqlSession);</code><ol><li><strong>创建MapperProxy对象</strong>：mapperProxy = new MapperProxy<>(sqlSession, mapperInterface, methodCache);<li><strong>创建mapper接口代理对象（JDK代理）</strong>：<code>Proxy.newProxyInstance(mapperInterface.getClassLoader(), new Class[] { mapperInterface }, mapperProxy);</code></ol></ol></ol> <li>返回一个接口代理对象（Mapper接口实现）。</li> <h1 id=执行目标方法><a class=headerlink href=#执行目标方法 title=执行目标方法></a>执行目标方法</h1><p><em><strong>执行目标方法前会先执行代理对象的<code>invoke()</code>方法</strong></em>。</p> <ol><li><strong>先执行代理对象invoke方法</strong>：MapperProxy.invoke(Object proxy, Method method, Object[] args)<ol><li>若method是Object的方法，则执行Object的invoke方法，否则继续执行。<li><strong>创建Mapper方法执行器并执行Mapper方法</strong>：cachedInvoker(method).invoke(proxy, method, args, sqlSession);<ol><li><strong>执行Mapper中的方法</strong>：调用MapperMethod.execute(SqlSession sqlSession, Object[] args)方法。<ol><li>判断方法类型：INSERT / UPDATE / DELETE / SELECT / FLUSH / 默认抛出异常。<li>根据方法类型来通过SqlSession执行对应操作（增删改查）逻辑。<li>返回执行结果。</ol></ol></ol><li>返回操作结果。</ol> <h2 id=Select><a class=headerlink href=#Select title=Select></a>Select</h2><h3 id=查询单条数据><a class=headerlink href=#查询单条数据 title=查询单条数据></a>查询单条数据</h3><ol><li><p>DefaultSqlSession.selectOne(command.getName(), param)</p><li><p>DefaultSqlSession.selectList(statement, parameter, rowBounds);</p> <ol><li><p><strong>获取MapperStatement对象</strong>：configuration.getMappedStatement(statement)，根据mapper接口方法唯一标识ID来获取。</p><li><p><strong>通过执行器执行查询方法</strong>：executor.query(ms, wrapCollection(parameter), rowBounds, Executor.NO_RESULT_HANDLER);<strong>先封装参数，然后执行query方法，最后返回结果</strong>。</p> <ol><li>获取绑定SQL的BoundSQL对象：<code>ms.getBoundSql(parameterObject);</code><li>创建缓存键：<code>createCacheKey(ms, parameterObject, rowBounds, boundSql);</code><li>执行查询：<code>query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);</code><ol><li><strong>查询二级缓存</strong>，如果有结果则返回，如果没有，则继续执行。<li>二级缓存中没有结果，则执行BaseExecutor.query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);方法。<ol><li><strong>查询一级缓存</strong>，如果有结果，则执行handleLocallyCachedOutputParameters(ms, key, parameter, boundSql);<li>如果一级缓存中没有，则执行 BaseExecutor.queryFromDatabase(ms, parameter, rowBounds, resultHandler, key, boundSql);<ol><li><strong>执行查询方法</strong>：doQuery(ms, parameter, rowBounds, resultHandler, boundSql);<ol><li><strong>获取配置信息</strong>：ms.getConfiguration();<li><strong>创建StatementHandler对象</strong>：configuration.newStatementHandler(…)。<ol><li>根据<code>statementType</code>来创建StatementHandler（BaseStatementHandler）对象。且同时会**创建ParemeterHandler 和 ResultHandler，其也在创建后会被拦截器链包装（创建代理）：interceptorChain.pluginAll(parameterHandler / resultSetHandler);**。（statementType有三种类型：STATEMENT:SimpleStatementHandler / PREPARED:PreparedStatementHandler / CALLABLE:CallableStatementHandler / 其它抛异常），<li>拦截器链会封装创建好的StatementHandler对象，然后返回：<code>return interceptorChain.pluginAll(statementHandler);</code></ol><li><strong>初始化Statement</strong>：<code>prepareStatement(handler, ms.getStatementLog());</code><ol><li>实例化Statement。<li>为ParameterHandler 设置参数：<code>setParameters(statement);</code></ol><li><strong>执行查询方法</strong>：StatementHandler.query(stmt, resultHandler);<ol><li>执行PreparedStatement.execute()方法来查询数据。<li>使用ResultSetHandler处理结果数据集，通过<strong>TypeHandler</strong>进行类型转换。<li>返回 处理后的结果集。</ol></ol><li><strong>本地缓存执行结果</strong>：PerpetualCache-localCache.putObject(key, list);<li>如果方法有回调，则将key和parameter保存到输出缓存中：localOutputParameterCache.putObject(key, parameter);</ol></ol></ol></ol><li><p><em><strong>如果查询结果只有1条数据就返回，否则直接抛异常TooManyResultsException</strong></em>。</p></ol><li><p>返回 结果集。</p></ol> <h3 id=查询多条数据><a class=headerlink href=#查询多条数据 title=查询多条数据></a>查询多条数据</h3><p>原理与查询单条数据类似。</p> <footer class=post-footer><div class=post-eof></div></footer> <div class=post-block><article class=post-content itemscope itemtype=http://schema.org/Article><link href=https://hgprivate.github.io/2024/08/21/Linux%E5%AE%9E%E6%93%8D%E7%AF%87/ itemprop=mainEntityOfPage><span hidden itemprop=author itemscope itemtype=http://schema.org/Person> <meta content=/static/imgs/avatar.png itemprop=image> <meta content=豪哥 itemprop=name> </span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization> <meta content=豪哥博客 itemprop=name> <meta content=豪哥博客 itemprop=description> </span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork> <meta content="undefined | 豪哥博客" itemprop=name> <meta itemprop=description> </span><header class=post-header><h2 itemprop="name headline" class=post-title><a class=post-title-link href=/2024/08/21/Linux%E5%AE%9E%E6%93%8D%E7%AF%87/ itemprop=url>Linux系列-Linux实操篇</a></h2><div class=post-meta-container><div class=post-meta><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar"></i> </span> <span class=post-meta-item-text>发表于</span> <time itemprop="dateCreated datePublished" title="创建时间：2024-08-21 21:39:13" datetime=2024-08-21T21:39:13+08:00>2024-08-21</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar-check"></i> </span> <span class=post-meta-item-text>更新于</span> <time title="修改时间：2023-09-30 20:43:58" datetime=2023-09-30T20:43:58+08:00 itemprop=dateModified>2023-09-30</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-folder"></i> </span> <span class=post-meta-item-text>分类于</span> <span itemprop=about itemscope itemtype=http://schema.org/Thing> <a href=/categories/Linux/ itemprop=url rel=index><span itemprop=name>Linux</span></a> </span> </span></div></div></header><div class=post-body itemprop=articleBody><h1 id=1、开始使用><a class=headerlink href=#1、开始使用 title=1、开始使用></a>1、开始使用</h1><h2 id=1-1、登录和注销><a class=headerlink href=#1-1、登录和注销 title=1.1、登录和注销></a>1.1、登录和注销</h2><ul><li><strong>登录</strong>：一般使用普通用户登录，然后通过<code>su - 用户名</code>命令来切换到系统管理员身份。<li><strong>注销</strong>：使用命令<code>logout</code>，即可注销。</ul><blockquote><p>logout命令在图形运行级别下无效，只在运行级别3下才有效。<p>无论是关机还是重启，建议先运行<code>sync</code>命令将内存中的数据写到磁盘。</blockquote><h2 id=1-2、重启><a class=headerlink href=#1-2、重启 title=1.2、重启></a>1.2、重启</h2><ul><li><strong>shutdown -r now</strong>：立刻重启计算机。<li><strong>reboot</strong>：现在重启计算机。</ul><h2 id=1-3、关机><a class=headerlink href=#1-3、关机 title=1.3、关机></a>1.3、关机</h2><ul><li><strong>shutdown -h now</strong>：立刻执行关机。<li><strong>shutdown -h 1</strong>：1分钟后关机。<li><strong>halt</strong>：关机。<li><strong>sync</strong>：内存数据同步到磁盘。</ul><h2 id=1-4、远程登录><a class=headerlink href=#1-4、远程登录 title=1.4、远程登录></a>1.4、远程登录</h2><p>Linux 一般作为服务器使用，而服务器一般放在机房，需要远程登录到Linux服务器来管理维护系统。<p>Linux 系统中是<strong>通过SSH服务实现远程登录功能，默认ssh服务端口号为 22</strong>。<p>Window中可以远程登录 Linux 的客户端有XShell、SecureCRT、Putty、SSH Secure Shell 等。<blockquote><p>远程登录Lunux服务器需要SSH协议和22端口。若Linux服务器没有满足该条件，请进行相关设置，以满足条件。</blockquote><h2 id=1-5、文件传输><a class=headerlink href=#1-5、文件传输 title=1.5、文件传输></a>1.5、文件传输</h2><p>远程文件传输需要 Linux服务器开启<strong>SSHD服务</strong>。如需使用文件传输，请先开启该服务。<h1 id=2、vi-vim编辑器><a class=headerlink href=#2、vi-vim编辑器 title=2、vi/vim编辑器></a>2、vi/vim编辑器</h1><h2 id=2-1、概述><a class=headerlink href=#2-1、概述 title=2.1、概述></a>2.1、概述</h2><p>Unix Like 系统都会内建 vi 编辑器，目前使用较多的是 vim 编辑器。<p><strong>vim 从 vi 发展而来</strong>。具备代码补全、编译、错误跳转等编程功能。<p><img alt=image-20210918194511730 src=https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/07/image-20210918194511730.png><h2 id=2-3、三种模式><a class=headerlink href=#2-3、三种模式 title=2.3、三种模式></a>2.3、三种模式</h2><p>vi / vim 分三种模式，分别是<strong>命令模式（Command mode），输入模式（Insert mode）和底线命令模式（Last line mode）</strong>。<h3 id=2-3-1、命令模式><a class=headerlink href=#2-3-1、命令模式 title=2.3.1、命令模式></a>2.3.1、命令模式</h3><p><strong>用户启动 vi/vim 时会直接进入 命令模式。</strong><p>常用命令如下：<ul><li>输入英文字母<code>i</code>会 切换到 输入模式。<li>输入英文字母<code>x</code>会 删除 当前光标所在处字符。<li>输入英文标点符号字符<code>:</code>会切换到底线命令模式，然后可在最下面一行输入命令。</ul><blockquote><p>命令模式下的命令数量有限，但可通过 <strong>底线命令模式</strong> 输入更多命令。</blockquote><h3 id=2-3-2、输入模式><a class=headerlink href=#2-3-2、输入模式 title=2.3.2、输入模式></a>2.3.2、输入模式</h3><p><strong>输入英文字母<code>i</code>会切换到输入模式。</strong><p>输入模式下可使用以下命令：<ul><li><strong>字符按键以及Shift组合</strong>，输入字符。<li><strong>BACK SPACE</strong>，退格键，删除光标前一个字符。<li><strong>DEL</strong>，删除键，删除光标后一个字符。<li><strong>HOME</strong>/<strong>END</strong>，移动光标到行首/行尾。<li><strong>Page Up</strong>/<strong>Page Down</strong>，上/下翻页。<li><strong>Insert</strong>，切换光标为输入/替换模式，光标将变成竖线/下划线。<li><strong>ESC</strong>，退出输入模式，切换到命令模式。</ul><h3 id=2-3-3、底线命令模式><a class=headerlink href=#2-3-3、底线命令模式 title=2.3.3、底线命令模式></a>2.3.3、底线命令模式</h3><p><strong>命令模式下输入英文标点符号<code>:</code>会切换到底线命令模式</strong>。<p>底线命令模式可输入单个或多个字符命令，命令数量较多。底线命令模式下常用命令有（省略了冒号）：<ul><li>q：退出程序。<li>w：保存文件。</ul><p><strong>按ESC键可退出底线命令模式。</strong><h1 id=3、用户管理><a class=headerlink href=#3、用户管理 title=3、用户管理></a>3、用户管理</h1><h2 id=3-1、概述><a class=headerlink href=#3-1、概述 title=3.1、概述></a>3.1、概述</h2><p><strong>Linux系统是一个多用户多任务分时操作系统</strong>，要使用系统资源，就必须申请一个账号，然后通过该账户进行访问。<p>用户账号机制 可以帮助系统管理员 跟踪系统用户的操作，并控制他们对系统资源的访问；同时可帮助用户 组织文件 并提供 安全性保护。<p>每个用户账号都拥有唯一 用户名 和 口令。输入正确的用户名和口令 就能进入系统和自己的主目录。<h2 id=3-2、用户组><a class=headerlink href=#3-2、用户组 title=3.2、用户组></a>3.2、用户组</h2><h3 id=3-2-1、添加组><a class=headerlink href=#3-2-1、添加组 title=3.2.1、添加组></a>3.2.1、添加组</h3><p>语法：groupadd 组名<p>常用命令：<figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line><span class=comment># 命令1：创建用户组wudang</span></span><br><span class=line>groupadd wudang</span><br></pre></table></figure><blockquote><p>创建好的用户组信息可以在用户组文件 <code>/etc/group</code>中看到。</blockquote><h3 id=3-2-2、修改组><a class=headerlink href=#3-2-2、修改组 title=3.2.2、修改组></a>3.2.2、修改组</h3><p>语法：groupmod -n new_name old_name<p>常用命令：<figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line><span class=comment># 命令1：将用户组meifa修改为haircut</span></span><br><span class=line>groupmod -n haircut meifa</span><br></pre></table></figure><h3 id=3-2-3、删除组><a class=headerlink href=#3-2-3、删除组 title=3.2.3、删除组></a>3.2.3、删除组</h3><p>语法：groupdel 组名<p>常用命令：<figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line><span class=comment># 命令1：删除用户组wudang</span></span><br><span class=line>groupdel wudang</span><br></pre></table></figure><h2 id=3-3、用户><a class=headerlink href=#3-3、用户 title=3.3、用户></a>3.3、用户</h2><h3 id=3-3-1、创建用户><a class=headerlink href=#3-3-1、创建用户 title=3.3.1、创建用户></a>3.3.1、创建用户</h3><p>语法：useradd [参数] 用户名<p>参数说明：<ul><li>-c<备注> 　加上备注文字。备注文字会保存在passwd的备注栏位中。<li>-d<登入目录> 　指定用户登入时的起始目录。<li>-D 　变更预设值。<li>-e<有效期限> 　指定帐号的有效期限。<li>-f<缓冲天数> 　指定在密码过期后多少天即关闭该帐号。<li>-g<群组> 　指定用户所属的群组。<li>-G<群组> 　指定用户所属的附加群组。<li>-m 　自动建立用户的登入目录。<li>-M 　不要自动建立用户的登入目录。<li>-n 　取消建立以用户名称为名的群组。<li>-r 　建立系统帐号。<li>-s<shell>　 　指定用户登入后所使用的shell。 <li>-u<uid> 　指定用户ID。 <p>常用命令：</p> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre><td class=code><pre><span class=line><span class=comment># 命令1：创建用户xm，并将其放到用户组xm中。</span></span><br><span class=line>useradd xm</span><br><span class=line></span><br><span class=line><span class=comment># 命令2：创建用户xm，并指定该用户的家目录为test</span></span><br><span class=line>useradd -d <span class=built_in>test</span> xm</span><br><span class=line></span><br><span class=line><span class=comment># 命令2：添加用户zwj，且指定用户组为wudang</span></span><br><span class=line>useradd -g wudang zwj</span><br></pre></table></figure> <blockquote><p>创建好的用户信息可以在<code>/etc/passwd</code>中看到。</blockquote> <h3 id=3-3-2、设置密码><a class=headerlink href=#3-3-2、设置密码 title=3.3.2、设置密码></a>3.3.2、设置密码</h3><p>（1）为用户xm设置密码</p> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line><span class=comment># 命令1：为用户xm设置密码123456</span></span><br><span class=line>passwd xm  <span class=comment># 回车后系统提示输入密码，该密码就是用户密码</span></span><br></pre></table></figure> <h3 id=3-3-3、查询用户><a class=headerlink href=#3-3-3、查询用户 title=3.3.3、查询用户></a>3.3.3、查询用户</h3><p>（1）查询名为xm的用户信息</p> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line><span class=comment># 命令1：查询用户xm</span></span><br><span class=line><span class=built_in>id</span> xm</span><br></pre></table></figure> <h3 id=3-3-4、修改用户><a class=headerlink href=#3-3-4、修改用户 title=3.3.4、修改用户></a>3.3.4、修改用户</h3><p>（1）修改密码</p> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line><span class=comment># 回车后，输入需要设置的密码</span></span><br><span class=line>passwd user_name</span><br></pre></table></figure> <p>（2）修改用户所属的组</p> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line><span class=comment># 命令1：将zwj的组修改为shaolin</span></span><br><span class=line>usermod -g shaolin zwj</span><br></pre></table></figure> <h3 id=3-3-5、切换用户><a class=headerlink href=#3-3-5、切换用户 title=3.3.5、切换用户></a>3.3.5、切换用户</h3><p>语法：su - 要切换的用户名</p> <p>常用命令：</p> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line><span class=comment># 命令1：切换到用户zf</span></span><br><span class=line>su - zf</span><br><span class=line></span><br><span class=line><span class=comment># 命令2：返回到原来用户</span></span><br><span class=line><span class=built_in>exit</span></span><br></pre></table></figure> <h3 id=3-3-6、删除用户><a class=headerlink href=#3-3-6、删除用户 title=3.3.6、删除用户></a>3.3.6、删除用户</h3><p>语法：userdel 用户名</p> <p>常用命令：</p> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line><span class=comment># 命令1：删除用户xm，但保留家目录</span></span><br><span class=line>userdel xm</span><br><span class=line></span><br><span class=line><span class=comment># 命令2：删除用户xm，并删除家目录</span></span><br><span class=line>userdel -r xm</span><br></pre></table></figure> <p><font color=red>注意：删除用户时一般保留家目录。</font></p> <h1 id=4、基础指令><a class=headerlink href=#4、基础指令 title=4、基础指令></a>4、基础指令</h1><h2 id=4-1、帮助指令><a class=headerlink href=#4-1、帮助指令 title=4.1、帮助指令></a>4.1、帮助指令</h2><h3 id=4-1-1、man指令><a class=headerlink href=#4-1-1、man指令 title=4.1.1、man指令></a>4.1.1、man指令</h3><p>语法：man [命令/配置文件]</p> <h3 id=4-1-2、help指令><a class=headerlink href=#4-1-2、help指令 title=4.1.2、help指令></a>4.1.2、help指令</h3><p>语法：help 命令</p> <h2 id=4-2、磁盘管理><a class=headerlink href=#4-2、磁盘管理 title=4.2、磁盘管理></a>4.2、磁盘管理</h2><h3 id=4-2-1、系統分区-挂载><a class=headerlink href=#4-2-1、系統分区-挂载 title=4.2.1、系統分区/挂载></a>4.2.1、系統分区/挂载</h3><h4 id=4-2-1-1、分区方式><a class=headerlink href=#4-2-1-1、分区方式 title=4.2.1.1、分区方式></a>4.2.1.1、分区方式</h4><ul><li><strong>MBR分区</strong><ol><li>最多支持4个分区。<li>系统只能安装在主分区。<li>扩展分区要占一个主分区。<li>MBR最大支持2TB，但拥有良好的兼容性。</ol><li><strong>GTP分区</strong><ol><li>支持无限个主分区。（操作系统可能有限制，windows下最多128个分区）。<li>最大支持18EB。（1EB = 1024PB，1PB = 1024TB）<li>windows7 64位以后支持gtp分区。</ol></ul> <h4 id=4-2-1-2、硬盘类型><a class=headerlink href=#4-2-1-2、硬盘类型 title=4.2.1.2、硬盘类型></a>4.2.1.2、硬盘类型</h4><p><strong>（1）IDE硬盘</strong></p> <p>驱动器标识符为 <code>hdx~</code>。</p> <ul><li><p><code>hd</code>：表明分区所在设备的类型，是指IDE硬盘。</p><li><p><code>x</code>：为盘号。</p> <ul><li>a为基本盘。<li>b为基本盘从盘。<li>c为辅助主盘。<li>d为辅助从盘。</ul><li><p><code>~</code>：代表分区。</p> <p>前四个分区用1-4的4个数字标识，它们是主分区或扩展分区。从5开始就是逻辑分区。</p></ul> <p><strong>（2）SCSI硬盘</strong></p> <p>SCSI硬盘标识符为 <code>sdx~</code>。其它与IDE硬盘中的相关描述类似。</p> <h4 id=4-2-1-3、查看分区挂载><a class=headerlink href=#4-2-1-3、查看分区挂载 title=4.2.1.3、查看分区挂载></a>4.2.1.3、查看分区挂载</h4><p><strong>（1）命令lsblk</strong></p> <p>语法如下：</p> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>lsblk </span><br></pre></table></figure> <p>参数解析：</p> <ul><li>-f：查看详细的设备挂载情况，显示文件系统信息。</ul> <h4 id=4-2-1-4、分区挂载><a class=headerlink href=#4-2-1-4、分区挂载 title=4.2.1.4、分区挂载></a>4.2.1.4、分区挂载</h4><p><strong>（1）添加硬盘</strong></p> <p>为虚拟机添加硬盘。</p> <p><strong>（2）硬盘分区</strong></p> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line>fdisk /dev/sdb</span><br><span class=line><span class=comment># 后续依次输入：m / n / e / 1 / w</span></span><br></pre></table></figure> <p><strong>（3）格式化分区</strong></p> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>mkfs -t xfs /dev/sdb1</span><br></pre></table></figure> <p><strong>（4）挂载</strong></p> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line><span class=comment># 第一步：创建需要挂载的目录，比如该目录是 /home/newdisk</span></span><br><span class=line><span class=built_in>mkdir</span> -p /home/newdisk</span><br><span class=line></span><br><span class=line><span class=comment># 第二步：执行挂载操作</span></span><br><span class=line>mount /dev/sdb1 /home/newdisk</span><br></pre></table></figure> <p>注意：磁盘卸载命令为<code>umount /home/newdisk</code></p> <h4 id=4-2-1-5、自动挂载><a class=headerlink href=#4-2-1-5、自动挂载 title=4.2.1.5、自动挂载></a>4.2.1.5、自动挂载</h4><p><strong>默认情况下，系统重启会导致之前的挂载丢失，为解决此问题需要设置自动挂载。</strong></p> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre><td class=code><pre><span class=line><span class=comment># 第一步：编辑 /etc/fstab 文件，将挂载关系添加至该文件中。</span></span><br><span class=line>vim /etc/fstab </span><br><span class=line></span><br><span class=line><span class=comment># 添加如下内容（根据自己本机情况来添加）</span></span><br><span class=line>/dev/sdb1         /home/newdisk       ext4         defaults         0 0</span><br><span class=line></span><br><span class=line><span class=comment># 第二步：执行mount命令，开启自动挂载。</span></span><br><span class=line>mount -a</span><br></pre></table></figure> <h3 id=4-2-2、查看磁盘使用><a class=headerlink href=#4-2-2、查看磁盘使用 title=4.2.2、查看磁盘使用></a>4.2.2、查看磁盘使用</h3><h4 id=4-2-2-1、df命令><a class=headerlink href=#4-2-2-1、df命令 title=4.2.2.1、df命令></a>4.2.2.1、df命令</h4><p>作用：<strong>用于显示目前在 Linux 系统上的文件系统磁盘使用情况统计。</strong></p> <p>语法：<code>df [选项]... [FILE]...</code></p> <ul><li>文件-a, –all 包含所有的具有 0 Blocks 的文件系统<li>文件–block-size={SIZE} 使用 {SIZE} 大小的 Blocks<li>文件-h, –human-readable 使用人类可读的格式(预设值是不加这个选项的…)<li>文件-H, –si 很像 -h, 但是用 1000 为单位而不是用 1024<li>文件-i, –inodes 列出 inode 资讯，不列出已使用 block<li>文件-k, –kilobytes 就像是 –block-size=1024<li>文件-l, –local 限制列出的文件结构<li>文件-m, –megabytes 就像 –block-size=1048576<li>文件–no-sync 取得资讯前不 sync (预设值)<li>文件-P, –portability 使用 POSIX 输出格式<li>文件–sync 在取得资讯前 sync<li>文件-t, –type=TYPE 限制列出文件系统的 TYPE<li>文件-T, –print-type 显示文件系统的形式<li>文件-x, –exclude-type=TYPE 限制列出文件系统不要显示 TYPE<li>文件-v (忽略)<li>文件–help 显示这个帮手并且离开<li>文件–version 输出版本资讯并且离开</ul> <h4 id=4-2-2-2、du命令><a class=headerlink href=#4-2-2-2、du命令 title=4.2.2.2、du命令></a>4.2.2.2、du命令</h4><p>作用：<strong>显示目录或文件大小。</strong></p> <p>语法：</p> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line><span class=built_in>du</span> [-abcDhHklmsSx][-L <符号连接>][-X <文件>][--block-size][--exclude=<目录或文件>][--max-depth=<目录层数>][--<span class=built_in>help</span>][--version][目录或文件]</span><br></pre></table></figure> <p>参数说明：</p> <ul><li>-a或-all 显示目录中个别文件的大小。<li>-b或-bytes 显示目录或文件大小时，以byte为单位。<li>-c或–total 除了显示个别目录或文件的大小外，同时也显示所有目录或文件的总和。<li>-D或–dereference-args 显示指定符号连接的源文件大小。<li>-h或–human-readable 以K，M，G为单位，提高信息的可读性。<li>-H或–si 与-h参数相同，但是K，M，G是以1000为换算单位。<li>-k或–kilobytes 以1024 bytes为单位。<li>-l或–count-links 重复计算硬件连接的文件。<li>-L<符号连接>或–dereference<符号连接> 显示选项中所指定符号连接的源文件大小。<li>-m或–megabytes 以1MB为单位。<li>-s或–summarize 仅显示总计。<li>-S或–separate-dirs 显示个别目录的大小时，并不含其子目录的大小。<li>-x或–one-file-xystem 以一开始处理时的文件系统为准，若遇上其它不同的文件系统目录则略过。<li>-X<文件>或–exclude-from=<文件> 在<文件>指定目录或文件。<li>–exclude=<目录或文件> 略过指定的目录或文件。<li>–max-depth=<目录层数> 超过指定层数的目录后，予以忽略。<li>–help 显示帮助。<li>–version 显示版本信息。</ul> <h3 id=4-2-3、创建-删除目录><a class=headerlink href=#4-2-3、创建-删除目录 title=4.2.3、创建/删除目录></a>4.2.3、创建/删除目录</h3><h4 id=4-2-3-1、mkdir命令><a class=headerlink href=#4-2-3-1、mkdir命令 title=4.2.3.1、mkdir命令></a>4.2.3.1、mkdir命令</h4><p>作用：<strong>用于创建目录。</strong></p> <p>语法：<code>mkdir [-p] dirName</code></p> <p>参数说明：</p> <ul><li>-p 确保目录名称存在，不存在时则创建。</ul> <h4 id=4-2-3-2、rmdir命令><a class=headerlink href=#4-2-3-2、rmdir命令 title=4.2.3.2、rmdir命令></a>4.2.3.2、rmdir命令</h4><p>作用：<strong>删除空目录。</strong></p> <p>语法：<code>rmdir [-p] dirName</code></p> <p>参数：</p> <ul><li>-p 当子目录被删除 后 也是空目录的话，则顺便一并删除。</ul> <h3 id=4-2-4、查看目录子项><a class=headerlink href=#4-2-4、查看目录子项 title=4.2.4、查看目录子项></a>4.2.4、查看目录子项</h3><h4 id=4-2-4-1、ls命令><a class=headerlink href=#4-2-4-1、ls命令 title=4.2.4.1、ls命令></a>4.2.4.1、ls命令</h4><p>作用：<strong>列出当前目录下所有文件和目录。</strong></p> <p>语法： ls [-alrtAFR] [name…]</p> <p>参数：</p> <ul><li>-a 显示所有文件及目录 (<strong>.</strong> 开头的隐藏文件也会列出)<li>-l 除文件名称外，亦将文件型态、权限、拥有者、文件大小等资讯详细列出<li>-r 将文件以相反次序显示(原定依英文字母次序)<li>-t 将文件依建立时间之先后次序列出<li>-A 同 -a ，但不列出 “.” (目前目录) 及 “..” (父目录)<li>-F 在列出的文件名称后加一符号；例如可执行档则加 “*”，目录则加 “/“。<li>-R 若目录下有文件，则以下之文件亦皆依序列出。</ul> <h4 id=4-2-4-2、tree命令><a class=headerlink href=#4-2-4-2、tree命令 title=4.2.4.2、tree命令></a>4.2.4.2、tree命令</h4><p>作用：以树状图形式展示目录内容。</p> <p>语法：</p> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>tree [-aACdDfFgilnNpqstux][-I <范本样式>][-P <范本样式>][目录...]</span><br></pre></table></figure> <p>参数说明：</p> <ul><li>-a 显示所有文件和目录。<li>-A 使用ASNI绘图字符显示树状图而非以ASCII字符组合。<li>-C 在文件和目录清单加上色彩，便于区分各种类型。<li>-d 显示目录名称而非内容。<li>-D 列出文件或目录的更改时间。<li>-f 在每个文件或目录之前，显示完整的相对路径名称。<li>-F 在执行文件，目录，Socket，符号连接，管道名称名称，各自加上”*”,”/“,”=”,”@”,”|”号。<li>-g 列出文件或目录的所属群组名称，没有对应的名称时，则显示群组识别码。<li>-i 不以阶梯状列出文件或目录名称。<li>-L level 限制目录显示层级。<li>-l 如遇到性质为符号连接的目录，直接列出该连接所指向的原始目录。<li>-n 不在文件和目录清单加上色彩。<li>-N 直接列出文件和目录名称，包括控制字符。<li>-p 列出权限标示。<li>-P<范本样式> 只显示符合范本样式的文件或目录名称。<li>-q 用”?”号取代控制字符，列出文件和目录名称。<li>-s 列出文件或目录大小。<li>-t 用文件和目录的更改时间排序。<li>-u 列出文件或目录的拥有者名称，没有对应的名称时，则显示用户识别码。<li>-x 将范围局限在现行的文件系统中，若指定目录下的某些子目录，其存放于另一个文件系统上，则将该子目录予以排除在寻找范围外。</ul> <h3 id=4-2-5、统计目录子项><a class=headerlink href=#4-2-5、统计目录子项 title=4.2.5、统计目录子项></a>4.2.5、统计目录子项</h3><h4 id=4-2-5-1、统计home目录下文件个数><a class=headerlink href=#4-2-5-1、统计home目录下文件个数 title=4.2.5.1、统计home目录下文件个数></a>4.2.5.1、统计home目录下文件个数</h4><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line><span class=comment># 仅统计 /home 当前第一级的文件个数</span></span><br><span class=line><span class=built_in>ls</span> -l /home | grep <span class=string>"^-"</span> | <span class=built_in>wc</span> -l</span><br><span class=line></span><br><span class=line><span class=comment># 统计 /home 下及子目录下的所有文件个数</span></span><br><span class=line><span class=built_in>ls</span> -lR /home | grep <span class=string>"^-"</span> | <span class=built_in>wc</span> -l</span><br></pre></table></figure> <h4 id=4-2-5-2、统计home目录下目录个数><a class=headerlink href=#4-2-5-2、统计home目录下目录个数 title=4.2.5.2、统计home目录下目录个数></a>4.2.5.2、统计home目录下目录个数</h4><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line><span class=comment># 仅统计 /home 当前第一级的目录个数</span></span><br><span class=line><span class=built_in>ls</span> -l /home | grep <span class=string>"^d"</span> | <span class=built_in>wc</span> -l</span><br><span class=line></span><br><span class=line><span class=comment># 统计 /home 下及子目录下的所有目录个数</span></span><br><span class=line><span class=built_in>ls</span> -lR /home | grep <span class=string>"^d"</span> | <span class=built_in>wc</span> -l</span><br></pre></table></figure> <h2 id=4-3、文件属性管理><a class=headerlink href=#4-3、文件属性管理 title=4.3、文件属性管理></a>4.3、文件属性管理</h2><h3 id=4-3-1、概述><a class=headerlink href=#4-3-1、概述 title=4.3.1、概述></a>4.3.1、概述</h3><p>在 Linux 中我们可以使用 <strong>ll</strong> 或者 <strong>ls –l</strong> 命令来显示一个文件的属性以及文件所属的用户和组，如：</p> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line>[root@www /]# <span class=built_in>ls</span> -l</span><br><span class=line>total 64</span><br><span class=line>dr-xr-xr-x   2 root root 4096 Dec 14  2012 bin</span><br><span class=line>dr-xr-xr-x   4 root root 4096 Apr 19  2012 boot</span><br></pre></table></figure> <p>从左到右每一部分的解析如下图所示：</p> <p><img alt=img src=https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/07/Linux%E6%96%87%E4%BB%B6%E5%B1%9E%E6%80%A7%E5%90%AB%E4%B9%89%E5%9B%BE%E7%A4%BA.jpg></p> <p>将上面列出的每一个文件的信息从左到右可分为7个部分，下面将分别解析。</p> <p><strong>（1）第一部分</strong></p> <p><img alt=img src=https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/07/Linux%E6%96%87%E4%BB%B6%E6%9D%83%E9%99%90%E5%B1%9E%E6%80%A7%E5%90%AB%E4%B9%89%E5%9B%BE%E7%A4%BA.jpg></p> <p><strong>第一部分的第一个字符表示当前文件的类型</strong>，文件类型有如下几种：</p> <ul><li><code>d</code>：表示目录<li><code>-</code>：表示文件；<li><code>l</code>：表示 链接文档(link file)；<li><code>b</code>：表示 装置文件中 可供储存的<strong>接口设备</strong>(可随机存取装置)；<li><code>c</code>：表示 装置文件中 的<strong>串行端口设备</strong>，例如键盘、鼠标(一次性读取装置)。</ul> <p>第一个字符后面的Owner表示<strong>当前文件的所有者（用户）有什么权限</strong>。</p> <p>第一个字符后面的Group表示<strong>当前文件的所属组（用户组）有什么权限</strong>。</p> <p>第一个字符后面的OtherUsers表示<strong>其它用户对当前文件有什么权限</strong>。</p> <blockquote><p>权限由 <code>r、w、x</code>三个参数组合。<code>r</code>表示 可读(read)、 <code>w</code>表示 可写(write)、 <code>x</code>表示 可执行(execute)。 三个权限的位置不会改变，如果没有权限则由字符<code>-</code>表示。</blockquote> <p><strong>（2）第二部分表示当前文件的链接数量。</strong></p> <p>如果当前文件的类型是文件，那么这里的数字表示硬链接数量。如果当前文件的类型是目录，那么这里的的数字表示当前目录下子项目的数量。</p> <p><strong>（3）第三部分表示当前文件的所有者是哪个用户。</strong></p> <p>常用命令：</p> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line><span class=comment># 命令1：查看当前目录中文件的所有者</span></span><br><span class=line><span class=built_in>ls</span> -ahl</span><br><span class=line></span><br><span class=line><span class=comment># 命令2：修改文件ok.txt的所有者为zf</span></span><br><span class=line><span class=built_in>chown</span> zf ok.txt</span><br></pre></table></figure> <p><strong>（4）第四部分表示当前文件所属的用户组是哪一组</strong></p> <p>常用命令：</p> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line><span class=comment># 命令1：修改文件ok.txt的所有组为police</span></span><br><span class=line><span class=built_in>chgrp</span> police ok.txt</span><br></pre></table></figure> <p><strong>（5）第五部分表示当前文件的大小。</strong></p> <p><strong>（6）第六部分表示当前文件最后的修改时间。</strong></p> <p><strong>（7）第七部分表示当前文件的文件名。</strong></p> <h3 id=4-3-2、修改文件属性><a class=headerlink href=#4-3-2、修改文件属性 title=4.3.2、修改文件属性></a>4.3.2、修改文件属性</h3><h4 id=4-3-2-1、chattr命令><a class=headerlink href=#4-3-2-1、chattr命令 title=4.3.2.1、chattr命令></a>4.3.2.1、chattr命令</h4><p>作用：<strong>改变文件属性。</strong></p> <p>该指令可改变存放在ext2文件系统上的文件或目录属性，这些属性共有以下8种模式：</p> <ol><li>a：让文件或目录仅供附加用途。<li>b：不更新文件或目录的最后存取时间。<li>c：将文件或目录压缩后存放。<li>d：将文件或目录排除在倾倒操作之外。<li>i：不得任意更动文件或目录。<li>s：保密性删除文件或目录。<li>S：即时更新文件或目录。<li>u：预防意外删除。</ol> <p>语法：chattr -RV -v<版本编号> +/-/=<属性> 文件或目录…</p> <p>参数：</p> <ul><li>-R 递归处理，将指定目录下的所有文件及子目录一并处理。<li>-v<版本编号> 设置文件或目录版本。<li>-V 显示指令执行过程。<li>+<属性> 开启文件或目录的该项属性。<li>-<属性> 关闭文件或目录的该项属性。<li>=<属性> 指定文件或目录的该项属性。</ul> <h4 id=4-3-2-2、chmod命令><a class=headerlink href=#4-3-2-2、chmod命令 title=4.3.2.2、chmod命令></a>4.3.2.2、chmod命令</h4><p>作用：<strong>控制文件所属用户权限。</strong></p> <p>简介：<strong>Linux/Unix 的文件调用权限分为三级 : 文件所有者（Owner）、用户组（Group）、其它用户（Other Users）。只有文件所有者和超级用户可以修改文件或目录的权限。</strong></p> <p><img alt=img src=https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/07/Linux%E6%96%87%E4%BB%B6%E6%9D%83%E9%99%90%E9%85%8D%E7%BD%AE%E6%96%B9%E5%BC%8F%E5%9B%BE%E7%A4%BA.jpg></p> <p>语法：</p> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line><span class=built_in>chmod</span> [-cfvR] [--<span class=built_in>help</span>] [--version] mode file...</span><br></pre></table></figure> <p>参数说明：</p> <ul><li>mode : 权限设定字串，格式如下：</ul> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>[ugoa...][[+-=][rwxX]...][,...]</span><br></pre></table></figure> <p>其中：</p> <ul><li>u 表示该文件的拥有者，g 表示与该文件的拥有者属于同一个群体(group)者，o表示其他以外的人，a 表示这三者皆是。<li>+ 表示增加权限、- 表示取消权限、= 表示唯一设定权限。<li>r 表示可读取，w 表示可写入，x 表示可执行，X 表示只有当该文件是个子目录或者该文件已经被设定过为可执行。</ul> <p>参数说明：</p> <ul><li>-c : 若该文件权限确实已经更改，才显示其更改动作。<li>-f : 若该文件权限无法被更改也不要显示错误讯息。<li>-v : 显示权限变更的详细资料。<li>-R : 对目前目录下的所有文件与子目录进行相同的权限变更(即以递归的方式逐个变更)。<li>–help : 显示辅助说明。<li>–version : 显示版本。</ul> <p>常用命令：</p> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre><td class=code><pre><span class=line><span class=comment># 数字命令方式：将 .bashrc 这个文件所有的权限都设定启用</span></span><br><span class=line><span class=comment># 如果要将权限变成 -rwxr-xr-- 呢？那么权限的分数就成为 [4+2+1][4+0+1][4+0+0]=754</span></span><br><span class=line><span class=built_in>chmod</span> 777 .bashrc </span><br><span class=line></span><br><span class=line><span class=comment># 符号命令方式：将 .bashrc 这个文件权限设置为-rwxr-xr--</span></span><br><span class=line><span class=built_in>chmod</span> u=rwx,g=rx,o=r .bashrc</span><br></pre></table></figure> <h4 id=4-3-2-3、chown-命令><a title="4.3.2.3、chown 命令" class=headerlink href=#4-3-2-3、chown-命令></a>4.3.2.3、chown 命令</h4><p>作用：<strong>管理文件所有者和文件关联组。</strong></p> <p>语法：</p> <figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>chown [-cfhvR] [--help] [--version] user[:group] file...</span><br></pre></table></figure> <p>参数 :</p> <ul><li>user : 新的文件拥有者的使用者 ID。<li>group : 新的文件拥有者的使用者组(group)。<li>-c : 显示更改的部分的信息。<li>-f : 忽略错误信息。<li>-h :修复符号链接。<li>-v : 显示详细的处理信息。<li>-R : 处理指定目录以及其子目录下的所有文件。<li>–help : 显示辅助说明。<li>–version : 显示版本。</ul> <h4 id=4-3-2-4、chgrp-命令><a title="4.3.2.4、chgrp 命令" class=headerlink href=#4-3-2-4、chgrp-命令></a>4.3.2.4、chgrp 命令</h4><p>作用：<strong>修改文件或目录所属群组。</strong></p> <p>语法：</p> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line><span class=built_in>chgrp</span> [-cfhRv][--<span class=built_in>help</span>][--version][所属群组][文件或目录...] 或 <span class=built_in>chgrp</span> [-cfhRv][--<span class=built_in>help</span>][--reference=<参考文件或目录>][--version][文件或目录...]</span><br></pre></table></figure> <p>参数说明：</p> <ul><li>-c或–changes 效果类似”-v”参数，但仅回报更改的部分。<li>-f或–quiet或–silent 　不显示错误信息。<li>-h或–no-dereference 　只对符号连接的文件作修改，而不更动其他任何相关文件。<li>-R或–recursive 　递归处理，将指定目录下的所有文件及子目录一并处理。<li>-v或–verbose 　显示指令执行过程。<li>–help 　在线帮助。<li>–reference=<参考文件或目录> 　把指定文件或目录的所属群组全部设成和参考文件或目录的所属群组相同。<li>–version 　显示版本信息。</ul> <h2 id=4-4、文件管理><a class=headerlink href=#4-4、文件管理 title=4.4、文件管理></a>4.4、文件管理</h2><h3 id=4-4-1、查找文件><a class=headerlink href=#4-4-1、查找文件 title=4.4.1、查找文件></a>4.4.1、查找文件</h3><h4 id=4-4-1-1、find命令><a class=headerlink href=#4-4-1-1、find命令 title=4.4.1.1、find命令></a>4.4.1.1、find命令</h4><p>作用：<strong>find 命令用来在指定目录下查找文件。</strong>任何位于参数之前的字符串都将被视为欲查找的目录名。如果使用该命令时，不设置任何参数，则 find 命令将在当前目录下查找子目录与文件。并且将查找到的子目录和文件全部进行显示。</p> <p>语法：</p> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>find path -option [-<span class=built_in>print</span>] [-<span class=built_in>exec</span> -ok <span class=built_in>command</span>] {} \;</span><br></pre></table></figure> <p>参数说明：</p> <p>find 根据下列规则判断 path 和 expression，在命令列上第一个 - ( ) , ! 之前的部份为 path，之后的是 expression。如果 path 是空字串则使用目前路径，如果 expression 是空字串则使用 -print 为预设 expression。</p> <ul><li>expression 中可使用的选项有二三十个之多，在此只介绍最常用的部份。<li>-mount, -xdev : 只检查和指定目录在同一个文件系统下的文件，避免列出其它文件系统中的文件。<li>-amin n : 在过去 n 分钟内被读取过。<li>-anewer file : 比文件 file 更晚被读取过的文件。<li>-atime n : 在过去n天内被读取过的文件。<li>-cmin n : 在过去 n 分钟内被修改过。<li>-cnewer file :比文件 file 更新的文件。<li>-ctime n : 在过去n天内被修改过的文件。<li>-empty：空的文件-gid n or -group name : gid 是 n 或是 group 名称是 name。<li>-ipath p, -path p : 路径名称符合 p 的文件，ipath 会忽略大小写。<li>-name name, -iname name : 文件名称符合 name 的文件。iname 会忽略大小写。<li>-size n : 文件大小 是 n 单位，b 代表 512 位元组的区块，c 表示字元数，k 表示 kilo bytes，w 是二个位元组。<li>-pid n : process id 是 n 的文件。<li>-type<ul><li>c : 文件类型是 c 的文件。<li>d: 目录<li>c: 字型装置文件<li>b: 区块装置文件<li>p: 具名贮列<li>f: 一般文件<li>l: 符号连结<li>s: socket</ul></ul> <h4 id=4-4-1-2、locate命令><a class=headerlink href=#4-4-1-2、locate命令 title=4.4.1.2、locate命令></a>4.4.1.2、locate命令</h4><p>作用：<strong>用于查找符合条件的文档</strong>，他会去保存文档和目录名称的数据库中查找合乎范本样式条件的文档或目录。一般情况只需输入 <code>locate your_file_name</code> 即可查找指定文件。</p> <p>语法：</p> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>locate [-d ][--<span class=built_in>help</span>][--version][范本样式...]</span><br></pre></table></figure> <p>参数：</p> <ul><li>-b, –basename – 仅匹配路径名的基本名称<li>-c, –count – 只输出找到的数量<li>-d, –database DBPATH – 使用 DBPATH 指定的数据库，而不是默认数据库 /var/lib/mlocate/mlocate.db<li>-e, –existing – 仅打印当前现有文件的条目<li>-1 – 如果 是 1．则启动安全模式。在安全模式下，使用者不会看到权限无法看到 的档案。这会始速度减慢，因为 locate 必须至实际的档案系统中取得档案的 权限资料。<li>-0, –null – 在输出上带有NUL的单独条目<li>-S, –statistics – 不搜索条目，打印有关每个数据库的统计信息<li>-q – 安静模式，不会显示任何错误讯息。<li>-P, –nofollow, -H – 检查文件存在时不要遵循尾随的符号链接<li>-l, –limit, -n LIMIT – 将输出（或计数）限制为LIMIT个条目<li>-n – 至多显示 n个输出。<li>-m, –mmap – 被忽略，为了向后兼容<li>-r, –regexp REGEXP – 使用基本正则表达式<li>–regex – 使用扩展正则表达式<li>-q, –quiet – 安静模式，不会显示任何错误讯息<li>-s, –stdio – 被忽略，为了向后兼容<li>-o – 指定资料库存的名称。<li>-h, –help – 显示帮助<li>-i, –ignore-case – 忽略大小写<li>-V, –version – 显示版本信息</ul> <h3 id=4-4-2、查看文件内容><a class=headerlink href=#4-4-2、查看文件内容 title=4.4.2、查看文件内容></a>4.4.2、查看文件内容</h3><h4 id=4-4-2-1、cat命令><a class=headerlink href=#4-4-2-1、cat命令 title=4.4.2.1、cat命令></a>4.4.2.1、cat命令</h4><p>作用：<strong>将文件的全部内容输出到控制台上以供查看</strong>。需要注意的是该命令会一次性将所有内容输出到控制台，所以该命令适用于文件内容少的场景。</p> <p>语法：<code>cat [-AbeEnstTuv] [--help] [--version] fileName</code></p> <p>参数说明：</p> <ul><li><strong>-n 或 –number</strong>：由 1 开始对所有输出的行数编号。<li><strong>-b 或 –number-nonblank</strong>：和 -n 相似，只不过对于空白行不编号。<li><strong>-s 或 –squeeze-blank</strong>：当遇到有连续两行以上的空白行，就代换为一行的空白行。<li><strong>-v 或 –show-nonprinting</strong>：使用 ^ 和 M- 符号，除了 LFD 和 TAB 之外。<li><strong>-E 或 –show-ends</strong> : 在每行结束处显示 $。<li><strong>-T 或 –show-tabs</strong>: 将 TAB 字符显示为 ^I。<li><strong>-A, –show-all</strong>：等价于 -vET。<li><strong>-e：</strong>等价于”-vE”选项；<li><strong>-t：</strong>等价于”-vT”选项；</ul> <h4 id=4-4-2-2、more命令><a class=headerlink href=#4-4-2-2、more命令 title=4.4.2.2、more命令></a>4.4.2.2、more命令</h4><p><strong>该命令是一个基于VI编辑器的文本过滤器，可以全屏幕按页显示文件的内容。</strong></p> <p>该命令中内置了多个快捷键供使用，详情如下：</p> <ul><li>空白键：向下翻一页。<li>enter：向下翻一行。<li>q：退出不在显示文件内容。<li>ctrl+f：向下滚动一屏。<li>ctrl+b：返回上一屏。<li>=：输出当前行的行号。<li>:f：输出文件名和当前行的行号。</ul> <p>语法：</p> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>more [-dlfpcsu] [-num] [+/pattern] [+linenum] [fileNames..]</span><br></pre></table></figure> <p>参数：</p> <ul><li>-num：一次显示的行数。<li>-d：提示使用者，在画面下方显示 [Press space to continue, ‘q’ to quit.] ，如果使用者按错键，则会显示 [Press ‘h’ for instructions.] 而不是 ‘哔’ 声。<li>-l：取消遇见特殊字元 ^L（送纸字元）时会暂停的功能。<li>-f：计算行数时，以实际上的行数，而非自动换行过后的行数（有些单行字数太长的会被扩展为两行或两行以上）。<li>-p：不以卷动的方式显示每一页，而是先清除萤幕后再显示内容。<li>-c：跟 -p 相似，不同的是先显示内容再清除其他旧资料。<li>-s：当遇到有连续两行以上的空白行，就代换为一行的空白行。<li>-u：不显示下引号 （根据环境变数 TERM 指定的 terminal 而有所不同）。<li>+/pattern：在每个文档显示前搜寻该字串（pattern），然后从该字串之后开始显示。<li>+num：从第 num 行开始显示。<li>fileNames：欲显示内容的文档，可为复数个数。</ul> <h4 id=4-4-2-3、less命令><a class=headerlink href=#4-4-2-3、less命令 title=4.4.2.3、less命令></a>4.4.2.3、less命令</h4><p><strong>less命令用于分屏查看文件内容，与more命令类似，但比more要更强大，less支持各种终端。less在显示文件内容时并非一次将整个文件加载显示，而是根据显示内容需要进行加载，对于查看大型文件内容有较高的效率。</strong></p> <p>该命令同样支持快捷键，详情如下：</p> <ul><li>空白键：向下翻动一页。<li>pagedown：向下翻动一页。<li>pageup：向上翻动一页。<li>/字串：向下搜索字串的功能，n向下查找，N向上查找。<li>?字串：向上搜索字串的功能，n向上查找，N向下查找。<li>q：退出less程序。</ul> <p>语法：<code>less [参数] 文件 </code></p> <p>参数说明：</p> <ul><li>-b <缓冲区大小> 设置缓冲区的大小<li>-e 当文件显示结束后，自动离开<li>-f 强迫打开特殊文件，例如外围设备代号、目录和二进制文件<li>-g 只标志最后搜索的关键词<li>-i 忽略搜索时的大小写<li>-m 显示类似more命令的百分比<li>-N 显示每行的行号<li>-o <文件名> 将less 输出的内容在指定文件中保存起来<li>-Q 不使用警告音<li>-s 显示连续空行为一行<li>-S 行过长时间将超出部分舍弃<li>-x <数字> 将”tab”键显示为规定的数字空格<li>/字符串：向下搜索”字符串”的功能<li>?字符串：向上搜索”字符串”的功能<li>n：重复前一个搜索（与 / 或 ? 有关）<li>N：反向重复前一个搜索（与 / 或 ? 有关）<li>b 向上翻一页<li>d 向后翻半页<li>h 显示帮助界面<li>Q 退出less 命令<li>u 向前滚动半页<li>y 向前滚动一行<li>空格键 滚动一页<li>回车键 滚动一行<li>[pagedown]： 向下翻动一页<li>[pageup]： 向上翻动一页</ul> <h4 id=4-4-2-4、head命令><a class=headerlink href=#4-4-2-4、head命令 title=4.4.2.4、head命令></a>4.4.2.4、head命令</h4><p><strong>head命令用于显示文件开头部分内容，默认只显示文件开头前10行内容。</strong></p> <p>语法如下：</p> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line><span class=built_in>head</span> 文件</span><br><span class=line><span class=built_in>head</span> -n 5 文件</span><br></pre></table></figure> <p>参数解析：</p> <ul><li>-n：设置显示头部内容的行数。</ul> <p>使用示例：</p> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line><span class=comment># 命令1：查看文件info.txt内容的前3行</span></span><br><span class=line><span class=built_in>head</span> -n 3 info.txt</span><br></pre></table></figure> <h4 id=4-4-2-5、tail命令><a class=headerlink href=#4-4-2-5、tail命令 title=4.4.2.5、tail命令></a>4.4.2.5、tail命令</h4><p><strong>tail命令用于输出文件尾部内容，默认只显示文件尾部后10行内容。</strong></p> <p>语法如下：</p> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line><span class=built_in>tail</span> 文件</span><br><span class=line><span class=built_in>tail</span> -n 5 文件</span><br><span class=line><span class=built_in>tail</span> -f 文件</span><br></pre></table></figure> <p>参数解析：</p> <ul><li>-n：设置要查看文件尾部多少行的内容。<li>-f：实时追踪文档的所有更新。</ul> <p>使用示例：</p> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line><span class=comment># 命令1：查看文件info.txt内容的后5行</span></span><br><span class=line><span class=built_in>tail</span> -n 5 info.txt</span><br></pre></table></figure> <h3 id=4-4-3、追加文件内容><a class=headerlink href=#4-4-3、追加文件内容 title=4.4.3、追加文件内容></a>4.4.3、追加文件内容</h3><h4 id=4-4-3-1、echo命令><a class=headerlink href=#4-4-3-1、echo命令 title=4.4.3.1、echo命令></a>4.4.3.1、echo命令</h4><p><strong>echo命令会输出内容到控制台。</strong></p> <p>语法如下：</p> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line><span class=built_in>echo</span> [选项] [要输出的内容]</span><br></pre></table></figure> <p>参数解析：</p> <ul><li>-e：支持反斜线控制的字符转换。比如：<code>\\  \n  \t</code></ul> <p>使用示例如下：</p> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line><span class=comment># 命令1：控制台分行输出hello和world</span></span><br><span class=line><span class=built_in>echo</span> -e <span class=string>"hello\nworld"</span></span><br></pre></table></figure> <h4 id=4-4-3-2、追加操作-和><a title="4.4.3.2、追加操作>和>>" class=headerlink href=#4-4-3-2、追加操作-和></a>4.4.3.2、追加操作>和>></h4><p>语法如下：</p> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line><span class=built_in>echo</span> 要输出的内容 [>/>>] info.txt</span><br></pre></table></figure> <p>参数解析：</p> <ul><li><code>></code>：<strong>向文件中添加内容，并覆盖已存在内容。</strong><li><code>>></code>：<strong>向文件中追加内容，不会覆盖已存在内容。</strong></ul> <p>使用示例：</p> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line><span class=comment># 命令1：将字符串hello输出保存到文件info.txt</span></span><br><span class=line><span class=built_in>echo</span> <span class=string>"hello"</span> >> info.txt</span><br></pre></table></figure> <h3 id=4-4-4、软连接文件><a class=headerlink href=#4-4-4、软连接文件 title=4.4.4、软连接文件></a>4.4.4、软连接文件</h3><p><strong>软连接也称为符号链接，有着自己的数据块，主要存储链接到其它文件的路径。</strong></p> <p>语法如下：</p> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line><span class=built_in>ln</span> -s [原文件或目录] [软连接名字]</span><br></pre></table></figure> <p>注意事项：</p> <ul><li>使用删除命令<code>rm -rf 软连接名/</code>后，软连接对应的真实目录中的文件也会被删除。<li>若仅仅想要删除软连接而不影响原始文件或目录，可以执行命令<code>rm -rf 软连接名</code>，与第一条描述的命令类似，只是缺少了一个<code>/</code>。</ul> <p>使用示例：</p> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line><span class=comment># 命令1：为目录/tmp创建一个软连接tmpdir</span></span><br><span class=line><span class=built_in>ln</span> -s /tmp tmpdir</span><br></pre></table></figure> <h2 id=4-5、压缩和解压缩><a class=headerlink href=#4-5、压缩和解压缩 title=4.5、压缩和解压缩></a>4.5、压缩和解压缩</h2><h3 id=4-5-1、gzip-gunzip><a class=headerlink href=#4-5-1、gzip-gunzip title=4.5.1、gzip/gunzip></a>4.5.1、gzip/gunzip</h3><p>语法如下：</p> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line>gzip 文件</span><br><span class=line>gunzip 文件.gz</span><br></pre></table></figure> <p>注意事项：</p> <ul><li><strong>只能压缩文件，不能压缩目录</strong>。<li><strong>不保留原来的文件</strong>。<li><strong>同时多个文件会产生多个压缩包</strong>。</ul> <p>使用示例：</p> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line><span class=comment># 命令1：压缩文件hello.txt</span></span><br><span class=line>gzip hello.txt</span><br><span class=line></span><br><span class=line><span class=comment># 命令2：解压缩文件hello.txt.gz</span></span><br><span class=line>gunzip hello.txt.gz</span><br></pre></table></figure> <h3 id=4-5-2、zip-unzip><a class=headerlink href=#4-5-2、zip-unzip title=4.5.2、zip/unzip></a>4.5.2、zip/unzip</h3><p>语法如下：</p> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line><span class=comment># 压缩命令语法</span></span><br><span class=line>zip [选项] [自定义名字.zip] [要压缩的内容]</span><br><span class=line><span class=comment># 解压缩命令语法</span></span><br><span class=line>unzip [选项] [自定义名字.zip]</span><br></pre></table></figure> <p>参数解析：</p> <ul><li>zip命令参数<ul><li>-r：压缩目录。</ul><li>unzip命令参数：<ul><li>-d<目录>：指定解压后文件要存放的目录。</ul></ul> <p>注意事项：</p> <ul><li><strong>zip命令在 win/linux 上都通用，可以压缩目录且保留源文件</strong>。</ul> <p>使用示例：</p> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre><td class=code><pre><span class=line><span class=comment># 命令1：压缩目录/root，然后再解压缩到/tmp目录下</span></span><br><span class=line>zip -r rootdir.zip /root</span><br><span class=line>unzip -d /tmp rootdir.zip</span><br><span class=line></span><br><span class=line><span class=comment># 命令2：一次将多个文件压缩成一个文件，然后再解压缩到/tmp目录下</span></span><br><span class=line>zip morefile.zip houge.txt bailongma.txt</span><br><span class=line>unzip -d /tmp morefile.zip</span><br></pre></table></figure> <h3 id=4-5-3、tar打包><a class=headerlink href=#4-5-3、tar打包 title=4.5.3、tar打包></a>4.5.3、tar打包</h3><p>语法如下：</p> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>tar [选项] [自定义名字.tar.gz] [需要打包的内容]</span><br></pre></table></figure> <p>参数解析：</p> <ul><li>-z：打包的同时进行压缩（使用了gzip）。<li>-c：生成.tar打包文件。<li>-v：显示详细信息。<li>-f：指定压缩后的文件名。<li>-x：解包.tar文件。<li>-C：解压缩到指定目录。</ul> <p>使用示例：</p> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line><span class=comment># 命令1：将多个文件打包并压缩，然后再解包到/tmp目录下</span></span><br><span class=line>tar -zcvf houma.tar.gz houge.txt bailongma.txt</span><br><span class=line>tar -zxvf houma.tar.gz -C /tmp</span><br></pre></table></figure> <h2 id=4-6、时间日期><a class=headerlink href=#4-6、时间日期 title=4.6、时间日期></a>4.6、时间日期</h2><h3 id=4-6-1、date命令><a class=headerlink href=#4-6-1、date命令 title=4.6.1、date命令></a>4.6.1、date命令</h3><p>语法如下：</p> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line><span class=built_in>date</span> [选项] ... [+format]</span><br></pre></table></figure> <p>参数解析：</p> <ul><li>-d<时间字符串>：显示指定的时间字符串表示的日期，非当前时间。<li>-s<日期时间>：设置系统日期时间。<li>date +%Y：显示当前年份。<li>date +%m：显示当前月份。<li>date +%d：显示当前哪一天。<li>date “+%Y-%m-%d %H:%M:%S”：显示年月日时分秒。</ul> <h3 id=4-6-2、cal命令><a class=headerlink href=#4-6-2、cal命令 title=4.6.2、cal命令></a>4.6.2、cal命令</h3><h1 id=5、网络管理><a class=headerlink href=#5、网络管理 title=5、网络管理></a>5、网络管理</h1><h2 id=5-1、查看网络IP和网关><a class=headerlink href=#5-1、查看网络IP和网关 title=5.1、查看网络IP和网关></a>5.1、查看网络IP和网关</h2><p><img alt=image-20210919111446177 src=https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/07/image-20210919111446177.png></p> <p><img alt=image-20210919111853400 src=https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/07/image-20210919111853400.png></p> <h2 id=5-2、网络环境配置><a class=headerlink href=#5-2、网络环境配置 title=5.2、网络环境配置></a>5.2、网络环境配置</h2><h3 id=5-2-1、配置静态IP><a class=headerlink href=#5-2-1、配置静态IP title=5.2.1、配置静态IP></a>5.2.1、配置静态IP</h3><p>编辑<code>/etc/sysconfig/network-scripts/ifcfg-eth0</code>文件，添加如下配置：</p> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br></pre><td class=code><pre><span class=line>NAME=ens33</span><br><span class=line>TYPE=Ethernet</span><br><span class=line>UUID=647650b9-b648-4848-b2b5-469f6840a621</span><br><span class=line>DEVICE=ens33</span><br><span class=line>ONBOOT=<span class=built_in>yes</span></span><br><span class=line>PROXY_METHOD=none</span><br><span class=line>BOOTPROTO=static</span><br><span class=line>DEFROUTE=<span class=built_in>yes</span></span><br><span class=line>IPV4_FAILURE_FATAL=<span class=built_in>yes</span></span><br><span class=line>IPV6INIT=no</span><br><span class=line>IPADDR=192.168.93.129</span><br><span class=line>GATEWAY=192.168.93.2</span><br><span class=line>DNS1=192.168.93.2</span><br><span class=line>PREFIX=24</span><br></pre></table></figure> <p>注意：配置完毕后需要重启系统。</p> <h3 id=5-2-2、配置动态IP><a class=headerlink href=#5-2-2、配置动态IP title=5.2.2、配置动态IP></a>5.2.2、配置动态IP</h3><p>编辑<code>/etc/sysconfig/network-scripts/ifcfg-eth0</code>文件，添加如下配置：</p> <figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br></pre><td class=code><pre><span class=line><span class=attr>NAME</span>=<span class=string>ens33</span></span><br><span class=line><span class=attr>DEVICE</span>=<span class=string>ens33</span></span><br><span class=line><span class=attr>TYPE</span>=<span class=string>Ethernet</span></span><br><span class=line><span class=attr>UUID</span>=<span class=string>647650b9-b648-4848-b2b5-469f6840a621</span></span><br><span class=line><span class=attr>ONBOOT</span>=<span class=string>yes</span></span><br><span class=line><span class=attr>PROXY_METHOD</span>=<span class=string>none</span></span><br><span class=line><span class=attr>BROWSER_ONLY</span>=<span class=string>no</span></span><br><span class=line><span class=attr>BOOTPROTO</span>=<span class=string>dhcp</span></span><br><span class=line><span class=attr>DEFROUTE</span>=<span class=string>yes</span></span><br><span class=line><span class=attr>IPV4_FAILURE_FATAL</span>=<span class=string>no</span></span><br><span class=line><span class=attr>IPV6INIT</span>=<span class=string>yes</span></span><br><span class=line><span class=attr>IPV6_AUTOCONF</span>=<span class=string>yes</span></span><br><span class=line><span class=attr>IPV6_DEFROUTE</span>=<span class=string>yes</span></span><br><span class=line><span class=attr>IPV6_FAILURE_FATAL</span>=<span class=string>no</span></span><br><span class=line><span class=attr>IPV6_ADDR_GEN_MODE</span>=<span class=string>stable-privacy</span></span><br></pre></table></figure> <p>注意：配置完毕后需要重启系统。</p> <h2 id=5-3、netstat指令><a class=headerlink href=#5-3、netstat指令 title=5.3、netstat指令></a>5.3、netstat指令</h2><p>简介：<strong>netstat 命令用于显示网络状态。利用 netstat 指令可查看系统网络情况。</strong></p> <p>语法：</p> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>netstat [-acCeFghilMnNoprstuvVwx][-A<网络类型>][--ip]</span><br></pre></table></figure> <p>参数说明：</p> <ul><li>-a或–all 显示所有连线中的Socket。<li>-A<网络类型>或–<网络类型> 列出该网络类型连线中的相关地址。<li>-c或–continuous 持续列出网络状态。<li>-C或–cache 显示路由器配置的快取信息。<li>-e或–extend 显示网络其他相关信息。<li>-F或–fib 显示路由缓存。<li>-g或–groups 显示多重广播功能群组组员名单。<li>-h或–help 在线帮助。<li>-i或–interfaces 显示网络界面信息表单。<li>-l或–listening 显示监控中的服务器的Socket。<li>-M或–masquerade 显示伪装的网络连线。<li>-n或–numeric 直接使用IP地址，而不通过域名服务器。<li>-N或–netlink或–symbolic 显示网络硬件外围设备的符号连接名称。<li>-o或–timers 显示计时器。<li>-p或–programs 显示正在使用Socket的程序识别码和程序名称。<li>-r或–route 显示Routing Table。<li>-s或–statistics 显示网络工作信息统计表。<li>-t或–tcp 显示TCP传输协议的连线状况。<li>-u或–udp 显示UDP传输协议的连线状况。<li>-v或–verbose 显示指令执行过程。<li>-V或–version 显示版本信息。<li>-w或–raw 显示RAW传输协议的连线状况。<li>-x或–unix 此参数的效果和指定”-A unix”参数相同。<li>–ip或–inet 此参数的效果和指定”-A inet”参数相同。</ul> <h1 id=6、进程管理><a class=headerlink href=#6、进程管理 title=6、进程管理></a>6、进程管理</h1><h2 id=6-1、简介><a class=headerlink href=#6-1、简介 title=6.1、简介></a>6.1、简介</h2><p><strong>Linux中的每个执行程序都是 一个进程，每个进程都有一个ID号。系统服务通常以 后台进程 方式存在，直到系统关机。</strong></p> <h2 id=6-2、查看系统进程><a class=headerlink href=#6-2、查看系统进程 title=6.2、查看系统进程></a>6.2、查看系统进程</h2><h3 id=6-2-1、ps命令><a class=headerlink href=#6-2-1、ps命令 title=6.2.1、ps命令></a>6.2.1、ps命令</h3><p>语法：<code>ps [options] [--help]</code></p> <p>参数：</p> <ul><li>-A 列出所有的进程<li>-w 显示加宽可以显示较多的资讯<li>-au 显示较详细的资讯<li>-aux 显示所有包含其他使用者的行程<li>au(x) 输出格式 :</ul> <figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>USER PID %CPU %MEM VSZ RSS TTY STAT START TIME COMMAND</span><br></pre></table></figure> <ul><li>USER: 行程拥有者<li>PID：p’ppid<li>%CPU: 占用的 CPU 使用率<li>%MEM: 占用的记忆体使用率<li>VSZ: 占用的虚拟记忆体大小<li>RSS: 占用的记忆体大小<li>TTY: 终端的次要装置号码 (minor device number of tty)<li>STAT: 该行程的状态:<ul><li>D: 无法中断的休眠状态 (通常 IO 的进程)<li>R: 正在执行中<li>S: 静止状态<li>T: 暂停执行<li>Z: 不存在但暂时无法消除<li>W: 没有足够的记忆体分页可分配<li>&LT: 高优先序的行程<li>N: 低优先序的行程<li>L: 有记忆体分页分配并锁在记忆体内 (实时系统或捱A I/O)</ul><li>START: 行程开始时间<li>TIME: 执行时间<li>COMMAND：执行指令</ul> <h3 id=6-2-2、pstree命令><a class=headerlink href=#6-2-2、pstree命令 title=6.2.2、pstree命令></a>6.2.2、pstree命令</h3><p>简介：<strong>pstree命令将所有行程以树状图显示，树状图将会以 pid (如果有指定) 或是以 init 这个基本行程为根 (root)，如果有指定使用者 id，则树状图会只显示该使用者所拥有的行程。</strong></p> <p>语法：</p> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line>pstree [-a] [-c] [-h|-Hpid] [-l] [-n] [-p] [-u] [-G|-U] [pid|user]</span><br><span class=line><span class=comment># or</span></span><br><span class=line>pstree -V</span><br></pre></table></figure> <p>参数说明：</p> <ul><li>-a 显示该行程的完整指令及参数, 如果是被记忆体置换出去的行程则会加上括号。<li>-c 如果有重覆的行程名, 则分开列出（预设值是会在前面加上 *）。</ul> <h2 id=6-3、终止进程><a class=headerlink href=#6-3、终止进程 title=6.3、终止进程></a>6.3、终止进程</h2><h3 id=6-3-1、简介><a class=headerlink href=#6-3-1、简介 title=6.3.1、简介></a>6.3.1、简介</h3><p>**终止进程可以采用命令 <code>kill、killall、pkill</code>**。</p> <h3 id=6-3-2、kill命令><a class=headerlink href=#6-3-2、kill命令 title=6.3.2、kill命令></a>6.3.2、kill命令</h3><p>简介：<strong>kill 命令可以通过指定进程PID来杀死或删除程序。</strong></p> <p>语法：</p> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line><span class=built_in>kill</span> [-s <信息名称或编号>][程序]　或　<span class=built_in>kill</span> [-l <信息编号>]</span><br></pre></table></figure> <p>参数说明：</p> <ul><li>-l <信息编号>：若不加<信息编号>选项，则 -l 参数会列出全部的信息名称。<li>-s <信息名称或编号>：指定要送出的信息。<li>[程序]：可以是程序的PID或是PGID，也可以是工作编号。</ul> <p>使用 kill -l 命令列出所有可用信号。最常用信号：</p> <ul><li>1 (HUP)：重新加载进程。<li>9 (KILL)：杀死一个进程。<li>15 (TERM)：正常停止一个进程。</ul> <h3 id=6-3-3、killall命令><a class=headerlink href=#6-3-3、killall命令 title=6.3.3、killall命令></a>6.3.3、killall命令</h3><p>简介：<strong>killall 可以通过指定进程名字来杀死进程，与 kill 不同的是会杀死指定名字的所有进程。</strong></p> <p>语法：</p> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>killall [选项]  name</span><br></pre></table></figure> <p>参数说明：</p> <ul><li>name ： 进程名</ul> <p>选项包含如下几个参数：</p> <ul><li>-e | –exact ： 进程需要和名字完全相符。<li>-I | –ignore-case ：忽略大小写。<li>-g | –process-group ：结束进程组。<li>-i | –interactive ：结束之前询问。<li>-l | –list ：列出所有的信号名称。<li>-q | –quite ：进程没有结束时，不输出任何信息。<li>-r | –regexp ：将进程名模式解释为扩展的正则表达式。<li>-s | –signal ：发送指定信号。<li>-u | –user ：结束指定用户的进程。<li>-v | –verbose ：显示详细执行过程。<li>-w | –wait ：等待所有的进程都结束。<li>-V |–version ：显示版本信息。<li>–help ：显示帮助信息。</ul> <h3 id=6-3-4、pkill命令><a class=headerlink href=#6-3-4、pkill命令 title=6.3.4、pkill命令></a>6.3.4、pkill命令</h3><p>简介：<strong>pkill 用于杀死一个进程，与 kill 不同的是它会杀死指定名字的所有进程，类似于 killall命令。</strong></p> <p>语法：</p> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>pkill [选项]  name</span><br></pre></table></figure> <p>参数说明：</p> <ul><li>name ： 进程名</ul> <p>选项包含如下几个参数：</p> <ul><li>-o 仅向找到的最小（起始）进程号发送信号 -n 仅向找到的最大（结束）进程号发送信号<li>-P 指定父进程号发送信号<li>-g 指定进程组<li>-t 指定开启进程的终端</ul> <h2 id=6-4、监控进程><a class=headerlink href=#6-4、监控进程 title=6.4、监控进程></a>6.4、监控进程</h2><p>简介：<strong>top命令用于实时显示 process 动态。</strong></p> <p>语法：</p> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>top [-] [d delay] [q] [c] [S] [s] [i] [n] [b]</span><br></pre></table></figure> <p>参数说明：</p> <ul><li>d : 改变显示的更新速度，或是在交谈式指令列( interactive command)按 s<li>q : 没有任何延迟的显示速度，如果使用者是有 superuser 的权限，则 top 将会以最高的优先序执行<li>c : 切换显示模式，共有两种模式，一是只显示执行档的名称，另一种是显示完整的路径与名称<li>S : 累积模式，会将己完成或消失的子进程 ( dead child process ) 的 CPU time 累积起来<li>s : 安全模式，将交谈式指令取消, 避免潜在的危机<li>i : 不显示任何闲置 (idle) 或无用 (zombie) 的进程<li>n : 更新的次数，完成后将会退出 top<li>b : 批次档模式，搭配 “n” 参数一起使用，可以用来将 top 的结果输出到档案内</ul> <h1 id=7、服务管理><a class=headerlink href=#7、服务管理 title=7、服务管理></a>7、服务管理</h1><h2 id=7-1、简介><a class=headerlink href=#7-1、简介 title=7.1、简介></a>7.1、简介</h2><p><strong>服务本质就是进程，且运行在后台，通常会监听某个端口，等待其它程序请求，故称之为守护进程</strong>。</p> <h2 id=7-2、查看服务开启情况><a class=headerlink href=#7-2、查看服务开启情况 title=7.2、查看服务开启情况></a>7.2、查看服务开启情况</h2><p>查看方式如下：</p> <ol><li>指令<code>setup</code><li>指令<code>ls -l /etc/init.d/</code></ol> <h2 id=7-3、查看服务运行级别><a class=headerlink href=#7-3、查看服务运行级别 title=7.3、查看服务运行级别></a>7.3、查看服务运行级别</h2><p>查看或修改默认级别方式如下：</p> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line><span class=comment># 第一步：编辑/etc/inittab文件</span></span><br><span class=line>vim /etc/inittab</span><br><span class=line></span><br><span class=line><span class=comment># 第二步：设置需要的运行级别，比如设置运行级别为5</span></span><br><span class=line><span class=built_in>id</span>: 5: initdefault: </span><br></pre></table></figure> <h2 id=7-4、服务操作指令><a class=headerlink href=#7-4、服务操作指令 title=7.4、服务操作指令></a>7.4、服务操作指令</h2><h3 id=7-4-1、service（CentOS6）><a class=headerlink href=#7-4-1、service（CentOS6） title=7.4.1、service（CentOS6）></a>7.4.1、service（CentOS6）</h3><p>简介：<strong>service命令是 Redhat Linux 兼容发行版中用来控制系统服务的实用工具，它可以启动、停止、重新启动和关闭系统服务，还可以显示所有系统服务的当前状态。</strong></p> <p>语法：service 服务名 [start / stop / restart / reload / status]</p> <blockquote><p>以上语法方式仅仅是临时生效，系统重启后会变为最初状态。如果设置永久生效，需要使用<code>chkconfig</code>指令。</blockquote> <h3 id=7-4-2、systemctl（CentOS7）><a class=headerlink href=#7-4-2、systemctl（CentOS7） title=7.4.2、systemctl（CentOS7）></a>7.4.2、systemctl（CentOS7）</h3><p>简介：<strong>centOS7.0之后不再使用<code>service</code>指令，改用<code>systemctl</code>指令。</strong></p> <p>语法如下：</p> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>systemctl start/stop/restart/status 服务名字</span><br></pre></table></figure> <blockquote><p>除了使用命令查看服务外，可以通过访问<code>/usr/lib/systemd/system</code>来查看服务。</blockquote> <p>使用示例：</p> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line><span class=comment># 示例1：开启服务</span></span><br><span class=line>systemctl start network</span><br></pre></table></figure> <h3 id=7-4-3、chkconfig><a class=headerlink href=#7-4-3、chkconfig title=7.4.3、chkconfig></a>7.4.3、chkconfig</h3><p>简介：<strong>chkconfig命令用于检查、设置系统服务</strong>，是Red Hat公司遵循GPL规则所开发的程序，可查询操作系统在每一个执行等级中会执行哪些系统服务，其包括各类常驻服务。谨记 chkconfig 不是立即自动禁止或激活一个服务，它只是简单的改变了符号连接。</p> <p>语法：</p> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line>chkconfig [--add][--del][--list][系统服务] </span><br><span class=line><span class=comment># or</span></span><br><span class=line>chkconfig [--level <等级代号>][系统服务][on/off/reset]</span><br></pre></table></figure> <p>参数：</p> <ul><li>–add：增加所指定的系统服务，让 chkconfig 指令得以管理它，并同时在系统启动的叙述文件内增加相关数据。<li>–del：删除所指定的系统服务，不再由 chkconfig 指令管理，并同时在系统启动的叙述文件内删除相关数据。<li>–level<等级代号>：指定读系统服务要在哪一个执行等级中开启或关闭。</ul> <p><strong>常用命令</strong>：</p> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre><td class=code><pre><span class=line><span class=comment># 命令1：查看 所有服务 开启情况</span></span><br><span class=line>chkconfig --list</span><br><span class=line><span class=comment># 命令2：查看 sshd服务 开启情况</span></span><br><span class=line>chkconfig --list | grep sshd</span><br><span class=line><span class=comment># 命令3：设置将 sshd服务 在运行级别5下关闭</span></span><br><span class=line>chkconfig --level 5 sshd off</span><br></pre></table></figure> <h1 id=8、定时任务><a class=headerlink href=#8、定时任务 title=8、定时任务></a>8、定时任务</h1><h2 id=8-1、crontab命令><a class=headerlink href=#8-1、crontab命令 title=8.1、crontab命令></a>8.1、crontab命令</h2><h3 id=8-1-1、简介><a class=headerlink href=#8-1-1、简介 title=8.1.1、简介></a>8.1.1、简介</h3><p><strong>Linux crontab是用来定期执行程序的命令</strong>。</p> <p>当安装完成操作系统之后，默认便会启动此任务调度命令。crond 命令每分钟会定期检查是否有要执行的工作，如果有要执行的工作便会自动执行该工作。</p> <p>注意：<strong>新建 cron 任务不会马上执行，至少要过 2 分钟后才可以，当然你可以重启 cron 来马上执行</strong>。</p> <p>linux 任务调度的工作主要分为以下两类：</p> <ul><li><strong>系统执行工作</strong>：系统周期性所要执行的工作，如备份系统数据、清理缓存。<li><strong>个人执行工作</strong>：某个用户定期要做的工作。</ul> <p>每个用户都有自己的cron配置文件，通过命令<code>crontab -e</code>就可以编辑。</p> <p>一般情况下我们编辑好用户的cron配置文件保存退出后会自动存放于/var/spool/cron/目录中，文件以用户名命名，linux的cron服务是每隔一分钟去读取一次/var/spool/cron、/etc/crontab、/etc/cron.d下面所有的内容。</p> <h3 id=8-1-2、语法参数介绍><a class=headerlink href=#8-1-2、语法参数介绍 title=8.1.2、语法参数介绍></a>8.1.2、语法参数介绍</h3><p>语法：</p> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line>crontab [ -u user ] file</span><br><span class=line><span class=comment># or</span></span><br><span class=line>crontab [ -u user ] { -l | -r | -e }</span><br></pre></table></figure> <p>说明：</p> <p><strong>crontab 可实现在固定时间或固定间隔执行程序</strong>。</p> <p><strong><code>-u user</code>表示指定user时程表，其前提是必须有权限才能指定他人时程表。如果不使用<code>-u user</code>则表示设定自己时程表。</strong></p> <p>参数说明：</p> <ul><li>-l : 查询crontab任务。<li>-e : 编辑crontab定时任务。<li>-r : 删除当前用户所有的crontab任务。</ul> <p>时间格式：</p> <figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>f1 f2 f3 f4 f5 program</span><br></pre></table></figure> <ul><li>f1 表示<strong>分钟</strong>，f2 表示<strong>小时</strong>，f3 表示一个月份中的第几<strong>日</strong>，f4 表示<strong>月</strong>份，f5 表示一个星期中的第几<strong>天</strong>。program 表示要执行的程序。<li>当 f1 为 * 时表示每分钟都要执行 program，f2 为 * 时表示每小时都要执行程序，其馀类推<li>当 f1 为 a-b 时表示从第 a 分钟到第 b 分钟这段时间内要执行，f2 为 a-b 时表示从第 a 到第 b 小时都要执行，其馀类推<li>当 f1 为 */n 时表示每 n 分钟个时间间隔执行一次，f2 为 */n 表示每 n 小时个时间间隔执行一次，其馀类推<li>当 f1 为 a, b, c,… 时表示第 a, b, c,… 分钟要执行，f2 为 a, b, c,… 时表示第 a, b, c…个小时要执行，其馀类推</ul> <figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre><td class=code><pre><span class=line>*    *    *    *    *</span><br><span class=line>-    -    -    -    -</span><br><span class=line>|    |    |    |    |</span><br><span class=line>|    |    |    |    +----- 星期中星期几 (0 - 6) (星期天 为0)</span><br><span class=line>|    |    |    +---------- 月份 (1 - 12) </span><br><span class=line>|    |    +--------------- 一个月中的第几天 (1 - 31)</span><br><span class=line>|    +-------------------- 小时 (0 - 23)</span><br><span class=line>+------------------------- 分钟 (0 - 59)</span><br></pre></table></figure> <p>使用者也可以将所有的设定先存放在文件中，用crontab file的方式来设定执行时间。</p> <h3 id=8-1-3、常用命令><a class=headerlink href=#8-1-3、常用命令 title=8.1.3、常用命令></a>8.1.3、常用命令</h3><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre><td class=code><pre><span class=line><span class=comment># 每一分钟执行一次 /bin/ls：</span></span><br><span class=line>* * * * * /bin/ls</span><br><span class=line><span class=comment># 在12月内, 每天的早上 6 点到 12 点，每隔 3 个小时 0 分钟执行一次 /usr/bin/backup：</span></span><br><span class=line>0 6-12/3 * 12 * /usr/bin/backup</span><br><span class=line><span class=comment># 周一到周五每天下午 5:00 寄一封信给 alex@domain.name：</span></span><br><span class=line>0 17 * * 1-5 mail -s <span class=string>"hi"</span> alex@domain.name < /tmp/maildata</span><br><span class=line><span class=comment># 每月每天的午夜 0 点 20 分, 2 点 20 分, 4 点 20 分....执行 echo "haha"：</span></span><br><span class=line>20 0-23/2 * * * <span class=built_in>echo</span> <span class=string>"haha"</span></span><br></pre></table></figure> <p><font color=red>注意：当程序在你所指定的时间执行后，系统会发一封邮件给当前的用户，显示该程序执行的内容，若不希望收到这样的邮件，请在每一行空一格之后加上<code>> /dev/null 2>&1</code>即可，</font>如：</p> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>20 03 * * * . /etc/profile;/bin/sh /var/www/runoob/test.sh > /dev/null 2>&1 </span><br></pre></table></figure> <h3 id=8-1-4、常见问题><a class=headerlink href=#8-1-4、常见问题 title=8.1.4、常见问题></a>8.1.4、常见问题</h3><h4 id=8-1-4-1、脚本无法执行问题><a class=headerlink href=#8-1-4-1、脚本无法执行问题 title=8.1.4.1、脚本无法执行问题></a>8.1.4.1、脚本无法执行问题</h4><p>如果我们使用 crontab 来定时执行脚本，无法执行，但是如果直接通过命令（如：./test.sh)又可以正常执行，这主要是因为无法读取环境变量的原因。</p> <p>解决方法：</p> <ol><li><p><em><strong>所有命令需要写成绝对路径形式</strong></em>，如：<code>/usr/local/bin/docker</code>。</p><li><p><strong>在 shell 脚本开头使用以下代码</strong>：</p> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line><span class=meta>#!/bin/sh</span></span><br><span class=line></span><br><span class=line>. /etc/profile</span><br><span class=line>. ~/.bash_profile</span><br></pre></table></figure><li><p>在 <strong>/etc/crontab</strong> 中添加环境变量，在可执行命令之前添加命令 <strong>. /etc/profile;/bin/sh</strong>，使得环境变量生效，例如：</p> <figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>20 03 * * * . /etc/profile;/bin/sh /var/www/runoob/test.sh</span><br></pre></table></figure></ol> <h1 id=9、RPM和YUM><a class=headerlink href=#9、RPM和YUM title=9、RPM和YUM></a>9、RPM和YUM</h1><h2 id=9-1、RPM><a class=headerlink href=#9-1、RPM title=9.1、RPM></a>9.1、RPM</h2><h3 id=9-1-1、简介><a class=headerlink href=#9-1-1、简介 title=9.1.1、简介></a>9.1.1、简介</h3><p>rpm（英文全拼：redhat package manager） 原本是 Red Hat Linux 发行版专门用来<strong>管理 Linux 各项套件的程序</strong>，由于它遵循 GPL 规则且功能强大方便，因而广受欢迎。逐渐受到其他发行版采用。<strong>RPM 让 Linux 易于安装，升级，间接提升了 Linux 适用度</strong>。</p> <h3 id=9-1-2、语法><a class=headerlink href=#9-1-2、语法 title=9.1.2、语法></a>9.1.2、语法</h3><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>rpm [-acdhilqRsv][-b<完成阶段><套间档>+][-e<套件挡>][-f<文件>+][-i<套件档>][-p<套件档>＋][-U<套件档>][-vv][--addsign<套件档>+][--allfiles][--allmatches][--badreloc][--buildroot<根目录>][--changelog][--checksig<套件档>+][--clean][--dbpath<数据库目录>][--dump][--excludedocs][--excludepath<排除目录>][--force][--ftpproxy<主机名称或IP地址>][--ftpport<通信端口>][--<span class=built_in>help</span>][--httpproxy<主机名称或IP地址>][--httpport<通信端口>][--ignorearch][--ignoreos][--ignoresize][--includedocs][--initdb][justdb][--nobulid][--nodeps][--nofiles][--nogpg][--nomd5][--nopgp][--noorder][--noscripts][--notriggers][--oldpackage][--percent][--pipe<执行指令>][--prefix<目的目录>][--provides][--queryformat<档头格式>][--querytags][--rcfile<配置档>][--rebulid<套件档>][--rebuliddb][--recompile<套件档>][--relocate<原目录>=<新目录>][--replacefiles][--replacepkgs][--requires][--resign<套件档>+][--rmsource][--rmsource<文件>][--root<根目录>][--scripts][--setperms][--setugids][--short-circuit][--sign][--target=<安装平台>+][--<span class=built_in>test</span>][--timecheck<检查秒数>][--triggeredby<套件档>][--triggers][--verify][--version][--whatprovides<功能特性>][--whatrequires<功能特性>]</span><br></pre></table></figure> <p><strong>参数说明</strong>：</p> <ul><li>-a 　查询所有套件。<li>-b<完成阶段><套件档>+或-t <完成阶段><套件档>+ 　设置包装套件的完成阶段，并指定套件档的文件名称。<li>-c 　只列出组态配置文件，本参数需配合”-l”参数使用。<li>-d 　只列出文本文件，本参数需配合”-l”参数使用。<li>-e<套件档>或–erase<套件档> 　删除指定的套件。<li>-f<文件>+ 　查询拥有指定文件的套件。<li>-h或–hash 　套件安装时列出标记。<li>-i 　显示套件的相关信息。<li>-i<套件档>或–install<套件档> 　安装指定的套件档。<li>-l 　显示套件的文件列表。<li>-p<套件档>+ 　查询指定的RPM套件档。<li>-q 　使用询问模式，当遇到任何问题时，rpm指令会先询问用户。<li>-R 　显示套件的关联性信息。<li>-s 　显示文件状态，本参数需配合”-l”参数使用。<li>-U<套件档>或–upgrade<套件档> 升级指定的套件档。<li>-v 　显示指令执行过程。<li>-vv 　详细显示指令执行过程，便于排错。<li>-addsign<套件档>+ 　在指定的套件里加上新的签名认证。<li>–allfiles 　安装所有文件。<li>–allmatches 　删除符合指定的套件所包含的文件。<li>–badreloc 　发生错误时，重新配置文件。<li>–buildroot<根目录> 　设置产生套件时，欲当作根目录的目录。<li>–changelog 　显示套件的更改记录。<li>–checksig<套件档>+ 　检验该套件的签名认证。<li>–clean 　完成套件的包装后，删除包装过程中所建立的目录。<li>–dbpath<数据库目录> 　设置欲存放RPM数据库的目录。<li>–dump 　显示每个文件的验证信息。本参数需配合”-l”参数使用。<li>–excludedocs 　安装套件时，不要安装文件。<li>–excludepath<排除目录> 　忽略在指定目录里的所有文件。<li>–force 　强行置换套件或文件。<li>–ftpproxy<主机名称或IP地址> 　指定FTP代理服务器。<li>–ftpport<通信端口> 　设置FTP服务器或代理服务器使用的通信端口。<li>–help 　在线帮助。<li>–httpproxy<主机名称或IP地址> 　指定HTTP代理服务器。<li>–httpport<通信端口> 　设置HTTP服务器或代理服务器使用的通信端口。<li>–ignorearch 　不验证套件档的结构正确性。<li>–ignoreos 　不验证套件档的结构正确性。<li>–ignoresize 　安装前不检查磁盘空间是否足够。<li>–includedocs 　安装套件时，一并安装文件。<li>–initdb 　确认有正确的数据库可以使用。<li>–justdb 　更新数据库，当不变动任何文件。<li>–nobulid 　不执行任何完成阶段。<li>–nodeps 　不验证套件档的相互关联性。<li>–nofiles 　不验证文件的属性。<li>–nogpg 　略过所有GPG的签名认证。<li>–nomd5 　不使用MD5编码演算确认文件的大小与正确性。<li>–nopgp 　略过所有PGP的签名认证。<li>–noorder 　不重新编排套件的安装顺序，以便满足其彼此间的关联性。<li>–noscripts 　不执行任何安装Script文件。<li>–notriggers 　不执行该套件包装内的任何Script文件。<li>–oldpackage 　升级成旧版本的套件。<li>–percent 　安装套件时显示完成度百分比。<li>–pipe<执行指令> 　建立管道，把输出结果转为该执行指令的输入数据。<li>–prefix<目的目录> 　若重新配置文件，就把文件放到指定的目录下。<li>–provides 　查询该套件所提供的兼容度。<li>–queryformat<档头格式> 　设置档头的表示方式。<li>–querytags 　列出可用于档头格式的标签。<li>–rcfile<配置文件> 　使用指定的配置文件。<li>–rebulid<套件档> 　安装原始代码套件，重新产生二进制文件的套件。<li>–rebuliddb 　以现有的数据库为主，重建一份数据库。<li>–recompile<套件档> 　此参数的效果和指定”–rebulid”参数类似，当不产生套件档。<li>–relocate<原目录>=<新目录> 　把本来会放到原目录下的文件改放到新目录。<li>–replacefiles 　强行置换文件。<li>–replacepkgs 　强行置换套件。<li>–requires 　查询该套件所需要的兼容度。<li>–resing<套件档>+ 　删除现有认证，重新产生签名认证。<li>–rmsource 　完成套件的包装后，删除原始代码。<li>–rmsource<文件> 　删除原始代码和指定的文件。<li>–root<根目录> 　设置欲当作根目录的目录。<li>–scripts 　列出安装套件的Script的变量。<li>–setperms 　设置文件的权限。<li>–setugids 　设置文件的拥有者和所属群组。<li>–short-circuit 　直接略过指定完成阶段的步骤。<li>–sign 　产生PGP或GPG的签名认证。<li>–target=<安装平台>+ 　设置产生的套件的安装平台。<li>–test 　仅作测试，并不真的安装套件。<li>–timecheck<检查秒数> 　设置检查时间的计时秒数。<li>–triggeredby<套件档> 　查询该套件的包装者。<li>–triggers 　展示套件档内的包装Script。<li>–verify 　此参数的效果和指定”-q”参数相同。<li>–version 　显示版本信息。<li>–whatprovides<功能特性> 　查询该套件对指定的功能特性所提供的兼容度。<li>–whatrequires<功能特性> 　查询该套件对指定的功能特性所需要的兼容度。</ul> <h3 id=9-1-3、常用命令><a class=headerlink href=#9-1-3、常用命令 title=9.1.3、常用命令></a>9.1.3、常用命令</h3><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br></pre><td class=code><pre><span class=line><span class=comment># 命令1：安装dejagnu</span></span><br><span class=line>rpm -ivh dejagnu-1.4.2-10.noarch.rpm</span><br><span class=line></span><br><span class=line><span class=comment># 命令2：忽略报错，强制安装</span></span><br><span class=line>rpm --force -ivh package.rpm</span><br><span class=line></span><br><span class=line><span class=comment># 命令3：列出所有已安装包</span></span><br><span class=line>rpm -qa</span><br><span class=line></span><br><span class=line><span class=comment># 命令4：查看rpm包中文件安装位置</span></span><br><span class=line>rpm -ql <span class=built_in>ls</span></span><br><span class=line></span><br><span class=line><span class=comment># 命令5：卸载rpm包</span></span><br><span class=line>rpm -e package.rpm </span><br><span class=line></span><br><span class=line><span class=comment># 命令6：升级rpm包</span></span><br><span class=line>rpm -U file.rpm</span><br></pre></table></figure> <h2 id=9-2、YUM><a class=headerlink href=#9-2、YUM title=9.2、YUM></a>9.2、YUM</h2><h3 id=9-2-1、简介><a class=headerlink href=#9-2-1、简介 title=9.2.1、简介></a>9.2.1、简介</h3><p>yum（ Yellow dog Updater, Modified）是一个在 Fedora 和 RedHat 以及 SUSE 中的<strong>Shell前端软件包管理器</strong>。基于 RPM 包管理，能从指定服务器自动下载 RPM 包并安装，<strong>可自动处理依赖关系</strong>。</p> <p><strong>yum 提供了查找、安装、删除某一个、一组甚至全部软件包的命令，且命令简洁又好记。</strong></p> <h3 id=9-2-2、语法><a class=headerlink href=#9-2-2、语法 title=9.2.2、语法></a>9.2.2、语法</h3><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>yum [options] [<span class=built_in>command</span>] [package ...]</span><br></pre></table></figure> <ul><li><strong>options：</strong>可选，选项包括-h（帮助），-y（当安装过程提示选择全部为 “yes”），-q（不显示安装的过程）等等。<li><strong>command：</strong>要进行的操作。<li><strong>package：</strong>安装的包名。</ul> <h3 id=9-2-3、常用命令><a class=headerlink href=#9-2-3、常用命令 title=9.2.3、常用命令></a>9.2.3、常用命令</h3><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br></pre><td class=code><pre><span class=line><span class=comment># 1.列出所有可更新的软件清单命令：</span></span><br><span class=line>yum check-update</span><br><span class=line><span class=comment># 2.更新所有软件命令：</span></span><br><span class=line>yum update</span><br><span class=line><span class=comment># 3.仅安装指定的软件命令：</span></span><br><span class=line>yum install &LTpackage_name></span><br><span class=line><span class=comment># 4.仅更新指定的软件命令：</span></span><br><span class=line>yum update &LTpackage_name></span><br><span class=line><span class=comment># 5.列出所有可安裝的软件清单命令：</span></span><br><span class=line>yum list</span><br><span class=line><span class=comment># 6.删除软件包命令：</span></span><br><span class=line>yum remove &LTpackage_name></span><br><span class=line><span class=comment># 7.查找软件包命令：</span></span><br><span class=line>yum search &LTkeyword></span><br><span class=line><span class=comment># 8.清除缓存命令:</span></span><br><span class=line>    <span class=comment># 8.1、清除缓存目录下的软件包</span></span><br><span class=line>    yum clean packages:</span><br><span class=line>    <span class=comment># 8.2、清除缓存目录下的 headers</span></span><br><span class=line>    yum clean headers:</span><br><span class=line>    <span class=comment># 8.3、清除缓存目录下旧的 headers</span></span><br><span class=line>    yum clean oldheaders:</span><br><span class=line>    <span class=comment># 8.4、清除缓存目录下的软件包及旧的 headers</span></span><br><span class=line>    yum clean, yum clean all (= yum clean packages; yum clean oldheaders) </span><br></pre></table></figure> <h1 id=10、强势工具><a class=headerlink href=#10、强势工具 title=10、强势工具></a>10、强势工具</h1><h2 id=10-1、文本处理工具><a class=headerlink href=#10-1、文本处理工具 title=10.1、文本处理工具></a>10.1、文本处理工具</h2><h3 id=10-1-1、cut命令><a class=headerlink href=#10-1-1、cut命令 title=10.1.1、cut命令></a>10.1.1、cut命令</h3><p><strong>cut命令可以从文件的每一行剪切字节、字符和字段，并将这些内容输出。</strong></p> <p>语法如下：</p> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line><span class=built_in>cut</span> 参数 filename</span><br></pre></table></figure> <p>参数解析：</p> <ul><li>-d：分隔符，按照指定分隔符来分割列，默认是制表符”\t”。<li>-f：列号，提取第几列。<li>-c：按字符进行切割，后加n表示取第几列。</ul> <h3 id=10-1-2、awk命令><a class=headerlink href=#10-1-2、awk命令 title=10.1.2、awk命令></a>10.1.2、awk命令</h3><p><strong>awk是一个强大的文本分析工具，把文件逐行读入，以空格为默认分隔符将行进行切割。</strong></p> <p>语法如下：</p> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>awk [参数] <span class=string>'/pattern1/{action1} /pattern2/{action2}'</span> filename</span><br></pre></table></figure> <p>参数解析：</p> <ul><li>-f：指定输入文件分割符。<li>-v：赋值一个用户定义变量。<li>pattern：表示awk在数据中查找的内容，就是匹配模式。<li>action：找到匹配内容时所执行的一系列命令。</ul> <p>内置变量：</p> <ul><li>FILENAME：文件名。<li>NR：已读的记录数，行号。<li>NF：游览记录的域的个数（切割后，列的数量）</ul> <p>使用示例：</p> <figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre><td class=code><pre><span class=line><span class=comment># 命令1：</span></span><br><span class=line>awk -F : <span class=string>'{print $1","$7}'</span> passwd</span><br><span class=line></span><br><span class=line><span class=comment># 命令2：</span></span><br><span class=line>awk -F : <span class=string>'BEGIN{print "start..."} {print $1","$7} END{print "end..."}'</span> passwd</span><br><span class=line></span><br><span class=line><span class=comment># 命令3：将passwd文件中的用户id增加1并输出</span></span><br><span class=line>awk -v i=1 -F : <span class=string>'{print $3+i}'</span> passwd</span><br></pre></table></figure> <footer class=post-footer><div class=post-eof></div></footer> <nav class=pagination><a class="extend prev" aria-label=上一页 href=/page/6/ rel=prev title=上一页><i class="fa fa-angle-left"></i></a><a class=page-number href=/>1</a><span class=space>…</span><a class=page-number href=/page/6/>6</a><span class="page-number current">7</span><a class=page-number href=/page/8/>8</a><span class=space>…</span><a class=page-number href=/page/12/>12</a><a class="extend next" aria-label=下一页 href=/page/8/ rel=next title=下一页><i class="fa fa-angle-right"></i></a></nav> <footer class=footer><div class=footer-inner><div class=copyright>© <span itemprop=copyrightYear>2024</span><span class=with-love> <i class="fa fa-heart"></i> </span><span class=author itemprop=copyrightHolder>豪哥</span></div></div></footer> <div class="toggle sidebar-toggle" role=button><span class=toggle-line></span><span class=toggle-line></span><span class=toggle-line></span></div> <div class=sidebar-dimmer></div> <div aria-label=返回顶部 class=back-to-top role=button><i class="fa fa-arrow-up fa-lg"></i><span>0%</span></div> <noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript> <script crossorigin=anonymous integrity=sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY= src=https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js></script> <script src=/js/comments.js></script><script src=/js/utils.js></script><script src=/js/motion.js></script><script src=/js/sidebar.js></script><script src=/js/next-boot.js></script> <script crossorigin=anonymous integrity=sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc= src=https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js></script> <script src=/js/third-party/search/local-search.js></script> 