<!doctypehtml><html lang=zh-CN><meta charset=UTF-8><meta content=width=device-width name=viewport><meta media="(prefers-color-scheme: light)" content=#222 name=theme-color><meta media="(prefers-color-scheme: dark)" content=#222 name=theme-color><meta content="Hexo 7.3.0" name=generator><link href=/images/apple-touch-icon-next.png rel=apple-touch-icon sizes=180x180><link href=/images/favicon-32x32-next.png rel=icon sizes=32x32 type=image/png><link href=/images/favicon-16x16-next.png rel=icon sizes=16x16 type=image/png><link color=#222 href=/images/logo.svg rel=mask-icon><link href=/css/main.css rel=stylesheet><link crossorigin=anonymous href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css integrity=sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA= rel=stylesheet><link crossorigin=anonymous href=https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css integrity=sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE= rel=stylesheet><script class=next-config data-name=main type=application/json>{"hostname":"hshz21.gitee.io","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script src=/js/config.js></script><meta content=豪哥博客 name=description><meta content=website property=og:type><meta content=豪哥博客 property=og:title><meta content=https://hshz21.gitee.io/page/8/index.html property=og:url><meta content=豪哥博客 property=og:site_name><meta content=豪哥博客 property=og:description><meta content=zh_CN property=og:locale><meta content=豪哥 property=article:author><meta content=HG property=article:tag><meta content=summary name=twitter:card><link href=https://hshz21.gitee.io/page/8/ rel=canonical><script class=next-config data-name=page type=application/json>{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/8/index.html","title":""}</script><script class=next-config data-name=calendar type=application/json>""</script><title>豪哥博客</title><noscript><link href=/css/noscript.css rel=stylesheet></noscript><body class=use-motion itemscope itemtype=http://schema.org/WebPage><div class=headband></div><main class=main><div class=column><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=site-brand-container><div class=site-nav-toggle><div aria-label=切换导航栏 class=toggle role=button><span class=toggle-line></span><span class=toggle-line></span><span class=toggle-line></span></div></div><div class=site-meta><a class=brand href=/ rel=start> <i class=logo-line></i> <h1 class=site-title>豪哥博客</h1> <i class=logo-line></i> </a><p class=site-subtitle itemprop=description>豪哥博客</div><div class=site-nav-right><div class="toggle popup-trigger" aria-label=搜索 role=button><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ rel=section><i class="fa fa-home fa-fw"></i>首页</a><li class="menu-item menu-item-tags"><a href=/tags/ rel=section><i class="fa fa-tags fa-fw"></i>标签</a><li class="menu-item menu-item-categories"><a href=/categories/ rel=section><i class="fa fa-th fa-fw"></i>分类</a><li class="menu-item menu-item-archives"><a href=/archives/ rel=section><i class="fa fa-archive fa-fw"></i>归档</a><li class="menu-item menu-item-search"><a class=popup-trigger role=button><i class="fa fa-search fa-fw"></i>搜索 </a></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon> <i class="fa fa-search"></i> </span><div class=search-input-container><input autocapitalize=off autocomplete=off class=search-input maxlength=80 placeholder=搜索... spellcheck=false type=search></div><span class=popup-btn-close role=button> <i class="fa fa-times-circle"></i> </span></div><div class=search-result-container><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></header><aside class=sidebar><div class="sidebar-inner sidebar-overview-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录<li class=sidebar-nav-overview>站点概览</ul><div class=sidebar-panel-container><!--noindex--><div class="post-toc-wrap sidebar-panel"></div><!--/noindex--><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop=author itemscope itemtype=http://schema.org/Person><img alt=豪哥 class=site-author-image itemprop=image src=/static/imgs/avatar.png><p class=site-author-name itemprop=name>豪哥<div class=site-description itemprop=description>豪哥博客</div></div><div class="site-state-wrap animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/> <span class=site-state-item-count>109</span> <span class=site-state-item-name>日志</span> </a></div><div class="site-state-item site-state-categories"><a href=/categories/> <span class=site-state-item-count>33</span> <span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/> <span class=site-state-item-count>126</span> <span class=site-state-item-name>标签</span></a></div></nav></div></div></div></div></aside></div><div class="main-inner index posts-expand"><div class=post-block><article class=post-content itemscope itemtype=http://schema.org/Article><link href=https://hshz21.gitee.io/2024/08/21/HTTP%E5%B8%B8%E8%A7%81%E9%97%AE%E7%AD%94/ itemprop=mainEntityOfPage><span hidden itemprop=author itemscope itemtype=http://schema.org/Person> <meta content=/static/imgs/avatar.png itemprop=image> <meta content=豪哥 itemprop=name> </span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization> <meta content=豪哥博客 itemprop=name> <meta content=豪哥博客 itemprop=description> </span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork> <meta content="undefined | 豪哥博客" itemprop=name> <meta itemprop=description> </span><header class=post-header><h2 itemprop="name headline" class=post-title><a class=post-title-link href=/2024/08/21/HTTP%E5%B8%B8%E8%A7%81%E9%97%AE%E7%AD%94/ itemprop=url>计算机系列-HTTP常见问题</a></h2><div class=post-meta-container><div class=post-meta><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar"></i> </span> <span class=post-meta-item-text>发表于</span> <time itemprop="dateCreated datePublished" title="创建时间：2024-08-21 21:39:13" datetime=2024-08-21T21:39:13+08:00>2024-08-21</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar-check"></i> </span> <span class=post-meta-item-text>更新于</span> <time title="修改时间：2023-10-06 16:37:05" datetime=2023-10-06T16:37:05+08:00 itemprop=dateModified>2023-10-06</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-folder"></i> </span> <span class=post-meta-item-text>分类于</span> <span itemprop=about itemscope itemtype=http://schema.org/Thing> <a href=/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA/ itemprop=url rel=index><span itemprop=name>计算机</span></a> </span> </span></div></div></header><div class=post-body itemprop=articleBody><h2 id=1、TLS-SSL><a class=headerlink href=#1、TLS-SSL title=1、TLS/SSL></a>1、TLS/SSL</h2><h2 id=1-1、概述><a class=headerlink href=#1-1、概述 title=1.1、概述></a>1.1、概述</h2><p><strong>1994年，网景（Netscape）公司发布SSL1.0，1996年正式发布SSL3.0</strong>。<p>1997年，互联网任务工程组（IETF）发布了基于SSL协议的TLS协议，<strong>1999年，IETF发布了正式的行业标准RFC2246，至此，SSL/TLS正式成为通信安全标准</strong>。<p>SSL协议是基于公钥密码体制和X509数字证书技术，为网络通信提供身份认证及数据传输保密性、安全性的一种协议。<p>SSL/TLS协议由三部门组成：<ul><li>握手协议：协商加密算法、mac算法和会话密钥。<li>记录协议：对交换的数据进行加密和签名。<li>警报协议：解决出现的问题。</ul><h2 id=1-2、工作场景><a class=headerlink href=#1-2、工作场景 title=1.2、工作场景></a>1.2、工作场景</h2><p>SSL/TLS是工作于传输层和应用层之间的加密协议，对于应用层来说是透明的，应用层数据通过SSL/TLS进行加密。<h2 id=2、SSL4次握手><a class=headerlink href=#2、SSL4次握手 title=2、SSL4次握手></a>2、SSL4次握手</h2><p><strong>SSL/TLS 1.2 需要4次握⼿、2个RTT时延</strong>，图中分开画了，合起来也是4次握⼿：<p><img alt=image-20210415200422278 src=https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/05/image-20210415200422278.png?token=AIGEF3PE545JVVIYEW2IG7DEZZNCC><p><strong>SSL/TLS 1.3只需1个RTT往返时延，也即只需要3次握⼿</strong>：<p><img alt=image-20230805094308510 src=https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/05/image-20230805094308510.png?token=AIGEF3MKAARIDRCLPWWQ7RDEZZNDM></div><footer class=post-footer><div class=post-eof></div></footer></article></div><div class=post-block><article class=post-content itemscope itemtype=http://schema.org/Article><link href=https://hshz21.gitee.io/2024/08/21/Gateway%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/ itemprop=mainEntityOfPage><span hidden itemprop=author itemscope itemtype=http://schema.org/Person> <meta content=/static/imgs/avatar.png itemprop=image> <meta content=豪哥 itemprop=name> </span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization> <meta content=豪哥博客 itemprop=name> <meta content=豪哥博客 itemprop=description> </span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork> <meta content="undefined | 豪哥博客" itemprop=name> <meta itemprop=description> </span><header class=post-header><h2 itemprop="name headline" class=post-title><a class=post-title-link href=/2024/08/21/Gateway%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/ itemprop=url>Gateway系列-Gateway基础应用</a></h2><div class=post-meta-container><div class=post-meta><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar"></i> </span> <span class=post-meta-item-text>发表于</span> <time itemprop="dateCreated datePublished" title="创建时间：2024-08-21 21:39:13" datetime=2024-08-21T21:39:13+08:00>2024-08-21</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar-check"></i> </span> <span class=post-meta-item-text>更新于</span> <time title="修改时间：2023-09-23 20:46:18" datetime=2023-09-23T20:46:18+08:00 itemprop=dateModified>2023-09-23</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-folder"></i> </span> <span class=post-meta-item-text>分类于</span> <span itemprop=about itemscope itemtype=http://schema.org/Thing> <a href=/categories/Gateway/ itemprop=url rel=index><span itemprop=name>Gateway</span></a> </span> </span></div></div></header><div class=post-body itemprop=articleBody><h1 id=1、加入依赖><a class=headerlink href=#1、加入依赖 title=1、加入依赖></a>1、加入依赖</h1><figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line><span class=tag><<span class=name>dependency</span>></span></span><br><span class=line>    <span class=tag><<span class=name>groupId</span>></span>org.springframework.cloud<span class=tag>&LT/<span class=name>groupId</span>></span></span><br><span class=line>    <span class=tag><<span class=name>artifactId</span>></span>spring-cloud-starter-gateway<span class=tag>&LT/<span class=name>artifactId</span>></span></span><br><span class=line><span class=tag>&LT/<span class=name>dependency</span>></span></span><br></pre></table></figure><h1 id=2、编写配置><a class=headerlink href=#2、编写配置 title=2、编写配置></a>2、编写配置</h1><figure class="highlight yml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br></pre><td class=code><pre><span class=line><span class=comment># Spring</span></span><br><span class=line><span class=attr>spring:</span></span><br><span class=line>  <span class=attr>application:</span></span><br><span class=line>    <span class=attr>name:</span> <span class=string>shh-gulimall-gateway</span></span><br><span class=line>  <span class=comment># jackson时间格式化</span></span><br><span class=line>  <span class=attr>jackson:</span></span><br><span class=line>    <span class=attr>time-zone:</span> <span class=string>GMT+8</span></span><br><span class=line>    <span class=attr>date-format:</span> <span class=string>yyyy-MM-dd</span> <span class=string>HH:mm:ss</span></span><br><span class=line>  <span class=attr>servlet:</span></span><br><span class=line>    <span class=attr>multipart:</span></span><br><span class=line>      <span class=attr>max-file-size:</span> <span class=string>100MB</span></span><br><span class=line>      <span class=attr>max-request-size:</span> <span class=string>100MB</span></span><br><span class=line>      <span class=attr>enabled:</span> <span class=literal>true</span></span><br><span class=line>  <span class=attr>cloud:</span></span><br><span class=line>    <span class=attr>nacos:</span></span><br><span class=line>      <span class=attr>discovery:</span></span><br><span class=line>        <span class=attr>server-addr:</span> <span class=number>127.0</span><span class=number>.0</span><span class=number>.1</span><span class=string>:8848</span></span><br><span class=line>        <span class=attr>namespace:</span> <span class=string>37d6d15b-ee13-4bb6-8dfb-101f2281d479</span></span><br><span class=line>        <span class=attr>group:</span> <span class=string>gulimall-server-list</span></span><br><span class=line>    <span class=attr>gateway:</span></span><br><span class=line>      <span class=attr>routes:</span></span><br><span class=line>        <span class=bullet>-</span> <span class=attr>id:</span> <span class=string>gulimall-product-router</span></span><br><span class=line>          <span class=attr>uri:</span> <span class=string>lb://shh-gulimall-product</span></span><br><span class=line>          <span class=attr>predicates:</span></span><br><span class=line>            <span class=bullet>-</span> <span class=string>Path=/api/product/**</span></span><br><span class=line>          <span class=attr>filters:</span></span><br><span class=line>            <span class=bullet>-</span> <span class=string>RewritePath=/api/?(?&LTsegment>.*),</span> <span class=string>/$\{segment}</span></span><br><span class=line>        <span class=bullet>-</span> <span class=attr>id:</span> <span class=string>gulimall-third-party-router</span></span><br><span class=line>          <span class=attr>uri:</span> <span class=string>lb://shh-gulimall-third-party</span></span><br><span class=line>          <span class=attr>predicates:</span></span><br><span class=line>            <span class=bullet>-</span> <span class=string>Path=/api/thirdparty/**</span></span><br><span class=line>          <span class=attr>filters:</span></span><br><span class=line>            <span class=bullet>-</span> <span class=string>RewritePath=/api/thirdparty/?(?&LTsegment>.*),</span> <span class=string>/gulimall-third-party/$\{segment}</span></span><br><span class=line>        <span class=bullet>-</span> <span class=attr>id:</span> <span class=string>gulimall-admin-router</span></span><br><span class=line>          <span class=attr>uri:</span> <span class=string>lb://shh-gulimall-admin</span></span><br><span class=line>          <span class=attr>predicates:</span></span><br><span class=line>            <span class=bullet>-</span> <span class=string>Path=/api/**</span></span><br><span class=line>          <span class=attr>filters:</span></span><br><span class=line>            <span class=bullet>-</span> <span class=string>RewritePath=/api/?(?&LTsegment>.*),</span> <span class=string>/$\{segment}</span></span><br></pre></table></figure><h1 id=3、全局过滤器><a class=headerlink href=#3、全局过滤器 title=3、全局过滤器></a>3、全局过滤器</h1><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br></pre><td class=code><pre><span class=line><span class=meta>@Slf4j</span></span><br><span class=line><span class=meta>@Component</span></span><br><span class=line><span class=meta>@Order(-1)</span>	<span class=comment>// 过滤器执行优先级，数字越小优先级越高。</span></span><br><span class=line><span class=keyword>public</span> <span class=keyword>class</span> <span class="title class_">SpringCloudGatewayFilter</span> <span class=keyword>implements</span> <span class="title class_">GlobalFilter</span>{</span><br><span class=line>    <span class=meta>@Override</span></span><br><span class=line>    <span class=keyword>public</span> Mono&LTVoid> <span class="title function_">filter</span><span class=params>(ServerWebExchange exchange, GatewayFilterChain chain)</span> {</span><br><span class=line>        <span class=type>String</span> <span class=variable>auth</span> <span class=operator>=</span> exchange.getRequest().getQueryParams().getFirst(<span class=string>"auth"</span>);</span><br><span class=line>        <span class=keyword>if</span> (StringUtils.isEmpty(auth)){</span><br><span class=line>            log.info(<span class=string>"用户名不能为空，请检查！"</span>);</span><br><span class=line>            exchange.getResponse().setStatusCode(HttpStatus.NOT_ACCEPTABLE);</span><br><span class=line>            <span class=keyword>return</span> exchange.getResponse().setComplete();</span><br><span class=line>        }<span class=keyword>else</span> <span class=keyword>if</span> (!auth.equals(<span class=string>"admin"</span>)){</span><br><span class=line>            log.info(<span class=string>"你没有权限！"</span>);</span><br><span class=line>            exchange.getResponse().setStatusCode(HttpStatus.NOT_ACCEPTABLE);</span><br><span class=line>            <span class=keyword>return</span> exchange.getResponse().setComplete();</span><br><span class=line>        }</span><br><span class=line>        <span class=keyword>return</span> chain.filter(exchange);</span><br><span class=line>    }</span><br><span class=line>}</span><br></pre></table></figure><h1 id=4、集成Sentinel><a class=headerlink href=#4、集成Sentinel title=4、集成Sentinel></a>4、集成Sentinel</h1><h2 id=4-1、授权规则><a class=headerlink href=#4-1、授权规则 title=4.1、授权规则></a>4.1、授权规则</h2><p><strong>只有通过网关进入的请求才能到达真正的服务，否则直接拦截</strong>。<h3 id=4-1-1、添加请求头信息><a class=headerlink href=#4-1-1、添加请求头信息 title=4.1.1、添加请求头信息></a>4.1.1、添加请求头信息</h3><p>在网关服务配置中 添加 请求头信息：<figure class="highlight yml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line><span class=attr>spring:</span></span><br><span class=line>  <span class=attr>cloud:</span></span><br><span class=line>    <span class=attr>gateway:</span></span><br><span class=line>      <span class=attr>default-filters:</span></span><br><span class=line>        <span class=bullet>-</span> <span class=string>AddRequestHeader=origin,gateway</span></span><br></pre></table></figure><h3 id=4-1-2、真实服务验证><a class=headerlink href=#4-1-2、真实服务验证 title=4.1.2、真实服务验证></a>4.1.2、真实服务验证</h3><p>在具体的服务中编写验证逻辑：<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br></pre><td class=code><pre><span class=line><span class=meta>@Component</span></span><br><span class=line><span class=keyword>public</span> <span class=keyword>class</span> <span class="title class_">HeaderOriginParser</span> <span class=keyword>implements</span> <span class="title class_">RequestOriginParser</span> {</span><br><span class=line>    <span class=meta>@Override</span></span><br><span class=line>    <span class=keyword>public</span> String <span class="title function_">parseOrigin</span><span class=params>(HttpServletRequest httpServletRequest)</span> {</span><br><span class=line>        <span class=type>String</span> <span class=variable>origin</span> <span class=operator>=</span> httpServletRequest.getHeader(<span class=string>"origin"</span>);</span><br><span class=line>        <span class=keyword>if</span> (StringUtils.isEmpty(origin)){</span><br><span class=line>            origin = <span class=string>"origin"</span>;</span><br><span class=line>        }</span><br><span class=line>        <span class=keyword>return</span> origin;</span><br><span class=line>    }</span><br><span class=line>}</span><br></pre></table></figure><h3 id=4-1-3、配置sentinel白名单><a class=headerlink href=#4-1-3、配置sentinel白名单 title=4.1.3、配置sentinel白名单></a>4.1.3、配置sentinel白名单</h3><p>在 簇点链路 列表中点击授权规则，设置白名单：<p><img src=https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/07/%E6%8E%88%E6%9D%83%E8%A7%84%E5%88%99-%E7%99%BD%E5%90%8D%E5%8D%95-%E6%B7%BB%E5%8A%A0.png></div><footer class=post-footer><div class=post-eof></div></footer></article></div><div class=post-block><article class=post-content itemscope itemtype=http://schema.org/Article><link href=https://hshz21.gitee.io/2024/08/21/Feign%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/ itemprop=mainEntityOfPage><span hidden itemprop=author itemscope itemtype=http://schema.org/Person> <meta content=/static/imgs/avatar.png itemprop=image> <meta content=豪哥 itemprop=name> </span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization> <meta content=豪哥博客 itemprop=name> <meta content=豪哥博客 itemprop=description> </span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork> <meta content="undefined | 豪哥博客" itemprop=name> <meta itemprop=description> </span><header class=post-header><h2 itemprop="name headline" class=post-title><a class=post-title-link href=/2024/08/21/Feign%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/ itemprop=url>Feign系列-Feign基础应用</a></h2><div class=post-meta-container><div class=post-meta><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar"></i> </span> <span class=post-meta-item-text>发表于</span> <time itemprop="dateCreated datePublished" title="创建时间：2024-08-21 21:39:13" datetime=2024-08-21T21:39:13+08:00>2024-08-21</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar-check"></i> </span> <span class=post-meta-item-text>更新于</span> <time title="修改时间：2023-10-02 15:57:29" datetime=2023-10-02T15:57:29+08:00 itemprop=dateModified>2023-10-02</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-folder"></i> </span> <span class=post-meta-item-text>分类于</span> <span itemprop=about itemscope itemtype=http://schema.org/Thing> <a href=/categories/Feign/ itemprop=url rel=index><span itemprop=name>Feign</span></a> </span> </span></div></div></header><div class=post-body itemprop=articleBody><h1 id=1、加入依赖><a class=headerlink href=#1、加入依赖 title=1、加入依赖></a>1、加入依赖</h1><figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line><span class=tag><<span class=name>dependency</span>></span></span><br><span class=line>    <span class=tag><<span class=name>groupId</span>></span>org.springframework.cloud<span class=tag>&LT/<span class=name>groupId</span>></span></span><br><span class=line>    <span class=tag><<span class=name>artifactId</span>></span>spring-cloud-starter-openfeign<span class=tag>&LT/<span class=name>artifactId</span>></span></span><br><span class=line><span class=tag>&LT/<span class=name>dependency</span>></span></span><br></pre></table></figure><h1 id=2、编写配置><a class=headerlink href=#2、编写配置 title=2、编写配置></a>2、编写配置</h1><figure class="highlight yml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line><span class=attr>feign:</span></span><br><span class=line>  <span class=attr>httpclient:</span></span><br><span class=line>    <span class=attr>enabled:</span> <span class=literal>true</span></span><br><span class=line>    <span class=attr>max-connections:</span> <span class=number>200</span></span><br><span class=line>    <span class=attr>max-connections-per-route:</span> <span class=number>50</span> <span class=comment># 单个路径最大连接数</span></span><br></pre></table></figure><h1 id=3、编写服务调用接口><a class=headerlink href=#3、编写服务调用接口 title=3、编写服务调用接口></a>3、编写服务调用接口</h1><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre><td class=code><pre><span class=line><span class=meta>@Component</span></span><br><span class=line><span class=meta>@FeignClient(value = "wms-service")</span></span><br><span class=line><span class=keyword>public</span> <span class=keyword>interface</span> <span class="title class_">WmsService</span> {</span><br><span class=line>    <span class=meta>@RequestMapping(value = "/ws/base/hello", method = RequestMethod.GET)</span></span><br><span class=line>    <span class=keyword>public</span> String <span class="title function_">hello</span><span class=params>()</span>;</span><br><span class=line>}</span><br></pre></table></figure><h1 id=4、整合Sentinel><a class=headerlink href=#4、整合Sentinel title=4、整合Sentinel></a>4、整合Sentinel</h1><h2 id=4-1、配置><a class=headerlink href=#4-1、配置 title=4.1、配置></a>4.1、配置</h2><figure class="highlight yml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line><span class=attr>feign:</span></span><br><span class=line>  <span class=attr>sentinel:</span></span><br><span class=line>    <span class=attr>enabled:</span> <span class=literal>true</span> <span class=comment># 开启对sentinel的支持</span></span><br></pre></table></figure><h2 id=4-2、Java代码><a class=headerlink href=#4-2、Java代码 title=4.2、Java代码></a>4.2、Java代码</h2><h3 id=4-2-1、FallbackFactory><a class=headerlink href=#4-2-1、FallbackFactory title=4.2.1、FallbackFactory></a>4.2.1、FallbackFactory</h3><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br></pre><td class=code><pre><span class=line><span class=meta>@Component</span></span><br><span class=line><span class=keyword>public</span> <span class=keyword>class</span> <span class="title class_">WmsServiceFallbackFactory</span> <span class=keyword>implements</span> <span class="title class_">FallbackFactory</span>&LTWmsService> {</span><br><span class=line>    <span class=meta>@Override</span></span><br><span class=line>    <span class=keyword>public</span> WmsService <span class="title function_">create</span><span class=params>(Throwable throwable)</span> {</span><br><span class=line>        <span class=keyword>return</span> <span class=keyword>new</span> <span class="title class_">WmsService</span>() {</span><br><span class=line>            <span class=meta>@Override</span></span><br><span class=line>            <span class=keyword>public</span> String <span class="title function_">hello</span><span class=params>()</span> {</span><br><span class=line>                System.err.println(<span class=string>"访问 WmsService 出错了！！！"</span>);</span><br><span class=line>                <span class=keyword>return</span> <span class=string>"error"</span>;</span><br><span class=line>            }</span><br><span class=line>        };</span><br><span class=line>    }</span><br><span class=line>}</span><br></pre></table></figure><h3 id=4-2-2、FeignClient调用><a class=headerlink href=#4-2-2、FeignClient调用 title=4.2.2、FeignClient调用></a>4.2.2、FeignClient调用</h3><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre><td class=code><pre><span class=line><span class=meta>@Component</span></span><br><span class=line><span class=meta>@FeignClient(value = "wms-service", fallback = WmsServiceFallbackFactory.class)</span></span><br><span class=line><span class=keyword>public</span> <span class=keyword>interface</span> <span class="title class_">WmsService</span> {</span><br><span class=line>    <span class=meta>@RequestMapping(value = "/ws/base/hello", method = RequestMethod.GET)</span></span><br><span class=line>    <span class=keyword>public</span> String <span class="title function_">hello</span><span class=params>()</span>;</span><br><span class=line>}</span><br></pre></table></figure></div><footer class=post-footer><div class=post-eof></div></footer></article></div><div class=post-block><article class=post-content itemscope itemtype=http://schema.org/Article><link href=https://hshz21.gitee.io/2024/08/21/Feign%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/ itemprop=mainEntityOfPage><span hidden itemprop=author itemscope itemtype=http://schema.org/Person> <meta content=/static/imgs/avatar.png itemprop=image> <meta content=豪哥 itemprop=name> </span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization> <meta content=豪哥博客 itemprop=name> <meta content=豪哥博客 itemprop=description> </span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork> <meta content="undefined | 豪哥博客" itemprop=name> <meta itemprop=description> </span><header class=post-header><h2 itemprop="name headline" class=post-title><a class=post-title-link href=/2024/08/21/Feign%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/ itemprop=url>Feign系列-Feign原理解析</a></h2><div class=post-meta-container><div class=post-meta><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar"></i> </span> <span class=post-meta-item-text>发表于</span> <time itemprop="dateCreated datePublished" title="创建时间：2024-08-21 21:39:13" datetime=2024-08-21T21:39:13+08:00>2024-08-21</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar-check"></i> </span> <span class=post-meta-item-text>更新于</span> <time title="修改时间：2023-10-02 16:09:18" datetime=2023-10-02T16:09:18+08:00 itemprop=dateModified>2023-10-02</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-folder"></i> </span> <span class=post-meta-item-text>分类于</span> <span itemprop=about itemscope itemtype=http://schema.org/Thing> <a href=/categories/Feign/ itemprop=url rel=index><span itemprop=name>Feign</span></a> </span> </span></div></div></header><div class=post-body itemprop=articleBody><h1 id=1、服务调用><a class=headerlink href=#1、服务调用 title=1、服务调用></a>1、服务调用</h1><h2 id=1-1、包装请求><a class=headerlink href=#1-1、包装请求 title=1.1、包装请求></a>1.1、包装请求</h2><p><strong>feign调用过程中会经过多个拦截器（RequestInterceptor），拦截器会对 feign 调用进行包装与增强</strong>。<h1 id=Feign调用问题><a class=headerlink href=#Feign调用问题 title=Feign调用问题></a>Feign调用问题</h1><h2 id=1-1、丢失请求头><a class=headerlink href=#1-1、丢失请求头 title=1.1、丢失请求头></a>1.1、丢失请求头</h2><h3 id=1-1-1、场景再现><a class=headerlink href=#1-1-1、场景再现 title=1.1.1、场景再现></a>1.1.1、场景再现</h3><p>以 服务1 调用 服务2为例。<ol><li>服务1调用服务2前，会先构建一个新请求，而这个新请求没有请求头。<li>没有请求头的请求到达服务2后，服务2以没有满足相关需求为由拒绝执行。</ol><h3 id=1-1-2、原因分析><a class=headerlink href=#1-1-2、原因分析 title=1.1.2、原因分析></a>1.1.2、原因分析</h3><p>feign调用会经过多个拦截器，这些拦截器会对请求进行包装与增强。<h3 id=1-1-3、解决方法><a class=headerlink href=#1-1-3、解决方法 title=1.1.3、解决方法></a>1.1.3、解决方法</h3><p>创建一个拦截器RequestInterceptor，在其 apply方法中编写添加请求头的逻辑。示例代码如下：<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br></pre><td class=code><pre><span class=line><span class=meta>@Configuration</span></span><br><span class=line><span class=keyword>public</span> <span class=keyword>class</span> <span class="title class_">GlFeignConfig</span> {</span><br><span class=line>	<span class=meta>@Bean("requestInterceptor")</span></span><br><span class=line>	<span class=keyword>public</span> RequestInterceptor <span class="title function_">requestInterceptor</span><span class=params>()</span>{</span><br><span class=line>		<span class=comment>// Feign在远程调用之前都会先经过这个方法</span></span><br><span class=line>		<span class=keyword>return</span> <span class=keyword>new</span> <span class="title class_">RequestInterceptor</span>() {</span><br><span class=line>			<span class=meta>@Override</span></span><br><span class=line>			<span class=keyword>public</span> <span class=keyword>void</span> <span class="title function_">apply</span><span class=params>(RequestTemplate template)</span> {</span><br><span class=line>				<span class=comment>// RequestContextHolder拿到刚进来这个请求</span></span><br><span class=line>				<span class=type>ServletRequestAttributes</span> <span class=variable>attributes</span> <span class=operator>=</span> (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();</span><br><span class=line>				<span class=keyword>if</span>(attributes != <span class=literal>null</span>){</span><br><span class=line>					<span class=type>HttpServletRequest</span> <span class=variable>request</span> <span class=operator>=</span> attributes.getRequest();</span><br><span class=line>					<span class=keyword>if</span>(request != <span class=literal>null</span>){</span><br><span class=line>						<span class=comment>// 同步请求头数据</span></span><br><span class=line>						<span class=type>String</span> <span class=variable>cookie</span> <span class=operator>=</span> request.getHeader(<span class=string>"Cookie"</span>);</span><br><span class=line>						<span class=comment>// 给新请求同步Cookie</span></span><br><span class=line>						template.header(<span class=string>"Cookie"</span>, cookie);</span><br><span class=line>					}</span><br><span class=line>				}</span><br><span class=line>			}</span><br><span class=line>		};</span><br><span class=line>	}</span><br><span class=line>}</span><br></pre></table></figure></div><footer class=post-footer><div class=post-eof></div></footer></article></div><div class=post-block><article class=post-content itemscope itemtype=http://schema.org/Article><link href=https://hshz21.gitee.io/2024/08/21/Eureka%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/ itemprop=mainEntityOfPage><span hidden itemprop=author itemscope itemtype=http://schema.org/Person> <meta content=/static/imgs/avatar.png itemprop=image> <meta content=豪哥 itemprop=name> </span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization> <meta content=豪哥博客 itemprop=name> <meta content=豪哥博客 itemprop=description> </span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork> <meta content="undefined | 豪哥博客" itemprop=name> <meta itemprop=description> </span><header class=post-header><h2 itemprop="name headline" class=post-title><a class=post-title-link href=/2024/08/21/Eureka%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/ itemprop=url>Eureka系列-Eureka基础应用</a></h2><div class=post-meta-container><div class=post-meta><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar"></i> </span> <span class=post-meta-item-text>发表于</span> <time itemprop="dateCreated datePublished" title="创建时间：2024-08-21 21:39:13" datetime=2024-08-21T21:39:13+08:00>2024-08-21</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar-check"></i> </span> <span class=post-meta-item-text>更新于</span> <time title="修改时间：2023-10-02 15:17:52" datetime=2023-10-02T15:17:52+08:00 itemprop=dateModified>2023-10-02</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-folder"></i> </span> <span class=post-meta-item-text>分类于</span> <span itemprop=about itemscope itemtype=http://schema.org/Thing> <a href=/categories/Eureka/ itemprop=url rel=index><span itemprop=name>Eureka</span></a> </span> </span></div></div></header><div class=post-body itemprop=articleBody><h1 id=1、注册中心搭建><a class=headerlink href=#1、注册中心搭建 title=1、注册中心搭建></a>1、注册中心搭建</h1><h2 id=1-1、添加依赖><a class=headerlink href=#1-1、添加依赖 title=1.1、添加依赖></a>1.1、添加依赖</h2><figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line><span class=tag><<span class=name>dependency</span>></span></span><br><span class=line>    <span class=tag><<span class=name>groupId</span>></span>org.springframework.cloud<span class=tag>&LT/<span class=name>groupId</span>></span></span><br><span class=line>    <span class=tag><<span class=name>artifactId</span>></span>spring-cloud-starter-netflix-eureka-server<span class=tag>&LT/<span class=name>artifactId</span>></span></span><br><span class=line><span class=tag>&LT/<span class=name>dependency</span>></span></span><br></pre></table></figure><h2 id=1-2、编写配置><a class=headerlink href=#1-2、编写配置 title=1.2、编写配置></a>1.2、编写配置</h2><figure class="highlight yml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br></pre><td class=code><pre><span class=line><span class=attr>server:</span></span><br><span class=line>  <span class=attr>port:</span> <span class=number>8070</span></span><br><span class=line></span><br><span class=line><span class=comment># registry-eureka server</span></span><br><span class=line><span class=attr>eureka:</span></span><br><span class=line>  <span class=attr>instance:</span></span><br><span class=line>    <span class=attr>hostname:</span> <span class=string>shhsca-registry-eureka</span></span><br><span class=line>  <span class=attr>client:</span></span><br><span class=line>    <span class=attr>register-with-eureka:</span> <span class=literal>false</span>  <span class=comment># false表示不将自己注入到注册中心</span></span><br><span class=line>    <span class=attr>fetch-registry:</span> <span class=literal>false</span>        <span class=comment># false表示自己就是服务中心</span></span><br><span class=line>    <span class=attr>service-url:</span></span><br><span class=line>      <span class=attr>defaultZone:</span> <span class=string>http://${eureka.instance.hostname}:${server.port}/eureka/</span></span><br><span class=line>  <span class=attr>server:</span></span><br><span class=line>    <span class=attr>enable-self-preservation:</span> <span class=literal>false</span>          <span class=comment># false表示关闭自我保护机制，保证不可用的服务会被及时删除(默认true)</span></span><br><span class=line>    <span class=attr>eviction-interval-timer-in-ms:</span> <span class=number>2000</span>      <span class=comment># 心跳时间(单位毫秒，默认0)</span></span><br><span class=line></span><br></pre></table></figure><h2 id=1-3、编写main方法><a class=headerlink href=#1-3、编写main方法 title=1.3、编写main方法></a>1.3、编写main方法</h2><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre><td class=code><pre><span class=line><span class=meta>@EnableEurekaServer</span></span><br><span class=line><span class=meta>@SpringBootApplication</span></span><br><span class=line><span class=keyword>public</span> <span class=keyword>class</span> <span class="title class_">EurekaRegistryServerApplication</span> {</span><br><span class=line>    <span class=keyword>public</span> <span class=keyword>static</span> <span class=keyword>void</span> <span class="title function_">main</span><span class=params>(String[] args)</span> {</span><br><span class=line>        SpringApplication.run(EurekaRegistryServerApplication.class, args);</span><br><span class=line>    }</span><br><span class=line>}</span><br></pre></table></figure><h1 id=2、注册服务><a class=headerlink href=#2、注册服务 title=2、注册服务></a>2、注册服务</h1><h2 id=2-1、添加依赖><a class=headerlink href=#2-1、添加依赖 title=2.1、添加依赖></a>2.1、添加依赖</h2><figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line><span class=tag><<span class=name>dependency</span>></span></span><br><span class=line>    <span class=tag><<span class=name>groupId</span>></span>org.springframework.cloud<span class=tag>&LT/<span class=name>groupId</span>></span></span><br><span class=line>    <span class=tag><<span class=name>artifactId</span>></span>spring-cloud-starter-netflix-eureka-client<span class=tag>&LT/<span class=name>artifactId</span>></span></span><br><span class=line><span class=tag>&LT/<span class=name>dependency</span>></span></span><br></pre></table></figure><h2 id=2-2、编写配置><a class=headerlink href=#2-2、编写配置 title=2.2、编写配置></a>2.2、编写配置</h2><figure class="highlight yml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br></pre><td class=code><pre><span class=line><span class=attr>server:</span></span><br><span class=line>  <span class=attr>port:</span> <span class=number>8071</span></span><br><span class=line></span><br><span class=line><span class=attr>spring:</span></span><br><span class=line>  <span class=attr>application:</span></span><br><span class=line>    <span class=attr>name:</span> <span class=string>shhsca-registry-eureka-provider</span></span><br><span class=line></span><br><span class=line><span class=comment># registry-eureka client</span></span><br><span class=line><span class=attr>eureka:</span></span><br><span class=line>  <span class=attr>instance:</span></span><br><span class=line>    <span class=attr>hostname:</span> <span class=number>127.0</span><span class=number>.0</span><span class=number>.1</span></span><br><span class=line>    <span class=attr>prefer-ip-address:</span> <span class=literal>true</span>                   <span class=comment># 访问路径可以显示IP</span></span><br><span class=line>    <span class=attr>lease-renewal-interval-in-seconds:</span> <span class=number>10</span>     <span class=comment># Eureka客户端发送心跳至服务端的时间间隔（单位秒，默认30秒）</span></span><br><span class=line>    <span class=attr>lease-expiration-duration-in-seconds:</span> <span class=number>30</span>  <span class=comment># Eureka服务端收到最后一次心跳后的等待时间上限，超过则删除该服务（单位秒，默认90秒）</span></span><br><span class=line>  <span class=attr>client:</span></span><br><span class=line>    <span class=attr>register-with-eureka:</span> <span class=literal>true</span>  <span class=comment># false表示不将自己注入到注册中心</span></span><br><span class=line>    <span class=attr>fetch-registry:</span> <span class=literal>true</span>        <span class=comment># false表示自己就是服务中心</span></span><br><span class=line>    <span class=attr>service-url:</span></span><br><span class=line>      <span class=attr>defaultZone:</span> <span class=string>http://localhost:8070/eureka/</span></span><br></pre></table></figure><h2 id=2-3、编写main方法><a class=headerlink href=#2-3、编写main方法 title=2.3、编写main方法></a>2.3、编写main方法</h2><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre><td class=code><pre><span class=line><span class=meta>@EnableEurekaClient</span></span><br><span class=line><span class=meta>@SpringBootApplication</span></span><br><span class=line><span class=keyword>public</span> <span class=keyword>class</span> <span class="title class_">EurekaRegistryProviderApplication</span> {</span><br><span class=line>    <span class=keyword>public</span> <span class=keyword>static</span> <span class=keyword>void</span> <span class="title function_">main</span><span class=params>(String[] args)</span> {</span><br><span class=line>        SpringApplication.run(EurekaRegistryProviderApplication.class, args);</span><br><span class=line>    }</span><br><span class=line>}</span><br></pre></table></figure></div><footer class=post-footer><div class=post-eof></div></footer></article></div><div class=post-block><article class=post-content itemscope itemtype=http://schema.org/Article><link href=https://hshz21.gitee.io/2024/08/21/Eureka%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/ itemprop=mainEntityOfPage><span hidden itemprop=author itemscope itemtype=http://schema.org/Person> <meta content=/static/imgs/avatar.png itemprop=image> <meta content=豪哥 itemprop=name> </span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization> <meta content=豪哥博客 itemprop=name> <meta content=豪哥博客 itemprop=description> </span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork> <meta content="undefined | 豪哥博客" itemprop=name> <meta itemprop=description> </span><header class=post-header><h2 itemprop="name headline" class=post-title><a class=post-title-link href=/2024/08/21/Eureka%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/ itemprop=url>Eureka系列-Eureka原理解析</a></h2><div class=post-meta-container><div class=post-meta><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar"></i> </span> <span class=post-meta-item-text>发表于</span> <time itemprop="dateCreated datePublished" title="创建时间：2024-08-21 21:39:13" datetime=2024-08-21T21:39:13+08:00>2024-08-21</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar-check"></i> </span> <span class=post-meta-item-text>更新于</span> <time title="修改时间：2023-09-23 20:36:01" datetime=2023-09-23T20:36:01+08:00 itemprop=dateModified>2023-09-23</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-folder"></i> </span> <span class=post-meta-item-text>分类于</span> <span itemprop=about itemscope itemtype=http://schema.org/Thing> <a href=/categories/Eureka/ itemprop=url rel=index><span itemprop=name>Eureka</span></a> </span> </span></div></div></header><div class=post-body itemprop=articleBody><h1 id=1、Eureka><a class=headerlink href=#1、Eureka title=1、Eureka></a>1、Eureka</h1><h2 id=1-1、Eureka底层原理><a class=headerlink href=#1-1、Eureka底层原理 title=1.1、Eureka底层原理></a>1.1、Eureka底层原理</h2><h3 id=1-1-1、服务注册><a class=headerlink href=#1-1-1、服务注册 title=1.1.1、服务注册></a>1.1.1、服务注册</h3><h4 id=1-1-1-1、注册时机><a class=headerlink href=#1-1-1-1、注册时机 title=1.1.1.1、注册时机></a>1.1.1.1、注册时机</h4><p>客户端 主动注册自己 的两种情况：<ol start=2><li>客户端刚启动时；<li>客户端 instance信息 发生变化时；</ol><h4 id=1-1-1-2、定时器注册><a class=headerlink href=#1-1-1-2、定时器注册 title=1.1.1.2、定时器注册></a>1.1.1.2、定时器注册</h4><p><code>com.netflix.discovery.DiscoveryClient</code>使用的<code>@Inject</code> //google guice 注入，遵循 JSR-330 规范。<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br></pre><td class=code><pre><span class=line><span class=keyword>private</span> <span class=keyword>void</span> <span class="title function_">initScheduledTasks</span><span class=params>()</span> {</span><br><span class=line>        <span class=type>int</span> renewalIntervalInSecs;</span><br><span class=line>        <span class=type>int</span> expBackOffBound;</span><br><span class=line>        <span class=keyword>if</span> (<span class=built_in>this</span>.clientConfig.shouldFetchRegistry()) {</span><br><span class=line>            renewalIntervalInSecs = <span class=built_in>this</span>.clientConfig.getRegistryFetchIntervalSeconds();</span><br><span class=line>            expBackOffBound = <span class=built_in>this</span>.clientConfig.getCacheRefreshExecutorExponentialBackOffBound();</span><br><span class=line>            <span class=built_in>this</span>.cacheRefreshTask = <span class=keyword>new</span> <span class="title class_">TimedSupervisorTask</span>(<span class=string>"cacheRefresh"</span>, <span class=built_in>this</span>.scheduler, <span class=built_in>this</span>.cacheRefreshExecutor, renewalIntervalInSecs, TimeUnit.SECONDS, expBackOffBound, <span class=keyword>new</span> <span class="title class_">DiscoveryClient</span>.CacheRefreshThread());</span><br><span class=line>            <span class=built_in>this</span>.scheduler.schedule(<span class=built_in>this</span>.cacheRefreshTask, (<span class=type>long</span>)renewalIntervalInSecs, TimeUnit.SECONDS);</span><br><span class=line>        }</span><br><span class=line></span><br><span class=line>        <span class=keyword>if</span> (<span class=built_in>this</span>.clientConfig.shouldRegisterWithEureka()) {</span><br><span class=line>            renewalIntervalInSecs = <span class=built_in>this</span>.instanceInfo.getLeaseInfo().getRenewalIntervalInSecs();</span><br><span class=line>            expBackOffBound = <span class=built_in>this</span>.clientConfig.getHeartbeatExecutorExponentialBackOffBound();</span><br><span class=line>            logger.info(<span class=string>"Starting heartbeat executor: renew interval is: {}"</span>, renewalIntervalInSecs);</span><br><span class=line>            <span class=built_in>this</span>.heartbeatTask = <span class=keyword>new</span> <span class="title class_">TimedSupervisorTask</span>(<span class=string>"heartbeat"</span>, <span class=built_in>this</span>.scheduler, <span class=built_in>this</span>.heartbeatExecutor, renewalIntervalInSecs, TimeUnit.SECONDS, expBackOffBound, <span class=keyword>new</span> <span class="title class_">DiscoveryClient</span>.HeartbeatThread());</span><br><span class=line>            <span class=built_in>this</span>.scheduler.schedule(<span class=built_in>this</span>.heartbeatTask, (<span class=type>long</span>)renewalIntervalInSecs, TimeUnit.SECONDS);</span><br><span class=line>            <span class=built_in>this</span>.instanceInfoReplicator = <span class=keyword>new</span> <span class="title class_">InstanceInfoReplicator</span>(<span class=built_in>this</span>, <span class=built_in>this</span>.instanceInfo, <span class=built_in>this</span>.clientConfig.getInstanceInfoReplicationIntervalSeconds(), <span class=number>2</span>);</span><br><span class=line>            <span class=built_in>this</span>.statusChangeListener = <span class=keyword>new</span> <span class="title class_">StatusChangeListener</span>() {</span><br><span class=line>                <span class=keyword>public</span> String <span class="title function_">getId</span><span class=params>()</span> {</span><br><span class=line>                    <span class=keyword>return</span> <span class=string>"statusChangeListener"</span>;</span><br><span class=line>                }</span><br><span class=line></span><br><span class=line>                <span class=keyword>public</span> <span class=keyword>void</span> <span class="title function_">notify</span><span class=params>(StatusChangeEvent statusChangeEvent)</span> {</span><br><span class=line>                    DiscoveryClient.logger.info(<span class=string>"Saw local status change event {}"</span>, statusChangeEvent);</span><br><span class=line>                    DiscoveryClient.<span class=built_in>this</span>.instanceInfoReplicator.onDemandUpdate();</span><br><span class=line>                }</span><br><span class=line>            };</span><br><span class=line>            <span class=keyword>if</span> (<span class=built_in>this</span>.clientConfig.shouldOnDemandUpdateStatusChange()) {</span><br><span class=line>                <span class=built_in>this</span>.applicationInfoManager.registerStatusChangeListener(<span class=built_in>this</span>.statusChangeListener);</span><br><span class=line>            }</span><br><span class=line></span><br><span class=line>            <span class=built_in>this</span>.instanceInfoReplicator.start(<span class=built_in>this</span>.clientConfig.getInitialInstanceInfoReplicationIntervalSeconds());</span><br><span class=line>        } <span class=keyword>else</span> {</span><br><span class=line>            logger.info(<span class=string>"Not registering with Eureka server per configuration"</span>);</span><br><span class=line>        }</span><br><span class=line>    }</span><br></pre></table></figure><p>DiscoverClient 构造函数 会调用<code>initScheduledTasks()</code>方法，该方法主要作用：<ol><li>开启 缓存刷新 定时器；<li>开启 心跳发送 定时器；<li>开启 实例状态 变更监听；<li>开启 应用状态 复制器；（开启一个定时线程，每40秒判断实例信息是否变更，如果有变更则重新注册）</ol><p><code>InstanceInfoReplicator</code>是一个服务注册任务， 有两个地方会执行该任务：<ol><li>定时线程 每40秒 执行 一次该任务；<li>当instance状态发生变更（除去DOWN这个状态）时，监听器statusChangeListener 会监听到并执行服务注册；</ol><h4 id=1-1-1-3、自动注册><a class=headerlink href=#1-1-1-3、自动注册 title=1.1.1.3、自动注册></a>1.1.1.3、自动注册</h4><p><strong>自动化配置类<code>EurekaClientAutoConfiguration</code>逻辑：实例化一个实现了接口SmartLifecycle 的 Bean，spring 容器加载完所有Bean之后 会执行被接口标识的类的start方法。</strong><h4 id=1-1-1-4、处理注册请求><a class=headerlink href=#1-1-1-4、处理注册请求 title=1.1.1.4、处理注册请求></a>1.1.1.4、处理注册请求</h4><p>程序入口：<code>com.netflix.eureka.resources.ApplicationResource.addInstance();</code> addInstance()方法调用链如下：<p><font color=orange><code>addInstance() ---> register() ---> PeerAwareInstanceRegistryImpl中的方法</code>。</font><p><font color=red>注意：Eureka-Server最终处理注册信息的任务会由 Lease对象 来负责。</font><p>与类Lease相关参数如下：<ul><li><font color=orange>DEFAULT_DURATION_IN_SECS</font>：租约过期时间，默认90秒；也就是说超过90秒没有发送心跳续约的实例将会被删除。<li><font color=orange>holder</font>：这个租约是属于谁的， 目前占用这个属性的是 instanceInfo，也就是客户端实例信息。<li><font color=orange>evictionTimestamp</font>： 租约过期时间，服务下线的时候，会更新这个时间戳；<li><font color=orange>registrationTimestamp</font>：租约注册时间；<li><font color=orange>serviceUpTimestamp</font>：服务启动时间 ；当客户端注册时且instanceInfo的status 为UP时，更新这个时间戳。<li><font color=orange>lastUpdateTimestamp</font>：最后更新时间；每次续约时会更新这个时间戳。<li><font color=orange>duration</font>：过期时间，毫秒单位。</ul><h4 id=1-1-1-5、重新注册><a class=headerlink href=#1-1-1-5、重新注册 title=1.1.1.5、重新注册></a>1.1.1.5、重新注册</h4><p>客户端会重新注册的三种情况：<ol><li>服务端 注册信息 不存在；<li>(客户端<code>lastDirtyTimestamp</code>) > (服务端实例 <code>lastDirtyTimestamp</code>) 时会认为服务端信息无效，需要重新发起注册请求；<li>服务端instance的<code>status = UNKNOW</code>时。（出现UNKNOW是因为deleteStatusOverride时存在传入UNKONW的可能性）</ol><h4 id=1-1-1-6、总结><a class=headerlink href=#1-1-1-6、总结 title=1.1.1.6、总结></a>1.1.1.6、总结</h4><p>eureka注册中心底层是一个hashmap，源码参考如下：<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line><span class=keyword>public</span> <span class=keyword>abstract</span> <span class=keyword>class</span> <span class="title class_">AbstractInstanceRegistry</span> <span class=keyword>implements</span> <span class="title class_">InstanceRegistry</span> {</span><br><span class=line>    <span class=keyword>private</span> <span class=keyword>final</span> ConcurrentHashMap&LTString, Map&LTString, Lease&LTInstanceInfo>>> registry</span><br><span class=line>            = <span class=keyword>new</span> <span class="title class_">ConcurrentHashMap</span>&LTString, Map&LTString, Lease&LTInstanceInfo>>>();</span><br><span class=line>    <span class=comment>// else fields and methods...</span></span><br><span class=line>}</span><br></pre></table></figure><p>根据源码分析如下：<ol><li><strong>Eureka Server的注册表直接基于内存，即在内存中维护一个数据结构。</strong><li><strong>各个服务的注册、服务下线、服务故障等变化都将更新并记录到注册表。</strong><li><strong>每个服务会每隔30秒从注册表拉取最新服务列表，而eureka server会直接返回有变化的注册表。</strong><li><strong>每个服务会每隔30秒发起心跳，也就是更新心跳时间。</strong></ol><blockquote><p>维护注册表、拉取注册表、更新心跳时间，全部发生在内存中！这是Eureka Server核心之一。</blockquote><h3 id=1-1-2、服务拉取><a class=headerlink href=#1-1-2、服务拉取 title=1.1.2、服务拉取></a>1.1.2、服务拉取</h3><h4 id=1-1-2-1、拉取方式><a class=headerlink href=#1-1-2-1、拉取方式 title=1.1.2.1、拉取方式></a>1.1.2.1、拉取方式</h4><ul><li><p><strong>启动时拉取</strong></p> <p>客户端 启动过程中 初始化DiscoverClient时，会主动全量获取一次注册信息。</p><li><p><strong>定时任务拉取</strong></p> <p>通过定时任务 每隔30秒 拉取一次注册表，拉取过程如下：</p> <ol><li>首先从缓存ReadOnlyCacheMap中查找注册表，若没有则执行第二步。<li>从缓存ReadWriteCacheMap中查找注册表，若没有则执行第三步。<li>从内存中获取实际的注册表数据。</ol></ul><h4 id=1-1-2-2、注册表数据更新><a class=headerlink href=#1-1-2-2、注册表数据更新 title=1.1.2.2、注册表数据更新></a>1.1.2.2、注册表数据更新</h4><ol><li><strong>注册表发生变化时会将最新数据更新到内存，同时清除缓存<code>ReadWriteCacheMap</code>中的数据。</strong>此过程不会影响<code>ReadOnlyCacheMap</code>继续提供服务。<li><strong>30秒内的每一个服务在拉取注册表时会直接读取<code>ReadOnlyCacheMap</code>。</strong><li><strong>30秒过后，当eureka server发现<code>ReadWriteCacheMap</code>被清空时，也会清空<code>ReadOnlyCacheMap</code>中的缓存。</strong><li><strong>当有服务拉取注册表时，会从内存中获取最新数据，同时填充更新各个缓存。</strong></ol><h4 id=1-1-2-3、多级缓存机制><a class=headerlink href=#1-1-2-3、多级缓存机制 title=1.1.2.3、多级缓存机制></a>1.1.2.3、多级缓存机制</h4><p><strong>Eureka Server为避免同时读写同一内存数据造成并发冲突问题，会通过 <font color=orange>多级缓存机制</font> 来提高请求响应速度。</strong><p>多级缓存优点：<ol><li>避免了内存注册表频繁读写冲突问题；<li>基于内存，性能很高；</ol><h4 id=1-1-2-4、增量全量拉取><a class=headerlink href=#1-1-2-4、增量全量拉取 title=1.1.2.4、增量全量拉取></a>1.1.2.4、增量全量拉取</h4><ul><li>增量获取<ol><li>clientConfig.shouldDisableDelta()为false时；<li>clientConfig.getRegistryRefreshSingleVipAddress()为空时；<li>forceFullRegistryFetch为false时；</ol><li>全量获取<ol><li>clientConfig.shouldDisableDelta()为true时；<li>clientConfig.getRegistryRefreshSingleVipAddress()非空时；<li>forceFullRegistryFetch为true时；<li>applications表示本地注册信息的缓存，如果本地缓存为空，或者里面的版本号为-1，那么就需要全量获取；</ol></ul><p>onCacheRefreshed() : 发布缓存刷新事件，用户可以自定义是否监听这个事件，比如需要将注册信息的变化落库。<h4 id=1-1-2-5、注意事项><a class=headerlink href=#1-1-2-5、注意事项 title=1.1.2.5、注意事项></a>1.1.2.5、注意事项</h4><ol><li><font color=red>注册列表信息不能及时匹配时，Eureka Client 会重新获取整个注册表信息。 </font><li><font color=red>整个注册表以及每个应用程序的信息进行了压缩，压缩内容和没有压缩的内容完全相同。</font><li><font color=red>Eureka Client 和 Eureka Server 可以使用 JSON/XML格式 进行通讯。Eureka Client 默认使用 压缩JSON格式来获取注册列表信息。</font></ol><h4 id=1-1-2-6、重要参数><a class=headerlink href=#1-1-2-6、重要参数 title=1.1.2.6、重要参数></a>1.1.2.6、重要参数</h4><ul><li><p><font color=orange>eureka.client.fetch-registry=true</font>：开启 服务消费者从注册中心拉取服务列表的 功能。</p><li><p><font color=orange>eureka.client.registry-fetch-interval-seconds=30</font>：服务消费者从注册中心拉取服务列表的时间间隔（单位：秒）。</p></ul><h3 id=1-1-3、服务续约><a class=headerlink href=#1-1-3、服务续约 title=1.1.3、服务续约></a>1.1.3、服务续约</h3><h4 id=1-1-3-1、简介><a class=headerlink href=#1-1-3-1、简介 title=1.1.3.1、简介></a>1.1.3.1、简介</h4><p><font color=orange>Eureka Client 每隔 30 秒会发送一次心跳来续约。</font>告知自己状态良好。<h4 id=1-1-3-2、重要参数><a class=headerlink href=#1-1-3-2、重要参数 title=1.1.3.2、重要参数></a>1.1.3.2、重要参数</h4><ul><li><font color=orange>eureka.instance.lease-renewal-interval-in-seconds=30</font>：服务续约任务的调用间隔时间，默认为30秒。</ul><h3 id=1-1-4、服务删除><a class=headerlink href=#1-1-4、服务删除 title=1.1.4、服务删除></a>1.1.4、服务删除</h3><h4 id=1-1-4-1、简介><a class=headerlink href=#1-1-4-1、简介 title=1.1.4.1、简介></a>1.1.4.1、简介</h4><p><strong>Eureka Server启动完成后会初始化一个清理过期实例的线程，该线程每60秒执行一次清理任务。</strong><p><strong>默认情况下，Eureka Client 超过 90 秒没有续约 就会被删除。</strong><h4 id=1-1-4-2、重要参数><a class=headerlink href=#1-1-4-2、重要参数 title=1.1.4.2、重要参数></a>1.1.4.2、重要参数</h4><ul><li>eureka.instance.lease-expiration-duration-in-seconds=90：心跳超时时间，默认为90秒。（没有开启自我保护机制时过期实例会被删除）</ul><h3 id=1-1-5、服务下线><a class=headerlink href=#1-1-5、服务下线 title=1.1.5、服务下线></a>1.1.5、服务下线</h3><h4 id=1-1-5-1、主动下线><a class=headerlink href=#1-1-5-1、主动下线 title=1.1.5.1、主动下线></a>1.1.5.1、主动下线</h4><p><strong>程序关闭时 Eureka Client 会向 Eureka Server 发送下线请求，Eureka Server 会从注册表中删除该实例信息。</strong><p>主动下线过程如下：<ol><li>从本地的CurrentHashMap中获取当前appName对应的的Map信息；<li>通过机器ID，获取要下线的机器对应的Lease；<li>修改Lease的evictionTimestamp ， 也就是设置下线时间为当前时间点；</ol><h4 id=1-1-5-2、状态变更><a class=headerlink href=#1-1-5-2、状态变更 title=1.1.5.2、状态变更></a>1.1.5.2、状态变更</h4><p>状态类型共有5种，分类如下：<ul><li>STARTING：服务正在启动中；<li>UP：服务正在运行；<li>DOWN：服务已经宕机，无法继续提供服务；<li>OUT_OF_SERVICE：不再提供服务，其它Eureka Client无法再调用该服务；（强制下线时可考虑设置该状态。）<li>UNKNOW：未知状态；</ul><p>状态变更分析如下：<ol><li>容器刚启动且实例化instance信息时，默认状态为STARTING；<li>初始化ApplicationInfoManager时会设置一个最初Instance信息，此时的instance信息的状态为STARTING；<li>自动注册类 初始化时会设置Instance状态为UP，同时触发监听器，让Eureka Client发起注册；</ol><h3 id=1-1-6、远程调用><a class=headerlink href=#1-1-6、远程调用 title=1.1.6、远程调用></a>1.1.6、远程调用</h3><p><strong>Eureka Client 获取到服务提供者信息后，可通过 HTTP 请求来调用对应服务；当服务提供者有多个时会通过 Ribbon 负载均衡来挑选一个。</strong><h3 id=1-1-7、自我保护机制><a class=headerlink href=#1-1-7、自我保护机制 title=1.1.7、自我保护机制></a>1.1.7、自我保护机制</h3><h4 id=1-1-7-1、简介><a class=headerlink href=#1-1-7-1、简介 title=1.1.7.1、简介></a>1.1.7.1、简介</h4><p>固定时间内大量实例被注销，可能会严重威胁整个微服务架构的可用性。为解决该问题提出了 自我保护机制。<p><strong>Eureka 自我保护机制是为了防止误杀服务而提供的一个机制。当存在大量心跳超时情况时，会进入自我保护机制；当客户端心跳恢复时，Eureka 会自动退出自我保护机制。</strong><h4 id=1-1-7-2、自我保护机制功能><a class=headerlink href=#1-1-7-2、自我保护机制功能 title=1.1.7.2、自我保护机制功能></a>1.1.7.2、自我保护机制功能</h4><p>Eureka Server 进入自我保护机制，会出现以下几种情况：<ol><li>Eureka不再直接移除长时间没有发送心跳 的服务；<li>让长时间没有发送心跳的服务继续对外提供服务；（保证可用性）<li>当网络稳定时，当前实例新的注册信息会被同步到其它节点；（保证最终一致性）</ol><h4 id=1-1-7-3、开启自我保护机制><a class=headerlink href=#1-1-7-3、开启自我保护机制 title=1.1.7.3、开启自我保护机制></a>1.1.7.3、开启自我保护机制</h4><p>相关源码如下：<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre><td class=code><pre><span class=line><span class=meta>@Override</span></span><br><span class=line><span class=keyword>public</span> <span class=type>boolean</span> <span class="title function_">isLeaseExpirationEnabled</span><span class=params>()</span> {</span><br><span class=line>    <span class=comment>// 是否开启自我保护机制，这是个配置，默认为true</span></span><br><span class=line>    <span class=keyword>if</span> (!isSelfPreservationModeEnabled()) {</span><br><span class=line>        <span class=keyword>return</span> <span class=literal>true</span>;</span><br><span class=line>    }</span><br><span class=line>    <span class=comment>// 计算是否需要自我保护</span></span><br><span class=line>    <span class=keyword>return</span> numberOfRenewsPerMinThreshold > <span class=number>0</span> && getNumOfRenewsInLastMin() > numberOfRenewsPerMinThreshold;</span><br><span class=line>}</span><br></pre></table></figure><p>getNumOfRenewInLastMin()方法返回的是每分钟续约数量（每个客户端续约时都会更新这个值，每分钟重置一次，会有一个线程专门去执行累加操作）。<strong>如果 每分钟的续约数量>最小续约数，则不需要开启自我保护机制， 如果是小于则需要开启， 所以当返回false的时就需要开启自我保护机制。</strong><p>自我保护模式被激活的条件是：<strong>1 分钟后满足 (Eureka Server 最后 1 分钟收到客户端实例续约的总数) < (Eureka Server 期望每分钟收到客户端实例续约的总数)。</strong><h4 id=1-1-7-4、关闭自我保护机制><a class=headerlink href=#1-1-7-4、关闭自我保护机制 title=1.1.7.4、关闭自我保护机制></a>1.1.7.4、关闭自我保护机制</h4><p>自我保护机制的关闭和解除方式如下：<ol><li>当服务的网络分区解除之后，客户端在续约时会更新每分钟的续约数，<strong>每分钟的续约数大于85%时就自动解除</strong>。<li>重启服务。</ol><h4 id=1-1-7-5、注意事项><a class=headerlink href=#1-1-7-5、注意事项 title=1.1.7.5、注意事项></a>1.1.7.5、注意事项</h4><ol><li>如果在保护期内刚好这个服务提供者非正常下线了，需要服务消费者端有一些容错机制，如重试，断路器等。<li>Eureka Server过期时间默认60s，客户端续约时间间隔默认30s，修改该配置可能会打破自我保护机制的规则。</ol><h4 id=1-1-7-6、重要参数><a class=headerlink href=#1-1-7-6、重要参数 title=1.1.7.6、重要参数></a>1.1.7.6、重要参数</h4><ul><li>eureka.server.enable-self-preservation=true：是否开启自我保护机制，true表示开启，false表示关闭。</ul><h3 id=1-1-8、Eureka集群><a class=headerlink href=#1-1-8、Eureka集群 title=1.1.8、Eureka集群></a>1.1.8、Eureka集群</h3><h4 id=1-1-8-1、集群工作原理><a class=headerlink href=#1-1-8-1、集群工作原理 title=1.1.8.1、集群工作原理></a>1.1.8.1、集群工作原理</h4><p>eureka集群架构图示例如下：<p><img alt=img src=https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/07/Eureka-%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86-%E9%9B%86%E7%BE%A4%E6%9E%B6%E6%9E%84%E5%9B%BE.jpg><p>Eureka Server 集群间通过 Replicate 来同步数据，不区分主节点和从节点。通过节点间互相注册来提高可用性，每个节点需要添加一个或多个有效的 serviceUrl 指向其他节点。<p>某个Eureka Server宕机时Eureka Client 请求会切换到新的 Eureka Server 节点。当宕机的节点恢复后会被纳入到服务器集群管理之中。当节点开始接受客户端请求时，所有的操作都会进行节点间复制，将请求复制到其它当前可知的所有 Eureka Server 节点中。<p><strong>Eureka Server 同步遵循一个原则：节点间可以形成通路 就可以实现共享信息。多个 Eureka Server 之间通过 P2P 方式完成服务注册表的同步。</strong><p><strong>Eureka Server 集群采用异步方式来同步状态，所以不保证节点间的状态能达到实时一致性，但能保证最终一致性。</strong><h4 id=1-1-8-2、Eureka分区><a class=headerlink href=#1-1-8-2、Eureka分区 title=1.1.8.2、Eureka分区></a>1.1.8.2、Eureka分区</h4><p>Eureka 提供了 Region 和 Zone 两个概念来进行分区，这两个概念来自于亚马逊的 AWS：<ul><li><p><font color=orange>region</font></p> <p>可以理解为【不同地理区域】，比如亚洲地区，中国区或者深圳等等。没有具体大小的限制。根据项目具体的情况，可以自行合理划分 region。</p><li><p><font color=orange>zone</font></p> <p>可以简单理解为 region 内的【具体机房】，比如将 region 划分为深圳，深圳有两个机房，那么就可以在此 region 之下划分出 zone1、zone2 两个 zone。</p></ul><p>上图中的 us-east-1c、us-east-1d、us-east-1e 就代表了不同的 Zone。Zone 内的 Eureka Client 优先和 Zone 内的 Eureka Server 进行心跳同步，同样调用端优先在 Zone 内的 Eureka Server 获取服务列表，当 Zone 内的 Eureka Server 挂掉之后，才会从别的 Zone 中获取信息。<h4 id=1-1-8-3、AP原则><a class=headerlink href=#1-1-8-3、AP原则 title=1.1.8.3、AP原则></a>1.1.8.3、AP原则</h4><p>Eureka Server 各个节点都是平等的，几个节点挂掉不会影响正常节点的工作，剩余的节点依然可以提供注册和查询服务。而 Eureka Client 在向某个 Eureka 注册时，如果发现连接失败，则会自动切换至其它节点。<strong>只要有一个 Eureka Server 存在就能保证注册服务可用，但不保证信息最新。</strong><h4 id=1-1-8-4、集群同步><a class=headerlink href=#1-1-8-4、集群同步 title=1.1.8.4、集群同步></a>1.1.8.4、集群同步</h4><p><strong>Eureka Server 收到来自客户端的注册、下线、心跳请求时，会将操作同步给相邻的集群节点。</strong><ol><li>同步操作采用异步方式，Eureka Server构建同步信息的任务，放入线程池，供线程异步来执行，默认是批量同步，即线程会一次性从队列里面取走所有数据进行同步， 如果相邻Eureka Server Node不可用时会进行重试，超出过期时间会放弃该同步任务。过期时间默认为30秒。<li>通过HTTP方式发送请求给其他Eureka Server，比如：register， Eureka Server收到其他节点的批量同步注册请求时会调用本地的register方法，跟客户端注册走的流程一直，只不过方法参数isReplication = true如此，带有isReplication = true参数的请求不会同步给其他节点，避免了循环同步。</ol><h3 id=1-1-9、Eureka工作流程><a class=headerlink href=#1-1-9、Eureka工作流程 title=1.1.9、Eureka工作流程></a>1.1.9、Eureka工作流程</h3><p>Eureka 工作流程 分析如下：<ol><li>Eureka Server 启动成功，等待服务端注册。如果是集群模式，那么启动过程中集群之间会通过 Replicate 同步注册表信息。<li>Eureka Client 启动时会注册服务到注册中心。<li>Eureka Client 每隔 30s 会发送一次心跳到Eureka Server端，告知状态良好。<li>Eureka Server 90s 内没有收到 Eureka Client 心跳续约时，会删除该实例。（没有开启自我保护机制）<li>如果大量Eureka Client 在90s内没有发送心跳，eureka server会进入自我保护机制，且不再删除长时间没有发送心跳的客户端。<li>Eureka Client 心跳请求恢复正常后，Eureka Server 会自动退出自我保护模式。<li>Eureka Client 定时全量 或 增量 从注册中心获取服务注册表，并且将这些信息缓存到本地。<li>服务调用时，Eureka Client 会先从本地缓存查找需要调用的服务。如果本地缓存不存在，则会从注册中心拉取然后同步到本地缓存。<li>Eureka Client 获取到目标服务器信息后发起服务调用。<li>程序关闭时 Client 会向 Server 发送下线请求，然后该实例信息会从注册表中被删除。</ol><h2 id=1-2、常见问题><a class=headerlink href=#1-2、常见问题 title=1.2、常见问题></a>1.2、常见问题</h2><h3 id=1-2-1、Eureka-Client刚启动是否会立即注册？><a title="1.2.1、Eureka Client刚启动是否会立即注册？" class=headerlink href=#1-2-1、Eureka-Client刚启动是否会立即注册？></a>1.2.1、Eureka Client刚启动是否会立即注册？</h3><p><strong>client端启动之后会立马向服务端发起注册。</strong><h3 id=1-2-2、Eureka-Server集群宕机后，客户端是否可用？><a title="1.2.2、Eureka Server集群宕机后，客户端是否可用？" class=headerlink href=#1-2-2、Eureka-Server集群宕机后，客户端是否可用？></a>1.2.2、Eureka Server集群宕机后，客户端是否可用？</h3><ul><li><p>场景一</p> <p>Eureka Client 启动时会主动全量从服务端获取一次注册信息，如果此时Eureka Server集群已经宕机，那么Eureka Client端将不可用。</p><li><p>场景二</p> <p>如果Eureka Client 启动时会全量获取注册信息并缓存至本地之后 Eureka Server 集群发生宕机，Eureka Client也可以继续对外提供服务。唯一不足的是后续无法获取最新注册信息。</p></ul><h3 id=1-2-3、时间间隔记录><a class=headerlink href=#1-2-3、时间间隔记录 title=1.2.3、时间间隔记录></a>1.2.3、时间间隔记录</h3><ul><li>Eureka Client<ul><li><strong>拉取服务信息并更新：默认30秒；</strong><li><strong>发送心跳：默认30秒；</strong><li><strong>检查应用是否变化，若变化则重新发起注册：默认30秒；</strong></ul><li>Eureka Server<ul><li><strong>只读缓存过期时间：默认30秒；</strong><li><strong>启动时同步节点数据的等待时间：默认30秒；</strong><li><strong>清空每分钟续约次数间隔：默认60秒；</strong><li><strong>清理过期任务：默认60秒；</strong><li><strong>租约过期时间：默认90秒；</strong><li><strong>读写缓存过期时间：默认180秒；</strong></ul></ul><h3 id=1-2-4、Eureka-Client-90秒没有发送心跳，一定会过期吗？><a title="1.2.4、Eureka Client 90秒没有发送心跳，一定会过期吗？" class=headerlink href=#1-2-4、Eureka-Client-90秒没有发送心跳，一定会过期吗？></a>1.2.4、Eureka Client 90秒没有发送心跳，一定会过期吗？</h3><ul><li><p>场景一</p> <p>自我保护模式开启时 将不会被清除；</p><li><p>场景二</p> <p>Eureka Server中租约过期时间默认90秒，服务端维护了一个变量<code>lastUpdaeTimestap</code>，其表示最后修改时间。</p> <p>最后修改时间的更新逻辑是：当前时间+90秒，最终判断是否过期，源码如下：</p> <figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line><span class=keyword>public</span> <span class=type>boolean</span> <span class="title function_">isExpired</span><span class=params>(<span class=type>long</span> additionalLeaseMs)</span> {</span><br><span class=line>    <span class=keyword>return</span> (evictionTimestamp > <span class=number>0</span> || System.currentTimeMillis() > (lastUpdateTimestamp + duration + additionalLeaseMs));</span><br><span class=line>}</span><br></pre></table></figure> <p>代码变量解析如下：</p> <ul><li>evictionTimestamp： 表示 下线时间，下线操作时会更新这个值。</ul> <p><strong>综上可知：最后修改时间 在续约时已经加了90秒，这里再加90秒就是180秒，所以，当前时间大于(最后修改时间+90秒)时才能判定为过期。</strong></p></ul><h1 id=2、Nacos><a class=headerlink href=#2、Nacos title=2、Nacos></a>2、Nacos</h1><p>Nacos注册中心实现原理图参考如下：<p><img alt=img src=https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/07/Eureka-%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86-Nacos%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E5%8E%9F%E7%90%86%E5%9B%BE.jpg><p>Nacos 中的服务注册方式是通过 轮询 注册中心集群节点地址来进行服务注册，Nacos Server 接收到 服务注册请求 后会通过Map来保存注册的服务信息，如果配置了持久化则会被保存到数据库中。<p><strong>服务消费者会采用 Pull 和 Push 两种方式同时运作。</strong><h2 id=2-1、服务注册><a class=headerlink href=#2-1、服务注册 title=2.1、服务注册></a>2.1、服务注册</h2><h3 id=2-1-1、简介><a class=headerlink href=#2-1-1、简介 title=2.1.1、简介></a>2.1.1、简介</h3><p>注册服务分两步：<ol><li>将 服务信息 注册到 服务端；<li>向服务端 发送 心跳包，这两个操作都是通过 NamingProxy 和服务端进行数据交互。</ol><h3 id=2-1-2、服务注册流程><a class=headerlink href=#2-1-2、服务注册流程 title=2.1.2、服务注册流程></a>2.1.2、服务注册流程</h3><p>Dubbo服务发布 是通过【事件监听机制】完成。当springboot应用启动完成后会发布 <code>ApplicationStartedEvent</code> 事件，而Dubbo类<code>DubboServiceRegistrationNonWebApplicationAutoConfiguration</code>会监听该事件，当监听到该事件时会立即触发 服务注册操作。相关源码如下：<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br></pre><td class=code><pre><span class=line><span class=meta>@EventListener(ApplicationStartedEvent.class)</span></span><br><span class=line><span class=keyword>public</span> <span class=keyword>void</span> <span class="title function_">onApplicationStarted</span><span class=params>()</span> {</span><br><span class=line>    setServerPort();</span><br><span class=line>    register();</span><br><span class=line>}</span><br><span class=line></span><br><span class=line><span class=keyword>private</span> <span class=keyword>void</span> <span class="title function_">register</span><span class=params>()</span> {</span><br><span class=line>    <span class=keyword>if</span> (registered) {</span><br><span class=line>        <span class=keyword>return</span>;</span><br><span class=line>    }</span><br><span class=line>    serviceRegistry.register(registration);  <span class=comment>//这里注入的应该是 NacosServiceRegistry</span></span><br><span class=line>    registered = <span class=literal>true</span>;</span><br><span class=line>}</span><br></pre></table></figure><p>服务注册流程参考如下：<ol><li><p>调用 NacosServiceRegistry.register() 方法发起服务注册请求</p> <ol><li>调用NacosNamingService.registerInstance(serviceId, group, instance)方法；<ol><li>调用this.beatReactor.addBeatInfo(groupedServiceName, beatInfo)方法；<ol><li>调用this.executorService.schedule(new BeatReactor.BeatTask(beatInfo), beatInfo.getPeriod(), TimeUnit.MILLISECONDS)方法。</ol><li>调用this.serverProxy.registerService(groupedServiceName, groupName, instance)方法；<ol><li>调用NamingProxy.registerService(groupedServiceName, groupName, instance)方法，拼接请求参数并发起注册服务的POST请求。</ol></ol></ol><li><p>Nacos服务端处理</p> <p>服务端提供了一个InstanceController类，服务端消费者发起注册服务请求时，调用的接口是： <code>[post]: /nacos/v1/ns/instance</code> ，<code>serviceName</code>代表客户端的项目名称 ，<code>namespace</code>代表nacos 的namespace。</p> <p>Nacos通过不同的 namespace 来维护服务，每个namespace下有不同的group，不同的group下才有对应的Service ，然后通过这个 serviceName 来确定服务实例。</p> <p>第一次进来则会进入初始化，初始化完会调用 putServiceAndInit，获取到服务以后把服务实例添加到集合中，然后基于一致性协议进行数据同步。然后调用 addInstance，然后返回注册成功响应。</p></ol><h2 id=2-2、服务发现><a class=headerlink href=#2-2、服务发现 title=2.2、服务发现></a>2.2、服务发现</h2><h3 id=2-2-1、简介><a class=headerlink href=#2-2-1、简介 title=2.2.1、简介></a>2.2.1、简介</h3><p>服务成功注册到注册中心后，消费者就可以获取可用服务。服务发现分两种：<ul><li>第一种：消费者向注册中心发起获取服务实例的请求，注册中心 会返回 所有可用服务实例。一般不推荐这种情况。<li>第二种：消费者从注册中心订阅某个服务，并通过 监听器 来监听服务状态信息，当被监听的服务实例发生变化时 消费者会更新本地服务实例列表，以保证所有服务可用。</ul><p>服务发现 分两步：<ol><li>不断查询 服务端可用服务实例的 定时任务；<li>不断从已变服务队列中取出服务 并通知 EventListener 持有者的 定时任务；</ol><h3 id=2-2-2、注意事项><a class=headerlink href=#2-2-2、注意事项 title=2.2.2、注意事项></a>2.2.2、注意事项</h3><p><strong>客户端会将获取到的服务实例保存在map中，map中的内容由调度任务定时更新，故会存在延时。</strong><h2 id=2-3、负载均衡><a class=headerlink href=#2-3、负载均衡 title=2.3、负载均衡></a>2.3、负载均衡</h2><h3 id=2-3-1、简介><a class=headerlink href=#2-3-1、简介 title=2.3.1、简介></a>2.3.1、简介</h3><p><strong>负载均衡有多种，可分为 服务端负载均衡 和 客户端负载均衡。</strong><p>Nacos客户端获取到服务列表后，会通过负载均衡算法从列表中选出一个可用实例，算法默认是【随机获取】。<h1 id=3、Zookeeper><a class=headerlink href=#3、Zookeeper title=3、Zookeeper></a>3、Zookeeper</h1><h2 id=3-1、服务注册><a class=headerlink href=#3-1、服务注册 title=3.1、服务注册></a>3.1、服务注册</h2><p>服务提供者 启动时 会注册服务信息到Zookeeper服务端，即会在Zookeeper服务器上创建一个服务节点，并在节点上存储服务的相关数据（如服务提供者的ip地址、端口等）。<h2 id=3-2、服务发现><a class=headerlink href=#3-2、服务发现 title=3.2、服务发现></a>3.2、服务发现</h2><p>服务消费者 启动时 会根据自身依赖的服务信息 向Zookeeper获取可用的服务提供者并设置Watch，后会将服务提供者信息缓存在本地，调用服务时直接从Zookeeper注册中心获取一个服务进行调用。<h2 id=3-3、服务通知><a class=headerlink href=#3-3、服务通知 title=3.3、服务通知></a>3.3、服务通知</h2><p>服务提供者 因某种原因宕机 或 不提供服务时，Zookeeper中对应的服务节点会被删除，同时Zookeeper会异步向所有关联的 服务消费者 发出 节点删除通知，服务消费者 收到通知后 更新本地缓存。<h1 id=注册中心对比><a class=headerlink href=#注册中心对比 title=注册中心对比></a>注册中心对比</h1><h2 id=1、Eureka、Nacos、Consul之间的区别><a class=headerlink href=#1、Eureka、Nacos、Consul之间的区别 title=1、Eureka、Nacos、Consul之间的区别></a>1、Eureka、Nacos、Consul之间的区别</h2><p>（1）版本迭代<ul><li>eureka：目前停止维护升级。<li>nacos：依然在升级迭代。<li>consul：依然在升级迭代。</ul><p>（2）ACP原则<ul><li><p>eureka：遵循AP原则（可用性+分离容忍），有较强的可用性，服务注册快，但牺牲了一致性。</p><li><p>nacos：遵循CP原则（一致性+分离容忍） 和AP原则（可用性+分离容忍）。</p><li><p>consul：遵循CP原则（一致性+分离容忍），服务注册慢，一致性会导致Leader挂掉后重新选举，选举期间整个consul不可用。</p></ul><p>（3）访问协议<ul><li>eureka：HTTP。<li>nacos：HTTP / 动态DNS / UDP。<li>consul：HTTP / DNS。</ul><p>（4）集成支持<ul><li>eureka：只支持SpringCloud集成。<li>nacos：支持Dubbo 、SpringCloud、K8S集成。<li>consul：支持SpringCloud、K8S集成。</ul><p>（5）应用内外<ul><li><p>eureka：直接集成到应用中，依赖于应用自身完成服务的注册与发现。</p><li><p>nacos：属于外部应用，侵入性小。</p><li><p>consul：属于外部应用，侵入性小。</p></ul><p>（6）雪崩保护<ul><li>eureka：支持雪崩保护。<li>nacos：支持雪崩保护。<li>consul：不支持雪崩保护。</ul><p>（7）配置中心<ul><li>eureka：不支持。<li>nacos：支持，使用简单，springBoot命名风格，支持动态刷新。<li>consul：支持，使用偏麻烦，不太符合springBoot命名风格，支持动态刷新。</ul><p>（8）自我保护方式和范围<ul><li><p>eureka</p> <p>保护方式：当在短时间内，统计续约失败的比例，如果达到一定阈值，则会触发自我保护的机制，在该机制下，Eureka Server不会剔除任何的微服务，等到正常后，再退出自我保护机制。自我保护开关(eureka.server.enable-self-preservation: false)</p> <p>保护范围：针对所有服务。</p><li><p>nacos</p> <p>保护方式：当健康实例 (Instance) 占服务总实例数量的比例小于阈值时，无论实例 (Instance) 是否健康，都会将这个实例 (Instance) 返回给客户端。虽然损失了部分流量，但保证了集群中剩余的健康实例 (Instance) 能正常工作。</p> <p>保护范围：针对某个具体 Service，而不是针对所有服务。</p></ul></div><footer class=post-footer><div class=post-eof></div></footer></article></div><div class=post-block><article class=post-content itemscope itemtype=http://schema.org/Article><link href=https://hshz21.gitee.io/2024/08/21/ElasticSearch%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8/ itemprop=mainEntityOfPage><span hidden itemprop=author itemscope itemtype=http://schema.org/Person> <meta content=/static/imgs/avatar.png itemprop=image> <meta content=豪哥 itemprop=name> </span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization> <meta content=豪哥博客 itemprop=name> <meta content=豪哥博客 itemprop=description> </span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork> <meta content="undefined | 豪哥博客" itemprop=name> <meta itemprop=description> </span><header class=post-header><h2 itemprop="name headline" class=post-title><a class=post-title-link href=/2024/08/21/ElasticSearch%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8/ itemprop=url>ElasticSearch系列-ElasticSearch基础应用</a></h2><div class=post-meta-container><div class=post-meta><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar"></i> </span> <span class=post-meta-item-text>发表于</span> <time itemprop="dateCreated datePublished" title="创建时间：2024-08-21 21:39:13" datetime=2024-08-21T21:39:13+08:00>2024-08-21</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar-check"></i> </span> <span class=post-meta-item-text>更新于</span> <time title="修改时间：2023-10-02 11:06:07" datetime=2023-10-02T11:06:07+08:00 itemprop=dateModified>2023-10-02</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-folder"></i> </span> <span class=post-meta-item-text>分类于</span> <span itemprop=about itemscope itemtype=http://schema.org/Thing> <a href=/categories/ElasticSearch/ itemprop=url rel=index><span itemprop=name>ElasticSearch</span></a> </span> </span></div></div></header><div class=post-body itemprop=articleBody><h1 id=1、ES概述><a class=headerlink href=#1、ES概述 title=1、ES概述></a>1、ES概述</h1><h2 id=1-1、何为ES><a class=headerlink href=#1-1、何为ES title=1.1、何为ES></a>1.1、何为ES</h2><p><strong>Elaticsearch，简称为es，es是一个开源的高扩展的分布式全文检索引擎</strong>，它可以近乎实时的存储、检索数据；本身扩展性很好，可以扩展到上百台服务器，处理PB级别数据。es也使用Java开发并使用Lucene作为其核心 来 实现 所有索引和搜索功能，但是它的目的是通过简单的RESTful API来隐藏Lucene复杂性，从而让全文搜索变得简单。<h2 id=1-2、使用案例><a class=headerlink href=#1-2、使用案例 title=1.2、使用案例></a>1.2、使用案例</h2><ul><li>2013年初，GitHub抛弃了Solr，采取ElasticSearch 来做PB级的搜索。 “GitHub使用ElasticSearch搜索20TB 的数据，包括13亿文件和1300亿行代码”。<li>维基百科：启动以elasticsearch为基础的核心搜索架构。<li>SoundCloud：“SoundCloud使用ElasticSearch为1.8亿用户提供即时而精准的音乐搜索服务”。<li>百度：百度目前广泛使用ElasticSearch作为文本数据分析，采集百度所有服务器上的各类指标数据及用户自定义数据，通过对各种数据进行多维分析展示，辅助定位分析实例异常或业务层面异常。目前覆盖百度内部 20多个业务线（包括casio、云分析、网盟、预测、文库、直达号、钱包、风控等），单集群最大100台机器，200个ES节点，每天导入30TB+数据。<li>新浪使用ES 分析处理32亿条实时日志。<li>阿里使用ES 构建挖财自己的日志采集和分析体系。</ul><h2 id=1-3、ES对比Solr><a class=headerlink href=#1-3、ES对比Solr title=1.3、ES对比Solr></a>1.3、ES对比Solr</h2><ol><li>Solr 利用 Zookeeper 进行分布式管理，而 Elasticsearch 自身带有分布式协调管理功能;<li>Solr 支持更多格式的数据，而 Elasticsearch 仅支持json文件格式；<li>Solr 官方提供的功能更多，而 Elasticsearch 本身更注重于核心功能，高级功能多有第三方插件提供；<li>Solr 在传统的搜索应用中表现好于 Elasticsearch，但在处理实时搜索应用时效率明显低于 Elasticsearch。</ol><h2 id=1-4、重要概念><a class=headerlink href=#1-4、重要概念 title=1.4、重要概念></a>1.4、重要概念</h2><p><strong>Elasticsearch是面向文档(document oriented)的</strong>，这意味着它可以存储整个对象或文档(document)。然而它不仅仅是存储，还会索引(index)每个文档的内容使之可以被搜索。在Elasticsearch中，你可以对文档（而非成行成列的 数据）进行索引、搜索、排序、过滤。<p>Elasticsearch比传统关系型数据库如下：<figure class="highlight tcl"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line>Relational DB ‐> Databases ‐> Tables ‐> Rows ‐> Columns</span><br><span class=line>Elasticsearch ‐> Indices ‐> Types ‐> Documents ‐> Fields</span><br></pre></table></figure><h3 id=1-4-1、索引Index><a class=headerlink href=#1-4-1、索引Index title=1.4.1、索引Index></a>1.4.1、索引Index</h3><p><strong>一个索引就是一个拥有几分相似特征的文档的集合</strong>。比如说，你可以有一个客户数据的索引，另一个产品目录的索 引，还有一个订单数据的索引。一个索引由一个名字来标识（必须全部是小写字母的），并且当我们要对对应于这 个索引中的文档进行索引、搜索、更新和删除的时候，都要使用到这个名字。在一个集群中，可以定义任意多的索引。<h3 id=1-4-2、类型Type><a class=headerlink href=#1-4-2、类型Type title=1.4.2、类型Type></a>1.4.2、类型Type</h3><p>在一个索引中，你可以定义一种或多种类型。一个类型是你的索引的一个逻辑上的分类/分区，其语义完全由你来定。通常，会为具有一组共同字段的文档定义一个类型。比如说，我们假设你运营一个博客平台并且将你所有的数据存储到一个索引中。在这个索引中，你可以为用户数据定义一个类型，为博客数据定义另一个类型，当然，也可以为评论数据定义另一个类型。<h3 id=1-4-3、字段Field><a class=headerlink href=#1-4-3、字段Field title=1.4.3、字段Field></a>1.4.3、字段Field</h3><p>相当于是数据表的字段，对文档数据根据不同属性进行的分类标识。<h3 id=1-4-4、映射Mapping><a class=headerlink href=#1-4-4、映射Mapping title=1.4.4、映射Mapping></a>1.4.4、映射Mapping</h3><p>mapping是处理数据的方式和规则方面做一些限制，如某个字段的数据类型、默认值、分析器、是否被索引等等， 这些都是映射里面可以设置的，其它就是处理es里面数据的一些使用规则设置也叫做映射，按着最优规则处理数据对性能提高很大，因此才需要建立映射，并且需要思考如何建立映射才能对性能更好。<h3 id=1-4-5、文档document><a class=headerlink href=#1-4-5、文档document title=1.4.5、文档document></a>1.4.5、文档document</h3><p>一个文档是一个可被索引的基础信息单元。比如，你可以拥有某一个客户的文档，某一个产品的一个文档，当然， 也可以拥有某个订单的一个文档。文档以JSON（Javascript Object Notation）格式来表示，而JSON是一个到处存 在的互联网数据交互格式。 在一个index/type里面，你可以存储任意多的文档。注意，尽管一个文档，物理上存在于一个索引之中，文档必须被索引/赋予一个索引的type。<h3 id=1-4-6、接近实时NRT><a class=headerlink href=#1-4-6、接近实时NRT title=1.4.6、接近实时NRT></a>1.4.6、接近实时NRT</h3><p>Elasticsearch是一个接近实时的搜索平台。这意味着，从索引一个文档直到这个文档能够被搜索到有一个轻微的延迟（通常是1秒以内）<h3 id=1-4-7、集群cluster><a class=headerlink href=#1-4-7、集群cluster title=1.4.7、集群cluster></a>1.4.7、集群cluster</h3><p>一个集群就是由一个或多个节点组织在一起，它们共同持有整个的数据，并一起提供索引和搜索功能。一个集群由 一个唯一的名字标识，这个名字默认就是“elasticsearch”。这个名字是重要的，因为一个节点只能通过指定某个集群的名字，来加入这个集群。<h3 id=1-4-8、节点Node><a class=headerlink href=#1-4-8、节点Node title=1.4.8、节点Node></a>1.4.8、节点Node</h3><p>一个节点是集群中的一个服务器，作为集群的一部分，它存储数据，参与集群的索引和搜索功能。和集群类似，一 个节点也是由一个名字来标识的，默认情况下，这个名字是一个随机的漫威漫画角色的名字，这个名字会在启动的 时候赋予节点。这个名字对于管理工作来说挺重要的，因为在这个管理过程中，你会去确定网络中的哪些服务器对 应于Elasticsearch集群中的哪些节点。<p>一个节点可以通过配置集群名称的方式来加入一个指定的集群。默认情况下，每个节点都会被安排加入到一个叫 做“elasticsearch”的集群中，这意味着，如果你在你的网络中启动了若干个节点，并假定它们能够相互发现彼此， 它们将会自动地形成并加入到一个叫做“elasticsearch”的集群中。<p>在一个集群里，只要你想，可以拥有任意多个节点。而且，如果当前你的网络中没有运行任何Elasticsearch节点， 这时启动一个节点，会默认创建并加入一个叫做“elasticsearch”的集群。<h3 id=1-4-9、分片和复制><a class=headerlink href=#1-4-9、分片和复制 title=1.4.9、分片和复制></a>1.4.9、分片和复制</h3><p>一个索引可以存储超出单个结点硬件限制的大量数据。比如，一个具有10亿文档的索引占据1TB的磁盘空间，而任 一节点都没有这样大的磁盘空间；或者单个节点处理搜索请求，响应太慢。为了解决这个问题，Elasticsearch提供 了将索引划分成多份的能力，这些份就叫做分片。当你创建一个索引的时候，你可以指定你想要的分片的数量。每 个分片本身也是一个功能完善并且独立的“索引”，这个“索引”可以被放置到集群中的任何节点上。分片很重要，主 要有两方面的原因： 1）允许你水平分割/扩展你的内容容量。 2）允许你在分片（潜在地，位于多个节点上）之上 进行分布式的、并行的操作，进而提高性能/吞吐量。<p>至于一个分片怎样分布，它的文档怎样聚合回搜索请求，是完全由Elasticsearch管理的，对于作为用户的你来说， 这些都是透明的。<p>在一个网络/云的环境里，失败随时都可能发生，在某个分片/节点不知怎么的就处于离线状态，或者由于任何原因 消失了，这种情况下，有一个故障转移机制是非常有用并且是强烈推荐的。为此目的，Elasticsearch允许你创建分 片的一份或多份拷贝，这些拷贝叫做复制分片，或者直接叫复制。<p>复制之所以重要，有两个主要原因： 在分片/节点失败的情况下，提供了高可用性。因为这个原因，注意到复制分 片从不与原/主要（original/primary）分片置于同一节点上是非常重要的。扩展你的搜索量/吞吐量，因为搜索可以 在所有的复制上并行运行。总之，每个索引可以被分成多个分片。一个索引也可以被复制0次（意思是没有复制） 或多次。一旦复制了，每个索引就有了主分片（作为复制源的原来的分片）和复制分片（主分片的拷贝）之别。分 片和复制的数量可以在索引创建的时候指定。在索引创建之后，你可以在任何时候动态地改变复制的数量，但是你 事后不能改变分片的数量。<p>默认情况下，Elasticsearch中的每个索引被分片5个主分片和1个复制，这意味着，如果你的集群中至少有两个节 点，你的索引将会有5个主分片和另外5个复制分片（1个完全拷贝），这样的话每个索引总共就有10个分片。<h1 id=2、ES管理><a class=headerlink href=#2、ES管理 title=2、ES管理></a>2、ES管理</h1><h2 id=2-1、DSL查询><a class=headerlink href=#2-1、DSL查询 title=2.1、DSL查询></a>2.1、DSL查询</h2><h3 id=2-1-1、概述><a class=headerlink href=#2-1-1、概述 title=2.1.1、概述></a>2.1.1、概述</h3><p>ES 提供了基于 JSON 的 DSL 来定义查询。常见查询类型包括：<ul><li>查询所有：查询所有数据，例如 match_all。<li>全文检索：利用分词器对输入内容进行分词，然后在倒排索引库中匹配。包括：match、multi_match。<li>精确查询：根据词条值来精确查询。包括：ids、range、term。<li>地理：根据经纬度来查询。包括：geo_distance、geo_bounding_box。<li>复合：可以将上述几个条件进行组合，合并查询条件。包括：bool、function_score。</ul><h3 id=2-1-2、复合检索><a class=headerlink href=#2-1-2、复合检索 title=2.1.2、复合检索></a>2.1.2、复合检索</h3><h4 id=2-1-2-1、bool-query><a title="2.1.2.1、bool query" class=headerlink href=#2-1-2-1、bool-query></a>2.1.2.1、bool query</h4><p><strong>bool query是一个或多个查询子句的组合</strong>，子查询组合方式有：<ul><li>must：必须匹配每个子查询。<li>must_not：必须不匹配，不参与算分。<li>should：选择性匹配子查询。<li>filter：必须匹配，不参与算分。</ul><p>使用语法和示例如下：<figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br></pre><td class=code><pre><span class=line>GET /indexName/_search</span><br><span class=line>{</span><br><span class=line>	<span class=string>"query"</span>:{</span><br><span class=line>		<span class=string>"bool"</span>:{</span><br><span class=line>			<span class=string>"must"</span>:[</span><br><span class=line>				{<span class=string>"term"</span>:{<span class=string>"city"</span>:<span class=string>"上海"</span>}}</span><br><span class=line>			],</span><br><span class=line>			<span class=string>"should"</span>:[</span><br><span class=line>				{<span class=string>"term"</span>:{<span class=string>"brand"</span>:<span class=string>"皇冠假日"</span>}},</span><br><span class=line>				{<span class=string>"term"</span>:{<span class=string>"brand"</span>:<span class=string>"华美达"</span>}}</span><br><span class=line>			],</span><br><span class=line>			<span class=string>"must_not"</span>:[</span><br><span class=line>				{<span class=string>"range"</span>:{<span class=string>"price"</span>:{<span class=string>"lte"</span>: 500}}}</span><br><span class=line>			],</span><br><span class=line>			<span class=string>"filter"</span>:[</span><br><span class=line>				{<span class=string>"range"</span>:{<span class=string>"score"</span>:{<span class=string>"gte"</span>: 45}}}</span><br><span class=line>			]</span><br><span class=line>		}</span><br><span class=line>	}</span><br><span class=line>}</span><br></pre></table></figure><h4 id=2-1-2-2、Boosting><a class=headerlink href=#2-1-2-2、Boosting title=2.1.2.2、Boosting></a>2.1.2.2、Boosting</h4><p>Boosting参数如下：<ul><li>positive（必填）：要运行的查询。<li>negative（必填）：用于降低相关性的查询<a href=https://www.elastic.co/guide/en/elasticsearch/reference/7.17/query-filter-context.html#relevance-scores rel=noopener target=_blank> </a>匹配文档的分数。<li>negative_boost（必填）：浮点数介于该参数值之间，用于减少 与查询匹配的文档的相关性分数。</ul><p>示例代码如下：<figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br></pre><td class=code><pre><span class=line>GET /_search</span><br><span class=line>{</span><br><span class=line>  <span class=string>"query"</span>: {</span><br><span class=line>    <span class=string>"boosting"</span>: {</span><br><span class=line>      <span class=string>"positive"</span>: {</span><br><span class=line>        <span class=string>"term"</span>: {</span><br><span class=line>          <span class=string>"text"</span>: <span class=string>"apple"</span></span><br><span class=line>        }</span><br><span class=line>      },</span><br><span class=line>      <span class=string>"negative"</span>: {</span><br><span class=line>        <span class=string>"term"</span>: {</span><br><span class=line>          <span class=string>"text"</span>: <span class=string>"pie tart fruit crumble tree"</span></span><br><span class=line>        }</span><br><span class=line>      },</span><br><span class=line>      <span class=string>"negative_boost"</span>: 0.5</span><br><span class=line>    }</span><br><span class=line>  }</span><br><span class=line>}</span><br></pre></table></figure><h4 id=2-1-2-3、Constant-score><a title="2.1.2.3、Constant score" class=headerlink href=#2-1-2-3、Constant-score></a>2.1.2.3、Constant score</h4><p>Constant score参数如下：<ul><li>filter（必填）：对要查询的文档进行过滤。<li>boost（可选）：为匹配到的文档的常量相关性分数。</ul><p>示例代码如下：<figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br></pre><td class=code><pre><span class=line>GET /_search</span><br><span class=line>{</span><br><span class=line>  <span class=string>"query"</span>: {</span><br><span class=line>    <span class=string>"constant_score"</span>: {</span><br><span class=line>      <span class=string>"filter"</span>: {</span><br><span class=line>        <span class=string>"term"</span>: { <span class=string>"user.id"</span>: <span class=string>"kimchy"</span> }</span><br><span class=line>      },</span><br><span class=line>      <span class=string>"boost"</span>: 1.2</span><br><span class=line>    }</span><br><span class=line>  }</span><br><span class=line>}</span><br></pre></table></figure><h4 id=2-1-2-4、Disjunction-max><a title="2.1.2.4、Disjunction max" class=headerlink href=#2-1-2-4、Disjunction-max></a>2.1.2.4、Disjunction max</h4><p>Disjunction max参数如下：<ul><li>queries（必需）：包含一个或多个子查询，可以匹配到相关的文档。<li>tie_breaker（可选）：浮点数和用于匹配到的文档的相关性分数。</ul><p>示例代码如下：<figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br></pre><td class=code><pre><span class=line>GET /_search</span><br><span class=line>{</span><br><span class=line>  <span class=string>"query"</span>: {</span><br><span class=line>    <span class=string>"dis_max"</span>: {</span><br><span class=line>      <span class=string>"queries"</span>: [</span><br><span class=line>        { <span class=string>"term"</span>: { <span class=string>"title"</span>: <span class=string>"Quick pets"</span> } },</span><br><span class=line>        { <span class=string>"term"</span>: { <span class=string>"body"</span>: <span class=string>"Quick pets"</span> } }</span><br><span class=line>      ],</span><br><span class=line>      <span class=string>"tie_breaker"</span>: 0.7</span><br><span class=line>    }</span><br><span class=line>  }</span><br><span class=line>}</span><br></pre></table></figure><h4 id=2-1-2-5、Function-score><a title="2.1.2.5、Function score" class=headerlink href=#2-1-2-5、Function-score></a>2.1.2.5、Function score</h4><p>该查询方式存在以下几个查询项：<ul><li>原始查询：搜索文档根据相关性来打分(query core)<li>过滤条件：符合条件的文档才会被算分<li>算分函数：算分函数的结果称为function score，将来会与query score运算得到新的算分，常见算分函数有：<ul><li>weight：给定一个常量值，作为函数结果。<li>field_value_factor：使用文档中的某个字段值作为函数结果。<li>random_score：随机生成一个值作为函数结果。<li>script_score：自定义计算公式，公式计算结果作为函数结果。</ul><li>加权方式：定义function score与query score的运算方式，包括：<ul><li>multiply：两者相乘，默认策略。<li>replace：使用 function score 替换 query score。<li>sum：求和。<li>avg：平均值。<li>max：最大值。<li>min：最小值。</ul></ul><p>使用语法和示例如下：<figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br></pre><td class=code><pre><span class=line><span class=comment># function_score 可以修改文档相关性算分，根据新的分数来排序</span></span><br><span class=line>GET /indexName/_search</span><br><span class=line>{</span><br><span class=line>	<span class=string>"query"</span>:{</span><br><span class=line>		<span class=string>"function_score"</span>:{</span><br><span class=line>			<span class=comment># 原始查询</span></span><br><span class=line>			<span class=string>"query"</span>:{<span class=string>"match"</span>:{<span class=string>"all"</span>:<span class=string>"外滩"</span>}},</span><br><span class=line>			<span class=string>"functions"</span>:[</span><br><span class=line>				{</span><br><span class=line>					<span class=comment># 过滤条件</span></span><br><span class=line>					<span class=string>"filter"</span>:{<span class=string>"term"</span>:{<span class=built_in>id</span>: <span class=string>"1"</span>}},</span><br><span class=line>					<span class=comment># 算分函数</span></span><br><span class=line>					<span class=string>"weight"</span>: 10</span><br><span class=line>				}</span><br><span class=line>			],</span><br><span class=line>			<span class=comment># 加权模式</span></span><br><span class=line>			<span class=string>"boost_mode"</span>: <span class=string>"multiply"</span></span><br><span class=line>		}</span><br><span class=line>	}</span><br><span class=line>}</span><br></pre></table></figure><h3 id=2-1-3、全文检索><a class=headerlink href=#2-1-3、全文检索 title=2.1.3、全文检索></a>2.1.3、全文检索</h3><p>使用语法和示例如下：<figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br></pre><td class=code><pre><span class=line><span class=comment># match 用法</span></span><br><span class=line>GET /_search</span><br><span class=line>{</span><br><span class=line>	<span class=string>"query"</span>:{</span><br><span class=line>		<span class=string>"match"</span>:{</span><br><span class=line>			<span class=string>"FIELD"</span>:<span class=string>"TEXT"</span></span><br><span class=line>		}</span><br><span class=line>	}</span><br><span class=line>}</span><br><span class=line></span><br><span class=line><span class=comment># multi_match 用法</span></span><br><span class=line>GET /_search</span><br><span class=line>{</span><br><span class=line>	<span class=string>"query"</span>:{</span><br><span class=line>		<span class=string>"multi_match"</span>:{</span><br><span class=line>			<span class=string>"query"</span>:<span class=string>"要查询的内容"</span>,</span><br><span class=line>			<span class=string>"FIELDS"</span>:[<span class=string>"要在哪些字段中查询，多个字段使用,号隔开"</span>]</span><br><span class=line>		}</span><br><span class=line>	}</span><br><span class=line>}</span><br></pre></table></figure><h3 id=2-1-4、精确检索><a class=headerlink href=#2-1-4、精确检索 title=2.1.4、精确检索></a>2.1.4、精确检索</h3><p>使用语法和示例如下：<figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br></pre><td class=code><pre><span class=line><span class=comment># term 按词条精确查询</span></span><br><span class=line>GET /indexName/_search</span><br><span class=line>{</span><br><span class=line>	<span class=string>"query"</span>:{</span><br><span class=line>		<span class=string>"term"</span>:{</span><br><span class=line>			<span class=string>"FIELD"</span>:{</span><br><span class=line>				<span class=string>"value"</span>:<span class=string>"VALUE"</span></span><br><span class=line>			}</span><br><span class=line>		}</span><br><span class=line>	}</span><br><span class=line>}</span><br><span class=line></span><br><span class=line><span class=comment># range 按数值、日期范围查询</span></span><br><span class=line>GET /indexName/_search</span><br><span class=line>{</span><br><span class=line>	<span class=string>"query"</span>:{</span><br><span class=line>		<span class=string>"range"</span>:{</span><br><span class=line>			<span class=string>"FIELD"</span>:{</span><br><span class=line>				<span class=string>"gte"</span>: 10,</span><br><span class=line>				<span class=string>"lte"</span>: 50</span><br><span class=line>			}</span><br><span class=line>		}</span><br><span class=line>	}</span><br><span class=line>}</span><br></pre></table></figure><h3 id=2-1-5、地理检索><a class=headerlink href=#2-1-5、地理检索 title=2.1.5、地理检索></a>2.1.5、地理检索</h3><p>使用语法和示例如下：<figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br></pre><td class=code><pre><span class=line><span class=comment># geo_bounding_box 查询geo_point值在某个矩形范围内的所有文档</span></span><br><span class=line>GET /indexName/_search</span><br><span class=line>{</span><br><span class=line>	<span class=string>"query"</span>:{</span><br><span class=line>		<span class=string>"geo_bounding_box"</span>:{</span><br><span class=line>			<span class=string>"FIELD"</span>:{</span><br><span class=line>				<span class=string>"lat"</span>: 31.1,</span><br><span class=line>				<span class=string>"lon"</span>: 121.5</span><br><span class=line>			},</span><br><span class=line>			<span class=string>"bottom_right"</span>:{</span><br><span class=line>				<span class=string>"lat"</span>: 30.9,</span><br><span class=line>				<span class=string>"lon"</span>: 121.7</span><br><span class=line>			}</span><br><span class=line>		}</span><br><span class=line>	}</span><br><span class=line>}</span><br><span class=line></span><br><span class=line><span class=comment># geo_distance 查询到达指定中心点小于某个距离值的所有文档</span></span><br><span class=line>GET /indexName/_search</span><br><span class=line>{</span><br><span class=line>	<span class=string>"query"</span>:{</span><br><span class=line>		<span class=string>"geo_distance"</span>:{</span><br><span class=line>			<span class=string>"distance"</span>: <span class=string>"15km"</span>,</span><br><span class=line>			<span class=string>"FIELD"</span>: <span class=string>"31.21, 121.5"</span></span><br><span class=line>		}</span><br><span class=line>	}</span><br><span class=line>}</span><br></pre></table></figure><h3 id=2-1-6、连接查询><a class=headerlink href=#2-1-6、连接查询 title=2.1.6、连接查询></a>2.1.6、连接查询</h3><h4 id=2-1-6-1、嵌套查询><a class=headerlink href=#2-1-6-1、嵌套查询 title=2.1.6.1、嵌套查询></a>2.1.6.1、嵌套查询</h4><p>示例代码如下：<figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br></pre><td class=code><pre><span class=line><span class=attr>//</span> <span class=string>准备数据</span></span><br><span class=line><span class=attr>PUT</span> <span class=string>/my-index-000001</span></span><br><span class=line><span class=attr>{</span></span><br><span class=line>  <span class=attr>"mappings"</span>: <span class=string>{</span></span><br><span class=line>    <span class=attr>"properties"</span>: <span class=string>{</span></span><br><span class=line>      <span class=attr>"obj1"</span>: <span class=string>{</span></span><br><span class=line>        <span class=attr>"type"</span>: <span class=string>"nested"</span></span><br><span class=line>      <span class=attr>}</span></span><br><span class=line>    <span class=attr>}</span></span><br><span class=line>  <span class=attr>}</span></span><br><span class=line><span class=attr>}</span></span><br><span class=line></span><br><span class=line><span class=attr>--------------------</span></span><br><span class=line></span><br><span class=line><span class=attr>GET</span> <span class=string>/my-index-000001/_search</span></span><br><span class=line><span class=attr>{</span></span><br><span class=line>  <span class=attr>"query"</span>: <span class=string>{</span></span><br><span class=line>    <span class=attr>"nested"</span>: <span class=string>{</span></span><br><span class=line>      <span class=attr>"path"</span>: <span class=string>"obj1",</span></span><br><span class=line>      <span class=attr>"query"</span>: <span class=string>{</span></span><br><span class=line>        <span class=attr>"bool"</span>: <span class=string>{</span></span><br><span class=line>          <span class=attr>"must"</span>: <span class=string>[</span></span><br><span class=line>            <span class=attr>{</span> <span class=string>"match": { "obj1.name": "blue" } },</span></span><br><span class=line>            <span class=attr>{</span> <span class=string>"range": { "obj1.count": { "gt": 5 } } }</span></span><br><span class=line>          <span class=attr>]</span></span><br><span class=line>        <span class=attr>}</span></span><br><span class=line>      <span class=attr>},</span></span><br><span class=line>      <span class=attr>"score_mode"</span>: <span class=string>"avg"</span></span><br><span class=line>    <span class=attr>}</span></span><br><span class=line>  <span class=attr>}</span></span><br><span class=line><span class=attr>}</span></span><br></pre></table></figure><p>多级嵌套查询示例：<figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br><span class=line>61</span><br><span class=line>62</span><br><span class=line>63</span><br><span class=line>64</span><br><span class=line>65</span><br><span class=line>66</span><br><span class=line>67</span><br><span class=line>68</span><br><span class=line>69</span><br><span class=line>70</span><br><span class=line>71</span><br><span class=line>72</span><br><span class=line>73</span><br><span class=line>74</span><br><span class=line>75</span><br><span class=line>76</span><br><span class=line>77</span><br><span class=line>78</span><br><span class=line>79</span><br><span class=line>80</span><br><span class=line>81</span><br><span class=line>82</span><br><span class=line>83</span><br><span class=line>84</span><br><span class=line>85</span><br><span class=line>86</span><br></pre><td class=code><pre><span class=line><span class=attr>//</span> <span class=string>准备数据</span></span><br><span class=line><span class=attr>PUT</span> <span class=string>/drivers</span></span><br><span class=line><span class=attr>{</span></span><br><span class=line>  <span class=attr>"mappings"</span>: <span class=string>{</span></span><br><span class=line>    <span class=attr>"properties"</span>: <span class=string>{</span></span><br><span class=line>      <span class=attr>"driver"</span>: <span class=string>{</span></span><br><span class=line>        <span class=attr>"type"</span>: <span class=string>"nested",</span></span><br><span class=line>        <span class=attr>"properties"</span>: <span class=string>{</span></span><br><span class=line>          <span class=attr>"last_name"</span>: <span class=string>{</span></span><br><span class=line>            <span class=attr>"type"</span>: <span class=string>"text"</span></span><br><span class=line>          <span class=attr>},</span></span><br><span class=line>          <span class=attr>"vehicle"</span>: <span class=string>{</span></span><br><span class=line>            <span class=attr>"type"</span>: <span class=string>"nested",</span></span><br><span class=line>            <span class=attr>"properties"</span>: <span class=string>{</span></span><br><span class=line>              <span class=attr>"make"</span>: <span class=string>{</span></span><br><span class=line>                <span class=attr>"type"</span>: <span class=string>"text"</span></span><br><span class=line>              <span class=attr>},</span></span><br><span class=line>              <span class=attr>"model"</span>: <span class=string>{</span></span><br><span class=line>                <span class=attr>"type"</span>: <span class=string>"text"</span></span><br><span class=line>              <span class=attr>}</span></span><br><span class=line>            <span class=attr>}</span></span><br><span class=line>          <span class=attr>}</span></span><br><span class=line>        <span class=attr>}</span></span><br><span class=line>      <span class=attr>}</span></span><br><span class=line>    <span class=attr>}</span></span><br><span class=line>  <span class=attr>}</span></span><br><span class=line><span class=attr>}</span></span><br><span class=line></span><br><span class=line><span class=attr>PUT</span> <span class=string>/drivers/_doc/1</span></span><br><span class=line><span class=attr>{</span></span><br><span class=line>  <span class=attr>"driver"</span> : <span class=string>{</span></span><br><span class=line>        <span class=attr>"last_name"</span> : <span class=string>"McQueen",</span></span><br><span class=line>        <span class=attr>"vehicle"</span> : <span class=string>[</span></span><br><span class=line>            <span class=attr>{</span></span><br><span class=line>                <span class=attr>"make"</span> : <span class=string>"Powell Motors",</span></span><br><span class=line>                <span class=attr>"model"</span> : <span class=string>"Canyonero"</span></span><br><span class=line>            <span class=attr>},</span></span><br><span class=line>            <span class=attr>{</span></span><br><span class=line>                <span class=attr>"make"</span> : <span class=string>"Miller-Meteor",</span></span><br><span class=line>                <span class=attr>"model"</span> : <span class=string>"Ecto-1"</span></span><br><span class=line>            <span class=attr>}</span></span><br><span class=line>        <span class=attr>]</span></span><br><span class=line>    <span class=attr>}</span></span><br><span class=line><span class=attr>}</span></span><br><span class=line></span><br><span class=line><span class=attr>PUT</span> <span class=string>/drivers/_doc/2?refresh</span></span><br><span class=line><span class=attr>{</span></span><br><span class=line>  <span class=attr>"driver"</span> : <span class=string>{</span></span><br><span class=line>        <span class=attr>"last_name"</span> : <span class=string>"Hudson",</span></span><br><span class=line>        <span class=attr>"vehicle"</span> : <span class=string>[</span></span><br><span class=line>            <span class=attr>{</span></span><br><span class=line>                <span class=attr>"make"</span> : <span class=string>"Mifune",</span></span><br><span class=line>                <span class=attr>"model"</span> : <span class=string>"Mach Five"</span></span><br><span class=line>            <span class=attr>},</span></span><br><span class=line>            <span class=attr>{</span></span><br><span class=line>                <span class=attr>"make"</span> : <span class=string>"Miller-Meteor",</span></span><br><span class=line>                <span class=attr>"model"</span> : <span class=string>"Ecto-1"</span></span><br><span class=line>            <span class=attr>}</span></span><br><span class=line>        <span class=attr>]</span></span><br><span class=line>    <span class=attr>}</span></span><br><span class=line><span class=attr>}</span></span><br><span class=line></span><br><span class=line>=============================</span><br><span class=line><span class=attr>//</span> <span class=string>多级嵌套查询</span></span><br><span class=line><span class=attr>GET</span> <span class=string>/drivers/_search</span></span><br><span class=line><span class=attr>{</span></span><br><span class=line>  <span class=attr>"query"</span>: <span class=string>{</span></span><br><span class=line>    <span class=attr>"nested"</span>: <span class=string>{</span></span><br><span class=line>      <span class=attr>"path"</span>: <span class=string>"driver",</span></span><br><span class=line>      <span class=attr>"query"</span>: <span class=string>{</span></span><br><span class=line>        <span class=attr>"nested"</span>: <span class=string>{</span></span><br><span class=line>          <span class=attr>"path"</span>: <span class=string>"driver.vehicle",</span></span><br><span class=line>          <span class=attr>"query"</span>: <span class=string>{</span></span><br><span class=line>            <span class=attr>"bool"</span>: <span class=string>{</span></span><br><span class=line>              <span class=attr>"must"</span>: <span class=string>[</span></span><br><span class=line>                <span class=attr>{</span> <span class=string>"match": { "driver.vehicle.make": "Powell Motors" } },</span></span><br><span class=line>                <span class=attr>{</span> <span class=string>"match": { "driver.vehicle.model": "Canyonero" } }</span></span><br><span class=line>              <span class=attr>]</span></span><br><span class=line>            <span class=attr>}</span></span><br><span class=line>          <span class=attr>}</span></span><br><span class=line>        <span class=attr>}</span></span><br><span class=line>      <span class=attr>}</span></span><br><span class=line>    <span class=attr>}</span></span><br><span class=line>  <span class=attr>}</span></span><br><span class=line><span class=attr>}</span></span><br><span class=line></span><br></pre></table></figure><h4 id=2-1-6-2、子查询><a class=headerlink href=#2-1-6-2、子查询 title=2.1.6.2、子查询></a>2.1.6.2、子查询</h4><p>示例代码如下：<figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br></pre><td class=code><pre><span class=line><span class=attr>GET</span> <span class=string>/_search</span></span><br><span class=line><span class=attr>{</span></span><br><span class=line>  <span class=attr>"query"</span>: <span class=string>{</span></span><br><span class=line>    <span class=attr>"has_child"</span>: <span class=string>{</span></span><br><span class=line>      <span class=attr>"type"</span>: <span class=string>"child",</span></span><br><span class=line>      <span class=attr>"query"</span>: <span class=string>{</span></span><br><span class=line>        <span class=attr>"match_all"</span>: <span class=string>{}</span></span><br><span class=line>      <span class=attr>},</span></span><br><span class=line>      <span class=attr>"max_children"</span>: <span class=string>10,</span></span><br><span class=line>      <span class=attr>"min_children"</span>: <span class=string>2,</span></span><br><span class=line>      <span class=attr>"score_mode"</span>: <span class=string>"min"</span></span><br><span class=line>    <span class=attr>}</span></span><br><span class=line>  <span class=attr>}</span></span><br><span class=line><span class=attr>}</span></span><br></pre></table></figure><h4 id=2-1-6-3、父查询><a class=headerlink href=#2-1-6-3、父查询 title=2.1.6.3、父查询></a>2.1.6.3、父查询</h4><p>示例代码如下：<figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br></pre><td class=code><pre><span class=line><span class=attr>GET</span> <span class=string>/my-index-000001/_search</span></span><br><span class=line><span class=attr>{</span></span><br><span class=line>  <span class=attr>"query"</span>: <span class=string>{</span></span><br><span class=line>    <span class=attr>"has_parent"</span>: <span class=string>{</span></span><br><span class=line>      <span class=attr>"parent_type"</span>: <span class=string>"parent",</span></span><br><span class=line>      <span class=attr>"query"</span>: <span class=string>{</span></span><br><span class=line>        <span class=attr>"term"</span>: <span class=string>{</span></span><br><span class=line>          <span class=attr>"tag"</span>: <span class=string>{</span></span><br><span class=line>            <span class=attr>"value"</span>: <span class=string>"Elasticsearch"</span></span><br><span class=line>          <span class=attr>}</span></span><br><span class=line>        <span class=attr>}</span></span><br><span class=line>      <span class=attr>}</span></span><br><span class=line>    <span class=attr>}</span></span><br><span class=line>  <span class=attr>}</span></span><br><span class=line><span class=attr>}</span></span><br></pre></table></figure><h4 id=2-1-6-4、父ID查询><a class=headerlink href=#2-1-6-4、父ID查询 title=2.1.6.4、父ID查询></a>2.1.6.4、父ID查询</h4><p>示例代码如下：<figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br></pre><td class=code><pre><span class=line><span class=attr>//</span> <span class=string>准备数据</span></span><br><span class=line><span class=attr>PUT</span> <span class=string>/my-index-000001</span></span><br><span class=line><span class=attr>{</span></span><br><span class=line>  <span class=attr>"mappings"</span>: <span class=string>{</span></span><br><span class=line>    <span class=attr>"properties"</span>: <span class=string>{</span></span><br><span class=line>      <span class=attr>"my-join-field"</span>: <span class=string>{</span></span><br><span class=line>        <span class=attr>"type"</span>: <span class=string>"join",</span></span><br><span class=line>        <span class=attr>"relations"</span>: <span class=string>{</span></span><br><span class=line>          <span class=attr>"my-parent"</span>: <span class=string>"my-child"</span></span><br><span class=line>        <span class=attr>}</span></span><br><span class=line>      <span class=attr>}</span></span><br><span class=line>    <span class=attr>}</span></span><br><span class=line>  <span class=attr>}</span></span><br><span class=line><span class=attr>}</span></span><br><span class=line>===</span><br><span class=line><span class=attr>PUT</span> <span class=string>/my-index-000001/_doc/1?refresh</span></span><br><span class=line><span class=attr>{</span></span><br><span class=line>  <span class=attr>"text"</span>: <span class=string>"This is a parent document.",</span></span><br><span class=line>  <span class=attr>"my-join-field"</span>: <span class=string>"my-parent"</span></span><br><span class=line><span class=attr>}</span></span><br><span class=line>===</span><br><span class=line><span class=attr>PUT</span> <span class=string>/my-index-000001/_doc/2?routing=1&refresh</span></span><br><span class=line><span class=attr>{</span></span><br><span class=line>  <span class=attr>"text"</span>: <span class=string>"This is a child document.",</span></span><br><span class=line>  <span class=attr>"my-join-field"</span>: <span class=string>{</span></span><br><span class=line>    <span class=attr>"name"</span>: <span class=string>"my-child",</span></span><br><span class=line>    <span class=attr>"parent"</span>: <span class=string>"1"</span></span><br><span class=line>  <span class=attr>}</span></span><br><span class=line><span class=attr>}</span></span><br><span class=line></span><br><span class=line>=================</span><br><span class=line><span class=attr>//</span> <span class=string>查询</span></span><br><span class=line><span class=attr>GET</span> <span class=string>/my-index-000001/_search</span></span><br><span class=line><span class=attr>{</span></span><br><span class=line>  <span class=attr>"query"</span>: <span class=string>{</span></span><br><span class=line>      <span class=attr>"parent_id"</span>: <span class=string>{</span></span><br><span class=line>          <span class=attr>"type"</span>: <span class=string>"my-child",</span></span><br><span class=line>          <span class=attr>"id"</span>: <span class=string>"1"</span></span><br><span class=line>      <span class=attr>}</span></span><br><span class=line>  <span class=attr>}</span></span><br><span class=line><span class=attr>}</span></span><br></pre></table></figure><h3 id=2-1-7、全部匹配><a class=headerlink href=#2-1-7、全部匹配 title=2.1.7、全部匹配></a>2.1.7、全部匹配</h3><p>示例代码如下：<figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br></pre><td class=code><pre><span class=line><span class=attr>GET</span> <span class=string>/_search</span></span><br><span class=line><span class=attr>{</span></span><br><span class=line>    <span class=attr>"query"</span>: <span class=string>{</span></span><br><span class=line>        <span class=attr>"match_all"</span>: <span class=string>{}</span></span><br><span class=line>    <span class=attr>}</span></span><br><span class=line><span class=attr>}</span></span><br><span class=line>===</span><br><span class=line><span class=attr>GET</span> <span class=string>/_search</span></span><br><span class=line><span class=attr>{</span></span><br><span class=line>  <span class=attr>"query"</span>: <span class=string>{</span></span><br><span class=line>    <span class=attr>"match_all"</span>: <span class=string>{ "boost" : 1.2 }</span></span><br><span class=line>  <span class=attr>}</span></span><br><span class=line><span class=attr>}</span></span><br></pre></table></figure><h3 id=2-1-8、跨度查询><a class=headerlink href=#2-1-8、跨度查询 title=2.1.8、跨度查询></a>2.1.8、跨度查询</h3><h4 id=2-1-8-1、Span-containing-query><a title="2.1.8.1、Span containing query" class=headerlink href=#2-1-8-1、Span-containing-query></a>2.1.8.1、Span containing query</h4><p>示例代码如下：<figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br></pre><td class=code><pre><span class=line><span class=attr>GET</span> <span class=string>/_search</span></span><br><span class=line><span class=attr>{</span></span><br><span class=line>  <span class=attr>"query"</span>: <span class=string>{</span></span><br><span class=line>    <span class=attr>"span_containing"</span>: <span class=string>{</span></span><br><span class=line>      <span class=attr>"little"</span>: <span class=string>{</span></span><br><span class=line>        <span class=attr>"span_term"</span>: <span class=string>{ "field1": "foo" }</span></span><br><span class=line>      <span class=attr>},</span></span><br><span class=line>      <span class=attr>"big"</span>: <span class=string>{</span></span><br><span class=line>        <span class=attr>"span_near"</span>: <span class=string>{</span></span><br><span class=line>          <span class=attr>"clauses"</span>: <span class=string>[</span></span><br><span class=line>            <span class=attr>{</span> <span class=string>"span_term": { "field1": "bar" } },</span></span><br><span class=line>            <span class=attr>{</span> <span class=string>"span_term": { "field1": "baz" } }</span></span><br><span class=line>          <span class=attr>],</span></span><br><span class=line>          <span class=attr>"slop"</span>: <span class=string>5,</span></span><br><span class=line>          <span class=attr>"in_order"</span>: <span class=string>true</span></span><br><span class=line>        <span class=attr>}</span></span><br><span class=line>      <span class=attr>}</span></span><br><span class=line>    <span class=attr>}</span></span><br><span class=line>  <span class=attr>}</span></span><br><span class=line><span class=attr>}</span></span><br></pre></table></figure><h4 id=2-1-8-2、Span-field-masking><a title="2.1.8.2、Span field masking" class=headerlink href=#2-1-8-2、Span-field-masking></a>2.1.8.2、Span field masking</h4><p>示例代码如下：<figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br></pre><td class=code><pre><span class=line><span class=attr>GET</span> <span class=string>/_search</span></span><br><span class=line><span class=attr>{</span></span><br><span class=line>  <span class=attr>"query"</span>: <span class=string>{</span></span><br><span class=line>    <span class=attr>"span_near"</span>: <span class=string>{</span></span><br><span class=line>      <span class=attr>"clauses"</span>: <span class=string>[</span></span><br><span class=line>        <span class=attr>{</span></span><br><span class=line>          <span class=attr>"span_term"</span>: <span class=string>{</span></span><br><span class=line>            <span class=attr>"text"</span>: <span class=string>"quick brown"</span></span><br><span class=line>          <span class=attr>}</span></span><br><span class=line>        <span class=attr>},</span></span><br><span class=line>        <span class=attr>{</span></span><br><span class=line>          <span class=attr>"span_field_masking"</span>: <span class=string>{</span></span><br><span class=line>            <span class=attr>"query"</span>: <span class=string>{</span></span><br><span class=line>              <span class=attr>"span_term"</span>: <span class=string>{</span></span><br><span class=line>                <span class=attr>"text.stems"</span>: <span class=string>"fox"</span></span><br><span class=line>              <span class=attr>}</span></span><br><span class=line>            <span class=attr>},</span></span><br><span class=line>            <span class=attr>"field"</span>: <span class=string>"text"</span></span><br><span class=line>          <span class=attr>}</span></span><br><span class=line>        <span class=attr>}</span></span><br><span class=line>      <span class=attr>],</span></span><br><span class=line>      <span class=attr>"slop"</span>: <span class=string>5,</span></span><br><span class=line>      <span class=attr>"in_order"</span>: <span class=string>false</span></span><br><span class=line>    <span class=attr>}</span></span><br><span class=line>  <span class=attr>}</span></span><br><span class=line><span class=attr>}</span></span><br></pre></table></figure><h4 id=2-1-8-3、Span-first><a title="2.1.8.3、Span first" class=headerlink href=#2-1-8-3、Span-first></a>2.1.8.3、Span first</h4><p>示例代码如下：<figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br></pre><td class=code><pre><span class=line><span class=attr>GET</span> <span class=string>/_search</span></span><br><span class=line><span class=attr>{</span></span><br><span class=line>  <span class=attr>"query"</span>: <span class=string>{</span></span><br><span class=line>    <span class=attr>"span_first"</span>: <span class=string>{</span></span><br><span class=line>      <span class=attr>"match"</span>: <span class=string>{</span></span><br><span class=line>        <span class=attr>"span_term"</span>: <span class=string>{ "user.id": "kimchy" }</span></span><br><span class=line>      <span class=attr>},</span></span><br><span class=line>      <span class=attr>"end"</span>: <span class=string>3</span></span><br><span class=line>    <span class=attr>}</span></span><br><span class=line>  <span class=attr>}</span></span><br><span class=line><span class=attr>}</span></span><br></pre></table></figure><h4 id=2-1-8-4、Span-multi-term><a title="2.1.8.4、Span multi-term" class=headerlink href=#2-1-8-4、Span-multi-term></a>2.1.8.4、Span multi-term</h4><p>示例代码如下：<figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br></pre><td class=code><pre><span class=line><span class=attr>GET</span> <span class=string>/_search</span></span><br><span class=line><span class=attr>{</span></span><br><span class=line>  <span class=attr>"query"</span>: <span class=string>{</span></span><br><span class=line>    <span class=attr>"span_multi"</span>: <span class=string>{</span></span><br><span class=line>      <span class=attr>"match"</span>: <span class=string>{</span></span><br><span class=line>        <span class=attr>"prefix"</span>: <span class=string>{ "user.id": { "value": "ki", "boost": 1.08 } }</span></span><br><span class=line>      <span class=attr>}</span></span><br><span class=line>    <span class=attr>}</span></span><br><span class=line>  <span class=attr>}</span></span><br><span class=line><span class=attr>}</span></span><br></pre></table></figure><h4 id=2-1-8-5、Span-near><a title="2.1.8.5、Span near" class=headerlink href=#2-1-8-5、Span-near></a>2.1.8.5、Span near</h4><p>示例代码如下：<figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br></pre><td class=code><pre><span class=line><span class=attr>GET</span> <span class=string>/_search</span></span><br><span class=line><span class=attr>{</span></span><br><span class=line>  <span class=attr>"query"</span>: <span class=string>{</span></span><br><span class=line>    <span class=attr>"span_near"</span>: <span class=string>{</span></span><br><span class=line>      <span class=attr>"clauses"</span>: <span class=string>[</span></span><br><span class=line>        <span class=attr>{</span> <span class=string>"span_term": { "field": "value1" } },</span></span><br><span class=line>        <span class=attr>{</span> <span class=string>"span_term": { "field": "value2" } },</span></span><br><span class=line>        <span class=attr>{</span> <span class=string>"span_term": { "field": "value3" } }</span></span><br><span class=line>      <span class=attr>],</span></span><br><span class=line>      <span class=attr>"slop"</span>: <span class=string>12,</span></span><br><span class=line>      <span class=attr>"in_order"</span>: <span class=string>false</span></span><br><span class=line>    <span class=attr>}</span></span><br><span class=line>  <span class=attr>}</span></span><br><span class=line><span class=attr>}</span></span><br></pre></table></figure><h4 id=2-1-8-6、Span-not><a title="2.1.8.6、Span not" class=headerlink href=#2-1-8-6、Span-not></a>2.1.8.6、Span not</h4><p>示例代码如下：<figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br></pre><td class=code><pre><span class=line><span class=attr>GET</span> <span class=string>/_search</span></span><br><span class=line><span class=attr>{</span></span><br><span class=line>  <span class=attr>"query"</span>: <span class=string>{</span></span><br><span class=line>    <span class=attr>"span_not"</span>: <span class=string>{</span></span><br><span class=line>      <span class=attr>"include"</span>: <span class=string>{</span></span><br><span class=line>        <span class=attr>"span_term"</span>: <span class=string>{ "field1": "hoya" }</span></span><br><span class=line>      <span class=attr>},</span></span><br><span class=line>      <span class=attr>"exclude"</span>: <span class=string>{</span></span><br><span class=line>        <span class=attr>"span_near"</span>: <span class=string>{</span></span><br><span class=line>          <span class=attr>"clauses"</span>: <span class=string>[</span></span><br><span class=line>            <span class=attr>{</span> <span class=string>"span_term": { "field1": "la" } },</span></span><br><span class=line>            <span class=attr>{</span> <span class=string>"span_term": { "field1": "hoya" } }</span></span><br><span class=line>          <span class=attr>],</span></span><br><span class=line>          <span class=attr>"slop"</span>: <span class=string>0,</span></span><br><span class=line>          <span class=attr>"in_order"</span>: <span class=string>true</span></span><br><span class=line>        <span class=attr>}</span></span><br><span class=line>      <span class=attr>}</span></span><br><span class=line>    <span class=attr>}</span></span><br><span class=line>  <span class=attr>}</span></span><br><span class=line><span class=attr>}</span></span><br></pre></table></figure><h4 id=2-1-8-7、Span-or><a title="2.1.8.7、Span or" class=headerlink href=#2-1-8-7、Span-or></a>2.1.8.7、Span or</h4><p>示例代码如下：<figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br></pre><td class=code><pre><span class=line><span class=attr>GET</span> <span class=string>/_search</span></span><br><span class=line><span class=attr>{</span></span><br><span class=line>  <span class=attr>"query"</span>: <span class=string>{</span></span><br><span class=line>    <span class=attr>"span_or"</span> : <span class=string>{</span></span><br><span class=line>      <span class=attr>"clauses"</span> : <span class=string>[</span></span><br><span class=line>        <span class=attr>{</span> <span class=string>"span_term" : { "field" : "value1" } },</span></span><br><span class=line>        <span class=attr>{</span> <span class=string>"span_term" : { "field" : "value2" } },</span></span><br><span class=line>        <span class=attr>{</span> <span class=string>"span_term" : { "field" : "value3" } }</span></span><br><span class=line>      <span class=attr>]</span></span><br><span class=line>    <span class=attr>}</span></span><br><span class=line>  <span class=attr>}</span></span><br><span class=line><span class=attr>}</span></span><br></pre></table></figure><h4 id=2-1-8-8、Span-term><a title="2.1.8.8、Span term" class=headerlink href=#2-1-8-8、Span-term></a>2.1.8.8、Span term</h4><p>示例代码如下：<figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre><td class=code><pre><span class=line><span class=attr>GET</span> <span class=string>/_search</span></span><br><span class=line><span class=attr>{</span></span><br><span class=line>  <span class=attr>"query"</span>: <span class=string>{</span></span><br><span class=line>    <span class=attr>"span_term"</span> : <span class=string>{ "user.id" : { "term" : "kimchy", "boost" : 2.0 } }</span></span><br><span class=line>  <span class=attr>}</span></span><br><span class=line><span class=attr>}</span></span><br></pre></table></figure><h4 id=2-1-8-9、Span-within><a title="2.1.8.9、Span within" class=headerlink href=#2-1-8-9、Span-within></a>2.1.8.9、Span within</h4><p>示例代码如下：<figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br></pre><td class=code><pre><span class=line><span class=attr>GET</span> <span class=string>/_search</span></span><br><span class=line><span class=attr>{</span></span><br><span class=line>  <span class=attr>"query"</span>: <span class=string>{</span></span><br><span class=line>    <span class=attr>"span_within"</span>: <span class=string>{</span></span><br><span class=line>      <span class=attr>"little"</span>: <span class=string>{</span></span><br><span class=line>        <span class=attr>"span_term"</span>: <span class=string>{ "field1": "foo" }</span></span><br><span class=line>      <span class=attr>},</span></span><br><span class=line>      <span class=attr>"big"</span>: <span class=string>{</span></span><br><span class=line>        <span class=attr>"span_near"</span>: <span class=string>{</span></span><br><span class=line>          <span class=attr>"clauses"</span>: <span class=string>[</span></span><br><span class=line>            <span class=attr>{</span> <span class=string>"span_term": { "field1": "bar" } },</span></span><br><span class=line>            <span class=attr>{</span> <span class=string>"span_term": { "field1": "baz" } }</span></span><br><span class=line>          <span class=attr>],</span></span><br><span class=line>          <span class=attr>"slop"</span>: <span class=string>5,</span></span><br><span class=line>          <span class=attr>"in_order"</span>: <span class=string>true</span></span><br><span class=line>        <span class=attr>}</span></span><br><span class=line>      <span class=attr>}</span></span><br><span class=line>    <span class=attr>}</span></span><br><span class=line>  <span class=attr>}</span></span><br><span class=line><span class=attr>}</span></span><br></pre></table></figure><h3 id=2-1-9、专业查询><a class=headerlink href=#2-1-9、专业查询 title=2.1.9、专业查询></a>2.1.9、专业查询</h3><p>本查询包含如下查询：<ul><li>distance_feature query<li>more_like_this query<li>percolate query<li>rank_feature query<li>script query<li>script_score query<li>wrapper query<li>pinned query</ul><h3 id=2-1-10、术语查询><a class=headerlink href=#2-1-10、术语查询 title=2.1.10、术语查询></a>2.1.10、术语查询</h3><p>本查询包含如下查询：<ul><li>exixts query<li>fuzzy query<li>ids query<li>prefix query<li>range query<li>regexp query<li>term query<li>terms query<li>terms_set query<li>type query<li>wildcard query</ul><h3 id=2-1-11、参数-minimum-shoud-match><a title="2.1.11、参数 minimum_shoud_match" class=headerlink href=#2-1-11、参数-minimum-shoud-match></a>2.1.11、参数 minimum_shoud_match</h3><p>该参数可取值范围如下：整数、负整数、百分比、负百分比、组合、多种组合、<h3 id=2-1-12、参数-rewrite><a title="2.1.12、参数 rewrite" class=headerlink href=#2-1-12、参数-rewrite></a>2.1.12、参数 rewrite</h3><p>该参数取值范围如下：<ul><li>constant_score<li>constant_score_boolean<li>scoring_boolean<li>top_terms_blended_freqs_N<li>top_terms_boost_N<li>top_terms_N</ul><h3 id=2-1-13、正则表达式><a class=headerlink href=#2-1-13、正则表达式 title=2.1.13、正则表达式></a>2.1.13、正则表达式</h3><h4 id=2-1-13-1、概述><a class=headerlink href=#2-1-13-1、概述 title=2.1.13.1、概述></a>2.1.13.1、概述</h4><p>es支持两种查询正则表达式：<ul><li>regexp<li>query_string</ul><h4 id=2-1-13-2、保留字符><a class=headerlink href=#2-1-13-2、保留字符 title=2.1.13.2、保留字符></a>2.1.13.2、保留字符</h4><p>Lucene的正则表达式引擎支持所有Unicode字符。然而， 以下字符保留为运算符：<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>. ? + * | { } [ ] ( ) " \</span><br></pre></table></figure><p>根据启用的可选运算符， 也可以保留以下字符：<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line># @ & < >  ~</span><br></pre></table></figure><p>要按字面意思使用这些字符之一，请使用前面的字符对其进行转义 反斜杠或用双引号括起来。例如：<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line>\@                  # renders as a literal '@'</span><br><span class=line>\\                  # renders as a literal '\'</span><br><span class=line>"john@smith.com"    # renders as 'john@smith.com'</span><br></pre></table></figure><h4 id=2-1-13-3、标准运算符><a class=headerlink href=#2-1-13-3、标准运算符 title=2.1.13.3、标准运算符></a>2.1.13.3、标准运算符</h4><p>Lucene的正则表达式引擎不使用<a href=https://en.wikipedia.org/wiki/Perl_Compatible_Regular_Expressions rel=noopener target=_blank>Perl 兼容正则表达式 （PCRE）</a> 库，但它确实支持 遵循标准运算符。<ul><li><p><strong><code>.</code></strong></p> <p>匹配任何字符。例如：<code>ab.     # matches 'aba', 'abb', 'abz', etc.</code></p><li><p><strong><code>?</code></strong></p> <p>将前面的字符重复零次或一次。通常用于制作 前面的字符可选。例如：<code>abc?     # matches 'ab' and 'abc'</code></p><li><p><strong><code>+</code></strong></p> <p>重复上述字符一次或多次。例如：<code>ab+     # matches 'ab', 'abb', 'abbb', etc.</code></p><li><p><strong><code>\*</code></strong></p> <p>重复上述字符零次或多次。例如：<code>ab*     # matches 'a', 'ab', 'abb', 'abbb', etc.</code></p><li><p><strong><code>{}</code></strong></p> <p>前面的字符可以重复的最小和最大次数。为 例：<code>a{2}    # matches 'aa' a{2,4}  # matches 'aa', 'aaa', and 'aaaa' a{2,}   # matches 'a</code> repeated two or more times`</p><li><p><strong><code>|</code></strong></p> <p>OR 运算符。如果左侧的最长模式，则匹配将成功 一侧或右侧匹配。例如：<code>abc|xyz  # matches 'abc' and 'xyz'</code></p><li><p><strong><code>( … )</code></strong></p> <p>形成一个组。可以使用组将表达式的一部分视为单个表达式 字符。例如：<code>abc(def)?  # matches 'abc' and 'abcdef' but not 'abcd'</code></p><li><p><strong><code>[ … ]</code></strong></p> <p>匹配括号中的某个字符。例如：<code>[abc]   # matches 'a', 'b', 'c'</code>在括号内，表示范围，除非是第一个字符或 逃脱。例如：<code>-``-``[a-c]   # matches 'a', 'b', or 'c' [-abc]  # '-' is first character. Matches '-', 'a', 'b', or 'c' [abc\-] # Escapes '-'. Matches 'a', 'b', 'c', or '-'</code>括号中字符前面的 A 表示字符或范围为非。为 例：<code>^``[^abc]      # matches any character except 'a', 'b', or 'c' [^a-c]      # matches any character except 'a', 'b', or 'c' [^-abc]     # matches any character except '-', 'a', 'b', or 'c' [^abc\-]    # matches any character except 'a', 'b', 'c', or '-'</code></p></ul><h4 id=2-1-13-4、可选运算符><a class=headerlink href=#2-1-13-4、可选运算符 title=2.1.13.4、可选运算符></a>2.1.13.4、可选运算符</h4><p>您可以使用该参数为 启用更多可选运算符 Lucene 的正则表达式引擎。<code>flags</code><p>若要启用多个运算符，请使用分隔符。例如，一个值 的启用 和 运算符。<code>|``flags``COMPLEMENT|INTERVAL``COMPLEMENT``INTERVAL</code><h4 id=2-1-13-5、有效值><a class=headerlink href=#2-1-13-5、有效值 title=2.1.13.5、有效值></a>2.1.13.5、有效值</h4><ul><li><p><strong><code>All</code>（默认）</strong></p> <p>启用所有可选运算符。</p><li><p><strong><code>“”</code>（空字符串）</strong></p> <p>值的别名。<code>ALL</code></p><li><p><strong><code>COMPLEMENT</code></strong></p> <p>启用运算符。您可以使用 否定最短的跟随 模式。例如：<code>~``~``a~bc   # matches 'adc' and 'aec' but not 'abc'</code></p><li><p><strong><code>EMPTY</code></strong></p> <p>启用（空语言）运算符。运算符不匹配任何 字符串，甚至不是空字符串。<code>#``#</code>如果通过以编程方式组合值来创建正则表达式，则可以 传递以指定“无字符串”。这样可以避免意外匹配空 字符串或其他不需要的字符串。例如：<code>#``#|abc  # matches 'abc' but nothing else, not even an empty string</code></p><li><p><strong><code>INTERVAL</code></strong></p> <p>启用运算符。您可以使用 匹配数字范围。为 例：<code><>``<>``foo&LT1-100>      # matches 'foo1', 'foo2' ... 'foo99', 'foo100' foo&LT01-100>     # matches 'foo01', 'foo02' ... 'foo99', 'foo100'</code></p><li><p><strong><code>INTERSECTION</code></strong></p> <p>启用充当 AND 运算符的运算符。比赛将成功 如果左侧和右侧的模式匹配。例如：<code>&``aaa.+&.+bbb  # matches 'aaabbb'</code></p><li><p><strong><code>ANYSTRING</code></strong></p> <p>启用运算符。您可以使用匹配任何整个 字符串。<code>@``@</code>您可以将运算符与 and 运算符组合以创建 “一切除外”逻辑。例如：<code>@``&``~``@&~(abc.+)  # matches everything except terms beginning with 'abc'</code></p><li><p><strong><code>NONE</code></strong></p> <p>禁用所有可选运算符。</p></ul><h4 id=2-1-13-6、不支持的运算符><a class=headerlink href=#2-1-13-6、不支持的运算符 title=2.1.13.6、不支持的运算符></a>2.1.13.6、不支持的运算符</h4><p>Lucene 的正则表达式引擎不支持锚运算符，例如（行首）或（行尾）。为了匹配一个术语，常规 表达式必须与整个字符串匹配。<code>^``$</code><h2 id=2-2、聚合><a class=headerlink href=#2-2、聚合 title=2.2、聚合></a>2.2、聚合</h2><h3 id=2-2-1、概述><a class=headerlink href=#2-2-1、概述 title=2.2.1、概述></a>2.2.1、概述</h3><p>聚合将数据汇总为指标、统计信息或其他分析。 聚合可帮助您回答以下问题：<ul><li>我的网站的平均加载时间是多少？<li>根据交易量，谁是最有价值的客户？<li>在我的网络上，什么文件会被视为大文件？<li>每个产品类别中有多少种产品？</ul><p>Elasticsearch 将聚合分为三类：<ul><li>计算指标的 指标聚合， 例如字段值中的总和或平均值。<li>存储桶聚合 根据字段值、范围、 或其他标准。<li>从中获取输入的管道聚合 其他聚合，而不是文档或字段。</ul><h3 id=2-2-2、存储聚合><a class=headerlink href=#2-2-2、存储聚合 title=2.2.2、存储聚合></a>2.2.2、存储聚合</h3><h4 id=2-2-2-1、文本分类聚合><a class=headerlink href=#2-2-2-1、文本分类聚合 title=2.2.2.1、文本分类聚合></a>2.2.2.1、文本分类聚合</h4><p>参数如下：<ul><li>field（必填）<li>max_unique_tokens<li>max_matched_tokens<li>similarity_threshold<li>categorization_filters<li>categorization_analyzer<ul><li>char_filter<li>tokenizer<li>filter</ul><li>shard_size<li>size<li>min_doc_count<li>shard_min_doc_count</ul><p>代码示例：<figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br></pre><td class=code><pre><span class=line>POST log-messages/_search?filter_path=aggregations</span><br><span class=line>{</span><br><span class=line>  "aggs": {</span><br><span class=line>    "categories": {</span><br><span class=line>      "categorize_text": {</span><br><span class=line>        "field": "message"</span><br><span class=line>      }</span><br><span class=line>    }</span><br><span class=line>  }</span><br><span class=line>}</span><br></pre></table></figure><h4 id=2-2-2-2、日期范围聚合><a class=headerlink href=#2-2-2-2、日期范围聚合 title=2.2.2.2、日期范围聚合></a>2.2.2.2、日期范围聚合</h4><p>示例代码：<figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br></pre><td class=code><pre><span class=line>POST /sales/_search?size=0</span><br><span class=line>{</span><br><span class=line>  "aggs": {</span><br><span class=line>    "range": {</span><br><span class=line>      "date_range": {</span><br><span class=line>        "field": "date",</span><br><span class=line>        "format": "MM-yyyy",</span><br><span class=line>        "ranges": [</span><br><span class=line>          { "to": "now-10M/M" },  </span><br><span class=line>          { "from": "now-10M/M" } </span><br><span class=line>        ]</span><br><span class=line>      }</span><br><span class=line>    }</span><br><span class=line>  }</span><br><span class=line>}</span><br></pre></table></figure><h4 id=2-2-2-3、IP范围聚合><a class=headerlink href=#2-2-2-3、IP范围聚合 title=2.2.2.3、IP范围聚合></a>2.2.2.3、IP范围聚合</h4><p>示例代码：<figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br></pre><td class=code><pre><span class=line>GET /ip_addresses/_search</span><br><span class=line>{</span><br><span class=line>  "size": 10,</span><br><span class=line>  "aggs": {</span><br><span class=line>    "ip_ranges": {</span><br><span class=line>      "ip_range": {</span><br><span class=line>        "field": "ip",</span><br><span class=line>        "ranges": [</span><br><span class=line>          { "to": "10.0.0.5" },</span><br><span class=line>          { "from": "10.0.0.5" }</span><br><span class=line>        ]</span><br><span class=line>      }</span><br><span class=line>    }</span><br><span class=line>  }</span><br><span class=line>}</span><br></pre></table></figure><h3 id=2-2-3、指标聚合><a class=headerlink href=#2-2-3、指标聚合 title=2.2.3、指标聚合></a>2.2.3、指标聚合</h3><h4 id=2-2-3-1、平均聚合><a class=headerlink href=#2-2-3-1、平均聚合 title=2.2.3.1、平均聚合></a>2.2.3.1、平均聚合</h4><p>示例代码如下：<figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre><td class=code><pre><span class=line>POST /exams/_search?size=0</span><br><span class=line>{</span><br><span class=line>  "aggs": {</span><br><span class=line>    "avg_grade": { "avg": { "field": "grade" } }</span><br><span class=line>  }</span><br><span class=line>}</span><br></pre></table></figure><h4 id=2-2-3-2、最小聚合><a class=headerlink href=#2-2-3-2、最小聚合 title=2.2.3.2、最小聚合></a>2.2.3.2、最小聚合</h4><p>示例代码如下：<figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre><td class=code><pre><span class=line>POST /sales/_search?size=0</span><br><span class=line>{</span><br><span class=line>  "aggs": {</span><br><span class=line>    "min_price": { "min": { "field": "price" } }</span><br><span class=line>  }</span><br><span class=line>}</span><br></pre></table></figure><p>脚本示例代码如下：<figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br></pre><td class=code><pre><span class=line>POST /sales/_search</span><br><span class=line>{</span><br><span class=line>  "size": 0,</span><br><span class=line>  "runtime_mappings": {</span><br><span class=line>    "price.adjusted": {</span><br><span class=line>      "type": "double",</span><br><span class=line>      "script": """</span><br><span class=line>        double price = doc['price'].value;</span><br><span class=line>        if (doc['promoted'].value) {</span><br><span class=line>          price *= 0.8;</span><br><span class=line>        }</span><br><span class=line>        emit(price);</span><br><span class=line>      """</span><br><span class=line>    }</span><br><span class=line>  },</span><br><span class=line>  "aggs": {</span><br><span class=line>    "min_price": {</span><br><span class=line>      "min": { "field": "price.adjusted" }</span><br><span class=line>    }</span><br><span class=line>  }</span><br><span class=line>}</span><br></pre></table></figure><h4 id=2-2-3-3、百分位数排名聚合><a class=headerlink href=#2-2-3-3、百分位数排名聚合 title=2.2.3.3、百分位数排名聚合></a>2.2.3.3、百分位数排名聚合</h4><p>示例代码如下：<figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br></pre><td class=code><pre><span class=line>GET latency/_search</span><br><span class=line>{</span><br><span class=line>  "size": 0,</span><br><span class=line>  "aggs": {</span><br><span class=line>    "load_time_ranks": {</span><br><span class=line>      "percentile_ranks": {</span><br><span class=line>        "field": "load_time",   </span><br><span class=line>        "values": [ 500, 600 ]</span><br><span class=line>      }</span><br><span class=line>    }</span><br><span class=line>  }</span><br><span class=line>}</span><br></pre></table></figure><p>脚本示例代码如下：<figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br></pre><td class=code><pre><span class=line>GET latency/_search</span><br><span class=line>{</span><br><span class=line>  "size": 0,</span><br><span class=line>  "runtime_mappings": {</span><br><span class=line>    "load_time.seconds": {</span><br><span class=line>      "type": "long",</span><br><span class=line>      "script": {</span><br><span class=line>        "source": "emit(doc['load_time'].value / params.timeUnit)",</span><br><span class=line>        "params": {</span><br><span class=line>          "timeUnit": 1000</span><br><span class=line>        }</span><br><span class=line>      }</span><br><span class=line>    }</span><br><span class=line>  },</span><br><span class=line>  "aggs": {</span><br><span class=line>    "load_time_ranks": {</span><br><span class=line>      "percentile_ranks": {</span><br><span class=line>        "values": [ 500, 600 ],</span><br><span class=line>        "field": "load_time.seconds"</span><br><span class=line>      }</span><br><span class=line>    }</span><br><span class=line>  }</span><br><span class=line>}</span><br></pre></table></figure><h4 id=2-2-3-4、百分位数聚合><a class=headerlink href=#2-2-3-4、百分位数聚合 title=2.2.3.4、百分位数聚合></a>2.2.3.4、百分位数聚合</h4><p>示例代码如下：<figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br></pre><td class=code><pre><span class=line>GET latency/_search</span><br><span class=line>{</span><br><span class=line>  "size": 0,</span><br><span class=line>  "aggs": {</span><br><span class=line>    "load_time_outlier": {</span><br><span class=line>      "percentiles": {</span><br><span class=line>        "field": "load_time" </span><br><span class=line>      }</span><br><span class=line>    }</span><br><span class=line>  }</span><br><span class=line>}</span><br></pre></table></figure><p>脚本示例代码如下：<figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br></pre><td class=code><pre><span class=line>GET latency/_search</span><br><span class=line>{</span><br><span class=line>  "size": 0,</span><br><span class=line>  "runtime_mappings": {</span><br><span class=line>    "load_time.seconds": {</span><br><span class=line>      "type": "long",</span><br><span class=line>      "script": {</span><br><span class=line>        "source": "emit(doc['load_time'].value / params.timeUnit)",</span><br><span class=line>        "params": {</span><br><span class=line>          "timeUnit": 1000</span><br><span class=line>        }</span><br><span class=line>      }</span><br><span class=line>    }</span><br><span class=line>  },</span><br><span class=line>  "aggs": {</span><br><span class=line>    "load_time_outlier": {</span><br><span class=line>      "percentiles": {</span><br><span class=line>        "field": "load_time.seconds"</span><br><span class=line>      }</span><br><span class=line>    }</span><br><span class=line>  }</span><br><span class=line>}</span><br></pre></table></figure><p>压缩控制内存利用与精度估计：<figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br></pre><td class=code><pre><span class=line>GET latency/_search</span><br><span class=line>{</span><br><span class=line>  "size": 0,</span><br><span class=line>  "aggs": {</span><br><span class=line>    "load_time_outlier": {</span><br><span class=line>      "percentiles": {</span><br><span class=line>        "field": "load_time",</span><br><span class=line>        "tdigest": {</span><br><span class=line>          "compression": 200    </span><br><span class=line>        }</span><br><span class=line>      }</span><br><span class=line>    }</span><br><span class=line>  }</span><br><span class=line>}</span><br></pre></table></figure><h4 id=2-2-3-5、速率聚合><a class=headerlink href=#2-2-3-5、速率聚合 title=2.2.3.5、速率聚合></a>2.2.3.5、速率聚合</h4><p>示例代码如下：<figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br></pre><td class=code><pre><span class=line>GET sales/_search</span><br><span class=line>{</span><br><span class=line>  "size": 0,</span><br><span class=line>  "aggs": {</span><br><span class=line>    "by_date": {</span><br><span class=line>      "date_histogram": {</span><br><span class=line>        "field": "date",</span><br><span class=line>        "calendar_interval": "month"  </span><br><span class=line>      },</span><br><span class=line>      "aggs": {</span><br><span class=line>        "my_rate": {</span><br><span class=line>          "rate": {</span><br><span class=line>            "unit": "year"  </span><br><span class=line>          }</span><br><span class=line>        }</span><br><span class=line>      }</span><br><span class=line>    }</span><br><span class=line>  }</span><br><span class=line>}</span><br></pre></table></figure><h4 id=2-2-3-6、统计聚合><a class=headerlink href=#2-2-3-6、统计聚合 title=2.2.3.6、统计聚合></a>2.2.3.6、统计聚合</h4><p>示例代码如下：<figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre><td class=code><pre><span class=line>POST /exams/_search?size=0</span><br><span class=line>{</span><br><span class=line>  "aggs": {</span><br><span class=line>    "grades_stats": { "stats": { "field": "grade" } }</span><br><span class=line>  }</span><br><span class=line>}</span><br></pre></table></figure><h4 id=2-2-3-7、字符串统计聚合><a class=headerlink href=#2-2-3-7、字符串统计聚合 title=2.2.3.7、字符串统计聚合></a>2.2.3.7、字符串统计聚合</h4><p>示例代码如下：<figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre><td class=code><pre><span class=line>POST /my-index-000001/_search?size=0</span><br><span class=line>{</span><br><span class=line>  "aggs": {</span><br><span class=line>    "message_stats": { "string_stats": { "field": "message.keyword" } }</span><br><span class=line>  }</span><br><span class=line>}</span><br></pre></table></figure><h4 id=2-2-3-8、总和统计><a class=headerlink href=#2-2-3-8、总和统计 title=2.2.3.8、总和统计></a>2.2.3.8、总和统计</h4><p>示例代码如下：<figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br></pre><td class=code><pre><span class=line>POST /sales/_search?size=0</span><br><span class=line>{</span><br><span class=line>  "query": {</span><br><span class=line>    "constant_score": {</span><br><span class=line>      "filter": {</span><br><span class=line>        "match": { "type": "hat" }</span><br><span class=line>      }</span><br><span class=line>    }</span><br><span class=line>  },</span><br><span class=line>  "aggs": {</span><br><span class=line>    "hat_prices": { "sum": { "field": "price" } }</span><br><span class=line>  }</span><br><span class=line>}</span><br></pre></table></figure><p>脚本示例代码如下：<figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br></pre><td class=code><pre><span class=line>POST /sales/_search?size=0</span><br><span class=line>{</span><br><span class=line>  "runtime_mappings": {</span><br><span class=line>    "price.weighted": {</span><br><span class=line>      "type": "double",</span><br><span class=line>      "script": """</span><br><span class=line>        double price = doc['price'].value;</span><br><span class=line>        if (doc['promoted'].value) {</span><br><span class=line>          price *= 0.8;</span><br><span class=line>        }</span><br><span class=line>        emit(price);</span><br><span class=line>      """</span><br><span class=line>    }</span><br><span class=line>  },</span><br><span class=line>  "query": {</span><br><span class=line>    "constant_score": {</span><br><span class=line>      "filter": {</span><br><span class=line>        "match": { "type": "hat" }</span><br><span class=line>      }</span><br><span class=line>    }</span><br><span class=line>  },</span><br><span class=line>  "aggs": {</span><br><span class=line>    "hat_prices": {</span><br><span class=line>      "sum": {</span><br><span class=line>        "field": "price.weighted"</span><br><span class=line>      }</span><br><span class=line>    }</span><br><span class=line>  }</span><br><span class=line>}</span><br></pre></table></figure><h4 id=2-2-3-9、热门聚合><a class=headerlink href=#2-2-3-9、热门聚合 title=2.2.3.9、热门聚合></a>2.2.3.9、热门聚合</h4><p>示例代码如下：<figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br></pre><td class=code><pre><span class=line>POST /sales/_search?size=0</span><br><span class=line>{</span><br><span class=line>  "aggs": {</span><br><span class=line>    "top_tags": {</span><br><span class=line>      "terms": {</span><br><span class=line>        "field": "type",</span><br><span class=line>        "size": 3</span><br><span class=line>      },</span><br><span class=line>      "aggs": {</span><br><span class=line>        "top_sales_hits": {</span><br><span class=line>          "top_hits": {</span><br><span class=line>            "sort": [</span><br><span class=line>              {</span><br><span class=line>                "date": {</span><br><span class=line>                  "order": "desc"</span><br><span class=line>                }</span><br><span class=line>              }</span><br><span class=line>            ],</span><br><span class=line>            "_source": {</span><br><span class=line>              "includes": [ "date", "price" ]</span><br><span class=line>            },</span><br><span class=line>            "size": 1</span><br><span class=line>          }</span><br><span class=line>        }</span><br><span class=line>      }</span><br><span class=line>    }</span><br><span class=line>  }</span><br><span class=line>}</span><br></pre></table></figure><h4 id=2-2-3-10、加权平均聚合><a class=headerlink href=#2-2-3-10、加权平均聚合 title=2.2.3.10、加权平均聚合></a>2.2.3.10、加权平均聚合</h4><p>示例代码如下：<figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br></pre><td class=code><pre><span class=line>POST /exams/_search</span><br><span class=line>{</span><br><span class=line>  "size": 0,</span><br><span class=line>  "aggs": {</span><br><span class=line>    "weighted_grade": {</span><br><span class=line>      "weighted_avg": {</span><br><span class=line>        "value": {</span><br><span class=line>          "field": "grade"</span><br><span class=line>        },</span><br><span class=line>        "weight": {</span><br><span class=line>          "field": "weight"</span><br><span class=line>        }</span><br><span class=line>      }</span><br><span class=line>    }</span><br><span class=line>  }</span><br><span class=line>}</span><br></pre></table></figure><h3 id=2-2-4、管道聚合><a class=headerlink href=#2-2-4、管道聚合 title=2.2.4、管道聚合></a>2.2.4、管道聚合</h3><h4 id=2-2-4-1、平均存储桶聚合><a class=headerlink href=#2-2-4-1、平均存储桶聚合 title=2.2.4.1、平均存储桶聚合></a>2.2.4.1、平均存储桶聚合</h4><p>示例代码如下：<figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br></pre><td class=code><pre><span class=line>POST _search</span><br><span class=line>{</span><br><span class=line>  "size": 0,</span><br><span class=line>  "aggs": {</span><br><span class=line>    "sales_per_month": {</span><br><span class=line>      "date_histogram": {</span><br><span class=line>        "field": "date",</span><br><span class=line>        "calendar_interval": "month"</span><br><span class=line>      },</span><br><span class=line>      "aggs": {</span><br><span class=line>        "sales": {</span><br><span class=line>          "sum": {</span><br><span class=line>            "field": "price"</span><br><span class=line>          }</span><br><span class=line>        }</span><br><span class=line>      }</span><br><span class=line>    },</span><br><span class=line>    "avg_monthly_sales": {</span><br><span class=line>// tag::avg-bucket-agg-syntax[]               </span><br><span class=line>      "avg_bucket": {</span><br><span class=line>        "buckets_path": "sales_per_month>sales",</span><br><span class=line>        "gap_policy": "skip",</span><br><span class=line>        "format": "#,##0.00;(#,##0.00)"</span><br><span class=line>      }</span><br><span class=line>// end::avg-bucket-agg-syntax[]               </span><br><span class=line>    }</span><br><span class=line>  }</span><br><span class=line>}</span><br></pre></table></figure><h4 id=2-2-4-2、存储桶排序聚合><a class=headerlink href=#2-2-4-2、存储桶排序聚合 title=2.2.4.2、存储桶排序聚合></a>2.2.4.2、存储桶排序聚合</h4><p>示例代码如下：<figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br></pre><td class=code><pre><span class=line>POST /sales/_search</span><br><span class=line>{</span><br><span class=line>  "size": 0,</span><br><span class=line>  "aggs": {</span><br><span class=line>    "sales_per_month": {</span><br><span class=line>      "date_histogram": {</span><br><span class=line>        "field": "date",</span><br><span class=line>        "calendar_interval": "month"</span><br><span class=line>      },</span><br><span class=line>      "aggs": {</span><br><span class=line>        "total_sales": {</span><br><span class=line>          "sum": {</span><br><span class=line>            "field": "price"</span><br><span class=line>          }</span><br><span class=line>        },</span><br><span class=line>        "sales_bucket_sort": {</span><br><span class=line>          "bucket_sort": {</span><br><span class=line>            "sort": [</span><br><span class=line>              { "total_sales": { "order": "desc" } } </span><br><span class=line>            ],</span><br><span class=line>            "size": 3                                </span><br><span class=line>          }</span><br><span class=line>        }</span><br><span class=line>      }</span><br><span class=line>    }</span><br><span class=line>  }</span><br><span class=line>}</span><br></pre></table></figure><h4 id=2-2-4-3、累计总和聚合><a class=headerlink href=#2-2-4-3、累计总和聚合 title=2.2.4.3、累计总和聚合></a>2.2.4.3、累计总和聚合</h4><p>示例代码如下：<figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br></pre><td class=code><pre><span class=line>POST /sales/_search</span><br><span class=line>{</span><br><span class=line>  "size": 0,</span><br><span class=line>  "aggs": {</span><br><span class=line>    "sales_per_month": {</span><br><span class=line>      "date_histogram": {</span><br><span class=line>        "field": "date",</span><br><span class=line>        "calendar_interval": "month"</span><br><span class=line>      },</span><br><span class=line>      "aggs": {</span><br><span class=line>        "sales": {</span><br><span class=line>          "sum": {</span><br><span class=line>            "field": "price"</span><br><span class=line>          }</span><br><span class=line>        },</span><br><span class=line>        "cumulative_sales": {</span><br><span class=line>          "cumulative_sum": {</span><br><span class=line>            "buckets_path": "sales" </span><br><span class=line>          }</span><br><span class=line>        }</span><br><span class=line>      }</span><br><span class=line>    }</span><br><span class=line>  }</span><br><span class=line>}</span><br></pre></table></figure><h4 id=2-2-4-4、百分位数存储桶聚合><a class=headerlink href=#2-2-4-4、百分位数存储桶聚合 title=2.2.4.4、百分位数存储桶聚合></a>2.2.4.4、百分位数存储桶聚合</h4><p>示例代码如下：<figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br></pre><td class=code><pre><span class=line>POST /sales/_search</span><br><span class=line>{</span><br><span class=line>  "size": 0,</span><br><span class=line>  "aggs": {</span><br><span class=line>    "sales_per_month": {</span><br><span class=line>      "date_histogram": {</span><br><span class=line>        "field": "date",</span><br><span class=line>        "calendar_interval": "month"</span><br><span class=line>      },</span><br><span class=line>      "aggs": {</span><br><span class=line>        "sales": {</span><br><span class=line>          "sum": {</span><br><span class=line>            "field": "price"</span><br><span class=line>          }</span><br><span class=line>        }</span><br><span class=line>      }</span><br><span class=line>    },</span><br><span class=line>    "percentiles_monthly_sales": {</span><br><span class=line>      "percentiles_bucket": {</span><br><span class=line>        "buckets_path": "sales_per_month>sales", </span><br><span class=line>        "percents": [ 25.0, 50.0, 75.0 ]         </span><br><span class=line>      }</span><br><span class=line>    }</span><br><span class=line>  }</span><br><span class=line>}</span><br></pre></table></figure><h4 id=2-2-4-5、统计信息存储桶聚合><a class=headerlink href=#2-2-4-5、统计信息存储桶聚合 title=2.2.4.5、统计信息存储桶聚合></a>2.2.4.5、统计信息存储桶聚合</h4><p>示例代码如下：<figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br></pre><td class=code><pre><span class=line>POST /sales/_search</span><br><span class=line>{</span><br><span class=line>  "size": 0,</span><br><span class=line>  "aggs": {</span><br><span class=line>    "sales_per_month": {</span><br><span class=line>      "date_histogram": {</span><br><span class=line>        "field": "date",</span><br><span class=line>        "calendar_interval": "month"</span><br><span class=line>      },</span><br><span class=line>      "aggs": {</span><br><span class=line>        "sales": {</span><br><span class=line>          "sum": {</span><br><span class=line>            "field": "price"</span><br><span class=line>          }</span><br><span class=line>        }</span><br><span class=line>      }</span><br><span class=line>    },</span><br><span class=line>    "stats_monthly_sales": {</span><br><span class=line>      "stats_bucket": {</span><br><span class=line>        "buckets_path": "sales_per_month>sales" </span><br><span class=line>      }</span><br><span class=line>    }</span><br><span class=line>  }</span><br><span class=line>}</span><br></pre></table></figure><h4 id=2-2-4-6、综合存储桶聚合><a class=headerlink href=#2-2-4-6、综合存储桶聚合 title=2.2.4.6、综合存储桶聚合></a>2.2.4.6、综合存储桶聚合</h4><p>示例代码如下：<figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br></pre><td class=code><pre><span class=line>POST /sales/_search</span><br><span class=line>{</span><br><span class=line>  "size": 0,</span><br><span class=line>  "aggs": {</span><br><span class=line>    "sales_per_month": {</span><br><span class=line>      "date_histogram": {</span><br><span class=line>        "field": "date",</span><br><span class=line>        "calendar_interval": "month"</span><br><span class=line>      },</span><br><span class=line>      "aggs": {</span><br><span class=line>        "sales": {</span><br><span class=line>          "sum": {</span><br><span class=line>            "field": "price"</span><br><span class=line>          }</span><br><span class=line>        }</span><br><span class=line>      }</span><br><span class=line>    },</span><br><span class=line>    "sum_monthly_sales": {</span><br><span class=line>      "sum_bucket": {</span><br><span class=line>        "buckets_path": "sales_per_month>sales" </span><br><span class=line>      }</span><br><span class=line>    }</span><br><span class=line>  }</span><br><span class=line>}</span><br></pre></table></figure><h2 id=2-3、搜索数据><a class=headerlink href=#2-3、搜索数据 title=2.3、搜索数据></a>2.3、搜索数据</h2><h3 id=2-3-1、折叠搜索结果><a class=headerlink href=#2-3-1、折叠搜索结果 title=2.3.1、折叠搜索结果></a>2.3.1、折叠搜索结果</h3><h3 id=2-3-2、筛选搜索结果><a class=headerlink href=#2-3-2、筛选搜索结果 title=2.3.2、筛选搜索结果></a>2.3.2、筛选搜索结果</h3><h3 id=2-3-3、高亮突出><a class=headerlink href=#2-3-3、高亮突出 title=2.3.3、高亮突出></a>2.3.3、高亮突出</h3><h4 id=2-3-3-1、概述><a class=headerlink href=#2-3-3-1、概述 title=2.3.3.1、概述></a>2.3.3.1、概述</h4><p>高亮突出显示设置：<ul><li>boundary_chars<li>boundary_max_scan<li>boundary_scanner<ul><li>chars<li>sentence<li>word</ul><li>boundary_scanner_locale<li>encoder<li>fields<li>force_source<li>fragmenter<ul><li>simple<li>span</ul><li>fragment_offset<li>fragment_size<li>highlight_query<li>matched_fields<li>no_match_size<li>number_of_fragments<li>order<li>phrase_limit<li>pre_tags<li>post_tags<li>require_field_match<li>max_analyzed_offset<li>tags_schema<li>type</ul><h5 id=覆盖全局设置><a class=headerlink href=#覆盖全局设置 title=覆盖全局设置></a>覆盖全局设置</h5><p>示例代码如下：<figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br></pre><td class=code><pre><span class=line>GET /_search</span><br><span class=line>{</span><br><span class=line>  "query" : {</span><br><span class=line>    "match": { "user.id": "kimchy" }</span><br><span class=line>  },</span><br><span class=line>  "highlight" : {</span><br><span class=line>    "number_of_fragments" : 3,</span><br><span class=line>    "fragment_size" : 150,</span><br><span class=line>    "fields" : {</span><br><span class=line>      "body" : { "pre_tags" : ["&LTem>"], "post_tags" : ["&LT/em>"] },</span><br><span class=line>      "blog.title" : { "number_of_fragments" : 0 },</span><br><span class=line>      "blog.author" : { "number_of_fragments" : 0 },</span><br><span class=line>      "blog.comment" : { "number_of_fragments" : 5, "order" : "score" }</span><br><span class=line>    }</span><br><span class=line>  }</span><br><span class=line>}</span><br></pre></table></figure><h5 id=指定高亮显示><a class=headerlink href=#指定高亮显示 title=指定高亮显示></a>指定高亮显示</h5><p>示例代码如下：<figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br></pre><td class=code><pre><span class=line>GET /_search</span><br><span class=line>{</span><br><span class=line>  "query": {</span><br><span class=line>    "match": {</span><br><span class=line>      "comment": {</span><br><span class=line>        "query": "foo bar"</span><br><span class=line>      }</span><br><span class=line>    }</span><br><span class=line>  },</span><br><span class=line>  "rescore": {</span><br><span class=line>    "window_size": 50,</span><br><span class=line>    "query": {</span><br><span class=line>      "rescore_query": {</span><br><span class=line>        "match_phrase": {</span><br><span class=line>          "comment": {</span><br><span class=line>            "query": "foo bar",</span><br><span class=line>            "slop": 1</span><br><span class=line>          }</span><br><span class=line>        }</span><br><span class=line>      },</span><br><span class=line>      "rescore_query_weight": 10</span><br><span class=line>    }</span><br><span class=line>  },</span><br><span class=line>  "_source": false,</span><br><span class=line>  "highlight": {</span><br><span class=line>    "order": "score",</span><br><span class=line>    "fields": {</span><br><span class=line>      "comment": {</span><br><span class=line>        "fragment_size": 150,</span><br><span class=line>        "number_of_fragments": 3,</span><br><span class=line>        "highlight_query": {</span><br><span class=line>          "bool": {</span><br><span class=line>            "must": {</span><br><span class=line>              "match": {</span><br><span class=line>                "comment": {</span><br><span class=line>                  "query": "foo bar"</span><br><span class=line>                }</span><br><span class=line>              }</span><br><span class=line>            },</span><br><span class=line>            "should": {</span><br><span class=line>              "match_phrase": {</span><br><span class=line>                "comment": {</span><br><span class=line>                  "query": "foo bar",</span><br><span class=line>                  "slop": 1,</span><br><span class=line>                  "boost": 10.0</span><br><span class=line>                }</span><br><span class=line>              }</span><br><span class=line>            },</span><br><span class=line>            "minimum_should_match": 0</span><br><span class=line>          }</span><br><span class=line>        }</span><br><span class=line>      }</span><br><span class=line>    }</span><br><span class=line>  }</span><br><span class=line>}</span><br></pre></table></figure><h5 id=设置荧光笔类型><a class=headerlink href=#设置荧光笔类型 title=设置荧光笔类型></a>设置荧光笔类型</h5><p>示例代码如下：<figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br></pre><td class=code><pre><span class=line>GET /_search</span><br><span class=line>{</span><br><span class=line>  "query": {</span><br><span class=line>    "match": { "user.id": "kimchy" }</span><br><span class=line>  },</span><br><span class=line>  "highlight": {</span><br><span class=line>    "fields": {</span><br><span class=line>      "comment": { "type": "plain" }</span><br><span class=line>    }</span><br><span class=line>  }</span><br><span class=line>}</span><br></pre></table></figure><h5 id=配置高亮显示标记><a class=headerlink href=#配置高亮显示标记 title=配置高亮显示标记></a>配置高亮显示标记</h5><p>示例代码如下：<figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br></pre><td class=code><pre><span class=line>GET /_search</span><br><span class=line>{</span><br><span class=line>  "query" : {</span><br><span class=line>    "match": { "user.id": "kimchy" }</span><br><span class=line>  },</span><br><span class=line>  "highlight" : {</span><br><span class=line>    "pre_tags" : ["&LTtag1>"],</span><br><span class=line>    "post_tags" : ["&LT/tag1>"],</span><br><span class=line>    "fields" : {</span><br><span class=line>      "body" : {}</span><br><span class=line>    }</span><br><span class=line>  }</span><br><span class=line>}</span><br><span class=line>===</span><br><span class=line>GET /_search</span><br><span class=line>{</span><br><span class=line>  "query" : {</span><br><span class=line>    "match": { "user.id": "kimchy" }</span><br><span class=line>  },</span><br><span class=line>  "highlight" : {</span><br><span class=line>    "pre_tags" : ["&LTtag1>", "&LTtag2>"],</span><br><span class=line>    "post_tags" : ["&LT/tag1>", "&LT/tag2>"],</span><br><span class=line>    "fields" : {</span><br><span class=line>      "body" : {}</span><br><span class=line>    }</span><br><span class=line>  }</span><br><span class=line>}</span><br><span class=line>===</span><br><span class=line>GET /_search</span><br><span class=line>{</span><br><span class=line>  "query" : {</span><br><span class=line>    "match": { "user.id": "kimchy" }</span><br><span class=line>  },</span><br><span class=line>  "highlight" : {</span><br><span class=line>    "tags_schema" : "styled",</span><br><span class=line>    "fields" : {</span><br><span class=line>      "comment" : {}</span><br><span class=line>    }</span><br><span class=line>  }</span><br><span class=line>}</span><br></pre></table></figure><h5 id=源上高亮显示><a class=headerlink href=#源上高亮显示 title=源上高亮显示></a>源上高亮显示</h5><p>示例代码如下：<figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br></pre><td class=code><pre><span class=line>GET /_search</span><br><span class=line>{</span><br><span class=line>  "query" : {</span><br><span class=line>    "match": { "user.id": "kimchy" }</span><br><span class=line>  },</span><br><span class=line>  "highlight" : {</span><br><span class=line>    "fields" : {</span><br><span class=line>      "comment" : {"force_source" : true}</span><br><span class=line>    }</span><br><span class=line>  }</span><br><span class=line>}</span><br></pre></table></figure><h5 id=所有字段中高亮显示><a class=headerlink href=#所有字段中高亮显示 title=所有字段中高亮显示></a>所有字段中高亮显示</h5><p>示例代码如下：<figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br></pre><td class=code><pre><span class=line>GET /_search</span><br><span class=line>{</span><br><span class=line>  "query" : {</span><br><span class=line>    "match": { "user.id": "kimchy" }</span><br><span class=line>  },</span><br><span class=line>  "highlight" : {</span><br><span class=line>    "require_field_match": false,</span><br><span class=line>    "fields": {</span><br><span class=line>      "body" : { "pre_tags" : ["&LTem>"], "post_tags" : ["&LT/em>"] }</span><br><span class=line>    }</span><br><span class=line>  }</span><br><span class=line>}</span><br></pre></table></figure><h5 id=合并多个字段上的匹配项><a class=headerlink href=#合并多个字段上的匹配项 title=合并多个字段上的匹配项></a>合并多个字段上的匹配项</h5><p>示例代码如下：<figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br></pre><td class=code><pre><span class=line>GET /_search</span><br><span class=line>{</span><br><span class=line>  "query": {</span><br><span class=line>    "query_string": {</span><br><span class=line>      "query": "comment.plain:running scissors",</span><br><span class=line>      "fields": [ "comment" ]</span><br><span class=line>    }</span><br><span class=line>  },</span><br><span class=line>  "highlight": {</span><br><span class=line>    "order": "score",</span><br><span class=line>    "fields": {</span><br><span class=line>      "comment": {</span><br><span class=line>        "matched_fields": [ "comment", "comment.plain" ],</span><br><span class=line>        "type": "fvh"</span><br><span class=line>      }</span><br><span class=line>    }</span><br><span class=line>  }</span><br><span class=line>}</span><br></pre></table></figure><h5 id=排序高亮显示><a class=headerlink href=#排序高亮显示 title=排序高亮显示></a>排序高亮显示</h5><p>示例代码如下：<figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre><td class=code><pre><span class=line>GET /_search</span><br><span class=line>{</span><br><span class=line>  "highlight": {</span><br><span class=line>    "fields": [</span><br><span class=line>      { "title": {} },</span><br><span class=line>      { "text": {} }</span><br><span class=line>    ]</span><br><span class=line>  }</span><br><span class=line>}</span><br></pre></table></figure><h5 id=控制高亮显示片段><a class=headerlink href=#控制高亮显示片段 title=控制高亮显示片段></a>控制高亮显示片段</h5><p>示例代码如下：<figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br></pre><td class=code><pre><span class=line>GET /_search</span><br><span class=line>{</span><br><span class=line>  "query" : {</span><br><span class=line>    "match": { "user.id": "kimchy" }</span><br><span class=line>  },</span><br><span class=line>  "highlight" : {</span><br><span class=line>    "fields" : {</span><br><span class=line>      "comment" : {"fragment_size" : 150, "number_of_fragments" : 3}</span><br><span class=line>    }</span><br><span class=line>  }</span><br><span class=line>}</span><br></pre></table></figure><h5 id=使用列表高亮显示><a class=headerlink href=#使用列表高亮显示 title=使用列表高亮显示></a>使用列表高亮显示</h5><p>示例代码如下：<figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br></pre><td class=code><pre><span class=line>PUT /example</span><br><span class=line>{</span><br><span class=line>  "mappings": {</span><br><span class=line>    "properties": {</span><br><span class=line>      "comment" : {</span><br><span class=line>        "type": "text",</span><br><span class=line>        "index_options" : "offsets"</span><br><span class=line>      }</span><br><span class=line>    }</span><br><span class=line>  }</span><br><span class=line>}</span><br></pre></table></figure><h5 id=指定碎片><a class=headerlink href=#指定碎片 title=指定碎片></a>指定碎片</h5><p>示例代码如下：<figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br></pre><td class=code><pre><span class=line>GET my-index-000001/_search</span><br><span class=line>{</span><br><span class=line>  "query": {</span><br><span class=line>    "match_phrase": { "message": "number 1" }</span><br><span class=line>  },</span><br><span class=line>  "highlight": {</span><br><span class=line>    "fields": {</span><br><span class=line>      "message": {</span><br><span class=line>        "type": "plain",</span><br><span class=line>        "fragment_size": 15,</span><br><span class=line>        "number_of_fragments": 3,</span><br><span class=line>        "fragmenter": "simple"</span><br><span class=line>      }</span><br><span class=line>    }</span><br><span class=line>  }</span><br><span class=line>}</span><br></pre></table></figure><h3 id=2-3-4、分页><a class=headerlink href=#2-3-4、分页 title=2.3.4、分页></a>2.3.4、分页</h3><p>（1）分页查询基本使用<p>ES默认情况下只返回TOP10的数据，如果需要查询更多数据就需要修改分页参数from、size来控制查询数据量。<ul><li>from：分页开始的位置，默认为0。<li>size：需要获取文档的数量。</ul><p>使用语法和示例如下：<figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br></pre><td class=code><pre><span class=line>GET /indexName/_search</span><br><span class=line>{</span><br><span class=line>	<span class=string>"query"</span>:{</span><br><span class=line>		<span class=string>"match_all"</span>:{}</span><br><span class=line>	},</span><br><span class=line>	<span class=string>"from"</span>: 100,</span><br><span class=line>	<span class=string>"size"</span>: 10,</span><br><span class=line>	<span class=string>"sort"</span>:[</span><br><span class=line>		{<span class=string>"price"</span>:<span class=string>"asc"</span>}</span><br><span class=line>	]</span><br><span class=line>}</span><br></pre></table></figure><p>（2）分页查询潜在问题<p>ES是分布式的，故可能面临深度分页问题。比如在多个节点的环境下，需要查询某个字段值在某个范围，那么该如何查询呢？每个节点都取一点数据，然后合并后返回吗？好像不合适。<p>要想解决这个问题，可以采用整合排序方法。比如要按 price 排序后，获取from=990，size=10的数据，可以这样做：<ol><li>首先在每个节点上都排序，并查询前1000条文档。<li>将所有节点查询的结果进行合并，然后对这些合并后的结果重新进行排序，拿出前1000条文档。<li>在最终拿出的1000条文档中，选择从990开始的10条文档数据。</ol><p>需要注意一点：搜索页数太深，或结果集（from + size）太多，对内存和CPU消耗会太大，故ES限制结果集查询上限为10000。<p>如果要查询的数据查过10000时该怎么做？ES官方给出两种解决方案：<ul><li>search after：分页时需要排序，原理是从上一次的排序值开始，查询下一页的数据。官方推荐该种方式。<li>scroll：原理是将排序数据作为快照保存在内存中，官方已经不推荐使用。</ul><h3 id=2-3-5、查询特定字段><a class=headerlink href=#2-3-5、查询特定字段 title=2.3.5、查询特定字段></a>2.3.5、查询特定字段</h3><p>示例代码如下：<figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br></pre><td class=code><pre><span class=line>POST my-index-000001/_search</span><br><span class=line>{</span><br><span class=line>  "query": {</span><br><span class=line>    "match": {</span><br><span class=line>      "user.id": "kimchy"</span><br><span class=line>    }</span><br><span class=line>  },</span><br><span class=line>  "fields": [</span><br><span class=line>    "user.id",</span><br><span class=line>    "http.response.*",         </span><br><span class=line>    {</span><br><span class=line>      "field": "@timestamp",</span><br><span class=line>      "format": "epoch_millis" </span><br><span class=line>    }</span><br><span class=line>  ],</span><br><span class=line>  "_source": false</span><br><span class=line>}</span><br></pre></table></figure><h3 id=2-3-6、跨集群搜索><a class=headerlink href=#2-3-6、跨集群搜索 title=2.3.6、跨集群搜索></a>2.3.6、跨集群搜索</h3><p>支持跨集群搜索的API如下：<ul><li>search<li>async seearch<li>multi search<li>search template<li>multi search template<li>field capabillties<li>EQL search<li>SQL search<li>Vector title search</ul><h4 id=2-3-6-1、远程集群设置><a class=headerlink href=#2-3-6-1、远程集群设置 title=2.3.6.1、远程集群设置></a>2.3.6.1、远程集群设置</h4><p>示例代码如下：<figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br></pre><td class=code><pre><span class=line>PUT _cluster/settings</span><br><span class=line>{</span><br><span class=line>  "persistent": {</span><br><span class=line>    "cluster": {</span><br><span class=line>      "remote": {</span><br><span class=line>        "cluster_one": {</span><br><span class=line>          "seeds": [</span><br><span class=line>            "127.0.0.1:9300"</span><br><span class=line>          ]</span><br><span class=line>        },</span><br><span class=line>        "cluster_two": {</span><br><span class=line>          "seeds": [</span><br><span class=line>            "127.0.0.1:9301"</span><br><span class=line>          ]</span><br><span class=line>        },</span><br><span class=line>        "cluster_three": {</span><br><span class=line>          "seeds": [</span><br><span class=line>            "127.0.0.1:9302"</span><br><span class=line>          ]</span><br><span class=line>        }</span><br><span class=line>      }</span><br><span class=line>    }</span><br><span class=line>  }</span><br><span class=line>}</span><br></pre></table></figure><h4 id=2-3-6-2、单个远程集群搜索><a class=headerlink href=#2-3-6-2、单个远程集群搜索 title=2.3.6.2、单个远程集群搜索></a>2.3.6.2、单个远程集群搜索</h4><p>示例代码如下：<figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre><td class=code><pre><span class=line>GET /cluster_one:my-index-000001/_search</span><br><span class=line>{</span><br><span class=line>  "query": {</span><br><span class=line>    "match": {</span><br><span class=line>      "user.id": "kimchy"</span><br><span class=line>    }</span><br><span class=line>  },</span><br><span class=line>  "_source": ["user.id", "message", "http.response.status_code"]</span><br><span class=line>}</span><br></pre></table></figure><h4 id=2-3-6-3、多个远程集群搜索><a class=headerlink href=#2-3-6-3、多个远程集群搜索 title=2.3.6.3、多个远程集群搜索></a>2.3.6.3、多个远程集群搜索</h4><p>示例代码如下：<figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre><td class=code><pre><span class=line>GET /my-index-000001,cluster_one:my-index-000001,cluster_two:my-index-000001/_search</span><br><span class=line>{</span><br><span class=line>  "query": {</span><br><span class=line>    "match": {</span><br><span class=line>      "user.id": "kimchy"</span><br><span class=line>    }</span><br><span class=line>  },</span><br><span class=line>  "_source": ["user.id", "message", "http.response.status_code"]</span><br><span class=line>}</span><br></pre></table></figure><h3 id=2-3-7、搜索多个索引><a class=headerlink href=#2-3-7、搜索多个索引 title=2.3.7、搜索多个索引></a>2.3.7、搜索多个索引</h3><p>示例代码如下：<figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br></pre><td class=code><pre><span class=line>GET /my-index-000001,my-index-000002/_search</span><br><span class=line>{</span><br><span class=line>  "query": {</span><br><span class=line>    "match": {</span><br><span class=line>      "user.id": "kimchy"</span><br><span class=line>    }</span><br><span class=line>  }</span><br><span class=line>}</span><br><span class=line></span><br><span class=line>GET /my-index-*/_search</span><br><span class=line>{</span><br><span class=line>  "query": {</span><br><span class=line>    "match": {</span><br><span class=line>      "user.id": "kimchy"</span><br><span class=line>    }</span><br><span class=line>  }</span><br><span class=line>}</span><br><span class=line></span><br><span class=line>GET /_search</span><br><span class=line>{</span><br><span class=line>  "indices_boost": [</span><br><span class=line>    { "my-index-000001": 1.4 },</span><br><span class=line>    { "my-index-000002": 1.3 }</span><br><span class=line>  ]</span><br><span class=line>}</span><br><span class=line></span><br><span class=line>GET /_search</span><br><span class=line>{</span><br><span class=line>  "indices_boost": [</span><br><span class=line>    { "my-alias":  1.4 },</span><br><span class=line>    { "my-index*": 1.3 }</span><br><span class=line>  ]</span><br><span class=line>}</span><br></pre></table></figure><h3 id=2-3-8、搜索模板><a class=headerlink href=#2-3-8、搜索模板 title=2.3.8、搜索模板></a>2.3.8、搜索模板</h3><h4 id=2-3-8-1、创建搜索模板><a class=headerlink href=#2-3-8-1、创建搜索模板 title=2.3.8.1、创建搜索模板></a>2.3.8.1、创建搜索模板</h4><p>示例代码如下：<figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br></pre><td class=code><pre><span class=line>PUT _scripts/my-search-template</span><br><span class=line>{</span><br><span class=line>  "script": {</span><br><span class=line>    "lang": "mustache",</span><br><span class=line>    "source": {</span><br><span class=line>      "query": {</span><br><span class=line>        "match": {</span><br><span class=line>          "message": "{{query_string}}"</span><br><span class=line>        }</span><br><span class=line>      },</span><br><span class=line>      "from": "{{from}}",</span><br><span class=line>      "size": "{{size}}"</span><br><span class=line>    },</span><br><span class=line>    "params": {</span><br><span class=line>      "query_string": "My query string"</span><br><span class=line>    }</span><br><span class=line>  }</span><br><span class=line>}</span><br></pre></table></figure><h4 id=2-3-8-2、验证搜索模板><a class=headerlink href=#2-3-8-2、验证搜索模板 title=2.3.8.2、验证搜索模板></a>2.3.8.2、验证搜索模板</h4><p>示例代码如下：<figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre><td class=code><pre><span class=line>POST _render/template</span><br><span class=line>{</span><br><span class=line>  "id": "my-search-template",</span><br><span class=line>  "params": {</span><br><span class=line>    "query_string": "hello world",</span><br><span class=line>    "from": 20,</span><br><span class=line>    "size": 10</span><br><span class=line>  }</span><br><span class=line>}</span><br></pre></table></figure><h4 id=2-3-8-3、运行模板化搜索><a class=headerlink href=#2-3-8-3、运行模板化搜索 title=2.3.8.3、运行模板化搜索></a>2.3.8.3、运行模板化搜索</h4><p>示例代码如下：<figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre><td class=code><pre><span class=line>GET my-index/_search/template</span><br><span class=line>{</span><br><span class=line>  "id": "my-search-template",</span><br><span class=line>  "params": {</span><br><span class=line>    "query_string": "hello world",</span><br><span class=line>    "from": 0,</span><br><span class=line>    "size": 10</span><br><span class=line>  }</span><br><span class=line>}</span><br></pre></table></figure><p>运行多个模板化搜索代码示例：<figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line>GET my-index/_msearch/template</span><br><span class=line>{ }</span><br><span class=line>{ "id": "my-search-template", "params": { "query_string": "hello world", "from": 0, "size": 10 }}</span><br><span class=line>{ }</span><br><span class=line>{ "id": "my-other-search-template", "params": { "query_type": "match_all" }}</span><br></pre></table></figure><h4 id=2-3-8-4、获取搜索模板><a class=headerlink href=#2-3-8-4、获取搜索模板 title=2.3.8.4、获取搜索模板></a>2.3.8.4、获取搜索模板</h4><p>示例代码如下：<figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line>GET _scripts/my-search-template</span><br><span class=line></span><br><span class=line>GET _cluster/state/metadata?pretty&filter_path=metadata.stored_scripts</span><br></pre></table></figure><h4 id=2-3-8-5、删除搜素模板><a class=headerlink href=#2-3-8-5、删除搜素模板 title=2.3.8.5、删除搜素模板></a>2.3.8.5、删除搜素模板</h4><p>示例代码如下：<figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>DELETE _scripts/my-search-template</span><br></pre></table></figure><h3 id=2-3-6、排序><a class=headerlink href=#2-3-6、排序 title=2.3.6、排序></a>2.3.6、排序</h3><p>ES支持对查询结果进行排序，默认是根据相关度算分来排序。可以排序的字段类型有：keyword类型、数值类型、地理坐标类型、日期类型等。<p>使用语法和示例如下：<figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br></pre><td class=code><pre><span class=line><span class=comment># 数值类型排序</span></span><br><span class=line>GET /indexName/_search</span><br><span class=line>{</span><br><span class=line>	<span class=string>"query"</span>:{</span><br><span class=line>		<span class=string>"match_all"</span>:{}</span><br><span class=line>	},</span><br><span class=line>	<span class=string>"sort"</span>:{</span><br><span class=line>		<span class=string>"FIELD"</span>:<span class=string>"desc"</span>	<span class=comment># 排序字段和排序方式，desc、asc。</span></span><br><span class=line>	}</span><br><span class=line>}</span><br><span class=line></span><br><span class=line><span class=comment># 经纬度排序</span></span><br><span class=line>GET /_search</span><br><span class=line>{</span><br><span class=line>  <span class=string>"sort"</span> : [</span><br><span class=line>    {</span><br><span class=line>      <span class=string>"_geo_distance"</span> : {</span><br><span class=line>          <span class=string>"pin.location"</span> : {</span><br><span class=line>          	<span class=string>"lat"</span> : 40,</span><br><span class=line>          	<span class=string>"lon"</span> : -70</span><br><span class=line>          },</span><br><span class=line>          <span class=string>"order"</span> : <span class=string>"asc"</span>,</span><br><span class=line>          <span class=string>"unit"</span> : <span class=string>"km"</span>,</span><br><span class=line>          <span class=string>"mode"</span> : <span class=string>"min"</span>,</span><br><span class=line>          <span class=string>"distance_type"</span> : <span class=string>"arc"</span>,</span><br><span class=line>          <span class=string>"ignore_unmapped"</span>: <span class=literal>true</span></span><br><span class=line>      }</span><br><span class=line>    }</span><br><span class=line>  ],</span><br><span class=line>  <span class=string>"query"</span> : {</span><br><span class=line>    <span class=string>"term"</span> : { <span class=string>"user"</span> : <span class=string>"kimchy"</span> }</span><br><span class=line>  }</span><br><span class=line>}</span><br><span class=line>---------------------------</span><br><span class=line>GET /_search</span><br><span class=line>{</span><br><span class=line>  <span class=string>"sort"</span>: [</span><br><span class=line>    {</span><br><span class=line>      <span class=string>"_geo_distance"</span>: {</span><br><span class=line>        <span class=string>"pin.location"</span>: [ [ -70, 40 ], [ -71, 42 ] ],</span><br><span class=line>        <span class=string>"order"</span>: <span class=string>"asc"</span>,</span><br><span class=line>        <span class=string>"unit"</span>: <span class=string>"km"</span></span><br><span class=line>      }</span><br><span class=line>    }</span><br><span class=line>  ],</span><br><span class=line>  <span class=string>"query"</span>: {</span><br><span class=line>    <span class=string>"term"</span>: { <span class=string>"user"</span>: <span class=string>"kimchy"</span> }</span><br><span class=line>  }</span><br><span class=line>}</span><br></pre></table></figure><h1 id=4、ES客户端><a class=headerlink href=#4、ES客户端 title=4、ES客户端></a>4、ES客户端</h1><h2 id=4-1、简介><a class=headerlink href=#4-1、简介 title=4.1、简介></a>4.1、简介</h2><p>elasticsearch客户端主要有三种：<ul><li>第一种，elasticsearch-head插件。<li>第二种，使用elasticsearch提供的Restful接口直接访问。<li>第三种，使用elasticsearch提供的API进行访问。</ul><h2 id=4-2、HTTP操作ES><a class=headerlink href=#4-2、HTTP操作ES title=4.2、HTTP操作ES></a>4.2、HTTP操作ES</h2><h3 id=4-2-1、ES接口语法><a class=headerlink href=#4-2-1、ES接口语法 title=4.2.1、ES接口语法></a>4.2.1、ES接口语法</h3><table><thead><tr><th>参数<th>解释<tbody><tr><td>VERB<td>适当的 HTTP 方法 或 谓词 : GET 、 POST 、 PUT 、 HEAD 或者 DELETE 。<tr><td>PROTOCOL<td>http 或者 https （如果你在 Elasticsearch 前面有一个 https 代理）<tr><td>HOST<td>Elasticsearch 集群中任意节点的主机名，或者用 localhost 代表本地机器上的节点。<tr><td>PORT<td>运行 Elasticsearch HTTP 服务的端口号，默认是 9200 。<tr><td>PATH<td>API 的终端路径（例如 _count 将返回集群中文档数量）。Path 可能包含多个组件，例如： _cluster/stats 和 _nodes/stats/jvm 。<tr><td>QUERY_STRING<td>任意可选的查询字符串参数 (例如 ?pretty 将格式化地输出 JSON 返回值，使其更容易阅读)<tr><td>BODY<td>一个 JSON 格式的请求体 (如果请求需要的话)</table><h3 id=4-2-2、管理索引和映射><a class=headerlink href=#4-2-2、管理索引和映射 title=4.2.2、管理索引和映射></a>4.2.2、管理索引和映射</h3><h4 id=4-2-2-1、创建索引设置映射><a class=headerlink href=#4-2-2-1、创建索引设置映射 title=4.2.2.1、创建索引设置映射></a>4.2.2.1、创建索引设置映射</h4><p>使用put方法创建一个索引，然后设置mapping信息。<p>请求url：<figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>PUT localhost:9200/blog1 </span><br></pre></table></figure><p>请求体：<figure class="highlight json"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br></pre><td class=code><pre><span class=line><span class=punctuation>{</span> </span><br><span class=line>	<span class=attr>"mappings"</span><span class=punctuation>:</span> <span class=punctuation>{</span> </span><br><span class=line>    	<span class=attr>"article"</span><span class=punctuation>:</span> <span class=punctuation>{</span> </span><br><span class=line>            <span class=attr>"properties"</span><span class=punctuation>:</span> <span class=punctuation>{</span> </span><br><span class=line>                <span class=attr>"id"</span><span class=punctuation>:</span> <span class=punctuation>{</span> </span><br><span class=line>                    <span class=attr>"type"</span><span class=punctuation>:</span> <span class=string>"long"</span><span class=punctuation>,</span> </span><br><span class=line>                    <span class=attr>"store"</span><span class=punctuation>:</span> <span class=literal><span class=keyword>true</span></span><span class=punctuation>,</span> </span><br><span class=line>                    <span class=attr>"index"</span><span class=punctuation>:</span><span class=string>"not_analyzed"</span> </span><br><span class=line>                <span class=punctuation>}</span><span class=punctuation>,</span></span><br><span class=line>                <span class=attr>"title"</span><span class=punctuation>:</span> <span class=punctuation>{</span> </span><br><span class=line>                    <span class=attr>"type"</span><span class=punctuation>:</span> <span class=string>"text"</span><span class=punctuation>,</span> </span><br><span class=line>                    <span class=attr>"store"</span><span class=punctuation>:</span> <span class=literal><span class=keyword>true</span></span><span class=punctuation>,</span> </span><br><span class=line>                    <span class=attr>"index"</span><span class=punctuation>:</span><span class=string>"analyzed"</span><span class=punctuation>,</span> </span><br><span class=line>                    <span class=attr>"analyzer"</span><span class=punctuation>:</span><span class=string>"standard"</span> </span><br><span class=line>                <span class=punctuation>}</span><span class=punctuation>,</span></span><br><span class=line>                <span class=attr>"content"</span><span class=punctuation>:</span> <span class=punctuation>{</span> </span><br><span class=line>                    <span class=attr>"type"</span><span class=punctuation>:</span> <span class=string>"text"</span><span class=punctuation>,</span> </span><br><span class=line>                    <span class=attr>"store"</span><span class=punctuation>:</span> <span class=literal><span class=keyword>true</span></span><span class=punctuation>,</span> </span><br><span class=line>                    <span class=attr>"index"</span><span class=punctuation>:</span><span class=string>"analyzed"</span><span class=punctuation>,</span> </span><br><span class=line>                    <span class=attr>"analyzer"</span><span class=punctuation>:</span><span class=string>"standard"</span> </span><br><span class=line>                <span class=punctuation>}</span> </span><br><span class=line>            <span class=punctuation>}</span> </span><br><span class=line>        <span class=punctuation>}</span> </span><br><span class=line>    <span class=punctuation>}</span> </span><br><span class=line><span class=punctuation>}</span> </span><br></pre></table></figure><h4 id=4-2-2-2、创建索引后设置映射><a class=headerlink href=#4-2-2-2、创建索引后设置映射 title=4.2.2.2、创建索引后设置映射></a>4.2.2.2、创建索引后设置映射</h4><p>创建索引时可以设置mapping，也可以先创建索引然后再设置mapping。<p>请求url：<figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>POST http://127.0.0.1:9200/blog2/hello/_mapping</span><br></pre></table></figure><p>请求体：<figure class="highlight json"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br></pre><td class=code><pre><span class=line><span class=punctuation>{</span></span><br><span class=line>    <span class=attr>"hello"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>        <span class=attr>"properties"</span><span class=punctuation>:</span> <span class=punctuation>{</span> </span><br><span class=line>            <span class=attr>"id"</span><span class=punctuation>:</span><span class=punctuation>{</span></span><br><span class=line>                <span class=attr>"type"</span><span class=punctuation>:</span><span class=string>"long"</span><span class=punctuation>,</span> </span><br><span class=line>                <span class=attr>"store"</span><span class=punctuation>:</span><span class=literal><span class=keyword>true</span></span> </span><br><span class=line>            <span class=punctuation>}</span><span class=punctuation>,</span></span><br><span class=line>            <span class=attr>"title"</span><span class=punctuation>:</span><span class=punctuation>{</span> </span><br><span class=line>                <span class=attr>"type"</span><span class=punctuation>:</span><span class=string>"text"</span><span class=punctuation>,</span> </span><br><span class=line>                <span class=attr>"store"</span><span class=punctuation>:</span><span class=literal><span class=keyword>true</span></span><span class=punctuation>,</span> </span><br><span class=line>                <span class=attr>"index"</span><span class=punctuation>:</span><span class=literal><span class=keyword>true</span></span><span class=punctuation>,</span> </span><br><span class=line>                <span class=attr>"analyzer"</span><span class=punctuation>:</span><span class=string>"standard"</span> </span><br><span class=line>            <span class=punctuation>}</span><span class=punctuation>,</span></span><br><span class=line>            <span class=attr>"content"</span><span class=punctuation>:</span><span class=punctuation>{</span> </span><br><span class=line>                <span class=attr>"type"</span><span class=punctuation>:</span><span class=string>"text"</span><span class=punctuation>,</span> </span><br><span class=line>                <span class=attr>"store"</span><span class=punctuation>:</span><span class=literal><span class=keyword>true</span></span><span class=punctuation>,</span> </span><br><span class=line>                <span class=attr>"store"</span><span class=punctuation>:</span><span class=literal><span class=keyword>true</span></span><span class=punctuation>,</span> </span><br><span class=line>                <span class=attr>"index"</span><span class=punctuation>:</span><span class=literal><span class=keyword>true</span></span><span class=punctuation>,</span> </span><br><span class=line>                <span class=attr>"analyzer"</span><span class=punctuation>:</span><span class=string>"standard"</span> </span><br><span class=line>            <span class=punctuation>}</span> </span><br><span class=line>        <span class=punctuation>}</span> </span><br><span class=line>    <span class=punctuation>}</span> </span><br><span class=line><span class=punctuation>}</span></span><br></pre></table></figure><h4 id=4-2-2-3、删除索引><a class=headerlink href=#4-2-2-3、删除索引 title=4.2.2.3、删除索引></a>4.2.2.3、删除索引</h4><p>请求：<figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>DELETE localhost:9200/blog1</span><br></pre></table></figure><h3 id=4-2-5、管理文档><a class=headerlink href=#4-2-5、管理文档 title=4.2.5、管理文档></a>4.2.5、管理文档</h3><h4 id=4-2-5-1、创建文档><a class=headerlink href=#4-2-5-1、创建文档 title=4.2.5.1、创建文档></a>4.2.5.1、创建文档</h4><p>请求url：<figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>POST localhost:9200/blog1/article/1 </span><br></pre></table></figure><p>请求体：<figure class="highlight json"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line><span class=punctuation>{</span> </span><br><span class=line>    <span class=attr>"id"</span><span class=punctuation>:</span><span class=number>1</span><span class=punctuation>,</span> </span><br><span class=line>    <span class=attr>"title"</span><span class=punctuation>:</span><span class=string>"ElasticSearch是一个基于Lucene的搜索服务器"</span><span class=punctuation>,</span> </span><br><span class=line>    <span class=attr>"content"</span><span class=punctuation>:</span><span class=string>"它提供了一个分布式多用户能力的全文搜索引擎，基于RESTful web接口。Elasticsearch是用Java 开发的，并作为Apache许可条款下的开放源码发布，是当前流行的企业级搜索引擎。设计用于云计算中，能够达到实时搜索，稳定，可靠，快速，安装使用方便。"</span> </span><br><span class=line><span class=punctuation>}</span></span><br></pre></table></figure><h4 id=4-2-5-2、查询文档><a class=headerlink href=#4-2-5-2、查询文档 title=4.2.5.2、查询文档></a>4.2.5.2、查询文档</h4><h5 id=根据ID查询><a class=headerlink href=#根据ID查询 title=根据ID查询></a>根据ID查询</h5><p>请求url：<figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>GET localhost:9200/blog1/article/1</span><br></pre></table></figure><h5 id=queryString查询><a class=headerlink href=#queryString查询 title=queryString查询></a>queryString查询</h5><p>请i去URL<figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>POST localhost:9200/blog1/article/_search</span><br></pre></table></figure><p>请求体<figure class="highlight json"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre><td class=code><pre><span class=line><span class=punctuation>{</span> </span><br><span class=line>    <span class=attr>"query"</span><span class=punctuation>:</span> <span class=punctuation>{</span> </span><br><span class=line>        <span class=attr>"query_string"</span><span class=punctuation>:</span> <span class=punctuation>{</span> </span><br><span class=line>            <span class=attr>"default_field"</span><span class=punctuation>:</span> <span class=string>"title"</span><span class=punctuation>,</span> </span><br><span class=line>            <span class=attr>"query"</span><span class=punctuation>:</span> <span class=string>"搜索服务器"</span> </span><br><span class=line>        <span class=punctuation>}</span> </span><br><span class=line>    <span class=punctuation>}</span> </span><br><span class=line><span class=punctuation>}</span></span><br></pre></table></figure><h5 id=term查询><a class=headerlink href=#term查询 title=term查询></a>term查询</h5><p>请求url：<figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>POST localhost:9200/blog1/article/_search</span><br></pre></table></figure><p>请求体：<figure class="highlight json"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre><td class=code><pre><span class=line><span class=punctuation>{</span> </span><br><span class=line>    <span class=attr>"query"</span><span class=punctuation>:</span> <span class=punctuation>{</span> </span><br><span class=line>        <span class=attr>"term"</span><span class=punctuation>:</span> <span class=punctuation>{</span> </span><br><span class=line>            <span class=attr>"title"</span><span class=punctuation>:</span> <span class=string>"搜索"</span> </span><br><span class=line>        <span class=punctuation>}</span> </span><br><span class=line>    <span class=punctuation>}</span> </span><br><span class=line><span class=punctuation>}</span></span><br></pre></table></figure><h4 id=4-2-5-3、修改文档><a class=headerlink href=#4-2-5-3、修改文档 title=4.2.5.3、修改文档></a>4.2.5.3、修改文档</h4><p>请求url：<figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>POST localhost:9200/blog1/article/1</span><br></pre></table></figure><p>请求体：<figure class="highlight json"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line><span class=punctuation>{</span> </span><br><span class=line>    <span class=attr>"id"</span><span class=punctuation>:</span><span class=number>1</span><span class=punctuation>,</span> </span><br><span class=line>    <span class=attr>"title"</span><span class=punctuation>:</span><span class=string>"【修改】ElasticSearch是一个基于Lucene的搜索服务器"</span><span class=punctuation>,</span> </span><br><span class=line>    <span class=attr>"content"</span><span class=punctuation>:</span><span class=string>"【修改】它提供了一个分布式多用户能力的全文搜索引擎，基于RESTful web接口。Elasticsearch 是用Java开发的，并作为Apache许可条款下的开放源码发布，是当前流行的企业级搜索引擎。设计用于云计算中，能够 达到实时搜索，稳定，可靠，快速，安装使用方便。"</span> </span><br><span class=line><span class=punctuation>}</span></span><br></pre></table></figure><h4 id=4-2-5-4、删除文档><a class=headerlink href=#4-2-5-4、删除文档 title=4.2.5.4、删除文档></a>4.2.5.4、删除文档</h4><p>请求url：<figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>DELETE localhost:9200/blog1/article/1</span><br></pre></table></figure><h1 id=5、IK分词器><a class=headerlink href=#5、IK分词器 title=5、IK分词器></a>5、IK分词器</h1><h2 id=5-1、问题分析><a class=headerlink href=#5-1、问题分析 title=5.1、问题分析></a>5.1、问题分析</h2><p>当我们创建索引时，字段使用的是标准分词器：<figure class="highlight json"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br></pre><td class=code><pre><span class=line><span class=punctuation>{</span> </span><br><span class=line>	<span class=attr>"mappings"</span><span class=punctuation>:</span> <span class=punctuation>{</span> </span><br><span class=line>		<span class=attr>"article"</span><span class=punctuation>:</span> <span class=punctuation>{</span> </span><br><span class=line>            <span class=attr>"properties"</span><span class=punctuation>:</span> <span class=punctuation>{</span> </span><br><span class=line>                <span class=attr>"id"</span><span class=punctuation>:</span> <span class=punctuation>{</span> </span><br><span class=line>                    <span class=attr>"type"</span><span class=punctuation>:</span> <span class=string>"long"</span><span class=punctuation>,</span> </span><br><span class=line>                    <span class=attr>"store"</span><span class=punctuation>:</span> <span class=literal><span class=keyword>true</span></span><span class=punctuation>,</span><span class=attr>"index"</span><span class=punctuation>:</span><span class=string>"not_analyzed"</span> </span><br><span class=line>                <span class=punctuation>}</span><span class=punctuation>,</span></span><br><span class=line>                <span class=attr>"title"</span><span class=punctuation>:</span> <span class=punctuation>{</span> </span><br><span class=line>                    <span class=attr>"type"</span><span class=punctuation>:</span> <span class=string>"text"</span><span class=punctuation>,</span> </span><br><span class=line>                    <span class=attr>"store"</span><span class=punctuation>:</span> <span class=literal><span class=keyword>true</span></span><span class=punctuation>,</span> </span><br><span class=line>                    <span class=attr>"index"</span><span class=punctuation>:</span><span class=string>"analyzed"</span><span class=punctuation>,</span> </span><br><span class=line>                    <span class=attr>"analyzer"</span><span class=punctuation>:</span><span class=string>"standard"</span> <span class=comment>//标准分词器 </span></span><br><span class=line>                <span class=punctuation>}</span><span class=punctuation>,</span></span><br><span class=line>                <span class=attr>"content"</span><span class=punctuation>:</span> <span class=punctuation>{</span> </span><br><span class=line>                    <span class=attr>"type"</span><span class=punctuation>:</span> <span class=string>"text"</span><span class=punctuation>,</span> </span><br><span class=line>                    <span class=attr>"store"</span><span class=punctuation>:</span> <span class=literal><span class=keyword>true</span></span><span class=punctuation>,</span> </span><br><span class=line>                    <span class=attr>"index"</span><span class=punctuation>:</span><span class=string>"analyzed"</span><span class=punctuation>,</span> </span><br><span class=line>                    <span class=attr>"analyzer"</span><span class=punctuation>:</span><span class=string>"standard"</span> <span class=comment>//标准分词器 </span></span><br><span class=line>                <span class=punctuation>}</span> </span><br><span class=line>            <span class=punctuation>}</span> </span><br><span class=line>        <span class=punctuation>}</span> </span><br><span class=line>    <span class=punctuation>}</span> </span><br><span class=line><span class=punctuation>}</span> </span><br></pre></table></figure><p>例如对 “我是程序员” 进行分词。<p>标准分词器 分词效果 测试：<figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>http://127.0.0.1:9200/_analyze?analyzer=standard&pretty=true&text=我是程序员 </span><br></pre></table></figure><p>分词结果：<figure class="highlight json"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br></pre><td class=code><pre><span class=line><span class=punctuation>{</span> </span><br><span class=line>    <span class=attr>"tokens"</span> <span class=punctuation>:</span> <span class=punctuation>[</span> </span><br><span class=line>        <span class=punctuation>{</span> </span><br><span class=line>            <span class=attr>"token"</span> <span class=punctuation>:</span> <span class=string>"我"</span><span class=punctuation>,</span> </span><br><span class=line>            <span class=attr>"start_offset"</span> <span class=punctuation>:</span> <span class=number>0</span><span class=punctuation>,</span> </span><br><span class=line>            <span class=attr>"end_offset"</span> <span class=punctuation>:</span> <span class=number>1</span><span class=punctuation>,</span> </span><br><span class=line>            <span class=attr>"type"</span> <span class=punctuation>:</span> <span class=string>"&LTIDEOGRAPHIC>"</span><span class=punctuation>,</span> </span><br><span class=line>            <span class=attr>"position"</span> <span class=punctuation>:</span> <span class=number>0</span> </span><br><span class=line>        <span class=punctuation>}</span><span class=punctuation>,</span></span><br><span class=line>        <span class=punctuation>{</span> </span><br><span class=line>            <span class=attr>"token"</span> <span class=punctuation>:</span> <span class=string>"是"</span><span class=punctuation>,</span> </span><br><span class=line>            <span class=attr>"start_offset"</span> <span class=punctuation>:</span> <span class=number>1</span><span class=punctuation>,</span> </span><br><span class=line>            <span class=attr>"end_offset"</span> <span class=punctuation>:</span> <span class=number>2</span><span class=punctuation>,</span> </span><br><span class=line>            <span class=attr>"type"</span> <span class=punctuation>:</span> <span class=string>"&LTIDEOGRAPHIC>"</span><span class=punctuation>,</span> </span><br><span class=line>            <span class=attr>"position"</span> <span class=punctuation>:</span> <span class=number>1</span> </span><br><span class=line>        <span class=punctuation>}</span><span class=punctuation>,</span></span><br><span class=line>        <span class=punctuation>{</span> </span><br><span class=line>            <span class=attr>"token"</span> <span class=punctuation>:</span> <span class=string>"程"</span><span class=punctuation>,</span> </span><br><span class=line>            <span class=attr>"start_offset"</span> <span class=punctuation>:</span> <span class=number>2</span><span class=punctuation>,</span> </span><br><span class=line>            <span class=attr>"end_offset"</span> <span class=punctuation>:</span> <span class=number>3</span><span class=punctuation>,</span> </span><br><span class=line>            <span class=attr>"type"</span> <span class=punctuation>:</span> <span class=string>"&LTIDEOGRAPHIC>"</span><span class=punctuation>,</span> </span><br><span class=line>            <span class=attr>"position"</span> <span class=punctuation>:</span> <span class=number>2</span> </span><br><span class=line>        <span class=punctuation>}</span><span class=punctuation>,</span></span><br><span class=line>        <span class=punctuation>{</span> </span><br><span class=line>            <span class=attr>"token"</span> <span class=punctuation>:</span> <span class=string>"序"</span><span class=punctuation>,</span> </span><br><span class=line>            <span class=attr>"start_offset"</span> <span class=punctuation>:</span> <span class=number>3</span><span class=punctuation>,</span></span><br><span class=line>            <span class=attr>"end_offset"</span> <span class=punctuation>:</span> <span class=number>4</span><span class=punctuation>,</span> </span><br><span class=line>            <span class=attr>"type"</span> <span class=punctuation>:</span> <span class=string>"&LTIDEOGRAPHIC>"</span><span class=punctuation>,</span> </span><br><span class=line>            <span class=attr>"position"</span> <span class=punctuation>:</span> <span class=number>3</span></span><br><span class=line>        <span class=punctuation>}</span><span class=punctuation>,</span></span><br><span class=line>        <span class=punctuation>{</span> </span><br><span class=line>            <span class=attr>"token"</span> <span class=punctuation>:</span> <span class=string>"员"</span><span class=punctuation>,</span> </span><br><span class=line>            <span class=attr>"start_offset"</span> <span class=punctuation>:</span> <span class=number>4</span><span class=punctuation>,</span> </span><br><span class=line>            <span class=attr>"end_offset"</span> <span class=punctuation>:</span> <span class=number>5</span><span class=punctuation>,</span> </span><br><span class=line>            <span class=attr>"type"</span> <span class=punctuation>:</span> <span class=string>"&LTIDEOGRAPHIC>"</span><span class=punctuation>,</span> </span><br><span class=line>            <span class=attr>"position"</span> <span class=punctuation>:</span> <span class=number>4</span></span><br><span class=line>        <span class=punctuation>}</span></span><br><span class=line>	<span class=punctuation>}</span></span><br><span class=line><span class=punctuation>}</span></span><br></pre></table></figure><p>而我们需要的分词效果是：我、是、程序、程序员。<p>这样的话就需要对中文支持良好的分析器的支持，支持中文分词的分词器有很多，word分词器、庖丁解牛、盘古 分词、Ansj分词等，但我们常用的还是下面要介绍的IK分词器。<h2 id=5-2、IK分词器简介><a class=headerlink href=#5-2、IK分词器简介 title=5.2、IK分词器简介></a>5.2、IK分词器简介</h2><p>IKAnalyzer是一个开源的，基于java语言开发的轻量级的中文分词工具包。从2006年12月推出1.0版开始， IKAnalyzer已经推出 了3个大版本。最初，它是以开源项目Lucene为应用主体的，结合词典分词和文法分析算法的 中文分词组件。新版本的IKAnalyzer3.0则发展为 面向Java的公用分词组件，独立于Lucene项目，同时提供了对 Lucene的默认优化实现。<p>IK分词器3.0特性如下：<ol><li>采用了特有的“正向迭代最细粒度切分算法“，具有60万字/秒的高速处理能力。<li>采用了多子处理器分析模 式，支持：英文字母（IP地址、Email、URL）、数字（日期，常用中文数量词，罗马数字，科学计数法），中文 词汇（姓名、地名处理）等分词处理。<li>对中英联合支持不是很好,在这方面的处理比较麻烦.需再做一次查询,同 时是支持个人词条的优化的词典存储，更小的内存占用。<li>支持用户词典扩展定义。<li>针对Lucene全文检索优 化的查询分析器IKQueryParser；采用歧义分析算法优化查询关键字的搜索排列组合，能极大的提高Lucene检索的 命中率。</ol><h2 id=5-3、ES集成IK分词器><a class=headerlink href=#5-3、ES集成IK分词器 title=5.3、ES集成IK分词器></a>5.3、ES集成IK分词器</h2><h3 id=5-3-1、IK分词器安装><a class=headerlink href=#5-3-1、IK分词器安装 title=5.3.1、IK分词器安装></a>5.3.1、IK分词器安装</h3><ol><li>下载地址：<a href=https://github.com/medcl/elasticsearch-analysis-ik/releases%E3%80%82 rel=noopener target=_blank>https://github.com/medcl/elasticsearch-analysis-ik/releases。</a><li>解压，将解压后的elasticsearch文件夹拷贝到elasticsearch-5.6.8\plugins下，并重命名文件夹为analysis-ik。<li>重新启动ElasticSearch，即可加载IK分词器。</ol><h3 id=5-3-2、IK分词器测试><a class=headerlink href=#5-3-2、IK分词器测试 title=5.3.2、IK分词器测试></a>5.3.2、IK分词器测试</h3><p>IK提供了两个分词算法ik_smart 和 ik_max_word<p>其中 ik_smart 为最少切分，ik_max_word为最细粒度划分<p>我们分别来试一下<p>1）最小切分：在浏览器地址栏输入地址<figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>http://127.0.0.1:9200/_analyze?analyzer=ik_smart&pretty=true&text=我是程序员 </span><br></pre></table></figure><p>2）最细切分：在浏览器地址栏输入地址<figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>http://127.0.0.1:9200/_analyze?analyzer=ik_max_word&pretty=true&text=我是程序员 </span><br></pre></table></figure><h2 id=5-4、测试效果><a class=headerlink href=#5-4、测试效果 title=5.4、测试效果></a>5.4、测试效果</h2><h3 id=5-4-1、重建索引><a class=headerlink href=#5-4-1、重建索引 title=5.4.1、重建索引></a>5.4.1、重建索引</h3><p>删除原有blog1索引<figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>DELETE localhost:9200/blog1 </span><br></pre></table></figure><p>创建blog1索引，此时分词器使用ik_max_word<figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>PUT localhost:9200/blog1</span><br></pre></table></figure><figure class="highlight json"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br></pre><td class=code><pre><span class=line><span class=punctuation>{</span> </span><br><span class=line>    <span class=attr>"mappings"</span><span class=punctuation>:</span> <span class=punctuation>{</span> </span><br><span class=line>        <span class=attr>"article"</span><span class=punctuation>:</span> <span class=punctuation>{</span> </span><br><span class=line>            <span class=attr>"properties"</span><span class=punctuation>:</span> <span class=punctuation>{</span> </span><br><span class=line>                <span class=attr>"id"</span><span class=punctuation>:</span> <span class=punctuation>{</span> </span><br><span class=line>                    <span class=attr>"type"</span><span class=punctuation>:</span> <span class=string>"long"</span><span class=punctuation>,</span> </span><br><span class=line>                    <span class=attr>"store"</span><span class=punctuation>:</span> <span class=literal><span class=keyword>true</span></span><span class=punctuation>,</span> </span><br><span class=line>                    <span class=attr>"index"</span><span class=punctuation>:</span><span class=string>"not_analyzed"</span> </span><br><span class=line>                <span class=punctuation>}</span><span class=punctuation>,</span></span><br><span class=line>                <span class=attr>"title"</span><span class=punctuation>:</span> <span class=punctuation>{</span> </span><br><span class=line>                    <span class=attr>"type"</span><span class=punctuation>:</span> <span class=string>"text"</span><span class=punctuation>,</span> </span><br><span class=line>                    <span class=attr>"store"</span><span class=punctuation>:</span> <span class=literal><span class=keyword>true</span></span><span class=punctuation>,</span> </span><br><span class=line>                    <span class=attr>"index"</span><span class=punctuation>:</span><span class=string>"analyzed"</span><span class=punctuation>,</span> </span><br><span class=line>                    <span class=attr>"analyzer"</span><span class=punctuation>:</span><span class=string>"ik_max_word"</span> </span><br><span class=line>                <span class=punctuation>}</span><span class=punctuation>,</span></span><br><span class=line>                <span class=attr>"content"</span><span class=punctuation>:</span> <span class=punctuation>{</span> </span><br><span class=line>                    <span class=attr>"type"</span><span class=punctuation>:</span> <span class=string>"text"</span><span class=punctuation>,</span> </span><br><span class=line>                    <span class=attr>"store"</span><span class=punctuation>:</span> <span class=literal><span class=keyword>true</span></span><span class=punctuation>,</span> </span><br><span class=line>                    <span class=attr>"index"</span><span class=punctuation>:</span><span class=string>"analyzed"</span><span class=punctuation>,</span> </span><br><span class=line>                    <span class=attr>"analyzer"</span><span class=punctuation>:</span><span class=string>"ik_max_word"</span> </span><br><span class=line>                <span class=punctuation>}</span> </span><br><span class=line>            <span class=punctuation>}</span> </span><br><span class=line>        <span class=punctuation>}</span> </span><br><span class=line>    <span class=punctuation>}</span></span><br><span class=line><span class=punctuation>}</span></span><br></pre></table></figure><p>创建文档<figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>POST localhost:9200/blog1/article/1</span><br></pre></table></figure><figure class="highlight json"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line><span class=punctuation>{</span> </span><br><span class=line>    <span class=attr>"id"</span><span class=punctuation>:</span><span class=number>1</span><span class=punctuation>,</span> </span><br><span class=line>    <span class=attr>"title"</span><span class=punctuation>:</span><span class=string>"ElasticSearch是一个基于Lucene的搜索服务器"</span><span class=punctuation>,</span> </span><br><span class=line>    <span class=attr>"content"</span><span class=punctuation>:</span><span class=string>"它提供了一个分布式多用户能力的全文搜索引擎，基于RESTful web接口。Elasticsearch是用Java 开发的，并作为Apache许可条款下的开放源码发布，是当前流行的企业级搜索引擎。设计用于云计算中，能够达到实时 搜索，稳定，可靠，快速，安装使用方便。"</span> </span><br><span class=line><span class=punctuation>}</span></span><br></pre></table></figure><h3 id=5-4-2、测试queryString><a class=headerlink href=#5-4-2、测试queryString title=5.4.2、测试queryString></a>5.4.2、测试queryString</h3><p>请求url：<figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>POST localhost:9200/blog1/article/_search</span><br></pre></table></figure><p>请求体：<figure class="highlight json"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre><td class=code><pre><span class=line><span class=punctuation>{</span> </span><br><span class=line>    <span class=attr>"query"</span><span class=punctuation>:</span> <span class=punctuation>{</span> </span><br><span class=line>        <span class=attr>"query_string"</span><span class=punctuation>:</span> <span class=punctuation>{</span> </span><br><span class=line>            <span class=attr>"default_field"</span><span class=punctuation>:</span> <span class=string>"title"</span><span class=punctuation>,</span> </span><br><span class=line>            <span class=attr>"query"</span><span class=punctuation>:</span> <span class=string>"搜索服务器"</span> </span><br><span class=line>        <span class=punctuation>}</span> </span><br><span class=line>    <span class=punctuation>}</span> </span><br><span class=line><span class=punctuation>}</span></span><br></pre></table></figure><h3 id=5-4-3、测试term><a class=headerlink href=#5-4-3、测试term title=5.4.3、测试term></a>5.4.3、测试term</h3><p>请求url：<figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>POST localhost:9200/blog1/article/_search</span><br></pre></table></figure><p>请求体：<figure class="highlight json"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre><td class=code><pre><span class=line><span class=punctuation>{</span> </span><br><span class=line>    <span class=attr>"query"</span><span class=punctuation>:</span> <span class=punctuation>{</span> </span><br><span class=line>        <span class=attr>"term"</span><span class=punctuation>:</span> <span class=punctuation>{</span> </span><br><span class=line>            <span class=attr>"title"</span><span class=punctuation>:</span> <span class=string>"搜索"</span> </span><br><span class=line>        <span class=punctuation>}</span> </span><br><span class=line>    <span class=punctuation>}</span> </span><br><span class=line><span class=punctuation>}</span></span><br></pre></table></figure><h1 id=Index-API><a title="Index API" class=headerlink href=#Index-API></a>Index API</h1><h2 id=创建索引><a class=headerlink href=#创建索引 title=创建索引></a>创建索引</h2><h3 id=语法><a class=headerlink href=#语法 title=语法></a>语法</h3><figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line><span class=attr>PUT</span> <span class=string>/&LTindex></span></span><br></pre></table></figure><h3 id=路径参数><a class=headerlink href=#路径参数 title=路径参数></a>路径参数</h3><p><code>&LTindex></code>索引名称必须满足以下条件：<ul><li>仅小写<li>不能包含 、、、’ （空格字符）、、<code>\``/``*``?``"``<``>``|``,``#</code><li>7.0 之前的索引可能包含冒号 （），但该冒号已弃用，在 7.0+ 中不受支持<code>:</code><li>不能以 、 开头 ，<code>-``_``+</code><li>不能是或<code>.``..</code><li>不能超过 255 字节（请注意它是字节，因此多字节字符将更快地计入 255 限制）<li>以 开头的名称已被弃用，隐藏索引和插件管理的内部<a href=https://www.elastic.co/guide/en/elasticsearch/reference/7.17/index-modules.html#index-hidden rel=noopener target=_blank>索引</a>除外<code>.</code></ul><h3 id=请求参数><a class=headerlink href=#请求参数 title=请求参数></a>请求参数</h3><ul><li><strong>include_type_name</strong><li><strong>wait_for_active_shards</strong><li><strong>master_timeout</strong>：默认30s。<li><strong>timeout</strong>：默认30s。</ul><h3 id=请求正文><a class=headerlink href=#请求正文 title=请求正文></a>请求正文</h3><ul><li><strong>aliases</strong><ul><li><code>&LTalias></code><ul><li><strong>filter</strong><li><strong>index_routing</strong><li><strong>is_hidden</strong><li><strong>is_write_index</strong><li><strong>routing</strong><li><strong>search_routing</strong></ul></ul><li><strong>mappings</strong><li><strong>settings</strong></ul><h3 id=示例><a class=headerlink href=#示例 title=示例></a>示例</h3><figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br></pre><td class=code><pre><span class=line><span class=attr>PUT</span> <span class=string>/my-index-000001?master_timeout=30s&timeout=30s</span></span><br><span class=line><span class=attr>{</span></span><br><span class=line>  <span class=attr>"settings"</span>: <span class=string>{</span></span><br><span class=line>    <span class=attr>"index"</span>: <span class=string>{</span></span><br><span class=line>      <span class=attr>"number_of_shards"</span>: <span class=string>3,  </span></span><br><span class=line>      <span class=attr>"number_of_replicas"</span>: <span class=string>2 </span></span><br><span class=line>    <span class=attr>}</span></span><br><span class=line>  <span class=attr>},</span></span><br><span class=line>  <span class=attr>"aliases"</span>: <span class=string>{</span></span><br><span class=line>    <span class=attr>"alias_1"</span>: <span class=string>{},</span></span><br><span class=line>    <span class=attr>"alias_2"</span>: <span class=string>{</span></span><br><span class=line>      <span class=attr>"filter"</span>: <span class=string>{</span></span><br><span class=line>        <span class=attr>"term"</span>: <span class=string>{ "user.id": "kimchy" }</span></span><br><span class=line>      <span class=attr>},</span></span><br><span class=line>      <span class=attr>"routing"</span>: <span class=string>"shard-1"</span></span><br><span class=line>    <span class=attr>}</span></span><br><span class=line>  <span class=attr>},</span></span><br><span class=line>  <span class=attr>"mappings"</span>: <span class=string>{</span></span><br><span class=line>    <span class=attr>"properties"</span>: <span class=string>{</span></span><br><span class=line>      <span class=attr>"field1"</span>: <span class=string>{ "type": "text" }</span></span><br><span class=line>    <span class=attr>}</span></span><br><span class=line>  <span class=attr>}</span></span><br><span class=line><span class=attr>}</span></span><br></pre></table></figure><h2 id=创建或更新别名><a class=headerlink href=#创建或更新别名 title=创建或更新别名></a>创建或更新别名</h2><h3 id=语法-1><a class=headerlink href=#语法-1 title=语法></a>语法</h3><figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line><span class=attr>POST</span> <span class=string>&LTtarget>/_alias/&LTalias></span></span><br><span class=line><span class=attr>POST</span> <span class=string>&LTtarget>/_aliases/&LTalias></span></span><br><span class=line><span class=attr>PUT</span> <span class=string>&LTtarget>/_alias/&LTalias></span></span><br><span class=line><span class=attr>PUT</span> <span class=string>&LTtarget>/_aliases/&LTalias></span></span><br></pre></table></figure><h3 id=路径参数-1><a class=headerlink href=#路径参数-1 title=路径参数></a>路径参数</h3><ul><li><code>&LTalias></code>：必需，要更新的别名，若别名不存在则创建它。<li><code>&LTtarget></code>：必需，数据量或索引，多个之间用逗号隔开。</ul><h3 id=查询参数><a class=headerlink href=#查询参数 title=查询参数></a>查询参数</h3><ul><li><strong>master_timeout</strong>：可选。<li><strong>timeout</strong>：可选。</ul><h3 id=请求体><a class=headerlink href=#请求体 title=请求体></a>请求体</h3><ul><li><strong>filter</strong>：可选。<li><strong>index_routing</strong>：可选。<li><strong>is_hidden</strong>：可选。<li><strong>is_write_index</strong>：可选。<li><strong>routing</strong>：可选。<li><strong>search_routing</strong>：可选。</ul><h2 id=删除索引><a class=headerlink href=#删除索引 title=删除索引></a>删除索引</h2><h3 id=语法-2><a class=headerlink href=#语法-2 title=语法></a>语法</h3><figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line><span class=attr>DELETE</span> <span class=string>/&LTindex></span></span><br></pre></table></figure><h3 id=路径参数-2><a class=headerlink href=#路径参数-2 title=路径参数></a>路径参数</h3><ul><li><code>&LTindex></code>：必填，要删除的索引，多个用逗号隔开。</ul><h3 id=查询参数-1><a class=headerlink href=#查询参数-1 title=查询参数></a>查询参数</h3><ul><li><strong>allow_no_indices</strong><li><strong>expand_wildcards</strong><li><strong>ignore_unavailable</strong><li><strong>master_timeout</strong><li><strong>timeout</strong></ul><h2 id=删除别名><a class=headerlink href=#删除别名 title=删除别名></a>删除别名</h2><h3 id=语法-3><a class=headerlink href=#语法-3 title=语法></a>语法</h3><figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line><span class=attr>DELETE</span> <span class=string>&LTtarget>/_alias/&LTalias></span></span><br><span class=line><span class=attr>DELETE</span> <span class=string>&LTtarget>/_aliases/&LTalias></span></span><br></pre></table></figure><h3 id=路径参数-3><a class=headerlink href=#路径参数-3 title=路径参数></a>路径参数</h3><ul><li><code>&LTalias></code>（必填）：要删除的别名，多个用逗号隔开。<li><code>&LTtarget>（必填）</code>：用于限制的数据流或索引，多个用逗号隔开。</ul><h3 id=查询参数-2><a class=headerlink href=#查询参数-2 title=查询参数></a>查询参数</h3><ul><li><strong>master_timeout</strong><li><strong>timeout</strong></ul><h2 id=是否存在><a class=headerlink href=#是否存在 title=是否存在></a>是否存在</h2><h3 id=语法-4><a class=headerlink href=#语法-4 title=语法></a>语法</h3><figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line><span class=attr>HEAD</span> <span class=string>&LTtarget></span></span><br></pre></table></figure><h3 id=路径参数-4><a class=headerlink href=#路径参数-4 title=路径参数></a>路径参数</h3><ul><li><code>&LTtarget></code>：数据流、索引、别名，多个用逗号隔开。</ul><h3 id=查询参数-3><a class=headerlink href=#查询参数-3 title=查询参数></a>查询参数</h3><ul><li><strong>allow_no_indices</strong>：默认true。<li><strong>expand_wildcards</strong><ul><li>all<li>open（默认）<li>closed<li>hidden<li>none</ul><li><strong>flat_settings</strong><li><strong>include_defaults</strong><li><strong>ignore_unavailable</strong><li><strong>local</strong></ul><h2 id=获取字段映射><a class=headerlink href=#获取字段映射 title=获取字段映射></a>获取字段映射</h2><h3 id=语法-5><a class=headerlink href=#语法-5 title=语法></a>语法</h3><figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line><span class=attr>GET</span> <span class=string>/_mapping/field/&LTfield></span></span><br><span class=line><span class=attr>GET</span> <span class=string>/&LTtarget>/_mapping/field/&LTfield></span></span><br></pre></table></figure><h3 id=路径参数-5><a class=headerlink href=#路径参数-5 title=路径参数></a>路径参数</h3><ul><li><strong><target> <li><strong><field> <h3 id=查询参数-4><a class=headerlink href=#查询参数-4 title=查询参数></a>查询参数</h3><ul><li><strong>allow_no_indices</strong><li><strong>expand_wildcards</strong><ul><li>all<li>open<li>closed<li>hidden<li>none</ul><li><strong>include_type_name</strong><li><strong>ignore_unavailable</strong><li><strong>include_defaults</strong><li><strong>local</strong></ul> <h2 id=获取索引><a class=headerlink href=#获取索引 title=获取索引></a>获取索引</h2><h3 id=语法-6><a class=headerlink href=#语法-6 title=语法></a>语法</h3><figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line><span class=attr>GET</span> <span class=string>/&LTtarget></span></span><br></pre></table></figure> <h3 id=路径参数-6><a class=headerlink href=#路径参数-6 title=路径参数></a>路径参数</h3><ul><li><strong><target> <h3 id=查询参数-5><a class=headerlink href=#查询参数-5 title=查询参数></a>查询参数</h3><ul><li><strong>allow_no_indices</strong><li><strong>expand_wildcards</strong><ul><li>all<li>open<li>closed<li>hidden<li>none</ul><li><strong>flat_settings</strong><li><strong>include_defaults</strong><li><strong>include_type_name</strong><li><strong>ignore_unavailable</strong><li><strong>local</strong><li><strong>master_timeout</strong></ul> <h2 id=获取映射><a class=headerlink href=#获取映射 title=获取映射></a>获取映射</h2><h3 id=语法-7><a class=headerlink href=#语法-7 title=语法></a>语法</h3><figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line><span class=attr>GET</span> <span class=string>/_mapping</span></span><br><span class=line><span class=attr>GET</span> <span class=string>/&LTtarget>/_mapping</span></span><br></pre></table></figure> <h3 id=路径参数-7><a class=headerlink href=#路径参数-7 title=路径参数></a>路径参数</h3><ul><li>**<target>**：数据流、索引和别名的逗号分隔列表，用于限制请求。支持通配符 （）。 <h3 id=查询参数-6><a class=headerlink href=#查询参数-6 title=查询参数></a>查询参数</h3><ul><li><strong>allow_no_indices</strong><li><strong>expand_wildcards</strong><ul><li>all<li>open（默认）<li>closed<li>hidden<li>none</ul><li><strong>include_type_name</strong><li><strong>ignore_unavailable</strong><li><strong>local</strong><li><strong>master_timeout</strong></ul> <h2 id=更新映射><a class=headerlink href=#更新映射 title=更新映射></a>更新映射</h2><h3 id=语法-8><a class=headerlink href=#语法-8 title=语法></a>语法</h3><figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line><span class=attr>PUT</span> <span class=string>/&LTtarget>/_mapping</span></span><br></pre></table></figure> <h3 id=路径参数-8><a class=headerlink href=#路径参数-8 title=路径参数></a>路径参数</h3><ul><li><code>&LTtarget>（必填）</code>：数据流、索引和别名的逗号分隔列表，用于限制请求。支持通配符（）。</ul> <h3 id=查询参数-7><a class=headerlink href=#查询参数-7 title=查询参数></a>查询参数</h3><ul><li><strong>allow_no_indices</strong><li><strong>expand_wildcards</strong><ul><li>all<li>open<li>closed<li>hidden<li>none</ul><li><strong>include_type_name</strong><li><strong>ignore_unavailable</strong><li><strong>master_timeout</strong><li><strong>timeout</strong><li><strong>write_index_only</strong></ul> <h3 id=请求体-1><a class=headerlink href=#请求体-1 title=请求体></a>请求体</h3><ul><li><strong>properties（必填）</strong>：字段的映射。</ul> <h3 id=示例-1><a class=headerlink href=#示例-1 title=示例></a>示例</h3><p>（1）单个目标</p> <figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre><td class=code><pre><span class=line><span class=attr>PUT</span> <span class=string>/publications/_mapping</span></span><br><span class=line><span class=attr>{</span></span><br><span class=line>  <span class=attr>"properties"</span>: <span class=string>{</span></span><br><span class=line>    <span class=attr>"title"</span>:  <span class=string>{ "type": "text"}</span></span><br><span class=line>  <span class=attr>}</span></span><br><span class=line><span class=attr>}</span></span><br></pre></table></figure> <p>（2）多个目标</p> <figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br></pre><td class=code><pre><span class=line><span class=comment># Create the two indices</span></span><br><span class=line><span class=attr>PUT</span> <span class=string>/my-index-000001</span></span><br><span class=line><span class=attr>PUT</span> <span class=string>/my-index-000002</span></span><br><span class=line><span class=comment></span></span><br><span class=line><span class=comment># Update both mappings</span></span><br><span class=line><span class=attr>PUT</span> <span class=string>/my-index-000001,my-index-000002/_mapping</span></span><br><span class=line><span class=attr>{</span></span><br><span class=line>  <span class=attr>"properties"</span>: <span class=string>{</span></span><br><span class=line>    <span class=attr>"user"</span>: <span class=string>{</span></span><br><span class=line>      <span class=attr>"properties"</span>: <span class=string>{</span></span><br><span class=line>        <span class=attr>"name"</span>: <span class=string>{</span></span><br><span class=line>          <span class=attr>"type"</span>: <span class=string>"keyword"</span></span><br><span class=line>        <span class=attr>}</span></span><br><span class=line>      <span class=attr>}</span></span><br><span class=line>    <span class=attr>}</span></span><br><span class=line>  <span class=attr>}</span></span><br><span class=line><span class=attr>}</span></span><br></pre></table></figure> <p>（3）为已存在字段添加新属性</p> <figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br></pre><td class=code><pre><span class=line><span class=attr>PUT</span> <span class=string>/my-index-000001</span></span><br><span class=line><span class=attr>{</span></span><br><span class=line>  <span class=attr>"mappings"</span>: <span class=string>{</span></span><br><span class=line>    <span class=attr>"properties"</span>: <span class=string>{</span></span><br><span class=line>      <span class=attr>"name"</span>: <span class=string>{</span></span><br><span class=line>        <span class=attr>"properties"</span>: <span class=string>{</span></span><br><span class=line>          <span class=attr>"first"</span>: <span class=string>{</span></span><br><span class=line>            <span class=attr>"type"</span>: <span class=string>"text"</span></span><br><span class=line>          <span class=attr>}</span></span><br><span class=line>        <span class=attr>}</span></span><br><span class=line>      <span class=attr>}</span></span><br><span class=line>    <span class=attr>}</span></span><br><span class=line>  <span class=attr>}</span></span><br><span class=line><span class=attr>}</span></span><br><span class=line></span><br><span class=line><span class=attr>---</span></span><br><span class=line></span><br><span class=line><span class=attr>PUT</span> <span class=string>/my-index-000001/_mapping</span></span><br><span class=line><span class=attr>{</span></span><br><span class=line>  <span class=attr>"properties"</span>: <span class=string>{</span></span><br><span class=line>    <span class=attr>"name"</span>: <span class=string>{</span></span><br><span class=line>      <span class=attr>"properties"</span>: <span class=string>{</span></span><br><span class=line>        <span class=attr>"last"</span>: <span class=string>{</span></span><br><span class=line>          <span class=attr>"type"</span>: <span class=string>"text"</span></span><br><span class=line>        <span class=attr>}</span></span><br><span class=line>      <span class=attr>}</span></span><br><span class=line>    <span class=attr>}</span></span><br><span class=line>  <span class=attr>}</span></span><br><span class=line><span class=attr>}</span></span><br></pre></table></figure> <p>（4）为已存在字段添加子字段</p> <figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br></pre><td class=code><pre><span class=line><span class=attr>PUT</span> <span class=string>/my-index-000001</span></span><br><span class=line><span class=attr>{</span></span><br><span class=line>  <span class=attr>"mappings"</span>: <span class=string>{</span></span><br><span class=line>    <span class=attr>"properties"</span>: <span class=string>{</span></span><br><span class=line>      <span class=attr>"city"</span>: <span class=string>{</span></span><br><span class=line>        <span class=attr>"type"</span>: <span class=string>"text"</span></span><br><span class=line>      <span class=attr>}</span></span><br><span class=line>    <span class=attr>}</span></span><br><span class=line>  <span class=attr>}</span></span><br><span class=line><span class=attr>}</span></span><br><span class=line></span><br><span class=line><span class=attr>---</span></span><br><span class=line></span><br><span class=line><span class=attr>PUT</span> <span class=string>/my-index-000001/_mapping</span></span><br><span class=line><span class=attr>{</span></span><br><span class=line>  <span class=attr>"properties"</span>: <span class=string>{</span></span><br><span class=line>    <span class=attr>"city"</span>: <span class=string>{</span></span><br><span class=line>      <span class=attr>"type"</span>: <span class=string>"text",</span></span><br><span class=line>      <span class=attr>"fields"</span>: <span class=string>{</span></span><br><span class=line>        <span class=attr>"raw"</span>: <span class=string>{</span></span><br><span class=line>          <span class=attr>"type"</span>: <span class=string>"keyword"</span></span><br><span class=line>        <span class=attr>}</span></span><br><span class=line>      <span class=attr>}</span></span><br><span class=line>    <span class=attr>}</span></span><br><span class=line>  <span class=attr>}</span></span><br><span class=line><span class=attr>}</span></span><br></pre></table></figure> <p>（5）更改已存在字段支持的属性</p> <figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br></pre><td class=code><pre><span class=line><span class=attr>PUT</span> <span class=string>/my-index-000001</span></span><br><span class=line><span class=attr>{</span></span><br><span class=line>  <span class=attr>"mappings"</span>: <span class=string>{</span></span><br><span class=line>    <span class=attr>"properties"</span>: <span class=string>{</span></span><br><span class=line>      <span class=attr>"user_id"</span>: <span class=string>{</span></span><br><span class=line>        <span class=attr>"type"</span>: <span class=string>"keyword",</span></span><br><span class=line>        <span class=attr>"ignore_above"</span>: <span class=string>20</span></span><br><span class=line>      <span class=attr>}</span></span><br><span class=line>    <span class=attr>}</span></span><br><span class=line>  <span class=attr>}</span></span><br><span class=line><span class=attr>}</span></span><br><span class=line></span><br><span class=line><span class=attr>---</span></span><br><span class=line></span><br><span class=line><span class=attr>PUT</span> <span class=string>/my-index-000001/_mapping</span></span><br><span class=line><span class=attr>{</span></span><br><span class=line>  <span class=attr>"properties"</span>: <span class=string>{</span></span><br><span class=line>    <span class=attr>"user_id"</span>: <span class=string>{</span></span><br><span class=line>      <span class=attr>"type"</span>: <span class=string>"keyword",</span></span><br><span class=line>      <span class=attr>"ignore_above"</span>: <span class=string>100</span></span><br><span class=line>    <span class=attr>}</span></span><br><span class=line>  <span class=attr>}</span></span><br><span class=line><span class=attr>}</span></span><br></pre></table></figure> <p>（6）更改已存在字段的映射</p> <figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br></pre><td class=code><pre><span class=line><span class=attr>PUT</span> <span class=string>/my-index-000001</span></span><br><span class=line><span class=attr>{</span></span><br><span class=line>  <span class=attr>"mappings"</span> : <span class=string>{</span></span><br><span class=line>    <span class=attr>"properties"</span>: <span class=string>{</span></span><br><span class=line>      <span class=attr>"user_id"</span>: <span class=string>{</span></span><br><span class=line>        <span class=attr>"type"</span>: <span class=string>"long"</span></span><br><span class=line>      <span class=attr>}</span></span><br><span class=line>    <span class=attr>}</span></span><br><span class=line>  <span class=attr>}</span></span><br><span class=line><span class=attr>}</span></span><br><span class=line></span><br><span class=line><span class=attr>---</span></span><br><span class=line></span><br><span class=line><span class=attr>POST</span> <span class=string>/my-index-000001/_doc?refresh=wait_for</span></span><br><span class=line><span class=attr>{</span></span><br><span class=line>  <span class=attr>"user_id"</span> : <span class=string>12345</span></span><br><span class=line><span class=attr>}</span></span><br><span class=line></span><br><span class=line><span class=attr>POST</span> <span class=string>/my-index-000001/_doc?refresh=wait_for</span></span><br><span class=line><span class=attr>{</span></span><br><span class=line>  <span class=attr>"user_id"</span> : <span class=string>12346</span></span><br><span class=line><span class=attr>}</span></span><br><span class=line></span><br><span class=line><span class=attr>---</span></span><br><span class=line></span><br><span class=line><span class=attr>PUT</span> <span class=string>/my-new-index-000001</span></span><br><span class=line><span class=attr>{</span></span><br><span class=line>  <span class=attr>"mappings"</span> : <span class=string>{</span></span><br><span class=line>    <span class=attr>"properties"</span>: <span class=string>{</span></span><br><span class=line>      <span class=attr>"user_id"</span>: <span class=string>{</span></span><br><span class=line>        <span class=attr>"type"</span>: <span class=string>"keyword"</span></span><br><span class=line>      <span class=attr>}</span></span><br><span class=line>    <span class=attr>}</span></span><br><span class=line>  <span class=attr>}</span></span><br><span class=line><span class=attr>}</span></span><br><span class=line></span><br><span class=line><span class=attr>---</span></span><br><span class=line></span><br><span class=line><span class=attr>POST</span> <span class=string>/_reindex</span></span><br><span class=line><span class=attr>{</span></span><br><span class=line>  <span class=attr>"source"</span>: <span class=string>{</span></span><br><span class=line>    <span class=attr>"index"</span>: <span class=string>"my-index-000001"</span></span><br><span class=line>  <span class=attr>},</span></span><br><span class=line>  <span class=attr>"dest"</span>: <span class=string>{</span></span><br><span class=line>    <span class=attr>"index"</span>: <span class=string>"my-new-index-000001"</span></span><br><span class=line>  <span class=attr>}</span></span><br><span class=line><span class=attr>}</span></span><br></pre></table></figure> <p>（7）重命名字段</p> <figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br></pre><td class=code><pre><span class=line><span class=attr>PUT</span> <span class=string>/my-index-000001</span></span><br><span class=line><span class=attr>{</span></span><br><span class=line>  <span class=attr>"mappings"</span>: <span class=string>{</span></span><br><span class=line>    <span class=attr>"properties"</span>: <span class=string>{</span></span><br><span class=line>      <span class=attr>"user_identifier"</span>: <span class=string>{</span></span><br><span class=line>        <span class=attr>"type"</span>: <span class=string>"keyword"</span></span><br><span class=line>      <span class=attr>}</span></span><br><span class=line>    <span class=attr>}</span></span><br><span class=line>  <span class=attr>}</span></span><br><span class=line><span class=attr>}</span></span><br><span class=line></span><br><span class=line><span class=attr>---</span></span><br><span class=line></span><br><span class=line><span class=attr>PUT</span> <span class=string>/my-index-000001/_mapping</span></span><br><span class=line><span class=attr>{</span></span><br><span class=line>  <span class=attr>"properties"</span>: <span class=string>{</span></span><br><span class=line>    <span class=attr>"user_id"</span>: <span class=string>{</span></span><br><span class=line>      <span class=attr>"type"</span>: <span class=string>"alias",</span></span><br><span class=line>      <span class=attr>"path"</span>: <span class=string>"user_identifier"</span></span><br><span class=line>    <span class=attr>}</span></span><br><span class=line>  <span class=attr>}</span></span><br><span class=line><span class=attr>}</span></span><br></pre></table></figure> <h1 id=Kibana-Dev-Tools-Console><a title="Kibana Dev Tools Console" class=headerlink href=#Kibana-Dev-Tools-Console></a>Kibana Dev Tools Console</h1><h2 id=测试命令备份><a class=headerlink href=#测试命令备份 title=测试命令备份></a>测试命令备份</h2><figure class="highlight json"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br><span class=line>61</span><br><span class=line>62</span><br><span class=line>63</span><br><span class=line>64</span><br><span class=line>65</span><br><span class=line>66</span><br><span class=line>67</span><br><span class=line>68</span><br><span class=line>69</span><br><span class=line>70</span><br><span class=line>71</span><br><span class=line>72</span><br><span class=line>73</span><br><span class=line>74</span><br><span class=line>75</span><br><span class=line>76</span><br><span class=line>77</span><br><span class=line>78</span><br><span class=line>79</span><br><span class=line>80</span><br><span class=line>81</span><br><span class=line>82</span><br><span class=line>83</span><br><span class=line>84</span><br><span class=line>85</span><br><span class=line>86</span><br><span class=line>87</span><br><span class=line>88</span><br><span class=line>89</span><br><span class=line>90</span><br><span class=line>91</span><br><span class=line>92</span><br><span class=line>93</span><br><span class=line>94</span><br><span class=line>95</span><br><span class=line>96</span><br><span class=line>97</span><br><span class=line>98</span><br><span class=line>99</span><br><span class=line>100</span><br><span class=line>101</span><br><span class=line>102</span><br><span class=line>103</span><br><span class=line>104</span><br><span class=line>105</span><br><span class=line>106</span><br><span class=line>107</span><br><span class=line>108</span><br><span class=line>109</span><br><span class=line>110</span><br><span class=line>111</span><br><span class=line>112</span><br><span class=line>113</span><br><span class=line>114</span><br><span class=line>115</span><br><span class=line>116</span><br><span class=line>117</span><br><span class=line>118</span><br><span class=line>119</span><br><span class=line>120</span><br><span class=line>121</span><br><span class=line>122</span><br><span class=line>123</span><br><span class=line>124</span><br><span class=line>125</span><br><span class=line>126</span><br><span class=line>127</span><br><span class=line>128</span><br><span class=line>129</span><br><span class=line>130</span><br><span class=line>131</span><br><span class=line>132</span><br><span class=line>133</span><br><span class=line>134</span><br><span class=line>135</span><br><span class=line>136</span><br><span class=line>137</span><br><span class=line>138</span><br><span class=line>139</span><br><span class=line>140</span><br><span class=line>141</span><br><span class=line>142</span><br><span class=line>143</span><br><span class=line>144</span><br><span class=line>145</span><br><span class=line>146</span><br><span class=line>147</span><br><span class=line>148</span><br><span class=line>149</span><br><span class=line>150</span><br><span class=line>151</span><br><span class=line>152</span><br><span class=line>153</span><br><span class=line>154</span><br><span class=line>155</span><br><span class=line>156</span><br><span class=line>157</span><br><span class=line>158</span><br><span class=line>159</span><br><span class=line>160</span><br><span class=line>161</span><br><span class=line>162</span><br><span class=line>163</span><br><span class=line>164</span><br><span class=line>165</span><br><span class=line>166</span><br><span class=line>167</span><br><span class=line>168</span><br><span class=line>169</span><br><span class=line>170</span><br><span class=line>171</span><br><span class=line>172</span><br><span class=line>173</span><br><span class=line>174</span><br><span class=line>175</span><br><span class=line>176</span><br><span class=line>177</span><br><span class=line>178</span><br><span class=line>179</span><br><span class=line>180</span><br><span class=line>181</span><br><span class=line>182</span><br><span class=line>183</span><br><span class=line>184</span><br><span class=line>185</span><br><span class=line>186</span><br><span class=line>187</span><br><span class=line>188</span><br><span class=line>189</span><br><span class=line>190</span><br><span class=line>191</span><br><span class=line>192</span><br><span class=line>193</span><br><span class=line>194</span><br><span class=line>195</span><br><span class=line>196</span><br><span class=line>197</span><br><span class=line>198</span><br><span class=line>199</span><br><span class=line>200</span><br><span class=line>201</span><br><span class=line>202</span><br><span class=line>203</span><br><span class=line>204</span><br><span class=line>205</span><br><span class=line>206</span><br><span class=line>207</span><br><span class=line>208</span><br><span class=line>209</span><br><span class=line>210</span><br><span class=line>211</span><br><span class=line>212</span><br><span class=line>213</span><br><span class=line>214</span><br><span class=line>215</span><br><span class=line>216</span><br><span class=line>217</span><br><span class=line>218</span><br><span class=line>219</span><br><span class=line>220</span><br><span class=line>221</span><br><span class=line>222</span><br><span class=line>223</span><br><span class=line>224</span><br><span class=line>225</span><br><span class=line>226</span><br><span class=line>227</span><br><span class=line>228</span><br><span class=line>229</span><br><span class=line>230</span><br><span class=line>231</span><br><span class=line>232</span><br><span class=line>233</span><br><span class=line>234</span><br><span class=line>235</span><br><span class=line>236</span><br><span class=line>237</span><br><span class=line>238</span><br><span class=line>239</span><br><span class=line>240</span><br><span class=line>241</span><br><span class=line>242</span><br><span class=line>243</span><br><span class=line>244</span><br><span class=line>245</span><br><span class=line>246</span><br><span class=line>247</span><br><span class=line>248</span><br><span class=line>249</span><br><span class=line>250</span><br><span class=line>251</span><br><span class=line>252</span><br><span class=line>253</span><br><span class=line>254</span><br><span class=line>255</span><br><span class=line>256</span><br><span class=line>257</span><br><span class=line>258</span><br><span class=line>259</span><br><span class=line>260</span><br><span class=line>261</span><br><span class=line>262</span><br><span class=line>263</span><br><span class=line>264</span><br><span class=line>265</span><br><span class=line>266</span><br><span class=line>267</span><br><span class=line>268</span><br><span class=line>269</span><br><span class=line>270</span><br><span class=line>271</span><br><span class=line>272</span><br><span class=line>273</span><br><span class=line>274</span><br><span class=line>275</span><br><span class=line>276</span><br><span class=line>277</span><br><span class=line>278</span><br><span class=line>279</span><br><span class=line>280</span><br><span class=line>281</span><br><span class=line>282</span><br><span class=line>283</span><br><span class=line>284</span><br><span class=line>285</span><br><span class=line>286</span><br><span class=line>287</span><br><span class=line>288</span><br><span class=line>289</span><br><span class=line>290</span><br><span class=line>291</span><br><span class=line>292</span><br><span class=line>293</span><br><span class=line>294</span><br><span class=line>295</span><br><span class=line>296</span><br><span class=line>297</span><br><span class=line>298</span><br><span class=line>299</span><br><span class=line>300</span><br><span class=line>301</span><br><span class=line>302</span><br><span class=line>303</span><br><span class=line>304</span><br><span class=line>305</span><br><span class=line>306</span><br><span class=line>307</span><br><span class=line>308</span><br><span class=line>309</span><br><span class=line>310</span><br><span class=line>311</span><br><span class=line>312</span><br><span class=line>313</span><br><span class=line>314</span><br><span class=line>315</span><br><span class=line>316</span><br><span class=line>317</span><br><span class=line>318</span><br><span class=line>319</span><br><span class=line>320</span><br><span class=line>321</span><br><span class=line>322</span><br><span class=line>323</span><br><span class=line>324</span><br><span class=line>325</span><br><span class=line>326</span><br><span class=line>327</span><br><span class=line>328</span><br><span class=line>329</span><br><span class=line>330</span><br><span class=line>331</span><br><span class=line>332</span><br><span class=line>333</span><br><span class=line>334</span><br><span class=line>335</span><br><span class=line>336</span><br><span class=line>337</span><br><span class=line>338</span><br><span class=line>339</span><br><span class=line>340</span><br><span class=line>341</span><br><span class=line>342</span><br><span class=line>343</span><br><span class=line>344</span><br><span class=line>345</span><br><span class=line>346</span><br><span class=line>347</span><br><span class=line>348</span><br><span class=line>349</span><br><span class=line>350</span><br><span class=line>351</span><br><span class=line>352</span><br><span class=line>353</span><br><span class=line>354</span><br><span class=line>355</span><br><span class=line>356</span><br><span class=line>357</span><br><span class=line>358</span><br><span class=line>359</span><br><span class=line>360</span><br><span class=line>361</span><br><span class=line>362</span><br><span class=line>363</span><br><span class=line>364</span><br><span class=line>365</span><br><span class=line>366</span><br><span class=line>367</span><br><span class=line>368</span><br><span class=line>369</span><br><span class=line>370</span><br><span class=line>371</span><br><span class=line>372</span><br><span class=line>373</span><br><span class=line>374</span><br><span class=line>375</span><br><span class=line>376</span><br><span class=line>377</span><br><span class=line>378</span><br><span class=line>379</span><br><span class=line>380</span><br><span class=line>381</span><br><span class=line>382</span><br><span class=line>383</span><br><span class=line>384</span><br><span class=line>385</span><br><span class=line>386</span><br><span class=line>387</span><br><span class=line>388</span><br><span class=line>389</span><br><span class=line>390</span><br><span class=line>391</span><br><span class=line>392</span><br><span class=line>393</span><br><span class=line>394</span><br><span class=line>395</span><br><span class=line>396</span><br><span class=line>397</span><br><span class=line>398</span><br><span class=line>399</span><br><span class=line>400</span><br><span class=line>401</span><br><span class=line>402</span><br><span class=line>403</span><br><span class=line>404</span><br><span class=line>405</span><br><span class=line>406</span><br><span class=line>407</span><br><span class=line>408</span><br><span class=line>409</span><br><span class=line>410</span><br><span class=line>411</span><br><span class=line>412</span><br><span class=line>413</span><br><span class=line>414</span><br><span class=line>415</span><br><span class=line>416</span><br><span class=line>417</span><br><span class=line>418</span><br><span class=line>419</span><br><span class=line>420</span><br><span class=line>421</span><br><span class=line>422</span><br><span class=line>423</span><br><span class=line>424</span><br><span class=line>425</span><br><span class=line>426</span><br><span class=line>427</span><br><span class=line>428</span><br><span class=line>429</span><br><span class=line>430</span><br><span class=line>431</span><br><span class=line>432</span><br><span class=line>433</span><br><span class=line>434</span><br><span class=line>435</span><br><span class=line>436</span><br><span class=line>437</span><br><span class=line>438</span><br><span class=line>439</span><br><span class=line>440</span><br><span class=line>441</span><br><span class=line>442</span><br><span class=line>443</span><br><span class=line>444</span><br><span class=line>445</span><br><span class=line>446</span><br><span class=line>447</span><br><span class=line>448</span><br><span class=line>449</span><br><span class=line>450</span><br><span class=line>451</span><br><span class=line>452</span><br><span class=line>453</span><br><span class=line>454</span><br><span class=line>455</span><br><span class=line>456</span><br><span class=line>457</span><br><span class=line>458</span><br><span class=line>459</span><br><span class=line>460</span><br></pre><td class=code><pre><span class=line># es信息</span><br><span class=line>GET /</span><br><span class=line></span><br><span class=line># 查询所有已存在的index信息</span><br><span class=line>GET /_cat/indices</span><br><span class=line></span><br><span class=line># 查询某个index的mapping（文档结构）信息</span><br><span class=line>GET /hotel</span><br><span class=line></span><br><span class=line># 查询某个index的document（文档）信息</span><br><span class=line>GET /hotel/_search</span><br><span class=line></span><br><span class=line># 查询所有index和文档信息（查询所有数据，速度较慢）</span><br><span class=line>GET _search</span><br><span class=line></span><br><span class=line></span><br><span class=line></span><br><span class=line>#====================================mapping</span><br><span class=line># 查询所有已存在的index信息</span><br><span class=line>GET /_cat/indices</span><br><span class=line></span><br><span class=line># 查询某个index是否存在</span><br><span class=line>HEAD /hotel</span><br><span class=line></span><br><span class=line># 查询某个index的mapping信息</span><br><span class=line>GET /hotel</span><br><span class=line></span><br><span class=line># 创建一个mapping</span><br><span class=line>PUT /my-index<span class=number>-000001</span></span><br><span class=line><span class=punctuation>{</span></span><br><span class=line>  <span class=attr>"mappings"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>    <span class=attr>"properties"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>      <span class=attr>"age"</span><span class=punctuation>:</span>    <span class=punctuation>{</span> <span class=attr>"type"</span><span class=punctuation>:</span> <span class=string>"integer"</span> <span class=punctuation>}</span><span class=punctuation>,</span>  </span><br><span class=line>      <span class=attr>"email"</span><span class=punctuation>:</span>  <span class=punctuation>{</span> <span class=attr>"type"</span><span class=punctuation>:</span> <span class=string>"keyword"</span>  <span class=punctuation>}</span><span class=punctuation>,</span> </span><br><span class=line>      <span class=attr>"name"</span><span class=punctuation>:</span>   <span class=punctuation>{</span> <span class=attr>"type"</span><span class=punctuation>:</span> <span class=string>"text"</span>  <span class=punctuation>}</span>     </span><br><span class=line>    <span class=punctuation>}</span></span><br><span class=line>  <span class=punctuation>}</span></span><br><span class=line><span class=punctuation>}</span></span><br><span class=line></span><br><span class=line># 向现有映射中添加字段</span><br><span class=line>PUT /my-index<span class=number>-000001</span>/_mapping</span><br><span class=line><span class=punctuation>{</span></span><br><span class=line>  <span class=attr>"properties"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>    <span class=attr>"employee-id"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>      <span class=attr>"type"</span><span class=punctuation>:</span> <span class=string>"keyword"</span><span class=punctuation>,</span></span><br><span class=line>      <span class=attr>"index"</span><span class=punctuation>:</span> <span class=literal><span class=keyword>false</span></span></span><br><span class=line>    <span class=punctuation>}</span></span><br><span class=line>  <span class=punctuation>}</span></span><br><span class=line><span class=punctuation>}</span></span><br><span class=line></span><br><span class=line># 查询已存在的mapping信息</span><br><span class=line>GET /my-index<span class=number>-000001</span>/_mapping</span><br><span class=line></span><br><span class=line># 查询mapping中某个字段的信息</span><br><span class=line>GET /my-index<span class=number>-000001</span>/_mapping/field/employee-id</span><br><span class=line></span><br><span class=line># 创建mapping并基于bulk api 一次添加多条数据</span><br><span class=line>PUT /my-index<span class=number>-000002</span>/</span><br><span class=line><span class=punctuation>{</span></span><br><span class=line>  <span class=attr>"mappings"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>    <span class=attr>"properties"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>      <span class=attr>"@timestamp"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>        <span class=attr>"format"</span><span class=punctuation>:</span> <span class=string>"strict_date_optional_time||epoch_second"</span><span class=punctuation>,</span></span><br><span class=line>        <span class=attr>"type"</span><span class=punctuation>:</span> <span class=string>"date"</span></span><br><span class=line>      <span class=punctuation>}</span><span class=punctuation>,</span></span><br><span class=line>      <span class=attr>"message"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>        <span class=attr>"type"</span><span class=punctuation>:</span> <span class=string>"wildcard"</span></span><br><span class=line>      <span class=punctuation>}</span></span><br><span class=line>    <span class=punctuation>}</span></span><br><span class=line>  <span class=punctuation>}</span></span><br><span class=line><span class=punctuation>}</span></span><br><span class=line># 为mapping一次添加多条数据</span><br><span class=line>POST /my-index<span class=number>-000002</span>/_bulk?refresh</span><br><span class=line><span class=punctuation>{</span><span class=attr>"index"</span><span class=punctuation>:</span><span class=punctuation>{</span><span class=punctuation>}</span><span class=punctuation>}</span></span><br><span class=line><span class=punctuation>{</span><span class=attr>"timestamp"</span><span class=punctuation>:</span><span class=string>"2020-04-30T14:30:17-05:00"</span><span class=punctuation>,</span><span class=attr>"message"</span><span class=punctuation>:</span><span class=string>"40.135.0.0 - - [30/Apr/2020:14:30:17 -0500] \"GET /images/hm_bg.jpg HTTP/1.0\" 200 24736"</span><span class=punctuation>}</span></span><br><span class=line><span class=punctuation>{</span><span class=attr>"index"</span><span class=punctuation>:</span><span class=punctuation>{</span><span class=punctuation>}</span><span class=punctuation>}</span></span><br><span class=line><span class=punctuation>{</span><span class=attr>"timestamp"</span><span class=punctuation>:</span><span class=string>"2020-04-30T14:30:53-05:00"</span><span class=punctuation>,</span><span class=attr>"message"</span><span class=punctuation>:</span><span class=string>"232.0.0.0 - - [30/Apr/2020:14:30:53 -0500] \"GET /images/hm_bg.jpg HTTP/1.0\" 200 24736"</span><span class=punctuation>}</span></span><br><span class=line><span class=punctuation>{</span><span class=attr>"index"</span><span class=punctuation>:</span><span class=punctuation>{</span><span class=punctuation>}</span><span class=punctuation>}</span></span><br><span class=line><span class=punctuation>{</span><span class=attr>"timestamp"</span><span class=punctuation>:</span><span class=string>"2020-04-30T14:31:12-05:00"</span><span class=punctuation>,</span><span class=attr>"message"</span><span class=punctuation>:</span><span class=string>"26.1.0.0 - - [30/Apr/2020:14:31:12 -0500] \"GET /images/hm_bg.jpg HTTP/1.0\" 200 24736"</span><span class=punctuation>}</span></span><br><span class=line><span class=punctuation>{</span><span class=attr>"index"</span><span class=punctuation>:</span><span class=punctuation>{</span><span class=punctuation>}</span><span class=punctuation>}</span></span><br><span class=line><span class=punctuation>{</span><span class=attr>"timestamp"</span><span class=punctuation>:</span><span class=string>"2020-04-30T14:31:19-05:00"</span><span class=punctuation>,</span><span class=attr>"message"</span><span class=punctuation>:</span><span class=string>"247.37.0.0 - - [30/Apr/2020:14:31:19 -0500] \"GET /french/splash_inet.html HTTP/1.0\" 200 3781"</span><span class=punctuation>}</span></span><br><span class=line><span class=punctuation>{</span><span class=attr>"index"</span><span class=punctuation>:</span><span class=punctuation>{</span><span class=punctuation>}</span><span class=punctuation>}</span></span><br><span class=line><span class=punctuation>{</span><span class=attr>"timestamp"</span><span class=punctuation>:</span><span class=string>"2020-04-30T14:31:22-05:00"</span><span class=punctuation>,</span><span class=attr>"message"</span><span class=punctuation>:</span><span class=string>"247.37.0.0 - - [30/Apr/2020:14:31:22 -0500] \"GET /images/hm_nbg.jpg HTTP/1.0\" 304 0"</span><span class=punctuation>}</span></span><br><span class=line><span class=punctuation>{</span><span class=attr>"index"</span><span class=punctuation>:</span><span class=punctuation>{</span><span class=punctuation>}</span><span class=punctuation>}</span></span><br><span class=line><span class=punctuation>{</span><span class=attr>"timestamp"</span><span class=punctuation>:</span><span class=string>"2020-04-30T14:31:27-05:00"</span><span class=punctuation>,</span><span class=attr>"message"</span><span class=punctuation>:</span><span class=string>"252.0.0.0 - - [30/Apr/2020:14:31:27 -0500] \"GET /images/hm_bg.jpg HTTP/1.0\" 200 24736"</span><span class=punctuation>}</span></span><br><span class=line><span class=punctuation>{</span><span class=attr>"index"</span><span class=punctuation>:</span><span class=punctuation>{</span><span class=punctuation>}</span><span class=punctuation>}</span></span><br><span class=line><span class=punctuation>{</span><span class=attr>"timestamp"</span><span class=punctuation>:</span><span class=string>"2020-04-30T14:31:28-05:00"</span><span class=punctuation>,</span><span class=attr>"message"</span><span class=punctuation>:</span><span class=string>"not a valid apache log"</span><span class=punctuation>}</span></span><br><span class=line></span><br><span class=line></span><br><span class=line></span><br><span class=line>#=======================================inde</span><br><span class=line># 创建索引</span><br><span class=line>PUT /my-index<span class=number>-000001</span>?master_timeout=<span class=number>30</span>s&timeout=<span class=number>30</span>s</span><br><span class=line><span class=punctuation>{</span></span><br><span class=line>  <span class=attr>"settings"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>    <span class=attr>"index"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>      <span class=attr>"number_of_shards"</span><span class=punctuation>:</span> <span class=number>3</span><span class=punctuation>,</span>  </span><br><span class=line>      <span class=attr>"number_of_replicas"</span><span class=punctuation>:</span> <span class=number>2</span> </span><br><span class=line>    <span class=punctuation>}</span></span><br><span class=line>  <span class=punctuation>}</span><span class=punctuation>,</span></span><br><span class=line>  <span class=attr>"aliases"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>    <span class=attr>"alias_1"</span><span class=punctuation>:</span> <span class=punctuation>{</span><span class=punctuation>}</span><span class=punctuation>,</span></span><br><span class=line>    <span class=attr>"alias_2"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>      <span class=attr>"filter"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>        <span class=attr>"term"</span><span class=punctuation>:</span> <span class=punctuation>{</span> <span class=attr>"user.id"</span><span class=punctuation>:</span> <span class=string>"kimchy"</span> <span class=punctuation>}</span></span><br><span class=line>      <span class=punctuation>}</span><span class=punctuation>,</span></span><br><span class=line>      <span class=attr>"routing"</span><span class=punctuation>:</span> <span class=string>"shard-1"</span></span><br><span class=line>    <span class=punctuation>}</span></span><br><span class=line>  <span class=punctuation>}</span><span class=punctuation>,</span></span><br><span class=line>  <span class=attr>"mappings"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>    <span class=attr>"properties"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>      <span class=attr>"field1"</span><span class=punctuation>:</span> <span class=punctuation>{</span> <span class=attr>"type"</span><span class=punctuation>:</span> <span class=string>"text"</span> <span class=punctuation>}</span></span><br><span class=line>    <span class=punctuation>}</span></span><br><span class=line>  <span class=punctuation>}</span></span><br><span class=line><span class=punctuation>}</span></span><br><span class=line></span><br><span class=line># 创建或更新别名（将流或索引添加进别名）</span><br><span class=line># POST &LTtarget>/_alias/&LTalias></span><br><span class=line># POST &LTtarget>/_aliases/&LTalias></span><br><span class=line># PUT &LTtarget>/_alias/&LTalias></span><br><span class=line># PUT &LTtarget>/_aliases/&LTalias></span><br><span class=line>PUT my-data-stream/_alias/my-alias</span><br><span class=line></span><br><span class=line># 创建或更新组件模板</span><br><span class=line># PUT /_component_template/&LTcomponent-template></span><br><span class=line>PUT _component_template/template_1</span><br><span class=line><span class=punctuation>{</span></span><br><span class=line>  <span class=attr>"template"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>    <span class=attr>"settings"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>      <span class=attr>"number_of_shards"</span><span class=punctuation>:</span> <span class=number>1</span></span><br><span class=line>    <span class=punctuation>}</span><span class=punctuation>,</span></span><br><span class=line>    <span class=attr>"mappings"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>      <span class=attr>"_source"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>        <span class=attr>"enabled"</span><span class=punctuation>:</span> <span class=literal><span class=keyword>false</span></span></span><br><span class=line>      <span class=punctuation>}</span><span class=punctuation>,</span></span><br><span class=line>      <span class=attr>"properties"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>        <span class=attr>"host_name"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>          <span class=attr>"type"</span><span class=punctuation>:</span> <span class=string>"keyword"</span></span><br><span class=line>        <span class=punctuation>}</span><span class=punctuation>,</span></span><br><span class=line>        <span class=attr>"created_at"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>          <span class=attr>"type"</span><span class=punctuation>:</span> <span class=string>"date"</span><span class=punctuation>,</span></span><br><span class=line>          <span class=attr>"format"</span><span class=punctuation>:</span> <span class=string>"EEE MMM dd HH:mm:ss Z yyyy"</span></span><br><span class=line>        <span class=punctuation>}</span></span><br><span class=line>      <span class=punctuation>}</span></span><br><span class=line>    <span class=punctuation>}</span></span><br><span class=line>  <span class=punctuation>}</span></span><br><span class=line><span class=punctuation>}</span></span><br><span class=line></span><br><span class=line></span><br><span class=line></span><br><span class=line>#====================================document</span><br><span class=line># index 是否存在</span><br><span class=line>HEAD /logs-test</span><br><span class=line></span><br><span class=line># 添加单个文档</span><br><span class=line>POST /logs-test/_doc</span><br><span class=line><span class=punctuation>{</span></span><br><span class=line>  <span class=attr>"@timestamp"</span><span class=punctuation>:</span><span class=string>"2099-05-06T16:21:15.000Z"</span><span class=punctuation>,</span></span><br><span class=line>  <span class=attr>"event"</span><span class=punctuation>:</span><span class=punctuation>{</span></span><br><span class=line>    <span class=attr>"origin"</span><span class=punctuation>:</span><span class=string>"192.0.2.42 - - [06/May/2099:16:21:15 +0000] \"GET /images/bg.jpg HTTP/1.0\" 200 24736"</span></span><br><span class=line>  <span class=punctuation>}</span></span><br><span class=line><span class=punctuation>}</span></span><br><span class=line></span><br><span class=line># 添加多个文档</span><br><span class=line>PUT logs-test/_bulk</span><br><span class=line><span class=punctuation>{</span><span class=attr>"create"</span><span class=punctuation>:</span> <span class=punctuation>{</span><span class=punctuation>}</span><span class=punctuation>}</span></span><br><span class=line><span class=punctuation>{</span><span class=attr>"@timestamp"</span><span class=punctuation>:</span> <span class=string>"2099-05-07T16:23:15.000Z"</span><span class=punctuation>,</span><span class=attr>"event"</span><span class=punctuation>:</span> <span class=punctuation>{</span><span class=attr>"origin"</span><span class=punctuation>:</span> <span class=string>"192.0.2.42 - - [06/Ma/2030:16:21:15 +0000] \"GET /images/bg.jpg HTTP/1.0\" 304 0"</span><span class=punctuation>}</span><span class=punctuation>}</span></span><br><span class=line><span class=punctuation>{</span><span class=attr>"create"</span><span class=punctuation>:</span> <span class=punctuation>{</span><span class=punctuation>}</span><span class=punctuation>}</span></span><br><span class=line><span class=punctuation>{</span><span class=attr>"@timestamp"</span><span class=punctuation>:</span> <span class=string>"2099-05-08T16:25:15.000Z"</span><span class=punctuation>,</span><span class=attr>"event"</span><span class=punctuation>:</span> <span class=punctuation>{</span><span class=attr>"origin"</span><span class=punctuation>:</span> <span class=string>"192.0.2.50 - - [06/Ma/2099:16:21:15 +0500] \"GET /favicon.ico HTTP/1.0\" 200 3638"</span><span class=punctuation>}</span><span class=punctuation>}</span></span><br><span class=line></span><br><span class=line># 查询数据</span><br><span class=line>GET /logs-test/_search</span><br><span class=line><span class=punctuation>{</span></span><br><span class=line>  <span class=attr>"query"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>    <span class=attr>"match_all"</span><span class=punctuation>:</span> <span class=punctuation>{</span><span class=punctuation>}</span></span><br><span class=line>  <span class=punctuation>}</span><span class=punctuation>,</span></span><br><span class=line>  <span class=attr>"sort"</span><span class=punctuation>:</span> <span class=punctuation>[</span></span><br><span class=line>    <span class=punctuation>{</span></span><br><span class=line>      <span class=attr>"@timestamp"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>        <span class=attr>"order"</span><span class=punctuation>:</span> <span class=string>"desc"</span></span><br><span class=line>      <span class=punctuation>}</span></span><br><span class=line>    <span class=punctuation>}</span></span><br><span class=line>  <span class=punctuation>]</span></span><br><span class=line><span class=punctuation>}</span></span><br><span class=line></span><br><span class=line># 查询单个字段</span><br><span class=line>GET logs-test/_search</span><br><span class=line><span class=punctuation>{</span></span><br><span class=line>  <span class=attr>"query"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>    <span class=attr>"match_all"</span><span class=punctuation>:</span> <span class=punctuation>{</span><span class=punctuation>}</span></span><br><span class=line>  <span class=punctuation>}</span><span class=punctuation>,</span></span><br><span class=line>  <span class=attr>"fields"</span><span class=punctuation>:</span> <span class=punctuation>[</span></span><br><span class=line>    <span class=string>"@timestamp"</span></span><br><span class=line>  <span class=punctuation>]</span><span class=punctuation>,</span></span><br><span class=line>  <span class=attr>"_source"</span><span class=punctuation>:</span> <span class=literal><span class=keyword>false</span></span><span class=punctuation>,</span></span><br><span class=line>  <span class=attr>"sort"</span><span class=punctuation>:</span> <span class=punctuation>[</span></span><br><span class=line>    <span class=punctuation>{</span></span><br><span class=line>      <span class=attr>"@timestamp"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>        <span class=attr>"order"</span><span class=punctuation>:</span> <span class=string>"desc"</span></span><br><span class=line>      <span class=punctuation>}</span></span><br><span class=line>    <span class=punctuation>}</span></span><br><span class=line>  <span class=punctuation>]</span></span><br><span class=line><span class=punctuation>}</span></span><br><span class=line></span><br><span class=line># 查询范围数据</span><br><span class=line>GET logs-test/_search</span><br><span class=line><span class=punctuation>{</span></span><br><span class=line>  <span class=attr>"query"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>    <span class=attr>"range"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>      <span class=attr>"@timestamp"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>        <span class=attr>"gte"</span><span class=punctuation>:</span> <span class=string>"2099-05-07"</span><span class=punctuation>,</span></span><br><span class=line>        <span class=attr>"lte"</span><span class=punctuation>:</span> <span class=string>"2099-05-08"</span></span><br><span class=line>      <span class=punctuation>}</span></span><br><span class=line>    <span class=punctuation>}</span></span><br><span class=line>  <span class=punctuation>}</span><span class=punctuation>,</span></span><br><span class=line>  <span class=attr>"fields"</span><span class=punctuation>:</span> <span class=punctuation>[</span></span><br><span class=line>    <span class=string>"@timestamp"</span></span><br><span class=line>  <span class=punctuation>]</span><span class=punctuation>,</span></span><br><span class=line>  <span class=attr>"_source"</span><span class=punctuation>:</span> <span class=literal><span class=keyword>false</span></span><span class=punctuation>,</span></span><br><span class=line>  <span class=attr>"sort"</span><span class=punctuation>:</span> <span class=punctuation>[</span></span><br><span class=line>    <span class=punctuation>{</span></span><br><span class=line>      <span class=attr>"@timestamp"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>        <span class=attr>"order"</span><span class=punctuation>:</span> <span class=string>"desc"</span></span><br><span class=line>      <span class=punctuation>}</span></span><br><span class=line>    <span class=punctuation>}</span></span><br><span class=line>  <span class=punctuation>]</span></span><br><span class=line><span class=punctuation>}</span></span><br><span class=line></span><br><span class=line># 复合查询</span><br><span class=line>GET logs-test/_search</span><br><span class=line><span class=punctuation>{</span></span><br><span class=line>  <span class=attr>"runtime_mappings"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>    <span class=attr>"source.ip"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>      <span class=attr>"type"</span><span class=punctuation>:</span> <span class=string>"ip"</span><span class=punctuation>,</span></span><br><span class=line>      <span class=attr>"script"</span><span class=punctuation>:</span> <span class=string>""</span><span class=string>"</span></span><br><span class=line><span class=string>        String sourceip=grok('%{IPORHOST:sourceip} .*').extract(doc[ "</span>event.original<span class=string>" ].value)?.sourceip;</span></span><br><span class=line><span class=string>        if (sourceip != null) emit(sourceip);</span></span><br><span class=line><span class=string>      "</span><span class=string>""</span></span><br><span class=line>    <span class=punctuation>}</span></span><br><span class=line>  <span class=punctuation>}</span><span class=punctuation>,</span></span><br><span class=line>  <span class=attr>"query"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>    <span class=attr>"bool"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>      <span class=attr>"filter"</span><span class=punctuation>:</span> <span class=punctuation>[</span></span><br><span class=line>        <span class=punctuation>{</span></span><br><span class=line>          <span class=attr>"range"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>            <span class=attr>"@timestamp"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>              <span class=attr>"gte"</span><span class=punctuation>:</span> <span class=string>"2099-05-07"</span><span class=punctuation>,</span></span><br><span class=line>              <span class=attr>"lte"</span><span class=punctuation>:</span> <span class=string>"2099-05-08"</span></span><br><span class=line>            <span class=punctuation>}</span></span><br><span class=line>          <span class=punctuation>}</span></span><br><span class=line>        <span class=punctuation>}</span><span class=punctuation>,</span></span><br><span class=line>        <span class=punctuation>{</span></span><br><span class=line>          <span class=attr>"range"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>            <span class=attr>"source.ip"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>              <span class=attr>"gte"</span><span class=punctuation>:</span> <span class=string>"192.0.2.0"</span><span class=punctuation>,</span></span><br><span class=line>              <span class=attr>"lte"</span><span class=punctuation>:</span> <span class=string>"192.0.2.240"</span></span><br><span class=line>            <span class=punctuation>}</span></span><br><span class=line>          <span class=punctuation>}</span></span><br><span class=line>        <span class=punctuation>}</span></span><br><span class=line>      <span class=punctuation>]</span></span><br><span class=line>    <span class=punctuation>}</span></span><br><span class=line>  <span class=punctuation>}</span><span class=punctuation>,</span></span><br><span class=line>  <span class=attr>"fields"</span><span class=punctuation>:</span> <span class=punctuation>[</span></span><br><span class=line>    <span class=string>"@timestamp"</span><span class=punctuation>,</span></span><br><span class=line>    <span class=string>"source.ip"</span></span><br><span class=line>  <span class=punctuation>]</span><span class=punctuation>,</span></span><br><span class=line>  <span class=attr>"_source"</span><span class=punctuation>:</span> <span class=literal><span class=keyword>false</span></span><span class=punctuation>,</span></span><br><span class=line>  <span class=attr>"sort"</span><span class=punctuation>:</span> <span class=punctuation>[</span></span><br><span class=line>    <span class=punctuation>{</span></span><br><span class=line>      <span class=attr>"@timestamp"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>        <span class=attr>"order"</span><span class=punctuation>:</span> <span class=string>"desc"</span></span><br><span class=line>      <span class=punctuation>}</span></span><br><span class=line>    <span class=punctuation>}</span></span><br><span class=line>  <span class=punctuation>]</span></span><br><span class=line><span class=punctuation>}</span></span><br><span class=line></span><br><span class=line>GET logs-test/_search</span><br><span class=line><span class=punctuation>{</span></span><br><span class=line>  <span class=attr>"runtime_mappings"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>    <span class=attr>"http.response.body.bytes"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>      <span class=attr>"type"</span><span class=punctuation>:</span> <span class=string>"long"</span><span class=punctuation>,</span></span><br><span class=line>      <span class=attr>"script"</span><span class=punctuation>:</span> <span class=string>""</span><span class=string>"</span></span><br><span class=line><span class=string>        String bytes=grok('%{COMMONAPACHELOG}').extract(doc[ "</span>event.original<span class=string>" ].value)?.bytes;</span></span><br><span class=line><span class=string>        if (bytes != null) emit(Integer.parseInt(bytes));</span></span><br><span class=line><span class=string>      "</span><span class=string>""</span></span><br><span class=line>    <span class=punctuation>}</span></span><br><span class=line>  <span class=punctuation>}</span><span class=punctuation>,</span></span><br><span class=line>  <span class=attr>"aggs"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>    <span class=attr>"average_response_size"</span><span class=punctuation>:</span><span class=punctuation>{</span></span><br><span class=line>      <span class=attr>"avg"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>        <span class=attr>"field"</span><span class=punctuation>:</span> <span class=string>"http.response.body.bytes"</span></span><br><span class=line>      <span class=punctuation>}</span></span><br><span class=line>    <span class=punctuation>}</span></span><br><span class=line>  <span class=punctuation>}</span><span class=punctuation>,</span></span><br><span class=line>  <span class=attr>"query"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>    <span class=attr>"bool"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>      <span class=attr>"filter"</span><span class=punctuation>:</span> <span class=punctuation>[</span></span><br><span class=line>        <span class=punctuation>{</span></span><br><span class=line>          <span class=attr>"range"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>            <span class=attr>"@timestamp"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>              <span class=attr>"gte"</span><span class=punctuation>:</span> <span class=string>"2099-05-05"</span><span class=punctuation>,</span></span><br><span class=line>              <span class=attr>"lt"</span><span class=punctuation>:</span> <span class=string>"2099-05-08"</span></span><br><span class=line>            <span class=punctuation>}</span></span><br><span class=line>          <span class=punctuation>}</span></span><br><span class=line>        <span class=punctuation>}</span></span><br><span class=line>      <span class=punctuation>]</span></span><br><span class=line>    <span class=punctuation>}</span></span><br><span class=line>  <span class=punctuation>}</span><span class=punctuation>,</span></span><br><span class=line>  <span class=attr>"fields"</span><span class=punctuation>:</span> <span class=punctuation>[</span></span><br><span class=line>    <span class=string>"@timestamp"</span><span class=punctuation>,</span></span><br><span class=line>    <span class=string>"http.response.body.bytes"</span></span><br><span class=line>  <span class=punctuation>]</span><span class=punctuation>,</span></span><br><span class=line>  <span class=attr>"_source"</span><span class=punctuation>:</span> <span class=literal><span class=keyword>false</span></span><span class=punctuation>,</span></span><br><span class=line>  <span class=attr>"sort"</span><span class=punctuation>:</span> <span class=punctuation>[</span></span><br><span class=line>    <span class=punctuation>{</span></span><br><span class=line>      <span class=attr>"@timestamp"</span><span class=punctuation>:</span> <span class=string>"desc"</span></span><br><span class=line>    <span class=punctuation>}</span></span><br><span class=line>  <span class=punctuation>]</span></span><br><span class=line><span class=punctuation>}</span></span><br><span class=line></span><br><span class=line># 删除文档</span><br><span class=line>DELETE /logs-test</span><br><span class=line></span><br><span class=line></span><br><span class=line>#=============================================聚合操作</span><br><span class=line>#============================存储桶聚合</span><br><span class=line># index是否存在</span><br><span class=line>HEAD /emails</span><br><span class=line></span><br><span class=line># 删除该 index</span><br><span class=line>DELETE /emails</span><br><span class=line></span><br><span class=line># <span class=number>1</span>、准备测试数据</span><br><span class=line>PUT /emails/_bulk?refresh</span><br><span class=line><span class=punctuation>{</span> <span class=attr>"index"</span> <span class=punctuation>:</span> <span class=punctuation>{</span> <span class=attr>"_id"</span> <span class=punctuation>:</span> <span class=number>1</span> <span class=punctuation>}</span> <span class=punctuation>}</span></span><br><span class=line><span class=punctuation>{</span> <span class=attr>"accounts"</span> <span class=punctuation>:</span> <span class=punctuation>[</span><span class=string>"hillary"</span><span class=punctuation>,</span> <span class=string>"sidney"</span><span class=punctuation>]</span><span class=punctuation>}</span></span><br><span class=line><span class=punctuation>{</span> <span class=attr>"index"</span> <span class=punctuation>:</span> <span class=punctuation>{</span> <span class=attr>"_id"</span> <span class=punctuation>:</span> <span class=number>2</span> <span class=punctuation>}</span> <span class=punctuation>}</span></span><br><span class=line><span class=punctuation>{</span> <span class=attr>"accounts"</span> <span class=punctuation>:</span> <span class=punctuation>[</span><span class=string>"hillary"</span><span class=punctuation>,</span> <span class=string>"donald"</span><span class=punctuation>]</span><span class=punctuation>}</span></span><br><span class=line><span class=punctuation>{</span> <span class=attr>"index"</span> <span class=punctuation>:</span> <span class=punctuation>{</span> <span class=attr>"_id"</span> <span class=punctuation>:</span> <span class=number>3</span> <span class=punctuation>}</span> <span class=punctuation>}</span></span><br><span class=line><span class=punctuation>{</span> <span class=attr>"accounts"</span> <span class=punctuation>:</span> <span class=punctuation>[</span><span class=string>"vladimir"</span><span class=punctuation>,</span> <span class=string>"donald"</span><span class=punctuation>]</span><span class=punctuation>}</span></span><br><span class=line></span><br><span class=line># 查询index的mapping信息</span><br><span class=line>GET /emails</span><br><span class=line></span><br><span class=line># 查询index的所有document数据</span><br><span class=line>GET /emails/_search</span><br><span class=line></span><br><span class=line># 聚合查询</span><br><span class=line>GET emails/_search</span><br><span class=line><span class=punctuation>{</span></span><br><span class=line>  <span class=attr>"size"</span><span class=punctuation>:</span> <span class=number>0</span><span class=punctuation>,</span></span><br><span class=line>  <span class=attr>"aggs"</span> <span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>    <span class=attr>"interactions"</span> <span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>      <span class=attr>"adjacency_matrix"</span> <span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>        <span class=attr>"filters"</span> <span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>          <span class=attr>"grpA"</span> <span class=punctuation>:</span> <span class=punctuation>{</span> <span class=attr>"terms"</span> <span class=punctuation>:</span> <span class=punctuation>{</span> <span class=attr>"accounts"</span> <span class=punctuation>:</span> <span class=punctuation>[</span><span class=string>"hillary"</span><span class=punctuation>,</span> <span class=string>"sidney"</span><span class=punctuation>]</span> <span class=punctuation>}</span><span class=punctuation>}</span><span class=punctuation>,</span></span><br><span class=line>          <span class=attr>"grpB"</span> <span class=punctuation>:</span> <span class=punctuation>{</span> <span class=attr>"terms"</span> <span class=punctuation>:</span> <span class=punctuation>{</span> <span class=attr>"accounts"</span> <span class=punctuation>:</span> <span class=punctuation>[</span><span class=string>"donald"</span><span class=punctuation>,</span> <span class=string>"mitt"</span><span class=punctuation>]</span> <span class=punctuation>}</span><span class=punctuation>}</span><span class=punctuation>,</span></span><br><span class=line>          <span class=attr>"grpC"</span> <span class=punctuation>:</span> <span class=punctuation>{</span> <span class=attr>"terms"</span> <span class=punctuation>:</span> <span class=punctuation>{</span> <span class=attr>"accounts"</span> <span class=punctuation>:</span> <span class=punctuation>[</span><span class=string>"vladimir"</span><span class=punctuation>,</span> <span class=string>"nigel"</span><span class=punctuation>]</span> <span class=punctuation>}</span><span class=punctuation>}</span></span><br><span class=line>        <span class=punctuation>}</span></span><br><span class=line>      <span class=punctuation>}</span></span><br><span class=line>    <span class=punctuation>}</span></span><br><span class=line>  <span class=punctuation>}</span></span><br><span class=line><span class=punctuation>}</span></span><br><span class=line></span><br><span class=line># （categorize_text）</span><br><span class=line>GET /hotel</span><br><span class=line>GET /hotel/_search</span><br><span class=line>GET /hotel/_search</span><br><span class=line><span class=punctuation>{</span></span><br><span class=line>  <span class=attr>"size"</span><span class=punctuation>:</span> <span class=number>0</span><span class=punctuation>,</span></span><br><span class=line>  <span class=attr>"aggs"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>    <span class=attr>"brand_categorize"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>      <span class=attr>"categorize_text"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>        <span class=attr>"field"</span><span class=punctuation>:</span> <span class=string>"brand"</span></span><br><span class=line>      <span class=punctuation>}</span></span><br><span class=line>    <span class=punctuation>}</span></span><br><span class=line>  <span class=punctuation>}</span></span><br><span class=line><span class=punctuation>}</span></span><br><span class=line></span><br><span class=line></span><br><span class=line></span><br><span class=line>#=========================指标聚合</span><br><span class=line>GET /hotel/_search</span><br><span class=line><span class=punctuation>{</span></span><br><span class=line>  <span class=attr>"query"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>    <span class=attr>"match_all"</span><span class=punctuation>:</span> <span class=punctuation>{</span><span class=punctuation>}</span></span><br><span class=line>  <span class=punctuation>}</span><span class=punctuation>,</span> </span><br><span class=line>  <span class=attr>"sort"</span><span class=punctuation>:</span> <span class=punctuation>[</span></span><br><span class=line>    <span class=punctuation>{</span></span><br><span class=line>      <span class=attr>"price"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>        <span class=attr>"order"</span><span class=punctuation>:</span> <span class=string>"asc"</span></span><br><span class=line>      <span class=punctuation>}</span></span><br><span class=line>    <span class=punctuation>}</span></span><br><span class=line>  <span class=punctuation>]</span></span><br><span class=line><span class=punctuation>}</span></span><br><span class=line></span><br><span class=line># （avg）查询所有宾馆的价格平均值</span><br><span class=line>GET /hotel/_search</span><br><span class=line><span class=punctuation>{</span></span><br><span class=line>  <span class=attr>"size"</span><span class=punctuation>:</span><span class=number>0</span><span class=punctuation>,</span></span><br><span class=line>  <span class=attr>"aggs"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>    <span class=attr>"avg_val"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>      <span class=attr>"avg"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>        <span class=attr>"field"</span><span class=punctuation>:</span> <span class=string>"price"</span></span><br><span class=line>      <span class=punctuation>}</span></span><br><span class=line>    <span class=punctuation>}</span></span><br><span class=line>  <span class=punctuation>}</span></span><br><span class=line><span class=punctuation>}</span></span><br><span class=line></span><br><span class=line># （boxplot）查询价格的最小值、最大值、中位数、第一个四分位数、第三个四分位数</span><br><span class=line>GET /hotel/_search</span><br><span class=line><span class=punctuation>{</span></span><br><span class=line>  <span class=attr>"size"</span><span class=punctuation>:</span> <span class=number>0</span><span class=punctuation>,</span></span><br><span class=line>  <span class=attr>"aggs"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>    <span class=attr>"price_boxplot"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>      <span class=attr>"boxplot"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>        <span class=attr>"field"</span><span class=punctuation>:</span><span class=string>"price"</span></span><br><span class=line>      <span class=punctuation>}</span></span><br><span class=line>    <span class=punctuation>}</span></span><br><span class=line>  <span class=punctuation>}</span></span><br><span class=line><span class=punctuation>}</span></span><br><span class=line></span><br><span class=line># （cardinality）</span><br><span class=line>GET /hotel/_search</span><br><span class=line><span class=punctuation>{</span></span><br><span class=line>  <span class=attr>"size"</span><span class=punctuation>:</span> <span class=number>0</span><span class=punctuation>,</span></span><br><span class=line>  <span class=attr>"aggs"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>    <span class=attr>"price_count"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>      <span class=attr>"cardinality"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>        <span class=attr>"field"</span><span class=punctuation>:</span><span class=string>"price"</span></span><br><span class=line>      <span class=punctuation>}</span></span><br><span class=line>    <span class=punctuation>}</span></span><br><span class=line>  <span class=punctuation>}</span></span><br><span class=line><span class=punctuation>}</span></span><br><span class=line></span><br><span class=line># （string_stats）</span><br><span class=line>GET /hotel/_search</span><br><span class=line><span class=punctuation>{</span></span><br><span class=line>  <span class=attr>"size"</span><span class=punctuation>:</span> <span class=number>0</span><span class=punctuation>,</span></span><br><span class=line>  <span class=attr>"aggs"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>    <span class=attr>"price_status"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>      <span class=attr>"string_stats"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>        <span class=attr>"field"</span><span class=punctuation>:</span><span class=string>"price.keyword"</span></span><br><span class=line>      <span class=punctuation>}</span></span><br><span class=line>    <span class=punctuation>}</span></span><br><span class=line>  <span class=punctuation>}</span></span><br><span class=line><span class=punctuation>}</span></span><br><span class=line></span><br><span class=line># （sum）</span><br><span class=line>GET /hotel/_search</span><br><span class=line><span class=punctuation>{</span></span><br><span class=line>  <span class=attr>"size"</span><span class=punctuation>:</span> <span class=number>0</span><span class=punctuation>,</span></span><br><span class=line>  <span class=attr>"aggs"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>    <span class=attr>"sum_price"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>      <span class=attr>"sum"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>        <span class=attr>"field"</span><span class=punctuation>:</span> <span class=string>"price"</span></span><br><span class=line>      <span class=punctuation>}</span></span><br><span class=line>    <span class=punctuation>}</span></span><br><span class=line>  <span class=punctuation>}</span></span><br><span class=line><span class=punctuation>}</span></span><br></pre></table></figure> <footer class=post-footer><div class=post-eof></div></footer> <div class=post-block><article class=post-content itemscope itemtype=http://schema.org/Article><link href=https://hshz21.gitee.io/2024/08/21/ElasticSearch%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/ itemprop=mainEntityOfPage><span hidden itemprop=author itemscope itemtype=http://schema.org/Person> <meta content=/static/imgs/avatar.png itemprop=image> <meta content=豪哥 itemprop=name> </span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization> <meta content=豪哥博客 itemprop=name> <meta content=豪哥博客 itemprop=description> </span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork> <meta content="undefined | 豪哥博客" itemprop=name> <meta itemprop=description> </span><header class=post-header><h2 itemprop="name headline" class=post-title><a class=post-title-link href=/2024/08/21/ElasticSearch%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/ itemprop=url>ElasticSearch系列-ElasticSearch环境搭建</a></h2><div class=post-meta-container><div class=post-meta><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar"></i> </span> <span class=post-meta-item-text>发表于</span> <time itemprop="dateCreated datePublished" title="创建时间：2024-08-21 21:39:13" datetime=2024-08-21T21:39:13+08:00>2024-08-21</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar-check"></i> </span> <span class=post-meta-item-text>更新于</span> <time title="修改时间：2023-08-07 16:44:58" datetime=2023-08-07T16:44:58+08:00 itemprop=dateModified>2023-08-07</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-folder"></i> </span> <span class=post-meta-item-text>分类于</span> <span itemprop=about itemscope itemtype=http://schema.org/Thing> <a href=/categories/ElasticSearch/ itemprop=url rel=index><span itemprop=name>ElasticSearch</span></a> </span> </span></div></div></header><div class=post-body itemprop=articleBody><h1 id=1、ElasticSearch单节点><a class=headerlink href=#1、ElasticSearch单节点 title=1、ElasticSearch单节点></a>1、ElasticSearch单节点</h1><h2 id=1-1、下载ES压缩包><a class=headerlink href=#1-1、下载ES压缩包 title=1.1、下载ES压缩包></a>1.1、下载ES压缩包</h2><p>ElasticSearch分为Linux和Window版本。<p>ElasticSearch的官方地址： <a href=https://www.elastic.co/products/elasticsearch%E5%9C%A8%E8%B5%84%E6%96%99%E4%B8%AD%E5%B7%B2%E7%BB%8F%E6%8F%90%E4%BE%9B%E4%BA%86%E4%B8%8B%E8%BD%BD%E5%A5%BD%E7%9A%845.6.8%E7%9A%84%E5%8E%8B%E7%BC%A9%E5%8C%85%EF%BC%9A rel=noopener target=_blank>https://www.elastic.co/products/elasticsearch在资料中已经提供了下载好的5.6.8的压缩包：</a><h2 id=1-2、安装ES服务><a class=headerlink href=#1-2、安装ES服务 title=1.2、安装ES服务></a>1.2、安装ES服务</h2><p>Window版的ElasticSearch的安装很简单，类似Window版的Tomcat，解压开即安装完毕，解压后的ElasticSearch 的目录结构如下：修改elasticsearch配置文件<code>confifig/elasticsearch.yml</code>，增加以下两句命令：<figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line><span class=attr>http.cors.enabled</span>: <span class=string>true </span></span><br><span class=line><span class=attr>http.cors.allow‐origin</span>: <span class=string>"*"</span></span><br></pre></table></figure><p>此步为允许elasticsearch跨越访问，如果不安装后面的elasticsearch-head是可以不修改，直接启动。<h2 id=1-3、启动ES服务><a class=headerlink href=#1-3、启动ES服务 title=1.3、启动ES服务></a>1.3、启动ES服务</h2><p>点击ElasticSearch下的bin目录下的elasticsearch.bat启动，控制台显示的日志信息如下：<p>注意：9300是tcp通讯端口，集群间和TCPClient都执行该端口，9200是http协议的RESTful接口 。<p>通过浏览器访问ElasticSearch服务器。<blockquote><p>注意：ElasticSearch使用java开发，且本版本的es需要的jdk版本要是1.8以上，所以 安装ElasticSearch之前保证JDK1.8+安装完毕，并正确的配置好JDK环境变量，否则启动ElasticSearch失败。</blockquote><h2 id=1-4、安装ES图形化界面插件><a class=headerlink href=#1-4、安装ES图形化界面插件 title=1.4、安装ES图形化界面插件></a>1.4、安装ES图形化界面插件</h2><p>ElasticSearch不同于Solr自带图形化界面，我们可以通过安装ElasticSearch的head插件，完成图形化界面的效果，完成索引数据的查看。安装插件的方式有两种，在线安装和本地安装。这里采用本地安装方式进行head插件的安装。elasticsearch-5-*以上版本安装head需要安装node和grunt。<h3 id=1-4-1、安装head><a class=headerlink href=#1-4-1、安装head title=1.4.1、安装head></a>1.4.1、安装head</h3><p>下载head插件：<a href=https://github.com/mobz/elasticsearch-head rel=noopener target=_blank>https://github.com/mobz/elasticsearch-head</a><p>注意：ElasticSearch使用java开发制作，且本版本的es 依赖 Jdk1.8 以上。将elasticsearch-head-master压缩包解压到任意目录，但要与 elasticsearch安装目录 区分开<h3 id=1-4-2、安装node><a class=headerlink href=#1-4-2、安装node title=1.4.2、安装node></a>1.4.2、安装node</h3><ol><li>下载nodejs：<a href=https://nodejs.org/en/download/ rel=noopener target=_blank>https://nodejs.org/en/download/</a> 。<li>双击安装程序，步骤截图如下：安装完毕，可以通过cmd控制台输入：node -v 查看版本号。</ol><h3 id=1-4-3、安装grunt插件><a class=headerlink href=#1-4-3、安装grunt插件 title=1.4.3、安装grunt插件></a>1.4.3、安装grunt插件</h3><p>将grunt安装为全局命令 ，Grunt是基于Node.js的项目构建工具。<p>在cmd控制台中输入如下执行命令：<figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>npm install ‐g grunt‐cli</span><br></pre></table></figure><h3 id=1-4-4、启动head><a class=headerlink href=#1-4-4、启动head title=1.4.4、启动head></a>1.4.4、启动head</h3><p>进入elasticsearch-head-master目录启动head，在命令提示符下输入命令：<figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line>npm install</span><br><span class=line>grunt server</span><br></pre></table></figure><p>打开浏览器，输入 <a href=http://localhost:9100，看到如下页面：>http://localhost:9100，看到如下页面：</a><p>如果无法连接到es服务，那么需要修改 <code>config/elasticsearch.yml</code>，增加 以下命令：<figure class="highlight yaml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line><span class=attr>http.cors.enabled:</span> <span class=literal>true</span> </span><br><span class=line><span class=string>http.cors.allow‐origin:</span> <span class=string>"*"</span></span><br></pre></table></figure><p>然后重新启动ElasticSearch服务后 重试 即可。<h1 id=6、ElasticSearch集群><a class=headerlink href=#6、ElasticSearch集群 title=6、ElasticSearch集群></a>6、ElasticSearch集群</h1><p>ES集群是一个 P2P类型（使用 gossip 协议）的分布式系统，除了集群状态管理以外，其他所有的请求都可以发送到 集群内任意一台节点上，这个节点可以自己找到需要转发给哪些节点，并且直接跟这些节点通信。所以，从网络架 构及服务配置上来说，构建集群所需要的配置极其简单。在 Elasticsearch 2.0 之前，无阻碍的网络下，所有配置了 相同 cluster.name 的节点都自动归属到一个集群中。2.0 版本之后，基于安全的考虑避免开发环境过于随便造成的 麻烦，从 2.0 版本开始，默认的自动发现方式改为了单播(unicast)方式。配置里提供几台节点的地址，ES 将其视作 gossip router 角色，借以完成集群的发现。由于这只是 ES 内一个很小的功能，所以 gossip router 角色并不需要 单独配置，每个 ES 节点都可以担任。所以，采用单播方式的集群，各节点都配置相同的几个节点列表作为 router 即可。<p>集群中节点数量没有限制，一般大于等于2个节点就可以看做是集群了。一般处于高性能及高可用方面来考虑一般 集群中的节点数量都是3个及3个以上。<h2 id=6-1、集群相关概念><a class=headerlink href=#6-1、集群相关概念 title=6.1、集群相关概念></a>6.1、集群相关概念</h2><h3 id=6-1-1、集群cluster><a class=headerlink href=#6-1-1、集群cluster title=6.1.1、集群cluster></a>6.1.1、集群cluster</h3><p>一个集群就是由一个或多个节点组织在一起，它们共同持有整个的数据，并一起提供索引和搜索功能。一个集群由 一个唯一的名字标识，这个名字默认就是“elasticsearch”。这个名字是重要的，因为一个节点只能通过指定某个集 群的名字，来加入这个集群<h3 id=6-1-2、节点node><a class=headerlink href=#6-1-2、节点node title=6.1.2、节点node></a>6.1.2、节点node</h3><p>一个节点是集群中的一个服务器，作为集群的一部分，它存储数据，参与集群的索引和搜索功能。和集群类似，一 个节点也是由一个名字来标识的，默认情况下，这个名字是一个随机的漫威漫画角色的名字，这个名字会在启动的 时候赋予节点。这个名字对于管理工作来说挺重要的，因为在这个管理过程中，你会去确定网络中的哪些服务器对 应于Elasticsearch集群中的哪些节点。<p>一个节点可以通过配置集群名称的方式来加入一个指定的集群。默认情况下，每个节点都会被安排加入到一个叫 做“elasticsearch”的集群中，这意味着，如果你在你的网络中启动了若干个节点，并假定它们能够相互发现彼此， 它们将会自动地形成并加入到一个叫做“elasticsearch”的集群中。<p>在一个集群里，只要你想，可以拥有任意多个节点。而且，如果当前你的网络中没有运行任何Elasticsearch节点， 这时启动一个节点，会默认创建并加入一个叫做“elasticsearch”的集群。<h3 id=6-1-3、分片和复制shards-replicas><a class=headerlink href=#6-1-3、分片和复制shards-replicas title=6.1.3、分片和复制shards&replicas></a>6.1.3、分片和复制shards&replicas</h3><p>一个索引可以存储超出单个结点硬件限制的大量数据。比如，一个具有10亿文档的索引占据1TB磁盘空间，而任一节点都没有如此大的磁盘空间；或者单个节点处理搜索请求，响应太慢。为了解决这个问题，Elasticsearch提供 了将索引划分成多份的能力，这些份就叫做分片。当你创建一个索引的时候，你可以指定你想要的分片的数量。每 个分片本身也是一个功能完善并且独立的“索引”，这个“索引”可以被放置到集群中的任何节点上。分片很重要，主 要有两方面的原因： 1）允许你水平分割/扩展你的内容容量。 2）允许你在分片（潜在地，位于多个节点上）之上 进行分布式的、并行的操作，进而提高性能/吞吐量。<p>至于一个分片怎样分布，它的文档怎样聚合回搜索请求，是完全由Elasticsearch管理的，对于作为用户的你来说， 这些都是透明的。<p>在一个网络/云的环境里，失败随时都可能发生，在某个分片/节点不知怎么的就处于离线状态，或者由于任何原因 消失了，这种情况下，有一个故障转移机制是非常有用并且是强烈推荐的。为此目的，Elasticsearch允许你创建分 片的一份或多份拷贝，这些拷贝叫做复制分片，或者直接叫复制。<p>复制之所以重要，有两个主要原因： 在分片/节点失败的情况下，提供了高可用性。因为这个原因，注意到复制分 片从不与原/主要（original/primary）分片置于同一节点上是非常重要的。扩展你的搜索量/吞吐量，因为搜索可以 在所有的复制上并行运行。总之，每个索引可以被分成多个分片。一个索引也可以被复制0次（意思是没有复制） 或多次。一旦复制了，每个索引就有了主分片（作为复制源的原来的分片）和复制分片（主分片的拷贝）之别。分 片和复制的数量可以在索引创建的时候指定。在索引创建之后，你可以在任何时候动态地改变复制的数量，但是你 事后不能改变分片的数量。<p>默认情况下，Elasticsearch中的每个索引被分片5个主分片和1个复制，这意味着，如果你的集群中至少有两个节 点，你的索引将会有5个主分片和另外5个复制分片（1个完全拷贝），这样的话每个索引总共就有10个分片。<h2 id=6-2、集群搭建><a class=headerlink href=#6-2、集群搭建 title=6.2、集群搭建></a>6.2、集群搭建</h2><h3 id=6-2-1、准备服务器><a class=headerlink href=#6-2-1、准备服务器 title=6.2.1、准备服务器></a>6.2.1、准备服务器</h3><p>创建elasticsearch-cluster文件夹，在内部复制三个elasticsearch服务。<h3 id=6-2-2、服务器配置><a class=headerlink href=#6-2-2、服务器配置 title=6.2.2、服务器配置></a>6.2.2、服务器配置</h3><p>修改<code>elasticsearch-cluster\node*\confifig\elasticsearch.yml</code>配置文件。<p><strong>node1节点</strong><figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br></pre><td class=code><pre><span class=line><span class=comment>#节点1的配置信息： </span></span><br><span class=line><span class=comment>#集群名称，保证唯一 </span></span><br><span class=line><span class=attr>cluster.name</span>: <span class=string>my‐elasticsearch </span></span><br><span class=line><span class=comment>#节点名称，必须不一样 </span></span><br><span class=line><span class=attr>node.name</span>: <span class=string>node‐1 </span></span><br><span class=line><span class=comment>#必须为本机的ip地址 </span></span><br><span class=line><span class=attr>network.host</span>: <span class=string>127.0.0.1 </span></span><br><span class=line><span class=comment>#服务端口号，在同一机器下必须不一样 </span></span><br><span class=line><span class=attr>http.port</span>: <span class=string>9200 </span></span><br><span class=line><span class=comment>#集群间通信端口号，在同一机器下必须不一样 </span></span><br><span class=line><span class=attr>transport.tcp.port</span>: <span class=string>9300 </span></span><br><span class=line><span class=comment>#设置集群自动发现机器ip集合 </span></span><br><span class=line><span class=attr>discovery.zen.ping.unicast.hosts</span>: <span class=string>["127.0.0.1:9300","127.0.0.1:9301","127.0.0.1:9302"]</span></span><br></pre></table></figure><p><strong>node2节点</strong><figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br></pre><td class=code><pre><span class=line><span class=comment>#节点1的配置信息： </span></span><br><span class=line><span class=comment>#集群名称，保证唯一 </span></span><br><span class=line><span class=attr>cluster.name</span>: <span class=string>my‐elasticsearch </span></span><br><span class=line><span class=comment>#节点名称，必须不一样 </span></span><br><span class=line><span class=attr>node.name</span>: <span class=string>node‐2 </span></span><br><span class=line><span class=comment>#必须为本机的ip地址 </span></span><br><span class=line><span class=attr>network.host</span>: <span class=string>127.0.0.1 </span></span><br><span class=line><span class=comment>#服务端口号，在同一机器下必须不一样 </span></span><br><span class=line><span class=attr>http.port</span>: <span class=string>9200 </span></span><br><span class=line><span class=comment>#集群间通信端口号，在同一机器下必须不一样 </span></span><br><span class=line><span class=attr>transport.tcp.port</span>: <span class=string>9301 </span></span><br><span class=line><span class=comment>#设置集群自动发现机器ip集合 </span></span><br><span class=line><span class=attr>discovery.zen.ping.unicast.hosts</span>: <span class=string>["127.0.0.1:9300","127.0.0.1:9301","127.0.0.1:9302"]</span></span><br></pre></table></figure><p><strong>node3节点</strong><figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br></pre><td class=code><pre><span class=line><span class=comment>#节点1的配置信息： </span></span><br><span class=line><span class=comment>#集群名称，保证唯一 </span></span><br><span class=line><span class=attr>cluster.name</span>: <span class=string>my‐elasticsearch </span></span><br><span class=line><span class=comment>#节点名称，必须不一样 </span></span><br><span class=line><span class=attr>node.name</span>: <span class=string>node‐3</span></span><br><span class=line><span class=comment>#必须为本机的ip地址 </span></span><br><span class=line><span class=attr>network.host</span>: <span class=string>127.0.0.1 </span></span><br><span class=line><span class=comment>#服务端口号，在同一机器下必须不一样 </span></span><br><span class=line><span class=attr>http.port</span>: <span class=string>9200 </span></span><br><span class=line><span class=comment>#集群间通信端口号，在同一机器下必须不一样 </span></span><br><span class=line><span class=attr>transport.tcp.port</span>: <span class=string>9302 </span></span><br><span class=line><span class=comment>#设置集群自动发现机器ip集合 </span></span><br><span class=line><span class=attr>discovery.zen.ping.unicast.hosts</span>: <span class=string>["127.0.0.1:9300","127.0.0.1:9301","127.0.0.1:9302"]</span></span><br></pre></table></figure><h3 id=6-2-3、启动服务器><a class=headerlink href=#6-2-3、启动服务器 title=6.2.3、启动服务器></a>6.2.3、启动服务器</h3><p>双击<code>elasticsearch-cluster\node*\bin\elasticsearch.bat</code>，请按顺序启动节点1、节点2、节点3。<h3 id=6-2-4、集群测试><a class=headerlink href=#6-2-4、集群测试 title=6.2.4、集群测试></a>6.2.4、集群测试</h3><p><strong>添加索引和映射</strong><figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>PUT localhost:9200/blog1 </span><br></pre></table></figure><figure class="highlight json"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br></pre><td class=code><pre><span class=line><span class=punctuation>{</span> </span><br><span class=line>    <span class=attr>"mappings"</span><span class=punctuation>:</span> <span class=punctuation>{</span> </span><br><span class=line>        <span class=attr>"article"</span><span class=punctuation>:</span> <span class=punctuation>{</span> </span><br><span class=line>            <span class=attr>"properties"</span><span class=punctuation>:</span> <span class=punctuation>{</span> </span><br><span class=line>                <span class=attr>"id"</span><span class=punctuation>:</span> <span class=punctuation>{</span> </span><br><span class=line>                    <span class=attr>"type"</span><span class=punctuation>:</span> <span class=string>"long"</span><span class=punctuation>,</span> </span><br><span class=line>                    <span class=attr>"store"</span><span class=punctuation>:</span> <span class=literal><span class=keyword>true</span></span><span class=punctuation>,</span> </span><br><span class=line>                    <span class=attr>"index"</span><span class=punctuation>:</span><span class=string>"not_analyzed"</span> </span><br><span class=line>                <span class=punctuation>}</span><span class=punctuation>,</span></span><br><span class=line>                <span class=attr>"title"</span><span class=punctuation>:</span> <span class=punctuation>{</span></span><br><span class=line>                    <span class=attr>"type"</span><span class=punctuation>:</span> <span class=string>"text"</span><span class=punctuation>,</span> </span><br><span class=line>                    <span class=attr>"store"</span><span class=punctuation>:</span> <span class=literal><span class=keyword>true</span></span><span class=punctuation>,</span> </span><br><span class=line>                    <span class=attr>"index"</span><span class=punctuation>:</span><span class=string>"analyzed"</span><span class=punctuation>,</span> </span><br><span class=line>                    <span class=attr>"analyzer"</span><span class=punctuation>:</span><span class=string>"standard"</span> </span><br><span class=line>                <span class=punctuation>}</span><span class=punctuation>,</span></span><br><span class=line>                <span class=attr>"content"</span><span class=punctuation>:</span> <span class=punctuation>{</span> </span><br><span class=line>                    <span class=attr>"type"</span><span class=punctuation>:</span> <span class=string>"text"</span><span class=punctuation>,</span> </span><br><span class=line>                    <span class=attr>"store"</span><span class=punctuation>:</span> <span class=literal><span class=keyword>true</span></span><span class=punctuation>,</span> </span><br><span class=line>                    <span class=attr>"index"</span><span class=punctuation>:</span><span class=string>"analyzed"</span><span class=punctuation>,</span> </span><br><span class=line>                    <span class=attr>"analyzer"</span><span class=punctuation>:</span><span class=string>"standard"</span> </span><br><span class=line>                <span class=punctuation>}</span> </span><br><span class=line>            <span class=punctuation>}</span> </span><br><span class=line>        <span class=punctuation>}</span> </span><br><span class=line>    <span class=punctuation>}</span> </span><br><span class=line><span class=punctuation>}</span></span><br></pre></table></figure><p><strong>添加文档</strong><figure class="highlight http"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>POST localhost:9200/blog1/article/1</span><br></pre></table></figure><figure class="highlight json"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line><span class=punctuation>{</span> </span><br><span class=line>    <span class=attr>"id"</span><span class=punctuation>:</span><span class=number>1</span><span class=punctuation>,</span> </span><br><span class=line>    <span class=attr>"title"</span><span class=punctuation>:</span><span class=string>"ElasticSearch是一个基于Lucene的搜索服务器"</span><span class=punctuation>,</span> </span><br><span class=line>    <span class=attr>"content"</span><span class=punctuation>:</span><span class=string>"它提供了一个分布式多用户能力的全文搜索引擎，基于RESTful web接口。Elasticsearch是用Java 开发的，并作为Apache许可条款下的开放源码发布，是当前流行的企业级搜索引擎。设计用于云计算中，能够达到实时 搜索，稳定，可靠，快速，安装使用方便。"</span> </span><br><span class=line><span class=punctuation>}</span></span><br></pre></table></figure></div><footer class=post-footer><div class=post-eof></div></footer></article></div> <div class=post-block><article class=post-content itemscope itemtype=http://schema.org/Article><link href=https://hshz21.gitee.io/2024/08/21/Docker%E4%B9%8BZookeeper%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/ itemprop=mainEntityOfPage><span hidden itemprop=author itemscope itemtype=http://schema.org/Person> <meta content=/static/imgs/avatar.png itemprop=image> <meta content=豪哥 itemprop=name> </span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization> <meta content=豪哥博客 itemprop=name> <meta content=豪哥博客 itemprop=description> </span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork> <meta content="undefined | 豪哥博客" itemprop=name> <meta itemprop=description> </span><header class=post-header><h2 itemprop="name headline" class=post-title><a class=post-title-link href=/2024/08/21/Docker%E4%B9%8BZookeeper%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/ itemprop=url>Docker系列-Zookeeper环境搭建</a></h2><div class=post-meta-container><div class=post-meta><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar"></i> </span> <span class=post-meta-item-text>发表于</span> <time itemprop="dateCreated datePublished" title="创建时间：2024-08-21 21:39:13" datetime=2024-08-21T21:39:13+08:00>2024-08-21</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar-check"></i> </span> <span class=post-meta-item-text>更新于</span> <time title="修改时间：2023-08-07 17:01:35" datetime=2023-08-07T17:01:35+08:00 itemprop=dateModified>2023-08-07</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-folder"></i> </span> <span class=post-meta-item-text>分类于</span> <span itemprop=about itemscope itemtype=http://schema.org/Thing> <a href=/categories/Docker/ itemprop=url rel=index><span itemprop=name>Docker</span></a> </span> </span></div></div></header><div class=post-body itemprop=articleBody><h1 id=单例环境><a class=headerlink href=#单例环境 title=单例环境></a>单例环境</h1><h2 id=1-1、准备工作><a class=headerlink href=#1-1、准备工作 title=1.1、准备工作></a>1.1、准备工作</h2><p>（1）创建本地数据卷目录<figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line><span class=built_in>mkdir</span> -p /home/docker/containers/zookeeper</span><br></pre></table></figure><p>（2）拉取镜像<figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>docker pull zookeeper:3.6.4</span><br></pre></table></figure><h2 id=1-2、启动容器><a class=headerlink href=#1-2、启动容器 title=1.2、启动容器></a>1.2、启动容器</h2><p>（1）把zookeeper容器中的文件复制出来<p>可以先创建一个容器，配置文件复制出来后，再删除这个容器，然后执行第（2）步的操作。<figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>docker <span class=built_in>cp</span> -a zookeeper:/apache-zookeeper-3.6.4-bin/conf /home/docker/containers/zookeeper/</span><br></pre></table></figure><p>（2）启动容器<figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre><td class=code><pre><span class=line>docker run -d \</span><br><span class=line>--name zookeeper \</span><br><span class=line>-p 2181:2181 \</span><br><span class=line>-v /home/docker/containers/zookeeper/conf:/apache-zookeeper-3.6.4-bin/conf \</span><br><span class=line>--network net-dev \</span><br><span class=line>zookeeper:3.6.4</span><br></pre></table></figure><h2 id=1-3、配置防火墙><a class=headerlink href=#1-3、配置防火墙 title=1.3、配置防火墙></a>1.3、配置防火墙</h2><p>配置仅允许指定IP访问nacos服务的8848端口：<figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line>firewall-cmd --permanent --add-rich-rule=<span class=string>'rule family="ipv4" source address="192.168.0.107" port protocol="tcp" port="2181" accept'</span></span><br><span class=line></span><br><span class=line><span class=comment># 重新加载，使其生效</span></span><br><span class=line>firewall-cmd --reload</span><br></pre></table></figure></div><footer class=post-footer><div class=post-eof></div></footer></article></div> <div class=post-block><article class=post-content itemscope itemtype=http://schema.org/Article><link href=https://hshz21.gitee.io/2024/08/21/Docker%E4%B9%8BXXL-JOB%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/ itemprop=mainEntityOfPage><span hidden itemprop=author itemscope itemtype=http://schema.org/Person> <meta content=/static/imgs/avatar.png itemprop=image> <meta content=豪哥 itemprop=name> </span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization> <meta content=豪哥博客 itemprop=name> <meta content=豪哥博客 itemprop=description> </span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork> <meta content="undefined | 豪哥博客" itemprop=name> <meta itemprop=description> </span><header class=post-header><h2 itemprop="name headline" class=post-title><a class=post-title-link href=/2024/08/21/Docker%E4%B9%8BXXL-JOB%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/ itemprop=url>Docker系列-XXLJOB环境搭建</a></h2><div class=post-meta-container><div class=post-meta><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar"></i> </span> <span class=post-meta-item-text>发表于</span> <time itemprop="dateCreated datePublished" title="创建时间：2024-08-21 21:39:13" datetime=2024-08-21T21:39:13+08:00>2024-08-21</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-calendar-check"></i> </span> <span class=post-meta-item-text>更新于</span> <time title="修改时间：2023-08-07 17:01:25" datetime=2023-08-07T17:01:25+08:00 itemprop=dateModified>2023-08-07</time> </span><span class=post-meta-item> <span class=post-meta-item-icon> <i class="far fa-folder"></i> </span> <span class=post-meta-item-text>分类于</span> <span itemprop=about itemscope itemtype=http://schema.org/Thing> <a href=/categories/Docker/ itemprop=url rel=index><span itemprop=name>Docker</span></a> </span> </span></div></div></header><div class=post-body itemprop=articleBody><h1 id=单例环境><a class=headerlink href=#单例环境 title=单例环境></a>单例环境</h1><h2 id=1-1、准备工作><a class=headerlink href=#1-1、准备工作 title=1.1、准备工作></a>1.1、准备工作</h2><p>（1）创建本地数据卷目录<figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line><span class=built_in>mkdir</span> -p /home/docker/containers/xxljob/data</span><br></pre></table></figure><p>（2）拉取镜像<figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>docker pull xxl-job-admin</span><br></pre></table></figure><h2 id=1-2、启动容器><a class=headerlink href=#1-2、启动容器 title=1.2、启动容器></a>1.2、启动容器</h2><p>（1）启动容器<figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre><td class=code><pre><span class=line>docker run -d \</span><br><span class=line>--name xxljob \</span><br><span class=line>-p 7070:7070 \</span><br><span class=line>-e PARAMS=<span class=string>"--spring.datasource.url=jdbc:mysql://mysql:3306/xxljob?useUnicode=true&characterEncoding=UTF-8&autoReconnect=true&serverTimezone=Asia/Shanghai --spring.datasource.username=root --spring.datasource.password=mysql368.cn"</span> \</span><br><span class=line>-v /home/docker/containers/xxljob/data:/data/applogs \</span><br><span class=line>--network net-dev \</span><br><span class=line>xuxueli/xxl-job-admin:2.4.0</span><br></pre></table></figure><h2 id=1-3、配置防火墙><a class=headerlink href=#1-3、配置防火墙 title=1.3、配置防火墙></a>1.3、配置防火墙</h2><p>配置仅允许指定IP访问xxljob服务：<figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line>firewall-cmd --permanent --add-rich-rule=<span class=string>'rule family="ipv4" source address="192.168.0.107" port protocol="tcp" port="7070" accept'</span></span><br><span class=line></span><br><span class=line><span class=comment># 重新加载，使其生效</span></span><br><span class=line>firewall-cmd --reload</span><br></pre></table></figure></div><footer class=post-footer><div class=post-eof></div></footer></article></div> <nav class=pagination><a class="extend prev" aria-label=上一页 href=/page/7/ rel=prev title=上一页><i class="fa fa-angle-left"></i></a><a class=page-number href=/>1</a><span class=space>…</span><a class=page-number href=/page/7/>7</a><span class="page-number current">8</span><a class=page-number href=/page/9/>9</a><span class=space>…</span><a class=page-number href=/page/11/>11</a><a class="extend next" aria-label=下一页 href=/page/9/ rel=next title=下一页><i class="fa fa-angle-right"></i></a></nav> <footer class=footer><div class=footer-inner><div class=copyright>© <span itemprop=copyrightYear>2024</span><span class=with-love> <i class="fa fa-heart"></i> </span><span class=author itemprop=copyrightHolder>豪哥</span></div></div></footer> <div class="toggle sidebar-toggle" role=button><span class=toggle-line></span><span class=toggle-line></span><span class=toggle-line></span></div> <div class=sidebar-dimmer></div> <div aria-label=返回顶部 class=back-to-top role=button><i class="fa fa-arrow-up fa-lg"></i><span>0%</span></div> <noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript> <script crossorigin=anonymous integrity=sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY= src=https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js></script> <script src=/js/comments.js></script><script src=/js/utils.js></script><script src=/js/motion.js></script><script src=/js/sidebar.js></script><script src=/js/next-boot.js></script> <script crossorigin=anonymous integrity=sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc= src=https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js></script> <script src=/js/third-party/search/local-search.js></script> 